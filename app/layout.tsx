import type { Metadata, Viewport } from "next";
import { Inter, Playfair_Display } from "next/font/google";
import "./globals.css";

// --- IMPORT PROVIDER ---
import QueryProvider from "./QueryProvider";
import { UserProvider } from "@/lib/UserContext";
import { AppSettingsProvider } from "@/lib/AppSettingsContext";

// --- IMPORT UI & LOGIC ---
import { Toaster } from "react-hot-toast";
import StaffPresence from "@/components/StaffPresence";
import PushManager from "@/components/PushManager";
import { cookies } from "next/headers";
import { AuthService } from "@/app/components/CongDangNhap/AuthService";
import NavigationWrapper from "@/components/NavigationWrapper"; // <--- IMPORT MỚI

// ... (Giữ nguyên phần Fonts, Metadata, Viewport cũ của bạn) ...
const inter = Inter({ subsets: ["latin", "vietnamese"], display: "swap", variable: "--font-inter" });
const playfair = Playfair_Display({ subsets: ["latin", "vietnamese"], display: "swap", variable: "--font-playfair", weight: ["400", "500", "600", "700", "800", "900"] });

export const metadata: Metadata = { title: "Hệ Thống Quản Lý ERP", description: "Generated by Tommy Nghiem" };
export const viewport: Viewport = { width: "device-width", initialScale: 1, maximumScale: 1, userScalable: false, themeColor: "#000000" };

export default async function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  // --- LOGIC LẤY USER (GIỮ NGUYÊN) ---
  const cookieStore = cookies();
  const sessionCookie = cookieStore.get('staff_session');
  const supabaseUser = await AuthService.getUser();

  let staffUser = null;
  if (sessionCookie) {
    try {
      const parsed = JSON.parse(sessionCookie.value);
      staffUser = {
        id: parsed.id,
        ho_ten: parsed.name,
        hinh_anh: parsed.avatar,
        email: parsed.email || 'staff@internal',
        userType: 'nhan_su',
        role: parsed.role,
        phan_loai: parsed.role,
        vi_tri: parsed.role,
        permissions: { allowView: true, allowEdit: true }
      };
    } catch (e) {}
  }

  const finalUser: any = staffUser ? { ...(supabaseUser || {}), ...staffUser } : supabaseUser;
  const isNhanSu = finalUser?.userType === 'nhan_su';

  return (
    <html lang="vi">
      <body className={`${inter.variable} ${playfair.variable} bg-black h-app w-full overflow-hidden font-sans antialiased text-white`}>
        <QueryProvider>
          <AppSettingsProvider>
            <UserProvider initialUser={finalUser}>
              
              <main className="min-h-screen relative flex flex-col">
                
                {/* --- SỬ DỤNG NAVIGATION WRAPPER (THAY THẾ CODE CŨ) --- */}
                {/* Nó sẽ tự động ẩn menu khi ở trang chủ */}
                <NavigationWrapper user={finalUser} isNhanSu={isNhanSu}>
                  {children}
                </NavigationWrapper>

                {/* Các tiện ích chạy ngầm */}
                <PushManager />
                {isNhanSu && <StaffPresence userId={finalUser?.id} />}
                <Toaster position="bottom-right" />
                
              </main>

            </UserProvider>
          </AppSettingsProvider>
        </QueryProvider>
      </body>
    </html>
  );
}