import type { Metadata, Viewport } from "next";
import { Inter, Playfair_Display } from "next/font/google";
import "./globals.css";

// Import Providers
import QueryProvider from "./QueryProvider";
import { UserProvider } from "@/lib/UserContext";
import { AppSettingsProvider } from "@/lib/AppSettingsContext";

// Import Components
import { Toaster } from "react-hot-toast";
import StaffPresence from "@/components/StaffPresence";
import PushManager from "@/components/PushManager";
import { cookies } from "next/headers";
import { AuthService } from "@/app/components/CongDangNhap/AuthService";
import NavigationWrapper from "@/app/components/NavigationWrapper"; 

const inter = Inter({ subsets: ["latin", "vietnamese"], display: "swap", variable: "--font-inter" });
const playfair = Playfair_Display({ subsets: ["latin", "vietnamese"], display: "swap", variable: "--font-playfair", weight: ["400", "500", "600", "700", "800", "900"] });

export const metadata: Metadata = { title: "H·ªá Th·ªëng Qu·∫£n L√Ω ERP", description: "Generated by Tommy Nghiem" };
export const viewport: Viewport = { width: "device-width", initialScale: 1, maximumScale: 1, userScalable: false, themeColor: "#000000" };

export default async function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const cookieStore = await cookies();
  const sessionCookie = cookieStore.get('staff_session');
  
  // üõ°Ô∏è L·∫§Y USER T·ª™ SUPABASE (B·∫¢O V·ªÜ 1)
  let supabaseUser = null;
  try {
     supabaseUser = await AuthService.getUser();
  } catch (e) {
     console.warn("AuthService error ignored");
  }

  // üõ°Ô∏è L·∫§Y USER T·ª™ COOKIE (B·∫¢O V·ªÜ 2 - CH·ªêNG CRASH)
  let staffUser = null;
  if (sessionCookie?.value) {
    try {
      // Ch·ªâ parse n·∫øu chu·ªói c√≥ v·∫ª l√† JSON h·ª£p l·ªá
      const val = sessionCookie.value;
      if (val && val !== "undefined" && val !== "null" && val.startsWith("{")) {
        const parsed = JSON.parse(val);
        staffUser = {
          id: parsed.id,
          ho_ten: parsed.name,
          hinh_anh: parsed.avatar,
          email: parsed.email || 'staff@internal',
          userType: 'nhan_su',
          role: parsed.role,
          phan_loai: parsed.role,
          vi_tri: parsed.role,
          permissions: { allowView: true, allowEdit: true }
        };
      }
    } catch (e) {
      // üîá IM L·∫∂NG TUY·ªÜT ƒê·ªêI N·∫æU L·ªñI: Kh√¥ng throw error ƒë·ªÉ tr√°nh s·∫≠p web
      // console.error("Cookie parse error ignored"); 
    }
  }

  // Merge d·ªØ li·ªáu an to√†n
  const finalUser: any = staffUser ? { ...(supabaseUser || {}), ...staffUser } : supabaseUser;
  const isNhanSu = finalUser?.userType === 'nhan_su';

  return (
    <html lang="vi">
      <body className={`${inter.variable} ${playfair.variable} bg-black h-app w-full overflow-hidden font-sans antialiased text-white`}>
        <QueryProvider>
          <AppSettingsProvider>
            <UserProvider initialUser={finalUser}>
              <main className="min-h-screen relative flex flex-col">
                
                {/* Wrapper ƒëi·ªÅu h∆∞·ªõng an to√†n */}
                <NavigationWrapper user={finalUser} isNhanSu={isNhanSu}>
                  {children}
                </NavigationWrapper>

                {/* C√°c ti·ªán √≠ch ch·∫°y ng·∫ßm */}
                <PushManager />
                {/* Ch·ªâ hi·ªán StaffPresence n·∫øu c√≥ user, tr√°nh l·ªói render */}
                {isNhanSu && finalUser?.id && <StaffPresence userId={finalUser.id} />}
                <Toaster position="bottom-right" />
                
              </main>
            </UserProvider>
          </AppSettingsProvider>
        </QueryProvider>
      </body>
    </html>
  );
}