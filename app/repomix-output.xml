This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
actions/admindb.ts
actions/NotificationAction.ts
actions/QuyenHanAdmin.ts
actions/QuyenHanBaoCao.ts
actions/QuyenHanCTV.ts
actions/QuyenHanKeToan.ts
actions/QuyenHanKhachVip.ts
actions/QuyenHanKho.ts
actions/QuyenHanQuanLy.ts
actions/QuyenHanSales.ts
actions/QuyenHanSanXuat.ts
actions/QuyenHanThietKe.ts
api/fs/content/route.ts
api/fs/list/route.ts
api/fs/manager/route.ts
api/fs/open/route.ts
api/push/notify-staff/route.ts
api/push/subscribe/notify-staff/route.ts
api/push/subscribe/route.ts
api/push/subscribe/send/route.ts
api/sync-users/route.ts
components/cacchucnang/index.ts
components/cacchucnang/khachhang/config.ts
components/cacchucnang/khachhang/index.ts
components/cacchucnang/khachhang/KhachHangChucNang.tsx
components/cacchucnang/KhungGiaoDienChucNang/index.ts
components/cacchucnang/KhungGiaoDienChucNang/KhungChiTiet.tsx
components/cacchucnang/KhungGiaoDienChucNang/KhungDanhSach.tsx
components/cacchucnang/KhungGiaoDienChucNang/KhungForm.tsx
components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan.tsx
components/cacchucnang/mauthietke/config.ts
components/cacchucnang/mauthietke/index.ts
components/cacchucnang/mauthietke/MauThietKeChucNang.tsx
components/cacchucnang/mauthietke/MauThietKeDetail.tsx
components/cacchucnang/mauthietke/MauThietKeForm.tsx
components/cacchucnang/mauthietke/MauThietKeList.tsx
components/cacchucnang/nhansu/config.ts
components/cacchucnang/nhansu/index.ts
components/cacchucnang/nhansu/NhanSuChucNang.tsx
components/cacchucnang/types.ts
components/cacchucnang/viecmau/config.ts
components/cacchucnang/viecmau/index.ts
components/cacchucnang/viecmau/MauThietKeChucNang.tsx
components/cacchucnang/viecmau/MauThietKeDetail.tsx
components/cacchucnang/viecmau/MauThietKeForm.tsx
components/cacchucnang/viecmau/MauThietKeList.tsx
components/ConfirmDialog.tsx
components/ErrorBoundary.tsx
components/ForceFullScreen.tsx
components/NutHoTro.tsx
components/PushManager.tsx
components/RegisterForm.tsx
components/StaffPresence.tsx
components/ThanhPhongChucNang.tsx
components/TuVanKhachHang.tsx
CongDangNhap/AuthService.ts
CongDangNhap/ChanForm.tsx
CongDangNhap/CongDangNhap.tsx
CongDangNhap/middleware.ts
CongDangNhap/page.tsx
CongDangNhap/RoleRedirectService.ts
constants/zIndex.ts
dashboard/admin/page.tsx
dathang/page.tsx
DuLieuBackend.md
favicon.ico
GiaoDienTong/KhungGiaoDienTong.tsx
GiaoDienTong/MenuSystemWrapper.tsx
GiaoDienTong/MenuTren/MenuTren.tsx
GiaoDienTong/MenuTren/NotificationCenter.tsx
GiaoDienTong/MenuTren/NotificationService.ts
GiaoDienTong/MenuTren/NotificationTypes.ts
GiaoDienTong/MenuTren/NutCaNhan/ChucNang.ts
GiaoDienTong/MenuTren/NutCaNhan/GiaoDienChiTiet.tsx
GiaoDienTong/MenuTren/NutCaNhan/ModalProfile.tsx
GiaoDienTong/MenuTren/NutCaNhan/NutCaNhan.tsx
globals.css
layout.tsx
Music/NhacNen.tsx
page.tsx
phongadmin/page.tsx
phongctv/page.tsx
phongketoan/page.tsx
phongkhachhang/page.tsx
phongkho/page.tsx
phongparttime/page.tsx
phongquanly/page.tsx
phongsales/page.tsx
phongthietke/page.tsx
phongtrungbay/page.tsx
QueryProvider.tsx
ThuVien/AppSettingsContext.tsx
ThuVien/compressImage.ts
ThuVien/DataNormalizer.ts
ThuVien/GoogleDich.tsx
ThuVien/InputValidator.ts
ThuVien/ketNoiSupabase.ts
ThuVien/KieuDuLieu.ts
ThuVien/LoggerService.ts
ThuVien/OrderService.ts
ThuVien/QueryTimeout.ts
ThuVien/UserContext.tsx
ThuVien/withTimeout.ts
trangchu/BackgroundManager.tsx
trangchu/NutDatHang.tsx
trangchu/page.tsx
trangchu/slider1.tsx
trangchu/slider2.tsx
types/index.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="actions/admindb.ts">
'use server';

import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

// K·∫øt n·ªëi DB (D√πng Postgres.js cho c√°c l·ªánh DDL m·∫°nh)
const sql = postgres(process.env.DATABASE_URL!, {
  ssl: 'require',
  max: 10,
  idle_timeout: 20, 
});

// üõ°Ô∏è 1. H√ÄM KI·ªÇM TRA QUY·ªÄN ADMIN (B·∫ÆT BU·ªòC)
async function requireAdmin() {
    const cookieStore = cookies();
    
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                get(name: string) {
                    return cookieStore.get(name)?.value
                },
                set(name: string, value: string, options: any) {},
                remove(name: string, options: any) {},
            },
        }
    );

    const { data: { user } } = await supabase.auth.getUser();
    if (!user || !user.email) throw new Error("Unauthorized: B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p");

    // Check email ho·∫∑c b·∫£ng nhan_su ƒë·ªÉ xem c√≥ ph·∫£i admin kh√¥ng
    const { data: nhanSu } = await supabase
        .from('nhan_su')
        .select('vi_tri, vi_tri_normalized')
        .eq('email', user.email)
        .single();
    
    // ∆Øu ti√™n tr∆∞·ªùng normalized ƒë·ªÉ kh·ªõp RLS/routing; v·∫´n h·ªó tr·ª£ legacy vi_tri
    const allowedRoles = ['admin', 'quanly', 'boss'];
    const userRoleNormalized = (nhanSu?.vi_tri_normalized || '').toLowerCase();
    const userRoleLegacy = (nhanSu?.vi_tri || '').toLowerCase().replace(/\s/g, '');
    
    const isAllowed = allowedRoles.includes(userRoleNormalized) || allowedRoles.some(r => userRoleLegacy.includes(r));

    if (!isAllowed) {
        throw new Error("Forbidden: B·∫°n kh√¥ng c√≥ quy·ªÅn qu·∫£n tr·ªã Database");
    }
}

// üõ°Ô∏è 2. H√ÄM KI·ªÇM TRA T√äN B·∫¢NG/C·ªòT (CH·ªêNG SQL INJECTION)
function validateIdentifier(name: string) {
    if (!/^[a-zA-Z0-9_]+$/.test(name)) {
        throw new Error(`T√™n kh√¥ng h·ª£p l·ªá: ${name}. Ch·ªâ ch·∫•p nh·∫≠n ch·ªØ, s·ªë v√† g·∫°ch d∆∞·ªõi.`);
    }
}

// --- C√ÅC H√ÄM ACTION ---

// --- 1. L·∫§Y DANH S√ÅCH B·∫¢NG ---
export async function getTablesWithRLSAction() {
    try {
        await requireAdmin(); // üõ°Ô∏è Check quy·ªÅn
        const tables = await sql`
            SELECT c.relname as table_name, c.relrowsecurity as rls_enabled
            FROM pg_class c
            JOIN pg_namespace n ON n.oid = c.relnamespace
            WHERE n.nspname = 'public' AND c.relkind = 'r'
            ORDER BY c.relname;
        `;
        return { success: true, data: Array.from(tables).map(t => ({ table_name: t.table_name, rls_enabled: t.rls_enabled })) };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 2. KI·ªÇM TRA RLS ---
export async function checkTableRLSAction(tableName: string) {
    try {
        await requireAdmin();
        const [result] = await sql`
            SELECT c.relrowsecurity as rls_enabled
            FROM pg_class c
            JOIN pg_namespace n ON n.oid = c.relnamespace
            WHERE n.nspname = 'public' AND c.relkind = 'r' AND c.relname = ${tableName}
        `;
        if (!result) return { success: false, error: "B·∫£ng kh√¥ng t·ªìn t·∫°i" };
        return { success: true, rls_enabled: result.rls_enabled };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 3. L·∫§Y SCHEMA ---
export async function getTableSchemaAction(tableName: string) {
    try {
        await requireAdmin();
        const columns = await sql`
            SELECT column_name, data_type, is_nullable, column_default
            FROM information_schema.columns 
            WHERE table_schema = 'public' AND table_name = ${tableName}
            ORDER BY ordinal_position;
        `;
        return { success: true, data: Array.from(columns) };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 4. TOGGLE RLS (NGUY HI·ªÇM - C·∫¶N CHECK K·ª∏) ---
export async function toggleRLSAction(tableName: string, enable: boolean) {
    try {
        await requireAdmin(); // üõ°Ô∏è Check quy·ªÅn c·ª±c quan tr·ªçng
        validateIdentifier(tableName); // üõ°Ô∏è Check SQL Injection

        if (enable) {
            await sql.unsafe(`ALTER TABLE "${tableName}" ENABLE ROW LEVEL SECURITY`);
        } else {
            await sql.unsafe(`ALTER TABLE "${tableName}" DISABLE ROW LEVEL SECURITY`);
            await sql.unsafe(`GRANT ALL ON TABLE "${tableName}" TO anon, authenticated, service_role`);
        }
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// --- 5. L·∫§Y D·ªÆ LI·ªÜU PH√ÇN TRANG (ƒê√É S·ª¨A L·ªñI SORT COLUMN) ---
export async function getTableDataPaginatedAction(tableName: string, page: number, pageSize: number) {
    try {
        await requireAdmin();
        validateIdentifier(tableName);
        
        // üü¢ B∆Ø·ªöC 1: T√¨m c·ªôt s·∫Øp x·∫øp h·ª£p l·ªá (Tr√°nh l·ªói column does not exist)
        const columns = await sql`
            SELECT column_name 
            FROM information_schema.columns 
            WHERE table_schema = 'public' AND table_name = ${tableName}
        `;
        
        const colNames = Array.from(columns).map(c => c.column_name);
        let sortCol = 'id'; // M·∫∑c ƒë·ªãnh sort theo id n·∫øu kh√¥ng t√¨m th·∫•y ng√†y
        
        // ∆Øu ti√™n c√°c c·ªôt th·ªùi gian ph·ªï bi·∫øn
        if (colNames.includes('tao_luc')) sortCol = 'tao_luc';
        else if (colNames.includes('created_at')) sortCol = 'created_at';
        else if (colNames.includes('date_created')) sortCol = 'date_created';
        
        // N·∫øu kh√¥ng c√≥ id lu√¥n (hi·∫øm g·∫∑p), l·∫•y c·ªôt ƒë·∫ßu ti√™n
        if (!colNames.includes('id') && sortCol === 'id' && colNames.length > 0) {
             sortCol = colNames[0];
        }

        const offset = (page - 1) * pageSize;
        
        // üü¢ B∆Ø·ªöC 2: Query an to√†n v·ªõi c·ªôt s·∫Øp x·∫øp ƒë·ªông
        const data = await sql.unsafe(`SELECT * FROM "${tableName}" ORDER BY "${sortCol}" DESC LIMIT ${pageSize} OFFSET ${offset}`);
        
        const [countResult] = await sql.unsafe(`SELECT count(*) as total FROM "${tableName}"`);
        
        return { 
            success: true, 
            data: Array.from(data), 
            total: Number(countResult.total) 
        };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// --- 6. T·∫†O KH√ìA NGO·∫†I ---
export async function createForeignKeyAction(table: string, col: string, refTable: string, refCol: string = 'id') {
    try {
        await requireAdmin();
        validateIdentifier(table);
        validateIdentifier(col);
        validateIdentifier(refTable);
        validateIdentifier(refCol);

        const constraintName = `fk_${table}_${col}_${Date.now()}`;
        await sql.unsafe(`
            ALTER TABLE "${table}" ADD CONSTRAINT "${constraintName}" 
            FOREIGN KEY ("${col}") REFERENCES "${refTable}" ("${refCol}") ON DELETE SET NULL
        `);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// --- 7. QU·∫¢N L√ù C·∫§U TR√öC B·∫¢NG (CORE) ---
export async function manageTableStructureAction(tableName: string, columnsDef: any[]) {
  try {
    await requireAdmin();
    if (!tableName) throw new Error("T√™n b·∫£ng kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng");
    validateIdentifier(tableName);

    await sql.unsafe(`
      CREATE TABLE IF NOT EXISTS "${tableName}" (
        id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
        tao_luc timestamptz DEFAULT now()
      )
    `);

    try {
        await sql.unsafe(`ALTER TABLE "${tableName}" DISABLE ROW LEVEL SECURITY`);
        await sql.unsafe(`GRANT ALL ON TABLE "${tableName}" TO anon, authenticated, service_role`);
    } catch (e) {}

    for (const col of columnsDef) {
        if (['id', 'tao_luc'].includes(col.name)) continue;
        validateIdentifier(col.name);

        try {
            const [existing] = await sql`SELECT column_name FROM information_schema.columns WHERE table_schema = 'public' AND table_name = ${tableName} AND column_name = ${col.name}`;

            let safeDefault = '';
            if (col.defaultValue !== undefined && col.defaultValue !== null && col.defaultValue !== '') {
                let val = String(col.defaultValue).trim();
                val = val.replace(/::[a-zA-Z0-9_ ]+$/, ''); 
                const isFuncOrNum = ['now()', 'gen_random_uuid()', 'true', 'false', 'current_timestamp'].includes(val.toLowerCase()) || !isNaN(Number(val));
                if (isFuncOrNum) {
                    safeDefault = val;
                } else {
                    if (val.startsWith("'") && val.endsWith("'")) safeDefault = val;
                    else {
                         if (col.type.endsWith('[]') && !val.startsWith('{')) val = `{${val}}`;
                         safeDefault = `'${val.replace(/'/g, "''")}'`; 
                    }
                }
            }

            if (existing) {
                await sql.unsafe(`ALTER TABLE "${tableName}" ALTER COLUMN "${col.name}" TYPE ${col.type} USING "${col.name}"::${col.type}`);
                await sql.unsafe(`ALTER TABLE "${tableName}" ALTER COLUMN "${col.name}" ${col.isNullable ? 'DROP NOT NULL' : 'SET NOT NULL'}`);
                if (safeDefault) await sql.unsafe(`ALTER TABLE "${tableName}" ALTER COLUMN "${col.name}" SET DEFAULT ${safeDefault}`);
                else await sql.unsafe(`ALTER TABLE "${tableName}" ALTER COLUMN "${col.name}" DROP DEFAULT`);
            } else {
                let query = `ALTER TABLE "${tableName}" ADD COLUMN "${col.name}" ${col.type}`;
                if (!col.isNullable) query += ` NOT NULL`;
                if (safeDefault) query += ` DEFAULT ${safeDefault}`;
                await sql.unsafe(query);
            }
        } catch (colErr: any) {
            throw new Error(`L·ªói c·ªôt '${col.name}': ${colErr.message}`);
        }
    }
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error instanceof Error ? error.message : String(error) };
  }
}

// --- 8. C√ÅC H√ÄM KH√ÅC ---
export async function unlockTableAction(tableName: string) {
    return toggleRLSAction(tableName, false);
}

export async function addColumnAction(tableName: string, colName: string, colType: string) {
    try {
        await requireAdmin();
        validateIdentifier(tableName);
        validateIdentifier(colName);
        
        await sql.unsafe(`ALTER TABLE "${tableName}" ADD COLUMN "${colName}" ${colType}`);
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 9. C·∫¨P NH·∫¨T D·ªÆ LI·ªÜU ---
export async function updateTableCellAction(tableName: string, id: string, column: string, value: any) {
    try {
        await requireAdmin();
        validateIdentifier(tableName);
        validateIdentifier(column);

        // X·ª≠ l√Ω gi√° tr·ªã ƒë·∫∑c bi·ªát
        let finalValue = value;
        if (value === '' || value === null) finalValue = null;

        await sql.unsafe(`
            UPDATE "${tableName}" 
            SET "${column}" = $1 
            WHERE id = $2
        `, [finalValue, id]);

        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 10. L·∫§Y D·ªÆ LI·ªÜU NH√ÇN S·ª∞ (C√ì SEARCH & FILTER) ---
export async function getNhanSuDataAction(page: number, pageSize: number, search: string, filterRole: string) {
    try {
        await requireAdmin();
        
        let query = `SELECT * FROM "nhan_su" WHERE 1=1`;
        const params: any[] = [];
        let paramCount = 1;

        if (search) {
            query += ` AND (ho_ten ILIKE $${paramCount} OR so_dien_thoai ILIKE $${paramCount} OR email ILIKE $${paramCount})`;
            params.push(`%${search}%`);
            paramCount++;
        }

        if (filterRole && filterRole !== 'all') {
            query += ` AND vi_tri_normalized = $${paramCount}`;
            params.push(filterRole);
            paramCount++;
        }

        const countQuery = query.replace('SELECT *', 'SELECT count(*) as total');
        const offset = (page - 1) * pageSize;
        query += ` ORDER BY tao_luc DESC LIMIT ${pageSize} OFFSET ${offset}`;

        const data = await sql.unsafe(query, params);
        const [countResult] = await sql.unsafe(countQuery, params);

        return { 
            success: true, 
            data: Array.from(data), 
            total: Number(countResult.total) 
        };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 11. C·∫¨P NH·∫¨T NH√ÇN S·ª∞ ---
export async function updateNhanSuAction(id: string, data: any) {
    try {
        await requireAdmin();
        
        // üü¢ FIX L·ªñI 428C9: B·ªé C·ªòT luong_theo_gio V√å L√Ä GENERATED COLUMN
        await sql.unsafe(`
            UPDATE "nhan_su"
            SET ho_ten = $1,
                so_dien_thoai = $2,
                vi_tri = $3,
                vi_tri_normalized = $4,
                email = $5,
                luong_thang = $6,
                thuong_doanh_thu = $7,
                ngan_hang = $8,
                so_tai_khoan = $9,
                hinh_anh = $10
            WHERE id = $11
        `, [
            data.ho_ten, 
            data.so_dien_thoai, 
            data.vi_tri, 
            data.vi_tri_normalized, 
            data.email || '',
            data.luong_thang || 0,
            data.thuong_doanh_thu || 0,
            data.ngan_hang || null,
            data.so_tai_khoan || null,
            data.hinh_anh || null,
            id
        ]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 12. T·∫†O M·ªöI NH√ÇN S·ª∞ ---
export async function createNhanSuAction(data: any) {
    try {
        await requireAdmin();
        
        // üü¢ FIX L·ªñI 428C9: B·ªé C·ªòT luong_theo_gio V√å L√Ä GENERATED COLUMN
        await sql.unsafe(`
            INSERT INTO "nhan_su" (
                ho_ten, so_dien_thoai, vi_tri, vi_tri_normalized, email, 
                trang_thai, luong_thang, thuong_doanh_thu, 
                ngan_hang, so_tai_khoan, hinh_anh
            )
            VALUES ($1, $2, $3, $4, $5, 'ƒêang ho·∫°t ƒë·ªông', $6, $7, $8, $9, $10)
        `, [
            data.ho_ten, 
            data.so_dien_thoai, 
            data.vi_tri, 
            data.vi_tri_normalized, 
            data.email,
            data.luong_thang || 0,
            data.thuong_doanh_thu || 0,
            data.ngan_hang || null,
            data.so_tai_khoan || null,
            data.hinh_anh || null
        ]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 13. L·∫§Y GI√Å TR·ªä DUY NH·∫§T C·ª¶A C·ªòT (D√πng cho Dropdown) ---
export async function getDistinctValuesAction(tableName: string, columnName: string) {
    try {
        await requireAdmin();
        validateIdentifier(tableName);
        validateIdentifier(columnName);

        const data = await sql.unsafe(`
            SELECT DISTINCT "${columnName}" 
            FROM "${tableName}" 
            WHERE "${columnName}" IS NOT NULL AND "${columnName}" != ''
            ORDER BY "${columnName}" ASC
        `);
        
        return { success: true, data: Array.from(data).map(row => row[columnName]) };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}
// --- üü¢ 14. X√ìA NH√ÇN S·ª∞ ---
export async function deleteNhanSuAction(id: string) {
    try {
        await requireAdmin(); // Ch·ªâ Admin/Qu·∫£n l√Ω m·ªõi g·ªçi ƒë∆∞·ª£c
        validateIdentifier('nhan_su');

        await sql.unsafe(`
            DELETE FROM "nhan_su" WHERE id = $1
        `, [id]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 14b. C·∫¨P NH·∫¨T H√ÄNG LO·∫†T NH√ÇN S·ª∞ (BULK UPDATE) ---
export async function bulkUpdateNhanSuAction(ids: string[], data: { vi_tri?: string; vi_tri_normalized?: string }) {
    try {
        await requireAdmin();
        
        if (!ids || ids.length === 0) {
            return { success: false, error: 'Kh√¥ng c√≥ ID n√†o ƒë∆∞·ª£c ch·ªçn' };
        }

        const setClauses: string[] = [];
        const params: any[] = [];
        let paramCount = 1;

        if (data.vi_tri !== undefined) {
            setClauses.push(`vi_tri = $${paramCount}`);
            params.push(data.vi_tri);
            paramCount++;
        }

        if (data.vi_tri_normalized !== undefined) {
            setClauses.push(`vi_tri_normalized = $${paramCount}`);
            params.push(data.vi_tri_normalized);
            paramCount++;
        }

        if (setClauses.length === 0) {
            return { success: false, error: 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t' };
        }

        const idPlaceholders = ids.map((_, i) => `$${paramCount + i}`).join(', ');
        params.push(...ids);

        const query = `UPDATE "nhan_su" SET ${setClauses.join(', ')} WHERE id IN (${idPlaceholders})`;
        
        await sql.unsafe(query, params);
        
        return { success: true, updated: ids.length };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// ... (Gi·ªØ nguy√™n c√°c h√†m c≈©)

// --- üü¢ 15. L·∫§Y D·ªÆ LI·ªÜU KH√ÅCH H√ÄNG (C√ì SEARCH & FILTER) ---
export async function getKhachHangDataAction(page: number, pageSize: number, search: string, filterRole: string) {
    try {
        await requireAdmin();
        
        let query = `SELECT * FROM "khach_hang" WHERE 1=1`;
        const params: any[] = [];
        let paramCount = 1;

        if (search) {
            query += ` AND (ho_ten ILIKE $${paramCount} OR so_dien_thoai ILIKE $${paramCount} OR email ILIKE $${paramCount})`;
            params.push(`%${search}%`);
            paramCount++;
        }

        if (filterRole && filterRole !== 'all') {
            query += ` AND phan_loai_normalized = $${paramCount}`;
            params.push(filterRole);
            paramCount++;
        }

        const countQuery = query.replace('SELECT *', 'SELECT count(*) as total');
        const offset = (page - 1) * pageSize;
        // S·∫Øp x·∫øp kh√°ch h√†ng m·ªõi nh·∫•t l√™n ƒë·∫ßu
        query += ` ORDER BY tao_luc DESC LIMIT ${pageSize} OFFSET ${offset}`;

        const data = await sql.unsafe(query, params);
        const [countResult] = await sql.unsafe(countQuery, params);

        return { 
            success: true, 
            data: Array.from(data), 
            total: Number(countResult.total) 
        };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 16. T·∫†O M·ªöI KH√ÅCH H√ÄNG ---
export async function createKhachHangAction(data: any) {
    try {
        await requireAdmin();
        
        // ƒê·∫£m b·∫£o normalized c√≥ gi√° tr·ªã
        const phanLoaiNorm = data.phan_loai_normalized || 
            (data.phan_loai ? data.phan_loai.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/\s+/g, "") : 'moi');

        await sql.unsafe(`
            INSERT INTO "khach_hang" (
                ho_ten, so_dien_thoai, email, 
                phan_loai, phan_loai_normalized, 
                hinh_anh, dia_chi, tao_luc
            )
            VALUES ($1, $2, $3, $4, $5, $6, $7, now())
        `, [
            data.ho_ten, 
            data.so_dien_thoai, 
            data.email,
            data.phan_loai,
            phanLoaiNorm,
            data.hinh_anh || null,
            data.dia_chi || null
        ]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 17. C·∫¨P NH·∫¨T KH√ÅCH H√ÄNG ---
export async function updateKhachHangAction(id: string, data: any) {
    try {
        await requireAdmin();

         const phanLoaiNorm = data.phan_loai_normalized || 
            (data.phan_loai ? data.phan_loai.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/\s+/g, "") : 'moi');
        
        await sql.unsafe(`
            UPDATE "khach_hang"
            SET ho_ten = $1,
                so_dien_thoai = $2,
                email = $3,
                phan_loai = $4,
                phan_loai_normalized = $5,
                hinh_anh = $6,
                dia_chi = $7
            WHERE id = $8
        `, [
            data.ho_ten, 
            data.so_dien_thoai, 
            data.email,
            data.phan_loai,
            phanLoaiNorm,
            data.hinh_anh || null,
            data.dia_chi || null,
            id
        ]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 18. X√ìA KH√ÅCH H√ÄNG ---
export async function deleteKhachHangAction(id: string) {
    try {
        await requireAdmin();
        validateIdentifier('khach_hang');

        await sql.unsafe(`DELETE FROM "khach_hang" WHERE id = $1`, [id]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 19. C·∫¨P NH·∫¨T H√ÄNG LO·∫†T KH√ÅCH H√ÄNG (BULK UPDATE) ---
export async function bulkUpdateKhachHangAction(ids: string[], data: { phan_loai?: string; phan_loai_normalized?: string }) {
    try {
        await requireAdmin();
        
        if (!ids || ids.length === 0) {
            return { success: false, error: 'Kh√¥ng c√≥ ID n√†o ƒë∆∞·ª£c ch·ªçn' };
        }

        // Build SET clause dynamically
        const setClauses: string[] = [];
        const params: any[] = [];
        let paramCount = 1;

        if (data.phan_loai !== undefined) {
            setClauses.push(`phan_loai = $${paramCount}`);
            params.push(data.phan_loai);
            paramCount++;
        }

        if (data.phan_loai_normalized !== undefined) {
            setClauses.push(`phan_loai_normalized = $${paramCount}`);
            params.push(data.phan_loai_normalized);
            paramCount++;
        }

        if (setClauses.length === 0) {
            return { success: false, error: 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t' };
        }

        // Create placeholders for IDs: $3, $4, $5, ...
        const idPlaceholders = ids.map((_, i) => `$${paramCount + i}`).join(', ');
        params.push(...ids);

        const query = `UPDATE "khach_hang" SET ${setClauses.join(', ')} WHERE id IN (${idPlaceholders})`;
        
        await sql.unsafe(query, params);
        
        return { success: true, updated: ids.length };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}
</file>

<file path="actions/NotificationAction.ts">
"use server";

import postgres from "postgres";
import webPush from "web-push";

// K·∫øt n·ªëi DB
const sql = postgres(process.env.DATABASE_URL!, { ssl: "require" });

// C·∫•u h√¨nh Web Push (L·∫•y t·ª´ bi·∫øn m√¥i tr∆∞·ªùng c·ªßa b·∫°n)
if (
  !process.env.VAPID_PRIVATE_KEY ||
  !process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY
) {
  console.warn(
    "‚ö†Ô∏è [NotificationAction] Ch∆∞a c·∫•u h√¨nh VAPID keys. Web Push s·∫Ω kh√¥ng ho·∫°t ƒë·ªông."
  );
} else {
  try {
    webPush.setVapidDetails(
      process.env.VAPID_SUBJECT || "mailto:admin@nghiemart.com",
      process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY!,
      process.env.VAPID_PRIVATE_KEY!
    );
  } catch (err) {
    console.error("‚ö†Ô∏è [NotificationAction] L·ªói c·∫•u h√¨nh VAPID:", err);
  }
}

/**
 * H√ÄM G·ª¨I TH√îNG B√ÅO TH√îNG MINH (Centralized Notification Handler)
 * ------------------------------------------------------------------
 * @param targetRoles Danh s√°ch role/ph√≤ng nh·∫≠n tin (vd: ['admin', 'thietke', 'quanly'])
 * @param title Ti√™u ƒë·ªÅ th√¥ng b√°o (vd: "M·∫´u thi·∫øt k·∫ø m·ªõi")
 * @param message N·ªôi dung chi ti·∫øt
 * @param url Link khi click v√†o (vd: '/phongthietke')
 * @param type Lo·∫°i icon hi·ªÉn th·ªã (m·∫∑c ƒë·ªãnh: 'system_alert')
 * @param senderName T√™n ng∆∞·ªùi g·ª≠i (Optional, m·∫∑c ƒë·ªãnh l√† H·ªá th·ªëng)
 */
export async function sendNotificationToRoles(
  targetRoles: string[],
  title: string,
  message: string,
  url: string = "/",
  type: string = "system_alert",
  senderName: string = "H·ªá th·ªëng"
) {
  try {
    // 1. CHU·∫®N H√ìA ROLE & T√åM USER
    // Chuy·ªÉn h·∫øt v·ªÅ ch·ªØ th∆∞·ªùng ƒë·ªÉ so s√°nh ch√≠nh x√°c v·ªõi vi_tri_normalized
    const rolesNormalized = targetRoles.map((r) => r.toLowerCase().trim());

    // T√¨m ID c·ªßa nh·ªØng nh√¢n s·ª± thu·ªôc c√°c ph√≤ng n√†y V√Ä ƒëang ho·∫°t ƒë·ªông
    // L∆∞u √Ω: N·∫øu mu·ªën g·ª≠i cho t·∫•t c·∫£ nh√¢n vi√™n (vd: th√¥ng b√°o chung), truy·ªÅn targetRoles = ['all']
    let users;
    if (rolesNormalized.includes("all")) {
      users =
        await sql`SELECT id FROM "nhan_su" WHERE trang_thai = 'dang_lam_viec'`;
    } else {
      users = await sql`
        SELECT id FROM "nhan_su" 
        WHERE vi_tri_normalized = ANY(${rolesNormalized})
        AND trang_thai = 'dang_lam_viec' 
        `;
    }

    if (users.length === 0) {
      return {
        success: true,
        count: 0,
        message: "Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi nh·∫≠n ph√π h·ª£p",
      };
    }

    const userIds = users.map((u) => u.id);

    // 2. L∆ØU V√ÄO DATABASE (B·∫£ng notifications) - ƒê·ªÉ hi·ªán chu√¥ng ƒë·ªè tr√™n Web
    // T·∫°o avatar m·∫∑c ƒë·ªãnh d·ª±a tr√™n t√™n ng∆∞·ªùi g·ª≠i
    const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(
      senderName
    )}&background=C69C6D&color=fff&size=128`;

    const notificationsToInsert = userIds.map((uid) => ({
      user_id: uid,
      type: type,
      category: "from_system",
      title: title,
      message: message,
      action_url: url,
      is_read: false,
      created_at: new Date().toISOString(),
      from_user_name: senderName,
      from_user_avatar: avatarUrl,
    }));

    // Batch Insert (Nhanh h∆°n insert t·ª´ng d√≤ng)
    if (notificationsToInsert.length > 0) {
      await sql`INSERT INTO "notifications" ${sql(notificationsToInsert)}`;
    }

    // 3. G·ª¨I PUSH NOTIFICATION (ƒê·∫øn ƒëi·ªán tho·∫°i/tr√¨nh duy·ªát)
    // T√¨m c√°c thi·∫øt b·ªã ƒë√£ ƒëƒÉng k√Ω nh·∫≠n tin c·ªßa nh·ªØng user n√†y
    const subscriptions = await sql`
      SELECT * FROM "push_subscriptions" 
      WHERE user_id = ANY(${userIds})
    `;

    if (subscriptions.length > 0) {
      const payload = JSON.stringify({
        title: title,
        body: message,
        url: url,
        icon: "/icon-192.png", // Icon app
        data: { url: url }, // D·ªØ li·ªáu m·ªü r·ªông cho Service Worker
      });

      // G·ª≠i song song (Promise.all)
      const pushPromises = subscriptions.map(async (sub) => {
        try {
          await webPush.sendNotification(
            {
              endpoint: sub.endpoint,
              keys: { auth: sub.auth, p256dh: sub.p256dh },
            },
            payload
          );
        } catch (err: any) {
          // X·ª≠ l√Ω thi·∫øt b·ªã c≈©/h·ªèng (L·ªói 410 Gone ho·∫∑c 404 Not Found)
          if (err.statusCode === 410 || err.statusCode === 404) {
            await sql`DELETE FROM "push_subscriptions" WHERE id = ${sub.id}`;
          }
        }
      });

      // Ch·∫°y ng·∫ßm, kh√¥ng await ƒë·ªÉ tr·∫£ k·∫øt qu·∫£ nhanh
      Promise.all(pushPromises).catch((err) =>
        console.error("L·ªói Push Batch:", err)
      );
    }

    return { success: true, count: userIds.length };
  } catch (error: any) {
    console.error("‚ùå L·ªói [sendNotificationToRoles]:", error);
    // Kh√¥ng throw error ƒë·ªÉ tr√°nh l√†m crash ch·ª©c nƒÉng ch√≠nh
    return { success: false, error: error.message };
  }
}
</file>

<file path="actions/QuyenHanAdmin.ts">
'use server';

import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

// K·∫øt n·ªëi DB
const sql = postgres(process.env.DATABASE_URL!, {
  ssl: 'require',
  max: 10,
  idle_timeout: 20, 
});

// üõ°Ô∏è 1. CHECK QUY·ªÄN SUPER ADMIN (CH·ªà ADMIN & BOSS)
async function requireSuperAdmin() {
    const cookieStore = cookies();
    
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                get(name: string) { return cookieStore.get(name)?.value },
                set(name: string, value: string, options: any) {},
                remove(name: string, options: any) {},
            },
        }
    );

    const { data: { user } } = await supabase.auth.getUser();
    if (!user || !user.email) throw new Error("Unauthorized: B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p");

    const { data: nhanSu } = await supabase
        .from('nhan_su')
        .select('vi_tri, vi_tri_normalized')
        .eq('email', user.email)
        .single();
    
    // üîí CH·ªà CHO PH√âP ADMIN V√Ä BOSS
    const allowedRoles = ['admin', 'boss'];
    const userRoleNormalized = (nhanSu?.vi_tri_normalized || '').toLowerCase();
    
    const isAllowed = allowedRoles.includes(userRoleNormalized);

    if (!isAllowed) {
        throw new Error("Forbidden: Ch·ªâ Super Admin m·ªõi c√≥ quy·ªÅn truy c·∫≠p System Core");
    }
}

// üõ°Ô∏è 2. VALIDATE INPUT
function validateIdentifier(name: string) {
    if (!/^[a-zA-Z0-9_]+$/.test(name)) {
        throw new Error(`T√™n kh√¥ng h·ª£p l·ªá: ${name}. Ch·ªâ ch·∫•p nh·∫≠n ch·ªØ, s·ªë v√† g·∫°ch d∆∞·ªõi.`);
    }
}

// --- C√ÅC H√ÄM H·ªÜ TH·ªêNG (SYSTEM ACTIONS) ---

// 1. L·∫§Y DANH S√ÅCH B·∫¢NG
export async function getTablesWithRLSAction() {
    try {
        await requireSuperAdmin();
        const tables = await sql`
            SELECT c.relname as table_name, c.relrowsecurity as rls_enabled
            FROM pg_class c
            JOIN pg_namespace n ON n.oid = c.relnamespace
            WHERE n.nspname = 'public' AND c.relkind = 'r'
            ORDER BY c.relname;
        `;
        return { success: true, data: Array.from(tables).map(t => ({ table_name: t.table_name, rls_enabled: t.rls_enabled })) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 2. L·∫§Y SCHEMA C·∫§U TR√öC B·∫¢NG
export async function getTableSchemaAction(tableName: string) {
    try {
        await requireSuperAdmin();
        validateIdentifier(tableName);
        const columns = await sql`
            SELECT column_name, data_type, is_nullable, column_default
            FROM information_schema.columns 
            WHERE table_schema = 'public' AND table_name = ${tableName}
            ORDER BY ordinal_position;
        `;
        return { success: true, data: Array.from(columns) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 3. TOGGLE RLS (B·∫¨T/T·∫ÆT B·∫¢O M·∫¨T)
export async function toggleRLSAction(tableName: string, enable: boolean) {
    try {
        await requireSuperAdmin();
        validateIdentifier(tableName);
        if (enable) {
            await sql.unsafe(`ALTER TABLE "${tableName}" ENABLE ROW LEVEL SECURITY`);
        } else {
            await sql.unsafe(`ALTER TABLE "${tableName}" DISABLE ROW LEVEL SECURITY`);
            await sql.unsafe(`GRANT ALL ON TABLE "${tableName}" TO anon, authenticated, service_role`);
        }
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 4. L·∫§Y D·ªÆ LI·ªÜU TH√î (RAW DATA VIEWER)
export async function getTableDataPaginatedAction(tableName: string, page: number, pageSize: number) {
    try {
        await requireSuperAdmin();
        validateIdentifier(tableName);
        
        const columns = await sql`SELECT column_name FROM information_schema.columns WHERE table_schema = 'public' AND table_name = ${tableName}`;
        const colNames = Array.from(columns).map(c => c.column_name);
        
        let sortCol = 'id';
        if (colNames.includes('tao_luc')) sortCol = 'tao_luc';
        else if (colNames.includes('created_at')) sortCol = 'created_at';
        else if (!colNames.includes('id') && colNames.length > 0) sortCol = colNames[0];

        const offset = (page - 1) * pageSize;
        const data = await sql.unsafe(`SELECT * FROM "${tableName}" ORDER BY "${sortCol}" DESC LIMIT ${pageSize} OFFSET ${offset}`);
        const [countResult] = await sql.unsafe(`SELECT count(*) as total FROM "${tableName}"`);
        
        return { success: true, data: Array.from(data), total: Number(countResult.total) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 5. C·∫¨P NH·∫¨T √î D·ªÆ LI·ªÜU B·∫§T K·ª≤ (RAW EDIT)
export async function updateTableCellAction(tableName: string, id: string, column: string, value: any) {
    try {
        await requireSuperAdmin();
        validateIdentifier(tableName);
        validateIdentifier(column);

        let finalValue = value === '' ? null : value;
        await sql.unsafe(`UPDATE "${tableName}" SET "${column}" = $1 WHERE id = $2`, [finalValue, id]);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 6. QU·∫¢N L√ù C·∫§U TR√öC (CREATE TABLE / ALTER COLUMN)
export async function manageTableStructureAction(tableName: string, columnsDef: any[]) {
  try {
    await requireSuperAdmin();
    if (!tableName) throw new Error("T√™n b·∫£ng tr·ªëng");
    validateIdentifier(tableName);

    await sql.unsafe(`
      CREATE TABLE IF NOT EXISTS "${tableName}" (
        id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
        tao_luc timestamptz DEFAULT now()
      )
    `);

    // T·ª± ƒë·ªông t·∫Øt RLS khi t·∫°o b·∫£ng m·ªõi ƒë·ªÉ tr√°nh l·ªói quy·ªÅn
    try {
        await sql.unsafe(`ALTER TABLE "${tableName}" DISABLE ROW LEVEL SECURITY`);
        await sql.unsafe(`GRANT ALL ON TABLE "${tableName}" TO anon, authenticated, service_role`);
    } catch (e) {}

    for (const col of columnsDef) {
        if (['id', 'tao_luc'].includes(col.name)) continue;
        validateIdentifier(col.name);

        const [existing] = await sql`SELECT column_name FROM information_schema.columns WHERE table_schema = 'public' AND table_name = ${tableName} AND column_name = ${col.name}`;
        
        // ... (Logic x·ª≠ l√Ω default value gi·ªØ nguy√™n t·ª´ file c≈©)
        let safeDefault = '';
        if (col.defaultValue !== undefined && col.defaultValue !== null && col.defaultValue !== '') {
             let val = String(col.defaultValue).trim();
             const isFunc = ['now()', 'true', 'false'].includes(val.toLowerCase()) || !isNaN(Number(val));
             safeDefault = isFunc ? val : `'${val.replace(/'/g, "''")}'`;
        }

        if (existing) {
            await sql.unsafe(`ALTER TABLE "${tableName}" ALTER COLUMN "${col.name}" TYPE ${col.type} USING "${col.name}"::${col.type}`);
        } else {
            let query = `ALTER TABLE "${tableName}" ADD COLUMN "${col.name}" ${col.type}`;
            if (safeDefault) query += ` DEFAULT ${safeDefault}`;
            await sql.unsafe(query);
        }
    }
    return { success: true };
  } catch (error: any) { return { success: false, error: error.message }; }
}

export async function addColumnAction(tableName: string, colName: string, colType: string) {
    try {
        await requireSuperAdmin();
        validateIdentifier(tableName); validateIdentifier(colName);
        await sql.unsafe(`ALTER TABLE "${tableName}" ADD COLUMN "${colName}" ${colType}`);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}
</file>

<file path="actions/QuyenHanBaoCao.ts">
'use server';
import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

const sql = postgres(process.env.DATABASE_URL!, { ssl: 'require' });

async function requireAuth() {
    const cookieStore = cookies();
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        { cookies: { get(name: string) { return cookieStore.get(name)?.value }, set() {}, remove() {} } }
    );
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error("Unauthorized");
    return user;
}

export async function getAdminDashboardStats() {
    try {
        await requireAuth();

        // 1. Doanh thu th√°ng n√†y (D·ª±a v√†o s·ªï c√°i - THU)
        const [revenue] = await sql`
            SELECT COALESCE(SUM(so_tien), 0) as total 
            FROM "so_cai_tai_chinh" 
            WHERE loai_giao_dich = 'thu' 
            AND date_trunc('month', tao_luc) = date_trunc('month', CURRENT_DATE)
        `;

        // 2. T·ªïng ƒë∆°n h√†ng h√¥m nay
        const [ordersToday] = await sql`
            SELECT COUNT(*) as count 
            FROM "don_hang" 
            WHERE date_trunc('day', tao_luc) = date_trunc('day', CURRENT_DATE)
        `;

        // 3. Gi√° tr·ªã t·ªìn kho hi·ªán t·∫°i (S·ªë l∆∞·ª£ng * Gi√° v·ªën)
        const [inventoryValue] = await sql`
            SELECT COALESCE(SUM(ton_kho * gia_von), 0) as total 
            FROM "vat_tu"
        `;

        // 4. L∆∞∆°ng t·∫°m t√≠nh th√°ng n√†y ph·∫£i tr·∫£ (D·ª±a v√†o nh·∫≠t k√Ω s·∫£n xu·∫•t)
        // (T√≠nh s∆° b·ªô: t·ªïng ƒëi·ªÉm * 1000ƒë ho·∫∑c logic l∆∞∆°ng gi·ªù, ·ªü ƒë√¢y l·∫•y sum t·ª´ b·∫£ng l∆∞∆°ng t·∫°m)
        const [salaryPending] = await sql`
            SELECT COALESCE(SUM(tong_thu_nhap), 0) as total 
            FROM "bang_luong" 
            WHERE thang = EXTRACT(MONTH FROM CURRENT_DATE)
        `;

        return {
            success: true,
            data: {
                revenueMonth: Number(revenue.total),
                ordersToday: Number(ordersToday.count),
                inventoryValue: Number(inventoryValue.total),
                salaryPending: Number(salaryPending.total)
            }
        };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// L·∫•y 10 ho·∫°t ƒë·ªông g·∫ßn nh·∫•t c·ªßa h·ªá th·ªëng
export async function getRecentActivities() {
    try {
        await requireAuth();
        const data = await sql`
            SELECT 'don_hang' as type, ma_don as ref, ('ƒê∆°n h√†ng m·ªõi: ' || tong_tien) as content, tao_luc FROM "don_hang"
            UNION ALL
            SELECT 'san_xuat' as type, ma_lenh as ref, 'L·ªánh SX ho√†n th√†nh' as content, ket_thuc_luc as tao_luc FROM "lenh_san_xuat" WHERE trang_thai = 'hoan_thanh'
            UNION ALL
            SELECT 'tai_chinh' as type, substring(id::text, 1, 8) as ref, (loai_giao_dich || ': ' || so_tien) as content, tao_luc FROM "so_cai_tai_chinh"
            ORDER BY tao_luc DESC
            LIMIT 10
        `;
        return { success: true, data: Array.from(data) };
    } catch (error: any) { return { success: false, error: error.message }; }
}
</file>

<file path="actions/QuyenHanCTV.ts">
'use server';
import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

const sql = postgres(process.env.DATABASE_URL!, { ssl: 'require' });

async function requireAuth() {
    const cookieStore = cookies();
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        { cookies: { get(name: string) { return cookieStore.get(name)?.value }, set() {}, remove() {} } }
    );
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error("Unauthorized");
    return user;
}

// 1. L·∫§Y TH·ªêNG K√ä HOA H·ªíNG (Dashboard)
export async function getCTVStatsAction() {
    try {
        const user = await requireAuth();
        
        // T√≠nh t·ªïng ƒë∆°n h√†ng m√† CTV n√†y gi·ªõi thi·ªáu (nguoi_tao_id l√† CTV)
        // Gi·∫£ s·ª≠ hoa h·ªìng c·ª©ng l√† 10% (Boss c√≥ th·ªÉ ch·ªânh sau)
        const [stats] = await sql`
            SELECT 
                COUNT(*) as total_orders,
                COALESCE(SUM(tong_tien), 0) as total_revenue,
                COALESCE(SUM(CASE WHEN trang_thai = 'hoan_thanh' THEN tong_tien ELSE 0 END), 0) * 0.1 as commission_earned
            FROM "don_hang"
            WHERE nguoi_tao_id = ${user.id}
        `;
        
        return { success: true, data: stats };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 2. L·∫§Y S·∫¢N PH·∫®M ƒê·ªÇ B√ÅN (K√®m link ·∫£nh ƒë·ªÉ ƒëƒÉng b√†i)
export async function getCTVProductsAction() {
    try {
        await requireAuth();
        const data = await sql`
            SELECT id, ten_vat_tu, gia_ban, hinh_anh, ton_kho, bo_suu_tap
            FROM "vat_tu"
            WHERE loai_vat_tu = 'thanh_pham' AND ton_kho > 0
            ORDER BY ten_vat_tu ASC
        `;
        return { success: true, data: Array.from(data) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 3. CTV T·∫†O ƒê∆†N (Gi·∫£n l∆∞·ª£c h∆°n Sales POS)
export async function createCTVOrderAction(data: any) {
    try {
        const user = await requireAuth();
        
        // T·∫°o kh√°ch h√†ng m·ªõi n·∫øu ch∆∞a c√≥ (CTV th∆∞·ªùng b√°n cho kh√°ch l·∫°)
        let khachId = data.khach_hang_id;
        if (!khachId && data.khach_moi) {
            const [newCust] = await sql`
                INSERT INTO "khach_hang" (ho_ten, so_dien_thoai, dia_chi, phan_loai, phan_loai_normalized, nguoi_gioi_thieu_id)
                VALUES (${data.khach_moi.ho_ten}, ${data.khach_moi.sdt}, ${data.khach_moi.dia_chi}, 'Kh√°ch CTV', 'moi', ${user.id})
                RETURNING id
            `;
            khachId = newCust.id;
        }

        // T·∫°o ƒë∆°n h√†ng
        const [newOrder] = await sql`
            INSERT INTO "don_hang" (
                khach_hang_id, nguoi_tao_id, sales_phu_trach_id, 
                trang_thai, tong_tien, da_thanh_toan, kenh_ban_hang, ghi_chu
            ) VALUES (
                ${khachId}, ${user.id}, ${user.id}, -- CTV t·ª± l√† sales ph·ª• tr√°ch ban ƒë·∫ßu
                'moi', ${data.tong_tien}, 0, 'ctv', ${data.ghi_chu}
            ) RETURNING id, ma_don
        `;

        // T·∫°o chi ti·∫øt
        for (const item of data.items) {
            await sql`
                INSERT INTO "don_hang_chi_tiet" (
                    don_hang_id, vat_tu_id, ten_item_hien_thi, so_luong, don_gia
                ) VALUES (
                    ${newOrder.id}, ${item.id}, ${item.ten_vat_tu}, ${item.so_luong}, ${item.don_gia}
                )
            `;
        }

        return { success: true, ma_don: newOrder.ma_don };
    } catch (error: any) { return { success: false, error: error.message }; }
}
</file>

<file path="actions/QuyenHanKeToan.ts">
"use server";

import postgres from "postgres";
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";
import { sendNotificationToRoles } from "./NotificationAction"; // üü¢ IMPORT

const sql = postgres(process.env.DATABASE_URL!, { ssl: "require" });

async function requireAuth() {
  const cookieStore = cookies();
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
        set() {},
        remove() {},
      },
    }
  );
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) throw new Error("Unauthorized");
  // L·∫•y th√™m t√™n
  const [ns] = await sql`SELECT id, ho_ten FROM nhan_su WHERE id = ${user.id}`;
  return ns;
}

// 1. L·∫§Y DANH S√ÅCH
export async function getThuChiDataAction(
  page: number,
  pageSize: number,
  search: string,
  filterType: string
) {
  try {
    await requireAuth();
    let query = `
            SELECT tc.*, ns.ho_ten as nguoi_thuc_hien_ten
            FROM "so_cai_tai_chinh" tc
            LEFT JOIN "nhan_su" ns ON tc.nguoi_thuc_hien = ns.id
            WHERE 1=1
        `;
    const params: any[] = [];
    let paramCount = 1;

    if (search) {
      query += ` AND (mo_ta ILIKE $${paramCount})`;
      params.push(`%${search}%`);
      paramCount++;
    }

    if (filterType && filterType !== "all") {
      query += ` AND loai_giao_dich = $${paramCount}`;
      params.push(filterType);
      paramCount++;
    }

    const countQuery = `SELECT count(*) as total FROM (${query}) as sub`;
    const offset = (page - 1) * pageSize;
    query += ` ORDER BY tao_luc DESC LIMIT ${pageSize} OFFSET ${offset}`;

    const data = await sql.unsafe(query, params);
    const [countResult] = await sql.unsafe(countQuery, params);

    return {
      success: true,
      data: Array.from(data),
      total: Number(countResult.total),
    };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 2. T·∫†O M·ªöI (ƒê√£ th√™m Noti)
export async function createThuChiAction(data: any) {
  try {
    const user = await requireAuth();
    await sql.unsafe(
      `
            INSERT INTO "so_cai_tai_chinh" (
                loai_giao_dich, so_tien, mo_ta, hinh_anh_chung_tu, nguoi_thuc_hien
            )
            VALUES ($1, $2, $3, $4, $5)
        `,
      [
        data.loai_giao_dich,
        data.so_tien,
        data.mo_ta,
        data.hinh_anh_chung_tu,
        user.id,
      ]
    );

    // üîî B√ÅO CHO BOSS/ADMIN
    const typeText = data.loai_giao_dich === "thu" ? "Kho·∫£n thu" : "Kho·∫£n chi";
    const icon =
      data.loai_giao_dich === "thu" ? "payment_received" : "system_alert";

    sendNotificationToRoles(
      ["admin", "boss"],
      "Bi·∫øn ƒë·ªông t√†i ch√≠nh",
      `${user.ho_ten} v·ª´a t·∫°o ${typeText}: ${Number(
        data.so_tien
      ).toLocaleString()}ƒë - ${data.mo_ta}`,
      "/phongketoan",
      icon,
      user.ho_ten
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 3. C·∫¨P NH·∫¨T
export async function updateThuChiAction(id: string, data: any) {
  try {
    const user = await requireAuth();
    await sql.unsafe(
      `
            UPDATE "so_cai_tai_chinh"
            SET loai_giao_dich = $1, so_tien = $2, mo_ta = $3, hinh_anh_chung_tu = $4
            WHERE id = $5
        `,
      [
        data.loai_giao_dich,
        data.so_tien,
        data.mo_ta,
        data.hinh_anh_chung_tu,
        id,
      ]
    );

    // üîî B√ÅO C·∫¨P NH·∫¨T
    sendNotificationToRoles(
      ["admin", "boss"],
      "C·∫≠p nh·∫≠t t√†i ch√≠nh",
      `${user.ho_ten} ƒë√£ s·ª≠a giao d·ªãch ${data.mo_ta}`,
      "/phongketoan",
      "system_update",
      user.ho_ten
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 4. X√ìA
export async function deleteThuChiAction(id: string) {
  try {
    const user = await requireAuth();
    await sql.unsafe(`DELETE FROM "so_cai_tai_chinh" WHERE id = $1`, [id]);

    // üîî B√ÅO X√ìA (Quan tr·ªçng v·ªõi ti·ªÅn nong)
    sendNotificationToRoles(
      ["admin", "boss"],
      "‚ö†Ô∏è X√≥a giao d·ªãch",
      `${user.ho_ten} ƒë√£ x√≥a m·ªôt giao d·ªãch t√†i ch√≠nh!`,
      "/phongketoan",
      "security_alert",
      user.ho_ten
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}
</file>

<file path="actions/QuyenHanKhachVip.ts">

</file>

<file path="actions/QuyenHanKho.ts">
'use server';
import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

const sql = postgres(process.env.DATABASE_URL!, { ssl: 'require' });

// H√†m check quy·ªÅn (Clone t·ª´ QuyenHanQuanLy)
async function requireAuth() {
    const cookieStore = cookies();
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        { cookies: { get(name: string) { return cookieStore.get(name)?.value }, set() {}, remove() {} } }
    );
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error("Unauthorized");
    return user;
}

// --- QU·∫¢N L√ù V·∫¨T T∆Ø ---
export async function getVatTuDataAction(page: number, pageSize: number, search: string, filterGroup: string) {
    try {
        await requireAuth();
        let query = `SELECT * FROM "vat_tu" WHERE 1=1`;
        const params: any[] = [];
        let paramCount = 1;

        if (search) {
            query += ` AND (ten_vat_tu ILIKE $${paramCount} OR ma_sku ILIKE $${paramCount})`;
            params.push(`%${search}%`);
            paramCount++;
        }

        // L·ªçc theo lo·∫°i (Nguy√™n li·ªáu / Th√†nh ph·∫©m)
        if (filterGroup && filterGroup !== 'all') {
            query += ` AND loai_vat_tu = $${paramCount}`;
            params.push(filterGroup);
            paramCount++;
        }

        const countQuery = query.replace('SELECT *', 'SELECT count(*) as total');
        const offset = (page - 1) * pageSize;
        query += ` ORDER BY ton_kho ASC, ten_vat_tu ASC LIMIT ${pageSize} OFFSET ${offset}`; // ∆Øu ti√™n hi·ªán h√†ng s·∫Øp h·∫øt

        const data = await sql.unsafe(query, params);
        const [countResult] = await sql.unsafe(countQuery, params);

        return { success: true, data: Array.from(data), total: Number(countResult.total) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

export async function createVatTuAction(data: any) {
    try {
        await requireAuth();
        await sql.unsafe(`
            INSERT INTO "vat_tu" (ma_sku, ten_vat_tu, loai_vat_tu, don_vi_tinh, gia_von, gia_ban, ton_kho, canh_bao_toi_thieu, hinh_anh)
            VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
        `, [
            data.ma_sku, data.ten_vat_tu, data.loai_vat_tu, data.don_vi_tinh,
            data.gia_von || 0, data.gia_ban || 0, data.ton_kho || 0, data.canh_bao_toi_thieu || 10,
            data.hinh_anh
        ]);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

export async function updateVatTuAction(id: string, data: any) {
    try {
        await requireAuth();
        await sql.unsafe(`
            UPDATE "vat_tu"
            SET ma_sku = $1, ten_vat_tu = $2, loai_vat_tu = $3, don_vi_tinh = $4,
                gia_von = $5, gia_ban = $6, ton_kho = $7, canh_bao_toi_thieu = $8, hinh_anh = $9
            WHERE id = $10
        `, [
            data.ma_sku, data.ten_vat_tu, data.loai_vat_tu, data.don_vi_tinh,
            data.gia_von, data.gia_ban, data.ton_kho, data.canh_bao_toi_thieu,
            data.hinh_anh, id
        ]);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

export async function deleteVatTuAction(id: string) {
    try {
        await requireAuth();
        await sql.unsafe(`DELETE FROM "vat_tu" WHERE id = $1`, [id]);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}
</file>

<file path="actions/QuyenHanQuanLy.ts">
"use server";

import postgres from "postgres";
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";
// üëá IMPORT M·ªöI
import { sendNotificationToRoles } from "./NotificationAction";

// K·∫øt n·ªëi DB
const sql = postgres(process.env.DATABASE_URL!, {
  ssl: "require",
  max: 10,
  idle_timeout: 20,
});

// üõ°Ô∏è 1. CHECK QUY·ªÄN QU·∫¢N L√ù (ADMIN + BOSS + QUANLY)
async function requireManager() {
  const cookieStore = cookies();

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
        set() {},
        remove() {},
      },
    }
  );

  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user || !user.email) throw new Error("Unauthorized: B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p");

  // L·∫•y th√¥ng tin nh√¢n s·ª±
  const [nhanSu] = await sql`
        SELECT id, ho_ten, vi_tri, vi_tri_normalized 
        FROM nhan_su 
        WHERE lower(email) = lower(${user.email})
        LIMIT 1
    `;

  // ‚úÖ DANH S√ÅCH QUY·ªÄN ƒê∆Ø·ª¢C PH√âP
  const allowedRoles = ["admin", "boss", "quanly"];
  const userRoleNormalized = (nhanSu?.vi_tri_normalized || "").toLowerCase();

  const isAllowed = allowedRoles.includes(userRoleNormalized);

  if (!isAllowed) {
    throw new Error("Forbidden: B·∫°n kh√¥ng c√≥ quy·ªÅn Qu·∫£n L√Ω nghi·ªáp v·ª• n√†y");
  }

  // üëá TR·∫¢ V·ªÄ TH√îNG TIN NH√ÇN S·ª∞ ƒê·ªÇ G·ª¨I NOTI (Thay v√¨ user object c·ªßa Auth)
  return nhanSu;
}

function validateIdentifier(name: string) {
  if (!/^[a-zA-Z0-9_]+$/.test(name))
    throw new Error("T√™n b·∫£ng/c·ªôt kh√¥ng h·ª£p l·ªá");
}

// ==============================================================================
// üöÄ ACTIONS (ƒê√É B·∫¨T B·∫¢O M·∫¨T)
// ==============================================================================

// --- üí¨ NGHI·ªÜP V·ª§ CHAT & H·ªñ TR·ª¢ ---

export async function getManagerChatSessionsAction(
  filterStatus: string = "all"
) {
  try {
    await requireManager(); // üõ°Ô∏è B·∫¢O M·∫¨T ƒê√É B·∫¨T

    let query = `
            SELECT 
                s.*,
                ns.ho_ten as ten_sales_phu_trach
            FROM tu_van_sessions s
            LEFT JOIN nhan_su ns ON s.nhan_su_phu_trach_id = ns.id
            WHERE 1=1
        `;

    if (filterStatus !== "all") {
      query += ` AND s.trang_thai = '${filterStatus}'`;
    }

    query += ` ORDER BY s.cap_nhat_luc DESC LIMIT 100`;

    const data = await sql.unsafe(query);
    return { success: true, data: Array.from(data) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function getManagerChatMessagesAction(sessionId: string) {
  try {
    await requireManager(); // üõ°Ô∏è B·∫¢O M·∫¨T ƒê√É B·∫¨T

    const data = await sql`
            SELECT * FROM tu_van_messages 
            WHERE session_id = ${sessionId} 
            ORDER BY tao_luc ASC
        `;

    return { success: true, data: Array.from(data) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// --- üë• NGHI·ªÜP V·ª§ NH√ÇN S·ª∞ ---

export async function getNhanSuDataAction(
  page: number,
  pageSize: number,
  search: string,
  filterRole: string
) {
  try {
    await requireManager(); // üõ°Ô∏è B·∫¢O M·∫¨T ƒê√É B·∫¨T

    let baseQuery = `SELECT * FROM "nhan_su" WHERE 1=1`;
    let countQueryBase = `SELECT count(*) as total FROM "nhan_su" WHERE 1=1`;
    const params: any[] = [];
    let paramCount = 1;

    if (search) {
      const searchClause = ` AND (ho_ten ILIKE $${paramCount} OR so_dien_thoai ILIKE $${paramCount} OR email ILIKE $${paramCount})`;
      baseQuery += searchClause;
      countQueryBase += searchClause;
      params.push(`%${search}%`);
      paramCount++;
    }

    if (filterRole && filterRole !== "all") {
      const roleClause = ` AND vi_tri_normalized = $${paramCount}`;
      baseQuery += roleClause;
      countQueryBase += roleClause;
      params.push(filterRole);
      paramCount++;
    }

    const offset = (page - 1) * pageSize;
    baseQuery += ` ORDER BY tao_luc DESC LIMIT ${pageSize} OFFSET ${offset}`;

    // üî• T·ªêI ∆ØU: Ch·∫°y song song sau khi ƒë√£ check quy·ªÅn
    const [dataResult, countResult] = await Promise.all([
      sql.unsafe(baseQuery, params),
      sql.unsafe(countQueryBase, params),
    ]);

    return {
      success: true,
      data: Array.from(dataResult),
      total: Number(countResult[0]?.total || 0),
    };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// üîí C√ÅC H√ÄM GHI (CREATE/UPDATE/DELETE)

export async function createNhanSuAction(data: any) {
  try {
    const manager = await requireManager();
    await sql.unsafe(
      `INSERT INTO "nhan_su" (
            ho_ten, so_dien_thoai, vi_tri, vi_tri_normalized, email, 
            trang_thai, luong_thang, thuong_doanh_thu, 
            ngan_hang, so_tai_khoan, hinh_anh
        ) VALUES ($1, $2, $3, $4, $5, 'ƒêang ho·∫°t ƒë·ªông', $6, $7, $8, $9, $10)`,
      [
        data.ho_ten,
        data.so_dien_thoai,
        data.vi_tri,
        data.vi_tri_normalized,
        data.email,
        data.luong_thang || 0,
        data.thuong_doanh_thu || 0,
        data.ngan_hang || null,
        data.so_tai_khoan || null,
        data.hinh_anh || null,
      ]
    );

    // üîî G·ª¨I TH√îNG B√ÅO: Nh√¢n s·ª± m·ªõi
    sendNotificationToRoles(
      ["admin", "boss"],
      "Tuy·ªÉn d·ª•ng m·ªõi",
      `${manager.ho_ten} v·ª´a th√™m nh√¢n s·ª±: ${data.ho_ten} (${data.vi_tri})`,
      "/phongquanly",
      "user_follow",
      manager.ho_ten
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function updateNhanSuAction(id: string, data: any) {
  try {
    const manager = await requireManager();
    await sql.unsafe(
      `UPDATE "nhan_su"
       SET ho_ten = $1, so_dien_thoai = $2, vi_tri = $3, vi_tri_normalized = $4, email = $5,
           luong_thang = $6, thuong_doanh_thu = $7, ngan_hang = $8, so_tai_khoan = $9, hinh_anh = $10
       WHERE id = $11`,
      [
        data.ho_ten,
        data.so_dien_thoai,
        data.vi_tri,
        data.vi_tri_normalized,
        data.email || "",
        data.luong_thang || 0,
        data.thuong_doanh_thu || 0,
        data.ngan_hang || null,
        data.so_tai_khoan || null,
        data.hinh_anh || null,
        id,
      ]
    );

    // üîî G·ª¨I TH√îNG B√ÅO: C·∫≠p nh·∫≠t nh√¢n s·ª±
    sendNotificationToRoles(
      ["admin", "boss"],
      "C·∫≠p nh·∫≠t h·ªì s∆°",
      `${manager.ho_ten} ƒë√£ c·∫≠p nh·∫≠t th√¥ng tin c·ªßa ${data.ho_ten}`,
      "/phongquanly",
      "system_update",
      manager.ho_ten
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function deleteNhanSuAction(id: string) {
  try {
    const manager = await requireManager();
    await sql.unsafe(`DELETE FROM "nhan_su" WHERE id = $1`, [id]);

    // üîî G·ª¨I TH√îNG B√ÅO: X√≥a nh√¢n s·ª± (C·∫£nh b√°o)
    sendNotificationToRoles(
      ["admin", "boss"],
      "‚ö†Ô∏è X√≥a nh√¢n s·ª±",
      `${manager.ho_ten} ƒë√£ x√≥a m·ªôt nh√¢n s·ª± kh·ªèi h·ªá th·ªëng.`,
      "/phongquanly",
      "security_alert",
      manager.ho_ten
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function bulkUpdateNhanSuAction(
  ids: string[],
  data: { vi_tri?: string; vi_tri_normalized?: string }
) {
  try {
    await requireManager();
    if (!ids.length) return { success: false, error: "Ch∆∞a ch·ªçn nh√¢n s·ª±" };

    const setClauses: string[] = [];
    const params: any[] = [];
    let paramCount = 1;

    if (data.vi_tri) {
      setClauses.push(`vi_tri = $${paramCount}`);
      params.push(data.vi_tri);
      paramCount++;
    }
    if (data.vi_tri_normalized) {
      setClauses.push(`vi_tri_normalized = $${paramCount}`);
      params.push(data.vi_tri_normalized);
      paramCount++;
    }

    const idPlaceholders = ids.map((_, i) => `$${paramCount + i}`).join(", ");
    params.push(...ids);

    await sql.unsafe(
      `UPDATE "nhan_su" SET ${setClauses.join(
        ", "
      )} WHERE id IN (${idPlaceholders})`,
      params
    );
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// --- ü§ù NGHI·ªÜP V·ª§ KH√ÅCH H√ÄNG ---

export async function getKhachHangDataAction(
  page: number,
  pageSize: number,
  search: string,
  filterRole: string
) {
  try {
    await requireManager(); // üõ°Ô∏è B·∫¢O M·∫¨T ƒê√É B·∫¨T

    let query = `SELECT * FROM "khach_hang" WHERE 1=1`;
    let countQuery = `SELECT count(*) as total FROM "khach_hang" WHERE 1=1`;
    const params: any[] = [];
    let paramCount = 1;

    if (search) {
      const searchClause = ` AND (ho_ten ILIKE $${paramCount} OR so_dien_thoai ILIKE $${paramCount} OR email ILIKE $${paramCount})`;
      query += searchClause;
      countQuery += searchClause;
      params.push(`%${search}%`);
      paramCount++;
    }
    if (filterRole && filterRole !== "all") {
      const roleClause = ` AND phan_loai_normalized = $${paramCount}`;
      query += roleClause;
      countQuery += roleClause;
      params.push(filterRole);
      paramCount++;
    }

    const offset = (page - 1) * pageSize;
    query += ` ORDER BY tao_luc DESC LIMIT ${pageSize} OFFSET ${offset}`;

    const [data, countResult] = await Promise.all([
      sql.unsafe(query, params),
      sql.unsafe(countQuery, params),
    ]);

    return {
      success: true,
      data: Array.from(data),
      total: Number(countResult[0]?.total || 0),
    };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function createKhachHangAction(data: any) {
  try {
    const manager = await requireManager();
    const phanLoaiNorm =
      data.phan_loai_normalized ||
      (data.phan_loai
        ? data.phan_loai
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
            .replace(/\s+/g, "")
        : "moi");

    await sql.unsafe(
      `INSERT INTO "khach_hang" (ho_ten, so_dien_thoai, email, phan_loai, phan_loai_normalized, hinh_anh, dia_chi, tao_luc)
       VALUES ($1, $2, $3, $4, $5, $6, $7, now())`,
      [
        data.ho_ten,
        data.so_dien_thoai,
        data.email,
        data.phan_loai,
        phanLoaiNorm,
        data.hinh_anh || null,
        data.dia_chi || null,
      ]
    );

    // üîî G·ª¨I TH√îNG B√ÅO: Kh√°ch h√†ng m·ªõi
    // B√°o cho Sales ƒë·ªÉ chƒÉm s√≥c ngay
    sendNotificationToRoles(
      ["sales", "boss", "admin"],
      "Kh√°ch h√†ng m·ªõi",
      `${manager.ho_ten} ƒë√£ th√™m kh√°ch h√†ng ti·ªÅm nƒÉng: ${data.ho_ten}`,
      "/phongkhachhang",
      "user_follow",
      manager.ho_ten
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function updateKhachHangAction(id: string, data: any) {
  try {
    await requireManager();
    const phanLoaiNorm =
      data.phan_loai_normalized ||
      (data.phan_loai
        ? data.phan_loai
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
            .replace(/\s+/g, "")
        : "moi");

    await sql.unsafe(
      `UPDATE "khach_hang"
       SET ho_ten = $1, so_dien_thoai = $2, email = $3, phan_loai = $4, phan_loai_normalized = $5, hinh_anh = $6, dia_chi = $7
       WHERE id = $8`,
      [
        data.ho_ten,
        data.so_dien_thoai,
        data.email,
        data.phan_loai,
        phanLoaiNorm,
        data.hinh_anh || null,
        data.dia_chi || null,
        id,
      ]
    );
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function deleteKhachHangAction(id: string) {
  try {
    await requireManager();
    await sql.unsafe(`DELETE FROM "khach_hang" WHERE id = $1`, [id]);
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function bulkUpdateKhachHangAction(
  ids: string[],
  data: { phan_loai?: string; phan_loai_normalized?: string }
) {
  try {
    await requireManager();
    if (!ids.length) return { success: false, error: "Ch∆∞a ch·ªçn kh√°ch h√†ng" };

    const setClauses: string[] = [];
    const params: any[] = [];
    let paramCount = 1;

    if (data.phan_loai) {
      setClauses.push(`phan_loai = $${paramCount}`);
      params.push(data.phan_loai);
      paramCount++;
    }
    if (data.phan_loai_normalized) {
      setClauses.push(`phan_loai_normalized = $${paramCount}`);
      params.push(data.phan_loai_normalized);
      paramCount++;
    }

    const idPlaceholders = ids.map((_, i) => `$${paramCount + i}`).join(", ");
    params.push(...ids);

    await sql.unsafe(
      `UPDATE "khach_hang" SET ${setClauses.join(
        ", "
      )} WHERE id IN (${idPlaceholders})`,
      params
    );
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// --- UTILS (Dropdowns) ---
export async function getDistinctValuesAction(
  tableName: string,
  columnName: string
) {
  try {
    await requireManager(); // üõ°Ô∏è B·∫¢O M·∫¨T ƒê√É B·∫¨T
    validateIdentifier(tableName);
    validateIdentifier(columnName);

    const data = await sql.unsafe(`
            SELECT DISTINCT "${columnName}" FROM "${tableName}" 
            WHERE "${columnName}" IS NOT NULL AND "${columnName}" != ''
            ORDER BY "${columnName}" ASC
        `);
    return {
      success: true,
      data: Array.from(data).map((row) => row[columnName]),
    };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// üü¢ L·∫§Y T√ÅC PH·∫®M HO√ÄN THI·ªÜN
export async function getFinishedArtworksAction(limit: number = 50) {
  try {
    await requireManager(); // üõ°Ô∏è B·∫¢O M·∫¨T ƒê√É B·∫¨T

    const data = await sql`
            SELECT 
                nk.id, 
                nk.anh_thanh_pham, 
                nk.thoi_gian_ket_thuc,
                ns.ho_ten as ten_nghe_nhan,
                vt.ten_vat_tu as ten_tac_pham,
                vt.ma_sku,
                dh.ma_don
            FROM nhat_ky_san_xuat nk
            JOIN nhan_su ns ON nk.nhan_su_thuc_hien = ns.id
            JOIN lenh_san_xuat lsx ON nk.lenh_san_xuat_id = lsx.id
            JOIN don_hang_chi_tiet dhct ON lsx.don_hang_chi_tiet_id = dhct.id
            JOIN don_hang dh ON dhct.don_hang_id = dh.id
            JOIN vat_tu vt ON dhct.vat_tu_id = vt.id
            WHERE nk.anh_thanh_pham IS NOT NULL 
            AND nk.ket_qua = 'dat'
            ORDER BY nk.thoi_gian_ket_thuc DESC
            LIMIT ${limit}
        `;

    return { success: true, data: Array.from(data) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}
</file>

<file path="actions/QuyenHanSales.ts">
"use server";

import postgres from "postgres";
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";
// üëá IMPORT M·ªöI
import { sendNotificationToRoles } from "./NotificationAction";

const sql = postgres(process.env.DATABASE_URL!, {
  ssl: "require",
  max: 10,
  idle_timeout: 20,
});

// Helper: L·∫•y th√¥ng tin nh√¢n vi√™n ƒëang login
async function getStaffUser() {
  const cookieStore = cookies();
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
        set() {},
        remove() {},
      },
    }
  );
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) throw new Error("Unauthorized: B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p");

  // L·∫•y role v√† organization_id
  const [ns] =
    await sql`SELECT id, ho_ten, vi_tri_normalized, organization_id FROM nhan_su WHERE id = ${user.id} LIMIT 1`;
  if (!ns) throw new Error("Not a staff member: Kh√¥ng t√¨m th·∫•y h·ªì s∆° nh√¢n s·ª±");

  return ns;
}

// --- 1. NGHI·ªÜP V·ª§ CHAT T∆Ø V·∫§N (C≈©) ---
export async function claimChatSessionAction(sessionId: string) {
  try {
    const staff = await getStaffUser();

    const [session] =
      await sql`SELECT nhan_su_phu_trach_id FROM tu_van_sessions WHERE id = ${sessionId} LIMIT 1`;
    if (!session) throw new Error("Cu·ªôc h·ªôi tho·∫°i kh√¥ng t·ªìn t·∫°i");

    if (
      session.nhan_su_phu_trach_id &&
      session.nhan_su_phu_trach_id !== staff.id
    ) {
      if (["admin", "quanly", "boss"].includes(staff.vi_tri_normalized)) {
        // Admin ƒë∆∞·ª£c quy·ªÅn c∆∞·ªõp
      } else {
        return {
          success: false,
          error: "Cu·ªôc h·ªôi tho·∫°i n√†y ƒë√£ c√≥ Sales kh√°c h·ªó tr·ª£!",
        };
      }
    }

    await sql`
            UPDATE tu_van_sessions 
            SET nhan_su_phu_trach_id = ${staff.id}, 
                trang_thai = 'dang_tu_van' 
            WHERE id = ${sessionId}
        `;

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// --- 2. NGHI·ªÜP V·ª§ B√ÅN H√ÄNG (POS) ---

// L·∫•y danh s√°ch s·∫£n ph·∫©m ƒë·ªÉ b√°n
export async function getProductsForPOS(search: string) {
  try {
    await getStaffUser();
    let query = `SELECT * FROM "vat_tu" WHERE loai_vat_tu = 'thanh_pham' AND ton_kho > 0`;
    const params: any[] = [];

    if (search) {
      query += ` AND (ten_vat_tu ILIKE $1 OR ma_sku ILIKE $1)`;
      params.push(`%${search}%`);
    }

    query += ` ORDER BY ten_vat_tu ASC LIMIT 20`;
    const data = await sql.unsafe(query, params);
    return { success: true, data: Array.from(data) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// T√¨m kh√°ch h√†ng nhanh
export async function searchCustomer(term: string) {
  try {
    await getStaffUser();
    const data = await sql`
            SELECT id, ho_ten, so_dien_thoai, phan_loai 
            FROM "khach_hang" 
            WHERE ho_ten ILIKE ${"%" + term + "%"} OR so_dien_thoai ILIKE ${
      "%" + term + "%"
    }
            LIMIT 5
        `;
    return { success: true, data: Array.from(data) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// üî• QUAN TR·ªåNG: T·∫†O ƒê∆†N & T·ª∞ ƒê·ªòNG B·∫ÆN L·ªÜNH S·∫¢N XU·∫§T
export async function createPOSOrder(orderData: any) {
  try {
    const staff = await getStaffUser();

    // 1. T·∫°o ƒê∆°n h√†ng
    // Tr·∫°ng th√°i 'dang_san_xuat' ƒë·ªÉ k√≠ch ho·∫°t quy tr√¨nh
    const [newOrder] = await sql`
            INSERT INTO "don_hang" (
                khach_hang_id, sales_phu_trach_id, nguoi_tao_id, organization_id,
                trang_thai, tong_tien, da_thanh_toan, kenh_ban_hang, ghi_chu
            ) VALUES (
                ${orderData.khach_hang_id}, ${staff.id}, ${staff.id}, ${staff.organization_id},
                'dang_san_xuat', ${orderData.tong_tien}, ${orderData.da_thanh_toan}, 'pos', ${orderData.ghi_chu}
            ) RETURNING id, ma_don
        `;

    // 2. L·∫•y quy tr√¨nh m·∫´u m·∫∑c ƒë·ªãnh (ƒê·ªÉ g·∫Øn v√†o l·ªánh SX)
    // Trong th·ª±c t·∫ø c√≥ th·ªÉ ch·ªçn quy tr√¨nh, ·ªü ƒë√¢y l·∫•y m·∫∑c ƒë·ªãnh c√°i ƒë·∫ßu ti√™n t√¨m th·∫•y
    const [defaultProcess] = await sql`SELECT id FROM quy_trinh_mau LIMIT 1`;
    const quyTrinhId = defaultProcess?.id || null;
    let hasJob = false;

    // 3. T·∫°o Chi ti·∫øt ƒë∆°n & L·ªánh S·∫£n Xu·∫•t (Job)
    for (const item of orderData.items) {
      // A. Insert Chi ti·∫øt ƒë∆°n
      const [newItem] = await sql`
                INSERT INTO "don_hang_chi_tiet" (
                    don_hang_id, vat_tu_id, ten_item_hien_thi, so_luong, don_gia
                ) VALUES (
                    ${newOrder.id}, ${item.id}, ${item.ten_vat_tu}, ${item.so_luong}, ${item.don_gia}
                ) RETURNING id
            `;

      // B. T·∫†O L·ªÜNH S·∫¢N XU·∫§T (Treo l√™n "S√†n vi·ªác" cho th·ª£ nh·∫≠n)
      if (quyTrinhId) {
        hasJob = true;
        // T·∫°o m√£ l·ªánh ng·∫´u nhi√™n
        const maLenh = "LSX-" + Math.floor(100000 + Math.random() * 900000);

        await sql`
                    INSERT INTO "lenh_san_xuat" (
                        ma_lenh, organization_id, don_hang_chi_tiet_id, quy_trinh_id,
                        trang_thai, tien_do, nguoi_phu_trach
                    ) VALUES (
                        ${maLenh}, 
                        ${staff.organization_id},
                        ${newItem.id}, ${quyTrinhId},
                        'moi', 0, NULL -- NULL = Ch∆∞a ai nh·∫≠n (Available Job)
                    )
                `;
      }
    }

    // 4. Ghi nh·∫≠n Thu ti·ªÅn (n·∫øu kh√°ch tr·∫£ ngay)
    if (orderData.da_thanh_toan > 0) {
      await sql`
                INSERT INTO "so_cai_tai_chinh" (
                    loai_giao_dich, so_tien, mo_ta, tham_chieu_id, nguoi_thuc_hien, organization_id
                ) VALUES (
                    'thu', ${orderData.da_thanh_toan}, ${
        "Thu ti·ªÅn ƒë∆°n " + newOrder.ma_don
      }, ${newOrder.id}, ${staff.id}, ${staff.organization_id}
                )
            `;
    }

    // üîî G·ª¨I TH√îNG B√ÅO ƒêA K√äNH
    // Logic: B√°o cho Admin, Qu·∫£n l√Ω, Kho, K·∫ø to√°n
    const targetRoles = ["admin", "boss", "quanly", "kho", "ketoan"];
    // N·∫øu c√≥ l·ªánh s·∫£n xu·∫•t -> B√°o th√™m cho Th·ª£
    if (hasJob) targetRoles.push("thosanxuat");

    sendNotificationToRoles(
      targetRoles,
      `ƒê∆°n h√†ng m·ªõi: ${newOrder.ma_don}`,
      `${staff.ho_ten} v·ª´a ch·ªët ƒë∆°n th√†nh c√¥ng! Doanh thu: ${Number(
        orderData.tong_tien
      ).toLocaleString()}ƒë`,
      "/dathang", // Link m·ªü danh s√°ch ƒë∆°n
      "order_created", // Icon
      staff.ho_ten
    );

    return { success: true, ma_don: newOrder.ma_don };
  } catch (error: any) {
    console.error("L·ªói t·∫°o ƒë∆°n POS:", error);
    return { success: false, error: error.message };
  }
}
</file>

<file path="actions/QuyenHanSanXuat.ts">
"use server";
import postgres from "postgres";
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";
// üëá IMPORT M·ªöI
import { sendNotificationToRoles } from "./NotificationAction";

const sql = postgres(process.env.DATABASE_URL!, { ssl: "require" });

async function requireAuth() {
  const cookieStore = cookies();
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
        set() {},
        remove() {},
      },
    }
  );
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) throw new Error("Unauthorized");
  // L·∫•y th√™m t√™n ƒë·ªÉ g·ª≠i noti
  const [ns] = await sql`SELECT id, ho_ten FROM nhan_su WHERE id = ${user.id}`;
  return ns;
}

// 1. L·∫§Y VI·ªÜC C·ª¶A T√îI (ƒê√£ nh·∫≠n, ch∆∞a xong)
export async function getMyTasksAction() {
  try {
    const user = await requireAuth();

    const data = await sql`
            SELECT 
                lsx.id, lsx.ma_lenh, lsx.trang_thai, lsx.tien_do, lsx.bat_dau_luc,
                ct.ten_item_hien_thi, ct.so_luong,
                qt.ten_quy_trinh,
                dh.ma_don, dh.ghi_chu as ghi_chu_don
            FROM "lenh_san_xuat" lsx
            JOIN "don_hang_chi_tiet" ct ON lsx.don_hang_chi_tiet_id = ct.id
            JOIN "don_hang" dh ON ct.don_hang_id = dh.id
            LEFT JOIN "quy_trinh_mau" qt ON lsx.quy_trinh_id = qt.id
            WHERE lsx.nguoi_phu_trach = ${user.id}
            AND lsx.trang_thai != 'hoan_thanh'
            ORDER BY dh.tao_luc ASC
        `;

    return { success: true, data: Array.from(data) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 2. L·∫§Y VI·ªÜC M·ªöI (S√†n vi·ªác - Ch∆∞a ai nh·∫≠n)
export async function getAvailableJobsAction() {
  try {
    await requireAuth();

    // L·∫•y c√°c l·ªánh SX m√† nguoi_phu_trach l√† NULL
    const data = await sql`
            SELECT 
                lsx.id, lsx.ma_lenh, lsx.trang_thai,
                ct.ten_item_hien_thi, ct.so_luong,
                qt.ten_quy_trinh,
                dh.ma_don, dh.ghi_chu as ghi_chu_don
            FROM "lenh_san_xuat" lsx
            JOIN "don_hang_chi_tiet" ct ON lsx.don_hang_chi_tiet_id = ct.id
            JOIN "don_hang" dh ON ct.don_hang_id = dh.id
            LEFT JOIN "quy_trinh_mau" qt ON lsx.quy_trinh_id = qt.id
            WHERE lsx.nguoi_phu_trach IS NULL 
            AND lsx.trang_thai = 'moi'
            ORDER BY dh.tao_luc DESC
            LIMIT 50
        `;
    return { success: true, data: Array.from(data) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 3. NH·∫¨N VI·ªÜC (Claim Job)
export async function claimJobAction(jobId: string) {
  try {
    const user = await requireAuth();

    // Update ng∆∞·ªùi ph·ª• tr√°ch = User ƒëang login
    const result = await sql`
            UPDATE "lenh_san_xuat"
            SET nguoi_phu_trach = ${user.id},
                trang_thai = 'dang_lam',
                bat_dau_luc = NOW()
            WHERE id = ${jobId} 
            AND nguoi_phu_trach IS NULL
            RETURNING ma_lenh
        `;

    if (result.count === 0) {
      return {
        success: false,
        error: "C√¥ng vi·ªác n√†y ƒë√£ b·ªã ng∆∞·ªùi kh√°c nh·∫≠n m·∫•t r·ªìi!",
      };
    }

    // üîî B√ÅO QU·∫¢N L√ù
    sendNotificationToRoles(
      ["admin", "quanly"],
      "Ti·∫øn ƒë·ªô s·∫£n xu·∫•t",
      `Th·ª£ ${user.ho_ten} ƒë√£ nh·∫≠n l·ªánh s·∫£n xu·∫•t: ${result[0].ma_lenh}`,
      "/phongsanxuat",
      "workshop_new",
      user.ho_ten
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 4. B·∫ÆT ƒê·∫¶U L√ÄM (Start Timer)
export async function startJobAction(jobId: string) {
  try {
    await requireAuth();
    await sql`
            UPDATE "lenh_san_xuat"
            SET trang_thai = 'dang_lam', 
                bat_dau_luc = COALESCE(bat_dau_luc, NOW()), -- Ch·ªâ set n·∫øu ch∆∞a c√≥
                cap_nhat_luc = NOW()
            WHERE id = ${jobId}
        `;
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 5. HO√ÄN TH√ÄNH VI·ªÜC (Finish & Get Paid)
export async function completeJobAction(
  jobId: string,
  resultImage: string,
  note: string
) {
  try {
    const user = await requireAuth();

    // D√πng transaction ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn
    await sql.begin(async (sql) => {
      // A. C·∫≠p nh·∫≠t L·ªánh SX th√†nh ho√†n th√†nh
      const [job] = await sql`
                UPDATE "lenh_san_xuat"
                SET trang_thai = 'hoan_thanh',
                    tien_do = 100,
                    ket_thuc_luc = NOW()
                WHERE id = ${jobId}
                RETURNING ma_lenh
            `;

      // B. Ghi nh·∫≠t k√Ω (ƒê·ªÉ k√≠ch ho·∫°t Trigger t√≠nh l∆∞∆°ng)
      // L·∫•y th√¥ng tin t·ª´ l·ªánh sx ƒë·ªÉ ghi log
      await sql`
                INSERT INTO "nhat_ky_san_xuat" (
                    lenh_san_xuat_id, nhan_su_thuc_hien, 
                    thoi_gian_bat_dau, thoi_gian_ket_thuc,
                    ket_qua, anh_thanh_pham, diem_thuong_nhan_duoc
                )
                SELECT 
                    id, ${user.id}, 
                    bat_dau_luc, NOW(),
                    'dat', ${resultImage}, 10 -- Th∆∞·ªüng m·∫∑c ƒë·ªãnh 10 ƒëi·ªÉm
                FROM "lenh_san_xuat"
                WHERE id = ${jobId}
            `;

      // üîî B√ÅO SALES & ADMIN ƒê·ªÇ GIAO H√ÄNG
      sendNotificationToRoles(
        ["admin", "quanly", "sales"],
        "S·∫£n xu·∫•t ho√†n t·∫•t ‚úÖ",
        `${user.ho_ten} ƒë√£ ho√†n th√†nh l·ªánh ${job.ma_lenh}. S·∫£n ph·∫©m ƒë√£ s·∫µn s√†ng giao!`,
        "/phongsanxuat",
        "artwork_featured",
        user.ho_ten
      );
    });

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 6. L·∫§Y L∆Ø∆†NG H√îM NAY (Motivational Metric)
export async function getMySalaryToday() {
  try {
    const user = await requireAuth();
    // T√≠nh t·ªïng l∆∞∆°ng c·ªßa th√°ng hi·ªán t·∫°i
    const [res] = await sql`
            SELECT SUM(tong_thu_nhap) as total
            FROM "bang_luong"
            WHERE nhan_su_id = ${user.id}
            AND thang = EXTRACT(MONTH FROM CURRENT_DATE)
            AND nam = EXTRACT(YEAR FROM CURRENT_DATE)
        `;
    return { success: true, total: Number(res?.total || 0) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}
</file>

<file path="actions/QuyenHanThietKe.ts">
"use server";
import postgres from "postgres";
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";
// üëá IMPORT M·ªöI: Action g·ª≠i th√¥ng b√°o trung t√¢m
import { sendNotificationToRoles } from "./NotificationAction";

const sql = postgres(process.env.DATABASE_URL!, {
  ssl: "require",
  max: 10,
  idle_timeout: 20,
});

// --- HELPER: CHU·∫®N H√ìA T√äN FILE (Ch·ªâ x·ª≠ l√Ω text, kh√¥ng g·∫Øn user) ---
const standardizeBasicName = (inputName: string) => {
  let name = inputName.trim();

  // 1. Vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu (VD: "th·ªç" -> "Th·ªç")
  if (name.length > 0) {
    name = name.charAt(0).toUpperCase() + name.slice(1);
  }

  // 2. T·ª± ƒë·ªông th√™m "cm" v√† d·∫•u g·∫°ch ngang cho k√≠ch th∆∞·ªõc
  // VD: "20x30" -> " - 20x30cm"
  name = name.replace(/(\d+)\s*[xX*]\s*(\d+)\s*(cm|CM)?/g, (match, w, h) => {
    return ` - ${w}x${h}cm`;
  });

  // 3. X·ª≠ l√Ω d·∫•u g·∫°ch ngang b·ªã th·ª´a
  name = name
    .replace(/\s*-\s*-\s*/g, " - ")
    .replace(/\s*-\s*/g, " - ")
    .replace(/^\s*-\s*/, "");

  return name;
};

// --- HELPER: X·ª¨ L√ù LIST FILE TR∆Ø·ªöC KHI L∆ØU ---
const processFileList = (input: any, currentUser: string) => {
  if (!input) return "[]";

  let files: any[] = [];

  // Parse d·ªØ li·ªáu ƒë·∫ßu v√†o
  try {
    if (Array.isArray(input)) files = input;
    else if (typeof input === "string") {
      const parsed = JSON.parse(input);
      if (Array.isArray(parsed)) files = parsed;
    }
  } catch {
    return "[]";
  }

  // X·ª≠ l√Ω t·ª´ng file
  const processedFiles = files
    .map((file: any) => {
      const now = new Date().toISOString();

      // TR∆Ø·ªúNG H·ª¢P 1: File l√† string (ki·ªÉu c≈©) -> convert sang object m·ªõi
      if (typeof file === "string") {
        return {
          ten: standardizeBasicName("File ƒë√≠nh k√®m"),
          url: file,
          nguoi_dang: currentUser, // G·∫Øn ng∆∞·ªùi ƒëang s·ª≠a v√¨ file c≈© ch∆∞a c√≥ info
          last_modified: now,
        };
      }

      // TR∆Ø·ªúNG H·ª¢P 2: L√† object chu·∫©n
      if (typeof file === "object" && file.url) {
        // Logic b·∫£o to√†n l·ªãch s·ª≠:
        // - N·∫øu file ƒë√£ c√≥ 'nguoi_dang' (file c≈©) -> Gi·ªØ nguy√™n.
        // - N·∫øu ch∆∞a c√≥ (file m·ªõi th√™m) -> G√°n currentUser.
        const uploader = file.nguoi_dang || currentUser;

        // - N·∫øu file c≈© -> Gi·ªØ nguy√™n th·ªùi gian.
        // - N·∫øu m·ªõi -> L·∫•y th·ªùi gian hi·ªán t·∫°i.
        const timestamp = file.last_modified || now;

        return {
          ...file,
          // Lu√¥n chu·∫©n h√≥a l·∫°i t√™n (ƒë·ªÉ s·ª≠a l·ªói ch√≠nh t·∫£ n·∫øu user m·ªõi nh·∫≠p)
          ten: standardizeBasicName(file.ten || "File thi·∫øt k·∫ø"),
          nguoi_dang: uploader,
          last_modified: timestamp,
        };
      }
      return null;
    })
    .filter(Boolean); // L·ªçc b·ªè null

  return JSON.stringify(processedFiles);
};

// --- CORE AUTH ---
async function requireAuth() {
  const cookieStore = cookies();
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
        set() {},
        remove() {},
      },
    }
  );
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user || !user.email) throw new Error("Unauthorized: Vui l√≤ng ƒëƒÉng nh·∫≠p");
  return user;
}

async function checkOwnershipOrAdmin(
  userEmail: string,
  resourceId?: string,
  action: "update" | "delete" = "update"
) {
  const [nhanSu] = await sql`
        SELECT id, vi_tri_normalized, ho_ten 
        FROM nhan_su 
        WHERE email = ${userEmail}
    `;

  if (!nhanSu) throw new Error("Kh√¥ng t√¨m th·∫•y th√¥ng tin nh√¢n s·ª±.");

  const role = nhanSu.vi_tri_normalized || "";
  const isAdmin = ["admin", "quanly", "boss"].includes(role);

  // Tr·∫£ v·ªÅ c·∫£ info nh√¢n s·ª± ƒë·ªÉ d√πng t√™n
  const userInfo = { id: nhanSu.id, name: nhanSu.ho_ten || "Nh√¢n vi√™n" };

  if (isAdmin) return userInfo;

  if (action === "delete") {
    throw new Error("‚õî B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a (Ch·ªâ Admin m·ªõi ƒë∆∞·ª£c x√≥a).");
  }

  if (resourceId) {
    const [mau] =
      await sql`SELECT nguoi_tao FROM mau_thiet_ke WHERE id = ${resourceId}`;
    if (!mau) throw new Error("M·∫´u kh√¥ng t·ªìn t·∫°i.");
    if (mau.nguoi_tao !== nhanSu.id) {
      throw new Error("‚õî B·∫°n ch·ªâ ƒë∆∞·ª£c ph√©p s·ª≠a m·∫´u do ch√≠nh m√¨nh t·∫°o ra.");
    }
  }
  return userInfo;
}

// --- ACTIONS ---

export async function getMauThietKeDataAction(
  page: number,
  pageSize: number,
  search: string,
  filterCategory: string
) {
  try {
    await requireAuth();
    let query = `
            SELECT m.*, n.ho_ten as ten_nguoi_tao 
            FROM "mau_thiet_ke" m
            LEFT JOIN "nhan_su" n ON m.nguoi_tao = n.id
            WHERE 1=1
        `;
    const params: any[] = [];
    let paramCount = 1;

    if (search) {
      query += ` AND (m.mo_ta ILIKE $${paramCount})`;
      params.push(`%${search}%`);
      paramCount++;
    }

    if (filterCategory && filterCategory !== "all") {
      if (filterCategory === "has_file") {
        query += ` AND m.file_thiet_ke IS NOT NULL AND m.file_thiet_ke::text != '[]' AND m.file_thiet_ke::text != '' `;
      } else {
        query += ` AND m.phan_loai_normalized = $${paramCount}`;
        params.push(filterCategory);
        paramCount++;
      }
    }

    const countQuery = `SELECT count(*) as total FROM (${query}) as sub`;
    const offset = (page - 1) * pageSize;
    query += ` ORDER BY m.tao_luc DESC LIMIT ${pageSize} OFFSET ${offset}`;

    const data = await sql.unsafe(query, params);
    const [countResult] = await sql.unsafe(countQuery, params);

    return {
      success: true,
      data: Array.from(data),
      total: Number(countResult.total),
    };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function createMauThietKeAction(data: any) {
  try {
    const user = await requireAuth();
    // L·∫•y th√¥ng tin ng∆∞·ªùi d√πng ƒëang thao t√°c
    const [nhanSu] = await sql`SELECT id, ho_ten FROM nhan_su WHERE email = ${
      user.email || ""
    }`;
    if (!nhanSu) throw new Error("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c danh t√≠nh nh√¢n s·ª±.");

    const phanLoaiNorm =
      data.phan_loai_normalized ||
      (data.phan_loai
        ? data.phan_loai
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/\s+/g, "")
            .toLowerCase()
        : "");

    // üü¢ T·ª∞ ƒê·ªòNG CHU·∫®N H√ìA T√äN FILE + G·∫ÆN NG∆Ø·ªúI T·∫†O
    const fileThietKeJson = processFileList(
      data.file_thiet_ke,
      nhanSu.ho_ten || "Admin"
    );

    await sql.unsafe(
      `
            INSERT INTO "mau_thiet_ke" (
                mo_ta, phan_loai, phan_loai_normalized, hinh_anh, 
                file_thiet_ke, nguoi_tao, tao_luc
            )
            VALUES ($1, $2, $3, $4, $5, $6, now())
        `,
      [
        data.mo_ta,
        data.phan_loai,
        phanLoaiNorm,
        data.hinh_anh,
        fileThietKeJson,
        nhanSu.id,
      ]
    );

    // üîî G·ª¨I TH√îNG B√ÅO T·ª∞ ƒê·ªòNG
    // Logic: B√°o cho Admin, Boss, Qu·∫£n l√Ω v√† Ph√≤ng Thi·∫øt k·∫ø
    sendNotificationToRoles(
      ["admin", "boss", "quanly", "thietke"],
      "M·∫´u thi·∫øt k·∫ø m·ªõi",
      `${nhanSu.ho_ten} v·ª´a th√™m m·∫´u: "${data.mo_ta}"`,
      "/phongthietke", // Link m·ªü khi click
      "artwork_new", // Icon type
      nhanSu.ho_ten // Ng∆∞·ªùi g·ª≠i
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function updateMauThietKeAction(id: string, data: any) {
  try {
    const user = await requireAuth();
    // Check quy·ªÅn v√† l·∫•y lu√¥n th√¥ng tin ng∆∞·ªùi ƒëang s·ª≠a (currentUser)
    const currentUser = await checkOwnershipOrAdmin(
      user.email || "",
      id,
      "update"
    );

    const phanLoaiNorm =
      data.phan_loai_normalized ||
      (data.phan_loai
        ? data.phan_loai
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/\s+/g, "")
            .toLowerCase()
        : "");

    // üü¢ T·ª∞ ƒê·ªòNG CHU·∫®N H√ìA T√äN FILE
    const fileThietKeJson = processFileList(
      data.file_thiet_ke,
      currentUser.name || "Admin"
    );

    await sql.unsafe(
      `
            UPDATE "mau_thiet_ke"
            SET mo_ta = $1,
                phan_loai = $2,
                phan_loai_normalized = $3,
                hinh_anh = $4,
                file_thiet_ke = $5,
                tao_luc = now()
            WHERE id = $6
        `,
      [
        data.mo_ta,
        data.phan_loai,
        phanLoaiNorm,
        data.hinh_anh,
        fileThietKeJson,
        id,
      ]
    );

    // üîî G·ª¨I TH√îNG B√ÅO C·∫¨P NH·∫¨T
    sendNotificationToRoles(
      ["admin", "boss", "quanly", "thietke"],
      "C·∫≠p nh·∫≠t m·∫´u thi·∫øt k·∫ø",
      `${currentUser.name} v·ª´a c·∫≠p nh·∫≠t m·∫´u: "${data.mo_ta}"`,
      "/phongthietke",
      "system_update",
      currentUser.name
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function deleteMauThietKeAction(id: string) {
  try {
    const user = await requireAuth();
    const currentUser = await checkOwnershipOrAdmin(
      user.email || "",
      id,
      "delete"
    );

    await sql.unsafe(`DELETE FROM "mau_thiet_ke" WHERE id = $1`, [id]);

    // üîî G·ª¨I TH√îNG B√ÅO X√ìA (Ch·ªâ b√°o cho Admin/Boss bi·∫øt c√≥ ng∆∞·ªùi x√≥a)
    sendNotificationToRoles(
      ["admin", "boss"],
      "ƒê√£ x√≥a m·∫´u thi·∫øt k·∫ø",
      `${currentUser.name} ƒë√£ x√≥a m·ªôt m·∫´u thi·∫øt k·∫ø kh·ªèi h·ªá th·ªëng.`,
      "/phongthietke",
      "system_alert",
      currentUser.name
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}
</file>

<file path="api/fs/content/route.ts">
import { NextResponse } from 'next/server';
import fs from 'fs';
import path from 'path';

// üõ°Ô∏è CH·ªà CHO PH√âP CH·∫†Y KHI ƒêANG DEV TR√äN M√ÅY LOCAL
const isDev = process.env.NODE_ENV === 'development';

export async function POST(req: Request) {
    if (!isDev) {
        return NextResponse.json({ error: 'T√≠nh nƒÉng n√†y b·ªã v√¥ hi·ªáu h√≥a tr√™n m√¥i tr∆∞·ªùng m·∫°ng.' }, { status: 403 });
    }

    try {
        const { filePath, content } = await req.json();
        
        // üõ°Ô∏è Sanitize Path: Ch·∫∑n vi·ªác truy c·∫≠p ra kh·ªèi th∆∞ m·ª•c d·ª± √°n (Directory Traversal)
        if (filePath.includes('..')) {
            return NextResponse.json({ error: 'ƒê∆∞·ªùng d·∫´n kh√¥ng h·ª£p l·ªá' }, { status: 400 });
        }

        const fullPath = path.join(process.cwd(), filePath);

        if (content !== undefined) {
            fs.writeFileSync(fullPath, content, 'utf-8');
            return NextResponse.json({ success: true });
        } else {
            if (!fs.existsSync(fullPath)) return NextResponse.json({ error: 'File 404' }, { status: 404 });
            const fileContent = fs.readFileSync(fullPath, 'utf-8');
            return NextResponse.json({ content: fileContent });
        }
    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="api/fs/list/route.ts">
import { NextResponse } from 'next/server';
import fs from 'fs';
import path from 'path';

// H√†m ƒë·ªá quy qu√©t file
const getFiles = (dir: string, fileList: string[] = [], rootDir: string) => {
    const files = fs.readdirSync(dir);

    files.forEach((file) => {
        const filePath = path.join(dir, file);
        const stat = fs.statSync(filePath);

        // B·ªè qua c√°c th∆∞ m·ª•c r√°c h·ªá th·ªëng
        if (file === 'node_modules' || file === '.next' || file === '.git' || file === '.vscode') {
            return;
        }

        if (stat.isDirectory()) {
            getFiles(filePath, fileList, rootDir);
        } else {
            // Ch·ªâ l·∫•y ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi ƒë·ªÉ hi·ªÉn th·ªã cho ƒë·∫πp
            // V√≠ d·ª•: app/page.tsx thay v√¨ C:/Users/.../app/page.tsx
            const relativePath = path.relative(rootDir, filePath).replace(/\\/g, '/');
            fileList.push(relativePath);
        }
    });

    return fileList;
};

export async function GET() {
    try {
        const rootDir = process.cwd(); // L·∫•y th∆∞ m·ª•c g·ªëc c·ªßa d·ª± √°n
        const files = getFiles(rootDir, [], rootDir);
        return NextResponse.json({ files });
    } catch (error) {
        return NextResponse.json({ error: 'L·ªói ƒë·ªçc file h·ªá th·ªëng' }, { status: 500 });
    }
}
</file>

<file path="api/fs/manager/route.ts">
import { NextResponse } from 'next/server';
import fs from 'fs';
import path from 'path';

// üõ°Ô∏è B·∫¢O M·∫¨T
const isDev = process.env.NODE_ENV === 'development';

export async function POST(req: Request) {
    // üõë CH·∫∂N TUY·ªÜT ƒê·ªêI
    if (!isDev) {
        return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }

    try {
        const { action, path: targetPath, newName, type } = await req.json();
        
        // üõ°Ô∏è B·∫¢O M·∫¨T PATH
        if (targetPath.includes('..')) return NextResponse.json({ error: 'Invalid path' }, { status: 400 });

        const fullPath = path.join(process.cwd(), targetPath);

        switch (action) {
            case 'create':
                if (type === 'folder') {
                    if (!fs.existsSync(fullPath)) fs.mkdirSync(fullPath, { recursive: true });
                } else {
                    if (!fs.existsSync(fullPath)) fs.writeFileSync(fullPath, '', 'utf-8');
                }
                break;

            case 'rename':
                // üõ°Ô∏è B·∫£o m·∫≠t t√™n m·ªõi
                if (!newName || newName.includes('/') || newName.includes('\\')) {
                    return NextResponse.json({ error: 'T√™n file kh√¥ng h·ª£p l·ªá' }, { status: 400 });
                }
                const newPath = path.join(path.dirname(fullPath), newName);
                if (fs.existsSync(fullPath)) fs.renameSync(fullPath, newPath);
                break;

            case 'delete':
                if (fs.existsSync(fullPath)) {
                    // üõ°Ô∏è CH·ªêNG X√ìA NH·∫¶M FILE H·ªÜ TH·ªêNG
                    if (fullPath === process.cwd()) {
                         return NextResponse.json({ error: 'Kh√¥ng th·ªÉ x√≥a root' }, { status: 403 });
                    }
                    fs.rmSync(fullPath, { recursive: true, force: true });
                }
                break;
                
            default:
                return NextResponse.json({ error: 'H√†nh ƒë·ªông kh√¥ng h·ª£p l·ªá' }, { status: 400 });
        }

        return NextResponse.json({ success: true });
    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="api/fs/open/route.ts">
import { NextResponse } from 'next/server';
import { exec } from 'child_process';
import path from 'path';

const isDev = process.env.NODE_ENV === 'development';

export async function POST(req: Request) {
    if (!isDev) return NextResponse.json({ error: 'Forbidden' }, { status: 403 });

    try {
        const { filePath } = await req.json();
        if (filePath.includes('..')) return NextResponse.json({ error: 'Invalid path' }, { status: 400 });
        
        const fullPath = path.join(process.cwd(), filePath); 

        let command = '';
        
        // üõ°Ô∏è B·∫¢O M·∫¨T: Ch·ªâ cho ph√©p m·ªü file, kh√¥ng inject l·ªánh l·∫°
        // S·ª≠ d·ª•ng JSON.stringify ƒë·ªÉ escape ƒë∆∞·ªùng d·∫´n, tr√°nh injection
        switch (process.platform) {
            case 'win32': 
                command = `explorer /select,${JSON.stringify(fullPath)}`; 
                break;
            case 'darwin': 
                command = `open -R ${JSON.stringify(fullPath)}`;
                break;
            default: 
                command = `xdg-open ${JSON.stringify(path.dirname(fullPath))}`;
        }

        exec(command, (error) => {
            if (error) console.error("L·ªói m·ªü th∆∞ m·ª•c:", error);
        });

        return NextResponse.json({ success: true });
    } catch (error) {
        return NextResponse.json({ error: 'L·ªói server' }, { status: 500 });
    }
}
</file>

<file path="api/push/notify-staff/route.ts">
import { createClient } from "@supabase/supabase-js";
import { NextResponse } from "next/server";

// Kh·ªüi t·∫°o Supabase Admin (Quy·ªÅn t·ªëi cao ƒë·ªÉ ghi th√¥ng b√°o cho ng∆∞·ªùi kh√°c)
const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY! // L∆∞u √Ω: C·∫ßn bi·∫øn m√¥i tr∆∞·ªùng n√†y trong .env.local
);

export async function POST(req: Request) {
  try {
    const body = await req.json();
    const { title, body: message, url, sessionId, targetStaffId } = body;

    // 1. X√ÅC ƒê·ªäNH NG∆Ø·ªúI NH·∫¨N
    let targetIds: string[] = [];

    if (targetStaffId) {
      // A. N·∫øu ƒë√£ ch·ªâ ƒë·ªãnh ƒë√≠ch danh (VD: Kh√°ch c≈© nh·∫Øn cho Sales ph·ª• tr√°ch)
      targetIds = [targetStaffId];
    } else {
      // B. N·∫øu kh√¥ng ch·ªâ ƒë·ªãnh (VD: Kh√°ch m·ªõi, ƒêƒÉng k√Ω m·ªõi) -> G·ª≠i cho to√†n b·ªô Admin/Sales/Qu·∫£n l√Ω
      // L·∫•y danh s√°ch nh√¢n vi√™n ƒëang l√†m vi·ªác c√≥ role ph√π h·ª£p
      const { data: staff } = await supabaseAdmin
        .from("nhan_su")
        .select("id")
        .eq("trang_thai", "dang_lam_viec")
        .in("vi_tri_normalized", ["admin", "quanly", "sales"]);

      if (staff) {
        targetIds = staff.map((s) => s.id);
      }
    }

    if (targetIds.length === 0) {
      return NextResponse.json(
        { message: "Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n n√†o ƒë·ªÉ b√°o" },
        { status: 200 }
      );
    }

    // 2. T·∫†O D·ªÆ LI·ªÜU TH√îNG B√ÅO (Chu·∫©n b·ªã insert v√†o DB)
    const notificationsToInsert = targetIds.map((userId) => ({
      user_id: userId,
      type: "system_alert", // Lo·∫°i th√¥ng b√°o
      category: sessionId ? "chat" : "system", // Ph√¢n lo·∫°i
      title: title,
      message: message,
      action_url: url,
      related_id: sessionId || null,
      is_read: false,
      from_user_name: "H·ªá th·ªëng",
      from_user_avatar:
        "https://ui-avatars.com/api/?name=System&background=C69C6D&color=fff",
    }));

    // 3. L∆ØU V√ÄO B·∫¢NG notifications
    const { error } = await supabaseAdmin
      .from("notifications")
      .insert(notificationsToInsert);

    if (error) {
      console.error("L·ªói l∆∞u th√¥ng b√°o:", error);
      return NextResponse.json({ error: error.message }, { status: 500 });
    }

    // --- (N√ÇNG CAO) PH·∫¶N B·∫ÆN WEB PUSH (N·∫øu m√†y c√≥ c√†i th∆∞ vi·ªán web-push) ---
    // Ph·∫ßn n√†y ƒë·ªÉ m·ªü r·ªông sau: Duy·ªát qua b·∫£ng push_subscriptions v√† b·∫Øn tin t·ªõi tr√¨nh duy·ªát
    // ...

    return NextResponse.json({ success: true, count: targetIds.length });
  } catch (err: any) {
    console.error("API Error:", err);
    return NextResponse.json(
      { error: "Internal Server Error" },
      { status: 500 }
    );
  }
}
</file>

<file path="api/push/subscribe/notify-staff/route.ts">
import { NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";
import webPush from "web-push";

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

webPush.setVapidDetails(
  process.env.VAPID_SUBJECT!,
  process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY!,
  process.env.VAPID_PRIVATE_KEY!
);

export async function POST(req: Request) {
  try {
    const { title, body, url } = await req.json();

    // 1. L·∫•y danh s√°ch ID c·ªßa nh√¢n s·ª± c√≥ quy·ªÅn Sales/Admin/Qu·∫£n l√Ω
    const { data: staffList } = await supabase
      .from("nhan_su")
      .select("id")
      .in("vi_tri_normalized", ["admin", "boss", "quanly", "sales"]);

    if (!staffList || staffList.length === 0) {
      return NextResponse.json({ message: "No staff found" });
    }

    const staffIds = staffList.map((s) => s.id);

    // 2. L·∫•y c√°c thi·∫øt b·ªã ƒë√£ ƒëƒÉng k√Ω Push c·ªßa nh·ªØng nh√¢n s·ª± n√†y
    const { data: subs } = await supabase
      .from("push_subscriptions")
      .select("*")
      .in("user_id", staffIds);

    if (!subs || subs.length === 0) {
      return NextResponse.json({ message: "No subscriptions found" });
    }

    // 3. G·ª≠i th√¥ng b√°o h√†ng lo·∫°t
    const payload = JSON.stringify({
      title: title || "Kh√°ch h√†ng m·ªõi!",
      body: body || "C√≥ kh√°ch h√†ng ƒëang c·∫ßn t∆∞ v·∫•n.",
      url: url || "/phongsales",
    });

    const promises = subs.map((sub) => {
      const pushConfig = {
        endpoint: sub.endpoint,
        keys: { auth: sub.auth, p256dh: sub.p256dh },
      };
      return webPush.sendNotification(pushConfig, payload).catch((err) => {
        if (err.statusCode === 410 || err.statusCode === 404) {
          supabase.from("push_subscriptions").delete().eq("id", sub.id).then();
        }
      });
    });

    await Promise.all(promises);

    return NextResponse.json({ success: true, count: subs.length });
  } catch (error: any) {
    console.error("Notify Staff Error:", error);
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}
</file>

<file path="api/push/subscribe/route.ts">
import { NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY! // D√πng Service Key ƒë·ªÉ bypass RLS n·∫øu c·∫ßn
);

export async function POST(req: Request) {
    try {
        const { subscription, user_id, user_agent } = await req.json();

        if (!subscription || !subscription.endpoint || !user_id) {
            return NextResponse.json({ error: 'Missing data' }, { status: 400 });
        }

        // L∆∞u v√†o DB
        const { error } = await supabase.from('push_subscriptions').upsert({
            user_id,
            endpoint: subscription.endpoint,
            p256dh: subscription.keys.p256dh,
            auth: subscription.keys.auth,
            user_agent: user_agent,
            created_at: new Date().toISOString()
        }, { onConflict: 'user_id, endpoint' });

        if (error) throw error;

        return NextResponse.json({ success: true });
    } catch (error: any) {
        console.error('Subscribe Error:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="api/push/subscribe/send/route.ts">
import { NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import webPush from 'web-push';

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

// C·∫•u h√¨nh Web Push
webPush.setVapidDetails(
    process.env.VAPID_SUBJECT!,
    process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY!,
    process.env.VAPID_PRIVATE_KEY!
);

export async function POST(req: Request) {
    try {
        // userId: Ng∆∞·ªùi nh·∫≠n, title: Ti√™u ƒë·ªÅ, body: N·ªôi dung, url: Link ƒë√≠ch
        const { userId, title, body, url } = await req.json();

        // 1. L·∫•y danh s√°ch thi·∫øt b·ªã c·ªßa User ƒë√≥
        const { data: subs } = await supabase
            .from('push_subscriptions')
            .select('*')
            .eq('user_id', userId);

        if (!subs || subs.length === 0) {
            return NextResponse.json({ message: 'User has no subscriptions' });
        }

        // 2. G·ª≠i th√¥ng b√°o ƒë·∫øn T·∫§T C·∫¢ thi·∫øt b·ªã c·ªßa h·ªç
        const notifications = subs.map(sub => {
            const pushConfig = {
                endpoint: sub.endpoint,
                keys: { auth: sub.auth, p256dh: sub.p256dh }
            };
            const payload = JSON.stringify({ title, body, url });

            return webPush.sendNotification(pushConfig, payload).catch(err => {
                if (err.statusCode === 410 || err.statusCode === 404) {
                    // Thi·∫øt b·ªã ƒë√£ h·ªßy ƒëƒÉng k√Ω ho·∫∑c l·ªói -> X√≥a kh·ªèi DB cho s·∫°ch
                    console.log('Subscription expired, deleting from DB:', sub.id);
                    supabase.from('push_subscriptions').delete().eq('id', sub.id).then();
                }
            });
        });

        await Promise.all(notifications);

        return NextResponse.json({ success: true, count: subs.length });
    } catch (error: any) {
        console.error('Push Error:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="api/sync-users/route.ts">
import { createClient } from '@supabase/supabase-js';
import { NextResponse } from 'next/server';

const supabaseAdmin = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!, 
    {
        auth: {
            autoRefreshToken: false,
            persistSession: false
        }
    }
);

export async function POST(req: Request) {
    try {
        // üõ°Ô∏è B·∫¢O M·∫¨T: Ki·ªÉm tra Secret Key t·ª´ Header
        const authHeader = req.headers.get('x-admin-secret');
        if (authHeader !== process.env.ADMIN_SECRET_KEY) {
             console.warn("‚ö†Ô∏è Truy c·∫≠p tr√°i ph√©p v√†o /api/sync-users");
             return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
        }

        console.log("--- B·∫ÆT ƒê·∫¶U ƒê·ªíNG B·ªò USER ---");

        // 1. L·∫•y danh s√°ch nh√¢n s·ª±
        const { data: employees, error: empError } = await supabaseAdmin
            .from('nhan_su')
            .select('*');

        if (empError) throw new Error("L·ªói l·∫•y d·ªØ li·ªáu nh√¢n s·ª±: " + empError.message);
        if (!employees) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu nh√¢n s·ª±");

        // 2. L·∫•y danh s√°ch Users hi·ªán t·∫°i t·ª´ Auth
        const { data: { users: authUsers }, error: authError } = await supabaseAdmin.auth.admin.listUsers();
        if (authError) throw new Error("L·ªói l·∫•y danh s√°ch Auth Users: " + authError.message);

        let added = 0;
        let updated = 0;
        let deleted = 0;

        // 3. X·ª¨ L√ù: TH√äM HO·∫∂C C·∫¨P NH·∫¨T
        for (const emp of employees) {
            if (!emp.email) continue; 

            const existingUser = authUsers.find(u => u.email === emp.email);

            if (!existingUser) {
                // -> Ch∆∞a c√≥ User -> T·∫†O M·ªöI
                const { error: createError } = await supabaseAdmin.auth.admin.createUser({
                    email: emp.email,
                    password: '12345678', 
                    email_confirm: true,
                    user_metadata: { 
                        full_name: emp.ten_hien_thi || emp.ten_day_du || 'Nh√¢n vi√™n',
                        source: 'auto_sync' 
                    }
                });
                
                if (createError) console.error(`L·ªói t·∫°o user ${emp.email}:`, createError.message);
                else added++;

            } else {
                // -> ƒê√£ c√≥ User -> C·∫¨P NH·∫¨T
                const currentName = existingUser.user_metadata?.full_name;
                const newName = emp.ten_hien_thi || emp.ten_day_du;

                if (newName && currentName !== newName) {
                    await supabaseAdmin.auth.admin.updateUserById(existingUser.id, {
                        user_metadata: { ...existingUser.user_metadata, full_name: newName }
                    });
                    updated++;
                }
            }
        }

        // 4. X·ª¨ L√ù: X√ìA
        const empEmails = new Set(employees.map(e => e.email));

        for (const user of authUsers) {
            // Logic an to√†n: Kh√¥ng x√≥a Super Admin (nh·ªØng user c√≥ email ƒë·∫∑c bi·ªát ho·∫∑c id c·ªë ƒë·ªãnh)
            // V√≠ d·ª•: Gi·ªØ l·∫°i admin@local
            if (user.email === 'admin@local') continue;

            if (user.email && !empEmails.has(user.email)) {
                 // Ch·ªâ x√≥a user ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông ƒë·ªÉ an to√†n
                 if (user.user_metadata?.source === 'auto_sync') {
                    await supabaseAdmin.auth.admin.deleteUser(user.id);
                    deleted++;
                 }
            }
        }

        return NextResponse.json({ 
            success: true, 
            message: "ƒê·ªìng b·ªô th√†nh c√¥ng",
            added, 
            updated, 
            deleted 
        });

    } catch (error: any) {
        console.error(error);
        return NextResponse.json({ success: false, error: error.message }, { status: 500 });
    }
}
</file>

<file path="components/cacchucnang/index.ts">
/**
 * ============================================================
 * C√ÅC CH·ª®C NƒÇNG - PH√íNG CHU·∫®N
 * ============================================================
 *
 * Th∆∞ m·ª•c ch·ª©a t·∫•t c·∫£ c√°c ch·ª©c nƒÉng d√πng chung.
 * M·ªói ch·ª©c nƒÉng n·∫±m trong 1 folder ri√™ng.
 *
 * C·∫§U TR√öC:
 * cacchucnang/
 * ‚îú‚îÄ‚îÄ nhansu/          - Qu·∫£n l√Ω nh√¢n s·ª±
 * ‚îú‚îÄ‚îÄ khachhang/       - Qu·∫£n l√Ω kh√°ch h√†ng (TODO)
 * ‚îú‚îÄ‚îÄ donhang/         - Qu·∫£n l√Ω ƒë∆°n h√†ng (TODO)
 * ‚îú‚îÄ‚îÄ vattu/           - Qu·∫£n l√Ω v·∫≠t t∆∞ kho (TODO)
 * ‚îî‚îÄ‚îÄ thuchi/          - Qu·∫£n l√Ω thu chi (TODO)
 *
 * C√ÅCH S·ª¨ D·ª§NG:
 * import { NhanSuChucNang } from '@/app/components/cacchucnang';
 */

// Nh√¢n s·ª±
export {
  NhanSuChucNang,
  createNhanSuConfig,
  type NhanSu,
  type NhanSuPermissions,
} from "./nhansu";

// TODO: Th√™m c√°c ch·ª©c nƒÉng kh√°c
// export { KhachHangChucNang } from './khachhang';
// export { DonHangChucNang } from './donhang';
// export { VatTuChucNang } from './vattu';
// export { ThuChiChucNang } from './thuchi';
export { MauThietKeChucNang } from "./mauthietke";
</file>

<file path="components/cacchucnang/khachhang/config.ts">
/**
 * ============================================================
 * CH·ª®C NƒÇNG: KH√ÅCH H√ÄNG
 * ƒê∆∞·ªùng d·∫´n: phongchuan/cacchucnang/khachhang
 * ============================================================
 * 
 * Ch·ª©c nƒÉng qu·∫£n l√Ω kh√°ch h√†ng d√πng chung cho nhi·ªÅu ph√≤ng.
 * M·ªói ph√≤ng g·ªçi ra v·ªõi quy·ªÅn kh√°c nhau th√¥ng qua props.
 * 
 * QUY·ªÄN H·∫†N:
 * - allowView: Xem danh s√°ch v√† chi ti·∫øt
 * - allowEdit: S·ª≠a th√¥ng tin
 * - allowDelete: X√≥a kh√°ch h√†ng
 * - allowBulk: Thao t√°c h√†ng lo·∫°t
 * 
 * S·ª¨ D·ª§NG:
 * import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
 * <KhachHangChucNang permissions={{ allowDelete: true }} />
 */

import { Phone, Mail, MapPin, User } from 'lucide-react';
import { ManagerConfig, FieldConfig, FilterTabConfig, TabConfig } from '../types';
import { 
    getKhachHangDataAction, 
    createKhachHangAction, 
    updateKhachHangAction, 
    deleteKhachHangAction 
} from '@/app/actions/QuyenHanQuanLy';

// ============================================================
// INTERFACE
// ============================================================

export interface KhachHang {
    id: string;
    ho_ten: string;
    so_dien_thoai?: string;
    email?: string;
    dia_chi?: string;
    phan_loai?: string;
    phan_loai_normalized?: string;
    hinh_anh?: string;
    ghi_chu?: string;
    tong_don_hang?: number;
    tao_luc?: string;
    cap_nhat_luc?: string;
}

export interface KhachHangPermissions {
    allowView?: boolean;
    allowEdit?: boolean;
    allowDelete?: boolean;
    allowBulk?: boolean;
}

// ============================================================
// CONSTANTS
// ============================================================

export const PHAN_LOAI_OPTIONS = [
    'Ti·ªÅm nƒÉng',
    'M·ªõi',
    'Th√¢n thi·∫øt',
    'VIP',
    'Kh√¥ng ho·∫°t ƒë·ªông',
];

// ============================================================
// FIELDS CONFIG
// ============================================================

const fields: FieldConfig[] = [
    {
        key: 'hinh_anh',
        label: '·∫¢nh ƒë·∫°i di·ªán',
        type: 'image',
        showInForm: true,
        showInDetail: false,
        showInCard: true,
    },
    {
        key: 'ho_ten',
        label: 'H·ªç v√† T√™n',
        type: 'text',
        placeholder: 'Nh·∫≠p h·ªç t√™n ƒë·∫ßy ƒë·ªß...',
        required: true,
    },
    {
        key: 'so_dien_thoai',
        label: 'S·ªë ƒëi·ªán tho·∫°i',
        type: 'phone',
        placeholder: '09xxxxxxxxx',
        required: true,
        icon: Phone,
    },
    {
        key: 'email',
        label: 'Email',
        type: 'email',
        placeholder: 'email@example.com',
        icon: Mail,
        colSpan: 2,
    },
    {
        key: 'dia_chi',
        label: 'ƒê·ªãa ch·ªâ',
        type: 'textarea',
        placeholder: 'Nh·∫≠p ƒë·ªãa ch·ªâ...',
        icon: MapPin,
        colSpan: 2,
    },
    {
        key: 'phan_loai',
        label: 'Ph√¢n lo·∫°i',
        type: 'select',
        options: PHAN_LOAI_OPTIONS,
    },
    {
        key: 'ghi_chu',
        label: 'Ghi ch√∫',
        type: 'textarea',
        placeholder: 'Ghi ch√∫ th√™m...',
        colSpan: 2,
    },
];

// ============================================================
// FILTER TABS
// ============================================================

const filterTabs: FilterTabConfig[] = [
    { id: 'tiemnang', label: 'TI·ªÄM NƒÇNG', filterField: 'phan_loai_normalized' },
    { id: 'moi', label: 'M·ªöI', filterField: 'phan_loai_normalized' },
    { id: 'thanthiet', label: 'TH√ÇN THI·∫æT', filterField: 'phan_loai_normalized' },
    { id: 'vip', label: 'VIP', filterField: 'phan_loai_normalized' },
    { id: 'khonghoatdong', label: 'KH√îNG Hƒê', filterField: 'phan_loai_normalized' },
];

// ============================================================
// DETAIL TABS
// ============================================================

const detailTabs: TabConfig[] = [
    { id: 'thongtin', label: 'TH√îNG TIN' },
    { id: 'donhang', label: 'ƒê∆†N H√ÄNG', searchable: true, sortable: true },
    { id: 'ghichu', label: 'GHI CH√ö' },
];

// ============================================================
// DATA SOURCE
// ============================================================

const dataSource = {
    fetchList: async (page: number, limit: number, search: string, filter: string) => {
        const res = await getKhachHangDataAction(page, limit, search, filter);
        return { success: res.success, data: res.data as KhachHang[] | undefined, error: res.error };
    },
    create: async (data: Partial<KhachHang>) => {
        if (data.phan_loai) {
            (data as any).phan_loai_normalized = data.phan_loai.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "").toLowerCase();
        }
        const res = await createKhachHangAction(data as any);
        return { success: res.success, data: (res as any).data as KhachHang, error: res.error };
    },
    update: async (id: string, data: Partial<KhachHang>) => {
        if (data.phan_loai) {
            (data as any).phan_loai_normalized = data.phan_loai.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "").toLowerCase();
        }
        const res = await updateKhachHangAction(id, data as any);
        return { success: res.success, data: (res as any).data as KhachHang, error: res.error };
    },
    delete: async (id: string) => {
        const res = await deleteKhachHangAction(id);
        return { success: res.success, error: res.error };
    },
};

// ============================================================
// CREATE CONFIG FUNCTION
// ============================================================

export function createKhachHangConfig(permissions: KhachHangPermissions = {}): ManagerConfig<KhachHang> {
    const { 
        allowView = true, 
        allowEdit = true, 
        allowDelete = false, 
        allowBulk = false 
    } = permissions;

    return {
        entityName: 'kh√°ch h√†ng',
        entityNamePlural: 'kh√°ch h√†ng',
        idField: 'id',
        fields,
        cardConfig: {
            avatarField: 'hinh_anh',
            titleField: 'ho_ten',
            subtitleField: 'phan_loai',
            infoFields: [{ field: 'so_dien_thoai', icon: Phone }],
        },
        filterTabs,
        detailTabs,
        actions: {
            allowView,
            allowEdit,
            allowDelete,
            allowBulkSelect: allowBulk,
            allowBulkDelete: allowBulk && allowDelete,
        },
        dataSource,
        searchFields: ['ho_ten', 'so_dien_thoai', 'email'],
        sortOptions: [
            { key: 'name', label: 'T√äN', sortFn: (a: KhachHang, b: KhachHang) => (a.ho_ten || '').localeCompare(b.ho_ten || '') },
            { key: 'phanloai', label: 'PH√ÇN LO·∫†I', sortFn: (a: KhachHang, b: KhachHang) => (a.phan_loai || '').localeCompare(b.phan_loai || '') },
            { key: 'ngay', label: 'NG√ÄY T·∫†O', sortFn: (a: KhachHang, b: KhachHang) => new Date(b.tao_luc || 0).getTime() - new Date(a.tao_luc || 0).getTime() },
        ],
        defaultSort: 'name',
        uploadConfig: { bucket: 'avatar', fileNamePrefix: 'kh' },
    };
}
</file>

<file path="components/cacchucnang/khachhang/index.ts">
export { default as KhachHangChucNang } from './KhachHangChucNang';
export { createKhachHangConfig, PHAN_LOAI_OPTIONS } from './config';
export type { KhachHang, KhachHangPermissions } from './config';
</file>

<file path="components/cacchucnang/khachhang/KhachHangChucNang.tsx">
/**
 * ============================================================
 * COMPONENT: KH√ÅCH H√ÄNG
 * ============================================================
 *
 * S·ª≠ d·ª•ng KhungGiaoDien ƒë·ªÉ ƒë·ªìng b·ªô giao di·ªán.
 * 3 ch·∫ø ƒë·ªô view: List | Detail | Form (inline, kh√¥ng popup)
 */

"use client";

import React, { useState, useEffect, useMemo, useCallback } from "react";
import {
  User,
  Phone,
  Mail,
  MapPin,
  ShoppingBag,
  Calendar,
  Trash2,
} from "lucide-react";
import {
  KhungDanhSach,
  KhungChiTiet,
  KhungForm,
} from "@/app/components/cacchucnang/KhungGiaoDienChucNang";
import ConfirmDialog from "@/app/components/ConfirmDialog";
import {
  KhachHang,
  KhachHangPermissions,
  createKhachHangConfig,
  PHAN_LOAI_OPTIONS,
} from "./config";

// ============================================================
// PROPS
// ============================================================

interface Props {
  permissions?: KhachHangPermissions;
  className?: string;
}

// ============================================================
// HELPER
// ============================================================

const toNonAccent = (str: string) =>
  str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "")
    .toLowerCase();

const getPhanLoaiStyle = (phanLoai?: string) => {
  const styles: Record<string, string> = {
    "Ti·ªÅm nƒÉng": "bg-blue-500/20 text-blue-400 border-blue-500/40",
    M·ªõi: "bg-green-500/20 text-green-400 border-green-500/40",
    "Th√¢n thi·∫øt": "bg-purple-500/20 text-purple-400 border-purple-500/40",
    VIP: "bg-yellow-500/20 text-yellow-400 border-yellow-500/40",
    "Kh√¥ng ho·∫°t ƒë·ªông": "bg-gray-500/20 text-gray-400 border-gray-500/40",
  };
  return (
    styles[phanLoai || ""] || "bg-gray-500/20 text-gray-400 border-gray-500/40"
  );
};

// ============================================================
// COMPONENT
// ============================================================

export default function KhachHangChucNang({
  permissions = {},
  className = "",
}: Props) {
  const config = createKhachHangConfig(permissions);
  const {
    allowView = true,
    allowEdit = true,
    allowDelete = false,
    allowBulk = false,
  } = permissions;

  // ========== STATE ==========
  const [items, setItems] = useState<KhachHang[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [activeTab, setActiveTab] = useState("all");
  const [sortBy, setSortBy] = useState("name");

  // VIEW STATE: 'list' | 'detail' | 'form'
  const [viewMode, setViewMode] = useState<"list" | "detail" | "form">("list");
  const [selectedItem, setSelectedItem] = useState<KhachHang | null>(null);
  const [detailTab, setDetailTab] = useState("thongtin");

  const [bulkMode, setBulkMode] = useState(false);
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [confirmDelete, setConfirmDelete] = useState<{
    show: boolean;
    ids: string[];
  }>({ show: false, ids: [] });

  const [formData, setFormData] = useState<Partial<KhachHang>>({});
  const [saving, setSaving] = useState(false);

  // ========== FETCH DATA ==========
  const fetchData = useCallback(async () => {
    setLoading(true);
    try {
      // üõ†Ô∏è FIX: Ki·ªÉm tra dataSource v√† method t·ªìn t·∫°i
      if (config.dataSource?.fetchList) {
        const res = await config.dataSource.fetchList(1, 50, "", "");
        if (res.success && res.data) setItems(res.data);
      }
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  }, [config.dataSource]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  // ========== TABS v·ªõi COUNT ==========
  const tabs = useMemo(() => {
    const counts: Record<string, number> = { all: items.length };
    config.filterTabs?.forEach((tab) => {
      // üõ†Ô∏è FIX: Ki·ªÉm tra id v√† filterField
      if (tab.id && tab.filterField) {
        counts[tab.id] = items.filter(
          (i) => (i as any)[tab.filterField!] === tab.id
        ).length;
      }
    });

    const dynamicTabs =
      config.filterTabs?.map((t) => ({
        id: t.id || "", // Fallback ID r·ªóng
        label: t.label,
        count: t.id ? counts[t.id] || 0 : 0,
      })) || [];

    return [{ id: "all", label: "T·∫§T C·∫¢", count: counts.all }, ...dynamicTabs];
  }, [items, config.filterTabs]);

  // ========== FILTERED & SORTED ==========
  const filteredList = useMemo(() => {
    let result = items;

    // Filter by tab
    if (activeTab !== "all") {
      result = result.filter((i) => i.phan_loai_normalized === activeTab);
    }

    // Search
    if (searchTerm) {
      const term = toNonAccent(searchTerm);
      result = result.filter((i) => {
        const hoTen = toNonAccent(i.ho_ten || "");
        const match =
          hoTen.includes(term) ||
          (i.so_dien_thoai || "").includes(term) ||
          toNonAccent(i.email || "").includes(term);
        return match;
      });
    }

    // Sort
    const sortOpt = config.sortOptions?.find((s) => s.key === sortBy);
    if (sortOpt?.sortFn) {
      result = [...result].sort(sortOpt.sortFn);
    }

    return result;
  }, [items, activeTab, searchTerm, sortBy, config.sortOptions]);

  // ========== HANDLERS ==========
  const handleOpenDetail = (item: KhachHang) => {
    setSelectedItem(item);
    setDetailTab("thongtin");
    setViewMode("detail");
  };

  const handleOpenForm = (item?: KhachHang) => {
    setFormData(item ? { ...item } : {});
    setSelectedItem(item || null);
    setViewMode("form");
  };

  const handleBackToList = () => {
    setViewMode("list");
    setSelectedItem(null);
  };

  const handleSave = async () => {
    setSaving(true);
    try {
      // üõ†Ô∏è FIX: Ki·ªÉm tra dataSource tr∆∞·ªõc khi g·ªçi
      if (selectedItem?.id) {
        if (config.dataSource?.update) {
          await config.dataSource.update(selectedItem.id, formData);
        }
      } else {
        if (config.dataSource?.create) {
          await config.dataSource.create(formData);
        }
      }
      await fetchData();
      handleBackToList();
    } catch (e) {
      console.error(e);
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (ids: string[]) => {
    // üõ†Ô∏è FIX: Ki·ªÉm tra delete method
    if (config.dataSource?.delete) {
      for (const id of ids) {
        await config.dataSource.delete(id);
      }
      await fetchData();
      setSelectedIds(new Set());
      setConfirmDelete({ show: false, ids: [] });
      handleBackToList();
    }
  };

  const toggleSelect = (id: string) => {
    const newSet = new Set(selectedIds);
    if (newSet.has(id)) newSet.delete(id);
    else newSet.add(id);
    setSelectedIds(newSet);
  };

  // ========== DETAIL TABS COUNT ==========
  const detailTabCounts = useMemo(
    () => ({
      thongtin: 4,
      donhang: 0,
      ghichu: selectedItem?.ghi_chu ? 1 : 0,
    }),
    [selectedItem]
  );

  // ========== RENDER ==========
  return (
    <div className={`h-full ${className}`}>
      {/* ====== CH·∫æ ƒê·ªò DANH S√ÅCH ====== */}
      {viewMode === "list" && (
        <KhungDanhSach
          tabs={tabs}
          activeTab={activeTab}
          onTabChange={setActiveTab}
          onSearch={setSearchTerm} // üõ†Ô∏è FIX: ƒê√£ x√≥a searchPlaceholder
          sortOptions={
            config.sortOptions?.map((s) => ({ key: s.key, label: s.label })) ||
            []
          }
          activeSort={sortBy}
          onSortChange={setSortBy}
          showAddButton={allowEdit}
          onAdd={() => handleOpenForm()}
          bulkMode={bulkMode}
          onBulkModeToggle={
            allowBulk ? () => setBulkMode(!bulkMode) : undefined
          }
          selectedCount={selectedIds.size}
          onSelectAll={() =>
            setSelectedIds(new Set(filteredList.map((i) => i.id)))
          }
          onClearSelection={() => setSelectedIds(new Set())}
          bulkActions={
            allowDelete
              ? [
                  {
                    id: "delete",
                    label: "X√ìA",
                    icon: Trash2,
                    color: "danger",
                    onClick: () =>
                      setConfirmDelete({
                        show: true,
                        ids: Array.from(selectedIds),
                      }),
                  },
                ]
              : []
          }
          loading={loading}
        >
          {/* Cards */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 p-4">
            {filteredList.map((item) => (
              <div
                key={item.id}
                onClick={() => !bulkMode && handleOpenDetail(item)}
                className={`group relative bg-[#0f0f0f] border rounded-xl overflow-hidden cursor-pointer transition-all hover:border-[#C69C6D]/50 hover:shadow-lg ${
                  selectedIds.has(item.id)
                    ? "border-[#C69C6D] bg-[#C69C6D]/5"
                    : "border-white/10"
                }`}
              >
                {/* Bulk checkbox */}
                {bulkMode && (
                  <div
                    onClick={(e) => {
                      e.stopPropagation();
                      toggleSelect(item.id);
                    }}
                    className="absolute top-3 right-3 z-10"
                  >
                    <div
                      className={`w-5 h-5 rounded border-2 flex items-center justify-center transition-colors ${
                        selectedIds.has(item.id)
                          ? "bg-[#C69C6D] border-[#C69C6D]"
                          : "border-white/30 bg-black/50"
                      }`}
                    >
                      {selectedIds.has(item.id) && (
                        <span className="text-black text-xs">‚úì</span>
                      )}
                    </div>
                  </div>
                )}

                <div className="p-4 flex items-center gap-4">
                  {/* Avatar */}
                  <div className="w-14 h-14 rounded-full bg-[#1a1a1a] border-2 border-[#C69C6D]/30 overflow-hidden shrink-0">
                    {item.hinh_anh ? (
                      <img
                        src={item.hinh_anh}
                        alt=""
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center text-[#C69C6D]/50">
                        <User size={24} />
                      </div>
                    )}
                  </div>

                  {/* Info */}
                  <div className="flex-1 min-w-0">
                    <h3 className="font-bold text-white truncate">
                      {item.ho_ten}
                    </h3>
                    <span
                      className={`inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase border ${getPhanLoaiStyle(
                        item.phan_loai
                      )}`}
                    >
                      {item.phan_loai || "Ch∆∞a ph√¢n lo·∫°i"}
                    </span>
                    <p className="text-xs text-white/40 truncate mt-1">
                      <Phone size={10} className="inline mr-1" />
                      {item.so_dien_thoai || "---"}
                    </p>
                  </div>
                </div>
              </div>
            ))}

            {filteredList.length === 0 && !loading && (
              <div className="col-span-full py-20 text-center text-white/30">
                Kh√¥ng c√≥ d·ªØ li·ªáu
              </div>
            )}
          </div>
        </KhungDanhSach>
      )}

      {/* ====== CH·∫æ ƒê·ªò CHI TI·∫æT ====== */}
      {viewMode === "detail" && selectedItem && (
        <KhungChiTiet
          data={selectedItem}
          onClose={handleBackToList}
          avatar={selectedItem.hinh_anh}
          avatarFallback={<User size={10} className="text-[#C69C6D]/50" />}
          title={selectedItem.ho_ten}
          tabs={[
            { id: "thongtin", label: "TH√îNG TIN" },
            { id: "donhang", label: "ƒê∆†N H√ÄNG" },
            { id: "ghichu", label: "GHI CH√ö" },
          ]}
          activeTab={detailTab}
          onTabChange={setDetailTab}
          tabCounts={detailTabCounts}
          showEditButton={allowEdit}
          showDeleteButton={allowDelete}
          onEdit={() => handleOpenForm(selectedItem)}
          onDelete={() =>
            setConfirmDelete({ show: true, ids: [selectedItem.id] })
          }
        >
          <div className="p-4">
            {detailTab === "thongtin" && (
              <div className="space-y-3">
                <InfoRow
                  icon={Phone}
                  label="S·ªê ƒêI·ªÜN THO·∫†I"
                  value={selectedItem.so_dien_thoai}
                  action={() =>
                    window.open(`tel:${selectedItem.so_dien_thoai}`)
                  }
                />
                <InfoRow icon={Mail} label="EMAIL" value={selectedItem.email} />
                <InfoRow
                  icon={MapPin}
                  label="ƒê·ªäA CH·ªà"
                  value={selectedItem.dia_chi}
                />
                <InfoRow
                  icon={Calendar}
                  label="NG√ÄY THAM GIA"
                  value={
                    selectedItem.tao_luc
                      ? new Date(selectedItem.tao_luc).toLocaleDateString(
                          "vi-VN"
                        )
                      : undefined
                  }
                />
              </div>
            )}
            {detailTab === "donhang" && (
              <div className="flex flex-col items-center justify-center py-10 text-white/30">
                <ShoppingBag size={40} className="mb-3 opacity-30" />
                <p className="text-sm">Ch∆∞a c√≥ ƒë∆°n h√†ng</p>
              </div>
            )}
            {detailTab === "ghichu" && (
              <div className="p-4 bg-[#151515] rounded-xl border border-white/5 min-h-[100px]">
                <p className="text-sm text-white/60 whitespace-pre-wrap">
                  {selectedItem.ghi_chu || "Ch∆∞a c√≥ ghi ch√∫"}
                </p>
              </div>
            )}
          </div>
        </KhungChiTiet>
      )}

      {/* ====== CH·∫æ ƒê·ªò FORM ====== */}
      {viewMode === "form" && (
        <KhungForm
          isEditing={!!selectedItem}
          data={formData}
          onClose={handleBackToList}
          title={selectedItem ? selectedItem.ho_ten : "TH√äM KH√ÅCH H√ÄNG"}
          avatar={selectedItem?.hinh_anh}
          avatarFallback={<User size={10} className="text-[#C69C6D]/50" />}
          showAvatarUpload={true}
          onSubmit={handleSave}
          loading={saving}
          isDirty={Object.keys(formData).length > 0}
        >
          <div className="space-y-4">
            <FormField label="H·ªç v√† T√™n" required>
              <input
                type="text"
                value={formData.ho_ten || ""}
                onChange={(e) =>
                  setFormData({ ...formData, ho_ten: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                placeholder="Nh·∫≠p h·ªç t√™n..."
              />
            </FormField>

            <div className="grid grid-cols-2 gap-4">
              <FormField label="S·ªë ƒëi·ªán tho·∫°i" required>
                <input
                  type="tel"
                  value={formData.so_dien_thoai || ""}
                  onChange={(e) =>
                    setFormData({ ...formData, so_dien_thoai: e.target.value })
                  }
                  className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                  placeholder="09..."
                />
              </FormField>
              <FormField label="Email">
                <input
                  type="email"
                  value={formData.email || ""}
                  onChange={(e) =>
                    setFormData({ ...formData, email: e.target.value })
                  }
                  className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                  placeholder="email@..."
                />
              </FormField>
            </div>

            <FormField label="Ph√¢n lo·∫°i">
              <select
                value={formData.phan_loai || ""}
                onChange={(e) =>
                  setFormData({ ...formData, phan_loai: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white focus:border-[#C69C6D]/50 focus:outline-none"
              >
                <option value="">Ch·ªçn ph√¢n lo·∫°i...</option>
                {PHAN_LOAI_OPTIONS.map((opt) => (
                  <option key={opt} value={opt}>
                    {opt}
                  </option>
                ))}
              </select>
            </FormField>

            <FormField label="ƒê·ªãa ch·ªâ">
              <textarea
                value={formData.dia_chi || ""}
                onChange={(e) =>
                  setFormData({ ...formData, dia_chi: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none resize-none"
                rows={2}
                placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ..."
              />
            </FormField>

            <FormField label="Ghi ch√∫">
              <textarea
                value={formData.ghi_chu || ""}
                onChange={(e) =>
                  setFormData({ ...formData, ghi_chu: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none resize-none"
                rows={3}
                placeholder="Ghi ch√∫ th√™m..."
              />
            </FormField>
          </div>
        </KhungForm>
      )}

      {/* ====== CONFIRM DELETE ====== */}
      <ConfirmDialog
        isOpen={confirmDelete.show}
        title="X√ÅC NH·∫¨N X√ìA"
        message={`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${confirmDelete.ids.length} kh√°ch h√†ng?`}
        onConfirm={() => handleDelete(confirmDelete.ids)}
        onCancel={() => setConfirmDelete({ show: false, ids: [] })}
      />
    </div>
  );
}

// ============================================================
// SUB-COMPONENTS
// ============================================================

function InfoRow({
  icon: Icon,
  label,
  value,
  action,
}: {
  icon: any;
  label: string;
  value?: string;
  action?: () => void;
}) {
  return (
    <div className="flex items-center gap-3 p-3 rounded-xl bg-[#151515] border border-white/5 hover:border-[#C69C6D]/30 transition-colors">
      <div className="p-2 rounded-lg bg-black text-[#C69C6D]">
        <Icon size={16} />
      </div>
      <div className="flex-1 min-w-0">
        <p className="text-[9px] font-black uppercase tracking-wider text-white/40 mb-0.5">
          {label}
        </p>
        <p className="text-sm font-bold text-gray-200 truncate">
          {value || "---"}
        </p>
      </div>
      {action && value && (
        <button
          onClick={action}
          className="px-3 py-1 text-[10px] font-bold uppercase bg-[#C69C6D]/20 text-[#C69C6D] rounded hover:bg-[#C69C6D]/30"
        >
          G·ªåI
        </button>
      )}
    </div>
  );
}

function FormField({
  label,
  required,
  children,
}: {
  label: string;
  required?: boolean;
  children: React.ReactNode;
}) {
  return (
    <div>
      <label className="block text-xs font-bold text-white/60 uppercase tracking-wider mb-2">
        {label} {required && <span className="text-red-400">*</span>}
      </label>
      {children}
    </div>
  );
}
</file>

<file path="components/cacchucnang/KhungGiaoDienChucNang/index.ts">
/**
 * ============================================================
 * KHUNG GIAO DI·ªÜN
 * ============================================================
 * 
 * B·ªô khung UI chu·∫©n cho to√†n b·ªô ·ª©ng d·ª•ng.
 * T·∫•t c·∫£ ƒë·ªÅu l√† INLINE PANEL (kh√¥ng ph·∫£i modal popup).
 * 
 * COMPONENTS:
 * - KhungDanhSach: Tab bar ngang + Cards + Search/Sort/Bulk
 * - KhungChiTiet: Tab bar ngang + Chi ti·∫øt inline
 * - KhungForm: Tab bar ngang + Form inline
 * 
 * STYLE CHUNG:
 * - Tab bar: h-[40px], bg-[#0a0a0a], border-b border-white/5
 * - Tabs: px-2 py-1, text-[10px] font-bold uppercase
 * - Actions: shrink-0 border-l, icon buttons p-1.5
 * 
 * S·ª¨ D·ª§NG:
 * import { KhungDanhSach, KhungChiTiet, KhungForm } from '@/app/components/KhungGiaoDien';
 */

export { default as KhungDanhSach } from './KhungDanhSach';
export { default as KhungChiTiet } from './KhungChiTiet';
export { default as KhungForm } from './KhungForm';

// Export types
export type { KhungDanhSachProps, TabItem as DanhSachTabItem, SortOption, BulkAction } from './KhungDanhSach';
export type { KhungChiTietProps, TabItem as ChiTietTabItem } from './KhungChiTiet';
export type { KhungFormProps } from './KhungForm';
</file>

<file path="components/cacchucnang/KhungGiaoDienChucNang/KhungChiTiet.tsx">
"use client";

/**
 * ============================================================
 * KHUNG CHI TI·∫æT (COMPACT & CLEAN TABS)
 * ============================================================
 * * Update UI:
 * - Row 1 Height: 45px (Compact Header)
 * - Row 2 Height: 40px (Compact Tabs)
 * - Tabs Style: Text-only (No background buttons), simple underline.
 */

import React, { ReactNode, useState } from "react";
import {
  X,
  User,
  Edit3,
  Trash2,
  Loader2,
  Search,
  ArrowUpDown,
} from "lucide-react";

// ============================================================
// TYPES
// ============================================================

export interface TabItem {
  id: string;
  label: string;
  icon?: React.ElementType;
  count?: number;
  searchable?: boolean;
  sortable?: boolean;
  sortOptions?: { key: string; label: string }[];
  showAddButton?: boolean;
}

export interface KhungChiTietProps {
  data: any;
  onClose: () => void;
  avatar?: string;
  avatarFallback?: ReactNode;
  title?: string;
  tabs?: TabItem[];
  activeTab?: string;
  onTabChange?: (tabId: string) => void;
  tabCounts?: Record<string, number>;
  searchTerm?: string;
  onSearch?: (term: string) => void;
  sortBy?: string;
  onSortChange?: (sortKey: string) => void;
  onAddInTab?: () => void;
  showEditButton?: boolean;
  showDeleteButton?: boolean;
  onEdit?: () => void;
  onDelete?: () => void;
  deleting?: boolean;
  children: ReactNode;
  className?: string;
}

// ============================================================
// COMPONENT
// ============================================================

export default function KhungChiTiet({
  data,
  onClose,
  avatar,
  avatarFallback,
  title,
  tabs = [],
  activeTab,
  onTabChange,
  tabCounts = {},
  searchTerm = "",
  onSearch,
  sortBy,
  onSortChange,
  onAddInTab,
  showEditButton = true,
  showDeleteButton = false,
  onEdit,
  onDelete,
  deleting = false,
  children,
  className = "",
}: KhungChiTietProps) {
  const [showSearch, setShowSearch] = useState(false);
  const [localSearchTerm, setLocalSearchTerm] = useState(searchTerm);
  const [showSortMenu, setShowSortMenu] = useState(false);

  // Swipe gesture states
  const [touchStartX, setTouchStartX] = useState<number | null>(null);
  const [touchEndX, setTouchEndX] = useState<number | null>(null);
  const minSwipeDistance = 50;

  if (!data) return null;

  const currentTabConfig = tabs.find((t) => t.id === activeTab);
  const TAB_IDS = tabs.map((t) => t.id);

  // Swipe handlers
  const handleTouchStart = (e: React.TouchEvent) => {
    setTouchEndX(null);
    setTouchStartX(e.targetTouches[0].clientX);
  };

  const handleTouchMove = (e: React.TouchEvent) => {
    setTouchEndX(e.targetTouches[0].clientX);
  };

  const handleTouchEnd = () => {
    if (!touchStartX || !touchEndX || !onTabChange) return;
    const distance = touchStartX - touchEndX;
    const isLeftSwipe = distance > minSwipeDistance;
    const isRightSwipe = distance < -minSwipeDistance;
    const currentIndex = TAB_IDS.indexOf(activeTab || "");

    if (isLeftSwipe && currentIndex < TAB_IDS.length - 1) {
      onTabChange(TAB_IDS[currentIndex + 1]);
    } else if (isRightSwipe && currentIndex > 0) {
      onTabChange(TAB_IDS[currentIndex - 1]);
    }
    setTouchStartX(null);
    setTouchEndX(null);
  };

  const handleSearch = (value: string) => {
    setLocalSearchTerm(value);
    onSearch?.(value);
  };

  return (
    <div
      className={`w-full h-full flex flex-col bg-[#050505] overflow-hidden ${className}`}
    >
      {/* ====== HEADER CONTAINER ====== */}
      <div className="shrink-0 flex flex-col bg-[#0a0a0a] border-b border-white/5 z-20 shadow-sm">
        {/* --- ROW 1: INFO & ACTIONS (Height reduced to 45px) --- */}
        <div className="flex items-center justify-between px-4 h-[45px] border-b border-white/5">
          {/* LEFT: Avatar + Title */}
          <div className="flex items-center gap-3 min-w-0">
            {/* Avatar nh·ªè h∆°n ch√∫t (w-8 h-8) ƒë·ªÉ h·ª£p v·ªõi thanh h-45 */}
            <div className="w-8 h-8 rounded-full border border-[#C69C6D]/30 overflow-hidden bg-[#1a1a1a] shrink-0 p-0.5 shadow-lg shadow-[#C69C6D]/5">
              {avatar ? (
                <img
                  src={avatar}
                  alt=""
                  className="w-full h-full object-cover rounded-full"
                />
              ) : (
                <div className="w-full h-full flex items-center justify-center bg-[#151515] rounded-full">
                  {avatarFallback || (
                    <User size={14} className="text-[#C69C6D]/50" />
                  )}
                </div>
              )}
            </div>
            <div className="min-w-0">
              <h2 className="text-sm font-black text-white uppercase tracking-wide truncate leading-tight">
                {title || "---"}
              </h2>
            </div>
          </div>

          {/* RIGHT: Global Actions */}
          <div className="flex items-center gap-1 shrink-0 ml-4">
            {showEditButton && onEdit && (
              <button
                onClick={onEdit}
                className="p-1.5 hover:text-[#C69C6D] text-gray-400 transition-all"
                title="Ch·ªânh s·ª≠a"
              >
                <Edit3 size={16} />
              </button>
            )}

            {showDeleteButton && onDelete && (
              <button
                onClick={onDelete}
                disabled={deleting}
                className="p-1.5 hover:text-red-500 text-gray-400 disabled:opacity-50 transition-all"
                title="X√≥a"
              >
                {deleting ? (
                  <Loader2 size={16} className="animate-spin" />
                ) : (
                  <Trash2 size={16} />
                )}
              </button>
            )}

            <div className="w-[1px] h-4 bg-white/10 mx-1"></div>

            <button
              onClick={onClose}
              className="p-1.5 hover:text-white text-gray-400 transition-all"
            >
              <X size={18} />
            </button>
          </div>
        </div>

        {/* --- ROW 2: CLEAN TABS (Height reduced to 40px) --- */}
        <div className="flex items-center justify-between h-[40px] px-2 relative">
          {/* Spacer Left */}
          <div className="w-[60px] shrink-0 hidden md:block"></div>

          {/* CENTER: Simple Text Tabs */}
          <div className="flex-1 flex items-center justify-center gap-6 h-full overflow-x-auto scrollbar-hide">
            <style jsx>{`
              .scrollbar-hide::-webkit-scrollbar {
                display: none;
              }
              .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
              }
            `}</style>
            {tabs.map((tab) => (
              <button
                key={tab.id}
                onClick={() => onTabChange?.(tab.id)}
                className={`relative h-full flex items-center gap-2 px-1 text-[10px] font-bold uppercase tracking-widest transition-all whitespace-nowrap group
                  ${
                    activeTab === tab.id
                      ? "text-[#C69C6D]"
                      : "text-gray-500 hover:text-white"
                  }
                `}
              >
                {tab.label}
                {(tabCounts[tab.id] !== undefined ||
                  tab.count !== undefined) && (
                  <span
                    className={`text-[9px] ${
                      activeTab === tab.id
                        ? "text-[#C69C6D]"
                        : "text-gray-600 group-hover:text-gray-400"
                    }`}
                  >
                    ({tabCounts[tab.id] ?? tab.count ?? 0})
                  </span>
                )}

                {/* Active Indicator Line (Simple Underline) */}
                {activeTab === tab.id && (
                  <div className="absolute bottom-0 left-0 right-0 h-[2px] bg-[#C69C6D] shadow-[0_0_8px_#C69C6D]" />
                )}
              </button>
            ))}
          </div>

          {/* RIGHT: Search & Sort Tools */}
          <div className="w-[60px] shrink-0 flex items-center justify-end gap-1">
            {currentTabConfig?.searchable && onSearch && (
              <div className="relative flex items-center">
                {showSearch ? (
                  <div className="absolute right-0 top-1/2 -translate-y-1/2 flex items-center bg-[#1a1a1a] border border-white/20 rounded z-10 animate-in slide-in-from-right-5 shadow-xl">
                    <input
                      autoFocus
                      type="text"
                      placeholder="T√¨m..."
                      value={localSearchTerm}
                      onChange={(e) => handleSearch(e.target.value)}
                      className="w-24 bg-transparent pl-2 pr-5 py-1 text-[10px] text-white placeholder:text-white/20 focus:outline-none"
                    />
                    <button
                      onClick={() => {
                        setShowSearch(false);
                        handleSearch("");
                      }}
                      className="absolute right-1 p-0.5 text-white/40 hover:text-white"
                    >
                      <X size={10} />
                    </button>
                  </div>
                ) : (
                  <button
                    onClick={() => setShowSearch(true)}
                    className="p-1.5 text-gray-500 hover:text-white transition-all"
                  >
                    <Search size={14} />
                  </button>
                )}
              </div>
            )}

            {currentTabConfig?.sortable &&
              currentTabConfig.sortOptions &&
              onSortChange && (
                <div className="relative">
                  <button
                    onClick={() => setShowSortMenu(!showSortMenu)}
                    className="p-1.5 text-gray-500 hover:text-white transition-all"
                  >
                    <ArrowUpDown size={14} />
                  </button>
                  {showSortMenu && (
                    <>
                      <div
                        className="fixed inset-0 z-40"
                        onClick={() => setShowSortMenu(false)}
                      />
                      <div className="absolute top-full mt-1 right-0 bg-[#1a1a1a] border border-white/10 rounded shadow-xl z-[100] min-w-[100px] overflow-hidden">
                        {currentTabConfig.sortOptions.map((opt) => (
                          <button
                            key={opt.key}
                            onClick={() => {
                              onSortChange(opt.key);
                              setShowSortMenu(false);
                            }}
                            className={`w-full text-left px-3 py-2 text-[9px] font-bold border-b border-white/5 last:border-0 ${
                              sortBy === opt.key
                                ? "text-[#C69C6D]"
                                : "text-gray-400 hover:text-white hover:bg-white/5"
                            }`}
                          >
                            {opt.label}
                          </button>
                        ))}
                      </div>
                    </>
                  )}
                </div>
              )}
          </div>
        </div>
      </div>

      {/* ====== CONTENT AREA ====== */}
      <div
        className="flex-1 overflow-y-auto custom-scrollbar bg-[#050505]"
        onTouchStart={handleTouchStart}
        onTouchMove={handleTouchMove}
        onTouchEnd={handleTouchEnd}
      >
        {children}
      </div>
    </div>
  );
}
</file>

<file path="components/cacchucnang/KhungGiaoDienChucNang/KhungDanhSach.tsx">
"use client";

/**
 * ============================================================
 * KHUNG DANH S√ÅCH
 * ============================================================
 *
 * Khung giao di·ªán chu·∫©n cho trang danh s√°ch.
 * Style: Tab bar ngang + Actions g√≥c ph·∫£i (gi·ªëng GenericManager)
 */

import React, { useState, ReactNode } from "react";
import {
  Search,
  X,
  Plus,
  ArrowUpDown,
  CheckSquare,
  Trash2,
} from "lucide-react";

// ============================================================
// TYPES
// ============================================================

export interface TabItem {
  id: string;
  label: string;
  count?: number;
}

export interface SortOption {
  key: string;
  label: string;
}

export interface BulkAction {
  id: string;
  label: string;
  icon?: React.ElementType;
  color?: string;
  onClick: (selectedIds: string[]) => void;
}

export interface KhungDanhSachProps {
  // Tabs
  tabs?: TabItem[];
  activeTab?: string;
  onTabChange?: (tabId: string) => void;

  // Search
  onSearch?: (term: string) => void;

  // Sort
  sortOptions?: SortOption[];
  activeSort?: string;
  onSortChange?: (sortKey: string) => void;

  // Actions
  showAddButton?: boolean;
  onAdd?: () => void;

  // Bulk mode
  bulkMode?: boolean;
  onBulkModeToggle?: () => void;
  selectedCount?: number;
  onSelectAll?: () => void;
  onClearSelection?: () => void;
  bulkActions?: BulkAction[];

  // Loading
  loading?: boolean;

  // Content
  children: ReactNode;

  // Style
  className?: string;
}

// ============================================================
// COMPONENT
// ============================================================

export default function KhungDanhSach({
  tabs = [],
  activeTab = "all",
  onTabChange,
  onSearch,
  sortOptions = [],
  activeSort,
  onSortChange,
  showAddButton = true,
  onAdd,
  bulkMode = false,
  onBulkModeToggle,
  selectedCount = 0,
  onSelectAll,
  onClearSelection,
  bulkActions = [],
  loading = false,
  children,
  className = "",
}: KhungDanhSachProps) {
  const [showSearch, setShowSearch] = useState(false);
  const [searchTerm, setSearchTerm] = useState("");
  const [showSortMenu, setShowSortMenu] = useState(false);

  const handleSearch = (value: string) => {
    setSearchTerm(value);
    onSearch?.(value);
  };

  const clearSearch = () => {
    setSearchTerm("");
    onSearch?.("");
    setShowSearch(false);
  };

  return (
    <div
      className={`w-full h-full flex flex-col bg-[#050505] overflow-hidden ${className}`}
    >
      {/* ====== TAB BAR - Style gi·ªëng GenericManager ====== */}
      <div className="shrink-0 h-[40px] flex items-center border-b border-white/5 bg-[#0a0a0a]">
        {/* Tabs - cu·ªôn ƒë∆∞·ª£c */}
        <div className="flex-1 flex items-center gap-1 px-2 overflow-x-auto min-w-0 scrollbar-hide">
          <style jsx>{`
            .scrollbar-hide::-webkit-scrollbar {
              display: none;
            }
            .scrollbar-hide {
              -ms-overflow-style: none;
              scrollbar-width: none;
            }
          `}</style>
          {tabs.map((tab) => (
            <button
              key={tab.id}
              onClick={() => onTabChange?.(tab.id)}
              className={`flex items-center gap-1 px-2 py-1 text-[10px] font-bold uppercase whitespace-nowrap rounded transition-all shrink-0 ${
                activeTab === tab.id
                  ? "text-[#C69C6D] bg-[#C69C6D]/10"
                  : "text-gray-500 hover:text-white hover:bg-white/5"
              }`}
            >
              {tab.label}
              {tab.count !== undefined && (
                <span
                  className={`px-1 py-0.5 rounded text-[8px] ${
                    activeTab === tab.id
                      ? "bg-[#C69C6D] text-black"
                      : "bg-white/10 text-gray-400"
                  }`}
                >
                  {tab.count}
                </span>
              )}
            </button>
          ))}
        </div>

        {/* Actions - c·ªë ƒë·ªãnh ph·∫£i */}
        <div className="shrink-0 flex items-center gap-1 px-2 border-l border-white/5 bg-[#0a0a0a]">
          {/* Search */}
          {onSearch && (
            <div className="relative flex items-center">
              {showSearch ? (
                <div className="flex items-center gap-1 animate-in slide-in-from-right-2">
                  <input
                    autoFocus
                    type="text"
                    placeholder="T√¨m..."
                    value={searchTerm}
                    onChange={(e) => handleSearch(e.target.value)}
                    className="w-28 bg-white/5 border border-white/10 rounded pl-2 pr-6 py-1 text-[10px] text-white placeholder:text-white/20 focus:outline-none focus:border-[#C69C6D]"
                  />
                  <button
                    onClick={clearSearch}
                    className="absolute right-1 p-0.5 text-white/40 hover:text-white"
                  >
                    <X size={12} />
                  </button>
                </div>
              ) : (
                <button
                  onClick={() => setShowSearch(true)}
                  className="p-1.5 bg-white/5 hover:bg-white/10 text-white/60 rounded transition-all"
                >
                  <Search size={14} />
                </button>
              )}
            </div>
          )}

          {/* Sort */}
          {sortOptions.length > 0 && (
            <div className="relative">
              <button
                onClick={() => setShowSortMenu(!showSortMenu)}
                className="p-1.5 bg-white/5 hover:bg-white/10 text-white/60 rounded transition-all"
              >
                <ArrowUpDown size={14} />
              </button>
              {showSortMenu && (
                <>
                  <div
                    className="fixed inset-0 z-40"
                    onClick={() => setShowSortMenu(false)}
                  />
                  <div className="absolute top-full mt-1 right-0 bg-[#1a1a1a] border border-white/10 rounded-lg shadow-2xl z-[100] min-w-[90px] overflow-hidden">
                    {sortOptions.map((opt) => (
                      <button
                        key={opt.key}
                        onClick={() => {
                          onSortChange?.(opt.key);
                          setShowSortMenu(false);
                        }}
                        className={`w-full text-left px-3 py-1.5 text-[10px] font-bold ${
                          activeSort === opt.key
                            ? "text-[#C69C6D] bg-[#C69C6D]/10"
                            : "text-white hover:bg-white/10"
                        }`}
                      >
                        {opt.label}
                      </button>
                    ))}
                  </div>
                </>
              )}
            </div>
          )}

          {/* Bulk Mode Toggle */}
          {onBulkModeToggle && (
            <button
              onClick={onBulkModeToggle}
              className={`p-1.5 rounded transition-all ${
                bulkMode
                  ? "bg-[#C69C6D] text-black"
                  : "bg-white/5 text-white/60 hover:bg-white/10"
              }`}
            >
              <CheckSquare size={14} />
            </button>
          )}

          {/* Add */}
          {showAddButton && onAdd && (
            <button
              onClick={onAdd}
              className="p-1.5 bg-[#C69C6D] hover:bg-white text-black rounded transition-all active:scale-95"
            >
              <Plus size={14} strokeWidth={3} />
            </button>
          )}
        </div>
      </div>

      {/* ====== BULK BAR ====== */}
      {bulkMode && selectedCount > 0 && (
        <div className="shrink-0 px-3 py-1.5 bg-[#C69C6D]/10 border-b border-[#C69C6D]/30 flex items-center justify-between gap-2">
          <div className="flex items-center gap-2">
            <span className="text-[#C69C6D] font-bold text-[10px]">
              ƒê√£ ch·ªçn: {selectedCount}
            </span>
            <button
              onClick={onSelectAll}
              className="text-[10px] text-white/60 hover:text-white underline"
            >
              T·∫•t c·∫£
            </button>
            <button
              onClick={onClearSelection}
              className="text-[10px] text-white/60 hover:text-white underline"
            >
              B·ªè ch·ªçn
            </button>
          </div>
          <div className="flex items-center gap-1">
            {bulkActions.map((action) => {
              const Icon = action.icon;
              return (
                <button
                  key={action.id}
                  onClick={() => action.onClick([])}
                  className={`p-1.5 rounded transition-all ${
                    action.color === "danger"
                      ? "bg-red-600 hover:bg-red-700 text-white"
                      : "bg-white/5 text-white/60 hover:bg-white/10"
                  }`}
                >
                  {Icon && <Icon size={14} />}
                </button>
              );
            })}
          </div>
        </div>
      )}

      {/* ====== CONTENT AREA ====== */}
      <div className="flex-1 overflow-y-auto">
        {loading ? (
          <div className="h-full flex items-center justify-center">
            <div className="w-8 h-8 border-2 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
          </div>
        ) : (
          children
        )}
      </div>
    </div>
  );
}
</file>

<file path="components/cacchucnang/KhungGiaoDienChucNang/KhungForm.tsx">
"use client";

/**
 * ============================================================
 * KHUNG FORM (CORE COMPONENT)
 * ============================================================
 * * Panel form inline chu·∫©n cho to√†n h·ªá th·ªëng.
 * * T√çNH NƒÇNG T√çCH H·ª¢P S·∫¥N:
 * 1. Giao di·ªán Header/Footer chu·∫©n.
 * 2. X√°c nh·∫≠n khi ƒë√≥ng form n·∫øu d·ªØ li·ªáu thay ƒë·ªïi (isDirty).
 * 3. T·ª± ƒë·ªông N√©n ·∫£nh (<1MB) v√† Upload l√™n Supabase (n·∫øu c√≥ prop uploadBucket).
 */

import React, { ReactNode, useState, useRef } from "react";
import { X, Save, Loader2, User, Camera } from "lucide-react";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { compressImage } from "@/app/ThuVien/compressImage";

// ============================================================
// TYPES
// ============================================================

export interface KhungFormProps {
  // Data
  isEditing?: boolean;
  data?: any;
  onClose: () => void;

  // Header Info
  title?: string;
  avatar?: string; // URL ·∫£nh hi·ªán t·∫°i
  avatarFallback?: ReactNode;

  // üü¢ C·∫§U H√åNH UPLOAD ·∫¢NH T·ª∞ ƒê·ªòNG
  showAvatarUpload?: boolean;
  uploadBucket?: string; // T√™n bucket tr√™n Supabase (vd: 'images')
  onUploadComplete?: (url: string) => void; // Callback tr·∫£ v·ªÅ URL sau khi upload xong
  onAvatarChange?: (file: File | null) => void; // (Legacy) Callback tr·∫£ v·ªÅ file th√¥ n·∫øu mu·ªën t·ª± x·ª≠ l√Ω

  // Form Actions
  onSubmit?: () => void | Promise<void>;

  // State
  loading?: boolean; // Tr·∫°ng th√°i ƒëang l∆∞u form
  isDirty?: boolean; // Tr·∫°ng th√°i ƒë√£ ch·ªânh s·ª≠a (ƒë·ªÉ hi·ªán confirm khi ƒë√≥ng)

  // Content
  children: ReactNode;
  className?: string;
}

// ============================================================
// COMPONENT
// ============================================================

export default function KhungForm({
  isEditing = false,
  onClose,
  title,
  avatar,
  avatarFallback,
  showAvatarUpload = false,
  uploadBucket, // üü¢ Nh·∫≠n t√™n bucket ƒë·ªÉ k√≠ch ho·∫°t auto-upload
  onUploadComplete,
  onAvatarChange,
  onSubmit,
  loading = false,
  isDirty = false,
  children,
  className = "",
}: KhungFormProps) {
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [showConfirm, setShowConfirm] = useState(false);

  // üü¢ State n·ªôi b·ªô ƒë·ªÉ qu·∫£n l√Ω tr·∫°ng th√°i upload ·∫£nh
  const [isUploading, setIsUploading] = useState(false);

  // X·ª≠ l√Ω ƒë√≥ng form an to√†n
  const handleClose = () => {
    if (isUploading) return; // Kh√¥ng cho ƒë√≥ng khi ƒëang upload d·ªü
    if (isDirty) {
      setShowConfirm(true);
    } else {
      onClose();
    }
  };

  const handleConfirmClose = () => {
    setShowConfirm(false);
    onClose();
  };

  // X·ª≠ l√Ω submit form
  const handleSubmit = async () => {
    if (loading || isUploading) return; // Ch·∫∑n n·∫øu ƒëang b·∫≠n
    await onSubmit?.();
  };

  // K√≠ch ho·∫°t input file
  const handleAvatarClick = () => {
    if (!isUploading) fileInputRef.current?.click();
  };

  // üü¢ CORE LOGIC: X·ª¨ L√ù ·∫¢NH (N√©n -> Upload -> L·∫•y URL)
  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // 1. Preview ngay l·∫≠p t·ª©c cho m∆∞·ª£t
    const reader = new FileReader();
    reader.onloadend = () => setAvatarPreview(reader.result as string);
    reader.readAsDataURL(file);

    // 2. N·∫øu c√≥ c·∫•u h√¨nh bucket -> T·ª± ƒë·ªông N√©n & Upload
    if (uploadBucket) {
      try {
        setIsUploading(true); // B·∫≠t loading

        // A. N√©n ·∫£nh (Gi·∫£m dung l∆∞·ª£ng ƒë·ªÉ ti·∫øt ki·ªám bƒÉng th√¥ng v√† Storage)
        // Quality 0.7, Max width 1200px l√† ƒë·ªß n√©t cho web
        const compressedFile = await compressImage(file, 0.7, 1200);

        // B. T·∫°o t√™n file an to√†n (Timestamp + Random + Extension)
        // Thay th·∫ø c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát ƒë·ªÉ tr√°nh l·ªói URL
        const safeName = file.name.replace(/[^a-zA-Z0-9]/g, "_");
        const fileName = `img_${Date.now()}_${Math.floor(
          Math.random() * 1000
        )}_${safeName}.jpg`;

        // C. Upload l√™n Supabase
        const { error: uploadError } = await supabase.storage
          .from(uploadBucket)
          .upload(fileName, compressedFile, {
            upsert: true,
            contentType: "image/jpeg",
          });

        if (uploadError) throw uploadError;

        // D. L·∫•y URL c√¥ng khai
        const { data: urlData } = supabase.storage
          .from(uploadBucket)
          .getPublicUrl(fileName);

        // E. Tr·∫£ v·ªÅ URL cho form cha ƒë·ªÉ l∆∞u v√†o DB
        if (onUploadComplete) {
          onUploadComplete(urlData.publicUrl);
        }
      } catch (error: any) {
        console.error("üî• Upload failed:", error);
        alert(`L·ªói t·∫£i ·∫£nh: ${error.message || "Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi"}`);
        setAvatarPreview(null); // Reset preview n·∫øu l·ªói
      } finally {
        setIsUploading(false); // T·∫Øt loading d√π th√†nh c√¥ng hay th·∫•t b·∫°i
      }
    }
    // 3. N·∫øu kh√¥ng c·∫•u h√¨nh bucket -> Tr·∫£ file th√¥ v·ªÅ cho cha t·ª± x·ª≠ l√Ω (Legacy support)
    else {
      onAvatarChange?.(file);
    }
  };

  // ·∫¢nh hi·ªÉn th·ªã: ∆Øu ti√™n Preview m·ªõi ch·ªçn > ·∫¢nh c≈© t·ª´ DB
  const displayAvatar = avatarPreview || avatar;

  return (
    <div
      className={`w-full h-full flex flex-col bg-[#050505] overflow-hidden ${className}`}
    >
      {/* ====== HEADER BAR ====== */}
      <div className="shrink-0 h-[45px] flex items-center border-b border-white/5 bg-[#0a0a0a]">
        {/* TR√ÅI: N√∫t ƒë√≥ng + Info */}
        <div className="shrink-0 flex items-center gap-3 px-3 border-r border-white/5">
          <button
            onClick={handleClose}
            disabled={loading || isUploading}
            className="p-2 text-white/40 hover:text-white hover:bg-white/10 rounded-full transition-all disabled:opacity-50"
          >
            <X size={16} />
          </button>
          <div className="flex items-center gap-2 pr-2">
            {/* Avatar Mini tr√™n thanh header */}
            <div className="relative w-7 h-7 rounded-full border border-[#C69C6D]/50 overflow-hidden bg-[#1a1a1a] shrink-0">
              {displayAvatar ? (
                <img
                  src={displayAvatar}
                  alt=""
                  className="w-full h-full object-cover"
                />
              ) : (
                <div className="w-full h-full flex items-center justify-center text-[#C69C6D]/50">
                  <User size={12} />
                </div>
              )}
            </div>
            <span className="text-[11px] md:text-xs font-bold text-[#C69C6D] uppercase tracking-wider truncate max-w-[150px]">
              {isEditing ? title || "C·∫¨P NH·∫¨T" : title || "TH√äM M·ªöI"}
            </span>
          </div>
        </div>

        <div className="flex-1" />

        {/* PH·∫¢I: Actions Buttons */}
        <div className="shrink-0 flex items-center gap-2 px-3 border-l border-white/5">
          <button
            onClick={handleClose}
            disabled={loading || isUploading}
            className="hidden md:block px-4 py-1.5 bg-white/5 hover:bg-white/10 text-white/60 rounded-lg text-[10px] font-bold uppercase transition-all"
          >
            H·ª¶Y B·ªé
          </button>
          <button
            onClick={handleSubmit}
            disabled={loading || isUploading}
            className={`
                            px-4 py-1.5 rounded-lg text-[10px] font-bold uppercase transition-all flex items-center gap-2
                            ${
                              loading || isUploading
                                ? "bg-white/10 text-white/50 cursor-not-allowed"
                                : "bg-[#C69C6D] hover:bg-[#b58b5d] text-black shadow-[0_0_10px_rgba(198,156,109,0.3)]"
                            }
                        `}
          >
            {loading || isUploading ? (
              <Loader2 size={14} className="animate-spin" />
            ) : (
              <Save size={14} />
            )}
            <span>
              {isUploading
                ? "ƒêANG T·∫¢I ·∫¢NH..."
                : loading
                ? "ƒêANG L∆ØU..."
                : "L∆ØU L·∫†I"}
            </span>
          </button>
        </div>
      </div>

      {/* Hidden Input File */}
      {showAvatarUpload && (
        <input
          ref={fileInputRef}
          type="file"
          accept="image/*"
          className="hidden"
          onChange={handleFileChange}
        />
      )}

      {/* ====== CONTENT AREA ====== */}
      <div className="flex-1 overflow-y-auto p-4 md:p-6 custom-scrollbar">
        {/* Khu v·ª±c Upload ·∫¢nh L·ªõn */}
        {showAvatarUpload && (
          <div className="flex justify-center mb-8">
            <div
              onClick={handleAvatarClick}
              className={`
                                relative w-28 h-28 rounded-full border-2 overflow-hidden bg-[#1a1a1a] group transition-all
                                ${
                                  isUploading
                                    ? "border-[#C69C6D] cursor-wait scale-95"
                                    : "border-[#C69C6D]/30 hover:border-[#C69C6D] cursor-pointer hover:shadow-lg"
                                }
                            `}
            >
              {displayAvatar ? (
                <img
                  src={displayAvatar}
                  alt=""
                  className={`w-full h-full object-cover transition-opacity ${
                    isUploading ? "opacity-50" : "opacity-100"
                  }`}
                />
              ) : (
                <div className="w-full h-full flex items-center justify-center text-[#C69C6D]/30">
                  <User size={40} />
                </div>
              )}

              {/* Overlay hi·ªáu ·ª©ng */}
              <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center transition-opacity">
                {isUploading ? (
                  <div className="text-[#C69C6D] flex flex-col items-center gap-1">
                    <Loader2 size={24} className="animate-spin" />
                    <span className="text-[8px] font-bold uppercase">
                      Uploading...
                    </span>
                  </div>
                ) : (
                  <div className="text-white flex flex-col items-center gap-1">
                    <Camera size={24} />
                    <span className="text-[8px] font-bold uppercase">
                      Thay ƒë·ªïi
                    </span>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Form Fields Children */}
        {children}
      </div>

      {/* ====== CONFIRM DIALOG ====== */}
      {showConfirm && (
        <div className="fixed inset-0 z-[110] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-in fade-in duration-200">
          <div className="bg-[#1a1a1a] border border-white/10 rounded-xl p-6 max-w-xs w-full text-center shadow-2xl">
            <h3 className="text-white font-bold text-lg mb-2">
              D·ªØ li·ªáu ch∆∞a l∆∞u
            </h3>
            <p className="text-white/60 text-sm mb-6">
              B·∫°n c√≥ ch·∫Øc mu·ªën ƒë√≥ng kh√¥ng? M·ªçi thay ƒë·ªïi s·∫Ω b·ªã m·∫•t.
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setShowConfirm(false)}
                className="flex-1 py-2.5 rounded-lg bg-white/5 text-white/70 font-bold text-xs uppercase hover:bg-white/10 transition-all"
              >
                ·ªû L·∫°i
              </button>
              <button
                onClick={handleConfirmClose}
                className="flex-1 py-2.5 rounded-lg bg-red-600/80 hover:bg-red-600 text-white font-bold text-xs uppercase transition-all shadow-lg shadow-red-900/20"
              >
                ƒê√≥ng & H·ªßy
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan.tsx">
"use client";

import React, { ReactNode } from "react";
import MenuTren from "@/app/GiaoDienTong/MenuTren/MenuTren";

import { Z_INDEX } from "@/app/constants/zIndex";

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const BASE_IMG_URL = `${SUPABASE_URL}/storage/v1/object/public/hinh-nen`;

interface Props {
  children: ReactNode;
  nguoiDung: any;
  loiChao?: string;
  contentClassName?: string;
}

export default function KhungTrangChuan({
  children,
  nguoiDung,
  loiChao,
  contentClassName = "max-w-[1920px] mx-auto p-3 pb-24 md:p-6 md:pb-24 pt-24",
}: Props) {
  const bgUrlMobile = `${BASE_IMG_URL}/trangchu-mobile.jpg`;
  const bgUrlTablet = `${BASE_IMG_URL}/trangchu-tablet.jpg`;
  const bgUrlDesktop = `${BASE_IMG_URL}/trangchu-desktop.jpg`;

  const displayLoiChao = loiChao || `Xin ch√†o, ${nguoiDung?.ho_ten || "User"}`;

  return (
    <div className="relative w-full min-h-screen bg-[#050505] text-[#F5F5F5] font-sans overflow-x-hidden selection:bg-[#C69C6D] selection:text-black text-[14px]">
      {/* LAYER 0: H√åNH N·ªÄN CHU·∫®N */}
      <div className="fixed inset-0 w-full h-full z-0 pointer-events-none select-none bg-black">
        <img
          src={bgUrlMobile}
          alt="BG"
          className="absolute inset-0 w-full h-full object-cover md:hidden opacity-100"
        />
        <img
          src={bgUrlTablet}
          alt="BG"
          className="absolute inset-0 w-full h-full object-cover hidden md:block lg:hidden opacity-100"
        />
        <img
          src={bgUrlDesktop}
          alt="BG"
          className="absolute inset-0 w-full h-full object-cover hidden lg:block opacity-100"
        />
        <div className="absolute inset-0 bg-gradient-to-t from-black via-black/60 to-black/40" />
      </div>

      {/* LAYER 1: N·ªòI DUNG CH√çNH */}
      <main
        className={`relative z-[10] w-full min-h-screen flex flex-col ${contentClassName}`}
      >
        {children}
      </main>

      {/* LAYER 2: GRADIENT B·∫¢O V·ªÜ MENU */}
      <div className="fixed top-0 left-0 right-0 h-28 bg-gradient-to-b from-black to-transparent z-[4900] pointer-events-none"></div>
      <div className="fixed bottom-0 left-0 right-0 h-28 bg-gradient-to-t from-black to-transparent z-[4900] pointer-events-none"></div>

      {/* LAYER 3: H·ªÜ TH·ªêNG MENU */}
      <MenuTren nguoiDung={nguoiDung} loiChao={displayLoiChao} />
    </div>
  );
}
</file>

<file path="components/cacchucnang/mauthietke/config.ts">
import { Palette, Image as ImageIcon, Tag, User } from "lucide-react";
import {
  ManagerConfig,
  FieldConfig,
  FilterTabConfig,
  TabConfig,
} from "../types";
import {
  getMauThietKeDataAction,
  createMauThietKeAction,
  updateMauThietKeAction,
  deleteMauThietKeAction,
} from "@/app/actions/QuyenHanThietKe";

// 1. C·∫¨P NH·∫¨T INTERFACE (Th√™m file_thiet_ke)
export interface MauThietKe {
  id: string;
  mo_ta: string;
  phan_loai: string;
  phan_loai_normalized: string;
  hinh_anh: string;
  // Th√™m tr∆∞·ªùng n√†y ƒë·ªÉ l∆∞u danh s√°ch link
  file_thiet_ke?: string[];
  nguoi_tao: string;
  ten_nguoi_tao?: string;
  tao_luc: string;
}

export interface MauThietKePermissions {
  allowView?: boolean;
  allowEdit?: boolean;
  allowDelete?: boolean;
  allowBulk?: boolean;
}

// C√°c lo·∫°i ph√¢n lo·∫°i chu·∫©n h√≥a
const PHAN_LOAI_OPTIONS = [
  "Tranh ch√¢n dung g·∫°o In UV + V·∫Ω m·∫∑t",
  "Tranh phong c·∫£nh G·∫°o - T·∫•m - C√°m",
  "ƒêƒ©a Tranh G·∫°o",
  "Tranh g·∫°o In UV",
  "Tranh In ƒê·ªÉ B√†n",
  "N√≥n l√° g·∫°o",
  "Tranh g·∫°o in UV c√≥ ƒë·ªìng h·ªì",
  "Tranh ch√¢n dung th·ªß c√¥ng 100%",
];

const fields: FieldConfig[] = [
  {
    key: "hinh_anh",
    label: "H√¨nh ·∫£nh m·∫´u",
    type: "image",
    showInForm: true,
    showInDetail: false,
    showInCard: true,
  },
  {
    key: "mo_ta",
    label: "M√¥ t·∫£ / T√™n m·∫´u",
    type: "text",
    placeholder: "Nh·∫≠p t√™n m·∫´u thi·∫øt k·∫ø...",
    required: true,
    icon: Palette,
  },
  {
    key: "phan_loai",
    label: "Ph√¢n lo·∫°i",
    type: "select",
    options: PHAN_LOAI_OPTIONS,
    required: true,
    icon: Tag,
  },
  {
    key: "ten_nguoi_tao",
    label: "Ng∆∞·ªùi thi·∫øt k·∫ø",
    type: "readonly",
    icon: User,
    showInForm: false,
  },
];

// 2. C·∫¨P NH·∫¨T B·ªò L·ªåC (Th√™m tab l·ªçc File Thi·∫øt K·∫ø)
const filterTabs: FilterTabConfig[] = [
  // Tab m·ªõi: L·ªçc nh·ªØng m·∫´u ƒë√£ c√≥ file
  {
    id: "has_file",
    label: "ƒê√É C√ì FILE",
    filterField: "file_thiet_ke", // Tr∆∞·ªùng n√†y s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω logic ri√™ng ·ªü Controller
  },
  {
    id: "tranhchandunggaoinuv+vemat",
    label: "CH√ÇN DUNG UV",
    filterField: "phan_loai_normalized",
  },
  {
    id: "tranhphongcanhgao-tam-cam",
    label: "PHONG C·∫¢NH",
    filterField: "phan_loai_normalized",
  },
  { id: "tranhgaoinuv", label: "IN UV", filterField: "phan_loai_normalized" },
  {
    id: "diatranhgao",
    label: "ƒêƒ®A TRANH",
    filterField: "phan_loai_normalized",
  },
  { id: "tranhindeban", label: "ƒê·ªÇ B√ÄN", filterField: "phan_loai_normalized" },
];

const detailTabs: TabConfig[] = [{ id: "thongtin", label: "CHI TI·∫æT" }];

const dataSource = {
  fetchList: async (
    page: number,
    limit: number,
    search: string,
    filter: string
  ) => {
    const res = await getMauThietKeDataAction(page, limit, search, filter);
    return {
      success: res.success,
      data: res.data as MauThietKe[] | undefined,
      error: res.error,
    };
  },
  create: async (data: Partial<MauThietKe>) => {
    const res = await createMauThietKeAction(data);
    return { success: res.success, data: (res as any)?.data, error: res.error };
  },
  update: async (id: string, data: Partial<MauThietKe>) => {
    const res = await updateMauThietKeAction(id, data);
    return { success: res.success, data: (res as any)?.data, error: res.error };
  },
  delete: async (id: string) => {
    const res = await deleteMauThietKeAction(id);
    return { success: res.success, error: res.error };
  },
};

export function createMauThietKeConfig(
  permissions: MauThietKePermissions = {}
): ManagerConfig<MauThietKe> {
  const {
    allowView = true,
    allowEdit = true,
    allowDelete = false,
    allowBulk = false,
  } = permissions;

  return {
    entityName: "m·∫´u thi·∫øt k·∫ø",
    entityNamePlural: "m·∫´u thi·∫øt k·∫ø",
    idField: "id",
    fields,
    cardConfig: {
      avatarField: "hinh_anh",
      titleField: "mo_ta",
      subtitleField: "phan_loai",
      infoFields: [{ field: "ten_nguoi_tao", icon: User }],
    },
    filterTabs,
    detailTabs,
    actions: {
      allowView,
      allowEdit,
      allowDelete,
      allowBulkSelect: allowBulk,
      allowBulkDelete: allowBulk && allowDelete,
    },
    dataSource,
    searchFields: ["mo_ta"],
    sortOptions: [
      {
        key: "newest",
        label: "M·ªöI NH·∫§T",
        sortFn: (a: MauThietKe, b: MauThietKe) =>
          new Date(b.tao_luc).getTime() - new Date(a.tao_luc).getTime(),
      },
      {
        key: "name",
        label: "T√äN A-Z",
        sortFn: (a: MauThietKe, b: MauThietKe) =>
          a.mo_ta.localeCompare(b.mo_ta),
      },
    ],
    defaultSort: "newest",
    uploadConfig: { bucket: "images", fileNamePrefix: "mau" }, // ƒê√£ chu·∫©n h√≥a v·ªÅ 'images'
  };
}
</file>

<file path="components/cacchucnang/mauthietke/index.ts">
export { default as MauThietKeChucNang } from "./MauThietKeChucNang";
export { createMauThietKeConfig } from "./config";
export type { MauThietKe, MauThietKePermissions } from "./config";
</file>

<file path="components/cacchucnang/mauthietke/MauThietKeChucNang.tsx">
"use client";

import React, { useState, useEffect, useMemo, useCallback } from "react";
import { Trash2 } from "lucide-react";
import { KhungDanhSach } from "@/app/components/cacchucnang/KhungGiaoDienChucNang";
import ConfirmDialog from "@/app/components/ConfirmDialog";
import {
  MauThietKe,
  MauThietKePermissions,
  createMauThietKeConfig,
} from "./config";

// IMPORT 3 TH√ÄNH PH·∫¶N ƒê√É T√ÅCH
import MauThietKeList from "./MauThietKeList";
import MauThietKeForm from "./MauThietKeForm";
import MauThietKeDetail from "./MauThietKeDetail";

interface Props {
  permissions?: MauThietKePermissions;
  className?: string;
}

const toNonAccent = (str: string) =>
  str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "")
    .toLowerCase();

export default function MauThietKeChucNang({
  permissions = {},
  className = "",
}: Props) {
  const config = createMauThietKeConfig(permissions);
  const {
    allowEdit = true,
    allowDelete = false,
    allowBulk = false,
  } = permissions;

  // --- STATE QU·∫¢N L√ù ---
  const [items, setItems] = useState<MauThietKe[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [activeTab, setActiveTab] = useState("all");
  const [sortBy, setSortBy] = useState("newest");

  // View State
  const [viewMode, setViewMode] = useState<"list" | "detail" | "form">("list");
  const [selectedItem, setSelectedItem] = useState<MauThietKe | null>(null);

  // Action State
  const [bulkMode, setBulkMode] = useState(false);
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [confirmDelete, setConfirmDelete] = useState<{
    show: boolean;
    ids: string[];
  }>({ show: false, ids: [] });
  const [saving, setSaving] = useState(false);

  // --- FETCH DATA ---
  const fetchData = useCallback(async () => {
    setLoading(true);
    try {
      if (config.dataSource?.fetchList) {
        const res = await config.dataSource.fetchList(1, 100, "", "");
        if (res.success && res.data) setItems(res.data);
      }
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  }, [config.dataSource]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  // --- FILTER & SORT LOGIC ---
  const filteredList = useMemo(() => {
    let result = items;

    // 1. LOGIC L·ªåC M·ªöI (X·ª≠ l√Ω tab 'ƒê√É C√ì FILE')
    if (activeTab === "has_file") {
      result = result.filter((i) => {
        // Ki·ªÉm tra xem c√≥ file thi·∫øt k·∫ø kh√¥ng (Array ho·∫∑c JSON string)
        const files = i.file_thiet_ke;
        if (Array.isArray(files) && files.length > 0) return true;
        if (typeof files === "string") {
          try {
            const parsed = JSON.parse(files);
            return Array.isArray(parsed) && parsed.length > 0;
          } catch {
            return false;
          }
        }
        return false;
      });
    }
    // L·ªçc theo ph√¢n lo·∫°i th√¥ng th∆∞·ªùng
    else if (activeTab !== "all") {
      result = result.filter((i) => i.phan_loai_normalized === activeTab);
    }

    // T√¨m ki·∫øm
    if (searchTerm) {
      const term = toNonAccent(searchTerm);
      result = result.filter((i) => toNonAccent(i.mo_ta).includes(term));
    }

    // S·∫Øp x·∫øp
    const sortOpt = config.sortOptions?.find((s) => s.key === sortBy);
    if (sortOpt?.sortFn) {
      result = [...result].sort(sortOpt.sortFn);
    }
    return result;
  }, [items, activeTab, searchTerm, sortBy, config.sortOptions]);

  const tabs = useMemo(() => {
    const counts: Record<string, number> = { all: items.length };

    config.filterTabs?.forEach((tab) => {
      // 2. LOGIC ƒê·∫æM S·ªê L∆Ø·ª¢NG M·ªöI CHO TAB 'HAS_FILE'
      if (tab.id === "has_file") {
        counts[tab.id] = items.filter((i) => {
          const files = i.file_thiet_ke;
          if (Array.isArray(files) && files.length > 0) return true;
          if (typeof files === "string") {
            try {
              const parsed = JSON.parse(files);
              return Array.isArray(parsed) && parsed.length > 0;
            } catch {
              return false;
            }
          }
          return false;
        }).length;
      }
      // ƒê·∫øm cho c√°c tab ph√¢n lo·∫°i b√¨nh th∆∞·ªùng
      else if (tab.id && tab.filterField) {
        counts[tab.id] = items.filter(
          (i) => (i as any)[tab.filterField!] === tab.id
        ).length;
      }
    });

    const dynamicTabs =
      config.filterTabs?.map((t) => ({
        id: t.id || "",
        label: t.label,
        count: t.id ? counts[t.id] || 0 : 0,
      })) || [];
    return [{ id: "all", label: "T·∫§T C·∫¢", count: counts.all }, ...dynamicTabs];
  }, [items, config.filterTabs]);

  // --- ACTION HANDLERS ---
  const handleOpenDetail = (item: MauThietKe) => {
    setSelectedItem(item);
    setViewMode("detail");
  };

  const handleOpenForm = (item?: MauThietKe) => {
    setSelectedItem(item || null);
    setViewMode("form");
  };

  // --- [UPDATED] LOGIC CHECK K·∫æT QU·∫¢ TR·∫¢ V·ªÄ T·ª™ BACKEND ---
  const handleSave = async (formData: any) => {
    setSaving(true);
    try {
      let res; // Bi·∫øn h·ª©ng k·∫øt qu·∫£

      if (selectedItem?.id) {
        if (config.dataSource?.update) {
          res = await config.dataSource.update(selectedItem.id, formData);
        }
      } else {
        if (config.dataSource?.create) {
          res = await config.dataSource.create(formData);
        }
      }

      // KI·ªÇM TRA: N·∫øu Backend tr·∫£ v·ªÅ success: false (do kh√¥ng c√≥ quy·ªÅn s·ª≠a, l·ªói logic...)
      if (res && !res.success) {
        // Hi·ªán th√¥ng b√°o l·ªói v√† KH√îNG ƒë√≥ng form
        alert(
          res.error || "Thao t√°c th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra l·∫°i quy·ªÅn h·∫°n!"
        );
        return; // D·ª´ng h√†m t·∫°i ƒë√¢y
      }

      // N·∫øu th√†nh c√¥ng -> T·∫£i l·∫°i d·ªØ li·ªáu v√† ƒë√≥ng form
      await fetchData();
      setViewMode("list");
      setSelectedItem(null);
    } catch (e) {
      console.error(e);
      alert("ƒê√£ c√≥ l·ªói h·ªá th·ªëng x·∫£y ra!");
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (ids: string[]) => {
    if (config.dataSource?.delete) {
      // Logic x√≥a c≈©ng n√™n c√≥ try/catch t∆∞∆°ng t·ª± nh∆∞ng t·∫°m th·ªùi gi·ªØ nguy√™n theo code g·ªëc
      // ƒë·ªÉ tr√°nh ·∫£nh h∆∞·ªüng logic delete h√†ng lo·∫°t
      for (const id of ids) await config.dataSource.delete(id);
      await fetchData();
      setSelectedIds(new Set());
      setConfirmDelete({ show: false, ids: [] });
      setViewMode("list");
    }
  };

  const handleBulkSelect = (id: string) => {
    const newSet = new Set(selectedIds);
    if (newSet.has(id)) newSet.delete(id);
    else newSet.add(id);
    setSelectedIds(newSet);
  };

  // --- RENDER ---
  return (
    <div className={`h-full ${className}`}>
      {/* 1. LIST VIEW */}
      {viewMode === "list" && (
        <KhungDanhSach
          tabs={tabs}
          activeTab={activeTab}
          onTabChange={setActiveTab}
          onSearch={setSearchTerm}
          sortOptions={
            config.sortOptions?.map((s) => ({ key: s.key, label: s.label })) ||
            []
          }
          activeSort={sortBy}
          onSortChange={setSortBy}
          showAddButton={allowEdit}
          onAdd={() => handleOpenForm()}
          bulkMode={bulkMode}
          onBulkModeToggle={
            allowBulk ? () => setBulkMode(!bulkMode) : undefined
          }
          selectedCount={selectedIds.size}
          onSelectAll={() =>
            setSelectedIds(new Set(filteredList.map((i) => i.id)))
          }
          onClearSelection={() => setSelectedIds(new Set())}
          bulkActions={
            allowDelete
              ? [
                  {
                    id: "delete",
                    label: "X√ìA",
                    icon: Trash2,
                    color: "danger",
                    onClick: () =>
                      setConfirmDelete({
                        show: true,
                        ids: Array.from(selectedIds),
                      }),
                  },
                ]
              : []
          }
          loading={loading}
        >
          <MauThietKeList
            items={filteredList}
            bulkMode={bulkMode}
            selectedIds={selectedIds}
            onToggleSelect={handleBulkSelect}
            onClickItem={handleOpenDetail}
          />
        </KhungDanhSach>
      )}

      {/* 2. FORM VIEW */}
      {viewMode === "form" && (
        <MauThietKeForm
          data={selectedItem}
          onClose={() => {
            setViewMode("list");
            setSelectedItem(null);
          }}
          onSubmit={handleSave}
          loading={saving}
        />
      )}

      {/* 3. DETAIL VIEW */}
      {viewMode === "detail" && selectedItem && (
        <MauThietKeDetail
          data={selectedItem}
          onClose={() => {
            setViewMode("list");
            setSelectedItem(null);
          }}
          allowEdit={allowEdit}
          allowDelete={allowDelete}
          onEdit={() => handleOpenForm(selectedItem)}
          onDelete={() =>
            setConfirmDelete({ show: true, ids: [selectedItem.id] })
          }
        />
      )}

      <ConfirmDialog
        isOpen={confirmDelete.show}
        title="X√ÅC NH·∫¨N X√ìA"
        message={`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${confirmDelete.ids.length} m·∫´u thi·∫øt k·∫ø?`}
        onConfirm={() => handleDelete(confirmDelete.ids)}
        onCancel={() => setConfirmDelete({ show: false, ids: [] })}
      />
    </div>
  );
}
</file>

<file path="components/cacchucnang/mauthietke/MauThietKeDetail.tsx">
"use client";

import React, { useState } from "react";
import {
  Tag,
  User,
  Calendar,
  Link as LinkIcon,
  Palette,
  ExternalLink,
  Clock,
} from "lucide-react";
import { KhungChiTiet } from "@/app/components/cacchucnang/KhungGiaoDienChucNang";
import { MauThietKe, createMauThietKeConfig } from "./config";

interface Props {
  data: MauThietKe;
  onClose: () => void;
  allowEdit: boolean;
  allowDelete: boolean;
  onEdit: () => void;
  onDelete: () => void;
}

// Interface m·ªü r·ªông ƒë·ªÉ h·ª©ng c√°c tr∆∞·ªùng m·ªõi t·ª´ backend
interface FileItem {
  ten: string;
  url: string;
  nguoi_dang?: string; // T√™n ng∆∞·ªùi upload
  last_modified?: string; // Th·ªùi gian upload
}

export default function MauThietKeDetail({
  data,
  onClose,
  allowEdit,
  allowDelete,
  onEdit,
  onDelete,
}: Props) {
  const config = createMauThietKeConfig();
  const [activeTab, setActiveTab] = useState("thongtin");
  const tabs = config.detailTabs.map((t) => ({ ...t, id: t.id || "" }));

  const item = data as any;

  // Helper format th·ªùi gian ng·∫Øn g·ªçn (VD: 14:30 25/12)
  const formatTime = (isoString?: string) => {
    if (!isoString) return "";
    const date = new Date(isoString);
    return date.toLocaleString("vi-VN", {
      hour: "2-digit",
      minute: "2-digit",
      day: "2-digit",
      month: "2-digit",
      year: "numeric", // C√≥ th·ªÉ b·ªè year n·∫øu mu·ªën g·ªçn h∆°n
    });
  };

  const getFileNameFromUrl = (url: string) => {
    try {
      return decodeURIComponent(url).split("?")[0].split("/").pop() || url;
    } catch {
      return url;
    }
  };

  const getDesignFiles = (): FileItem[] => {
    if (!item || !item.file_thiet_ke) return [];
    let parsed: any[] = [];
    const rawData = item.file_thiet_ke;

    try {
      if (Array.isArray(rawData)) parsed = rawData;
      else if (typeof rawData === "string" && rawData.trim()) {
        const result = JSON.parse(rawData);
        if (Array.isArray(result)) parsed = result;
      }
    } catch {
      return [];
    }

    return parsed
      .map((entry: any) => {
        // Data c≈© (String)
        if (typeof entry === "string") {
          return { ten: getFileNameFromUrl(entry), url: entry };
        }
        // Data m·ªõi (Object)
        if (typeof entry === "object" && entry !== null) {
          return {
            ten:
              entry.ten ||
              getFileNameFromUrl(entry.url || "") ||
              "File ƒë√≠nh k√®m",
            url: entry.url || "",
            nguoi_dang: entry.nguoi_dang,
            last_modified: entry.last_modified,
          };
        }
        return null;
      })
      .filter((f): f is FileItem => f !== null && f.url.trim() !== "");
  };

  const designFiles = getDesignFiles();

  return (
    <KhungChiTiet
      data={data}
      onClose={onClose}
      avatar={item.hinh_anh}
      title={item.ten || item.mo_ta || "Chi ti·∫øt m·∫´u"}
      tabs={tabs}
      activeTab={activeTab}
      onTabChange={setActiveTab}
      showEditButton={allowEdit}
      showDeleteButton={allowDelete}
      onEdit={onEdit}
      onDelete={onDelete}
    >
      <div className="p-4 space-y-4">
        {/* H√åNH ·∫¢NH */}
        <div className="aspect-video w-full rounded-xl overflow-hidden bg-[#1a1a1a] border border-white/10 relative group">
          {item.hinh_anh ? (
            <img
              src={item.hinh_anh}
              alt=""
              className="w-full h-full object-contain"
            />
          ) : (
            <div className="w-full h-full flex items-center justify-center text-white/20">
              <Palette size={48} />
            </div>
          )}
        </div>

        {/* DANH S√ÅCH FILE - GIAO DI·ªÜN M·ªöI */}
        {designFiles.length > 0 ? (
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <label className="text-[10px] text-white/40 font-bold uppercase">
                File Thi·∫øt K·∫ø G·ªëc ({designFiles.length})
              </label>
            </div>

            <div className="grid gap-2">
              {designFiles.map((file, idx) => (
                <a
                  key={idx}
                  href={file.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="group flex items-center gap-3 p-3 bg-[#151515] hover:bg-[#C69C6D] border border-white/10 hover:border-[#C69C6D] rounded-lg transition-all relative overflow-hidden"
                  title={file.url}
                >
                  {/* Icon File */}
                  <div className="w-10 h-10 rounded bg-black/20 flex items-center justify-center text-[#C69C6D] group-hover:text-black shrink-0">
                    <LinkIcon size={18} />
                  </div>

                  {/* Th√¥ng tin ch√≠nh */}
                  <div className="flex-1 overflow-hidden">
                    {/* T√™n File */}
                    <div className="flex items-center gap-2">
                      <p className="text-sm font-bold text-[#C69C6D] group-hover:text-black truncate">
                        {file.ten}
                      </p>
                    </div>

                    {/* Metadata: Ng∆∞·ªùi ƒëƒÉng - Th·ªùi gian */}
                    <div className="flex items-center gap-2 mt-0.5 text-[10px] text-white/40 group-hover:text-black/70 font-mono">
                      {file.nguoi_dang && (
                        <span className="flex items-center gap-1">
                          <User size={10} /> {file.nguoi_dang}
                        </span>
                      )}

                      {file.nguoi_dang && file.last_modified && <span>‚Ä¢</span>}

                      {file.last_modified && (
                        <span className="flex items-center gap-1">
                          <Clock size={10} /> {formatTime(file.last_modified)}
                        </span>
                      )}
                    </div>
                  </div>

                  <ExternalLink
                    size={14}
                    className="text-white/20 group-hover:text-black/40"
                  />
                </a>
              ))}
            </div>
          </div>
        ) : (
          <div className="p-3 rounded-lg border border-dashed border-white/10 flex items-center justify-center gap-2 text-white/20">
            <LinkIcon size={14} />
            <span className="text-xs italic">Ch∆∞a c√≥ file thi·∫øt k·∫ø n√†o</span>
          </div>
        )}

        {/* TH√îNG TIN KH√ÅC */}
        <div className="grid gap-3 pt-2 border-t border-white/5">
          <DetailRow
            icon={<Tag size={18} />}
            label="Ph√¢n lo·∫°i"
            value={item.phan_loai}
          />
          <DetailRow
            icon={<User size={18} />}
            label="Ng∆∞·ªùi t·∫°o m·∫´u"
            value={item.ten_nguoi_tao}
          />
          <DetailRow
            icon={<Calendar size={18} />}
            label="Ng√†y t·∫°o m·∫´u"
            value={
              item.tao_luc || item.created_at
                ? new Date(item.tao_luc || item.created_at).toLocaleDateString(
                    "vi-VN"
                  )
                : "---"
            }
          />
        </div>
      </div>
    </KhungChiTiet>
  );
}

function DetailRow({
  icon,
  label,
  value,
}: {
  icon: any;
  label: string;
  value: string;
}) {
  return (
    <div className="p-3 bg-[#151515] rounded-xl border border-white/5 flex items-center gap-3">
      <div className="text-[#C69C6D]">{icon}</div>
      <div>
        <p className="text-[10px] text-white/40 font-bold uppercase">{label}</p>
        <p className="text-white text-sm">{value || "---"}</p>
      </div>
    </div>
  );
}
</file>

<file path="components/cacchucnang/mauthietke/MauThietKeForm.tsx">
"use client";

import React, { useState } from "react";
import { Plus, Link as LinkIcon, Trash2, Type } from "lucide-react";
import { KhungForm } from "@/app/components/cacchucnang/KhungGiaoDienChucNang";
import { MauThietKe, createMauThietKeConfig } from "./config";

interface Props {
  data: MauThietKe | null; // null = T·∫°o m·ªõi
  onClose: () => void;
  onSubmit: (formData: any) => Promise<void>;
  loading: boolean;
}

// 1. ƒê·ªãnh nghƒ©a ki·ªÉu d·ªØ li·ªáu cho file thi·∫øt k·∫ø
interface FileItem {
  ten: string;
  url: string;
}

// 2. ƒê·ªãnh nghƒ©a ki·ªÉu State cho Form (Tr√°nh xung ƒë·ªôt Type)
interface FormState extends Omit<Partial<MauThietKe>, "file_thiet_ke"> {
  file_thiet_ke: FileItem[];
}

export default function MauThietKeForm({
  data,
  onClose,
  onSubmit,
  loading,
}: Props) {
  const config = createMauThietKeConfig();

  // 3. Kh·ªüi t·∫°o state
  const [formData, setFormData] = useState<FormState>(() => {
    let files: FileItem[] = [];

    // Logic parse d·ªØ li·ªáu c≈©
    if (data && (data as any).file_thiet_ke) {
      try {
        const raw = (data as any).file_thiet_ke;
        let parsed: any[] = [];

        if (Array.isArray(raw)) {
          parsed = raw;
        } else if (typeof raw === "string") {
          parsed = JSON.parse(raw);
        }

        // Convert sang chu·∫©n { ten, url }
        files = parsed.map((item: any) => {
          if (typeof item === "string") return { ten: "", url: item };
          if (typeof item === "object")
            return { ten: item.ten || "", url: item.url || "" };
          return { ten: "", url: "" };
        });
      } catch {}
    }

    return data ? { ...data, file_thiet_ke: files } : { file_thiet_ke: [] };
  });

  // --- HANDLERS ---

  const handleChange = (field: keyof FormState, value: any) => {
    setFormData((prev) => ({ ...prev, [field]: value }));
  };

  const handleFileChange = (
    index: number,
    field: keyof FileItem,
    value: string
  ) => {
    const newFiles = [...formData.file_thiet_ke];
    if (!newFiles[index]) return;
    newFiles[index] = { ...newFiles[index], [field]: value };
    setFormData((prev) => ({ ...prev, file_thiet_ke: newFiles }));
  };

  const addFileRow = () => {
    setFormData((prev) => ({
      ...prev,
      file_thiet_ke: [...prev.file_thiet_ke, { ten: "", url: "" }],
    }));
  };

  const removeFileRow = (index: number) => {
    const newFiles = [...formData.file_thiet_ke];
    newFiles.splice(index, 1);
    setFormData((prev) => ({ ...prev, file_thiet_ke: newFiles }));
  };

  const handleSubmit = async () => {
    // 1. Validate th√¥ng tin chung
    if (!formData.mo_ta?.trim()) {
      alert("Vui l√≤ng nh·∫≠p T√™n m·∫´u thi·∫øt k·∫ø!");
      return;
    }
    if (!formData.phan_loai) {
      alert("Vui l√≤ng ch·ªçn Ph√¢n lo·∫°i!");
      return;
    }

    // 2. Validate file
    const validFiles = formData.file_thiet_ke.filter(
      (f) => f.ten.trim() !== "" || f.url.trim() !== ""
    );
    const hasError = validFiles.some(
      (f) => f.ten.trim() === "" || f.url.trim() === ""
    );

    if (hasError) {
      alert(
        "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß T√äN HI·ªÇN TH·ªä v√† ƒê∆Ø·ªúNG D·∫™N cho file thi·∫øt k·∫ø!"
      );
      return;
    }

    // 3. Submit (G·ª¨I M·∫¢NG TR·ª∞C TI·∫æP - Backend s·∫Ω t·ª± lo Stringify)
    // üü¢ S·ª¨A: Kh√¥ng JSON.stringify ·ªü ƒë√¢y n·ªØa
    const finalData = {
      ...formData,
      file_thiet_ke: validFiles,
    };

    await onSubmit(finalData);
  };

  return (
    <KhungForm
      onClose={onClose}
      title={data ? "S·ª¨A M·∫™U" : "TH√äM M·∫™U M·ªöI"}
      onSubmit={handleSubmit}
      loading={loading}
      isDirty={true}
      showAvatarUpload={true}
      uploadBucket="images"
      avatar={formData.hinh_anh}
      onUploadComplete={(url: string) => handleChange("hinh_anh", url)}
    >
      <div className="space-y-4">
        {/* T√™n m·∫´u */}
        <div>
          <label className="text-xs font-bold text-white/60 mb-2 block uppercase">
            T√™n m·∫´u thi·∫øt k·∫ø <span className="text-red-500">*</span>
          </label>
          <input
            className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:border-[#C69C6D] outline-none placeholder-white/20"
            value={formData.mo_ta || ""}
            onChange={(e) => handleChange("mo_ta", e.target.value)}
            placeholder="Nh·∫≠p t√™n m·∫´u..."
          />
        </div>

        {/* Ph√¢n lo·∫°i */}
        <div>
          <label className="text-xs font-bold text-white/60 mb-2 block uppercase">
            Ph√¢n lo·∫°i <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <select
              className="w-full bg-[#1a1a1a] text-white border border-white/10 rounded-lg px-4 py-3 focus:border-[#C69C6D] outline-none appearance-none"
              value={formData.phan_loai || ""}
              onChange={(e) => handleChange("phan_loai", e.target.value)}
            >
              <option value="" className="bg-[#1a1a1a] text-gray-500">
                -- Ch·ªçn lo·∫°i --
              </option>
              {config.fields
                .find((f) => f.key === "phan_loai")
                ?.options?.map((opt: any) => (
                  <option
                    key={opt}
                    value={opt}
                    className="bg-[#1a1a1a] text-white py-2"
                  >
                    {opt}
                  </option>
                ))}
            </select>
            <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-white/50 text-xs">
              ‚ñº
            </div>
          </div>
        </div>

        {/* File Thi·∫øt K·∫ø */}
        <div>
          <div className="flex items-center justify-between mb-2">
            <label className="text-xs font-bold text-white/60 uppercase">
              File Thi·∫øt K·∫ø (Google Drive)
            </label>
            <button
              type="button"
              onClick={addFileRow}
              className="flex items-center gap-1 text-[10px] bg-[#C69C6D]/20 text-[#C69C6D] hover:bg-[#C69C6D] hover:text-black px-2 py-1 rounded transition-all font-bold"
            >
              <Plus size={12} /> TH√äM FILE
            </button>
          </div>

          <div className="space-y-2">
            {formData.file_thiet_ke.map((file, idx) => (
              <div key={idx} className="flex gap-2 items-start">
                {/* T√™n */}
                <div className="w-1/3 relative group">
                  <div className="absolute left-3 top-1/2 -translate-y-1/2 text-white/30">
                    <Type size={14} />
                  </div>
                  <input
                    className={`w-full bg-white/5 border rounded-lg pl-9 pr-3 py-2.5 text-white text-xs outline-none placeholder-white/20 transition-all ${
                      file.ten.trim() === "" && file.url.trim() !== ""
                        ? "border-red-500/50 focus:border-red-500"
                        : "border-white/10 focus:border-[#C69C6D]"
                    }`}
                    placeholder="T√™n hi·ªÉn th·ªã..."
                    value={file.ten}
                    onChange={(e) =>
                      handleFileChange(idx, "ten", e.target.value)
                    }
                  />
                </div>
                {/* Link */}
                <div className="flex-1 relative group">
                  <div className="absolute left-3 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-[#C69C6D] transition-colors">
                    <LinkIcon size={14} />
                  </div>
                  <input
                    className={`
                        w-full bg-white/5 border rounded-lg pl-9 pr-4 py-2.5 text-white text-xs outline-none placeholder-white/20 transition-all
                        ${
                          file.url.trim() === "" && file.ten.trim() !== ""
                            ? "border-red-500/50 focus:border-red-500"
                            : "border-white/10 focus:border-[#C69C6D]"
                        }
                    `}
                    value={file.url}
                    onChange={(e) =>
                      handleFileChange(idx, "url", e.target.value)
                    }
                    placeholder="D√°n link Google Drive..."
                  />
                </div>
                {/* X√≥a */}
                <button
                  type="button"
                  onClick={() => removeFileRow(idx)}
                  className="p-2 text-white/20 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-colors shrink-0 mt-[2px]"
                >
                  <Trash2 size={16} />
                </button>
              </div>
            ))}

            {formData.file_thiet_ke.length === 0 && (
              <div
                onClick={addFileRow}
                className="text-[10px] text-white/20 italic text-center py-3 border border-dashed border-white/10 rounded-lg cursor-pointer hover:border-white/30 transition-colors"
              >
                Ch∆∞a c√≥ file n√†o. Nh·∫•n ƒë·ªÉ th√™m.
              </div>
            )}
          </div>
        </div>
      </div>
    </KhungForm>
  );
}
</file>

<file path="components/cacchucnang/mauthietke/MauThietKeList.tsx">
"use client";

import React from "react";
import { Palette, User, Link as LinkIcon } from "lucide-react";
import { MauThietKe } from "./config";

interface Props {
  items: MauThietKe[];
  bulkMode: boolean;
  selectedIds: Set<string>;
  onToggleSelect: (id: string) => void;
  onClickItem: (item: MauThietKe) => void;
}

export default function MauThietKeList({
  items,
  bulkMode,
  selectedIds,
  onToggleSelect,
  onClickItem,
}: Props) {
  // Helper: ƒê·∫øm s·ªë l∆∞·ª£ng file thi·∫øt k·∫ø
  const getFileCount = (item: MauThietKe) => {
    const files = item.file_thiet_ke;
    if (Array.isArray(files))
      return files.filter((f) => f && f.trim() !== "").length;
    if (typeof files === "string") {
      try {
        const parsed = JSON.parse(files);
        return Array.isArray(parsed)
          ? parsed.filter((f: any) => f && f.trim() !== "").length
          : 0;
      } catch {
        return 0;
      }
    }
    return 0;
  };

  return (
    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-2 p-2 md:p-4">
      {items.map((item) => {
        const fileCount = getFileCount(item);

        return (
          <div
            key={item.id}
            onClick={(e) => {
              if (bulkMode) {
                e.stopPropagation();
                onToggleSelect(item.id);
              } else {
                onClickItem(item);
              }
            }}
            className={`
                group relative bg-[#0f0f0f] border border-white/10 rounded-lg overflow-hidden cursor-pointer 
                hover:border-[#C69C6D]/50 transition-all 
                ${
                  selectedIds.has(item.id)
                    ? "border-[#C69C6D] bg-[#C69C6D]/10"
                    : ""
                }
            `}
          >
            {/* üü¢ HI·ªÇN TH·ªä S·ªê L∆Ø·ª¢NG FILE THI·∫æT K·∫æ (Badge) */}
            {fileCount > 0 && (
              <div className="absolute top-1 left-1 z-10 flex items-center gap-1 bg-black/60 backdrop-blur-sm px-1.5 py-0.5 rounded text-[9px] font-bold text-[#C69C6D] border border-white/10 shadow-sm">
                <LinkIcon size={10} />
                <span>{fileCount}</span>
              </div>
            )}

            {/* Checkbox Bulk Mode */}
            {bulkMode && (
              <div className="absolute top-1 right-1 z-10 w-5 h-5 border-2 rounded flex items-center justify-center transition-colors border-white/30 bg-black/50">
                {selectedIds.has(item.id) && (
                  <span className="text-[#C69C6D] font-bold text-xs">‚úì</span>
                )}
              </div>
            )}

            {/* H√¨nh ·∫£nh */}
            <div className="aspect-square w-full bg-[#1a1a1a] relative group-hover:opacity-90 transition-opacity">
              {item.hinh_anh ? (
                <img
                  src={item.hinh_anh}
                  alt=""
                  className="w-full h-full object-cover"
                  loading="lazy"
                />
              ) : (
                <div className="w-full h-full flex items-center justify-center text-white/10">
                  <Palette size={24} />
                </div>
              )}
            </div>

            {/* N·ªôi dung (ƒê√£ cƒÉn gi·ªØa) */}
            <div className="p-2 text-center">
              <h3 className="font-bold text-white truncate text-xs leading-tight">
                {item.mo_ta}
              </h3>
              <p className="text-[9px] text-[#C69C6D] mt-0.5 truncate uppercase opacity-80">
                {item.phan_loai}
              </p>
              <div className="mt-1 flex items-center justify-center gap-1 text-[9px] text-white/30 truncate">
                <User size={8} />
                <span className="truncate">{item.ten_nguoi_tao || "---"}</span>
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
}
</file>

<file path="components/cacchucnang/nhansu/config.ts">
/**
 * ============================================================
 * CH·ª®C NƒÇNG: NH√ÇN S·ª∞
 * ƒê∆∞·ªùng d·∫´n: phongchuan/cacchucnang/nhansu
 * ============================================================
 * 
 * Ch·ª©c nƒÉng qu·∫£n l√Ω nh√¢n s·ª± d√πng chung cho nhi·ªÅu ph√≤ng.
 * M·ªói ph√≤ng g·ªçi ra v·ªõi quy·ªÅn kh√°c nhau th√¥ng qua props.
 * 
 * QUY·ªÄN H·∫†N:
 * - allowView: Xem danh s√°ch v√† chi ti·∫øt
 * - allowEdit: S·ª≠a th√¥ng tin
 * - allowDelete: X√≥a nh√¢n s·ª±
 * - allowBulk: Thao t√°c h√†ng lo·∫°t
 * 
 * S·ª¨ D·ª§NG:
 * import { NhanSuChucNang } from '@/app/components/cacchucnang/nhansu';
 * <NhanSuChucNang permissions={{ allowDelete: true }} />
 */

import { Phone, Mail, Banknote, Clock, Percent, ShieldCheck } from 'lucide-react';
import { ManagerConfig, FieldConfig, FilterTabConfig, TabConfig } from '../types';
import { 
    getNhanSuDataAction, 
    createNhanSuAction, 
    updateNhanSuAction, 
    deleteNhanSuAction,
    getDistinctValuesAction 
} from '@/app/actions/QuyenHanQuanLy';

// ============================================================
// INTERFACE
// ============================================================

export interface NhanSu {
    id: string;
    ho_ten: string;
    vi_tri: string;
    vi_tri_normalized: string;
    so_dien_thoai: string;
    email: string;
    hinh_anh?: string;
    trang_thai?: string;
    luong_thang?: number;
    luong_theo_gio?: number;
    thuong_doanh_thu?: number;
    ngan_hang?: string;
    so_tai_khoan?: string;
}

export interface NhanSuPermissions {
    allowView?: boolean;
    allowEdit?: boolean;
    allowDelete?: boolean;
    allowBulk?: boolean;
}

// ============================================================
// CONSTANTS
// ============================================================

const VN_BANKS = [
    "Vietcombank", "VietinBank", "BIDV", "Agribank", "Techcombank", "MBBank", 
    "ACB", "VPBank", "TPBank", "Sacombank", "HDBank", "VIB", "MSB", "SHB", 
    "SeABank", "OCB", "Eximbank", "LienVietPostBank", "Nam A Bank", "Viet Capital Bank"
];

// ============================================================
// FIELDS CONFIG
// ============================================================

const fields: FieldConfig[] = [
    {
        key: 'hinh_anh',
        label: '·∫¢nh ƒë·∫°i di·ªán',
        type: 'image',
        showInForm: true,
        showInDetail: false,
        showInCard: true,
    },
    {
        key: 'ho_ten',
        label: 'H·ªç v√† T√™n',
        type: 'text',
        placeholder: 'Nh·∫≠p h·ªç t√™n ƒë·∫ßy ƒë·ªß...',
        required: true,
    },
    {
        key: 'vi_tri',
        label: 'V·ªã tr√≠ / Ch·ª©c v·ª•',
        type: 'select-add',
        placeholder: 'Ch·ªçn ch·ª©c v·ª•...',
        required: true,
        optionsLoader: async () => {
            const res = await getDistinctValuesAction('nhan_su', 'vi_tri');
            return (res.success && res.data) ? res.data as string[] : [];
        },
    },
    {
        key: 'email',
        label: 'Email li√™n h·ªá',
        type: 'email',
        placeholder: 'email@example.com',
        required: true,
        icon: Mail,
        colSpan: 2,
    },
    {
        key: 'so_dien_thoai',
        label: 'S·ªë ƒëi·ªán tho·∫°i',
        type: 'phone',
        placeholder: '09xxxxxxxxx',
        icon: Phone,
    },
    {
        key: 'luong_thang',
        label: 'L∆∞∆°ng c·ª©ng (VNƒê)',
        type: 'money',
        placeholder: '0',
        icon: Banknote,
        highlight: true,
    },
    {
        key: 'luong_theo_gio',
        label: 'L∆∞∆°ng theo gi·ªù',
        type: 'readonly',
        icon: Clock,
        computeFrom: 'luong_thang',
        computeFn: (luongThang: any) => {
            const value = Number(luongThang) || 0;
            if (value <= 0) return '0';
            return Math.round((value / 24 / 8) / 1000) * 1000;
        },
    },
    {
        key: 'thuong_doanh_thu',
        label: 'Th∆∞·ªüng doanh s·ªë (%)',
        type: 'percent',
        placeholder: '0 - 30',
        maxValue: 30,
        icon: Percent,
    },
    {
        key: 'ngan_hang',
        label: 'Ng√¢n h√†ng',
        type: 'select',
        options: VN_BANKS,
        icon: ShieldCheck,
    },
    {
        key: 'so_tai_khoan',
        label: 'S·ªë t√†i kho·∫£n',
        type: 'text',
        placeholder: 'Nh·∫≠p s·ªë t√†i kho·∫£n...',
    },
];

// ============================================================
// FILTER TABS
// ============================================================

const filterTabs: FilterTabConfig[] = [
    { id: 'quanly', label: 'QU·∫¢N L√ù', filterField: 'vi_tri_normalized' },
    { id: 'sales', label: 'SALES', filterField: 'vi_tri_normalized' },
    { id: 'thosanxuat', label: 'TH·ª¢', filterField: 'vi_tri_normalized' },
    { id: 'parttime', label: 'PART-TIME', filterField: 'vi_tri_normalized' },
    { id: 'congtacvien', label: 'CTV', filterField: 'vi_tri_normalized' },
];

// ============================================================
// DETAIL TABS
// ============================================================

const detailTabs: TabConfig[] = [
    { id: 'hoso', label: 'H·ªí S∆†' },
    { id: 'muctieu', label: 'M·ª§C TI√äU', searchable: true, sortable: true, sortOptions: [{ key: 'name', label: 'T√äN' }, { key: 'reward', label: 'TH∆Ø·ªûNG' }], showAddButton: true },
    { id: 'thanhtich', label: 'TH√ÄNH T√çCH', searchable: true },
];

// ============================================================
// DATA SOURCE
// ============================================================

const dataSource = {
    fetchList: async (page: number, limit: number, search: string, filter: string) => {
        const res = await getNhanSuDataAction(page, limit, search, filter);
        return { success: res.success, data: res.data as NhanSu[] | undefined, error: res.error };
    },
    create: async (data: Partial<NhanSu>) => {
        if (data.vi_tri) {
            (data as any).vi_tri_normalized = data.vi_tri.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "").toLowerCase();
        }
        const res = await createNhanSuAction(data as any);
        return { success: res.success, data: (res as any).data as NhanSu, error: res.error };
    },
    update: async (id: string, data: Partial<NhanSu>) => {
        if (data.vi_tri) {
            (data as any).vi_tri_normalized = data.vi_tri.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "").toLowerCase();
        }
        const res = await updateNhanSuAction(id, data as any);
        return { success: res.success, data: (res as any).data as NhanSu, error: res.error };
    },
    delete: async (id: string) => {
        const res = await deleteNhanSuAction(id);
        return { success: res.success, error: res.error };
    },
};

// ============================================================
// CREATE CONFIG FUNCTION
// ============================================================

export function createNhanSuConfig(permissions: NhanSuPermissions = {}): ManagerConfig<NhanSu> {
    const { 
        allowView = true, 
        allowEdit = true, 
        allowDelete = false, 
        allowBulk = false 
    } = permissions;

    return {
        entityName: 'nh√¢n s·ª±',
        entityNamePlural: 'nh√¢n s·ª±',
        idField: 'id',
        fields,
        cardConfig: {
            avatarField: 'hinh_anh',
            titleField: 'ho_ten',
            subtitleField: 'vi_tri',
            infoFields: [{ field: 'so_dien_thoai', icon: Phone }],
        },
        filterTabs,
        detailTabs,
        actions: {
            allowView,
            allowEdit,
            allowDelete,
            allowBulkSelect: allowBulk,
            allowBulkDelete: allowBulk && allowDelete,
        },
        dataSource,
        searchFields: ['ho_ten', 'so_dien_thoai', 'email'],
        sortOptions: [
            { key: 'name', label: 'T√äN', sortFn: (a: NhanSu, b: NhanSu) => a.ho_ten.localeCompare(b.ho_ten) },
            { key: 'vitri', label: 'V·ªä TR√ç', sortFn: (a: NhanSu, b: NhanSu) => (a.vi_tri || '').localeCompare(b.vi_tri || '') },
            { key: 'luong', label: 'L∆Ø∆†NG', sortFn: (a: NhanSu, b: NhanSu) => (b.luong_thang || 0) - (a.luong_thang || 0) },
        ],
        defaultSort: 'name',
        uploadConfig: { bucket: 'avatar', fileNamePrefix: 'ns' },
    };
}
</file>

<file path="components/cacchucnang/nhansu/index.ts">
/**
 * CH·ª®C NƒÇNG: NH√ÇN S·ª∞
 * Export t·∫•t c·∫£ t·ª´ folder n√†y
 */

export { default as NhanSuChucNang } from './NhanSuChucNang';
export { createNhanSuConfig, type NhanSu, type NhanSuPermissions } from './config';
</file>

<file path="components/cacchucnang/nhansu/NhanSuChucNang.tsx">
/**
 * ============================================================
 * COMPONENT: NH√ÇN S·ª∞
 * ============================================================
 *
 * S·ª≠ d·ª•ng KhungGiaoDien ƒë·ªÉ ƒë·ªìng b·ªô giao di·ªán.
 * 3 ch·∫ø ƒë·ªô view: List | Detail | Form (inline, kh√¥ng popup)
 */

"use client";

import React, { useState, useEffect, useMemo, useCallback } from "react";
import { User, Phone, Mail, Banknote, Briefcase, Trash2 } from "lucide-react";
import {
  KhungDanhSach,
  KhungChiTiet,
  KhungForm,
} from "@/app/components/cacchucnang/KhungGiaoDienChucNang";
import ConfirmDialog from "@/app/components/ConfirmDialog";
import { NhanSu, NhanSuPermissions, createNhanSuConfig } from "./config";

// ============================================================
// PROPS
// ============================================================

interface Props {
  permissions?: NhanSuPermissions;
  className?: string;
}

// ============================================================
// HELPER: Format ti·ªÅn VNƒê
// ============================================================

const formatMoney = (value: number | undefined) => {
  if (!value) return "0 ‚Ç´";
  return new Intl.NumberFormat("vi-VN", {
    style: "currency",
    currency: "VND",
  }).format(value);
};

const toNonAccent = (str: string) =>
  str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "")
    .toLowerCase();

// ============================================================
// COMPONENT
// ============================================================

export default function NhanSuChucNang({
  permissions = {},
  className = "",
}: Props) {
  console.log("üî¥ NhanSuChucNang MOUNTED - new version with KhungDanhSach");
  const config = createNhanSuConfig(permissions);
  const {
    allowView = true,
    allowEdit = true,
    allowDelete = false,
    allowBulk = false,
  } = permissions;

  // ========== STATE ==========
  const [items, setItems] = useState<NhanSu[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [activeTab, setActiveTab] = useState("all");
  const [sortBy, setSortBy] = useState("name");

  // VIEW STATE: 'list' | 'detail' | 'form'
  const [viewMode, setViewMode] = useState<"list" | "detail" | "form">("list");
  const [selectedItem, setSelectedItem] = useState<NhanSu | null>(null);
  const [detailTab, setDetailTab] = useState("hoso");

  const [bulkMode, setBulkMode] = useState(false);
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [confirmDelete, setConfirmDelete] = useState<{
    show: boolean;
    ids: string[];
  }>({ show: false, ids: [] });

  const [formData, setFormData] = useState<Partial<NhanSu>>({});
  const [saving, setSaving] = useState(false);

  // ========== FETCH DATA ==========
  const fetchData = useCallback(async () => {
    setLoading(true);
    try {
      // üõ†Ô∏è FIX: Ki·ªÉm tra k·ªπ dataSource.fetchList c√≥ t·ªìn t·∫°i kh√¥ng
      if (config.dataSource?.fetchList) {
        const res = await config.dataSource.fetchList(1, 50, "", "");
        if (res.success && res.data) setItems(res.data);
      }
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  }, [config.dataSource]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  // ========== TABS v·ªõi COUNT ==========
  const tabs = useMemo(() => {
    const counts: Record<string, number> = { all: items.length };
    config.filterTabs?.forEach((tab) => {
      // Ki·ªÉm tra an to√†n tr∆∞·ªõc khi truy c·∫≠p
      if (tab.id && tab.filterField) {
        counts[tab.id] = items.filter(
          (i) => (i as any)[tab.filterField!] === tab.id
        ).length;
      }
    });

    const dynamicTabs =
      config.filterTabs?.map((t) => ({
        id: t.id || "", // Fallback ID r·ªóng
        label: t.label,
        count: t.id ? counts[t.id] || 0 : 0,
      })) || [];

    return [{ id: "all", label: "T·∫§T C·∫¢", count: counts.all }, ...dynamicTabs];
  }, [items, config.filterTabs]);

  // ========== FILTERED & SORTED ==========
  const filteredList = useMemo(() => {
    let result = items;

    // Filter by tab
    if (activeTab !== "all") {
      result = result.filter((i) => i.vi_tri_normalized === activeTab);
    }

    // Search
    if (searchTerm) {
      const term = toNonAccent(searchTerm);
      result = result.filter((i) => {
        const hoTen = toNonAccent(i.ho_ten || "");
        const match =
          hoTen.includes(term) ||
          (i.so_dien_thoai || "").includes(term) ||
          toNonAccent(i.email || "").includes(term);
        return match;
      });
    }

    // Sort
    const sortOpt = config.sortOptions?.find((s) => s.key === sortBy);
    if (sortOpt?.sortFn) {
      result = [...result].sort(sortOpt.sortFn);
    }

    return result;
  }, [items, activeTab, searchTerm, sortBy, config.sortOptions]);

  // ========== HANDLERS ==========
  const handleOpenDetail = (item: NhanSu) => {
    setSelectedItem(item);
    setDetailTab("hoso");
    setViewMode("detail");
  };

  const handleOpenForm = (item?: NhanSu) => {
    setFormData(item ? { ...item } : {});
    setSelectedItem(item || null);
    setViewMode("form");
  };

  const handleBackToList = () => {
    setViewMode("list");
    setSelectedItem(null);
  };

  const handleSave = async () => {
    setSaving(true);
    try {
      // üõ†Ô∏è FIX: Ki·ªÉm tra create/update c√≥ t·ªìn t·∫°i kh√¥ng
      if (selectedItem?.id) {
        if (config.dataSource?.update) {
          await config.dataSource.update(selectedItem.id, formData);
        }
      } else {
        if (config.dataSource?.create) {
          await config.dataSource.create(formData);
        }
      }
      await fetchData();
      handleBackToList();
    } catch (e) {
      console.error(e);
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (ids: string[]) => {
    // üõ†Ô∏è FIX: Ki·ªÉm tra delete c√≥ t·ªìn t·∫°i kh√¥ng
    if (config.dataSource?.delete) {
      for (const id of ids) {
        await config.dataSource.delete(id);
      }
      await fetchData();
      setSelectedIds(new Set());
      setConfirmDelete({ show: false, ids: [] });
      handleBackToList();
    }
  };

  const toggleSelect = (id: string) => {
    const newSet = new Set(selectedIds);
    if (newSet.has(id)) newSet.delete(id);
    else newSet.add(id);
    setSelectedIds(newSet);
  };

  // ========== DETAIL TABS COUNT ==========
  const detailTabCounts = useMemo(
    () => ({
      hoso: 3,
      luong: 3,
      nganhang: 2,
    }),
    []
  );

  // ========== RENDER ==========
  return (
    <div className={`h-full ${className}`}>
      {/* ====== CH·∫æ ƒê·ªò DANH S√ÅCH ====== */}
      {viewMode === "list" && (
        <KhungDanhSach
          tabs={tabs}
          activeTab={activeTab}
          onTabChange={setActiveTab}
          onSearch={setSearchTerm} // üõ†Ô∏è FIX: ƒê√£ x√≥a searchPlaceholder g√¢y l·ªói
          sortOptions={
            config.sortOptions?.map((s) => ({ key: s.key, label: s.label })) ||
            []
          }
          activeSort={sortBy}
          onSortChange={setSortBy}
          showAddButton={allowEdit}
          onAdd={() => handleOpenForm()}
          bulkMode={bulkMode}
          onBulkModeToggle={
            allowBulk ? () => setBulkMode(!bulkMode) : undefined
          }
          selectedCount={selectedIds.size}
          onSelectAll={() =>
            setSelectedIds(new Set(filteredList.map((i) => i.id)))
          }
          onClearSelection={() => setSelectedIds(new Set())}
          bulkActions={
            allowDelete
              ? [
                  {
                    id: "delete",
                    label: "X√ìA",
                    icon: Trash2,
                    color: "danger",
                    onClick: () =>
                      setConfirmDelete({
                        show: true,
                        ids: Array.from(selectedIds),
                      }),
                  },
                ]
              : []
          }
          loading={loading}
        >
          {/* Cards */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 p-4">
            {filteredList.map((item) => (
              <div
                key={item.id}
                onClick={() => !bulkMode && handleOpenDetail(item)}
                className={`group relative bg-[#0f0f0f] border rounded-xl overflow-hidden cursor-pointer transition-all hover:border-[#C69C6D]/50 hover:shadow-lg ${
                  selectedIds.has(item.id)
                    ? "border-[#C69C6D] bg-[#C69C6D]/5"
                    : "border-white/10"
                }`}
              >
                {/* Bulk checkbox */}
                {bulkMode && (
                  <div
                    onClick={(e) => {
                      e.stopPropagation();
                      toggleSelect(item.id);
                    }}
                    className="absolute top-3 right-3 z-10"
                  >
                    <div
                      className={`w-5 h-5 rounded border-2 flex items-center justify-center transition-colors ${
                        selectedIds.has(item.id)
                          ? "bg-[#C69C6D] border-[#C69C6D]"
                          : "border-white/30 bg-black/50"
                      }`}
                    >
                      {selectedIds.has(item.id) && (
                        <span className="text-black text-xs">‚úì</span>
                      )}
                    </div>
                  </div>
                )}

                <div className="p-4 flex items-center gap-4">
                  {/* Avatar */}
                  <div className="w-14 h-14 rounded-full bg-[#1a1a1a] border-2 border-[#C69C6D]/30 overflow-hidden shrink-0">
                    {item.hinh_anh ? (
                      <img
                        src={item.hinh_anh}
                        alt=""
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center text-[#C69C6D]/50">
                        <User size={24} />
                      </div>
                    )}
                  </div>

                  {/* Info */}
                  <div className="flex-1 min-w-0">
                    <h3 className="font-bold text-white truncate">
                      {item.ho_ten}
                    </h3>
                    <p className="text-xs text-[#C69C6D] truncate">
                      {item.vi_tri}
                    </p>
                    <p className="text-xs text-white/40 truncate mt-1">
                      <Phone size={10} className="inline mr-1" />
                      {item.so_dien_thoai || "---"}
                    </p>
                  </div>
                </div>
              </div>
            ))}

            {filteredList.length === 0 && !loading && (
              <div className="col-span-full py-20 text-center text-white/30">
                Kh√¥ng c√≥ d·ªØ li·ªáu
              </div>
            )}
          </div>
        </KhungDanhSach>
      )}

      {/* ====== CH·∫æ ƒê·ªò CHI TI·∫æT ====== */}
      {viewMode === "detail" && selectedItem && (
        <KhungChiTiet
          data={selectedItem}
          onClose={handleBackToList}
          avatar={selectedItem.hinh_anh}
          avatarFallback={<User size={10} className="text-[#C69C6D]/50" />}
          title={selectedItem.ho_ten}
          tabs={[
            { id: "hoso", label: "H·ªí S∆†" },
            { id: "luong", label: "L∆Ø∆†NG" },
            { id: "nganhang", label: "NG√ÇN H√ÄNG" },
          ]}
          activeTab={detailTab}
          onTabChange={setDetailTab}
          tabCounts={detailTabCounts}
          showEditButton={allowEdit}
          showDeleteButton={allowDelete}
          onEdit={() => handleOpenForm(selectedItem)}
          onDelete={() =>
            setConfirmDelete({ show: true, ids: [selectedItem.id] })
          }
        >
          <div className="p-4">
            {detailTab === "hoso" && (
              <div className="space-y-3">
                <InfoRow icon={Mail} label="EMAIL" value={selectedItem.email} />
                <InfoRow
                  icon={Phone}
                  label="S·ªê ƒêI·ªÜN THO·∫†I"
                  value={selectedItem.so_dien_thoai}
                />
                <InfoRow
                  icon={Briefcase}
                  label="V·ªä TR√ç"
                  value={selectedItem.vi_tri}
                />
              </div>
            )}
            {detailTab === "luong" && (
              <div className="space-y-3">
                <InfoRow
                  icon={Banknote}
                  label="L∆Ø∆†NG TH√ÅNG"
                  value={formatMoney(selectedItem.luong_thang)}
                  highlight
                />
                <InfoRow
                  icon={Banknote}
                  label="L∆Ø∆†NG THEO GI·ªú"
                  value={formatMoney(selectedItem.luong_theo_gio)}
                />
                <InfoRow
                  icon={Banknote}
                  label="TH∆Ø·ªûNG DOANH S·ªê"
                  value={`${selectedItem.thuong_doanh_thu || 0}%`}
                />
              </div>
            )}
            {detailTab === "nganhang" && (
              <div className="space-y-3">
                <InfoRow
                  icon={Banknote}
                  label="NG√ÇN H√ÄNG"
                  value={selectedItem.ngan_hang}
                />
                <InfoRow
                  icon={Banknote}
                  label="S·ªê T√ÄI KHO·∫¢N"
                  value={selectedItem.so_tai_khoan}
                />
              </div>
            )}
          </div>
        </KhungChiTiet>
      )}

      {/* ====== CH·∫æ ƒê·ªò FORM ====== */}
      {viewMode === "form" && (
        <KhungForm
          isEditing={!!selectedItem}
          data={formData}
          onClose={handleBackToList}
          title={selectedItem ? selectedItem.ho_ten : "TH√äM NH√ÇN S·ª∞"}
          avatar={selectedItem?.hinh_anh}
          avatarFallback={<User size={10} className="text-[#C69C6D]/50" />}
          showAvatarUpload={true}
          onSubmit={handleSave}
          loading={saving}
          isDirty={Object.keys(formData).length > 0}
        >
          <div className="space-y-4">
            <FormField label="H·ªç v√† T√™n" required>
              <input
                type="text"
                value={formData.ho_ten || ""}
                onChange={(e) =>
                  setFormData({ ...formData, ho_ten: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                placeholder="Nh·∫≠p h·ªç t√™n..."
              />
            </FormField>

            <FormField label="V·ªã tr√≠" required>
              <input
                type="text"
                value={formData.vi_tri || ""}
                onChange={(e) =>
                  setFormData({ ...formData, vi_tri: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                placeholder="Nh·∫≠p v·ªã tr√≠..."
              />
            </FormField>

            <div className="grid grid-cols-2 gap-4">
              <FormField label="Email">
                <input
                  type="email"
                  value={formData.email || ""}
                  onChange={(e) =>
                    setFormData({ ...formData, email: e.target.value })
                  }
                  className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                  placeholder="email@..."
                />
              </FormField>
              <FormField label="S·ªë ƒëi·ªán tho·∫°i">
                <input
                  type="tel"
                  value={formData.so_dien_thoai || ""}
                  onChange={(e) =>
                    setFormData({ ...formData, so_dien_thoai: e.target.value })
                  }
                  className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                  placeholder="09..."
                />
              </FormField>
            </div>

            <FormField label="L∆∞∆°ng th√°ng (VNƒê)">
              <input
                type="number"
                value={formData.luong_thang || ""}
                onChange={(e) =>
                  setFormData({
                    ...formData,
                    luong_thang: Number(e.target.value),
                  })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                placeholder="0"
              />
            </FormField>
          </div>
        </KhungForm>
      )}

      {/* ====== CONFIRM DELETE ====== */}
      <ConfirmDialog
        isOpen={confirmDelete.show}
        title="X√ÅC NH·∫¨N X√ìA"
        message={`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${confirmDelete.ids.length} nh√¢n s·ª±?`}
        onConfirm={() => handleDelete(confirmDelete.ids)}
        onCancel={() => setConfirmDelete({ show: false, ids: [] })}
      />
    </div>
  );
}

// ============================================================
// SUB-COMPONENTS
// ============================================================

function InfoRow({
  icon: Icon,
  label,
  value,
  highlight,
}: {
  icon: any;
  label: string;
  value?: string;
  highlight?: boolean;
}) {
  return (
    <div className="flex items-center gap-3 p-3 rounded-xl bg-[#151515] border border-white/5">
      <div
        className={`p-2 rounded-lg ${
          highlight
            ? "bg-[#C69C6D]/20 text-[#C69C6D]"
            : "bg-black text-[#C69C6D]"
        }`}
      >
        <Icon size={16} />
      </div>
      <div className="flex-1 min-w-0">
        <p className="text-[9px] font-black uppercase tracking-wider text-white/40 mb-0.5">
          {label}
        </p>
        <p
          className={`text-sm font-bold truncate ${
            highlight ? "text-[#C69C6D]" : "text-gray-200"
          }`}
        >
          {value || "---"}
        </p>
      </div>
    </div>
  );
}

function FormField({
  label,
  required,
  children,
}: {
  label: string;
  required?: boolean;
  children: React.ReactNode;
}) {
  return (
    <div>
      <label className="block text-xs font-bold text-white/60 uppercase tracking-wider mb-2">
        {label} {required && <span className="text-red-400">*</span>}
      </label>
      {children}
    </div>
  );
}
</file>

<file path="components/cacchucnang/types.ts">
/**
 * Types d√πng chung cho c√°c config ch·ª©c nƒÉng
 * ƒê·ªãnh nghƒ©a c·∫•u tr√∫c data cho danh s√°ch, chi ti·∫øt, form
 */

import { LucideIcon } from 'lucide-react';
import { ReactNode } from 'react';

// C·∫•u h√¨nh 1 field hi·ªÉn th·ªã
export interface FieldConfig {
    key: string;
    label: string;
    icon?: LucideIcon;
    render?: (value: any, item: any) => ReactNode;
    editable?: boolean;
    type?: 'text' | 'number' | 'email' | 'tel' | 'select' | 'textarea' | 'date' | 'image' | 'select-add' | 'phone' | 'money' | 'readonly' | 'percent';
    options?: string[] | { value: string; label: string }[];
    optionsLoader?: () => Promise<string[]>;
    required?: boolean;
    placeholder?: string;
    colSpan?: number;
    showInForm?: boolean;
    showInDetail?: boolean;
    showInCard?: boolean;
    highlight?: boolean;
    computeFrom?: string;
    computeFn?: (value: any) => any;
    maxValue?: number;
}

// C·∫•u h√¨nh 1 tab l·ªçc (trong danh s√°ch)
export interface FilterTabConfig {
    id?: string;
    key?: string;
    label: string;
    filter?: (item: any) => boolean;
    filterField?: string;
    color?: string;
}

// C·∫•u h√¨nh 1 tab chi ti·∫øt
export interface TabConfig {
    id?: string;
    key?: string;
    label: string;
    icon?: LucideIcon;
    content?: ReactNode | ((item: any) => ReactNode);
    searchable?: boolean;
    sortable?: boolean;
    sortOptions?: { key: string; label: string }[];
    showAddButton?: boolean;
}

// C·∫•u h√¨nh sort options
export interface SortOption<T = any> {
    key: string;
    label: string;
    sortFn: (a: T, b: T) => number;
}

// C·∫•u h√¨nh ch√≠nh cho Manager
export interface ManagerConfig<T = any> {
    // Entity info
    entityName: string;
    entityNamePlural: string;
    
    // Table/query
    tableName?: string;
    idField?: string;
    
    // Card display
    getCardTitle?: (item: T) => string;
    getCardSubtitle?: (item: T) => string;
    getCardAvatar?: (item: T) => string | null;
    getCardBadge?: (item: T) => { text: string; color: string } | null;
    
    // Card config
    cardConfig?: {
        titleField?: string;
        subtitleField?: string;
        avatarField?: string;
        badgeField?: string;
        getBadgeColor?: (value: string) => string;
        infoFields?: { field: string; icon?: LucideIcon }[];
    };
    
    // Fields config
    fields: FieldConfig[];
    
    // Tabs config  
    filterTabs: FilterTabConfig[];
    detailTabs: TabConfig[];
    
    // List config
    listConfig?: {
        searchKeys: string[];
        sortOptions: SortOption<T>[];
        defaultSort: string;
    };
    
    // Search fields (for quick search)
    searchFields?: string[];
    
    // Sort options (top level alternative to listConfig.sortOptions)
    sortOptions?: SortOption<T>[];
    
    // Default sort (top level alternative)
    defaultSort?: string;
    
    // Upload config for images
    uploadConfig?: {
        bucket: string;
        fileNamePrefix?: string;
    };
    
    // Permissions
    permissions?: {
        canCreate?: boolean;
        canEdit?: boolean;
        canDelete?: boolean;
        canBulkDelete?: boolean;
    };
    
    // Actions
    actions?: {
        allowView?: boolean;
        allowEdit?: boolean;
        allowDelete?: boolean;
        allowBulkSelect?: boolean;
        allowBulkDelete?: boolean;
        onCardClick?: (item: T) => void;
        onEdit?: (item: T) => void;
        onDelete?: (item: T) => void;
        onBulkDelete?: (items: T[]) => void;
        onCreate?: () => void;
    };
    
    // Data source (flexible ƒë·ªÉ ph√π h·ª£p v·ªõi nhi·ªÅu c√°ch implement)
    dataSource?: {
        fetchList?: (page: number, limit: number, search: string, filter: string) => Promise<{ success: boolean; data: T[] | undefined; error: any }>;
        fetch?: () => Promise<T[]>;
        create?: (item: Partial<T>) => Promise<{ success: boolean; data: T; error: any }>;
        update?: (id: string, item: Partial<T>) => Promise<{ success: boolean; data: T; error: any }>;
        delete?: (id: string) => Promise<{ success: boolean; error: any }>;
    };
}
</file>

<file path="components/cacchucnang/viecmau/config.ts">
import { Palette, Image as ImageIcon, Tag, User } from "lucide-react";
import {
  ManagerConfig,
  FieldConfig,
  FilterTabConfig,
  TabConfig,
} from "../types";
import {
  getMauThietKeDataAction,
  createMauThietKeAction,
  updateMauThietKeAction,
  deleteMauThietKeAction,
} from "@/app/actions/QuyenHanThietKe";

// 1. C·∫¨P NH·∫¨T INTERFACE (Th√™m file_thiet_ke)
export interface MauThietKe {
  id: string;
  mo_ta: string;
  phan_loai: string;
  phan_loai_normalized: string;
  hinh_anh: string;
  // Th√™m tr∆∞·ªùng n√†y ƒë·ªÉ l∆∞u danh s√°ch link
  file_thiet_ke?: string[];
  nguoi_tao: string;
  ten_nguoi_tao?: string;
  tao_luc: string;
}

export interface MauThietKePermissions {
  allowView?: boolean;
  allowEdit?: boolean;
  allowDelete?: boolean;
  allowBulk?: boolean;
}

// C√°c lo·∫°i ph√¢n lo·∫°i chu·∫©n h√≥a
const PHAN_LOAI_OPTIONS = [
  "Tranh ch√¢n dung g·∫°o In UV + V·∫Ω m·∫∑t",
  "Tranh phong c·∫£nh G·∫°o - T·∫•m - C√°m",
  "ƒêƒ©a Tranh G·∫°o",
  "Tranh g·∫°o In UV",
  "Tranh In ƒê·ªÉ B√†n",
  "N√≥n l√° g·∫°o",
  "Tranh g·∫°o in UV c√≥ ƒë·ªìng h·ªì",
  "Tranh ch√¢n dung th·ªß c√¥ng 100%",
];

const fields: FieldConfig[] = [
  {
    key: "hinh_anh",
    label: "H√¨nh ·∫£nh m·∫´u",
    type: "image",
    showInForm: true,
    showInDetail: false,
    showInCard: true,
  },
  {
    key: "mo_ta",
    label: "M√¥ t·∫£ / T√™n m·∫´u",
    type: "text",
    placeholder: "Nh·∫≠p t√™n m·∫´u thi·∫øt k·∫ø...",
    required: true,
    icon: Palette,
  },
  {
    key: "phan_loai",
    label: "Ph√¢n lo·∫°i",
    type: "select",
    options: PHAN_LOAI_OPTIONS,
    required: true,
    icon: Tag,
  },
  {
    key: "ten_nguoi_tao",
    label: "Ng∆∞·ªùi thi·∫øt k·∫ø",
    type: "readonly",
    icon: User,
    showInForm: false,
  },
];

// 2. C·∫¨P NH·∫¨T B·ªò L·ªåC (Th√™m tab l·ªçc File Thi·∫øt K·∫ø)
const filterTabs: FilterTabConfig[] = [
  // Tab m·ªõi: L·ªçc nh·ªØng m·∫´u ƒë√£ c√≥ file
  {
    id: "has_file",
    label: "ƒê√É C√ì FILE",
    filterField: "file_thiet_ke", // Tr∆∞·ªùng n√†y s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω logic ri√™ng ·ªü Controller
  },
  {
    id: "tranhchandunggaoinuv+vemat",
    label: "CH√ÇN DUNG UV",
    filterField: "phan_loai_normalized",
  },
  {
    id: "tranhphongcanhgao-tam-cam",
    label: "PHONG C·∫¢NH",
    filterField: "phan_loai_normalized",
  },
  { id: "tranhgaoinuv", label: "IN UV", filterField: "phan_loai_normalized" },
  {
    id: "diatranhgao",
    label: "ƒêƒ®A TRANH",
    filterField: "phan_loai_normalized",
  },
  { id: "tranhindeban", label: "ƒê·ªÇ B√ÄN", filterField: "phan_loai_normalized" },
];

const detailTabs: TabConfig[] = [{ id: "thongtin", label: "CHI TI·∫æT" }];

const dataSource = {
  fetchList: async (
    page: number,
    limit: number,
    search: string,
    filter: string
  ) => {
    const res = await getMauThietKeDataAction(page, limit, search, filter);
    return {
      success: res.success,
      data: res.data as MauThietKe[] | undefined,
      error: res.error,
    };
  },
  create: async (data: Partial<MauThietKe>) => {
    const res = await createMauThietKeAction(data);
    return { success: res.success, data: (res as any)?.data, error: res.error };
  },
  update: async (id: string, data: Partial<MauThietKe>) => {
    const res = await updateMauThietKeAction(id, data);
    return { success: res.success, data: (res as any)?.data, error: res.error };
  },
  delete: async (id: string) => {
    const res = await deleteMauThietKeAction(id);
    return { success: res.success, error: res.error };
  },
};

export function createMauThietKeConfig(
  permissions: MauThietKePermissions = {}
): ManagerConfig<MauThietKe> {
  const {
    allowView = true,
    allowEdit = true,
    allowDelete = false,
    allowBulk = false,
  } = permissions;

  return {
    entityName: "m·∫´u thi·∫øt k·∫ø",
    entityNamePlural: "m·∫´u thi·∫øt k·∫ø",
    idField: "id",
    fields,
    cardConfig: {
      avatarField: "hinh_anh",
      titleField: "mo_ta",
      subtitleField: "phan_loai",
      infoFields: [{ field: "ten_nguoi_tao", icon: User }],
    },
    filterTabs,
    detailTabs,
    actions: {
      allowView,
      allowEdit,
      allowDelete,
      allowBulkSelect: allowBulk,
      allowBulkDelete: allowBulk && allowDelete,
    },
    dataSource,
    searchFields: ["mo_ta"],
    sortOptions: [
      {
        key: "newest",
        label: "M·ªöI NH·∫§T",
        sortFn: (a: MauThietKe, b: MauThietKe) =>
          new Date(b.tao_luc).getTime() - new Date(a.tao_luc).getTime(),
      },
      {
        key: "name",
        label: "T√äN A-Z",
        sortFn: (a: MauThietKe, b: MauThietKe) =>
          a.mo_ta.localeCompare(b.mo_ta),
      },
    ],
    defaultSort: "newest",
    uploadConfig: { bucket: "images", fileNamePrefix: "mau" }, // ƒê√£ chu·∫©n h√≥a v·ªÅ 'images'
  };
}
</file>

<file path="components/cacchucnang/viecmau/index.ts">
export { default as MauThietKeChucNang } from "./MauThietKeChucNang";
export { createMauThietKeConfig } from "./config";
export type { MauThietKe, MauThietKePermissions } from "./config";
</file>

<file path="components/cacchucnang/viecmau/MauThietKeChucNang.tsx">
"use client";

import React, { useState, useEffect, useMemo, useCallback } from "react";
import { Trash2 } from "lucide-react";
import { KhungDanhSach } from "@/app/components/cacchucnang/KhungGiaoDienChucNang";
import ConfirmDialog from "@/app/components/ConfirmDialog";
import {
  MauThietKe,
  MauThietKePermissions,
  createMauThietKeConfig,
} from "./config";

// IMPORT 3 TH√ÄNH PH·∫¶N ƒê√É T√ÅCH
import MauThietKeList from "./MauThietKeList";
import MauThietKeForm from "./MauThietKeForm";
import MauThietKeDetail from "./MauThietKeDetail";

interface Props {
  permissions?: MauThietKePermissions;
  className?: string;
}

const toNonAccent = (str: string) =>
  str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "")
    .toLowerCase();

export default function MauThietKeChucNang({
  permissions = {},
  className = "",
}: Props) {
  const config = createMauThietKeConfig(permissions);
  const {
    allowEdit = true,
    allowDelete = false,
    allowBulk = false,
  } = permissions;

  // --- STATE QU·∫¢N L√ù ---
  const [items, setItems] = useState<MauThietKe[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [activeTab, setActiveTab] = useState("all");
  const [sortBy, setSortBy] = useState("newest");

  // View State
  const [viewMode, setViewMode] = useState<"list" | "detail" | "form">("list");
  const [selectedItem, setSelectedItem] = useState<MauThietKe | null>(null);

  // Action State
  const [bulkMode, setBulkMode] = useState(false);
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [confirmDelete, setConfirmDelete] = useState<{
    show: boolean;
    ids: string[];
  }>({ show: false, ids: [] });
  const [saving, setSaving] = useState(false);

  // --- FETCH DATA ---
  const fetchData = useCallback(async () => {
    setLoading(true);
    try {
      if (config.dataSource?.fetchList) {
        const res = await config.dataSource.fetchList(1, 100, "", "");
        if (res.success && res.data) setItems(res.data);
      }
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  }, [config.dataSource]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  // --- FILTER & SORT LOGIC ---
  const filteredList = useMemo(() => {
    let result = items;

    // 1. LOGIC L·ªåC M·ªöI (X·ª≠ l√Ω tab 'ƒê√É C√ì FILE')
    if (activeTab === "has_file") {
      result = result.filter((i) => {
        // Ki·ªÉm tra xem c√≥ file thi·∫øt k·∫ø kh√¥ng (Array ho·∫∑c JSON string)
        const files = i.file_thiet_ke;
        if (Array.isArray(files) && files.length > 0) return true;
        if (typeof files === "string") {
          try {
            const parsed = JSON.parse(files);
            return Array.isArray(parsed) && parsed.length > 0;
          } catch {
            return false;
          }
        }
        return false;
      });
    }
    // L·ªçc theo ph√¢n lo·∫°i th√¥ng th∆∞·ªùng
    else if (activeTab !== "all") {
      result = result.filter((i) => i.phan_loai_normalized === activeTab);
    }

    // T√¨m ki·∫øm
    if (searchTerm) {
      const term = toNonAccent(searchTerm);
      result = result.filter((i) => toNonAccent(i.mo_ta).includes(term));
    }

    // S·∫Øp x·∫øp
    const sortOpt = config.sortOptions?.find((s) => s.key === sortBy);
    if (sortOpt?.sortFn) {
      result = [...result].sort(sortOpt.sortFn);
    }
    return result;
  }, [items, activeTab, searchTerm, sortBy, config.sortOptions]);

  const tabs = useMemo(() => {
    const counts: Record<string, number> = { all: items.length };

    config.filterTabs?.forEach((tab) => {
      // 2. LOGIC ƒê·∫æM S·ªê L∆Ø·ª¢NG M·ªöI CHO TAB 'HAS_FILE'
      if (tab.id === "has_file") {
        counts[tab.id] = items.filter((i) => {
          const files = i.file_thiet_ke;
          if (Array.isArray(files) && files.length > 0) return true;
          if (typeof files === "string") {
            try {
              const parsed = JSON.parse(files);
              return Array.isArray(parsed) && parsed.length > 0;
            } catch {
              return false;
            }
          }
          return false;
        }).length;
      }
      // ƒê·∫øm cho c√°c tab ph√¢n lo·∫°i b√¨nh th∆∞·ªùng
      else if (tab.id && tab.filterField) {
        counts[tab.id] = items.filter(
          (i) => (i as any)[tab.filterField!] === tab.id
        ).length;
      }
    });

    const dynamicTabs =
      config.filterTabs?.map((t) => ({
        id: t.id || "",
        label: t.label,
        count: t.id ? counts[t.id] || 0 : 0,
      })) || [];
    return [{ id: "all", label: "T·∫§T C·∫¢", count: counts.all }, ...dynamicTabs];
  }, [items, config.filterTabs]);

  // --- ACTION HANDLERS ---
  const handleOpenDetail = (item: MauThietKe) => {
    setSelectedItem(item);
    setViewMode("detail");
  };

  const handleOpenForm = (item?: MauThietKe) => {
    setSelectedItem(item || null);
    setViewMode("form");
  };

  // --- [UPDATED] LOGIC CHECK K·∫æT QU·∫¢ TR·∫¢ V·ªÄ T·ª™ BACKEND ---
  const handleSave = async (formData: any) => {
    setSaving(true);
    try {
      let res; // Bi·∫øn h·ª©ng k·∫øt qu·∫£

      if (selectedItem?.id) {
        if (config.dataSource?.update) {
          res = await config.dataSource.update(selectedItem.id, formData);
        }
      } else {
        if (config.dataSource?.create) {
          res = await config.dataSource.create(formData);
        }
      }

      // KI·ªÇM TRA: N·∫øu Backend tr·∫£ v·ªÅ success: false (do kh√¥ng c√≥ quy·ªÅn s·ª≠a, l·ªói logic...)
      if (res && !res.success) {
        // Hi·ªán th√¥ng b√°o l·ªói v√† KH√îNG ƒë√≥ng form
        alert(
          res.error || "Thao t√°c th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra l·∫°i quy·ªÅn h·∫°n!"
        );
        return; // D·ª´ng h√†m t·∫°i ƒë√¢y
      }

      // N·∫øu th√†nh c√¥ng -> T·∫£i l·∫°i d·ªØ li·ªáu v√† ƒë√≥ng form
      await fetchData();
      setViewMode("list");
      setSelectedItem(null);
    } catch (e) {
      console.error(e);
      alert("ƒê√£ c√≥ l·ªói h·ªá th·ªëng x·∫£y ra!");
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (ids: string[]) => {
    if (config.dataSource?.delete) {
      // Logic x√≥a c≈©ng n√™n c√≥ try/catch t∆∞∆°ng t·ª± nh∆∞ng t·∫°m th·ªùi gi·ªØ nguy√™n theo code g·ªëc
      // ƒë·ªÉ tr√°nh ·∫£nh h∆∞·ªüng logic delete h√†ng lo·∫°t
      for (const id of ids) await config.dataSource.delete(id);
      await fetchData();
      setSelectedIds(new Set());
      setConfirmDelete({ show: false, ids: [] });
      setViewMode("list");
    }
  };

  const handleBulkSelect = (id: string) => {
    const newSet = new Set(selectedIds);
    if (newSet.has(id)) newSet.delete(id);
    else newSet.add(id);
    setSelectedIds(newSet);
  };

  // --- RENDER ---
  return (
    <div className={`h-full ${className}`}>
      {/* 1. LIST VIEW */}
      {viewMode === "list" && (
        <KhungDanhSach
          tabs={tabs}
          activeTab={activeTab}
          onTabChange={setActiveTab}
          onSearch={setSearchTerm}
          sortOptions={
            config.sortOptions?.map((s) => ({ key: s.key, label: s.label })) ||
            []
          }
          activeSort={sortBy}
          onSortChange={setSortBy}
          showAddButton={allowEdit}
          onAdd={() => handleOpenForm()}
          bulkMode={bulkMode}
          onBulkModeToggle={
            allowBulk ? () => setBulkMode(!bulkMode) : undefined
          }
          selectedCount={selectedIds.size}
          onSelectAll={() =>
            setSelectedIds(new Set(filteredList.map((i) => i.id)))
          }
          onClearSelection={() => setSelectedIds(new Set())}
          bulkActions={
            allowDelete
              ? [
                  {
                    id: "delete",
                    label: "X√ìA",
                    icon: Trash2,
                    color: "danger",
                    onClick: () =>
                      setConfirmDelete({
                        show: true,
                        ids: Array.from(selectedIds),
                      }),
                  },
                ]
              : []
          }
          loading={loading}
        >
          <MauThietKeList
            items={filteredList}
            bulkMode={bulkMode}
            selectedIds={selectedIds}
            onToggleSelect={handleBulkSelect}
            onClickItem={handleOpenDetail}
          />
        </KhungDanhSach>
      )}

      {/* 2. FORM VIEW */}
      {viewMode === "form" && (
        <MauThietKeForm
          data={selectedItem}
          onClose={() => {
            setViewMode("list");
            setSelectedItem(null);
          }}
          onSubmit={handleSave}
          loading={saving}
        />
      )}

      {/* 3. DETAIL VIEW */}
      {viewMode === "detail" && selectedItem && (
        <MauThietKeDetail
          data={selectedItem}
          onClose={() => {
            setViewMode("list");
            setSelectedItem(null);
          }}
          allowEdit={allowEdit}
          allowDelete={allowDelete}
          onEdit={() => handleOpenForm(selectedItem)}
          onDelete={() =>
            setConfirmDelete({ show: true, ids: [selectedItem.id] })
          }
        />
      )}

      <ConfirmDialog
        isOpen={confirmDelete.show}
        title="X√ÅC NH·∫¨N X√ìA"
        message={`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${confirmDelete.ids.length} m·∫´u thi·∫øt k·∫ø?`}
        onConfirm={() => handleDelete(confirmDelete.ids)}
        onCancel={() => setConfirmDelete({ show: false, ids: [] })}
      />
    </div>
  );
}
</file>

<file path="components/cacchucnang/viecmau/MauThietKeDetail.tsx">
"use client";

import React, { useState } from "react";
import {
  Tag,
  User,
  Calendar,
  Link as LinkIcon,
  Palette,
  ExternalLink,
  Clock,
} from "lucide-react";
import { KhungChiTiet } from "@/app/components/cacchucnang/KhungGiaoDienChucNang";
import { MauThietKe, createMauThietKeConfig } from "./config";

interface Props {
  data: MauThietKe;
  onClose: () => void;
  allowEdit: boolean;
  allowDelete: boolean;
  onEdit: () => void;
  onDelete: () => void;
}

// Interface m·ªü r·ªông ƒë·ªÉ h·ª©ng c√°c tr∆∞·ªùng m·ªõi t·ª´ backend
interface FileItem {
  ten: string;
  url: string;
  nguoi_dang?: string; // T√™n ng∆∞·ªùi upload
  last_modified?: string; // Th·ªùi gian upload
}

export default function MauThietKeDetail({
  data,
  onClose,
  allowEdit,
  allowDelete,
  onEdit,
  onDelete,
}: Props) {
  const config = createMauThietKeConfig();
  const [activeTab, setActiveTab] = useState("thongtin");
  const tabs = config.detailTabs.map((t) => ({ ...t, id: t.id || "" }));

  const item = data as any;

  // Helper format th·ªùi gian ng·∫Øn g·ªçn (VD: 14:30 25/12)
  const formatTime = (isoString?: string) => {
    if (!isoString) return "";
    const date = new Date(isoString);
    return date.toLocaleString("vi-VN", {
      hour: "2-digit",
      minute: "2-digit",
      day: "2-digit",
      month: "2-digit",
      year: "numeric", // C√≥ th·ªÉ b·ªè year n·∫øu mu·ªën g·ªçn h∆°n
    });
  };

  const getFileNameFromUrl = (url: string) => {
    try {
      return decodeURIComponent(url).split("?")[0].split("/").pop() || url;
    } catch {
      return url;
    }
  };

  const getDesignFiles = (): FileItem[] => {
    if (!item || !item.file_thiet_ke) return [];
    let parsed: any[] = [];
    const rawData = item.file_thiet_ke;

    try {
      if (Array.isArray(rawData)) parsed = rawData;
      else if (typeof rawData === "string" && rawData.trim()) {
        const result = JSON.parse(rawData);
        if (Array.isArray(result)) parsed = result;
      }
    } catch {
      return [];
    }

    return parsed
      .map((entry: any) => {
        // Data c≈© (String)
        if (typeof entry === "string") {
          return { ten: getFileNameFromUrl(entry), url: entry };
        }
        // Data m·ªõi (Object)
        if (typeof entry === "object" && entry !== null) {
          return {
            ten:
              entry.ten ||
              getFileNameFromUrl(entry.url || "") ||
              "File ƒë√≠nh k√®m",
            url: entry.url || "",
            nguoi_dang: entry.nguoi_dang,
            last_modified: entry.last_modified,
          };
        }
        return null;
      })
      .filter((f): f is FileItem => f !== null && f.url.trim() !== "");
  };

  const designFiles = getDesignFiles();

  return (
    <KhungChiTiet
      data={data}
      onClose={onClose}
      avatar={item.hinh_anh}
      title={item.ten || item.mo_ta || "Chi ti·∫øt m·∫´u"}
      tabs={tabs}
      activeTab={activeTab}
      onTabChange={setActiveTab}
      showEditButton={allowEdit}
      showDeleteButton={allowDelete}
      onEdit={onEdit}
      onDelete={onDelete}
    >
      <div className="p-4 space-y-4">
        {/* H√åNH ·∫¢NH */}
        <div className="aspect-video w-full rounded-xl overflow-hidden bg-[#1a1a1a] border border-white/10 relative group">
          {item.hinh_anh ? (
            <img
              src={item.hinh_anh}
              alt=""
              className="w-full h-full object-contain"
            />
          ) : (
            <div className="w-full h-full flex items-center justify-center text-white/20">
              <Palette size={48} />
            </div>
          )}
        </div>

        {/* DANH S√ÅCH FILE - GIAO DI·ªÜN M·ªöI */}
        {designFiles.length > 0 ? (
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <label className="text-[10px] text-white/40 font-bold uppercase">
                File Thi·∫øt K·∫ø G·ªëc ({designFiles.length})
              </label>
            </div>

            <div className="grid gap-2">
              {designFiles.map((file, idx) => (
                <a
                  key={idx}
                  href={file.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="group flex items-center gap-3 p-3 bg-[#151515] hover:bg-[#C69C6D] border border-white/10 hover:border-[#C69C6D] rounded-lg transition-all relative overflow-hidden"
                  title={file.url}
                >
                  {/* Icon File */}
                  <div className="w-10 h-10 rounded bg-black/20 flex items-center justify-center text-[#C69C6D] group-hover:text-black shrink-0">
                    <LinkIcon size={18} />
                  </div>

                  {/* Th√¥ng tin ch√≠nh */}
                  <div className="flex-1 overflow-hidden">
                    {/* T√™n File */}
                    <div className="flex items-center gap-2">
                      <p className="text-sm font-bold text-[#C69C6D] group-hover:text-black truncate">
                        {file.ten}
                      </p>
                    </div>

                    {/* Metadata: Ng∆∞·ªùi ƒëƒÉng - Th·ªùi gian */}
                    <div className="flex items-center gap-2 mt-0.5 text-[10px] text-white/40 group-hover:text-black/70 font-mono">
                      {file.nguoi_dang && (
                        <span className="flex items-center gap-1">
                          <User size={10} /> {file.nguoi_dang}
                        </span>
                      )}

                      {file.nguoi_dang && file.last_modified && <span>‚Ä¢</span>}

                      {file.last_modified && (
                        <span className="flex items-center gap-1">
                          <Clock size={10} /> {formatTime(file.last_modified)}
                        </span>
                      )}
                    </div>
                  </div>

                  <ExternalLink
                    size={14}
                    className="text-white/20 group-hover:text-black/40"
                  />
                </a>
              ))}
            </div>
          </div>
        ) : (
          <div className="p-3 rounded-lg border border-dashed border-white/10 flex items-center justify-center gap-2 text-white/20">
            <LinkIcon size={14} />
            <span className="text-xs italic">Ch∆∞a c√≥ file thi·∫øt k·∫ø n√†o</span>
          </div>
        )}

        {/* TH√îNG TIN KH√ÅC */}
        <div className="grid gap-3 pt-2 border-t border-white/5">
          <DetailRow
            icon={<Tag size={18} />}
            label="Ph√¢n lo·∫°i"
            value={item.phan_loai}
          />
          <DetailRow
            icon={<User size={18} />}
            label="Ng∆∞·ªùi t·∫°o m·∫´u"
            value={item.ten_nguoi_tao}
          />
          <DetailRow
            icon={<Calendar size={18} />}
            label="Ng√†y t·∫°o m·∫´u"
            value={
              item.tao_luc || item.created_at
                ? new Date(item.tao_luc || item.created_at).toLocaleDateString(
                    "vi-VN"
                  )
                : "---"
            }
          />
        </div>
      </div>
    </KhungChiTiet>
  );
}

function DetailRow({
  icon,
  label,
  value,
}: {
  icon: any;
  label: string;
  value: string;
}) {
  return (
    <div className="p-3 bg-[#151515] rounded-xl border border-white/5 flex items-center gap-3">
      <div className="text-[#C69C6D]">{icon}</div>
      <div>
        <p className="text-[10px] text-white/40 font-bold uppercase">{label}</p>
        <p className="text-white text-sm">{value || "---"}</p>
      </div>
    </div>
  );
}
</file>

<file path="components/cacchucnang/viecmau/MauThietKeForm.tsx">
"use client";

import React, { useState } from "react";
import { Plus, Link as LinkIcon, Trash2, Type } from "lucide-react";
import { KhungForm } from "@/app/components/cacchucnang/KhungGiaoDienChucNang";
import { MauThietKe, createMauThietKeConfig } from "./config";

interface Props {
  data: MauThietKe | null; // null = T·∫°o m·ªõi
  onClose: () => void;
  onSubmit: (formData: any) => Promise<void>;
  loading: boolean;
}

// 1. ƒê·ªãnh nghƒ©a ki·ªÉu d·ªØ li·ªáu cho file thi·∫øt k·∫ø
interface FileItem {
  ten: string;
  url: string;
}

// 2. ƒê·ªãnh nghƒ©a ki·ªÉu State cho Form (Tr√°nh xung ƒë·ªôt Type)
interface FormState extends Omit<Partial<MauThietKe>, "file_thiet_ke"> {
  file_thiet_ke: FileItem[];
}

export default function MauThietKeForm({
  data,
  onClose,
  onSubmit,
  loading,
}: Props) {
  const config = createMauThietKeConfig();

  // 3. Kh·ªüi t·∫°o state
  const [formData, setFormData] = useState<FormState>(() => {
    let files: FileItem[] = [];

    // Logic parse d·ªØ li·ªáu c≈©
    if (data && (data as any).file_thiet_ke) {
      try {
        const raw = (data as any).file_thiet_ke;
        let parsed: any[] = [];

        if (Array.isArray(raw)) {
          parsed = raw;
        } else if (typeof raw === "string") {
          parsed = JSON.parse(raw);
        }

        // Convert sang chu·∫©n { ten, url }
        files = parsed.map((item: any) => {
          if (typeof item === "string") return { ten: "", url: item };
          if (typeof item === "object")
            return { ten: item.ten || "", url: item.url || "" };
          return { ten: "", url: "" };
        });
      } catch {}
    }

    return data ? { ...data, file_thiet_ke: files } : { file_thiet_ke: [] };
  });

  // --- HANDLERS ---

  const handleChange = (field: keyof FormState, value: any) => {
    setFormData((prev) => ({ ...prev, [field]: value }));
  };

  const handleFileChange = (
    index: number,
    field: keyof FileItem,
    value: string
  ) => {
    const newFiles = [...formData.file_thiet_ke];
    if (!newFiles[index]) return;
    newFiles[index] = { ...newFiles[index], [field]: value };
    setFormData((prev) => ({ ...prev, file_thiet_ke: newFiles }));
  };

  const addFileRow = () => {
    setFormData((prev) => ({
      ...prev,
      file_thiet_ke: [...prev.file_thiet_ke, { ten: "", url: "" }],
    }));
  };

  const removeFileRow = (index: number) => {
    const newFiles = [...formData.file_thiet_ke];
    newFiles.splice(index, 1);
    setFormData((prev) => ({ ...prev, file_thiet_ke: newFiles }));
  };

  const handleSubmit = async () => {
    // 1. Validate th√¥ng tin chung
    if (!formData.mo_ta?.trim()) {
      alert("Vui l√≤ng nh·∫≠p T√™n m·∫´u thi·∫øt k·∫ø!");
      return;
    }
    if (!formData.phan_loai) {
      alert("Vui l√≤ng ch·ªçn Ph√¢n lo·∫°i!");
      return;
    }

    // 2. Validate file
    const validFiles = formData.file_thiet_ke.filter(
      (f) => f.ten.trim() !== "" || f.url.trim() !== ""
    );
    const hasError = validFiles.some(
      (f) => f.ten.trim() === "" || f.url.trim() === ""
    );

    if (hasError) {
      alert(
        "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß T√äN HI·ªÇN TH·ªä v√† ƒê∆Ø·ªúNG D·∫™N cho file thi·∫øt k·∫ø!"
      );
      return;
    }

    // 3. Submit (G·ª¨I M·∫¢NG TR·ª∞C TI·∫æP - Backend s·∫Ω t·ª± lo Stringify)
    // üü¢ S·ª¨A: Kh√¥ng JSON.stringify ·ªü ƒë√¢y n·ªØa
    const finalData = {
      ...formData,
      file_thiet_ke: validFiles,
    };

    await onSubmit(finalData);
  };

  return (
    <KhungForm
      onClose={onClose}
      title={data ? "S·ª¨A M·∫™U" : "TH√äM M·∫™U M·ªöI"}
      onSubmit={handleSubmit}
      loading={loading}
      isDirty={true}
      showAvatarUpload={true}
      uploadBucket="images"
      avatar={formData.hinh_anh}
      onUploadComplete={(url) => handleChange("hinh_anh", url)}
    >
      <div className="space-y-4">
        {/* T√™n m·∫´u */}
        <div>
          <label className="text-xs font-bold text-white/60 mb-2 block uppercase">
            T√™n m·∫´u thi·∫øt k·∫ø <span className="text-red-500">*</span>
          </label>
          <input
            className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:border-[#C69C6D] outline-none placeholder-white/20"
            value={formData.mo_ta || ""}
            onChange={(e) => handleChange("mo_ta", e.target.value)}
            placeholder="Nh·∫≠p t√™n m·∫´u..."
          />
        </div>

        {/* Ph√¢n lo·∫°i */}
        <div>
          <label className="text-xs font-bold text-white/60 mb-2 block uppercase">
            Ph√¢n lo·∫°i <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <select
              className="w-full bg-[#1a1a1a] text-white border border-white/10 rounded-lg px-4 py-3 focus:border-[#C69C6D] outline-none appearance-none"
              value={formData.phan_loai || ""}
              onChange={(e) => handleChange("phan_loai", e.target.value)}
            >
              <option value="" className="bg-[#1a1a1a] text-gray-500">
                -- Ch·ªçn lo·∫°i --
              </option>
              {config.fields
                .find((f) => f.key === "phan_loai")
                ?.options?.map((opt: any) => (
                  <option
                    key={opt}
                    value={opt}
                    className="bg-[#1a1a1a] text-white py-2"
                  >
                    {opt}
                  </option>
                ))}
            </select>
            <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-white/50 text-xs">
              ‚ñº
            </div>
          </div>
        </div>

        {/* File Thi·∫øt K·∫ø */}
        <div>
          <div className="flex items-center justify-between mb-2">
            <label className="text-xs font-bold text-white/60 uppercase">
              File Thi·∫øt K·∫ø (Google Drive)
            </label>
            <button
              type="button"
              onClick={addFileRow}
              className="flex items-center gap-1 text-[10px] bg-[#C69C6D]/20 text-[#C69C6D] hover:bg-[#C69C6D] hover:text-black px-2 py-1 rounded transition-all font-bold"
            >
              <Plus size={12} /> TH√äM FILE
            </button>
          </div>

          <div className="space-y-2">
            {formData.file_thiet_ke.map((file, idx) => (
              <div key={idx} className="flex gap-2 items-start">
                {/* T√™n */}
                <div className="w-1/3 relative group">
                  <div className="absolute left-3 top-1/2 -translate-y-1/2 text-white/30">
                    <Type size={14} />
                  </div>
                  <input
                    className={`w-full bg-white/5 border rounded-lg pl-9 pr-3 py-2.5 text-white text-xs outline-none placeholder-white/20 transition-all ${
                      file.ten.trim() === "" && file.url.trim() !== ""
                        ? "border-red-500/50 focus:border-red-500"
                        : "border-white/10 focus:border-[#C69C6D]"
                    }`}
                    placeholder="T√™n hi·ªÉn th·ªã..."
                    value={file.ten}
                    onChange={(e) =>
                      handleFileChange(idx, "ten", e.target.value)
                    }
                  />
                </div>
                {/* Link */}
                <div className="flex-1 relative group">
                  <div className="absolute left-3 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-[#C69C6D] transition-colors">
                    <LinkIcon size={14} />
                  </div>
                  <input
                    className={`
                        w-full bg-white/5 border rounded-lg pl-9 pr-4 py-2.5 text-white text-xs outline-none placeholder-white/20 transition-all
                        ${
                          file.url.trim() === "" && file.ten.trim() !== ""
                            ? "border-red-500/50 focus:border-red-500"
                            : "border-white/10 focus:border-[#C69C6D]"
                        }
                    `}
                    value={file.url}
                    onChange={(e) =>
                      handleFileChange(idx, "url", e.target.value)
                    }
                    placeholder="D√°n link Google Drive..."
                  />
                </div>
                {/* X√≥a */}
                <button
                  type="button"
                  onClick={() => removeFileRow(idx)}
                  className="p-2 text-white/20 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-colors shrink-0 mt-[2px]"
                >
                  <Trash2 size={16} />
                </button>
              </div>
            ))}

            {formData.file_thiet_ke.length === 0 && (
              <div
                onClick={addFileRow}
                className="text-[10px] text-white/20 italic text-center py-3 border border-dashed border-white/10 rounded-lg cursor-pointer hover:border-white/30 transition-colors"
              >
                Ch∆∞a c√≥ file n√†o. Nh·∫•n ƒë·ªÉ th√™m.
              </div>
            )}
          </div>
        </div>
      </div>
    </KhungForm>
  );
}
</file>

<file path="components/cacchucnang/viecmau/MauThietKeList.tsx">
"use client";

import React from "react";
import { Palette, User, Link as LinkIcon } from "lucide-react";
import { MauThietKe } from "./config";

interface Props {
  items: MauThietKe[];
  bulkMode: boolean;
  selectedIds: Set<string>;
  onToggleSelect: (id: string) => void;
  onClickItem: (item: MauThietKe) => void;
}

export default function MauThietKeList({
  items,
  bulkMode,
  selectedIds,
  onToggleSelect,
  onClickItem,
}: Props) {
  // Helper: ƒê·∫øm s·ªë l∆∞·ª£ng file thi·∫øt k·∫ø
  const getFileCount = (item: MauThietKe) => {
    const files = item.file_thiet_ke;
    if (Array.isArray(files))
      return files.filter((f) => f && f.trim() !== "").length;
    if (typeof files === "string") {
      try {
        const parsed = JSON.parse(files);
        return Array.isArray(parsed)
          ? parsed.filter((f: any) => f && f.trim() !== "").length
          : 0;
      } catch {
        return 0;
      }
    }
    return 0;
  };

  return (
    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-2 p-2 md:p-4">
      {items.map((item) => {
        const fileCount = getFileCount(item);

        return (
          <div
            key={item.id}
            onClick={(e) => {
              if (bulkMode) {
                e.stopPropagation();
                onToggleSelect(item.id);
              } else {
                onClickItem(item);
              }
            }}
            className={`
                group relative bg-[#0f0f0f] border border-white/10 rounded-lg overflow-hidden cursor-pointer 
                hover:border-[#C69C6D]/50 transition-all 
                ${
                  selectedIds.has(item.id)
                    ? "border-[#C69C6D] bg-[#C69C6D]/10"
                    : ""
                }
            `}
          >
            {/* üü¢ HI·ªÇN TH·ªä S·ªê L∆Ø·ª¢NG FILE THI·∫æT K·∫æ (Badge) */}
            {fileCount > 0 && (
              <div className="absolute top-1 left-1 z-10 flex items-center gap-1 bg-black/60 backdrop-blur-sm px-1.5 py-0.5 rounded text-[9px] font-bold text-[#C69C6D] border border-white/10 shadow-sm">
                <LinkIcon size={10} />
                <span>{fileCount}</span>
              </div>
            )}

            {/* Checkbox Bulk Mode */}
            {bulkMode && (
              <div className="absolute top-1 right-1 z-10 w-5 h-5 border-2 rounded flex items-center justify-center transition-colors border-white/30 bg-black/50">
                {selectedIds.has(item.id) && (
                  <span className="text-[#C69C6D] font-bold text-xs">‚úì</span>
                )}
              </div>
            )}

            {/* H√¨nh ·∫£nh */}
            <div className="aspect-square w-full bg-[#1a1a1a] relative group-hover:opacity-90 transition-opacity">
              {item.hinh_anh ? (
                <img
                  src={item.hinh_anh}
                  alt=""
                  className="w-full h-full object-cover"
                  loading="lazy"
                />
              ) : (
                <div className="w-full h-full flex items-center justify-center text-white/10">
                  <Palette size={24} />
                </div>
              )}
            </div>

            {/* N·ªôi dung (ƒê√£ cƒÉn gi·ªØa) */}
            <div className="p-2 text-center">
              <h3 className="font-bold text-white truncate text-xs leading-tight">
                {item.mo_ta}
              </h3>
              <p className="text-[9px] text-[#C69C6D] mt-0.5 truncate uppercase opacity-80">
                {item.phan_loai}
              </p>
              <div className="mt-1 flex items-center justify-center gap-1 text-[9px] text-white/30 truncate">
                <User size={8} />
                <span className="truncate">{item.ten_nguoi_tao || "---"}</span>
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
}
</file>

<file path="components/ConfirmDialog.tsx">
'use client';

import React, { useEffect, useState } from 'react';
import { createPortal } from 'react-dom';
import { AlertTriangle, CheckCircle2, X } from 'lucide-react';

interface ConfirmDialogProps {
  isOpen: boolean;
  title: string;
  message: string;
  confirmText?: string;
  cancelText?: string;
  isDangerous?: boolean; // N·∫øu true n√∫t s·∫Ω m√†u ƒë·ªè (X√≥a)
  isLoading?: boolean;
  onConfirm: () => void;
  onCancel: () => void;
}

export default function ConfirmDialog({
  isOpen,
  title,
  message,
  confirmText = 'X√°c nh·∫≠n',
  cancelText = 'H·ªßy b·ªè',
  isDangerous = false,
  isLoading = false,
  onConfirm,
  onCancel
}: ConfirmDialogProps) {
  const [mounted, setMounted] = useState(false);

  useEffect(() => { setMounted(true); }, []);

  if (!mounted || !isOpen) return null;

  return createPortal(
    <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
      {/* Backdrop m·ªù ·∫£o */}
      <div 
        className="absolute inset-0 bg-black/80 backdrop-blur-sm animate-in fade-in duration-300"
        onClick={!isLoading ? onCancel : undefined}
      />

      {/* Dialog Content */}
      <div className="relative w-full max-w-sm bg-[#1a120f] border border-[#C69C6D]/40 rounded-2xl shadow-[0_0_50px_rgba(0,0,0,0.8)] overflow-hidden animate-in zoom-in-95 duration-300">
        
        {/* Glow effect ph√≠a tr√™n */}
        <div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#C69C6D] to-transparent opacity-70"></div>

        <div className="p-6 text-center">
          {/* Icon */}
          <div className="mx-auto w-16 h-16 mb-4 flex items-center justify-center rounded-full bg-black border border-[#C69C6D]/20 shadow-inner">
            {isDangerous ? (
              <AlertTriangle size={32} className="text-red-500 animate-pulse" />
            ) : (
              <CheckCircle2 size={32} className="text-[#C69C6D]" />
            )}
          </div>

          {/* Title & Message */}
          <h3 className="text-xl font-serif font-bold text-[#F5E6D3] mb-2 uppercase tracking-wide">
            {title}
          </h3>
          <p className="text-white/60 text-sm font-light leading-relaxed mb-6">
            {message}
          </p>

          {/* Actions */}
          <div className="flex gap-3">
            <button
              onClick={onCancel}
              disabled={isLoading}
              className="flex-1 py-3 rounded-xl border border-white/10 text-white/50 hover:text-white hover:bg-white/5 transition-all text-xs font-bold uppercase tracking-widest"
            >
              {cancelText}
            </button>
            <button
              onClick={onConfirm}
              disabled={isLoading}
              className={`flex-1 py-3 rounded-xl text-black font-bold uppercase tracking-widest transition-all shadow-lg active:scale-95 text-xs flex items-center justify-center gap-2
                ${isDangerous 
                  ? 'bg-red-600 hover:bg-red-500 text-white shadow-red-900/20' 
                  : 'bg-[#C69C6D] hover:bg-[#B58B5D] shadow-[#C69C6D]/20'
                }
                ${isLoading ? 'opacity-70 cursor-not-allowed' : ''}
              `}
            >
              {isLoading ? 'ƒêang x·ª≠ l√Ω...' : confirmText}
            </button>
          </div>
        </div>
      </div>
    </div>,
    document.body
  );
}
</file>

<file path="components/ErrorBoundary.tsx">
'use client';
import React, { ReactNode } from 'react';
import { AlertCircle } from 'lucide-react';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error?: Error;
}

export default class ErrorBoundary extends React.Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error) {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('ErrorBoundary caught:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return this.props.fallback || (
        <div className="flex items-center justify-center min-h-screen bg-red-50 p-4">
          <div className="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
            <div className="flex items-center gap-3 mb-4">
              <AlertCircle className="text-red-600" size={24} />
              <h2 className="text-lg font-bold text-red-600">C√≥ L·ªói X·∫£y Ra</h2>
            </div>
            <p className="text-gray-700 mb-4">·ª®ng d·ª•ng g·∫∑p s·ª± c·ªë. Vui l√≤ng refresh trang ho·∫∑c li√™n h·ªá h·ªó tr·ª£.</p>
            <button
              onClick={() => window.location.reload()}
              className="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
            >
              Reload
            </button>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}
</file>

<file path="components/ForceFullScreen.tsx">
"use client";

import React, { useState, useEffect } from "react";
import {
  Download,
  Share,
  PlusSquare,
  Smartphone,
  Monitor,
  XCircle,
  CheckCircle2,
} from "lucide-react";
import { usePathname } from "next/navigation";

export default function ForceFullScreen() {
  const pathname = usePathname();
  const [showPrompt, setShowPrompt] = useState(false);
  const [isIOS, setIsIOS] = useState(false);
  const [isMobile, setIsMobile] = useState(false);
  const [deferredPrompt, setDeferredPrompt] = useState<any>(null);

  // 1. LOGIC T√çNH CHI·ªÄU CAO "B·∫§T T·ª¨" (Fix l·ªói h·ªü tr·∫Øng tr√™n Safari/Chrome Mobile)
  useEffect(() => {
    const setAppHeight = () => {
      const vh = window.visualViewport
        ? window.visualViewport.height
        : window.innerHeight;
      document.documentElement.style.setProperty("--app-height", `${vh}px`);
    };

    setAppHeight();

    if (window.visualViewport) {
      window.visualViewport.addEventListener("resize", setAppHeight);
      window.visualViewport.addEventListener("scroll", setAppHeight);
    } else {
      window.addEventListener("resize", setAppHeight);
    }

    return () => {
      if (window.visualViewport) {
        window.visualViewport.removeEventListener("resize", setAppHeight);
        window.visualViewport.removeEventListener("scroll", setAppHeight);
      } else {
        window.removeEventListener("resize", setAppHeight);
      }
    };
  }, []);

  // 2. LOGIC KI·ªÇM TRA & √âP C√ÄI ƒê·∫∂T
  useEffect(() => {
    // Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ b·∫•m "·∫®n vƒ©nh vi·ªÖn" ch∆∞a
    const isDismissed =
      typeof window !== "undefined" &&
      localStorage.getItem("PWA_PROMPT_DISMISSED") === "true";

    if (isDismissed) return;

    // --- A. X·ª≠ l√Ω cho Android/Chrome (S·ª± ki·ªán chu·∫©n) ---
    const handleBeforeInstall = (e: any) => {
      e.preventDefault();
      setDeferredPrompt(e);
      // N·∫øu ch∆∞a c√†i ƒë·∫∑t, hi·ªán popup ngay
      setShowPrompt(true);
    };
    window.addEventListener("beforeinstallprompt", handleBeforeInstall);

    // --- B. X·ª≠ l√Ω cho iOS v√† check tr·∫°ng th√°i ---
    const checkDeviceAndMode = () => {
      const userAgent = window.navigator.userAgent.toLowerCase();

      // Detect Mobile
      const mobile =
        /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(
          userAgent
        );
      setIsMobile(mobile);

      // Detect iOS chu·∫©n (Bao g·ªìm iPad Pro ƒë·ªùi m·ªõi gi·∫£ d·∫°ng Mac)
      const isIOSDevice =
        /iPad|iPhone|iPod/.test(navigator.userAgent) ||
        (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);

      setIsIOS(isIOSDevice);

      // Ki·ªÉm tra ƒë√£ c√†i ƒë·∫∑t (Standalone) ch∆∞a?
      const isStandalone =
        window.matchMedia("(display-mode: standalone)").matches ||
        window.matchMedia("(display-mode: fullscreen)").matches ||
        window.matchMedia("(display-mode: minimal-ui)").matches ||
        (window.navigator as any).standalone ||
        document.referrer.includes("android-app://");

      // ƒêi·ªÅu ki·ªán hi·ªÉn th·ªã:
      // 1. Ph·∫£i l√† trang n·ªôi b·ªô (ƒë·ªÉ kh√¥ng l√†m phi·ªÅn ·ªü trang login/home)
      const isInternalPage =
        pathname.startsWith("/phong") ||
        pathname.startsWith("/dashboard") ||
        pathname.startsWith("/admin");

      // 2. N·∫øu l√† iOS v√† ch∆∞a c√†i ƒë·∫∑t -> Hi·ªán lu√¥n
      if (isIOSDevice && !isStandalone && isInternalPage) {
        setShowPrompt(true);
      }

      // N·∫øu ƒë√£ c√†i r·ªìi th√¨ t·∫Øt prompt
      if (isStandalone) {
        setShowPrompt(false);
      }
    };

    checkDeviceAndMode();
    window.addEventListener("resize", checkDeviceAndMode);

    return () => {
      window.removeEventListener("beforeinstallprompt", handleBeforeInstall);
      window.removeEventListener("resize", checkDeviceAndMode);
    };
  }, [pathname]);

  const handleInstallClick = async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === "accepted") {
        setDeferredPrompt(null);
        setShowPrompt(false);
      }
    } else {
      alert(
        'Vui l√≤ng t√¨m n√∫t "C√†i ƒë·∫∑t" ho·∫∑c "Th√™m v√†o m√†n h√¨nh ch√≠nh" (Add to Home Screen) trong menu tr√¨nh duy·ªát.'
      );
    }
  };

  const handleDismiss = () => {
    localStorage.setItem("PWA_PROMPT_DISMISSED", "true");
    setShowPrompt(false);
  };

  if (!showPrompt) return null;

  return (
    <div className="fixed inset-0 z-[99999] bg-black/95 backdrop-blur-xl flex flex-col items-center justify-center p-6 animate-in fade-in duration-500 text-center">
      <button
        onClick={() => setShowPrompt(false)}
        className="absolute top-4 right-4 text-white/30 hover:text-white p-2"
      >
        <XCircle size={24} />
      </button>

      <div className="w-20 h-20 mb-6 rounded-2xl bg-gradient-to-br from-[#C69C6D] to-[#5D4037] flex items-center justify-center shadow-[0_0_40px_rgba(198,156,109,0.3)] animate-bounce">
        {isIOS ? (
          <Smartphone className="text-white w-10 h-10" />
        ) : (
          <Download className="text-white w-10 h-10" />
        )}
      </div>

      <h2 className="text-2xl font-bold text-[#F5E6D3] mb-4 uppercase tracking-widest font-serif">
        C√†i ƒê·∫∑t ·ª®ng D·ª•ng
      </h2>

      <p className="text-gray-400 text-sm md:text-base max-w-md mb-8 leading-relaxed">
        {isIOS
          ? "ƒê·ªÉ ·ª©ng d·ª•ng ho·∫°t ƒë·ªông ·ªïn ƒë·ªãnh v√† to√†n m√†n h√¨nh tr√™n iPhone/iPad, vui l√≤ng th√™m v√†o m√†n h√¨nh ch√≠nh."
          : "C√†i ƒë·∫∑t ·ª©ng d·ª•ng v√†o thi·∫øt b·ªã ƒë·ªÉ c√≥ tr·∫£i nghi·ªám t·ªët nh·∫•t, kh√¥ng b·ªã l·ªói giao di·ªán."}
      </p>

      {isIOS ? (
        <div className="bg-[#1a120f] border border-[#8B5E3C]/30 p-5 rounded-xl max-w-xs w-full text-left space-y-4 shadow-2xl">
          <div className="flex items-center gap-3 text-[#C69C6D] text-sm font-bold">
            <Share size={20} />
            <span>1. Nh·∫•n n√∫t Chia s·∫ª (Share)</span>
          </div>
          <div className="w-full h-[1px] bg-[#8B5E3C]/20"></div>
          <div className="flex items-center gap-3 text-[#F5E6D3] text-sm font-bold">
            <PlusSquare size={20} />
            <span>2. Ch·ªçn "Th√™m v√†o MH ch√≠nh"</span>
          </div>
        </div>
      ) : (
        <div className="w-full max-w-xs space-y-3">
          <button
            onClick={handleInstallClick}
            className="w-full py-4 bg-[#C69C6D] hover:bg-[#b08b5e] text-[#1a120f] font-bold text-sm uppercase tracking-widest rounded-xl transition-all active:scale-95 shadow-[0_0_20px_rgba(198,156,109,0.4)] flex items-center justify-center gap-2"
          >
            <Download size={20} strokeWidth={2.5} /> C√ÄI ƒê·∫∂T NGAY
          </button>
        </div>
      )}

      <button
        onClick={handleDismiss}
        className="mt-8 flex items-center gap-2 px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-white/50 hover:text-white transition-colors text-xs font-medium border border-white/5"
      >
        <CheckCircle2 size={14} />
        ƒê√£ c√†i ƒë·∫∑t / Kh√¥ng hi·ªán l·∫°i
      </button>
    </div>
  );
}
</file>

<file path="components/NutHoTro.tsx">
"use client";

import React, { useState, useEffect, useRef, useMemo } from "react";
import {
  MessageCircle,
  X,
  Send,
  User,
  ShieldCheck,
  Image as ImageIcon,
  Loader2,
  Headphones,
  PhoneCall,
  Info,
  LogIn,
} from "lucide-react";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { useUser } from "@/app/ThuVien/UserContext";
import { useRouter } from "next/navigation";
import { compressImage } from "@/app/ThuVien/compressImage";

// Hook √¢m thanh click nh·∫π
const useSoundEffect = () => {
  const audioRef = useRef<HTMLAudioElement | null>(null);
  useEffect(() => {
    if (typeof window !== "undefined") {
      audioRef.current = new Audio("/sounds/click.mp3");
      audioRef.current.volume = 0.5;
    }
  }, []);
  return () => audioRef.current?.play().catch(() => {});
};

// üü¢ Helper t·∫°o ID kh√°ch v√£ng lai (Gi·ªØ chat khi F5)
const getGuestId = () => {
  if (typeof window === "undefined") return "guest";
  let id = localStorage.getItem("guest_chat_id");
  if (!id) {
    id = "guest_" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem("guest_chat_id", id);
  }
  return id;
};

export default function NutHoTro() {
  const { user } = useUser();
  const router = useRouter();
  const playClick = useSoundEffect();

  // State
  const [isOpen, setIsOpen] = useState(false);
  const [viewMode, setViewMode] = useState<"form_guest" | "chat">("form_guest");
  const [isSending, setIsSending] = useState(false);
  const [guestInfo, setGuestInfo] = useState({ name: "", phone: "" });
  const [messages, setMessages] = useState<any[]>([]);
  const [inputMsg, setInputMsg] = useState("");
  const [sessionId, setSessionId] = useState<string | null>(null);
  const [onlineStaffCount, setOnlineStaffCount] = useState(0);

  // üü¢ Th√™m state th√¥ng tin nh√¢n vi√™n ƒëang chat
  const [staffInfo, setStaffInfo] = useState<any>(null);

  const scrollRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const guestId = getGuestId(); // L·∫•y ID kh√°ch v√£ng lai

  // 1. REALTIME STAFF COUNT
  useEffect(() => {
    const channel = supabase.channel("online-users-counter");
    channel
      .on("presence", { event: "sync" }, () => {
        const state = channel.presenceState();
        const allUsers: any[] = Object.values(state).flat();
        const supportStaff = allUsers.filter(
          (u) =>
            u.role &&
            ["admin", "boss", "quanly", "sales"].includes(u.role.toLowerCase())
        );
        setOnlineStaffCount(supportStaff.length);
      })
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, []);

  // 2. CHECK USER & RESTORE SESSION
  useEffect(() => {
    if (isOpen) {
      if (user) {
        setViewMode("chat");
        initChatSession(
          user.id,
          user.ho_ten || "Kh√°ch h√†ng",
          user.so_dien_thoai
        );
      } else {
        const saved = localStorage.getItem("guest_chat_info");
        if (saved) {
          const p = JSON.parse(saved);
          setGuestInfo(p);
          setViewMode("chat");
          initChatSession(null, p.name, p.phone);
        } else if (localStorage.getItem("guest_chat_id")) {
          checkExistingGuestSession();
        } else {
          setViewMode("form_guest");
        }
      }
    }
  }, [isOpen, user]);

  // H√†m ki·ªÉm tra session c≈© c·ªßa kh√°ch v√£ng lai
  const checkExistingGuestSession = async () => {
    const { data } = await supabase
      .from("tu_van_sessions")
      .select("*")
      .eq("khach_vang_lai_id", guestId)
      .neq("trang_thai", "ket_thuc")
      .single();
    if (data) {
      setViewMode("chat");
      setSessionId(data.id);
      subscribeToChat(data.id);
    } else {
      setViewMode("form_guest");
    }
  };

  // Auto scroll
  useEffect(() => {
    if (scrollRef.current)
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
  }, [messages, viewMode, isOpen]);

  // 3. LOGIC HI·ªÇN TH·ªä TH√îNG B√ÅO L·ªäCH S·ª∞
  const showPoliteMessage = useMemo(() => {
    if (messages.length < 2) return false;
    const last2 = messages.slice(-2);
    return last2.every((m) => !m.la_nhan_vien);
  }, [messages]);

  // Init Session
  const initChatSession = async (
    userId: string | null,
    name: string,
    phone: string | null
  ) => {
    let q = supabase
      .from("tu_van_sessions")
      .select("*")
      .neq("trang_thai", "ket_thuc");

    if (userId) q = q.eq("khach_hang_id", userId);
    else q = q.eq("khach_vang_lai_id", guestId);

    const { data } = await q
      .order("cap_nhat_luc", { ascending: false })
      .limit(1);

    if (data && data.length > 0) {
      setSessionId(data[0].id);
      subscribeToChat(data[0].id);

      if (data[0].nhan_su_phu_trach_id) {
        const { data: s } = await supabase
          .from("nhan_su")
          .select("ho_ten, hinh_anh")
          .eq("id", data[0].nhan_su_phu_trach_id)
          .single();
        setStaffInfo(s);
      }
    }
  };

  // üü¢ Subscribe Chat (ƒê√£ t·ªëi ∆∞u)
  const subscribeToChat = async (sId: string) => {
    const { data } = await supabase
      .from("tu_van_messages")
      .select("*")
      .eq("session_id", sId)
      .order("tao_luc", { ascending: true });
    if (data) setMessages(data);

    // D√πng t√™n channel unique ƒë·ªÉ tr√°nh conflict
    const channel = supabase
      .channel(`guest_chat_room_${sId}`)
      .on(
        "postgres_changes",
        {
          event: "INSERT",
          schema: "public",
          table: "tu_van_messages",
          filter: `session_id=eq.${sId}`,
        },
        (payload) => {
          setMessages((p) => {
            // Ch·ªëng duplicate
            if (p.some((m) => m.id === payload.new.id)) return p;
            return [...p, payload.new];
          });
          if (scrollRef.current)
            scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
        }
      )
      .on(
        "postgres_changes",
        {
          event: "UPDATE",
          schema: "public",
          table: "tu_van_sessions",
          filter: `id=eq.${sId}`,
        },
        async (payload) => {
          if (
            payload.new.nhan_su_phu_trach_id &&
            payload.new.nhan_su_phu_trach_id !==
              payload.old.nhan_su_phu_trach_id
          ) {
            const { data: s } = await supabase
              .from("nhan_su")
              .select("ho_ten, hinh_anh")
              .eq("id", payload.new.nhan_su_phu_trach_id)
              .single();
            setStaffInfo(s);
          }
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  };

  // 4. G·ª¨I TIN NH·∫ÆN & PUSH NOTIFICATION
  const handleSend = async (file?: File) => {
    if (!inputMsg.trim() && !file) return;

    setIsSending(true);
    const text = inputMsg;
    setInputMsg("");

    try {
      let activeId = sessionId;
      let imgUrl = null;
      let isNew = false;

      if (file) {
        const compressed = await compressImage(file, 0.7, 1200);
        const name = `chat_${Date.now()}_${file.name.replace(/\W/g, "")}`;
        const { error: upErr } = await supabase.storage
          .from("images")
          .upload(name, compressed);
        if (!upErr) {
          const { data } = supabase.storage.from("images").getPublicUrl(name);
          imgUrl = data.publicUrl;
        }
      }

      if (!activeId) {
        const { data: newSess, error } = await supabase
          .from("tu_van_sessions")
          .insert({
            khach_hang_id: user?.id || null,
            khach_vang_lai_id: !user ? guestId : null,
            ten_hien_thi:
              user?.ho_ten || guestInfo.name || `Kh√°ch ${guestId.slice(-4)}`,
            sdt_lien_he: user?.so_dien_thoai || guestInfo.phone,
            loai_khach: user ? "thanh_vien" : "vang_lai",
            trang_thai: "cho_tu_van",
            tin_nhan_cuoi: imgUrl ? "[H√¨nh ·∫£nh]" : text,
          })
          .select()
          .single();

        if (!error) {
          activeId = newSess.id;
          setSessionId(newSess.id);
          subscribeToChat(newSess.id);
          isNew = true;
        }
      } else {
        await supabase
          .from("tu_van_sessions")
          .update({
            tin_nhan_cuoi: imgUrl
              ? text
                ? `[·∫¢nh] ${text}`
                : "[H√¨nh ·∫£nh]"
              : text,
            cap_nhat_luc: new Date().toISOString(),
          })
          .eq("id", activeId);
      }

      if (activeId) {
        await supabase.from("tu_van_messages").insert({
          session_id: activeId,
          nguoi_gui_id: user?.id || guestId,
          la_nhan_vien: false,
          noi_dung: text,
          hinh_anh: imgUrl,
        });

        // G·ª≠i th√¥ng b√°o cho nh√¢n vi√™n
        fetch("/api/push/notify-staff", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: `üí¨ Kh√°ch: ${user?.ho_ten || guestInfo.name || "V√£ng lai"}`,
            body: text || "ƒê√£ g·ª≠i h√¨nh ·∫£nh",
            url: "/quan-ly/tu-van",
            sessionId: activeId,
            targetStaffId: staffInfo ? null : null,
          }),
        }).catch(() => {});
      }
    } finally {
      setIsSending(false);
      if (fileInputRef.current) fileInputRef.current.value = "";
    }
  };

  const handleGuestSubmit = () => {
    if (!guestInfo.name.trim() || !guestInfo.phone.trim())
      return alert("Vui l√≤ng nh·∫≠p t√™n v√† SƒêT");
    localStorage.setItem("guest_chat_info", JSON.stringify(guestInfo));
    setViewMode("chat");
    initChatSession(null, guestInfo.name, guestInfo.phone);
  };

  if (user?.userType === "nhan_su") return null; // Nh√¢n s·ª± d√πng TuVanKhachHang

  return (
    <>
      <style jsx global>{`
        .glass-panel {
          background: rgba(10, 10, 10, 0.95);
          backdrop-filter: blur(20px);
          border-right: 1px solid rgba(198, 156, 109, 0.2);
          box-shadow: 10px 0 50px rgba(0, 0, 0, 0.8);
        }
        .chat-bubble-guest {
          background: #c69c6d;
          color: #000;
          border-radius: 12px 12px 2px 12px;
        }
        .chat-bubble-staff {
          background: #222;
          color: #fff;
          border: 1px solid #333;
          border-radius: 12px 12px 12px 2px;
        }
      `}</style>

      <div className="fixed bottom-6 left-6 z-[9000] font-sans flex flex-col items-start gap-4">
        {isOpen && (
          <div className="fixed inset-0 z-[9999] flex justify-start">
            <div
              className="absolute inset-0 bg-black/60 backdrop-blur-sm animate-in fade-in"
              onClick={() => setIsOpen(false)}
            ></div>
            <div className="relative w-full md:w-[450px] h-full glass-panel flex flex-col animate-in slide-in-from-left duration-300">
              {/* Header */}
              <div className="flex items-center justify-between p-5 border-b border-[#C69C6D]/20 bg-[#151515]">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-full bg-[#C69C6D]/10 flex items-center justify-center text-[#C69C6D]">
                    {staffInfo && staffInfo.hinh_anh ? (
                      <img
                        src={staffInfo.hinh_anh}
                        className="w-full h-full rounded-full object-cover"
                      />
                    ) : (
                      <Headphones size={20} />
                    )}
                  </div>
                  <div>
                    <h2 className="text-sm font-bold text-white uppercase tracking-widest">
                      {staffInfo ? staffInfo.ho_ten : "Trung T√¢m H·ªó Tr·ª£"}
                    </h2>
                    <div className="flex items-center gap-1.5 mt-1">
                      <span
                        className={`w-2 h-2 rounded-full ${
                          onlineStaffCount > 0
                            ? "bg-green-500 animate-pulse"
                            : "bg-gray-500"
                        }`}
                      ></span>
                      <span className="text-[10px] text-white/60">
                        {staffInfo
                          ? "ƒêang h·ªó tr·ª£ b·∫°n"
                          : onlineStaffCount > 0
                          ? `${onlineStaffCount} t∆∞ v·∫•n vi√™n Online`
                          : "ƒêang ngo·∫°i tuy·∫øn"}
                      </span>
                    </div>
                  </div>
                </div>
                <button
                  onClick={() => setIsOpen(false)}
                  className="p-2 hover:bg-white/10 rounded-full text-white/60 hover:text-white transition-colors"
                >
                  <X size={24} />
                </button>
              </div>

              {/* Body */}
              <div className="flex-1 bg-[#0a0a0a] relative overflow-hidden flex flex-col">
                {viewMode === "form_guest" ? (
                  <div className="flex-1 flex flex-col justify-center p-8 space-y-6 animate-in zoom-in-95">
                    <div className="text-center space-y-3">
                      <ShieldCheck
                        size={48}
                        className="mx-auto text-[#C69C6D]"
                      />
                      <h3 className="text-lg font-bold text-white">
                        K·∫øt N·ªëi V·ªõi Ch√∫ng T√¥i
                      </h3>
                      <p className="text-white/50 text-sm">
                        ƒê·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ t·ªët nh·∫•t, qu√Ω kh√°ch vui l√≤ng ƒë·ªÉ l·∫°i th√¥ng
                        tin li√™n h·ªá.
                      </p>
                    </div>
                    <div className="space-y-4">
                      <input
                        placeholder="H·ªç v√† t√™n c·ªßa b·∫°n"
                        className="w-full bg-[#1a1a1a] border border-white/10 rounded-xl p-4 text-white outline-none focus:border-[#C69C6D] transition-all"
                        value={guestInfo.name}
                        onChange={(e) =>
                          setGuestInfo({ ...guestInfo, name: e.target.value })
                        }
                      />
                      <input
                        placeholder="S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá"
                        className="w-full bg-[#1a1a1a] border border-white/10 rounded-xl p-4 text-white outline-none focus:border-[#C69C6D] transition-all"
                        value={guestInfo.phone}
                        onChange={(e) =>
                          setGuestInfo({ ...guestInfo, phone: e.target.value })
                        }
                      />
                      <button
                        onClick={handleGuestSubmit}
                        className="w-full py-4 bg-[#C69C6D] text-black font-bold uppercase tracking-wider rounded-xl hover:bg-white transition-all shadow-[0_0_20px_rgba(198,156,109,0.3)]"
                      >
                        B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán
                      </button>
                    </div>
                    <div className="text-center pt-4 border-t border-white/5">
                      <button
                        onClick={() => {
                          setIsOpen(false);
                          router.push("/?login=1");
                        }}
                        className="text-white/40 hover:text-[#C69C6D] text-xs uppercase font-bold tracking-widest transition-colors flex items-center justify-center gap-2"
                      >
                        <LogIn size={14} /> ƒêƒÉng nh·∫≠p t√†i kho·∫£n
                      </button>
                    </div>
                  </div>
                ) : (
                  <>
                    {/* Chat Messages */}
                    <div
                      className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar"
                      ref={scrollRef}
                    >
                      <div className="text-center py-4">
                        <span className="text-[10px] text-white/20 uppercase tracking-widest border px-3 py-1 rounded-full border-white/10">
                          K√™nh h·ªó tr·ª£ b·∫£o m·∫≠t
                        </span>
                      </div>
                      {messages.map((m) => (
                        <div
                          key={m.id}
                          className={`flex ${
                            m.la_nhan_vien ? "justify-start" : "justify-end"
                          }`}
                        >
                          <div
                            className={`max-w-[80%] p-3 text-sm font-medium shadow-md ${
                              m.la_nhan_vien
                                ? "chat-bubble-staff"
                                : "chat-bubble-guest"
                            }`}
                          >
                            {m.hinh_anh && (
                              <img
                                src={m.hinh_anh}
                                className="w-full h-auto rounded-lg mb-2 border border-black/10"
                              />
                            )}
                            {m.noi_dung}
                          </div>
                        </div>
                      ))}
                      {showPoliteMessage && (
                        <div className="bg-[#15202B] border border-[#C69C6D]/30 p-4 rounded-xl flex gap-4 animate-in fade-in slide-in-from-bottom-2 shadow-xl mx-2">
                          <Info className="text-[#C69C6D] shrink-0" size={24} />
                          <div className="flex-1">
                            <p className="text-[#C69C6D] text-sm font-bold mb-1">
                              QU√ù KH√ÅCH C·∫¶N H·ªñ TR·ª¢ G·∫§P?
                            </p>
                            <p className="text-white/70 text-xs mb-3 leading-relaxed">
                              Hi·ªán t·∫°i c√°c t∆∞ v·∫•n vi√™n ƒëang b·∫≠n. Qu√Ω kh√°ch vui
                              l√≤ng g·ªçi tr·ª±c ti·∫øp ƒë·ªÉ ƒë∆∞·ª£c ∆∞u ti√™n ph·ª•c v·ª•.
                            </p>
                            <div className="flex gap-2">
                              <a
                                href="tel:0939941588"
                                className="flex-1 bg-[#1E3A8A] hover:bg-[#1E40AF] text-white text-xs py-2 rounded-lg font-bold flex items-center justify-center gap-1 transition-colors"
                              >
                                <PhoneCall size={12} /> MS. CHI
                              </a>
                              <a
                                href="tel:0939852511"
                                className="flex-1 bg-[#065F46] hover:bg-[#047857] text-white text-xs py-2 rounded-lg font-bold flex items-center justify-center gap-1 transition-colors"
                              >
                                <PhoneCall size={12} /> MR. TOMMY
                              </a>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>

                    {/* Input Area */}
                    <div className="p-4 bg-[#111] border-t border-white/10 flex gap-3 items-end">
                      <button
                        onClick={() => fileInputRef.current?.click()}
                        className="p-3 bg-white/5 hover:bg-white/10 rounded-xl text-white/60 hover:text-[#C69C6D] transition-colors h-[46px] w-[46px] flex items-center justify-center"
                      >
                        <ImageIcon size={20} />
                      </button>
                      <input
                        type="file"
                        ref={fileInputRef}
                        className="hidden"
                        accept="image/*"
                        onChange={(e) =>
                          e.target.files?.[0] && handleSend(e.target.files[0])
                        }
                      />
                      <div className="flex-1 bg-white/5 border border-white/10 rounded-xl flex items-center px-4 min-h-[46px] focus-within:border-[#C69C6D] transition-colors">
                        <input
                          className="flex-1 bg-transparent text-sm text-white placeholder-white/30 outline-none py-3"
                          placeholder={
                            isSending ? "ƒêang g·ª≠i..." : "Nh·∫≠p tin nh·∫Øn..."
                          }
                          value={inputMsg}
                          onChange={(e) => setInputMsg(e.target.value)}
                          onKeyDown={(e) => e.key === "Enter" && handleSend()}
                          disabled={isSending}
                        />
                        <button
                          onClick={() => handleSend()}
                          disabled={isSending}
                          className="ml-2 text-[#C69C6D] hover:text-white disabled:opacity-50 transition-colors"
                        >
                          {isSending ? (
                            <Loader2 size={20} className="animate-spin" />
                          ) : (
                            <Send size={20} />
                          )}
                        </button>
                      </div>
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Floating Toggle Button */}
        {!isOpen && (
          <button
            onClick={() => {
              playClick();
              setIsOpen(true);
            }}
            className="w-14 h-14 rounded-full flex items-center justify-center bg-[#C69C6D] text-black shadow-[0_0_30px_rgba(198,156,109,0.4)] hover:scale-110 active:scale-95 transition-all animate-bounce-slow z-[9000] border-2 border-white/20"
          >
            <MessageCircle size={28} fill="currentColor" />
            {onlineStaffCount > 0 && (
              <span className="absolute top-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-black"></span>
            )}
          </button>
        )}
      </div>
    </>
  );
}
</file>

<file path="components/PushManager.tsx">
'use client';
import React, { useEffect, useState } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import { BellRing, Loader2 } from 'lucide-react';

const VAPID_PUBLIC_KEY = process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY;

// H√†m chuy·ªÉn ƒë·ªïi key VAPID
function urlBase64ToUint8Array(base64String: string) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

export default function PushManager() {
    const { user } = useUser();
    const [isSupported, setIsSupported] = useState(false);
    const [subscription, setSubscription] = useState<PushSubscription | null>(null);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if ('serviceWorker' in navigator && 'PushManager' in window) {
            setIsSupported(true);
            registerServiceWorker();
        }
    }, []);

    const registerServiceWorker = async () => {
        try {
            const registration = await navigator.serviceWorker.register('/sw.js', {
                scope: '/',
                updateViaCache: 'none',
            });
            
            // Check n·∫øu ƒë√£ subscribe r·ªìi
            const sub = await registration.pushManager.getSubscription();
            setSubscription(sub);
        } catch (error) {
            console.error('Service Worker Error:', error);
        }
    };

    const subscribeToPush = async () => {
        if (!user || !VAPID_PUBLIC_KEY) return;
        setLoading(true);

        try {
            const registration = await navigator.serviceWorker.ready;
            
            // 1. Y√™u c·∫ßu tr√¨nh duy·ªát c·∫•p quy·ªÅn (N√≥ s·∫Ω hi·ªán popup c·ªßa Chrome/Safari)
            const sub = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
            });

            // 2. G·ª≠i v·ªÅ Server l∆∞u l·∫°i
            await fetch('/api/push/subscribe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    subscription: sub,
                    user_id: user.id,
                    user_agent: navigator.userAgent
                })
            });

            setSubscription(sub);
            alert("ƒê√£ b·∫≠t th√¥ng b√°o th√†nh c√¥ng! B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c tin t·ª©c m·ªõi nh·∫•t ngay tr√™n m√†n h√¨nh kh√≥a.");
        } catch (error) {
            console.error('Subscription failed:', error);
            alert("Vui l√≤ng ki·ªÉm tra l·∫°i quy·ªÅn th√¥ng b√°o trong c√†i ƒë·∫∑t tr√¨nh duy·ªát.");
        } finally {
            setLoading(false);
        }
    };

    // N·∫øu ch∆∞a h·ªó tr·ª£, ho·∫∑c ƒë√£ ƒëƒÉng k√Ω r·ªìi th√¨ ·∫©n
    if (!isSupported || subscription || !user) return null;

    return (
        <div className="fixed bottom-24 left-6 z-[8000] animate-in slide-in-from-left duration-500">
            <button 
                onClick={subscribeToPush}
                disabled={loading}
                className="flex items-center gap-3 px-4 py-3 bg-[#C69C6D] hover:bg-white text-black font-bold rounded-xl shadow-[0_0_20px_rgba(198,156,109,0.4)] transition-all active:scale-95 group"
            >
                <div className="bg-black/10 p-1.5 rounded-full">
                    {loading ? <Loader2 size={16} className="animate-spin"/> : <BellRing size={16} className="animate-wiggle"/>}
                </div>
                <div className="text-left">
                    <p className="text-[10px] uppercase tracking-wider opacity-70">ƒê·ª´ng b·ªè l·ª°</p>
                    <p className="text-xs font-black">B·∫¨T TH√îNG B√ÅO ƒê·∫®Y</p>
                </div>
            </button>
            <style jsx>{`
                @keyframes wiggle { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }
                .animate-wiggle { animation: wiggle 0.3s ease-in-out infinite; }
            `}</style>
        </div>
    );
}
</file>

<file path="components/RegisterForm.tsx">
"use client";

import React, { useState, useRef } from "react";
import { createClient } from "@supabase/supabase-js";
import {
  Mail,
  Phone,
  Lock,
  Eye,
  EyeOff,
  UserPlus,
  Briefcase,
  User,
  MapPin,
  CreditCard,
  Building,
  CheckCircle2,
  ShieldCheck,
  ChevronRight,
  Camera,
  Banknote,
  Clock,
  Percent,
  Image as ImageIcon,
  FileText,
} from "lucide-react";
import { compressImage } from "@/app/ThuVien/compressImage";

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

const VN_BANKS = [
  "Vietcombank",
  "VietinBank",
  "BIDV",
  "Agribank",
  "Techcombank",
  "MBBank",
  "ACB",
  "VPBank",
  "TPBank",
  "Sacombank",
  "HDBank",
  "VIB",
  "MSB",
  "SHB",
  "SeABank",
  "OCB",
  "Eximbank",
  "LienVietPostBank",
  "Nam A Bank",
  "Viet Capital Bank",
];

const PHAN_LOAI_OPTIONS = [
  "Ti·ªÅm nƒÉng",
  "M·ªõi",
  "Th√¢n thi·∫øt",
  "VIP",
  "Kh√¥ng ho·∫°t ƒë·ªông",
];

// üü¢ Helper l·∫•y ID kh√°ch v√£ng lai t·ª´ localStorage (ƒë·ªÉ merge chat)
const getGuestId = () => {
  if (typeof window === "undefined") return null;
  return localStorage.getItem("guest_chat_id");
};

interface RegisterFormProps {
  onSuccess?: () => void;
  onSwitchToLogin?: () => void;
}

export default function RegisterForm({
  onSuccess,
  onSwitchToLogin,
}: RegisterFormProps) {
  const [userType, setUserType] = useState<"nhan_su" | "khach_hang">(
    "khach_hang"
  );

  // Common Fields
  const [hoTen, setHoTen] = useState("");
  const [email, setEmail] = useState("");
  const [phone, setPhone] = useState("");
  const [password, setPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [showPassword, setShowPassword] = useState(false);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);

  // Staff Fields
  const [viTri, setViTri] = useState("");
  const [luongThang, setLuongThang] = useState<number | "">("");
  const [thuongDoanhThu, setThuongDoanhThu] = useState<number | "">("");
  const [nganHang, setNganHang] = useState("");
  const [soTaiKhoan, setSoTaiKhoan] = useState("");

  // Customer Fields
  const [diaChi, setDiaChi] = useState("");
  const [phanLoai, setPhanLoai] = useState("M·ªõi");
  const [ghiChu, setGhiChu] = useState("");

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);
  const [isUploading, setIsUploading] = useState(false);

  const fileInputRef = useRef<HTMLInputElement>(null);

  const luongTheoGio = luongThang
    ? Math.round(Number(luongThang) / 24 / 8 / 1000) * 1000
    : 0;

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
      setAvatarFile(file);
    }
  };

  const handleRegister = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);

    try {
      // 1. Validation
      if (!hoTen.trim()) throw new Error("Vui l√≤ng nh·∫≠p H·ªç v√† T√™n");
      if (!email.includes("@")) throw new Error("Email kh√¥ng h·ª£p l·ªá");
      if (phone.length < 10) throw new Error("S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá");
      if (password.length < 6) throw new Error("M·∫≠t kh·∫©u ph·∫£i t·ª´ 6 k√Ω t·ª±");
      if (password !== confirmPassword)
        throw new Error("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp");

      if (userType === "khach_hang" && !diaChi.trim())
        throw new Error("Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ");
      if (userType === "nhan_su" && !viTri.trim())
        throw new Error("Vui l√≤ng nh·∫≠p v·ªã tr√≠ mong mu·ªën");

      // 2. Check existing
      const { data: existing } = await supabase
        .from(userType)
        .select("id")
        .or(`email.eq.${email.trim()},so_dien_thoai.eq.${phone.trim()}`)
        .maybeSingle();

      if (existing) {
        throw new Error("Email ho·∫∑c S·ªë ƒëi·ªán tho·∫°i ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng.");
      }

      // 3. Upload Avatar
      let avatarUrl = null;
      if (avatarFile) {
        setIsUploading(true);
        const compressed = await compressImage(avatarFile, 0.7, 800);
        const fileName = `avatar_${Date.now()}_${avatarFile.name.replace(
          /\W/g,
          ""
        )}`;
        const { error: upErr } = await supabase.storage
          .from("avatar")
          .upload(fileName, compressed);
        if (upErr) throw upErr;

        const { data: urlData } = supabase.storage
          .from("avatar")
          .getPublicUrl(fileName);
        avatarUrl = urlData.publicUrl;
        setIsUploading(false);
      }

      // 4. Create Auth User
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email: email.trim(),
        password: password,
        options: {
          data: {
            ho_ten: hoTen,
            phone: phone,
            user_type: userType,
            waiting_approval: true,
          },
        },
      });

      if (authError) throw authError;
      if (!authData.user) throw new Error("Kh√¥ng th·ªÉ t·∫°o t√†i kho·∫£n.");

      // 5. Insert Registration Data
      const guestId = getGuestId(); // üü¢ L·∫•y ID v√£ng lai ƒë·ªÉ merge chat

      const registrationData = {
        auth_user_id: authData.user.id,
        ho_ten: hoTen.trim(),
        email: email.trim(),
        so_dien_thoai: phone.trim(),
        user_type: userType,
        hinh_anh: avatarUrl,
        details:
          userType === "nhan_su"
            ? {
                vi_tri: viTri,
                luong_thang: Number(luongThang) || 0,
                thuong_doanh_thu: Number(thuongDoanhThu) || 0,
                ngan_hang: nganHang,
                so_tai_khoan: soTaiKhoan,
              }
            : {
                dia_chi: diaChi,
                phan_loai: phanLoai,
                ghi_chu: ghiChu,
                guest_id: guestId, // üü¢ G·ª≠i k√®m guest_id l√™n DB
              },
        status: "pending",
        created_at: new Date().toISOString(),
      };

      const { error: regError } = await supabase
        .from("user_registrations")
        .insert(registrationData);

      if (regError) {
        console.warn("L·ªói l∆∞u ƒë∆°n ƒëƒÉng k√Ω:", regError);
      } else {
        // 6. Notify Staff
        fetch("/api/push/notify-staff", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: `üÜï ƒêƒÉng k√Ω m·ªõi: ${hoTen}`,
            body: `${
              userType === "nhan_su" ? "·ª®ng vi√™n" : "Kh√°ch h√†ng"
            } ${hoTen} v·ª´a ƒëƒÉng k√Ω. Vui l√≤ng duy·ªát.`,
            url: "/quan-ly/duyet-thanh-vien",
          }),
        }).catch((err) => console.error("Notify error:", err));
      }

      setSuccess(true);
      if (onSuccess) setTimeout(onSuccess, 3000);
    } catch (err: any) {
      setError(err.message || "ƒêƒÉng k√Ω th·∫•t b·∫°i");
    } finally {
      setLoading(false);
      setIsUploading(false);
    }
  };

  if (success) {
    return (
      <div className="w-full h-full flex flex-col items-center justify-center p-8 text-center animate-in zoom-in duration-300">
        <div className="w-20 h-20 bg-green-500/20 rounded-full flex items-center justify-center mb-6">
          <CheckCircle2 size={40} className="text-green-400" />
        </div>
        <h2 className="text-2xl font-bold text-[#C69C6D] mb-2">
          ƒêƒÉng K√Ω Th√†nh C√¥ng!
        </h2>
        <p className="text-white/70 mb-6 max-w-sm">
          H·ªì s∆° c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i. Vui l√≤ng ch·ªù admin x√°c nh·∫≠n qua Email.
        </p>
        <button
          onClick={onSwitchToLogin}
          className="px-6 py-3 bg-white/10 hover:bg-white/20 rounded-xl text-white font-bold transition-all"
        >
          Quay l·∫°i ƒêƒÉng Nh·∫≠p
        </button>
      </div>
    );
  }

  return (
    // üü¢ Fix l·ªói cu·ªôn tr√™n mobile b·∫±ng h-[100dvh]
    <div className="flex flex-col lg:flex-row w-full h-[100dvh] lg:h-full bg-[#0a0a0a] overflow-hidden">
      {/* C·ªòT TR√ÅI: QUY TR√åNH (·∫®n tr√™n mobile) */}
      <div className="hidden lg:flex w-1/3 bg-[#111] border-r border-[#C69C6D]/30 p-6 flex-col shrink-0">
        <h3 className="text-lg font-bold text-[#C69C6D] uppercase tracking-widest mb-6 flex items-center gap-2">
          <ShieldCheck size={20} /> Quy Tr√¨nh
        </h3>

        <div className="flex-1 space-y-8 relative pl-2">
          <div className="absolute left-[19px] top-2 bottom-10 w-[1px] bg-white/10 z-0"></div>
          <StepItem
            number="1"
            title="ƒêƒÉng K√Ω"
            desc="ƒêi·ªÅn th√¥ng tin h·ªì s∆°."
            active={true}
          />
          <StepItem
            number="2"
            title="X√©t Duy·ªát"
            desc="Admin ki·ªÉm tra v√† ph√¢n quy·ªÅn."
          />
          <StepItem
            number="3"
            title="S·ª≠ D·ª•ng"
            desc="ƒêƒÉng nh·∫≠p v√† b·∫Øt ƒë·∫ßu l√†m vi·ªác."
          />
        </div>

        <div className="mt-auto pt-6 border-t border-white/10">
          <p className="text-white/40 text-xs italic">
            * Cam k·∫øt b·∫£o m·∫≠t th√¥ng tin tuy·ªát ƒë·ªëi.
          </p>
        </div>
      </div>

      {/* C·ªòT PH·∫¢I: FORM NH·∫¨P LI·ªÜU */}
      <div className="w-full lg:w-2/3 flex flex-col h-full bg-[#0a0a0a] min-h-0">
        {/* Header c·ªë ƒë·ªãnh */}
        <div className="shrink-0 px-6 py-4 border-b border-white/10 flex items-center justify-between bg-[#0a0a0a]/90 backdrop-blur z-10">
          <h2 className="text-xl font-bold text-white">ƒêƒÉng K√Ω T√†i Kho·∫£n</h2>
          {onSwitchToLogin && (
            <button
              onClick={onSwitchToLogin}
              className="text-xs text-[#C69C6D] hover:underline flex items-center gap-1"
            >
              ƒêƒÉng nh·∫≠p <ChevronRight size={14} />
            </button>
          )}
        </div>

        {/* Form Body - Cu·ªôn ƒë∆∞·ª£c */}
        <div className="flex-1 overflow-y-auto p-6 custom-scrollbar pb-32">
          {error && (
            <div className="bg-red-900/30 border border-red-500/50 p-3 rounded-lg mb-6 text-red-200 text-sm flex items-start gap-2 animate-in fade-in slide-in-from-top-2">
              <ShieldCheck size={16} className="mt-0.5 shrink-0" />
              <span>{error}</span>
            </div>
          )}

          <form onSubmit={handleRegister} className="space-y-6">
            {/* 1. Ch·ªçn Lo·∫°i & Avatar */}
            <div className="flex flex-col sm:flex-row gap-6">
              {/* Avatar Upload */}
              <div className="shrink-0 flex flex-col items-center gap-2">
                <div
                  onClick={() => fileInputRef.current?.click()}
                  className="w-24 h-24 rounded-full border-2 border-dashed border-white/20 hover:border-[#C69C6D] flex items-center justify-center cursor-pointer overflow-hidden bg-white/5 relative group transition-all"
                >
                  {avatarPreview ? (
                    <img
                      src={avatarPreview}
                      alt="Avatar"
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <Camera
                      className="text-white/30 group-hover:text-[#C69C6D]"
                      size={32}
                    />
                  )}
                  <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                    <ImageIcon size={20} className="text-white" />
                  </div>
                </div>
                <span className="text-[10px] text-white/40 uppercase font-bold">
                  ·∫¢nh ƒë·∫°i di·ªán
                </span>
                <input
                  type="file"
                  ref={fileInputRef}
                  className="hidden"
                  accept="image/*"
                  onChange={handleFileChange}
                />
              </div>

              {/* Lo·∫°i t√†i kho·∫£n */}
              <div className="flex-1">
                <label className="block text-white/60 text-xs font-bold uppercase mb-2">
                  B·∫°n l√† ai?
                </label>
                <div className="grid grid-cols-2 gap-3 h-[88px]">
                  <TypeButton
                    active={userType === "khach_hang"}
                    onClick={() => setUserType("khach_hang")}
                    icon={User}
                    label="Kh√°ch H√†ng"
                  />
                  <TypeButton
                    active={userType === "nhan_su"}
                    onClick={() => setUserType("nhan_su")}
                    icon={Briefcase}
                    label="Nh√¢n S·ª±"
                  />
                </div>
              </div>
            </div>

            {/* 2. Th√¥ng tin chung */}
            <div className="space-y-4">
              <p className="text-[#C69C6D] text-xs font-bold uppercase border-b border-white/10 pb-1">
                Th√¥ng tin ƒëƒÉng nh·∫≠p
              </p>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <InputGroup label="H·ªç v√† T√™n" icon={User} required>
                  <input
                    className="w-full bg-transparent outline-none text-white text-sm"
                    placeholder="Nguy·ªÖn VƒÉn A"
                    value={hoTen}
                    onChange={(e) => setHoTen(e.target.value)}
                  />
                </InputGroup>
                <InputGroup label="S·ªë ƒêi·ªán Tho·∫°i" icon={Phone} required>
                  <input
                    className="w-full bg-transparent outline-none text-white text-sm"
                    placeholder="09..."
                    type="tel"
                    value={phone}
                    onChange={(e) => setPhone(e.target.value)}
                  />
                </InputGroup>
              </div>
              <InputGroup label="Email" icon={Mail} required>
                <input
                  className="w-full bg-transparent outline-none text-white text-sm"
                  placeholder="email@example.com"
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                />
              </InputGroup>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <InputGroup label="M·∫≠t Kh·∫©u" icon={Lock} required>
                  <div className="relative w-full">
                    <input
                      className="w-full bg-transparent outline-none text-white text-sm pr-8"
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      type={showPassword ? "text" : "password"}
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                    />
                    <button
                      type="button"
                      onClick={() => setShowPassword(!showPassword)}
                      className="absolute right-0 top-1/2 -translate-y-1/2 text-white/40 hover:text-white"
                    >
                      {showPassword ? <EyeOff size={14} /> : <Eye size={14} />}
                    </button>
                  </div>
                </InputGroup>
                <InputGroup label="X√°c Nh·∫≠n" icon={Lock} required>
                  <input
                    className="w-full bg-transparent outline-none text-white text-sm"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    type="password"
                    value={confirmPassword}
                    onChange={(e) => setConfirmPassword(e.target.value)}
                  />
                </InputGroup>
              </div>
            </div>

            {/* 3. Fields ri√™ng */}
            {userType === "khach_hang" && (
              <div className="space-y-4 animate-in fade-in slide-in-from-right-4 duration-300">
                <p className="text-[#C69C6D] text-xs font-bold uppercase border-b border-white/10 pb-1">
                  H·ªì s∆° kh√°ch h√†ng
                </p>
                <InputGroup label="ƒê·ªãa Ch·ªâ Giao H√†ng" icon={MapPin} required>
                  <input
                    className="w-full bg-transparent outline-none text-white text-sm"
                    placeholder="S·ªë nh√†, ƒë∆∞·ªùng..."
                    value={diaChi}
                    onChange={(e) => setDiaChi(e.target.value)}
                  />
                </InputGroup>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <InputGroup label="Ph√¢n Lo·∫°i" icon={Briefcase}>
                    <select
                      className="w-full bg-transparent outline-none text-white text-sm appearance-none"
                      value={phanLoai}
                      onChange={(e) => setPhanLoai(e.target.value)}
                    >
                      {PHAN_LOAI_OPTIONS.map((opt) => (
                        <option key={opt} value={opt} className="bg-[#111]">
                          {opt}
                        </option>
                      ))}
                    </select>
                  </InputGroup>
                  <InputGroup label="Ghi Ch√∫" icon={FileText}>
                    <input
                      className="w-full bg-transparent outline-none text-white text-sm"
                      placeholder="Ghi ch√∫ th√™m..."
                      value={ghiChu}
                      onChange={(e) => setGhiChu(e.target.value)}
                    />
                  </InputGroup>
                </div>
              </div>
            )}

            {userType === "nhan_su" && (
              <div className="space-y-4 animate-in fade-in slide-in-from-right-4 duration-300">
                <p className="text-[#C69C6D] text-xs font-bold uppercase border-b border-white/10 pb-1">
                  H·ªì s∆° nh√¢n s·ª±
                </p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <InputGroup
                    label="V·ªã Tr√≠ / Ch·ª©c V·ª•"
                    icon={Briefcase}
                    required
                  >
                    <input
                      className="w-full bg-transparent outline-none text-white text-sm"
                      placeholder="VD: Sales..."
                      value={viTri}
                      onChange={(e) => setViTri(e.target.value)}
                    />
                  </InputGroup>
                  <InputGroup label="Th∆∞·ªüng Doanh S·ªë (%)" icon={Percent}>
                    <input
                      type="number"
                      className="w-full bg-transparent outline-none text-white text-sm"
                      placeholder="0 - 30"
                      value={thuongDoanhThu}
                      onChange={(e) =>
                        setThuongDoanhThu(Number(e.target.value))
                      }
                      max={30}
                    />
                  </InputGroup>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <InputGroup label="L∆∞∆°ng C·ª©ng (VNƒê)" icon={Banknote}>
                    <input
                      type="number"
                      className="w-full bg-transparent outline-none text-white text-sm"
                      placeholder="10,000,000"
                      value={luongThang}
                      onChange={(e) => setLuongThang(Number(e.target.value))}
                    />
                  </InputGroup>
                  <InputGroup label="L∆∞∆°ng Theo Gi·ªù (Auto)" icon={Clock}>
                    <input
                      className="w-full bg-transparent outline-none text-white/50 text-sm"
                      readOnly
                      value={
                        luongTheoGio
                          ? new Intl.NumberFormat("vi-VN").format(
                              luongTheoGio
                            ) + " ƒë/h"
                          : "---"
                      }
                    />
                  </InputGroup>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <InputGroup label="Ng√¢n H√†ng" icon={Building}>
                    <select
                      className="w-full bg-transparent outline-none text-white text-sm appearance-none"
                      value={nganHang}
                      onChange={(e) => setNganHang(e.target.value)}
                    >
                      <option value="" className="bg-[#111]">
                        -- Ch·ªçn --
                      </option>
                      {VN_BANKS.map((bank) => (
                        <option key={bank} value={bank} className="bg-[#111]">
                          {bank}
                        </option>
                      ))}
                    </select>
                  </InputGroup>
                  <InputGroup label="S·ªë T√†i Kho·∫£n" icon={CreditCard}>
                    <input
                      className="w-full bg-transparent outline-none text-white text-sm"
                      placeholder="STK..."
                      value={soTaiKhoan}
                      onChange={(e) => setSoTaiKhoan(e.target.value)}
                    />
                  </InputGroup>
                </div>
              </div>
            )}
          </form>
        </div>

        {/* Footer Action - C·ªë ƒë·ªãnh d∆∞·ªõi c√πng */}
        <div className="shrink-0 p-6 border-t border-white/10 bg-[#0a0a0a] z-20 absolute bottom-0 left-0 right-0">
          <button
            onClick={handleRegister}
            disabled={loading || isUploading}
            className="w-full py-3.5 bg-[#C69C6D] hover:bg-white text-black font-bold uppercase tracking-widest rounded-xl transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed shadow-[0_0_20px_rgba(198,156,109,0.3)] flex items-center justify-center gap-2"
          >
            {loading || isUploading ? (
              <div className="w-5 h-5 border-2 border-black border-t-transparent rounded-full animate-spin" />
            ) : (
              <UserPlus size={18} />
            )}
            G·ª≠i ƒê∆°n ƒêƒÉng K√Ω
          </button>
        </div>
      </div>

      <style jsx global>{`
        .custom-scrollbar::-webkit-scrollbar {
          width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: #111;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: #333;
          border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background: #c69c6d;
        }
      `}</style>
    </div>
  );
}

// Sub-components
function StepItem({ number, title, desc, active }: any) {
  return (
    <div className="relative flex gap-4 z-10">
      <div
        className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm border-2 shrink-0 transition-colors ${
          active
            ? "bg-[#C69C6D] border-[#C69C6D] text-black"
            : "bg-[#111] border-white/20 text-white/40"
        }`}
      >
        {number}
      </div>
      <div>
        <h4
          className={`text-sm font-bold ${
            active ? "text-white" : "text-white/60"
          }`}
        >
          {title}
        </h4>
        <p className="text-xs text-white/40 mt-1 leading-relaxed">{desc}</p>
      </div>
    </div>
  );
}

function TypeButton({ active, onClick, icon: Icon, label }: any) {
  return (
    <button
      type="button"
      onClick={onClick}
      className={`p-4 rounded-xl border flex flex-col items-center justify-center transition-all h-full ${
        active
          ? "bg-[#C69C6D]/20 border-[#C69C6D]"
          : "bg-white/5 border-white/10 hover:bg-white/10"
      }`}
    >
      <Icon
        size={24}
        className={`mb-2 ${active ? "text-[#C69C6D]" : "text-white/50"}`}
      />
      <div
        className={`font-bold text-sm ${
          active ? "text-white" : "text-white/70"
        }`}
      >
        {label}
      </div>
    </button>
  );
}

function InputGroup({ label, icon: Icon, required, children }: any) {
  return (
    <div className="group w-full">
      <label className="block text-white/60 text-[10px] font-bold uppercase mb-1.5 ml-1">
        {label} {required && <span className="text-red-400">*</span>}
      </label>
      <div className="flex items-center gap-3 px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus-within:border-[#C69C6D] focus-within:bg-black transition-all">
        <Icon
          size={16}
          className="text-white/30 group-focus-within:text-[#C69C6D] transition-colors shrink-0"
        />
        {children}
      </div>
    </div>
  );
}
</file>

<file path="components/StaffPresence.tsx">
"use client";
import { useEffect } from "react";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { useUser } from "@/app/ThuVien/UserContext";

export default function StaffPresence() {
  const { user } = useUser();

  useEffect(() => {
    // Ch·ªâ ch·∫°y n·∫øu l√† nh√¢n s·ª±
    if (!user || user.userType !== "nhan_su") return;

    // X√°c ƒë·ªãnh role chu·∫©n ƒë·ªÉ g·ª≠i ƒëi
    // ∆Øu ti√™n vi_tri_normalized, n·∫øu kh√¥ng c√≥ th√¨ l·∫•y role t·ª´ context
    const roleToSend =
      (user as any).vi_tri_normalized || user.role || "nhan_su";

    // T·∫°o k√™nh 'online-users'
    const channel = supabase.channel("online-users", {
      config: {
        presence: {
          key: user.id, // ID ƒë·ªãnh danh duy nh·∫•t
        },
      },
    });

    channel
      .on("presence", { event: "sync" }, () => {
        // Debug ch∆°i th√¥i
        // console.log('üì° Staff signal sent:', user.ho_ten);
      })
      .subscribe(async (status) => {
        if (status === "SUBSCRIBED") {
          // G·ª≠i th√¥ng tin nh√¢n vi√™n l√™n k√™nh
          await channel.track({
            id: user.id,
            name: user.ho_ten,
            role: roleToSend, // Quan tr·ªçng: G·ª≠i role chu·∫©n ƒë·ªÉ b√™n kia l·ªçc
            online_at: new Date().toISOString(),
          });
        }
      });

    return () => {
      supabase.removeChannel(channel);
    };
  }, [user]);

  return null;
}
</file>

<file path="components/ThanhPhongChucNang.tsx">
"use client";
import React, { useState } from "react";
import { Check, List } from "lucide-react";

interface FunctionItem {
  id: string;
  label: string;
  icon: React.ElementType;
}

interface Props {
  tenPhong: string;
  functions: FunctionItem[];
  activeFunction: string;
  onFunctionChange: (id: string) => void;
}

export default function ThanhPhongChucNang({
  tenPhong,
  functions,
  activeFunction,
  onFunctionChange,
}: Props) {
  const [showDropdown, setShowDropdown] = useState(false);

  // T√¨m ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c ch·ªçn
  const activeItem = functions.find((f) => f.id === activeFunction);

  return (
    // justify-between: ƒê·∫©y T√™n Ph√≤ng sang tr√°i, Ch·ª©c NƒÉng sang ph·∫£i
    <div className="flex-none z-30 w-full h-[50px] bg-[#080808] border-b border-[#C69C6D]/20 shadow-md flex items-center justify-between px-4 md:px-6">
      {/* 1. T√äN PH√íNG (B√äN TR√ÅI - Canh s√°t l·ªÅ tr√°i) */}
      <div className="shrink-0 bg-gradient-to-r from-[#C69C6D] to-[#B58B5D] text-black px-4 py-1.5 rounded-l-md rounded-r-xl transform skew-x-[-10deg] shadow-[0_0_15px_rgba(198,156,109,0.3)]">
        <h1 className="text-xs md:text-sm font-black uppercase tracking-[0.15em] skew-x-[10deg] whitespace-nowrap">
          {tenPhong}
        </h1>
      </div>

      {/* 2. TR√åNH CH·ªåN CH·ª®C NƒÇNG (B√äN PH·∫¢I - Canh s√°t l·ªÅ ph·∫£i) */}
      <div className="relative flex items-center">
        <button
          onClick={() => setShowDropdown(!showDropdown)}
          className="flex items-center gap-3 group outline-none text-right"
        >
          {/* T√™n ch·ª©c nƒÉng - Ch·ªØ to, kh√¥ng vi·ªÅn */}
          <span className="text-[#C69C6D] font-black text-base md:text-lg uppercase tracking-wide truncate max-w-[180px] sm:max-w-xs">
            {activeItem?.label}
          </span>

          {/* N√∫t danh s√°ch (Icon) - C√πng m√†u v√†ng */}
          <List
            size={24}
            strokeWidth={2.5}
            className={`transition-transform duration-300 ${
              showDropdown
                ? "rotate-90 text-white"
                : "text-[#C69C6D] group-hover:text-white"
            }`}
          />
        </button>

        {/* MENU X·ªî XU·ªêNG - CƒÉn ph·∫£i (right-0) */}
        {showDropdown && (
          <>
            <div
              className="fixed inset-0 z-40"
              onClick={() => setShowDropdown(false)}
            />

            <div className="absolute top-full right-0 mt-3 w-[240px] bg-[#1a1a1a] rounded-lg shadow-[0_20px_50px_rgba(0,0,0,0.9)] overflow-hidden z-50 animate-in fade-in slide-in-from-top-2 py-2 border border-white/5">
              {functions.map((func) => {
                const Icon = func.icon;
                const isActive = func.id === activeFunction;
                return (
                  <button
                    key={func.id}
                    onClick={() => {
                      onFunctionChange(func.id);
                      setShowDropdown(false);
                    }}
                    className={`
                                            w-full flex items-center justify-end gap-3 px-4 py-3 text-xs font-bold uppercase tracking-wide transition-all text-right
                                            ${
                                              isActive
                                                ? "bg-[#C69C6D] text-black"
                                                : "text-white/60 hover:bg-white/5 hover:text-white hover:pr-6"
                                            }
                                        `}
                  >
                    <span className="flex-1 truncate">{func.label}</span>
                    <Icon size={16} strokeWidth={isActive ? 2.5 : 2} />
                    {isActive && (
                      <Check
                        size={14}
                        strokeWidth={3}
                        className="shrink-0 order-first"
                      />
                    )}
                  </button>
                );
              })}
            </div>
          </>
        )}
      </div>
    </div>
  );
}
</file>

<file path="components/TuVanKhachHang.tsx">
"use client";

import React, { useState, useEffect, useRef, useMemo } from "react";
import {
  MessageSquare,
  X,
  Send,
  User,
  AlertCircle,
  Shield,
  Briefcase,
  Image as ImageIcon,
  Loader2,
  BellRing,
  UserPlus,
  Search,
  MoreVertical,
  Check,
  Circle,
} from "lucide-react";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { useUser } from "@/app/ThuVien/UserContext";
import { compressImage } from "@/app/ThuVien/compressImage";

const formatTime = (iso: string) => {
  if (!iso) return "";
  const d = new Date(iso);
  return `${d.getHours()}:${String(d.getMinutes()).padStart(2, "0")}`;
};

export default function TuVanKhachHang() {
  const { user } = useUser();

  // --- STATE UI ---
  const [isOpen, setIsOpen] = useState(false);
  const [activeTab, setActiveTab] = useState<"waiting" | "my_chats" | "all">(
    "waiting"
  );
  const [showInviteModal, setShowInviteModal] = useState(false);

  // --- STATE DATA ---
  const [allSessions, setAllSessions] = useState<any[]>([]);
  const [staffList, setStaffList] = useState<any[]>([]);
  const [onlineStaffIds, setOnlineStaffIds] = useState<Set<string>>(new Set());

  // --- STATE CHAT ---
  const [selectedSession, setSelectedSession] = useState<any>(null);
  const [messages, setMessages] = useState<any[]>([]);
  const [inputMsg, setInputMsg] = useState("");
  const [isSending, setIsSending] = useState(false);
  const [isLoadingMessages, setIsLoadingMessages] = useState(false);

  // Refs
  const ringtoneRef = useRef<HTMLAudioElement | null>(null);
  const scrollRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const isManager =
    user && ["admin", "quanly", "boss"].includes(user.role || "");

  // 1. INIT SOUND & STAFF LIST (ƒê√É S·ª¨A L·∫†I QUERY)
  useEffect(() => {
    if (typeof window !== "undefined") {
      ringtoneRef.current = new Audio("/sounds/ring.mp3");
      ringtoneRef.current.loop = true;
    }

    // üü¢ LOAD DANH S√ÅCH NH√ÇN VI√äN ƒê·ªÇ M·ªúI (FIXED)
    const fetchStaff = async () => {
      const { data, error } = await supabase
        .from("nhan_su")
        .select("id, ho_ten, hinh_anh, vi_tri, vi_tri_normalized")
        .eq("trang_thai", "dang_lam_viec")
        // Ch·ªâ l·∫•y nh·ªØng ng∆∞·ªùi c√≥ vai tr√≤ h·ªó tr·ª£
        .in("vi_tri_normalized", ["admin", "quanly", "sales"]);

      if (error) {
        console.error("L·ªói l·∫•y danh s√°ch nh√¢n vi√™n:", error);
      } else if (data) {
        setStaffList(data);
      }
    };

    if (user) fetchStaff();
  }, [user]);

  // 2. REALTIME ONLINE STATUS
  useEffect(() => {
    if (!user) return;
    const channel = supabase.channel("online_staff_tracking");
    channel
      .on("presence", { event: "sync" }, () => {
        const state = channel.presenceState();
        const ids = new Set<string>();
        Object.values(state).forEach((presences: any) => {
          presences.forEach((p: any) => {
            if (p.user_id) ids.add(p.user_id);
          });
        });
        setOnlineStaffIds(ids);
      })
      .subscribe(async (status) => {
        if (status === "SUBSCRIBED") {
          await channel.track({
            user_id: user.id,
            online_at: new Date().toISOString(),
          });
        }
      });
    return () => {
      supabase.removeChannel(channel);
    };
  }, [user]);

  // 3. LOAD SESSIONS & SUBSCRIBE
  useEffect(() => {
    if (!user) return;

    const fetchSessions = async () => {
      const { data } = await supabase
        .from("tu_van_sessions")
        .select("*")
        .neq("trang_thai", "ket_thuc")
        .order("cap_nhat_luc", { ascending: false });
      if (data) setAllSessions(data);
    };
    fetchSessions();

    const channel = supabase
      .channel("staff_chat_global")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "tu_van_sessions" },
        (payload) => {
          if (payload.eventType === "INSERT") {
            setAllSessions((prev) => [payload.new, ...prev]);
          } else if (payload.eventType === "UPDATE") {
            setAllSessions((prev) =>
              prev.map((s) => (s.id === payload.new.id ? payload.new : s))
            );
            if (selectedSession?.id === payload.new.id) {
              setSelectedSession(payload.new);
            }
          }
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [user, selectedSession?.id]);

  // 4. LOAD MESSAGES
  useEffect(() => {
    if (!selectedSession) return;

    setIsLoadingMessages(true);
    const fetchMsgs = async () => {
      const { data, error } = await supabase
        .from("tu_van_messages")
        .select("*")
        .eq("session_id", selectedSession.id)
        .order("tao_luc", { ascending: true });

      if (!error && data) {
        setMessages(data);
        scrollToBottom();
      }
      setIsLoadingMessages(false);
    };
    fetchMsgs();

    const isMine =
      selectedSession.nhan_su_phu_trach_id === user?.id ||
      (selectedSession.ho_tro_vien_ids &&
        selectedSession.ho_tro_vien_ids.includes(user?.id));
    if (
      isMine &&
      !selectedSession.is_read &&
      selectedSession.last_sender_type === "customer"
    ) {
      supabase.rpc("mark_session_as_read", {
        p_session_id: selectedSession.id,
      });
    }

    const channel = supabase
      .channel(`room_${selectedSession.id}`)
      .on(
        "postgres_changes",
        {
          event: "INSERT",
          schema: "public",
          table: "tu_van_messages",
          filter: `session_id=eq.${selectedSession.id}`,
        },
        (payload) => {
          setMessages((prev) => [...prev, payload.new]);
          scrollToBottom();
          if (!payload.new.la_nhan_vien) {
            supabase.rpc("mark_session_as_read", {
              p_session_id: selectedSession.id,
            });
          }
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [selectedSession?.id]);

  const scrollToBottom = () => {
    setTimeout(() => {
      if (scrollRef.current)
        scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }, 100);
  };

  // --- LOGIC PH√ÇN LO·∫†I & BADGE ---
  const displayedSessions = useMemo(() => {
    if (!user) return [];
    if (activeTab === "waiting")
      return allSessions.filter((s) => !s.nhan_su_phu_trach_id);
    if (activeTab === "my_chats")
      return allSessions.filter(
        (s) =>
          s.nhan_su_phu_trach_id === user.id ||
          (s.ho_tro_vien_ids && s.ho_tro_vien_ids.includes(user.id))
      );
    return allSessions.filter((s) => s.nhan_su_phu_trach_id);
  }, [allSessions, activeTab, user]);

  const badgeCount = useMemo(() => {
    if (!user) return 0;
    const waiting = allSessions.filter((s) => !s.nhan_su_phu_trach_id).length;
    const myUnread = allSessions.filter(
      (s) =>
        (s.nhan_su_phu_trach_id === user.id ||
          (s.ho_tro_vien_ids && s.ho_tro_vien_ids.includes(user.id))) &&
        s.is_read === false &&
        s.last_sender_type === "customer"
    ).length;
    return waiting + myUnread;
  }, [allSessions, user]);

  useEffect(() => {
    if (badgeCount > 0 && !isOpen) ringtoneRef.current?.play().catch(() => {});
    else {
      ringtoneRef.current?.pause();
      if (ringtoneRef.current) ringtoneRef.current.currentTime = 0;
    }
  }, [badgeCount, isOpen]);

  // --- ACTIONS ---
  const handleClaim = async () => {
    if (!selectedSession || !user) return;
    const { data: check } = await supabase
      .from("tu_van_sessions")
      .select("nhan_su_phu_trach_id")
      .eq("id", selectedSession.id)
      .single();
    if (check?.nhan_su_phu_trach_id) {
      alert("ƒê√£ c√≥ ng∆∞·ªùi nh·∫≠n!");
      return;
    }
    await supabase
      .from("tu_van_sessions")
      .update({
        nhan_su_phu_trach_id: user.id,
        trang_thai: "dang_tu_van",
        ho_tro_vien_ids: [],
      })
      .eq("id", selectedSession.id);
    setActiveTab("my_chats");
  };

  const handleSend = async (file?: File) => {
    if ((!inputMsg.trim() && !file) || !selectedSession || !user) return;
    if (!selectedSession.nhan_su_phu_trach_id) {
      if (!confirm("Ti·∫øp nh·∫≠n kh√°ch n√†y?")) return;
      await handleClaim();
    }
    setIsSending(true);
    const text = inputMsg;
    setInputMsg("");
    try {
      let imageUrl = null;
      if (file) {
        const compressed = await compressImage(file, 0.7, 1200);
        const fileName = `staff_chat_${Date.now()}_${file.name}`;
        const { error } = await supabase.storage
          .from("images")
          .upload(fileName, compressed);
        if (!error)
          imageUrl = supabase.storage.from("images").getPublicUrl(fileName)
            .data.publicUrl;
      }
      await supabase.from("tu_van_messages").insert({
        session_id: selectedSession.id,
        nguoi_gui_id: user.id,
        la_nhan_vien: true,
        noi_dung: text,
        hinh_anh: imageUrl,
      });
    } finally {
      setIsSending(false);
      scrollToBottom();
    }
  };

  const handleInvite = async (staffId: string) => {
    // G·ªçi RPC ƒë·ªÉ add staffId v√†o m·∫£ng ho_tro_vien_ids
    const { error } = await supabase.rpc("invite_staff_to_session", {
      p_session_id: selectedSession.id,
      p_staff_id: staffId,
    });

    if (error) {
      console.error("L·ªói m·ªùi:", error);
      alert("Kh√¥ng th·ªÉ m·ªùi. Vui l√≤ng th·ª≠ l·∫°i.");
    } else {
      setShowInviteModal(false);
      alert("ƒê√£ th√™m v√†o nh√≥m chat!");
    }
  };

  if (!user || user.userType !== "nhan_su") return null;
  const UserIcon = isManager ? Shield : Briefcase;

  return (
    <>
      <div className="fixed bottom-6 left-6 z-[9000]">
        <button
          onClick={() => setIsOpen(!isOpen)}
          className={`group relative w-16 h-16 rounded-full flex items-center justify-center shadow-2xl transition-all border-2 ${
            badgeCount > 0 && !isOpen
              ? "bg-red-600 border-white animate-bounce"
              : "bg-[#C69C6D] border-[#C69C6D] text-black hover:scale-110"
          }`}
        >
          {badgeCount > 0 && !isOpen ? (
            <BellRing size={32} className="text-white" />
          ) : isOpen ? (
            <X size={28} />
          ) : (
            <User size={32} />
          )}
          {!isOpen && badgeCount > 0 && (
            <span className="absolute -top-2 -right-2 w-7 h-7 bg-white text-red-600 border-2 border-red-600 rounded-full flex items-center justify-center text-xs font-black">
              {badgeCount}
            </span>
          )}
        </button>
      </div>

      {isOpen && (
        <div className="fixed inset-4 md:inset-10 z-[8999] bg-[#0a0a0a] border border-[#C69C6D]/30 rounded-2xl shadow-2xl flex overflow-hidden animate-in zoom-in-95 duration-200 flex-col md:flex-row">
          {/* C·ªòT TR√ÅI: LIST */}
          <div className="w-full md:w-[350px] border-r border-white/10 flex flex-col bg-[#111]">
            <div className="p-4 border-b border-white/10 bg-[#161616]">
              <div className="flex items-center gap-3 mb-4">
                <div className="w-10 h-10 rounded-full bg-[#C69C6D]/20 flex items-center justify-center text-[#C69C6D]">
                  <UserIcon size={20} />
                </div>
                <div>
                  <div className="font-bold text-white uppercase">
                    {user.ho_ten}
                  </div>
                  <div className="text-xs text-gray-400">Tr·ª±c tuy·∫øn</div>
                </div>
              </div>
              <div className="flex bg-black p-1 rounded-lg border border-white/10">
                <button
                  onClick={() => setActiveTab("waiting")}
                  className={`flex-1 py-2 text-xs font-bold rounded ${
                    activeTab === "waiting"
                      ? "bg-red-600 text-white"
                      : "text-gray-400 hover:text-white"
                  }`}
                >
                  CH·ªú (
                  {allSessions.filter((s) => !s.nhan_su_phu_trach_id).length})
                </button>
                <button
                  onClick={() => setActiveTab("my_chats")}
                  className={`flex-1 py-2 text-xs font-bold rounded ${
                    activeTab === "my_chats"
                      ? "bg-[#C69C6D] text-black"
                      : "text-gray-400 hover:text-white"
                  }`}
                >
                  C·ª¶A T√îI
                </button>
                {isManager && (
                  <button
                    onClick={() => setActiveTab("all")}
                    className={`flex-1 py-2 text-xs font-bold rounded ${
                      activeTab === "all"
                        ? "bg-blue-600 text-white"
                        : "text-gray-400 hover:text-white"
                    }`}
                  >
                    GI√ÅM S√ÅT
                  </button>
                )}
              </div>
            </div>

            <div className="flex-1 overflow-y-auto custom-scrollbar bg-[#0a0a0a]">
              {displayedSessions.map((s) => {
                const isUnread =
                  activeTab === "my_chats" &&
                  !s.is_read &&
                  s.last_sender_type === "customer";
                return (
                  <div
                    key={s.id}
                    onClick={() => setSelectedSession(s)}
                    className={`p-4 border-b border-white/5 cursor-pointer hover:bg-white/5 relative ${
                      selectedSession?.id === s.id ? "bg-white/10" : ""
                    } ${isUnread ? "bg-[#C69C6D]/10" : ""}`}
                  >
                    {isUnread && (
                      <div className="absolute top-4 right-4 w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_#22c55e]"></div>
                    )}
                    <div className="flex justify-between mb-1">
                      <span
                        className={`font-bold text-sm ${
                          isUnread ? "text-[#C69C6D]" : "text-white"
                        }`}
                      >
                        {s.ten_hien_thi}
                      </span>
                      <span className="text-[10px] text-gray-500">
                        {formatTime(s.cap_nhat_luc)}
                      </span>
                    </div>
                    <div
                      className={`text-xs truncate ${
                        isUnread ? "text-white font-bold" : "text-gray-400"
                      }`}
                    >
                      {s.last_sender_type === "staff" ? "B·∫°n: " : ""}{" "}
                      {s.tin_nhan_cuoi || "..."}
                    </div>
                  </div>
                );
              })}
              {displayedSessions.length === 0 && (
                <div className="p-8 text-center text-gray-600 text-sm">
                  Kh√¥ng c√≥ d·ªØ li·ªáu
                </div>
              )}
            </div>
          </div>

          {/* C·ªòT PH·∫¢I: CHAT */}
          <div className="flex-1 flex flex-col bg-[#050505] relative min-w-0">
            {selectedSession ? (
              <>
                <div className="h-16 border-b border-white/10 flex justify-between items-center px-6 bg-[#161616] shrink-0">
                  <div>
                    <h3 className="font-bold text-white">
                      {selectedSession.ten_hien_thi}
                    </h3>
                    <div className="flex items-center gap-2 text-xs text-gray-400">
                      <span>
                        {selectedSession.nhan_su_phu_trach_id
                          ? selectedSession.nhan_su_phu_trach_id === user.id
                            ? "ƒêang chat v·ªõi b·∫°n"
                            : "ƒê·ªìng nghi·ªáp ƒëang chat"
                          : "Ch∆∞a ai nh·∫≠n"}
                      </span>
                      {selectedSession.ho_tro_vien_ids?.length > 0 && (
                        <span className="bg-blue-900/50 text-blue-300 px-2 rounded-full text-[10px]">
                          C√≥ h·ªó tr·ª£
                        </span>
                      )}
                    </div>
                  </div>
                  <div className="flex gap-3">
                    {!selectedSession.nhan_su_phu_trach_id ? (
                      <button
                        onClick={handleClaim}
                        className="px-4 py-2 bg-[#C69C6D] hover:bg-white text-black font-bold text-xs rounded animate-pulse"
                      >
                        TI·∫æP NH·∫¨N
                      </button>
                    ) : (
                      // üü¢ N√öT M·ªúI ƒê·ªíNG NGHI·ªÜP: Ch·ªâ hi·ªán cho ng∆∞·ªùi ph·ª• tr√°ch ho·∫∑c Admin
                      (selectedSession.nhan_su_phu_trach_id === user.id ||
                        isManager) && (
                        <button
                          onClick={() => setShowInviteModal(true)}
                          className="p-2 bg-white/5 hover:bg-white/20 rounded-full text-white"
                          title="M·ªùi ƒë·ªìng nghi·ªáp"
                        >
                          <UserPlus size={20} />
                        </button>
                      )
                    )}
                  </div>
                </div>

                <div
                  className="flex-1 overflow-y-auto p-6 space-y-4 bg-black/50"
                  ref={scrollRef}
                >
                  {isLoadingMessages ? (
                    <div className="flex justify-center pt-10">
                      <Loader2
                        className="animate-spin text-[#C69C6D]"
                        size={30}
                      />
                    </div>
                  ) : (
                    messages.map((m) => (
                      <div
                        key={m.id}
                        className={`flex ${
                          m.la_nhan_vien ? "justify-end" : "justify-start"
                        }`}
                      >
                        <div
                          className={`max-w-[70%] p-3 rounded-2xl text-sm ${
                            m.la_nhan_vien
                              ? "bg-[#C69C6D] text-black"
                              : "bg-[#222] text-white border border-white/10"
                          }`}
                        >
                          {m.hinh_anh && (
                            <img
                              src={m.hinh_anh}
                              className="w-full h-auto rounded-lg mb-2"
                            />
                          )}
                          <p className="whitespace-pre-wrap">{m.noi_dung}</p>
                          <div className="text-[9px] mt-1 opacity-50 text-right">
                            {formatTime(m.tao_luc)}
                          </div>
                        </div>
                      </div>
                    ))
                  )}
                </div>

                <div className="p-4 border-t border-white/10 bg-[#161616] flex gap-3">
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="p-3 text-gray-400 hover:text-[#C69C6D] bg-white/5 rounded-xl"
                  >
                    <ImageIcon size={20} />
                  </button>
                  <input
                    type="file"
                    ref={fileInputRef}
                    className="hidden"
                    accept="image/*"
                    onChange={(e) =>
                      e.target.files?.[0] && handleSend(e.target.files[0])
                    }
                  />
                  <div className="flex-1 flex gap-2">
                    <input
                      className="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 text-white text-sm outline-none focus:border-[#C69C6D]"
                      placeholder="Nh·∫≠p tin nh·∫Øn..."
                      value={inputMsg}
                      onChange={(e) => setInputMsg(e.target.value)}
                      onKeyDown={(e) => e.key === "Enter" && handleSend()}
                      disabled={
                        isSending ||
                        (!selectedSession.nhan_su_phu_trach_id && !isManager)
                      }
                    />
                    <button
                      onClick={() => handleSend()}
                      className="p-3 bg-[#C69C6D] hover:bg-white text-black rounded-xl disabled:opacity-50"
                    >
                      <Send size={20} />
                    </button>
                  </div>
                </div>
              </>
            ) : (
              <div className="flex-1 flex items-center justify-center text-white/20 flex-col gap-3">
                <MessageSquare size={64} />
                <p className="uppercase font-bold tracking-widest">
                  Ch∆∞a ch·ªçn h·ªôi tho·∫°i
                </p>
              </div>
            )}
          </div>

          {/* üü¢ MODAL M·ªúI ƒê·ªíNG NGHI·ªÜP (ƒê√É FIX: L·∫§Y ƒê√öNG DATA STAFF) */}
          {showInviteModal && (
            <div
              className="absolute inset-0 z-[9999] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4"
              onClick={() => setShowInviteModal(false)}
            >
              <div
                className="bg-[#1a1a1a] w-[400px] max-h-[80vh] rounded-2xl border border-white/10 shadow-2xl flex flex-col overflow-hidden"
                onClick={(e) => e.stopPropagation()}
              >
                <div className="p-4 border-b border-white/10 flex justify-between items-center bg-[#222]">
                  <h3 className="text-white font-bold uppercase">M·ªùi h·ªó tr·ª£</h3>
                  <button onClick={() => setShowInviteModal(false)}>
                    <X className="text-gray-400 hover:text-white" size={20} />
                  </button>
                </div>
                <div className="flex-1 overflow-y-auto p-2 space-y-1">
                  {staffList.length === 0 && (
                    <div className="p-4 text-center text-gray-500 text-sm">
                      Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n h·ªó tr·ª£ n√†o kh√°c.
                    </div>
                  )}

                  {staffList
                    .filter((s) => s.id !== user.id)
                    .map((s) => {
                      const isOnline = onlineStaffIds.has(s.id);
                      return (
                        <button
                          key={s.id}
                          onClick={() => handleInvite(s.id)}
                          className="w-full flex items-center gap-3 p-3 hover:bg-white/10 rounded-xl transition-all group"
                        >
                          <div className="relative">
                            <div className="w-10 h-10 rounded-full bg-gray-700 overflow-hidden">
                              {s.hinh_anh ? (
                                <img
                                  src={s.hinh_anh}
                                  className="w-full h-full object-cover"
                                />
                              ) : (
                                <User
                                  size={20}
                                  className="m-auto text-gray-400"
                                />
                              )}
                            </div>
                            <div
                              className={`absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-[#1a1a1a] ${
                                isOnline ? "bg-green-500" : "bg-gray-500"
                              }`}
                            ></div>
                          </div>
                          <div className="text-left flex-1">
                            <div className="text-sm font-bold text-white group-hover:text-[#C69C6D]">
                              {s.ho_ten}
                            </div>
                            <div className="text-xs text-gray-500">
                              {s.vi_tri || "Nh√¢n vi√™n"} ‚Ä¢{" "}
                              {isOnline ? "Online" : "Offline"}
                            </div>
                          </div>
                          <div className="w-8 h-8 rounded-full border border-white/10 flex items-center justify-center text-gray-400 group-hover:bg-[#C69C6D] group-hover:text-black group-hover:border-[#C69C6D]">
                            <UserPlus size={16} />
                          </div>
                        </button>
                      );
                    })}
                </div>
              </div>
            </div>
          )}
        </div>
      )}
    </>
  );
}
</file>

<file path="CongDangNhap/AuthService.ts">
import { supabase } from '@/app/ThuVien/ketNoiSupabase';
import { DataNormalizer } from '@/app/ThuVien/DataNormalizer';

// --- ƒê·ªäNH NGHƒ®A KI·ªÇU D·ªÆ LI·ªÜU CHU·∫®N ---

// Quy·ªÅn h·∫°n m·∫∑c ƒë·ªãnh (c√≥ th·ªÉ m·ªü r·ªông sau n√†y)
const DEFAULT_PERMISSIONS = {
  isAdmin: false,
  canView: true,
  canEdit: false,
  canDelete: false,
};

export interface UserInfo {
  id: string;
  email: string;
  ho_ten: string | null;
  so_dien_thoai: string | null;
  hinh_anh?: string | null;
  
  // Ph√¢n lo·∫°i quan tr·ªçng
  userType: 'nhan_su' | 'khach_hang';
  role: string; // ƒê√¢y l√† gi√° tr·ªã quan tr·ªçng nh·∫•t ƒë·ªÉ ƒë·ªãnh tuy·∫øn (VD: 'admin', 'sales', 'khtrongtam')
  
  // C√°c tr∆∞·ªùng chi ti·∫øt t·ª´ DB (ƒë·ªÉ hi·ªÉn th·ªã)
  vi_tri?: string | null;            // VD: "Th·ª£ S·∫£n Xu·∫•t"
  vi_tri_normalized?: string | null; // VD: "thosanxuat"
  phan_loai?: string | null;         // VD: "KH Tr·ªçng t√¢m"
  phan_loai_normalized?: string | null; // VD: "khtrongtam"
  
  permissions: typeof DEFAULT_PERMISSIONS;
}

export class AuthService {

  /**
   * 1. H√ÄM C·ªêT L√ïI: NH·∫¨N DI·ªÜN USER QUA EMAIL
   * Logic: Check b·∫£ng nhan_su tr∆∞·ªõc -> N·∫øu kh√¥ng c√≥ th√¨ check khach_hang
   */
  static async identifyUser(email: string): Promise<UserInfo | null> {
    if (!email) return null;
    const cleanEmail = email.trim().toLowerCase();

    try {
      // --- B∆Ø·ªöC 1: T√åM TRONG B·∫¢NG NH√ÇN S·ª∞ ---
      const { data: nhanSu, error: errNS } = await supabase
        .from('nhan_su')
        .select('*')
        .eq('email', cleanEmail)
        .single();

      if (nhanSu && !errNS) {
        // N·∫øu l√† nh√¢n s·ª±, role ch√≠nh l√† vi_tri_normalized
        // N·∫øu vi_tri_normalized null, fallback v·ªÅ 'parttime' cho an to√†n
        const roleCode = nhanSu.vi_tri_normalized || 'parttime';
        
        return {
          id: nhanSu.id,
          email: nhanSu.email,
          ho_ten: nhanSu.ho_ten,
          so_dien_thoai: nhanSu.so_dien_thoai,
          hinh_anh: nhanSu.hinh_anh,
          
          userType: 'nhan_su',
          role: roleCode, // <-- D√πng c√°i n√†y ƒë·ªÉ tra b·∫£ng routing_permissions
          
          vi_tri: nhanSu.vi_tri,
          vi_tri_normalized: roleCode,
          
          permissions: {
            ...DEFAULT_PERMISSIONS,
            isAdmin: roleCode === 'admin' || roleCode === 'quanly'
          }
        };
      }

      // --- B∆Ø·ªöC 2: T√åM TRONG B·∫¢NG KH√ÅCH H√ÄNG ---
      const { data: khachHang, error: errKH } = await supabase
        .from('khach_hang')
        .select('*')
        .eq('email', cleanEmail)
        .single();

      if (khachHang && !errKH) {
        // N·∫øu l√† kh√°ch h√†ng, role ch√≠nh l√† phan_loai_normalized
        // VD: 'vip', 'doitac', 'khtrongtam'
        const roleCode = khachHang.phan_loai_normalized || 'moi';

        return {
          id: khachHang.id,
          email: khachHang.email,
          ho_ten: khachHang.ho_ten,
          so_dien_thoai: khachHang.so_dien_thoai,
          
          userType: 'khach_hang',
          role: roleCode, // <-- D√πng c√°i n√†y ƒë·ªÉ tra b·∫£ng routing_permissions

          phan_loai: khachHang.phan_loai,
          phan_loai_normalized: roleCode,
          
          permissions: DEFAULT_PERMISSIONS
        };
      }

      // Kh√¥ng t√¨m th·∫•y ·ªü ƒë√¢u c·∫£
      return null;

    } catch (error) {
      console.error('AuthService: L·ªói ƒë·ªãnh danh user:', error);
      return null;
    }
  }

  /**
   * 2. H√ÄM H·ªñ TR·ª¢: L·∫§Y USER HI·ªÜN T·∫†I T·ª™ SESSION
   * D√πng cho Client Side (UserContext)
   */
  static async getCurrentUser(): Promise<UserInfo | null> {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user || !user.email) return null;

    // G·ªçi h√†m identify ·ªü tr√™n ƒë·ªÉ l·∫•y th√¥ng tin chi ti·∫øt t·ª´ DB
    return await this.identifyUser(user.email);
  }

  /**
   * 3. H√ÄM RPC (QUAN TR·ªåNG CHO CONGDANGNHAP.TSX)
   * H√†m n√†y g·ªçi RPC trong database ƒë·ªÉ bypass RLS n·∫øu c·∫ßn thi·∫øt,
   * ho·∫∑c ƒë∆°n gi·∫£n l√† t√°i s·ª≠ d·ª•ng logic identifyUser ·ªü tr√™n.
   * ƒê·ªÉ ƒë·∫£m b·∫£o t∆∞∆°ng th√≠ch v·ªõi code c≈© c·ªßa b·∫°n, t√¥i vi·∫øt h√†m n√†y wrap l·∫°i logic tr√™n.
   */
  static async getUserByEmailWithRpc(email: string): Promise<UserInfo | null> {
    // ∆Øu ti√™n d√πng logic identifyUser ·ªü tr√™n v√¨ n√≥ query tr·ª±c ti·∫øp b·∫£ng chu·∫©n
    return await this.identifyUser(email);
    
    /* Ghi ch√∫: N·∫øu b·∫°n th·ª±c s·ª± mu·ªën d√πng RPC (Database Function) 'get_user_profile_by_email', 
       h√£y ƒë·∫£m b·∫£o function ƒë√≥ trong Postgres tr·∫£ v·ªÅ ƒë√∫ng c·∫•u tr√∫c c·ªôt nh∆∞ mong ƒë·ª£i.
       Hi·ªán t·∫°i, query tr·ª±c ti·∫øp (client-side query) l√† an to√†n v√† d·ªÖ debug nh·∫•t 
       v·ªõi c·∫•u tr√∫c b·∫£ng b·∫°n v·ª´a cung c·∫•p.
    */
  }

  /**
   * 4. ƒêƒÇNG XU·∫§T
   */
  static async signOut() {
    return await supabase.auth.signOut();
  }

  /**
   * 5. HELPER: KI·ªÇM TRA QUY·ªÄN ADMIN
   */
  static async isCurrentUserAdmin(): Promise<boolean> {
    const user = await this.getCurrentUser();
    return user?.permissions.isAdmin ?? false;
  }
}
</file>

<file path="CongDangNhap/ChanForm.tsx">
'use client';

import React from 'react';

interface Props {
    onSupportClick?: () => void;
}

export default function ChanForm({ onSupportClick }: Props) {
    return (
        <div className="w-full flex flex-col items-center gap-3 mt-6 animate-in fade-in duration-700 delay-300">
            {/* ƒê∆∞·ªùng k·∫ª m·ªù tinh t·∫ø */}
            <div className="w-24 h-[1px] bg-gradient-to-r from-transparent via-[#8B5E3C] to-transparent opacity-50"></div>
            
            <div className="flex flex-col items-center gap-1 text-[10px] uppercase tracking-widest font-medium text-white/30 font-serif">
                <span>ƒê∆∞·ª£c ki·∫øn t·∫°o b·ªüi</span>
                <span className="text-[#C69C6D] font-bold drop-shadow-md tracking-[0.2em]">Tommy Nghi√™m Art</span>
            </div>
            
            {/* N√∫t H·ªó tr·ª£ */}
            <button 
                type="button" 
                onClick={onSupportClick}
                className="text-[10px] text-gray-600 hover:text-white transition-colors cursor-pointer mt-2 hover:underline decoration-dotted underline-offset-4"
            >
                G·∫∑p s·ª± c·ªë ƒëƒÉng nh·∫≠p?
            </button>
        </div>
    );
}
</file>

<file path="CongDangNhap/CongDangNhap.tsx">
"use client";

import React, { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { AuthService } from "@/app/CongDangNhap/AuthService";
import { getRedirectUrl } from "@/app/CongDangNhap/RoleRedirectService";
import {
  X,
  Square,
  CheckSquare,
  Lock,
  Eye,
  EyeOff,
  Loader2,
  ArrowRight,
  Mail,
  ArrowLeft,
  UserPlus,
  KeyRound,
} from "lucide-react";
import { Z_INDEX } from "@/app/constants/zIndex";
import RegisterForm from "@/app/components/RegisterForm"; // üü¢ Import Form m·ªõi

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const BASE_IMG_URL = `${SUPABASE_URL}/storage/v1/object/public/hinh-nen`;

// Hi·ªáu ·ª©ng n·ªÅn (Gi·ªØ nguy√™n)
const NenHieuUng = ({ isModalMode }: { isModalMode: boolean }) => {
  const bgMobile = `${BASE_IMG_URL}/login-mobile.jpg`;
  const bgTablet = `${BASE_IMG_URL}/login-tablet.jpg`;
  const bgDesktop = `${BASE_IMG_URL}/login-desktop.jpg`;

  return (
    <div
      className={`absolute inset-0 bg-[#050505] overflow-hidden ${
        isModalMode ? "rounded-2xl" : ""
      }`}
    >
      <div
        className="absolute inset-0 bg-cover bg-center md:hidden transition-opacity duration-700"
        style={{ backgroundImage: `url('${bgMobile}')` }}
      />
      <div
        className="absolute inset-0 bg-cover bg-center hidden md:block lg:hidden transition-opacity duration-700"
        style={{ backgroundImage: `url('${bgTablet}')` }}
      />
      <div
        className="absolute inset-0 bg-cover bg-center hidden lg:block transition-opacity duration-700"
        style={{ backgroundImage: `url('${bgDesktop}')` }}
      />
      <div
        className={`absolute inset-0 bg-black/60 ${
          isModalMode ? "bg-black/70" : ""
        }`}
      />
      <div className="absolute top-[-20%] left-[50%] -translate-x-1/2 w-[500px] h-[500px] bg-yellow-600/10 rounded-full blur-[100px] mix-blend-overlay" />
    </div>
  );
};

// üü¢ ƒê·ªãnh nghƒ©a Interface ƒë·ªÉ fix l·ªói TypeScript cho ONhapLieu
interface ONhapLieuProps {
  id: string;
  label: string;
  value: string;
  onChange: (val: string) => void;
  type?: string;
  showEye?: boolean;
  isPasswordVisible?: boolean;
  onToggleEye?: () => void;
}

// √î nh·∫≠p li·ªáu (Gi·ªØ nguy√™n)
const ONhapLieu = ({
  id,
  label,
  value,
  onChange,
  type = "text",
  showEye = false,
  isPasswordVisible = false,
  onToggleEye,
}: ONhapLieuProps) => {
  const inputType = showEye ? (isPasswordVisible ? "text" : "password") : type;

  return (
    <div className="group relative w-full">
      <label
        htmlFor={id}
        className="block text-white/80 text-xs font-bold uppercase tracking-[0.2em] mb-2 drop-shadow-md ml-1"
      >
        {label}
      </label>
      <div className="relative w-full">
        <input
          id={id}
          type={inputType}
          value={value}
          onChange={(e) => onChange(e.target.value)}
          className="w-full bg-black/40 hover:bg-black/60 focus:bg-black/80 text-white text-lg font-bold tracking-wider border border-white/20 focus:border-[#C69C6D] rounded-xl px-5 py-4 outline-none transition-all duration-300 placeholder-transparent shadow-lg"
          autoComplete="off"
        />
        {showEye && (
          <button
            type="button"
            onClick={onToggleEye}
            className="absolute right-4 top-1/2 -translate-y-1/2 text-white/40 hover:text-[#C69C6D] transition-colors p-1"
            tabIndex={-1}
          >
            {isPasswordVisible ? <EyeOff size={20} /> : <Eye size={20} />}
          </button>
        )}
      </div>
      <div className="absolute bottom-0 left-5 right-5 h-[1px] bg-[#C69C6D] scale-x-0 group-focus-within:scale-x-100 transition-transform duration-500 origin-left"></div>
    </div>
  );
};

// N√∫t x√°c nh·∫≠n (Gi·ªØ nguy√™n)
const NutXacNhan = ({
  isLoading,
  mode = "login",
}: {
  isLoading: boolean;
  mode?: "login" | "register" | "forgotPassword";
}) => {
  const getButtonText = () => {
    switch (mode) {
      // case 'register': return 'ƒêƒÇNG K√ù'; // ƒê√£ chuy·ªÉn sang form ri√™ng
      case "forgotPassword":
        return "G·ª¨I EMAIL";
      default:
        return "LOGIN";
    }
  };
  const getIcon = () => {
    switch (mode) {
      // case 'register': return <UserPlus size={28} ... />;
      case "forgotPassword":
        return (
          <Mail
            size={28}
            className="group-hover:scale-110 transition-transform duration-500"
            strokeWidth={2}
          />
        );
      default:
        return (
          <ArrowRight
            size={28}
            className="group-hover:-rotate-45 transition-transform duration-500"
            strokeWidth={2}
          />
        );
    }
  };

  return (
    <button
      type="submit"
      disabled={isLoading}
      className="group mt-8 flex flex-col items-center gap-3 opacity-90 hover:opacity-100 transition-all disabled:opacity-50 mx-auto"
    >
      <div className="w-16 h-16 md:w-20 md:h-20 rounded-full flex items-center justify-center bg-transparent border-2 border-white/30 text-white group-hover:bg-white group-hover:text-black group-hover:border-white group-hover:shadow-[0_0_30px_rgba(255,255,255,0.4)] transition-all duration-500 ease-out shadow-xl">
        {isLoading ? <Loader2 className="animate-spin" size={28} /> : getIcon()}
      </div>
      <div className="flex flex-col items-center">
        <span className="text-lg font-bold tracking-[0.3em] text-white group-hover:text-yellow-400 transition-colors drop-shadow-md">
          {isLoading ? "..." : getButtonText()}
        </span>
      </div>
    </button>
  );
};

// Component Ch√≠nh
export default function CongDangNhap({
  isOpen,
  onClose,
  isGateKeeper = false,
  initialMode = "login",
}: {
  isOpen?: boolean;
  onClose?: () => void;
  isGateKeeper?: boolean;
  initialMode?: "login" | "register";
}) {
  console.log("üé® CongDangNhap MOUNTED/RENDERED", {
    isOpen,
    isGateKeeper,
    initialMode,
  });

  const router = useRouter();
  const [mode, setMode] = useState<"login" | "register" | "forgotPassword">(
    "login"
  );
  const [user, setUser] = useState({ name: "", phone: "" }); // name=email, phone=password
  const [flags, setFlags] = useState({ loading: false, anim: false });
  const [isError, setIsError] = useState(false);

  const [wantFullScreen, setWantFullScreen] = useState(true);
  const [rememberMe, setRememberMe] = useState(true);
  const [showPhone, setShowPhone] = useState(false);

  // Dialog states
  const [showErrorDialog, setShowErrorDialog] = useState(false);
  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");
  const [showSuccessDialog, setShowSuccessDialog] = useState(false);

  const isModal = typeof isOpen === "boolean";

  const isVipCustomer = (phanLoai: string) =>
    !!phanLoai && phanLoai.trim().length > 0;

  // üü¢ UPDATE: Set mode t·ª´ prop initialMode
  useEffect(() => {
    if (isOpen) {
      setMode(initialMode || "login");
      const timer = setTimeout(
        () => setFlags((p) => ({ ...p, anim: true })),
        50
      );
      return () => clearTimeout(timer);
    } else {
      setFlags((p) => ({ ...p, anim: false }));
    }
  }, [isOpen, initialMode]);

  useEffect(() => {
    const savedEmail = localStorage.getItem("SAVED_EMAIL");
    if (savedEmail) {
      try {
        const parsed = JSON.parse(savedEmail);
        if (parsed.email) setUser((prev) => ({ ...prev, name: parsed.email }));
        setRememberMe(true);
      } catch (e) {
        setRememberMe(false);
      }
    }
    const savedPref = localStorage.getItem("GLOBAL_FULLSCREEN_PREF");
    if (savedPref !== null) setWantFullScreen(savedPref === "true");
  }, []);

  if (isModal && !isOpen) return null;

  const triggerFullScreen = () => {
    try {
      const elem = document.documentElement as any;
      if (elem.requestFullscreen) elem.requestFullscreen();
      else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
    } catch (err) {
      console.warn("Fullscreen error:", err);
    }
  };

  // --- LOGIC LOGIN (GI·ªÆ NGUY√äN) ---
  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    if (typeof window !== "undefined")
      localStorage.setItem(
        "GLOBAL_FULLSCREEN_PREF",
        wantFullScreen ? "true" : "false"
      );
    if (wantFullScreen) triggerFullScreen();

    setFlags((p) => ({ ...p, loading: true }));
    setIsError(false);

    const email = user.name.trim().toLowerCase();
    const password = user.phone.trim();

    try {
      const { data: authData, error: authError } =
        await supabase.auth.signInWithPassword({ email, password });
      if (authError) throw new Error(`L·ªói ƒëƒÉng nh·∫≠p: ${authError.message}`);
      if (!authData.session) throw new Error("Session kh√¥ng ƒë∆∞·ª£c t·∫°o.");

      const finalUser = await AuthService.getUserByEmailWithRpc(email);
      if (!finalUser) throw new Error("Kh√¥ng t√¨m th·∫•y h·ªì s∆°.");

      let finalRole = "khach";
      if (finalUser.userType === "nhan_su") {
        finalRole = (finalUser as any).vi_tri_normalized || "parttime";
      } else {
        const phanLoai = finalUser.phan_loai || "";
        if (!isVipCustomer(phanLoai))
          throw new Error("T√†i kho·∫£n n√†y kh√¥ng ƒë∆∞·ª£c ph√©p truy c·∫≠p.");
        finalRole = (finalUser as any).phan_loai_normalized || "moi";
      }

      if (rememberMe)
        localStorage.setItem("SAVED_EMAIL", JSON.stringify({ email }));
      else localStorage.removeItem("SAVED_EMAIL");

      const userInfo = {
        id: finalUser.id,
        ho_ten: (finalUser as any).ten_hien_thi || finalUser.ho_ten || email,
        email: email,
        role: finalRole,
        role_normalized:
          (finalUser as any).vi_tri_normalized ||
          (finalUser as any).phan_loai_normalized ||
          finalRole,
        userType: finalUser.userType,
        avatar_url: (finalUser as any).hinh_anh,
      };

      localStorage.setItem("USER_INFO", JSON.stringify(userInfo));
      localStorage.setItem("USER_ROLE", finalRole);
      document.cookie = "VISITOR_MODE=; Path=/; Max-Age=0; SameSite=Lax";

      await new Promise((resolve) => setTimeout(resolve, 1000));
      const targetUrl = await getRedirectUrl(finalUser.userType, finalRole);

      if (isModal && onClose) onClose();
      router.push(targetUrl);
    } catch (err: any) {
      setErrorMessage(err?.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh");
      setShowErrorDialog(true);
      setIsError(true);
    } finally {
      setFlags((p) => ({ ...p, loading: false }));
    }
  };

  // Logic Qu√™n m·∫≠t kh·∫©u (GI·ªÆ NGUY√äN)
  const handleForgotPassword = async (e: React.FormEvent) => {
    e.preventDefault();
    setFlags((p) => ({ ...p, loading: true }));
    const email = user.name.trim().toLowerCase();
    try {
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${window.location.origin}/reset-password`,
      });
      if (error) throw error;
      setSuccessMessage(
        "ƒê√£ g·ª≠i link ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u! Vui l√≤ng ki·ªÉm tra email."
      );
      setShowSuccessDialog(true);
      setTimeout(() => {
        setShowSuccessDialog(false);
        setMode("login");
      }, 3000);
    } catch (err: any) {
      setErrorMessage(err.message);
      setShowErrorDialog(true);
    } finally {
      setFlags((p) => ({ ...p, loading: false }));
    }
  };

  const handleClose = () => {
    if (isGateKeeper) {
      router.push("/");
      return;
    }
    setFlags((p) => ({ ...p, anim: false }));
    setTimeout(() => onClose && onClose(), 300);
  };

  // üü¢ ƒêI·ªÄU CH·ªàNH ƒê·ªò R·ªòNG MODAL
  const modalWidthClass =
    mode === "register"
      ? "max-w-4xl h-auto md:h-[650px]"
      : "max-w-screen-xl h-full";

  return (
    <div
      className={`fixed inset-0 w-screen h-[100dvh] font-sans text-white overflow-hidden bg-black/90 backdrop-blur-sm flex items-center justify-center`}
      style={{ zIndex: Z_INDEX.modal }}
    >
      {/* Background Effect */}
      <div className="absolute inset-0 opacity-50 pointer-events-none">
        <NenHieuUng isModalMode={isModal} />
      </div>

      {/* Main Container */}
      <div
        className={`relative w-full ${modalWidthClass} mx-auto flex flex-col items-center justify-center transition-all duration-700 ease-out transform 
                  ${
                    isModal
                      ? flags.anim
                        ? "opacity-100 blur-0 scale-100"
                        : "opacity-0 blur-xl scale-110"
                      : "opacity-100"
                  }
            `}
      >
        {/* Close Button */}
        {isModal && (
          <button
            onClick={handleClose}
            className="absolute top-4 right-4 md:top-8 md:right-8 text-white/50 hover:text-white transition-colors p-2 z-50 bg-black/20 rounded-full active:scale-95"
          >
            <X size={24} className="md:w-8 md:h-8" strokeWidth={1.5} />
          </button>
        )}

        {/* üü¢ SWITCH CONTENT: REGISTER FORM vs LOGIN FORM */}
        {mode === "register" ? (
          // üü¢ FORM ƒêƒÇNG K√ù M·ªöI (T√çCH H·ª¢P)
          <div className="w-full h-full bg-[#0a0a0a] md:border border-[#C69C6D]/30 rounded-none md:rounded-2xl shadow-2xl overflow-hidden relative z-10 flex">
            <RegisterForm
              onSwitchToLogin={() => setMode("login")}
              onSuccess={() => {
                /* C√≥ th·ªÉ th√™m logic redirect ho·∫∑c th√¥ng b√°o ·ªü ƒë√¢y */
              }}
            />
          </div>
        ) : (
          // üü¢ FORM LOGIN / FORGOT C≈® (GI·ªÆ NGUY√äN)
          <form
            onSubmit={mode === "login" ? handleLogin : handleForgotPassword}
            className="w-full px-6 flex flex-col items-center justify-center relative z-10"
          >
            <div className="w-full max-w-[500px] flex flex-col gap-5 md:gap-6">
              {/* Mode Title v·ªõi Back button */}
              <div
                className={`flex items-center justify-center mb-2 ${
                  isError ? "animate-shake" : ""
                }`}
              >
                {mode === "forgotPassword" && (
                  <button
                    type="button"
                    onClick={() => setMode("login")}
                    className="absolute left-6 md:left-auto md:relative md:mr-4 text-white/50 hover:text-white transition-colors p-2"
                  >
                    <ArrowLeft size={24} />
                  </button>
                )}
                <h1 className="text-2xl md:text-3xl font-bold tracking-[0.3em] text-white/80">
                  {mode === "forgotPassword" ? "QU√äN M·∫¨T KH·∫®U" : "LOGIN"}
                </h1>
              </div>

              {/* Input Group */}
              <div
                className={`flex flex-col gap-4 ${
                  isError ? "animate-shake" : ""
                }`}
              >
                <ONhapLieu
                  id="inp_email"
                  label="EMAIL"
                  value={user.name}
                  onChange={(v: string) => setUser((p) => ({ ...p, name: v }))}
                />

                {mode === "login" && (
                  <ONhapLieu
                    id="inp_password"
                    label="M·∫¨T KH·∫®U"
                    value={user.phone}
                    onChange={(v: string) =>
                      setUser((p) => ({ ...p, phone: v }))
                    }
                    type={showPhone ? "text" : "password"}
                    showEye={true}
                    isPasswordVisible={showPhone}
                    onToggleEye={() => setShowPhone(!showPhone)}
                  />
                )}

                {/* Options Checkbox */}
                {mode === "login" && (
                  <div className="flex flex-row items-center justify-between px-1 mt-1">
                    <div
                      className="flex items-center gap-2 cursor-pointer group select-none"
                      onClick={() => setRememberMe(!rememberMe)}
                    >
                      <div
                        className={`transition-colors ${
                          rememberMe
                            ? "text-[#C69C6D]"
                            : "text-gray-600 group-hover:text-gray-400"
                        }`}
                      >
                        {rememberMe ? (
                          <CheckSquare size={16} />
                        ) : (
                          <Square size={16} />
                        )}
                      </div>
                      <span
                        className={`text-[10px] md:text-xs font-bold uppercase tracking-widest transition-colors ${
                          rememberMe
                            ? "text-white"
                            : "text-gray-500 group-hover:text-gray-400"
                        }`}
                      >
                        GHI NH·ªö ƒêƒÇNG NH·∫¨P
                      </span>
                    </div>
                    <div
                      className="flex items-center gap-2 cursor-pointer group select-none"
                      onClick={() => setWantFullScreen(!wantFullScreen)}
                    >
                      <div
                        className={`transition-colors ${
                          wantFullScreen
                            ? "text-yellow-500"
                            : "text-gray-600 group-hover:text-gray-400"
                        }`}
                      >
                        {wantFullScreen ? (
                          <CheckSquare size={16} />
                        ) : (
                          <Square size={16} />
                        )}
                      </div>
                      <span
                        className={`text-[10px] md:text-xs font-bold uppercase tracking-widest transition-colors ${
                          wantFullScreen
                            ? "text-white"
                            : "text-gray-500 group-hover:text-gray-400"
                        }`}
                      >
                        To√†n m√†n h√¨nh
                      </span>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Submit Button */}
            <div className="w-full max-w-[500px] mt-6 flex justify-center">
              <NutXacNhan isLoading={flags.loading} mode={mode} />
            </div>

            {/* Footer Links */}
            <div className="mt-6 flex flex-col items-center gap-3">
              {mode === "login" && (
                <>
                  <button
                    type="button"
                    onClick={() => setMode("forgotPassword")}
                    className="inline-flex items-center gap-2 text-xs md:text-sm text-white/40 hover:text-[#C69C6D] transition-all duration-300"
                  >
                    <KeyRound size={14} /> <span>Qu√™n m·∫≠t kh·∫©u?</span>
                  </button>
                  <button
                    type="button"
                    onClick={() => setMode("register")}
                    className="inline-flex items-center gap-2 text-xs md:text-sm text-white/40 hover:text-[#C69C6D] transition-all duration-300"
                  >
                    <UserPlus size={14} />{" "}
                    <span>Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay</span>
                  </button>
                </>
              )}

              {mode === "forgotPassword" && (
                <button
                  type="button"
                  onClick={() => setMode("login")}
                  className="inline-flex items-center gap-2 text-xs md:text-sm text-white/40 hover:text-[#C69C6D] transition-all duration-300"
                >
                  <span>Quay l·∫°i ƒëƒÉng nh·∫≠p</span>
                </button>
              )}

              <a
                href="tel:+84939941588"
                className="inline-flex items-center gap-2 text-xs md:text-sm text-white/30 hover:text-white transition-all duration-300 border-b border-transparent hover:border-white/50 pb-0.5 group"
              >
                <Lock
                  size={12}
                  className="group-hover:text-green-400 transition-colors"
                />{" "}
                <span>C·∫ßn h·ªó tr·ª£?</span>
              </a>
            </div>
          </form>
        )}
      </div>

      {/* Error Dialog */}
      {showErrorDialog && (
        <div
          className="fixed inset-0 flex items-center justify-center bg-black/80 backdrop-blur-sm"
          style={{ zIndex: Z_INDEX.modal + 10 }}
          onClick={() => setShowErrorDialog(false)}
        >
          <div
            className="relative bg-gradient-to-b from-zinc-900 to-black border border-white/10 rounded-2xl p-8 max-w-sm w-[90%] shadow-2xl transform animate-fadeIn"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex justify-center mb-6">
              <div className="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center border border-red-500/30">
                <Lock className="w-8 h-8 text-red-400" />
              </div>
            </div>
            <h3 className="text-xl font-bold text-white text-center mb-2">
              ƒêƒÉng nh·∫≠p th·∫•t b·∫°i
            </h3>
            <p className="text-white/60 text-sm text-center mb-6">
              {errorMessage || "Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin"}
            </p>
            <button
              onClick={() => setShowErrorDialog(false)}
              className="w-full py-3 bg-white/10 hover:bg-white/20 text-white font-semibold rounded-xl transition-all duration-300 border border-white/10 hover:border-white/30"
            >
              Th·ª≠ l·∫°i
            </button>
          </div>
        </div>
      )}

      {/* Success Dialog */}
      {showSuccessDialog && (
        <div
          className="fixed inset-0 flex items-center justify-center bg-black/80 backdrop-blur-sm"
          style={{ zIndex: Z_INDEX.modal + 10 }}
          onClick={() => setShowSuccessDialog(false)}
        >
          <div
            className="relative bg-gradient-to-b from-emerald-900/30 to-black border border-emerald-500/30 rounded-2xl p-8 max-w-sm w-[90%] shadow-2xl transform animate-fadeIn"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex justify-center mb-6">
              <div className="w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center border border-green-500/30">
                <Lock className="w-8 h-8 text-green-400" />
              </div>
            </div>
            <h3 className="text-xl font-bold text-white text-center mb-2">
              Th√†nh c√¥ng!
            </h3>
            <p className="text-white/60 text-sm text-center mb-6">
              {successMessage}
            </p>
            <button
              onClick={() => setShowSuccessDialog(false)}
              className="w-full py-3 bg-green-500/20 hover:bg-green-500/30 text-green-400 font-semibold rounded-xl transition-all duration-300 border border-green-500/30 hover:border-green-500/50"
            >
              ƒê√≥ng
            </button>
          </div>
        </div>
      )}

      <style jsx global>{`
        @keyframes shake {
          0%,
          100% {
            transform: translateX(0);
          }
          25% {
            transform: translateX(-5px);
          }
          75% {
            transform: translateX(5px);
          }
        }
        .animate-shake {
          animation: shake 0.3s ease-in-out;
        }
        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: scale(0.9);
          }
          to {
            opacity: 1;
            transform: scale(1);
          }
        }
        .animate-fadeIn {
          animation: fadeIn 0.3s ease-out;
        }
      `}</style>
    </div>
  );
}
</file>

<file path="CongDangNhap/middleware.ts">
import { createServerClient } from '@supabase/ssr';
import { NextResponse, type NextRequest } from 'next/server';

// Route c√¥ng khai
const PUBLIC_ROUTES = [
  '/', 
  '/trangchu', 
  '/dathang', 
  '/CongDangNhap',
  '/auth/callback',
  '/login'
];

// Route tƒ©nh
const STATIC_PATHS = [
  '/_next', '/api', '/static', '/favicon.ico', '/manifest.json', 
  '.png', '.jpg', '.jpeg', '.svg', '.css', '.js', '.mp3'
];

export async function middleware(request: NextRequest) {
  const path = request.nextUrl.pathname;

  // 1. B·ªè qua file tƒ©nh
  if (STATIC_PATHS.some(p => path.startsWith(p) || path.endsWith(p))) {
    return NextResponse.next();
  }

  let response = NextResponse.next({
    request: { headers: request.headers },
  });

  // Setup Supabase
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) { return request.cookies.get(name)?.value; },
        set(name: string, value: string, options: any) {
          request.cookies.set({ name, value, ...options });
          response = NextResponse.next({ request: { headers: request.headers } });
          response.cookies.set({ name, value, ...options });
        },
        remove(name: string, options: any) {
          request.cookies.set({ name, value: '', ...options });
          response = NextResponse.next({ request: { headers: request.headers } });
          response.cookies.set({ name, value: '', ...options });
        },
      },
    }
  );

  // 2. L·∫•y User
  const { data: { user } } = await supabase.auth.getUser();

  // A. CH∆ØA ƒêƒÇNG NH·∫¨P
  if (!user) {
    if (!PUBLIC_ROUTES.includes(path)) {
      return NextResponse.redirect(new URL('/?login=1', request.url));
    }
    return response;
  }

  // B. ƒê√É ƒêƒÇNG NH·∫¨P
  const email = user.email;
  if (!email) return response;

  // 3. X√°c ƒë·ªãnh Role
  let userType = '';
  let roleNormalized = '';

  const { data: nhanSu } = await supabase
    .from('nhan_su')
    .select('vi_tri_normalized')
    .eq('email', email)
    .single();

  if (nhanSu) {
    userType = 'nhan_su';
    roleNormalized = nhanSu.vi_tri_normalized || 'parttime';
  } else {
    const { data: khachHang } = await supabase
      .from('khach_hang')
      .select('phan_loai_normalized')
      .eq('email', email)
      .single();

    if (khachHang) {
      userType = 'khach_hang';
      roleNormalized = khachHang.phan_loai_normalized || 'moi';
    } else {
      // User r√°c -> Logout
      await supabase.auth.signOut();
      return NextResponse.redirect(new URL('/', request.url));
    }
  }

  // 4. Ki·ªÉm tra quy·ªÅn (C√≥ Fallback)
  if (roleNormalized === 'admin' || roleNormalized === 'boss') {
    return response; 
  }

  // Th·ª≠ ƒë·ªçc DB
  const { data: permission } = await supabase
    .from('routing_permissions')
    .select('allowed_routes, default_route')
    .eq('user_type', userType)
    .eq('role_normalized', roleNormalized)
    .single();

  let allowedRoutes: string[] = [];
  let defaultRoute = '/';

  if (permission) {
    // C√≥ d·ªØ li·ªáu DB
    defaultRoute = permission.default_route || '/';
    if (Array.isArray(permission.allowed_routes)) {
        allowedRoutes = permission.allowed_routes;
    } else if (typeof permission.allowed_routes === 'string') {
        try { allowedRoutes = JSON.parse(permission.allowed_routes); } catch {}
    }
  } else {
    // üü¢ D√ôNG FALLBACK TRONG CODE (Quan tr·ªçng)
    if (userType === 'nhan_su') {
        defaultRoute = `/phong${roleNormalized}`; // VD: /phongparttime
        allowedRoutes = [defaultRoute, '/dashboard'];
        
        // Fix ƒë·∫∑c bi·ªát cho tr∆∞·ªùng h·ª£p mapping kh√¥ng ƒë·ªÅu
        if (roleNormalized === 'thosanxuat') defaultRoute = '/phongtho';
        if (roleNormalized === 'congtacvien') defaultRoute = '/phongctv';
        
        allowedRoutes.push(defaultRoute);
    } else {
        allowedRoutes = ['/trangchu', '/dathang'];
        defaultRoute = '/trangchu';
    }
  }

  // Logic ch·∫∑n ƒë∆∞·ªùng
  const isAllowed = PUBLIC_ROUTES.includes(path) || allowedRoutes.some(route => {
    return path === route || path.startsWith(`${route}/`);
  });

  if (isAllowed) {
    return response;
  } else {
    // Redirect v·ªÅ ph√≤ng chu·∫©n
    if (path === defaultRoute) {
        // Tr√°nh loop n·∫øu defaultRoute c≈©ng l·ªói
        return NextResponse.redirect(new URL(userType === 'nhan_su' ? '/phongparttime' : '/', request.url));
    }
    return NextResponse.redirect(new URL(defaultRoute, request.url));
  }
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico).*)',
  ],
};
</file>

<file path="CongDangNhap/page.tsx">
'use client';

import React from 'react';
import CongDangNhap from './CongDangNhap';

/**
 * üîê TRANG C·ªîNG ƒêƒÇNG NH·∫¨P
 * Route: /CongDangNhap
 * 
 * S·ª≠ d·ª•ng component CongDangNhap ƒë√£ t·ªëi ∆∞u giao di·ªán
 * v·ªõi ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng: remember me, fullscreen, redirect ƒë√∫ng ph√≤ng
 */
export default function TrangCongDangNhap() {
  return <CongDangNhap isGateKeeper={true} />;
}
</file>

<file path="CongDangNhap/RoleRedirectService.ts">
import { supabase } from '@/app/ThuVien/ketNoiSupabase';

// H√†m chu·∫©n h√≥a chu·ªói
const normalizeString = (str: string | null | undefined): string => {
    if (!str) return '';
    return str
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .replace(/[^a-z0-9]/g, "")
        .trim();
};

// üü¢ C·∫§U H√åNH D·ª∞ PH√íNG (Kh·ªõp 100% v·ªõi file CSV routing_permissions)
// Gi√∫p h·ªá th·ªëng v·∫´n ch·∫°y ngon k·ªÉ c·∫£ khi Database b·ªã ch·∫∑n quy·ªÅn ƒë·ªçc
const FALLBACK_ROUTES: Record<string, string> = {
    // Nh√≥m Qu·∫£n Tr·ªã
    'admin': '/phongadmin',
    'boss': '/phongadmin',
    'quanly': '/phongquanly',
    
    // Nh√≥m Nghi·ªáp V·ª•
    'sales': '/phongsales',
    'ketoan': '/phongketoan',   // ‚úÖ M·ªõi: K·∫ø to√°n
    'thukho': '/phongkho',      // ‚úÖ M·ªõi: Th·ªß kho
    
    // Nh√≥m S·∫£n Xu·∫•t
    'congtacvien': '/phongctv',
    'ctv': '/phongctv',
    'parttime': '/phongparttime',
    'thosanxuat': '/phongtho',
    'tho': '/phongtho',
    'kythuat': '/phongtho',
    'thietke': '/phongthietke',
    
    // Nh√≥m Kh√°ch h√†ng
    'vip': '/trangchu',
    'doitac': '/trangchu',
    'moi': '/trangchu',
    'damuahang': '/trangchu',
    'khtrongtam': '/trangchu',
    'khach': '/trangchu'
};

const FALLBACK_ALLOWED_ROUTES: Record<string, string[]> = {
    // Admin & Boss: Full quy·ªÅn
    'admin': ['/phongadmin', '/phongquanly', '/phongkho', '/phongketoan', '/phongsales', '/phongparttime', '/phongctv', '/phongthietke', '/dashboard', '/settings'],
    'boss': ['/phongadmin', '/phongquanly', '/phongkho', '/phongketoan', '/phongsales', '/phongparttime', '/phongctv', '/phongthietke', '/dashboard', '/settings'],
    
    // Qu·∫£n l√Ω: ƒê∆∞·ª£c xem Kho, K·∫ø to√°n ƒë·ªÉ duy·ªát
    'quanly': ['/phongquanly', '/phongkho', '/phongketoan', '/dashboard'],
    
    // Nghi·ªáp v·ª• c·ª• th·ªÉ
    'sales': ['/phongsales', '/dathang', '/phongkho'], // ‚úÖ Sales ƒë∆∞·ª£c xem kho ƒë·ªÉ b√°o kh√°ch
    'ketoan': ['/phongketoan', '/dashboard'],          // ‚úÖ M·ªõi
    'thukho': ['/phongkho', '/dashboard'],             // ‚úÖ M·ªõi
    
    // S·∫£n xu·∫•t
    'parttime': ['/phongparttime'],
    'thosanxuat': ['/phongtho'],
    'congtacvien': ['/phongctv'],
    'thietke': ['/phongthietke'],
    
    // Kh√°ch h√†ng
    'khach': ['/trangchu', '/dathang', '/giohang']
};

export class RoleRedirectService {

    // ============================================================
    // 1. LOGIC ƒêI·ªÄU H∆Ø·ªöNG (∆ØU TI√äN DB -> D·ª∞ PH√íNG SAU)
    // ============================================================

    static async getRedirectUrl(
        userType: string, 
        roleNormalized: string
    ): Promise<string> {
        try {
            const p_role = normalizeString(roleNormalized);

            // 1. Th·ª≠ ƒë·ªçc t·ª´ Database
            const { data, error } = await supabase
                .from('routing_permissions')
                .select('default_route')
                .eq('user_type', userType)
                .eq('role_normalized', p_role)
                .maybeSingle();

            if (!error && data && data.default_route) {
                return data.default_route;
            }

            // 2. N·∫øu l·ªói ho·∫∑c kh√¥ng t√¨m th·∫•y -> D√πng ch·∫ø ƒë·ªô D·ª∞ PH√íNG
            // ƒêi·ªÅu n√†y ph√° v·ª° v√≤ng l·∫∑p v√¥ t·∫≠n khi DB b·ªã l·ªói
            if (FALLBACK_ROUTES[p_role]) {
                console.log(`‚ö†Ô∏è D√πng Fallback Route cho ${p_role}: ${FALLBACK_ROUTES[p_role]}`);
                return FALLBACK_ROUTES[p_role];
            }

            // 3. ƒê∆∞·ªùng c√πng (M·∫∑c ƒë·ªãnh an to√†n ƒë·ªÉ kh√¥ng v·ªÅ trang ch·ªß n·∫øu l√† nh√¢n s·ª±)
            return userType === 'nhan_su' ? '/phongparttime' : '/trangchu';

        } catch (err) {
            console.error('RoleRedirectService Error:', err);
            return '/';
        }
    }

    // ============================================================
    // 2. CHECK QUY·ªÄN TRUY C·∫¨P (DB -> D·ª∞ PH√íNG)
    // ============================================================

    static async isRouteAllowed(
        userType: string, 
        roleNormalized: string, 
        route: string
    ): Promise<boolean> {
        try {
            const p_role = normalizeString(roleNormalized);
            const cleanRoute = route.split('?')[0];

            // Admin lu√¥n ƒë∆∞·ª£c ƒëi m·ªçi n∆°i
            if (p_role === 'admin' || p_role === 'boss') return true;

            // 1. Th·ª≠ ƒë·ªçc DB
            const { data, error } = await supabase
                .from('routing_permissions')
                .select('allowed_routes')
                .eq('user_type', userType)
                .eq('role_normalized', p_role)
                .maybeSingle();

            let allowedRoutes: string[] = [];

            if (!error && data && data.allowed_routes) {
                if (Array.isArray(data.allowed_routes)) {
                    allowedRoutes = data.allowed_routes;
                } else if (typeof data.allowed_routes === 'string') {
                    try { allowedRoutes = JSON.parse(data.allowed_routes); } catch {}
                }
            } else {
                // 2. D√πng D·ª± ph√≤ng
                allowedRoutes = FALLBACK_ALLOWED_ROUTES[p_role] || FALLBACK_ALLOWED_ROUTES['khach'];
            }

            // Logic kh·ªõp route
            const isAllowed = allowedRoutes.some((r: string) => {
                return cleanRoute === r || cleanRoute.startsWith(r + '/');
            });

            return isAllowed;

        } catch (err) {
            console.error('Permission Check Error:', err);
            return false;
        }
    }

    // ============================================================
    // 3. UI HELPERS (Gi·ªØ nguy√™n)
    // ============================================================

    static isHRAdmin(viTriNormalized: string | null | undefined): boolean {
        if (!viTriNormalized) return false;
        const role = normalizeString(viTriNormalized);
        return ['admin', 'quanly', 'boss', 'sep', 'manager'].includes(role);
    }

    static getModalIdFromPosition(viTriNormalized: string | null | undefined): string | null {
        if (!viTriNormalized) return null;
        const role = normalizeString(viTriNormalized);
        
        const map: Record<string, string> = {
            'admin': 'admin',
            'quanly': 'quanly',
            'boss': 'quanly',
            'sales': 'sales',
            'ketoan': 'ketoan', // ‚úÖ M·ªõi
            'thukho': 'thukho', // ‚úÖ M·ªõi
            'thosanxuat': 'tho',
            'tho': 'tho',
            'kythuat': 'tho',
            'thietke': 'thietke',
            'parttime': 'parttime',
            'thoivu': 'parttime',
            'congtacvien': 'ctv',
            'ctv': 'ctv',
            'khtrongtam': 'trungbay',
            'vip': 'trungbay'
        };
        
        return map[role] || null;
    }

    static getModalDisplayName(viTriNormalized: string | null | undefined): string | null {
        if (!viTriNormalized) return null;
        const role = normalizeString(viTriNormalized);
        
        const map: Record<string, string> = {
            'admin': 'Ph√≤ng Admin',
            'quanly': 'Ph√≤ng Qu·∫£n L√Ω',
            'sales': 'Ph√≤ng Sales',
            'ketoan': 'Ph√≤ng K·∫ø To√°n', // ‚úÖ M·ªõi
            'thukho': 'Kho T·ªïng',      // ‚úÖ M·ªõi
            'thosanxuat': 'Ph√≤ng Th·ª£',
            'thietke': 'Ph√≤ng Thi·∫øt K·∫ø',
            'parttime': 'Ph√≤ng Part-time',
            'congtacvien': 'Ph√≤ng CTV',
            'khtrongtam': 'Ph√≤ng Tr∆∞ng B√†y',
            'vip': 'Ph√≤ng VIP'
        };
        
        if (!map[role]) {
            return `Ph√≤ng ${role.charAt(0).toUpperCase() + role.slice(1)}`;
        }

        return map[role];
    }
}

// Export l·∫ª
export const getRedirectUrl = RoleRedirectService.getRedirectUrl;
export const isRouteAllowed = RoleRedirectService.isRouteAllowed;
export const isHRAdmin = RoleRedirectService.isHRAdmin;
export const getModalIdFromPosition = RoleRedirectService.getModalIdFromPosition;
export const getModalDisplayName = RoleRedirectService.getModalDisplayName;
</file>

<file path="constants/zIndex.ts">
// ‚úÖ Z-INDEX MANAGEMENT SYSTEM
// Centralized z-index values to prevent conflicts

export const Z_INDEX = {
  // Background layers
  background: 0,
  backgroundImage: 1,
  gradient: 4900,

  // Main content
  content: 10,
  contentOverlay: 20,

  // Menu system
  menuTren: 5000,
  menuDuoi: 5000,
  menuButton: 11000,

  // Chat system
  chatDrawer: 5500,
  chatToast: 5600,

  // Modals & Overlays
  modalBackdrop: 9900,
  modal: 9999,

  // Floating elements
  adminTools: 5001,
  loginButton: 5002,

  // Utilities
  tooltip: 10000,
  notification: 10100,
} as const;

// Export type for TypeScript strict checks
export type ZIndexKey = keyof typeof Z_INDEX;
</file>

<file path="dashboard/admin/page.tsx">
'use client';

import React from 'react';
import { useRouter } from 'next/navigation';
import { useUser } from '@/app/ThuVien/UserContext';
import { BarChart3, Users, Settings, AlertCircle } from 'lucide-react';

/**
 * üìä ADMIN DASHBOARD
 * Route: /dashboard/admin
 */
export default function AdminDashboardPage() {
  const router = useRouter();
  const { user, loading } = useUser();

  // Loading state
  if (loading) {
    return (
      <div className="min-h-screen bg-[#050505] flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#C69C6D] mx-auto mb-4" />
          <p className="text-gray-400">ƒêang t·∫£i...</p>
        </div>
      </div>
    );
  }

  // No user - redirect
  if (!user) {
    router.push('/');
    return null;
  }

  return (
    <div className="min-h-screen bg-[#050505] p-4 md:p-8">
      {/* HEADER */}
      <div className="mb-8">
        <h1 className="text-4xl font-bold text-[#C69C6D] mb-2">üìä Admin Dashboard</h1>
        <p className="text-white/70">
          Ch√†o {user.ho_ten} ({user.userType === 'nhan_su' ? user.vi_tri_normalized : user.phan_loai_normalized})
        </p>
      </div>

      {/* STATS GRID */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <StatCard icon={Users} title="Users" value="1,234" color="blue" />
        <StatCard icon={BarChart3} title="Analytics" value="85%" color="green" />
        <StatCard icon={Settings} title="Products" value="567" color="purple" />
        <StatCard icon={AlertCircle} title="Alerts" value="42" color="red" />
      </div>

      {/* SECTIONS */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div className="bg-[#1a120f] border border-[#8B5E3C]/30 rounded-lg p-6">
          <h2 className="text-xl font-bold text-[#C69C6D] mb-4 flex items-center gap-2">
            <Users size={20} /> User Management
          </h2>
          <p className="text-white/70 mb-4">Manage system users and roles</p>
          <button className="px-4 py-2 bg-[#C69C6D] text-black rounded font-bold hover:bg-white transition-all">
            Manage Users
          </button>
        </div>

        <div className="bg-[#1a120f] border border-[#8B5E3C]/30 rounded-lg p-6">
          <h2 className="text-xl font-bold text-[#C69C6D] mb-4 flex items-center gap-2">
            <Settings size={20} /> System Settings
          </h2>
          <p className="text-white/70 mb-4">Configure system settings</p>
          <button className="px-4 py-2 bg-[#C69C6D] text-black rounded font-bold hover:bg-white transition-all">
            Settings
          </button>
        </div>

        <div className="bg-[#1a120f] border border-[#8B5E3C]/30 rounded-lg p-6">
          <h2 className="text-xl font-bold text-[#C69C6D] mb-4 flex items-center gap-2">
            <BarChart3 size={20} /> Analytics
          </h2>
          <p className="text-white/70 mb-4">View detailed analytics</p>
          <button className="px-4 py-2 bg-[#C69C6D] text-black rounded font-bold hover:bg-white transition-all">
            View Analytics
          </button>
        </div>

        <div className="bg-[#1a120f] border border-[#8B5E3C]/30 rounded-lg p-6">
          <h2 className="text-xl font-bold text-[#C69C6D] mb-4">Content Management</h2>
          <p className="text-white/70 mb-4">Manage website content</p>
          <button className="px-4 py-2 bg-[#C69C6D] text-black rounded font-bold hover:bg-white transition-all">
            Manage Content
          </button>
        </div>
      </div>
    </div>
  );
}

interface StatCardProps {
  icon: React.ElementType;
  title: string;
  value: string;
  color: string;
}

function StatCard({ icon: Icon, title, value, color }: StatCardProps) {
  const colorClasses: Record<string, string> = {
    blue: 'text-blue-400 bg-blue-900/20 border-blue-500',
    green: 'text-green-400 bg-green-900/20 border-green-500',
    purple: 'text-purple-400 bg-purple-900/20 border-purple-500',
    red: 'text-red-400 bg-red-900/20 border-red-500',
  };

  return (
    <div className={`${colorClasses[color]} border rounded-lg p-6`}>
      <Icon size={24} />
      <p className="text-white/70 text-sm mt-2">{title}</p>
      <p className="text-2xl font-bold mt-2">{value}</p>
    </div>
  );
}
</file>

<file path="dathang/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { supabase } from '@/app/ThuVien/ketNoiSupabase';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import { useUser } from '@/app/ThuVien/UserContext';
import { Search, ShoppingCart, Filter, Loader2 } from 'lucide-react';

export default function TrangDatHang() {
  const { user } = useUser();
  const [products, setProducts] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('all');

  useEffect(() => {
    const fetchProducts = async () => {
      // L·∫•y d·ªØ li·ªáu t·ª´ b·∫£ng VAT_TU (ƒë√£ seed)
      const { data } = await supabase
        .from('vat_tu')
        .select('*')
        .eq('loai_vat_tu', 'thanh_pham')
        .order('gia_ban', { ascending: true });
      
      if (data) setProducts(data);
      setLoading(false);
    };
    fetchProducts();
  }, []);

  const handleOrder = async (product: any) => {
    if (!user) {
        alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t h√†ng!");
        return;
    }
    const confirmMsg = `X√°c nh·∫≠n ƒë·∫∑t t√°c ph·∫©m: ${product.ten_vat_tu}\nGi√°: ${product.gia_ban.toLocaleString()} VNƒê?`;
    if (!confirm(confirmMsg)) return;

    // G·ªçi API t·∫°o ƒë∆°n h√†ng (ƒë√£ c√≥ trigger tr·ª´ kho)
    const { error } = await supabase.from('don_hang_chi_tiet').insert({
        don_hang_id: null, // T·∫°o ƒë∆°n nh√°p (ho·∫∑c logic t·∫°o ƒë∆°n m·ªõi) - ·ªû ƒë√¢y demo
        vat_tu_id: product.id,
        so_luong: 1,
        don_gia: product.gia_ban,
        ten_item_hien_thi: product.ten_vat_tu
    });
    
    // V√¨ logic t·∫°o ƒë∆°n ph·ª©c t·∫°p c·∫ßn Header ƒë∆°n h√†ng, ·ªü ƒë√¢y ta gi·∫£ l·∫≠p b√°o th√†nh c√¥ng
    // Th·ª±c t·∫ø n√™n d√πng OrderService.createOrder
    alert("ƒê√£ g·ª≠i y√™u c·∫ßu ƒë·∫∑t h√†ng! Nh√¢n vi√™n s·∫Ω li√™n h·ªá b·∫°n s·ªõm.");
  };

  return (
    <KhungTrangChuan nguoiDung={user} loiChao="B·ªò S∆ØU T·∫¨P T√ÅC PH·∫®M">
      <div className="max-w-6xl mx-auto px-4 pb-20">
        
        {/* B·ªô l·ªçc */}
        <div className="flex gap-2 overflow-x-auto pb-4 mb-6 scrollbar-hide">
             {['all', 'Xu√¢n', 'H·∫°', 'Thu', 'ƒê√¥ng'].map(bg => (
                 <button 
                    key={bg}
                    onClick={() => setFilter(bg)}
                    className={`px-4 py-2 rounded-full text-xs font-bold uppercase border transition-all whitespace-nowrap
                    ${filter === bg ? 'bg-[#C69C6D] text-black border-[#C69C6D]' : 'bg-white/5 border-white/10 text-white hover:border-white'}`}
                 >
                    {bg === 'all' ? 'T·∫•t c·∫£' : `BST ${bg}`}
                 </button>
             ))}
        </div>

        {/* Grid S·∫£n ph·∫©m */}
        {loading ? (
            <div className="flex justify-center py-20"><Loader2 className="animate-spin text-[#C69C6D]"/></div>
        ) : (
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {products
                .filter(p => filter === 'all' || p.bo_suu_tap === filter)
                .map((p) => (
                <div key={p.id} className="bg-[#111] border border-white/10 rounded-2xl overflow-hidden group hover:border-[#C69C6D]/50 transition-all">
                    <div className="aspect-square relative overflow-hidden">
                        <img src={p.hinh_anh} alt={p.ten_vat_tu} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"/>
                        <div className="absolute top-2 right-2 bg-black/60 backdrop-blur px-2 py-1 rounded text-[10px] text-[#C69C6D] font-bold border border-[#C69C6D]/30">
                            BST {p.bo_suu_tap}
                        </div>
                    </div>
                    <div className="p-4">
                        <h3 className="text-white font-serif text-lg font-bold truncate">{p.ten_vat_tu}</h3>
                        <div className="flex items-center justify-between mt-2">
                            <span className="text-[#C69C6D] font-bold">
                                {p.gia_ban.toLocaleString()} ‚Ç´
                            </span>
                            <button 
                                onClick={() => handleOrder(p)}
                                className="p-2 bg-white text-black rounded-full hover:bg-[#C69C6D] transition-colors"
                            >
                                <ShoppingCart size={18} />
                            </button>
                        </div>
                        <p className="text-gray-500 text-xs mt-2">C√≤n l·∫°i: {p.ton_kho} t√°c ph·∫©m</p>
                    </div>
                </div>
            ))}
            </div>
        )}
      </div>
    </KhungTrangChuan>
  );
}
</file>

<file path="DuLieuBackend.md">
| ?column? |
| -------- |

| # DATABASE SCHEMA DOCUMENTATION

## Table: bang_luong

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| nhan_su_id | uuid | YES | - | |
| thang | integer | YES | - | |
| nam | integer | YES | - | |
| tong_thu_nhap | numeric | YES | 0... | |
| trang_thai | text | YES | 'chua_chot'::text... | |
| created_at | timestamp with time zone | YES | now()... | |

> Constraints:

- CHECK: 27491_54977_1_not_null

## Table: cac_buoc_mau

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| quy_trinh_id | uuid | YES | - | üîó FK -> quy_trinh_mau.id |
| ten_buoc | text | YES | - | |
| thu_tu | integer | YES | - | |
| thoi_gian_chuan | integer | YES | - | |
| huong_dan_ky_thuat | text | YES | - | |
| video_huong_dan | text | YES | - | |
| diem_thuong | integer | YES | 10... | |

> Constraints:

- FOREIGN KEY: cac_buoc_mau_quy_trinh_id_fkey
- CHECK: 27491_53195_1_not_null

## Table: cau_hinh_hop_qua

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | text | NO | - | üîë PK |
| ten_qua | text | YES | - | |
| ti_le_roi | double precision | YES | - | |
| loai_qua | text | YES | - | |
| gia_tri | numeric | YES | - | |
| hinh_anh | text | YES | - | |

> Constraints:

- CHECK: 27491_53393_1_not_null

## Table: dinh_muc

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| thanh_pham_id | uuid | YES | - | üîó FK -> vat_tu.id |
| nguyen_lieu_id | uuid | YES | - | üîó FK -> vat_tu.id |
| so_luong_can | numeric | YES | - | |

> Constraints:

- FOREIGN KEY: dinh_muc_nguyen_lieu_id_fkey
- FOREIGN KEY: dinh_muc_thanh_pham_id_fkey
- CHECK: 27491_53209_1_not_null

## Table: don_hang

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| organization_id | uuid | YES | - | |
| ma_don | text | YES | - | |
| khach_hang_id | uuid | YES | - | üîó FK -> khach_hang.id |
| sales_phu_trach_id | uuid | YES | - | üîó FK -> nhan_su.id |
| nguoi_tao_id | uuid | YES | - | üîó FK -> nhan_su.id |
| trang_thai | text | YES | 'moi'::text... | |
| tong_tien | numeric | YES | 0... | |
| da_thanh_toan | numeric | YES | 0... | |
| kenh_ban_hang | text | YES | - | |
| ghi_chu | text | YES | - | |
| thong_tin_giao_hang | jsonb | YES | - | |
| tao_luc | timestamp with time zone | YES | now()... | |
| cap_nhat_luc | timestamp with time zone | YES | now()... | |

> Constraints:

- FOREIGN KEY: don_hang_khach_hang_id_fkey
- UNIQUE: don_hang_ma_don_key
- FOREIGN KEY: don_hang_nguoi_tao_id_fkey
- FOREIGN KEY: don_hang_sales_phu_trach_id_fkey
- CHECK: 27491_53227_1_not_null

## Table: don_hang_chi_tiet

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| don_hang_id | uuid | YES | - | üîó FK -> don_hang.id |
| vat_tu_id | uuid | YES | - | üîó FK -> vat_tu.id |
| ten_item_hien_thi | text | YES | - | |
| so_luong | integer | YES | - | |
| don_gia | numeric | YES | - | |
| thanh_tien | numeric | YES | - | |
| quy_trinh_id | uuid | YES | - | üîó FK -> quy_trinh_mau.id |
| yeu_cau_rieng | jsonb | YES | - | |

> Constraints:

- FOREIGN KEY: don_hang_chi_tiet_don_hang_id_fkey
- FOREIGN KEY: don_hang_chi_tiet_quy_trinh_id_fkey
- FOREIGN KEY: don_hang_chi_tiet_vat_tu_id_fkey
- CHECK: 27491_53257_1_not_null

## Table: khach_hang

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| ho_ten | text | YES | - | |
| so_dien_thoai | text | YES | - | |
| nguoi_tao | uuid | YES | - | üîó FK -> nhan_su.id |
| tao_luc | timestamp with time zone | YES | now()... | |
| email | text | YES | - | |
| phan_loai | text | YES | - | |
| phan_loai_normalized | text | YES | - | |
| hinh_anh | text | YES | - | |
| dia_chi | text | YES | - | |
| organization_id | uuid | YES | '00000000-0000-0000-... | |
| art_coin | integer | YES | 0... | |
| hang_thanh_vien | text | YES | 'Newbie'::text... | |
| tong_chi_tieu_tich_luy | numeric | YES | 0... | |
| nguoi_gioi_thieu_id | uuid | YES | - | üîó FK -> nhan_su.id |
| metadata_so_thich | jsonb | YES | '{}'::jsonb... | |
| vi_blockchain | text | YES | - | |

> Constraints:

- FOREIGN KEY: fk_khachhang_nhansu_chinh
- FOREIGN KEY: khach_hang_nguoi_gioi_thieu_id_fkey
- CHECK: 27491_43793_1_not_null

## Table: lenh_san_xuat

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| organization_id | uuid | YES | - | |
| ma_lenh | text | YES | - | |
| don_hang_chi_tiet_id | uuid | YES | - | üîó FK -> don_hang_chi_tiet.id |
| quy_trinh_id | uuid | YES | - | üîó FK -> quy_trinh_mau.id |
| trang_thai | text | YES | 'moi'::text... | |
| tien_do | integer | YES | 0... | |
| nguoi_phu_trach | uuid | YES | - | üîó FK -> nhan_su.id |
| ma_qr_san_pham | text | YES | - | |
| bat_dau_luc | timestamp with time zone | YES | - | |
| ket_thuc_luc | timestamp with time zone | YES | - | |

> Constraints:

- FOREIGN KEY: lenh_san_xuat_don_hang_chi_tiet_id_fkey
- UNIQUE: lenh_san_xuat_ma_lenh_key
- FOREIGN KEY: lenh_san_xuat_nguoi_phu_trach_fkey
- FOREIGN KEY: lenh_san_xuat_quy_trinh_id_fkey
- CHECK: 27491_53280_1_not_null

## Table: lich_su_trung_thuong

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| nhan_su_id | uuid | YES | - | üîó FK -> nhan_su.id |
| qua_id | text | YES | - | üîó FK -> cau_hinh_hop_qua.id |
| ngay_trung | timestamp with time zone | YES | now()... | |

> Constraints:

- FOREIGN KEY: lich_su_trung_thuong_nhan_su_id_fkey
- FOREIGN KEY: lich_su_trung_thuong_qua_id_fkey
- CHECK: 27491_53400_1_not_null

## Table: lich_su_vi_pham

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| nhan_su_id | uuid | YES | - | üîó FK -> nhan_su.id |
| loai | text | YES | - | |
| ly_do | text | YES | - | |
| so_tien | numeric | YES | - | |
| ngay_ghi_nhan | timestamp with time zone | YES | now()... | |

> Constraints:

- FOREIGN KEY: lich_su_vi_pham_nhan_su_id_fkey
- CHECK: 27491_53366_1_not_null

## Table: mau_thiet_ke

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| mo_ta | text | YES | - | |
| phan_loai | text | YES | - | |
| phan_loai_normalized | text | YES | - | |
| hinh_anh | text | YES | - | |
| nguoi_tao | uuid | YES | - | üîó FK -> nhan_su.id |
| tao_luc | timestamp with time zone | YES | now()... | |
| file_thiet_ke | jsonb | YES | '[]'::jsonb... | |

> Constraints:

- FOREIGN KEY: mau_thiet_ke_nguoi_tao_fkey
- CHECK: 27491_55088_1_not_null

## Table: nhan_su

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| vi_tri | text | YES | - | |
| email | text | YES | - | |
| so_dien_thoai | text | YES | - | |
| so_tai_khoan | text | YES | - | |
| ngan_hang | text | YES | - | |
| luong_thang | bigint | YES | 0... | |
| thuong_doanh_thu | bigint | YES | 0... | |
| hinh_anh | text | YES | - | |
| ho_ten | text | YES | - | |
| luong_theo_gio | numeric | YES | - | |
| nguoi_tao | uuid | YES | auth.uid()... | üîó FK -> nhan_su.id |
| tao_luc | timestamp with time zone | YES | now()... | |
| trang_thai | text | YES | 'ƒêang ho·∫°t ƒë·ªông'::te... | |
| vi_tri_normalized | text | YES | - | |
| organization_id | uuid | YES | '00000000-0000-0000-... | |
| ma_qr_dinh_danh | text | YES | - | |
| diem_cong_hien | integer | YES | 0... | |
| cap_bac_game | text | YES | 'H·ªçc vi·ªác'::text... | |
| so_sao_tin_nhiem | numeric | YES | 5.0... | |
| metadata_hanh_vi | jsonb | YES | '{}'::jsonb... | |
| luong_co_ban | numeric | YES | 0... | |

> Constraints:

- FOREIGN KEY: fk_nhan_su_nguoi_tao
- UNIQUE: nhan_su_email_unique
- UNIQUE: nhan_su_ma_qr_dinh_danh_key
- CHECK: 27491_27601_1_not_null

## Table: nhat_ky_san_xuat

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| lenh_san_xuat_id | uuid | YES | - | üîó FK -> lenh_san_xuat.id |
| buoc_mau_id | uuid | YES | - | üîó FK -> cac_buoc_mau.id |
| nhan_su_thuc_hien | uuid | YES | - | üîó FK -> nhan_su.id |
| thoi_gian_bat_dau | timestamp with time zone | YES | - | |
| thoi_gian_ket_thuc | timestamp with time zone | YES | - | |
| ket_qua | text | YES | - | |
| so_luong_hoan_thanh | integer | YES | - | |
| anh_thanh_pham | text | YES | - | |
| diem_thuong_nhan_duoc | integer | YES | 0... | |
| qua_tang_random | jsonb | YES | - | |

> Constraints:

- FOREIGN KEY: nhat_ky_san_xuat_buoc_mau_id_fkey
- FOREIGN KEY: nhat_ky_san_xuat_lenh_san_xuat_id_fkey
- FOREIGN KEY: nhat_ky_san_xuat_nhan_su_thuc_hien_fkey
- CHECK: 27491_53307_1_not_null

## Table: nhom_vat_tu

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| ten_nhom | text | YES | - | |
| organization_id | uuid | YES | - | |

> Constraints:

- CHECK: 27491_53159_1_not_null

## Table: notifications

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| user_id | uuid | NO | - | |
| type | text | NO | - | |
| category | text | NO | - | |
| title | text | NO | - | |
| message | text | YES | - | |
| from_user_id | uuid | YES | - | |
| from_user_name | text | YES | - | |
| from_user_avatar | text | YES | - | |
| related_id | text | YES | - | |
| action_url | text | YES | - | |
| is_read | boolean | YES | false... | |
| created_at | timestamp with time zone | YES | now()... | |
| updated_at | timestamp with time zone | YES | now()... | |

> Constraints:

- CHECK: 27491_54947_1_not_null
- CHECK: 27491_54947_2_not_null
- CHECK: 27491_54947_3_not_null
- CHECK: 27491_54947_4_not_null
- CHECK: 27491_54947_5_not_null

## Table: push_subscriptions

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| user_id | uuid | NO | - | |
| endpoint | text | NO | - | |
| p256dh | text | NO | - | |
| auth | text | NO | - | |
| user_agent | text | YES | - | |
| created_at | timestamp with time zone | YES | now()... | |

> Constraints:

- CHECK: 27491_54968_1_not_null
- CHECK: 27491_54968_2_not_null
- CHECK: 27491_54968_3_not_null
- CHECK: 27491_54968_4_not_null
- CHECK: 27491_54968_5_not_null

## Table: quy_trinh_mau

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| ten_quy_trinh | text | YES | - | |
| loai_ap_dung | text | YES | - | |
| organization_id | uuid | YES | - | |

> Constraints:

- CHECK: 27491_53187_1_not_null

## Table: routing_permissions

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | integer | NO | nextval('routing_per... | üîë PK |
| user_type | character varying | NO | - | |
| role_normalized | character varying | NO | - | |
| allowed_routes | ARRAY | NO | - | |
| default_route | character varying | NO | - | |
| created_at | timestamp with time zone | YES | now()... | |

> Constraints:

- CHECK: 27491_49689_1_not_null
- CHECK: 27491_49689_2_not_null
- CHECK: 27491_49689_3_not_null
- CHECK: 27491_49689_4_not_null
- CHECK: 27491_49689_5_not_null

## Table: slider_data

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | bigint | NO | - | üîë PK |
| loai_slider | text | NO | - | |
| tieu_de | text | YES | - | |
| mo_ta | text | YES | - | |
| hinh_anh | text | YES | - | |
| thu_tu | integer | YES | 0... | |
| tao_luc | timestamp with time zone | YES | now()... | |

> Constraints:

- CHECK: 27491_54911_1_not_null
- CHECK: 27491_54911_2_not_null

## Table: so_cai_tai_chinh

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| organization_id | uuid | YES | - | |
| loai_giao_dich | text | YES | - | |
| so_tien | numeric | YES | - | |
| mo_ta | text | YES | - | |
| tham_chieu_id | uuid | YES | - | |
| hinh_anh_chung_tu | text | YES | - | |
| nguoi_thuc_hien | uuid | YES | - | üîó FK -> nhan_su.id |
| tao_luc | timestamp with time zone | YES | now()... | |

> Constraints:

- FOREIGN KEY: so_cai_tai_chinh_nguoi_thuc_hien_fkey
- CHECK: 27491_53331_1_not_null

## Table: to_chuc

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| ten_to_chuc | text | NO | - | |
| ma_so_thue | text | YES | - | |
| cau_hinh | jsonb | YES | '{"theme": "dark", "... | |
| tao_luc | timestamp with time zone | YES | now()... | |

> Constraints:

- CHECK: 27491_53148_1_not_null
- CHECK: 27491_53148_2_not_null

## Table: tu_van_messages

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| session_id | uuid | YES | - | üîó FK -> tu_van_sessions.id |
| nguoi_gui_id | text | YES | - | |
| la_nhan_vien | boolean | YES | false... | |
| noi_dung | text | YES | - | |
| hinh_anh | text | YES | - | |
| tao_luc | timestamp with time zone | YES | now()... | |

> Constraints:

- FOREIGN KEY: tu_van_messages_session_id_fkey
- CHECK: 27491_54932_1_not_null

## Table: tu_van_sessions

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| khach_hang_id | uuid | YES | - | |
| khach_vang_lai_id | text | YES | - | |
| ten_hien_thi | text | YES | - | |
| sdt_lien_he | text | YES | - | |
| loai_khach | text | YES | 'vang_lai'::text... | |
| trang_thai | text | YES | 'cho_tu_van'::text... | |
| nhan_su_phu_trach_id | uuid | YES | - | |
| tin_nhan_cuoi | text | YES | - | |
| cap_nhat_luc | timestamp with time zone | YES | now()... | |
| tao_luc | timestamp with time zone | YES | now()... | |
| ho_tro_vien_ids | ARRAY | YES | '{}'::uuid[]... | |
| is_read | boolean | YES | true... | |
| last_sender_type | text | YES | 'staff'::text... | |

> Constraints:

- CHECK: 27491_54920_1_not_null

## Table: user_devices

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| user_id | uuid | YES | - | üîó FK -> nhan_su.id |
| fcm_token | text | NO | - | |
| platform | text | YES | - | |
| last_active | timestamp with time zone | YES | now()... | |

> Constraints:

- UNIQUE: user_devices_user_id_fcm_token_key
- FOREIGN KEY: user_devices_user_id_fkey
- CHECK: 27491_56281_1_not_null
- CHECK: 27491_56281_3_not_null

## Table: user_registrations

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| auth_user_id | uuid | YES | - | |
| ho_ten | text | YES | - | |
| email | text | YES | - | |
| so_dien_thoai | text | YES | - | |
| user_type | text | YES | - | |
| requested_vi_tri | text | YES | - | |
| requested_phan_loai | text | YES | - | |
| status | text | YES | 'pending'::text... | |
| created_at | timestamp with time zone | YES | now()... | |
| hinh_anh | text | YES | - | |
| details | jsonb | YES | - | |

> Constraints:

- CHECK: 27491_54958_1_not_null

## Table: vat_tu

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| organization_id | uuid | YES | - | |
| ma_sku | text | YES | - | |
| ten_vat_tu | text | NO | - | |
| loai_vat_tu | text | YES | - | |
| don_vi_tinh | text | YES | - | |
| gia_von | numeric | YES | 0... | |
| gia_ban | numeric | YES | 0... | |
| ton_kho | numeric | YES | 0... | |
| canh_bao_toi_thieu | numeric | YES | 10... | |
| nhom_id | uuid | YES | - | üîó FK -> nhom_vat_tu.id |
| bo_suu_tap | text | YES | - | |
| hinh_anh | text | YES | - | |
| metadata | jsonb | YES | '{}'::jsonb... | |

> Constraints:

- UNIQUE: vat_tu_ma_sku_key
- FOREIGN KEY: vat_tu_nhom_id_fkey
- CHECK: 27491_53167_1_not_null
- CHECK: 27491_53167_4_not_null

## Table: yeu_cau_ho_tro

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | üîë PK |
| nguoi_gui_id | uuid | YES | - | üîó FK -> nhan_su.id |
| loai_yeu_cau | text | YES | - | |
| noi_dung | text | YES | - | |
| trang_thai | text | YES | 'moi'::text... | |
| nguoi_nhan_id | uuid | YES | - | üîó FK -> nhan_su.id |
| hinh_anh_dinh_kem | text | YES | - | |
| diem_thuong | integer | YES | 5... | |
| tao_luc | timestamp with time zone | YES | now()... | |

> Constraints:

- FOREIGN KEY: yeu_cau_ho_tro_nguoi_gui_id_fkey
- FOREIGN KEY: yeu_cau_ho_tro_nguoi_nhan_id_fkey
- CHECK: 27491_53345_1_not_null

|
</file>

<file path="GiaoDienTong/KhungGiaoDienTong.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Loader2 } from 'lucide-react';

// üü¢ C·∫¨P NH·∫¨T IMPORT
 
import CongDangNhap from '../CongDangNhap/CongDangNhap'; 
import StaffPresence from '../components/StaffPresence';

export default function KhungGiaoDienTong({ children }: { children: React.ReactNode }) {
  const pathname = usePathname();
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(true);
  const [currentUser, setCurrentUser] = useState<any>(null);

  useEffect(() => {
    const loadUser = () => {
      // 1. C√°c trang t·ª± qu·∫£n l√Ω auth -> Cho qua lu√¥n
      if (pathname === '/' || pathname === '/admin' || pathname === '/phongquanly' || pathname === '/phongparttime' || pathname === '/trangchu') {
          setIsLoading(false);
          return;
      }

      // 2. Load user t·ª´ localStorage
      const storedUser = typeof window !== 'undefined' ? localStorage.getItem('USER_INFO') : null;
      
      if (storedUser) {
        try {
          setCurrentUser(JSON.parse(storedUser));
        } catch (e) {
          console.error('Error parsing user:', e);
        }
      }
      
      setIsLoading(false);
    };

    loadUser();
  }, [pathname]);

  if (isLoading) return (
      <div className="h-screen bg-black flex flex-col items-center justify-center gap-4">
          <Loader2 className="animate-spin text-[#C69C6D]" size={40}/>
      </div>
  );
 
  return (
    <div className="flex flex-col min-h-screen bg-[#0a0a0a] text-gray-200 font-sans relative">
        <main className="flex-1 w-full max-w-[1920px] mx-auto p-3 pb-20 md:p-6 md:pb-20">
            {children}
        </main>
 <StaffPresence />
 
    </div>
  );
}
</file>

<file path="GiaoDienTong/MenuSystemWrapper.tsx">
"use client";

import React from "react";

interface MenuSystemWrapperProps {
  currentUser?: any;
  onToggleContent?: (isOpen: boolean) => void;
  onlyAccountButton?: boolean;
}

/**
 * üé® Reusable Menu System Wrapper
 * Packages gradient overlays + MenuDuoi for consistent styling across all pages
 * Usage: <MenuSystemWrapper currentUser={user} onlyAccountButton={true} />
 */
export default function MenuSystemWrapper({
  currentUser,
  onToggleContent,
  onlyAccountButton,
}: MenuSystemWrapperProps) {
  return (
    <>
      {/* GRADIENT B·∫¢O V·ªÜ MENU - Bottom */}
      <div className="fixed bottom-0 left-0 right-0 h-28 bg-gradient-to-t from-black to-transparent z-[4900] pointer-events-none"></div>
    </>
  );
}
</file>

<file path="GiaoDienTong/MenuTren/MenuTren.tsx">
"use client";
import React, { useState, useEffect, useRef } from "react";
import { createPortal } from "react-dom";
import { ShoppingCart, QrCode, UserCircle } from "lucide-react";
import NhacNen from "@/app/Music/NhacNen";
import NotificationCenter from "./NotificationCenter";
import { NotificationService } from "./NotificationService";
import { Notification } from "./NotificationTypes";
import { useUser } from "@/app/ThuVien/UserContext";
import { Z_INDEX } from "@/app/constants/zIndex";
import { useAppSettings } from "@/app/ThuVien/AppSettingsContext";
import ModalProfile from "@/app/GiaoDienTong/MenuTren/NutCaNhan/ModalProfile";

// Hook √¢m thanh th√¥ng b√°o
const useNotificationSound = () => {
  const audioRef = useRef<HTMLAudioElement | null>(null);
  useEffect(() => {
    if (typeof window !== "undefined") {
      audioRef.current = new Audio("/sounds/hover.mp3");
    }
  }, []);
  return () => {
    if (audioRef.current) {
      audioRef.current.currentTime = 0;
      audioRef.current.play().catch(() => {});
    }
  };
};

export default function MenuTren({
  nguoiDung: fallbackUser,
}: {
  nguoiDung: any;
  loiChao: string;
}) {
  const { user: contextUser } = useUser();
  const { t } = useAppSettings();
  const playSound = useNotificationSound();

  // ∆Øu ti√™n user t·ª´ context
  const nguoiDung = contextUser
    ? {
        id: contextUser.id,
        ho_ten: contextUser.ho_ten || t("profile.user"),
        email: contextUser.email,
        role:
          contextUser.userType === "nhan_su"
            ? contextUser.vi_tri_normalized
            : contextUser.phan_loai_normalized,
        permissions: contextUser.permissions,
        vi_tri: contextUser.vi_tri,
        userType: contextUser.userType,
        phan_loai: contextUser.phan_loai,
        so_dien_thoai: contextUser.so_dien_thoai,
      }
    : fallbackUser;

  const isVisitor =
    !nguoiDung ||
    nguoiDung?.userType === "guest" ||
    nguoiDung?.role === "visitor";
  const isNhanSu = nguoiDung?.userType === "nhan_su";

  // State
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const [unreadCount, setUnreadCount] = useState(0);
  const [cartCount, setCartCount] = useState(0);
  const [showProfile, setShowProfile] = useState(false);
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  // üü¢ LOGIC L·∫§Y T√äN HI·ªÇN TH·ªä (R√öT G·ªåN CHO MOBILE)
  const getDisplayName = () => {
    if (isVisitor) return { full: "Qu√Ω Kh√°ch", short: "KH√ÅCH" };

    const fullName = nguoiDung?.ho_ten || "";
    const lastName = fullName.trim().split(" ").pop()?.toUpperCase() || "B·∫†N";

    return {
      full: fullName,
      short: lastName,
    };
  };

  const displayName = getDisplayName();

  // üü¢ LOGIC GI·ªé H√ÄNG
  useEffect(() => {
    if (isNhanSu) return;

    const checkCart = () => {
      try {
        const cartData = localStorage.getItem("cart_items");
        const items = cartData ? JSON.parse(cartData) : [];
        setCartCount(items.length || 0);
      } catch {
        setCartCount(0);
      }
    };

    checkCart();
    window.addEventListener("storage", checkCart);
    window.addEventListener("cart_updated", checkCart);

    return () => {
      window.removeEventListener("storage", checkCart);
      window.removeEventListener("cart_updated", checkCart);
    };
  }, [isNhanSu]);

  // üü¢ NOTIFICATION LOGIC
  useEffect(() => {
    if (!nguoiDung?.id || isVisitor) return;

    let isMounted = true;
    let subscription: any = null;

    const initNotifications = async () => {
      try {
        const [notifs, count] = await Promise.all([
          NotificationService.getUserNotifications(nguoiDung.id),
          NotificationService.getUnreadCount(nguoiDung.id),
        ]);

        if (isMounted) {
          setNotifications(notifs);
          setUnreadCount(count);
        }

        subscription = NotificationService.subscribeToNotifications(
          nguoiDung.id,
          (newNotification) => {
            if (isMounted) {
              playSound();
              setNotifications((prev) => {
                if (prev.some((n) => n.id === newNotification.id)) return prev;
                return [newNotification, ...prev];
              });
              if (!newNotification.is_read) setUnreadCount((prev) => prev + 1);
            }
          }
        );
      } catch (error) {
        console.error("L·ªói th√¥ng b√°o:", error);
      }
    };

    initNotifications();

    return () => {
      isMounted = false;
      if (subscription?.unsubscribe) subscription.unsubscribe();
    };
  }, [nguoiDung?.id, isVisitor]);

  const handleMarkAsRead = async (id: string) => {
    setNotifications((prev) =>
      prev.map((n) => (n.id === id ? { ...n, is_read: true } : n))
    );
    setUnreadCount((prev) => Math.max(0, prev - 1));
    await NotificationService.markAsRead(id);
  };

  const handleMarkAllAsRead = async () => {
    if (!nguoiDung?.id) return;
    setNotifications((prev) => prev.map((n) => ({ ...n, is_read: true })));
    setUnreadCount(0);
    await NotificationService.markAllAsRead(nguoiDung.id);
  };

  const handleDelete = async (id: string) => {
    setNotifications((prev) => {
      const notif = prev.find((n) => n.id === id);
      if (notif && !notif.is_read) setUnreadCount((c) => Math.max(0, c - 1));
      return prev.filter((n) => n.id !== id);
    });
    await NotificationService.deleteNotification(id);
  };

  const handleNotificationClick = (notification: Notification) => {
    if (notification.action_url) window.location.href = notification.action_url;
    if (!notification.is_read) handleMarkAsRead(notification.id);
  };

  return (
    <>
      <div
        className={`fixed top-0 left-0 right-0 h-[65px] md:h-[85px] px-3 md:px-6 flex justify-between items-center bg-transparent transition-all duration-300 pointer-events-none`}
        style={{ zIndex: Z_INDEX.menuTren }}
      >
        {/* üü¢ G√ìC TR√ÅI: T√äN HI·ªÇN TH·ªä (CO GI√ÉN T·ªêT) */}
        <div className="flex-1 min-w-0 flex items-center gap-2 animate-slide-down pointer-events-auto mr-2">
          {/* Desktop: Hi·ªán ƒë·∫ßy ƒë·ªß */}
          <div className="hidden md:flex flex-col">
            <span className="text-xs font-medium italic text-gray-300 drop-shadow-md">
              {isVisitor ? "Ch√†o m·ª´ng," : "Xin ch√†o,"}
            </span>
            <span
              className="font-black text-white uppercase tracking-wider drop-shadow-lg shadow-black truncate max-w-[200px] lg:max-w-none"
              style={{ fontSize: "20px" }}
            >
              {displayName.full}
            </span>
          </div>

          {/* Mobile: Hi·ªán r√∫t g·ªçn */}
          <div className="md:hidden flex items-baseline gap-1 overflow-hidden">
            <span className="text-[10px] text-gray-300 italic whitespace-nowrap">
              Ch√†o
            </span>
            <span className="font-bold text-[#C69C6D] uppercase truncate text-sm drop-shadow-md">
              {displayName.short}
            </span>
          </div>
        </div>

        {/* üü¢ G√ìC PH·∫¢I: C√ÅC N√öT (KH√îNG BAO GI·ªú B·ªä ƒê·∫®Y M·∫§T) */}
        {!isVisitor && (
          <div className="shrink-0 flex gap-1.5 md:gap-3 animate-slide-down delay-100 pointer-events-auto items-center">
            {/* 1. Nh·∫°c n·ªÅn: Hi·ªán m·ªçi n∆°i */}
            {nguoiDung?.id && <NhacNen />}

            {/* 2. Gi·ªè h√†ng: Ch·ªâ hi·ªán n·∫øu l√† Kh√°ch h√†ng & c√≥ ƒë·ªì */}
            {!isNhanSu && cartCount > 0 && (
              <NutVuong
                icon={ShoppingCart}
                badge={cartCount}
                onClick={() => {
                  /* Logic m·ªü gi·ªè h√†ng */
                }}
                className="animate-bounce-slow"
              />
            )}

            {/* 3. Th√¥ng b√°o */}
            {nguoiDung?.id && (
              <NotificationCenter
                notifications={notifications}
                unreadCount={unreadCount}
                onMarkAsRead={handleMarkAsRead}
                onMarkAllAsRead={handleMarkAllAsRead}
                onDelete={handleDelete}
                onNotificationClick={handleNotificationClick}
              />
            )}

            {/* 4. QR Code: CH·ªà HI·ªÜN TR√äN DESKTOP (Mobile ·∫©n ƒëi ƒë·ªÉ ti·∫øt ki·ªám ch·ªó cho Nh·∫°c) */}
            <div className="hidden md:block">
              <NutVuong icon={QrCode} />
            </div>

            {/* 5. N√∫t C√° Nh√¢n: Lu√¥n hi·ªán */}
            <NutVuong
              icon={UserCircle}
              onClick={() => setShowProfile(true)}
              isActive={showProfile}
            />
          </div>
        )}
      </div>

      {mounted &&
        showProfile &&
        nguoiDung &&
        !isVisitor &&
        createPortal(
          <ModalProfile
            isOpen={true}
            onClose={() => setShowProfile(false)}
            nguoiDung={nguoiDung}
          />,
          document.body
        )}
    </>
  );
}

// Component N√∫t Vu√¥ng (ƒê√£ ch·ªânh padding nh·ªè h∆°n cho Mobile)
function NutVuong({
  icon: Icon,
  badge,
  onClick,
  isActive,
  className = "",
}: any) {
  return (
    <button
      onClick={onClick}
      className={`
                w-9 h-9 md:w-10 md:h-10 rounded-lg flex items-center justify-center relative active:scale-95 transition-all backdrop-blur-sm shadow-sm group cursor-pointer
                ${
                  isActive
                    ? "bg-[#C69C6D] border border-[#C69C6D] text-black shadow-[0_0_15px_rgba(198,156,109,0.4)]"
                    : "bg-black/40 border border-white/10 hover:bg-white/10 text-white"
                }
                ${className}
            `}
    >
      <Icon
        size={18}
        className={`transition-colors ${
          isActive ? "text-black" : "text-white group-hover:text-[#C69C6D]"
        }`}
      />

      {badge && badge > 0 && (
        <span className="absolute -top-1.5 -right-1.5 w-4 h-4 bg-red-600 text-white text-[9px] font-bold flex items-center justify-center rounded-full border border-black shadow-sm z-10 animate-in zoom-in">
          {badge > 99 ? "99+" : badge}
        </span>
      )}
    </button>
  );
}
</file>

<file path="GiaoDienTong/MenuTren/NotificationCenter.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { Bell, X, Check, CheckCircle2, MessageCircle, Heart, Users, Zap, AlertCircle, ShoppingBag, Calendar, Award } from 'lucide-react';
import { Notification, NotificationGroup, NOTIFICATION_CONFIG, NotificationType } from './NotificationTypes';
import { useAppSettings } from '@/app/ThuVien/AppSettingsContext';

interface Props {
  notifications: Notification[];
  unreadCount: number;
  onMarkAsRead: (id: string) => void;
  onMarkAllAsRead: () => void;
  onDelete: (id: string) => void;
  onNotificationClick: (notification: Notification) => void;
}

export default function NotificationCenter({ 
  notifications, 
  unreadCount, 
  onMarkAsRead, 
  onMarkAllAsRead, 
  onDelete,
  onNotificationClick 
}: Props) {
  const [isOpen, setIsOpen] = useState(false);
  const [filteredCategory, setFilteredCategory] = useState<string | null>(null);
  const { t, language } = useAppSettings(); // üåê Hook ng√¥n ng·ªØ

  // Nh√≥m th√¥ng b√°o theo category
  const groupedNotifications: NotificationGroup[] = React.useMemo(() => {
    const groups: Record<string, Notification[]> = {};
    
    notifications.forEach(notif => {
      if (!groups[notif.category]) {
        groups[notif.category] = [];
      }
      groups[notif.category].push(notif);
    });

    return Object.entries(groups).map(([category, notifs]) => ({
      category: category as any,
      label: getCategoryLabel(category),
      notifications: notifs.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime()),
      unread_count: notifs.filter(n => !n.is_read).length,
      icon: getCategoryIcon(category),
      color: getCategoryColor(category)
    }));
  }, [notifications]);

  const displayedNotifications = filteredCategory 
    ? groupedNotifications.find(g => g.category === filteredCategory)?.notifications || []
    : notifications.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());

  return (
    <div className="relative">
      {/* Notification Button */}
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className="relative w-10 h-10 bg-black/40 border border-white/10 rounded-lg flex items-center justify-center transition-all hover:bg-white/10 backdrop-blur-sm group active:scale-95"
      >
        <Bell size={18} className="text-[#C69C6D]" />
        
        {/* Badge - Unread count */}
        {unreadCount > 0 && (
          <div className="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-lg">
            {unreadCount > 99 ? '99+' : unreadCount}
          </div>
        )}

        {/* Indicator dot */}
        {unreadCount > 0 && (
          <div className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
        )}
      </button>

      {/* Notification Dropdown */}
      {isOpen && (
        <div className="fixed md:absolute top-[85px] md:top-[120%] left-0 md:left-auto md:right-0 w-screen md:w-[450px] md:max-h-[600px] bg-[#0a0807]/95 border-t md:border border-[#8B5E3C]/30 rounded-none md:rounded-xl shadow-2xl overflow-hidden z-[5100] backdrop-blur-xl flex flex-col animate-in fade-in slide-in-from-top-2 duration-200"
        >
          {/* Header */}
          <div className="sticky top-0 px-4 py-3 border-b border-[#8B5E3C]/20 bg-black/50 flex items-center justify-between">
            <div className="flex items-center gap-2">
              <h3 className="text-sm font-bold text-white uppercase tracking-widest">{t('notifications.title')}</h3>
              {unreadCount > 0 && (
                <span className="text-xs font-bold bg-red-500 text-white px-2 py-0.5 rounded-full">
                  {unreadCount} {t('notifications.new')}
                </span>
              )}
            </div>
            <div className="flex items-center gap-1">
              {unreadCount > 0 && (
                <button 
                  onClick={onMarkAllAsRead}
                  className="p-1.5 text-[#C69C6D] hover:bg-white/10 rounded transition-all active:scale-95"
                  title={t('notifications.markAllRead')}
                >
                  <CheckCircle2 size={16} />
                </button>
              )}
              <button 
                onClick={() => setIsOpen(false)}
                className="p-1.5 text-gray-400 hover:text-white hover:bg-white/10 rounded transition-all md:hidden active:scale-95"
              >
                <X size={18} />
              </button>
            </div>
          </div>

          {/* Category Filter */}
          {groupedNotifications.length > 0 && (
            <div className="sticky top-[53px] px-3 py-2 bg-black/30 border-b border-[#8B5E3C]/10 overflow-x-auto flex gap-2">
              <button
                onClick={() => setFilteredCategory(null)}
                className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider whitespace-nowrap transition-all active:scale-95 ${
                  filteredCategory === null
                    ? 'bg-[#C69C6D] text-black'
                    : 'bg-white/5 text-gray-300 hover:bg-white/10'
                }`}
              >
                {language === 'vi' ? 'T·∫•t c·∫£' : 'All'}
              </button>
              {groupedNotifications.map(group => (
                <button
                  key={group.category}
                  onClick={() => setFilteredCategory(group.category)}
                  className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider whitespace-nowrap transition-all flex items-center gap-1 active:scale-95 ${
                    filteredCategory === group.category
                      ? 'bg-[#C69C6D] text-black'
                      : 'bg-white/5 text-gray-300 hover:bg-white/10'
                  }`}
                >
                  {group.unread_count > 0 && (
                    <span className="bg-red-500 text-white text-[9px] font-bold rounded-full w-4 h-4 flex items-center justify-center">
                      {group.unread_count}
                    </span>
                  )}
                  {group.label}
                </button>
              ))}
            </div>
          )}

          {/* Notifications List */}
          <div className="flex-1 overflow-y-auto space-y-2 p-3">
            {displayedNotifications.length === 0 ? (
              <div className="flex flex-col items-center justify-center py-12 text-center">
                <Bell size={32} className="text-gray-500 mb-2 opacity-50" />
                <p className="text-sm text-gray-400">{t('notifications.empty')}</p>
              </div>
            ) : (
              displayedNotifications.map(notification => (
                <NotificationItem
                  key={notification.id}
                  notification={notification}
                  onMarkAsRead={() => {
                    onMarkAsRead(notification.id);
                  }}
                  onDelete={() => onDelete(notification.id)}
                  onClick={() => {
                    onNotificationClick(notification);
                    setIsOpen(false);
                  }}
                />
              ))
            )}
          </div>

          {/* Footer */}
          {notifications.length > 0 && (
            <div className="border-t border-[#8B5E3C]/20 px-4 py-3 bg-black/50 text-center">
              <button className="text-xs text-[#C69C6D] hover:text-white font-bold uppercase tracking-widest transition-all active:scale-95">
                Xem t·∫•t c·∫£ th√¥ng b√°o
              </button>
            </div>
          )}
        </div>
      )}

      {/* Overlay */}
      {isOpen && (
        <div 
          onClick={() => setIsOpen(false)}
          className="fixed inset-0 z-[5099] md:hidden"
        />
      )}
    </div>
  );
}

function NotificationItem({ 
  notification, 
  onMarkAsRead, 
  onDelete, 
  onClick 
}: {
  notification: Notification;
  onMarkAsRead: () => void;
  onDelete: () => void;
  onClick: () => void;
}) {
  const config = NOTIFICATION_CONFIG[notification.type as NotificationType];
  const IconComponent = getIconComponent(notification.type);

  return (
    <div
      onClick={onClick}
      className={`group relative p-3 rounded-lg transition-all cursor-pointer ${
        notification.is_read
          ? 'bg-white/5 hover:bg-white/10'
          : 'bg-[#C69C6D]/10 border border-[#C69C6D]/30 hover:bg-[#C69C6D]/20'
      }`}
    >
      {/* Unread indicator */}
      {!notification.is_read && (
        <div className="absolute top-3 left-3 w-2 h-2 bg-red-500 rounded-full"></div>
      )}

      <div className="flex gap-3 pl-4">
        {/* Avatar or Icon */}
        <div className="flex-shrink-0">
          {notification.from_user_avatar ? (
            <img
              src={notification.from_user_avatar}
              alt={notification.from_user_name}
              className="w-10 h-10 rounded-full object-cover border border-[#C69C6D]/30"
            />
          ) : (
            <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ backgroundColor: `${config.color}20` }}>
              <IconComponent size={18} style={{ color: config.color }} />
            </div>
          )}
        </div>

        {/* Content */}
        <div className="flex-1 min-w-0">
          <div className="flex items-start justify-between gap-2 mb-1">
            <p className="text-sm font-bold text-white truncate">
              {notification.title}
            </p>
            <span className="text-[10px] text-gray-400 flex-shrink-0">
              {formatTime(notification.created_at)}
            </span>
          </div>
          
          <p className="text-xs text-gray-300 line-clamp-2 mb-2">
            {notification.message}
          </p>

          {/* Actions */}
          <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
            {!notification.is_read && (
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onMarkAsRead();
                }}
                className="text-[10px] text-[#C69C6D] hover:text-white font-bold uppercase tracking-wider transition-all active:scale-95 flex items-center gap-1"
              >
                <Check size={12} /> ƒê√£ ƒë·ªçc
              </button>
            )}
            <button
              onClick={(e) => {
                e.stopPropagation();
                onDelete();
              }}
              className="text-[10px] text-gray-400 hover:text-red-400 font-bold uppercase tracking-wider transition-all active:scale-95"
            >
              X√≥a
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function getCategoryLabel(category: string): string {
  const labels: Record<string, string> = {
    'from_users': 'T·ª´ ng∆∞·ªùi d√πng',
    'from_system': 'T·ª´ h·ªá th·ªëng',
    'from_business': 'T·ª´ ƒë∆°n h√†ng',
    'from_events': 'T·ª´ s·ª± ki·ªán',
    'from_content': 'T·ª´ n·ªôi dung',
    'from_security': 'B·∫£o m·∫≠t'
  };
  return labels[category] || category;
}

function getCategoryColor(category: string): string {
  const colors: Record<string, string> = {
    'from_users': '#3B82F6',
    'from_system': '#6366F1',
    'from_business': '#8B5E3C',
    'from_events': '#F59E0B',
    'from_content': '#C69C6D',
    'from_security': '#EF4444'
  };
  return colors[category] || '#C69C6D';
}

function getCategoryIcon(category: string): any {
  const icons: Record<string, any> = {
    'from_users': Users,
    'from_system': Zap,
    'from_business': ShoppingBag,
    'from_events': Calendar,
    'from_content': Award,
    'from_security': AlertCircle
  };
  return icons[category] || Bell;
}

function getIconComponent(type: NotificationType): any {
  const icons: Record<NotificationType, any> = {
    'user_follow': Users,
    'user_comment': MessageCircle,
    'user_like': Heart,
    'user_message': MessageCircle,
    'user_mention': MessageCircle,
    'user_tag': MessageCircle,
    'system_update': Zap,
    'system_announcement': Zap,
    'system_alert': AlertCircle,
    'order_created': ShoppingBag,
    'order_confirmed': CheckCircle2,
    'order_shipped': ShoppingBag,
    'order_delivered': CheckCircle2,
    'payment_received': CheckCircle2,
    'event_new': Calendar,
    'event_reminder': Calendar,
    'workshop_new': Users,
    'workshop_reminder': Bell,
    'achievement_unlocked': Award,
    'milestone_reached': Award,
    'product_new': ShoppingBag,
    'artwork_new': Award,
    'artwork_featured': Award,
    'security_alert': AlertCircle,
    'login_new_device': AlertCircle
  };
  return icons[type] || Bell;
}

function formatTime(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  
  const seconds = Math.floor(diff / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);

  if (seconds < 60) return 'V·ª´a xong';
  if (minutes < 60) return `${minutes}p tr∆∞·ªõc`;
  if (hours < 24) return `${hours}h tr∆∞·ªõc`;
  if (days < 7) return `${days}d tr∆∞·ªõc`;
  
  return date.toLocaleDateString('vi-VN');
}
</file>

<file path="GiaoDienTong/MenuTren/NotificationService.ts">
import { Notification, NotificationType } from "./NotificationTypes";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { RealtimeChannel } from "@supabase/supabase-js";

export class NotificationService {
  // ... (Gi·ªØ nguy√™n c√°c h√†m getUserNotifications, getUnreadCount, create, markRead, delete...)

  static async getUserNotifications(
    userId: string,
    limit = 50
  ): Promise<Notification[]> {
    try {
      const { data, error } = await supabase
        .from("notifications")
        .select("*")
        .eq("user_id", userId)
        .order("created_at", { ascending: false })
        .limit(limit);

      if (error) throw error;
      return (data as Notification[]) || [];
    } catch (error) {
      console.error("Error fetching notifications:", error);
      return [];
    }
  }

  static async getUnreadCount(userId: string): Promise<number> {
    try {
      const { count, error } = await supabase
        .from("notifications")
        .select("*", { count: "exact", head: true })
        .eq("user_id", userId)
        .eq("is_read", false);

      if (error) throw error;
      return count || 0;
    } catch (error) {
      console.error("Error fetching unread count:", error);
      return 0;
    }
  }

  static async markAsRead(notificationId: string) {
    try {
      const { error } = await supabase
        .from("notifications")
        .update({ is_read: true, updated_at: new Date().toISOString() })
        .eq("id", notificationId);
      if (error) throw error;
      return true;
    } catch (error) {
      console.error("Error marking notification as read:", error);
      return false;
    }
  }

  static async markAllAsRead(userId: string) {
    try {
      const { error } = await supabase
        .from("notifications")
        .update({ is_read: true, updated_at: new Date().toISOString() })
        .eq("user_id", userId)
        .eq("is_read", false);
      if (error) throw error;
      return true;
    } catch (error) {
      console.error("Error marking all notifications as read:", error);
      return false;
    }
  }

  static async deleteNotification(notificationId: string) {
    try {
      const { error } = await supabase
        .from("notifications")
        .delete()
        .eq("id", notificationId);
      if (error) throw error;
      return true;
    } catch (error) {
      console.error("Error deleting notification:", error);
      return false;
    }
  }

  // üü¢ S·ª¨A L·∫†I H√ÄM SUBSCRIBE CHO AN TO√ÄN
  static subscribeToNotifications(
    userId: string,
    callback: (notification: Notification) => void
  ) {
    // T·∫°o channel v·ªõi ID duy nh·∫•t ƒë·ªÉ tr√°nh tr√πng l·∫∑p
    const channelId = `notifications:${userId}:${Date.now()}`;

    const channel = supabase
      .channel(channelId)
      .on(
        "postgres_changes",
        {
          event: "INSERT",
          schema: "public",
          table: "notifications",
          filter: `user_id=eq.${userId}`,
        },
        (payload) => {
          // Validate d·ªØ li·ªáu tr∆∞·ªõc khi callback
          if (payload.new && payload.new.id) {
            callback(payload.new as Notification);
          }
        }
      )
      .subscribe((status) => {
        if (status === "SUBSCRIBED") {
          console.log(`üîî ƒê√£ k·∫øt n·ªëi th√¥ng b√°o cho user ${userId}`);
        }
      });

    // Tr·∫£ v·ªÅ object ch·ª©a h√†m unsubscribe an to√†n
    return {
      unsubscribe: () => {
        console.log(`üîï H·ªßy k·∫øt n·ªëi th√¥ng b√°o ${channelId}`);
        supabase.removeChannel(channel);
      },
    };
  }
}
</file>

<file path="GiaoDienTong/MenuTren/NotificationTypes.ts">
// Lo·∫°i th√¥ng b√°o t·ª´ c√°c ngu·ªìn kh√°c nhau
export type NotificationType = 
  // T·ª´ NG∆Ø·ªúI D√ôNG KH√ÅC
  | 'user_follow' 
  | 'user_comment' 
  | 'user_like' 
  | 'user_message' 
  | 'user_mention'
  | 'user_tag'
  // T·ª´ H·ªÜ TH·ªêNG
  | 'system_update'
  | 'system_announcement'
  | 'system_alert'
  // T·ª´ HO·∫†T ƒê·ªòNG KINH DOANH
  | 'order_created'
  | 'order_confirmed'
  | 'order_shipped'
  | 'order_delivered'
  | 'payment_received'
  // T·ª´ S·ª∞ KI·ªÜN & WORKSHOP
  | 'event_new'
  | 'event_reminder'
  | 'workshop_new'
  | 'workshop_reminder'
  // T·ª´ T∆Ø·ªöNG C√îNG
  | 'achievement_unlocked'
  | 'milestone_reached'
  // T·ª´ N·ªòI DUNG
  | 'product_new'
  | 'artwork_new'
  | 'artwork_featured'
  // B·∫£o m·∫≠t
  | 'security_alert'
  | 'login_new_device';

export type NotificationCategory = 
  | 'from_users'      // T·ª´ ng∆∞·ªùi kh√°c
  | 'from_system'     // T·ª´ h·ªá th·ªëng
  | 'from_business'   // T·ª´ ho·∫°t ƒë·ªông kinh doanh
  | 'from_events'     // T·ª´ s·ª± ki·ªán
  | 'from_content'    // T·ª´ n·ªôi dung m·ªõi
  | 'from_security';  // T·ª´ b·∫£o m·∫≠t

export interface Notification {
  id: string;
  user_id: string;
  type: NotificationType;
  category: NotificationCategory;
  
  // Th√¥ng tin ch√≠nh
  title: string;
  message: string;
  icon?: string;
  avatar?: string;
  
  // Ng∆∞·ªùi g·ª≠i (n·∫øu t·ª´ ng∆∞·ªùi d√πng kh√°c)
  from_user_id?: string;
  from_user_name?: string;
  from_user_avatar?: string;
  
  // Li√™n k·∫øt
  related_id?: string;        // ID c·ªßa object li√™n quan (product_id, order_id, etc)
  action_url?: string;        // URL ƒë·ªÉ navigate
  
  // Tr·∫°ng th√°i
  is_read: boolean;
  created_at: string;
  updated_at: string;
  
  // H√†nh ƒë·ªông
  action_label?: string;
  action_type?: 'confirm' | 'view' | 'dismiss';
}

export interface NotificationGroup {
  category: NotificationCategory;
  label: string;
  notifications: Notification[];
  unread_count: number;
  icon: any;
  color: string;
}

export const NOTIFICATION_CONFIG: Record<NotificationType, {
  category: NotificationCategory;
  label: string;
  icon: string;
  color: string;
  priority: number;
  description: (data?: any) => string;
}> = {
  // T·ª´ NG∆Ø·ªúI D√ôNG
  'user_follow': {
    category: 'from_users',
    label: 'Theo d√µi m·ªõi',
    icon: 'UserPlus',
    color: '#3B82F6',
    priority: 5,
    description: (data) => `${data?.from_user_name} ƒë√£ theo d√µi b·∫°n`
  },
  'user_comment': {
    category: 'from_users',
    label: 'B√¨nh lu·∫≠n m·ªõi',
    icon: 'MessageCircle',
    color: '#8B5E3C',
    priority: 4,
    description: (data) => `${data?.from_user_name} ƒë√£ b√¨nh lu·∫≠n: "${data?.message}"`
  },
  'user_like': {
    category: 'from_users',
    label: 'Y√™u th√≠ch',
    icon: 'Heart',
    color: '#EF4444',
    priority: 3,
    description: (data) => `${data?.from_user_name} y√™u th√≠ch t√°c ph·∫©m c·ªßa b·∫°n`
  },
  'user_message': {
    category: 'from_users',
    label: 'Tin nh·∫Øn m·ªõi',
    icon: 'Mail',
    color: '#10B981',
    priority: 6,
    description: (data) => `Tin nh·∫Øn t·ª´ ${data?.from_user_name}: "${data?.message}"`
  },
  'user_mention': {
    category: 'from_users',
    label: 'ƒê∆∞·ª£c ƒë·ªÅ c·∫≠p',
    icon: 'AtSign',
    color: '#C69C6D',
    priority: 4,
    description: (data) => `${data?.from_user_name} ƒë√£ ƒë·ªÅ c·∫≠p ƒë·∫øn b·∫°n`
  },
  'user_tag': {
    category: 'from_users',
    label: 'ƒê∆∞·ª£c g·∫Øn th·∫ª',
    icon: 'Tag',
    color: '#8B5E3C',
    priority: 4,
    description: (data) => `${data?.from_user_name} ƒë√£ g·∫Øn th·∫ª b·∫°n`
  },

  // T·ª´ H·ªÜ TH·ªêNG
  'system_update': {
    category: 'from_system',
    label: 'C·∫≠p nh·∫≠t h·ªá th·ªëng',
    icon: 'RefreshCw',
    color: '#6366F1',
    priority: 2,
    description: (data) => 'H·ªá th·ªëng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v·ªõi c√°c t√≠nh nƒÉng m·ªõi'
  },
  'system_announcement': {
    category: 'from_system',
    label: 'Th√¥ng b√°o chung',
    icon: 'Megaphone',
    color: '#F59E0B',
    priority: 3,
    description: (data) => data?.message || 'C√≥ th√¥ng b√°o chung m·ªõi t·ª´ h·ªá th·ªëng'
  },
  'system_alert': {
    category: 'from_system',
    label: 'C·∫£nh b√°o h·ªá th·ªëng',
    icon: 'AlertCircle',
    color: '#EF4444',
    priority: 5,
    description: (data) => data?.message || 'C·∫£nh b√°o t·ª´ h·ªá th·ªëng'
  },

  // T·ª´ HO·∫†T ƒê·ªòNG KINH DOANH
  'order_created': {
    category: 'from_business',
    label: 'ƒê∆°n h√†ng m·ªõi',
    icon: 'ShoppingBag',
    color: '#8B5E3C',
    priority: 4,
    description: (data) => `ƒê∆°n h√†ng #${data?.related_id} c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c t·∫°o`
  },
  'order_confirmed': {
    category: 'from_business',
    label: 'ƒê∆°n h√†ng x√°c nh·∫≠n',
    icon: 'CheckCircle',
    color: '#10B981',
    priority: 3,
    description: (data) => `ƒê∆°n h√†ng #${data?.related_id} ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n`
  },
  'order_shipped': {
    category: 'from_business',
    label: 'ƒê∆°n h√†ng ƒë√£ g·ª≠i',
    icon: 'Truck',
    color: '#3B82F6',
    priority: 3,
    description: (data) => `ƒê∆°n h√†ng #${data?.related_id} ƒëang tr√™n ƒë∆∞·ªùng t·ªõi`
  },
  'order_delivered': {
    category: 'from_business',
    label: 'ƒê∆°n h√†ng ƒë√£ giao',
    icon: 'Package',
    color: '#10B981',
    priority: 3,
    description: (data) => `ƒê∆°n h√†ng #${data?.related_id} ƒë√£ ƒë∆∞·ª£c giao th√†nh c√¥ng`
  },
  'payment_received': {
    category: 'from_business',
    label: 'Thanh to√°n nh·∫≠n ƒë∆∞·ª£c',
    icon: 'CreditCard',
    color: '#10B981',
    priority: 4,
    description: (data) => `Thanh to√°n ${data?.message} ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n`
  },

  // T·ª´ S·ª∞ KI·ªÜN & WORKSHOP
  'event_new': {
    category: 'from_events',
    label: 'S·ª± ki·ªán m·ªõi',
    icon: 'Calendar',
    color: '#8B5E3C',
    priority: 2,
    description: (data) => `S·ª± ki·ªán m·ªõi: ${data?.message}`
  },
  'event_reminder': {
    category: 'from_events',
    label: 'Nh·∫Øc nh·ªü s·ª± ki·ªán',
    icon: 'Clock',
    color: '#F59E0B',
    priority: 4,
    description: (data) => `S·ª± ki·ªán s·∫Øp di·ªÖn ra: ${data?.message}`
  },
  'workshop_new': {
    category: 'from_events',
    label: 'Workshop m·ªõi',
    icon: 'Users',
    color: '#8B5E3C',
    priority: 2,
    description: (data) => `Workshop m·ªõi: ${data?.message}`
  },
  'workshop_reminder': {
    category: 'from_events',
    label: 'Nh·∫Øc nh·ªü workshop',
    icon: 'Bell',
    color: '#F59E0B',
    priority: 4,
    description: (data) => `Workshop s·∫Øp b·∫Øt ƒë·∫ßu: ${data?.message}`
  },

  // T·ª´ ƒê·∫†T C√îNG
  'achievement_unlocked': {
    category: 'from_content',
    label: 'Th√†nh t·ª±u m·ªü kh√≥a',
    icon: 'Award',
    color: '#FBBF24',
    priority: 3,
    description: (data) => `B·∫°n ƒë√£ m·ªü kh√≥a th√†nh t·ª±u: ${data?.message}`
  },
  'milestone_reached': {
    category: 'from_content',
    label: 'C·ªôt m·ªëc ƒë·∫°t ƒë∆∞·ª£c',
    icon: 'Target',
    color: '#FBBF24',
    priority: 3,
    description: (data) => `Ch√∫c m·ª´ng! B·∫°n ƒë√£ ƒë·∫°t ${data?.message}`
  },

  // T·ª´ N·ªòI DUNG
  'product_new': {
    category: 'from_content',
    label: 'S·∫£n ph·∫©m m·ªõi',
    icon: 'Package',
    color: '#8B5E3C',
    priority: 1,
    description: (data) => `T√°c ph·∫©m m·ªõi: ${data?.message}`
  },
  'artwork_new': {
    category: 'from_content',
    label: 'T√°c ph·∫©m m·ªõi',
    icon: 'Image',
    color: '#8B5E3C',
    priority: 1,
    description: (data) => `T√°c ph·∫©m m·ªõi ƒë√£ ƒë∆∞·ª£c th√™m: ${data?.message}`
  },
  'artwork_featured': {
    category: 'from_content',
    label: 'T√°c ph·∫©m n·ªïi b·∫≠t',
    icon: 'Star',
    color: '#FBBF24',
    priority: 2,
    description: (data) => `T√°c ph·∫©m ${data?.message} ƒë√£ ƒë∆∞·ª£c n·ªïi b·∫≠t`
  },

  // B·∫¢O M·∫¨T
  'security_alert': {
    category: 'from_security',
    label: 'C·∫£nh b√°o b·∫£o m·∫≠t',
    icon: 'Shield',
    color: '#EF4444',
    priority: 6,
    description: (data) => data?.message || 'C√≥ ho·∫°t ƒë·ªông b·∫•t th∆∞·ªùng tr√™n t√†i kho·∫£n'
  },
  'login_new_device': {
    category: 'from_security',
    label: 'ƒêƒÉng nh·∫≠p thi·∫øt b·ªã m·ªõi',
    icon: 'Smartphone',
    color: '#F59E0B',
    priority: 5,
    description: (data) => `ƒêƒÉng nh·∫≠p t·ª´ thi·∫øt b·ªã m·ªõi: ${data?.message}`
  }
};
</file>

<file path="GiaoDienTong/MenuTren/NutCaNhan/ChucNang.ts">
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { LoggerService } from "@/app/ThuVien/LoggerService";

const logger = LoggerService.createScoped("xuLyDangXuat");

export const xuLyDangXuat = async () => {
  try {
    logger.info("üö™ B·∫Øt ƒë·∫ßu qu√° tr√¨nh ƒëƒÉng xu·∫•t...");

    // 1. X√ìA TH·ª¶ C√îNG TO√ÄN B·ªò LOCALSTORAGE
    if (typeof window !== "undefined") {
      // X√≥a c√°c key c·ªßa App
      localStorage.removeItem("USER_INFO");
      localStorage.removeItem("USER_ROLE");
      localStorage.removeItem("user_role");
      localStorage.removeItem("LA_ADMIN_CUNG");
      localStorage.removeItem("SAVED_EMAIL");

      // QUAN TR·ªåNG: X√≥a token c·ªßa Supabase (th∆∞·ªùng c√≥ d·∫°ng sb-xxxx-auth-token)
      Object.keys(localStorage).forEach((key) => {
        if (key.startsWith("sb-") || key.includes("supabase")) {
          localStorage.removeItem(key);
        }
      });

      // X√≥a sessionStorage
      sessionStorage.clear();
    }

    // 2. X√ìA COOKIE TH·ª¶ C√îNG (ƒê·ªÉ Middleware kh√¥ng b·∫Øt l·∫°i ƒë∆∞·ª£c)
    document.cookie.split(";").forEach((c) => {
      document.cookie = c
        .replace(/^ +/, "")
        .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
    });

    // 3. G·ªåI SUPABASE SIGN OUT (Cho ch·∫Øc ƒÉn ph√≠a server)
    try {
      await supabase.auth.signOut({ scope: "global" });
    } catch (err) {
      console.warn("Supabase signOut warning:", err);
    }

    logger.info("‚úÖ ƒê√£ d·ªçn d·∫πp s·∫°ch s·∫Ω session");

    // 4. FORCE REDIRECT V·ªÄ TRANG CH·ª¶ V·ªöI PARAM ƒê·∫∂C BI·ªÜT
    // Th√™m timestamp ƒë·ªÉ tr√¨nh duy·ªát kh√¥ng cache
    // Param ?logout=success b√°o hi·ªáu cho trang ch·ªß bi·∫øt "Tao v·ª´a logout ƒë·∫•y, ƒë·ª´ng c√≥ auto-login l·∫°i"
    window.location.href = `/?logout=success&t=${Date.now()}`;
  } catch (error) {
    logger.error("‚ùå L·ªói ƒëƒÉng xu·∫•t nghi√™m tr·ªçng", error);
    // Fallback cu·ªëi c√πng: Force reload trang g·ªëc
    window.location.href = `/?logout=force&t=${Date.now()}`;
  }
};
</file>

<file path="GiaoDienTong/MenuTren/NutCaNhan/GiaoDienChiTiet.tsx">
'use client';
import React from 'react';
import { User, LogOut, Mail, Hash, KeyRound, Smartphone } from 'lucide-react';
import { xuLyDangXuat } from './ChucNang';

interface Props {
    nguoiDung: any;
}

export default function GiaoDienChiTiet({ nguoiDung }: Props) {
    // Chu·∫©n h√≥a d·ªØ li·ªáu
    const hoTen = nguoiDung?.ho_ten || 'Kh√°ch v√£ng lai';
    const viTri = nguoiDung?.vi_tri || 'Ch∆∞a x√°c ƒë·ªãnh';
    const email = nguoiDung?.email || 'Ch∆∞a c·∫≠p nh·∫≠t';
    const role = nguoiDung?.role || 'khach';
    const avatar = nguoiDung?.avatar_url;
    const userId = nguoiDung?.id || 'N/A';

    return (
        <div className="max-w-md mx-auto w-full space-y-6 pt-4 pb-6">
            
            {/* 1. CARD AVATAR & INFO CH√çNH */}
            <div className="relative group">
                {/* Glow Effect */}
                <div className="absolute -inset-0.5 bg-gradient-to-br from-[#8B5E3C] to-[#C69C6D] rounded-2xl blur opacity-20 group-hover:opacity-40 transition duration-700"></div>
                
                <div className="relative bg-[#1a120f] border border-[#8B5E3C]/40 rounded-2xl p-6 flex flex-col items-center shadow-2xl overflow-hidden">
                    {/* Background Pattern */}
                    <div className="absolute inset-0 opacity-5 bg-[repeating-linear-gradient(45deg,transparent,transparent_5px,#C69C6D_5px,#C69C6D_6px)]"></div>
                    
                    {/* Avatar */}
                    <div className="w-28 h-28 md:w-32 md:h-32 rounded-full border-2 border-[#C69C6D] p-1 mb-4 relative z-10 shadow-[0_0_30px_rgba(198,156,109,0.2)] bg-[#110d0c]">
                        {avatar ? (
                            <img src={avatar} alt="Avt" className="w-full h-full rounded-full object-cover" />
                        ) : (
                            <div className="w-full h-full rounded-full bg-[#2a1e1b] flex items-center justify-center text-[#C69C6D]">
                                <User className="w-14 h-14" strokeWidth={1.5} />
                            </div>
                        )}
                        {/* Role Badge */}
                        <div className="absolute -bottom-2 -right-2 bg-[#C69C6D] text-[#1a120f] text-[10px] font-black px-2 py-1 rounded-md border border-[#1a120f] uppercase shadow-lg tracking-wider">
                            {role}
                        </div>
                    </div>

                    {/* Name & Title */}
                    <h3 className="text-xl md:text-2xl font-bold text-[#F5E6D3] uppercase tracking-wide relative z-10 text-center">{hoTen}</h3>
                    <p className="text-xs text-[#8B5E3C] font-bold uppercase tracking-[0.2em] mt-1 relative z-10 opacity-80">{viTri}</p>
                </div>
            </div>

            {/* 2. CARD CHI TI·∫æT */}
            <div className="space-y-3">
                <div className="bg-[#1a120f] border border-[#8B5E3C]/20 rounded-xl p-4 flex items-start gap-4 hover:border-[#C69C6D]/50 transition-colors">
                    <div className="p-2 bg-[#C69C6D]/10 rounded-full text-[#C69C6D] shrink-0 mt-1">
                        <Hash size={18} />
                    </div>
                    <div className="flex-1 min-w-0">
                        <p className="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">M√£ ƒê·ªãnh Danh (ID)</p>
                        <p className="text-sm text-gray-300 font-mono break-all leading-tight select-all">{userId}</p>
                    </div>
                </div>

                <div className="bg-[#1a120f] border border-[#8B5E3C]/20 rounded-xl p-4 flex items-start gap-4 hover:border-[#C69C6D]/50 transition-colors">
                    <div className="p-2 bg-[#C69C6D]/10 rounded-full text-[#C69C6D] shrink-0 mt-1">
                        <Mail size={18} />
                    </div>
                    <div className="flex-1 min-w-0">
                        <p className="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Email X√°c Th·ª±c</p>
                        <p className="text-sm text-gray-300 font-sans break-words leading-tight">{email}</p>
                    </div>
                </div>
            </div>

            {/* 3. QUICK ACTIONS GRID */}
            <div className="grid grid-cols-2 gap-3">
                <button className="flex flex-col items-center justify-center gap-2 bg-[#1a120f] border border-[#8B5E3C]/20 hover:bg-[#C69C6D]/10 hover:border-[#C69C6D] p-4 rounded-xl transition-all group">
                    <KeyRound size={20} className="text-[#8B5E3C] group-hover:text-[#C69C6D]"/>
                    <span className="text-[10px] uppercase font-bold text-gray-400 group-hover:text-[#F5E6D3]">ƒê·ªïi M·∫≠t Kh·∫©u</span>
                </button>
                <button className="flex flex-col items-center justify-center gap-2 bg-[#1a120f] border border-[#8B5E3C]/20 hover:bg-[#C69C6D]/10 hover:border-[#C69C6D] p-4 rounded-xl transition-all group">
                    <Smartphone size={20} className="text-[#8B5E3C] group-hover:text-[#C69C6D]"/>
                    <span className="text-[10px] uppercase font-bold text-gray-400 group-hover:text-[#F5E6D3]">Thi·∫øt B·ªã</span>
                </button>
            </div>

            {/* 4. LOGOUT BUTTON */}
            <button 
                onClick={xuLyDangXuat} 
                className="w-full flex items-center justify-center gap-2 text-red-400 hover:text-white text-sm font-bold uppercase tracking-[0.15em] px-6 py-4 border border-red-900/50 bg-red-950/20 hover:bg-red-600 rounded-xl transition-all shadow-lg active:scale-95 group mt-4"
            >
                <LogOut size={18} className="group-hover:-translate-x-1 transition-transform" />
                ƒêƒÉng Xu·∫•t H·ªá Th·ªëng
            </button>

            <div className="text-center">
                <p className="text-[9px] text-[#5D4037] font-mono">Phi√™n b·∫£n h·ªá th·ªëng: 2.5.0 (Beta)</p>
            </div>
        </div>
    );
}
</file>

<file path="GiaoDienTong/MenuTren/NutCaNhan/ModalProfile.tsx">
'use client';
import React, { useState, useEffect, ReactNode } from 'react';
import { 
  X, User, Package, Phone, Mail, MapPin, CreditCard, 
  ChevronRight, LogOut, ChevronLeft, Settings, Trophy,
  Globe, Moon, Sun, Palette, Check
} from 'lucide-react';
import { OrderService, Order } from '@/app/ThuVien/OrderService';
import { Z_INDEX } from '@/app/constants/zIndex';
import { LoggerService } from '@/app/ThuVien/LoggerService';
import { xuLyDangXuat } from './ChucNang';
import { useAppSettings, ThemeMode, LanguageCode } from '@/app/ThuVien/AppSettingsContext';

// Inline ConfirmDialog component
interface ConfirmDialogProps {
  isOpen: boolean;
  title: string;
  message: string;
  icon?: ReactNode;
  confirmText?: string;
  cancelText?: string;
  isDangerous?: boolean;
  isLoading?: boolean;
  onConfirm: () => void;
  onCancel: () => void;
}

function ConfirmDialog({
  isOpen,
  title,
  message,
  icon,
  confirmText = 'X√°c nh·∫≠n',
  cancelText = 'H·ªßy',
  isDangerous = false,
  isLoading = false,
  onConfirm,
  onCancel
}: ConfirmDialogProps) {
  if (!isOpen) return null;
  
  return (
    <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm">
      <div className="bg-[#1a1a1a] border border-white/10 rounded-xl p-6 max-w-sm w-full mx-4 shadow-2xl">
        <div className="flex items-center gap-3 mb-4">
          {icon && <div>{icon}</div>}
          <h3 className="text-lg font-semibold text-white">{title}</h3>
        </div>
        <p className="text-white/70 mb-6">{message}</p>
        <div className="flex gap-3 justify-end">
          <button
            onClick={onCancel}
            disabled={isLoading}
            className="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 disabled:opacity-50"
          >
            {cancelText}
          </button>
          <button
            onClick={onConfirm}
            disabled={isLoading}
            className={`px-4 py-2 rounded-lg text-white ${
              isDangerous ? 'bg-red-600 hover:bg-red-700' : 'bg-[#C69C6D] hover:bg-[#C69C6D]/80'
            } disabled:opacity-50`}
          >
            {isLoading ? 'ƒêang x·ª≠ l√Ω...' : confirmText}
          </button>
        </div>
      </div>
    </div>
  );
}

interface ModalProfileProps {
  isOpen: boolean;
  onClose: () => void;
  nguoiDung: any;
}

// C√°c m√†n h√¨nh
type ScreenType = 
  | 'main'           // M√†n ch√≠nh: C√†i ƒê·∫∑t, H·ªì S∆° C·ªßa T√¥i
  | 'caidat'         // C√†i ƒê·∫∑t: Ng√¥n Ng·ªØ, Giao Di·ªán
  | 'hosocuatoi'     // H·ªì S∆°: Th√¥ng Tin, Th√†nh T√≠ch/ƒê∆°n H√†ng
  | 'thongtincanhan' // Chi ti·∫øt th√¥ng tin c√° nh√¢n
  | 'thanhtich'      // Th√†nh t√≠ch (nhan_su)
  | 'donhang'        // ƒê∆°n h√†ng (khach_hang)
  | 'ngonngu'        // Ch·ªçn ng√¥n ng·ªØ
  | 'giaodien';      // Ch·ªçn giao di·ªán

export default function ModalProfile({ isOpen, onClose, nguoiDung }: ModalProfileProps) {
  const [currentScreen, setCurrentScreen] = useState<ScreenType>('main');
  const [orders, setOrders] = useState<Order[]>([]);
  const [isLoadingOrders, setIsLoadingOrders] = useState(false);
  const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);
  const [isLoggingOut, setIsLoggingOut] = useState(false);
  
  // üåê Hook settings cho theme + language
  const { t, language } = useAppSettings();
  
  // X√°c ƒë·ªãnh lo·∫°i user
  const isNhanSu = nguoiDung?.userType === 'nhan_su' || nguoiDung?.vi_tri;
  const isKhachHang = nguoiDung?.userType === 'khach_hang' || nguoiDung?.phan_loai;

  // Reset v·ªÅ m√†n ch√≠nh khi m·ªü l·∫°i
  useEffect(() => {
    if (isOpen) {
      setCurrentScreen('main');
    }
  }, [isOpen]);

  // Load orders khi v√†o m√†n ƒë∆°n h√†ng
  useEffect(() => {
    if (isOpen && currentScreen === 'donhang') {
      loadOrders();
    }
  }, [isOpen, currentScreen]);

  // ‚úÖ ESC KEY HANDLING - Close modal on ESC press
  useEffect(() => {
    if (!isOpen) return;

    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        e.preventDefault();
        onClose();
      }
    };

    window.addEventListener('keydown', handleEscape);
    return () => window.removeEventListener('keydown', handleEscape);
  }, [isOpen, onClose]);

  const loadOrders = async () => {
    setIsLoadingOrders(true);
    try {
      const { orders: data } = await OrderService.getMyOrders(20);
      setOrders(data);
    } catch (error) {
      LoggerService.error('ModalProfile', 'Error loading orders', error);
    } finally {
      setIsLoadingOrders(false);
    }
  };

  const handleLogoutConfirm = async () => {
    setIsLoggingOut(true);
    try {
      await xuLyDangXuat();
    } catch (error) {
      LoggerService.error('ModalProfile', 'Logout error', error);
      setIsLoggingOut(false);
      setShowLogoutConfirm(false);
    }
  };

  // X·ª≠ l√Ω n√∫t back - quay v·ªÅ m√†n cha
  const handleBack = () => {
    switch (currentScreen) {
      case 'ngonngu':
      case 'giaodien':
        setCurrentScreen('caidat');
        break;
      case 'thongtincanhan':
      case 'thanhtich':
      case 'donhang':
        setCurrentScreen('hosocuatoi');
        break;
      default:
        setCurrentScreen('main');
    }
  };

  // L·∫•y ti√™u ƒë·ªÅ m√†n h√¨nh
  const getScreenTitle = () => {
    switch (currentScreen) {
      case 'caidat': return t('profile.settings');
      case 'hosocuatoi': return t('profile.myProfile');
      case 'thongtincanhan': return t('profile.personalInfo');
      case 'thanhtich': return t('profile.achievements');
      case 'donhang': return t('profile.orders');
      case 'ngonngu': return t('settings.language');
      case 'giaodien': return t('settings.theme');
      default: return t('profile.title');
    }
  };

  if (!isOpen) return null;

  // =====================================================
  // M√ÄN H√åNH CON (kh√¥ng ph·∫£i main)
  // =====================================================
  if (currentScreen !== 'main') {
    return (
      <div className="fixed inset-0 flex items-center justify-center sm:items-start sm:justify-end" style={{ zIndex: Z_INDEX.modal }}>
        <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose} />
        <div className="relative w-full h-full sm:h-screen sm:max-w-md bg-gradient-to-br from-[#0A0A0A] to-[#1A1A1A] border-l border-white/20 shadow-2xl flex flex-col overflow-hidden">
          
          {/* Header m√†n con */}
          <div className="flex-shrink-0 px-4 py-4 border-b border-white/10 bg-black/40 backdrop-blur-md">
            <div className="flex items-center gap-3">
              <button onClick={handleBack} className="p-2 hover:bg-white/10 rounded-lg transition-colors">
                <ChevronLeft size={24} className="text-white" />
              </button>
              <h2 className="text-lg font-bold text-white">{getScreenTitle()}</h2>
            </div>
          </div>

          {/* Content m√†n con */}
          <div className="flex-1 overflow-y-auto p-4">
            {currentScreen === 'caidat' && (
              <ScreenCaiDat 
                onGoToNgonNgu={() => setCurrentScreen('ngonngu')}
                onGoToGiaoDien={() => setCurrentScreen('giaodien')}
              />
            )}
            {currentScreen === 'hosocuatoi' && (
              <ScreenHoSoCuaToi 
                isNhanSu={isNhanSu}
                isKhachHang={isKhachHang}
                onGoToThongTin={() => setCurrentScreen('thongtincanhan')}
                onGoToThanhTich={() => setCurrentScreen('thanhtich')}
                onGoToDonHang={() => setCurrentScreen('donhang')}
              />
            )}
            {currentScreen === 'thongtincanhan' && <ScreenThongTinCaNhan nguoiDung={nguoiDung} />}
            {currentScreen === 'thanhtich' && <ScreenThanhTich nguoiDung={nguoiDung} />}
            {currentScreen === 'donhang' && <ScreenDonHang orders={orders} isLoading={isLoadingOrders} onReload={loadOrders} />}
            {currentScreen === 'ngonngu' && <ScreenNgonNgu />}
            {currentScreen === 'giaodien' && <ScreenGiaoDien />}
          </div>
        </div>
      </div>
    );
  }

  // =====================================================
  // M√ÄN H√åNH CH√çNH
  // =====================================================
  return (
    <div className="fixed inset-0 flex items-center justify-center sm:items-start sm:justify-end" style={{ zIndex: Z_INDEX.modal }}>
      <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose} />

      <div className="relative w-full h-full sm:h-screen sm:max-w-md bg-gradient-to-br from-[#0A0A0A] to-[#1A1A1A] border-l border-white/20 shadow-2xl flex flex-col overflow-hidden">
        
        {/* Header - Avatar & T√™n */}
        <div className="flex-shrink-0 px-6 py-6 border-b border-white/10 bg-black/40 backdrop-blur-md">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-4">
              <div className="w-14 h-14 rounded-full bg-gradient-to-br from-[#C69C6D] to-[#F2D3A0] flex items-center justify-center text-black font-bold text-xl">
                {nguoiDung?.ho_ten?.[0]?.toUpperCase() || nguoiDung?.email?.[0]?.toUpperCase() || 'U'}
              </div>
              <div>
                <h2 className="text-lg font-bold text-white">
                  {nguoiDung?.ho_ten || (language === 'vi' ? 'Ng∆∞·ªùi d√πng' : 'User')}
                </h2>
                <p className="text-white/60 text-sm">{nguoiDung?.email}</p>
              </div>
            </div>
            <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-lg transition-colors text-white/60 hover:text-white">
              <X size={24} />
            </button>
          </div>

          {/* N√∫t ƒêƒÉng xu·∫•t */}
          <button
            onClick={() => setShowLogoutConfirm(true)}
            disabled={isLoggingOut}
            className="flex items-center gap-2 px-4 py-2.5 bg-white/5 border border-white/10 text-white rounded-lg font-medium text-sm transition-all hover:bg-white/10"
          >
            <LogOut size={18} />
            <span>{isLoggingOut ? t('auth.loggingOut') : t('auth.logout')}</span>
          </button>
        </div>

        {/* Content - 2 m·ª•c ch√≠nh */}
        <div className="flex-1 overflow-y-auto p-4 space-y-4">
          
          {/* KH·ªêI MENU CH√çNH */}
          <div className="bg-white/5 border border-white/10 rounded-2xl overflow-hidden">
            <KhoiMenuChon 
              icon={<Settings size={20} className="text-[#C69C6D]" />}
              label={t('profile.settings')}
              subtitle={t('profile.settingsDesc')}
              onClick={() => setCurrentScreen('caidat')}
            />
            <KhoiMenuChon 
              icon={<User size={20} className="text-[#C69C6D]" />}
              label={t('profile.myProfile')}
              subtitle={isNhanSu ? t('profile.myProfileDescStaff') : t('profile.myProfileDescCustomer')}
              onClick={() => setCurrentScreen('hosocuatoi')}
              isLast
            />
          </div>

        </div>
      </div>

      {/* Logout Confirmation Dialog */}
      <ConfirmDialog
        isOpen={showLogoutConfirm}
        title={t('auth.logout')}
        message={t('auth.logoutConfirm')}
        icon={<LogOut className="text-[#C69C6D]" size={24} />}
        confirmText={t('auth.logout')}
        cancelText={t('app.cancel')}
        isDangerous={false}
        isLoading={isLoggingOut}
        onConfirm={handleLogoutConfirm}
        onCancel={() => !isLoggingOut && setShowLogoutConfirm(false)}
      />
    </div>
  );
}

// =====================================================
// COMPONENT: KH·ªêI MENU CH·ªåN
// =====================================================
function KhoiMenuChon({ 
  icon, 
  label, 
  subtitle,
  onClick, 
  isLast = false 
}: { 
  icon: ReactNode; 
  label: string; 
  subtitle?: string;
  onClick?: () => void; 
  isLast?: boolean;
}) {
  return (
    <button 
      onClick={onClick}
      className={`w-full px-4 py-4 flex items-center gap-3 hover:bg-white/5 transition-colors ${!isLast ? 'border-b border-white/5' : ''}`}
    >
      <div className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center">
        {icon}
      </div>
      <div className="flex-1 text-left">
        <p className="text-white font-medium">{label}</p>
        {subtitle && <p className="text-white/50 text-sm">{subtitle}</p>}
      </div>
      {onClick && <ChevronRight size={20} className="text-white/30" />}
    </button>
  );
}

// =====================================================
// M√ÄN H√åNH: C√ÄI ƒê·∫∂T
// =====================================================
function ScreenCaiDat({ 
  onGoToNgonNgu, 
  onGoToGiaoDien 
}: { 
  onGoToNgonNgu: () => void;
  onGoToGiaoDien: () => void;
}) {
  const { language, theme, t } = useAppSettings();
  
  const languageDisplay = language === 'vi' ? 'Ti·∫øng Vi·ªát' : 'English';
  const themeDisplay = theme === 'dark' 
    ? (language === 'vi' ? 'T·ªëi' : 'Dark')
    : (language === 'vi' ? 'S√°ng' : 'Light');

  return (
    <div className="space-y-4">
      <div className="bg-[var(--bg-card)] border border-[var(--border-color)] rounded-2xl overflow-hidden">
        <KhoiMenuChon 
          icon={<Globe size={20} className="text-blue-400" />}
          label={t('settings.language')}
          subtitle={languageDisplay}
          onClick={onGoToNgonNgu}
        />
        <KhoiMenuChon 
          icon={<Palette size={20} className="text-purple-400" />}
          label={t('settings.theme')}
          subtitle={themeDisplay}
          onClick={onGoToGiaoDien}
          isLast
        />
      </div>
    </div>
  );
}

// =====================================================
// M√ÄN H√åNH: H·ªí S∆† C·ª¶A T√îI
// =====================================================
function ScreenHoSoCuaToi({ 
  isNhanSu,
  isKhachHang,
  onGoToThongTin, 
  onGoToThanhTich,
  onGoToDonHang
}: { 
  isNhanSu: boolean;
  isKhachHang: boolean;
  onGoToThongTin: () => void;
  onGoToThanhTich: () => void;
  onGoToDonHang: () => void;
}) {
  const { t } = useAppSettings();
  
  return (
    <div className="space-y-4">
      <div className="bg-white/5 border border-white/10 rounded-2xl overflow-hidden">
        <KhoiMenuChon 
          icon={<User size={20} className="text-[#C69C6D]" />}
          label={t('profile.personalInfo')}
          subtitle={t('profile.personalInfoDesc')}
          onClick={onGoToThongTin}
        />
        
        {/* Th√†nh T√≠ch - ch·ªâ hi·ªán cho nh√¢n s·ª± */}
        {isNhanSu && (
          <KhoiMenuChon 
            icon={<Trophy size={20} className="text-yellow-400" />}
            label={t('profile.achievements')}
            subtitle={t('profile.achievementsDesc')}
            onClick={onGoToThanhTich}
          />
        )}
        
        {/* ƒê∆°n H√†ng - ch·ªâ hi·ªán cho kh√°ch h√†ng */}
        {isKhachHang && (
          <KhoiMenuChon 
            icon={<Package size={20} className="text-green-400" />}
            label={t('profile.orders')}
            subtitle={t('profile.ordersDesc')}
            onClick={onGoToDonHang}
            isLast
          />
        )}
        
        {/* N·∫øu l√† nh√¢n s·ª± th√¨ Th√†nh T√≠ch l√† last */}
        {isNhanSu && !isKhachHang && (
          <div className="hidden" /> // Placeholder ƒë·ªÉ isLast ho·∫°t ƒë·ªông ƒë√∫ng
        )}
      </div>
    </div>
  );
}

// =====================================================
// M√ÄN H√åNH: TH√îNG TIN C√Å NH√ÇN
// =====================================================
function ScreenThongTinCaNhan({ nguoiDung }: { nguoiDung: any }) {
  const { t } = useAppSettings();
  
  const fields = [
    { icon: User, label: t('field.fullName'), value: nguoiDung?.ho_ten },
    { icon: Mail, label: t('field.email'), value: nguoiDung?.email },
    { icon: Phone, label: t('field.phone'), value: nguoiDung?.so_dien_thoai },
    { icon: MapPin, label: t('field.address'), value: nguoiDung?.dia_chi },
    { icon: CreditCard, label: t('field.idCard'), value: nguoiDung?.cccd },
  ];

  return (
    <div className="space-y-4">
      <div className="bg-white/5 border border-white/10 rounded-2xl overflow-hidden">
        {fields.map((field, idx) => {
          const Icon = field.icon;
          const isLast = idx === fields.length - 1;
          return (
            <div key={idx} className={`px-4 py-4 ${!isLast ? 'border-b border-white/5' : ''}`}>
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center">
                  <Icon size={20} className="text-[#C69C6D]" />
                </div>
                <div className="flex-1 min-w-0">
                  <p className="text-white/50 text-xs">{field.label}</p>
                  <p className="text-white font-medium truncate">
                    {field.value || <span className="text-white/30 italic">{t('field.notUpdated')}</span>}
                  </p>
                </div>
              </div>
            </div>
          );
        })}
      </div>

      <button className="w-full py-4 bg-gradient-to-r from-[#C69C6D] to-[#F2D3A0] text-black rounded-2xl font-bold">
        {t('profile.editInfo')}
      </button>
    </div>
  );
}

// =====================================================
// M√ÄN H√åNH: TH√ÄNH T√çCH (nhan_su)
// =====================================================
function ScreenThanhTich({ nguoiDung }: { nguoiDung: any }) {
  const { t } = useAppSettings();
  
  return (
    <div className="space-y-4">
      <div className="bg-white/5 border border-white/10 rounded-2xl p-6 text-center">
        <Trophy size={48} className="text-yellow-400 mx-auto mb-4" />
        <h3 className="text-lg font-bold text-white mb-2">{t('achievements.title')}</h3>
        <p className="text-white/60 text-sm">{t('achievements.developing')}</p>
      </div>
      
      {/* Placeholder cho c√°c th√†nh t√≠ch */}
      <div className="bg-white/5 border border-white/10 rounded-2xl overflow-hidden">
        <div className="px-4 py-4 border-b border-white/5">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-yellow-500/20 flex items-center justify-center">
              <Trophy size={20} className="text-yellow-400" />
            </div>
            <div className="flex-1">
              <p className="text-white font-medium">{t('achievements.points')}</p>
              <p className="text-white/50 text-sm">0</p>
            </div>
          </div>
        </div>
        <div className="px-4 py-4">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center">
              <Trophy size={20} className="text-purple-400" />
            </div>
            <div className="flex-1">
              <p className="text-white font-medium">{t('achievements.badges')}</p>
              <p className="text-white/50 text-sm">{t('achievements.noBadges')}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// =====================================================
// M√ÄN H√åNH: ƒê∆†N H√ÄNG (khach_hang)
// =====================================================
function ScreenDonHang({ orders, isLoading, onReload }: { orders: Order[]; isLoading: boolean; onReload: () => void }) {
  const { t, language } = useAppSettings();
  
  if (isLoading) {
    return (
      <div className="flex items-center justify-center py-20">
        <div className="w-12 h-12 border-4 border-[#C69C6D]/30 border-t-[#C69C6D] rounded-full animate-spin"></div>
      </div>
    );
  }

  if (orders.length === 0) {
    return (
      <div className="text-center py-20">
        <Package size={48} className="text-white/20 mx-auto mb-4" />
        <h3 className="text-lg font-bold text-white mb-2">{t('orders.empty')}</h3>
        <p className="text-white/60 text-sm mb-4">{t('orders.emptyDesc')}</p>
        <button onClick={onReload} className="px-4 py-2 bg-[#C69C6D] text-black rounded-lg font-medium">
          {t('app.refresh')}
        </button>
      </div>
    );
  }

  return (
    <div className="space-y-3">
      {orders.map((order) => (
        <div key={order.id} className="bg-white/5 border border-white/10 rounded-xl p-4">
          <div className="flex items-center justify-between mb-2">
            <span className="text-[#C69C6D] font-bold">{order.ma_don}</span>
            <span className="text-xs px-2 py-1 bg-white/10 rounded-full text-white/80">
              {OrderService.formatStatus(order.trang_thai)}
            </span>
          </div>
          <p className="text-white/60 text-sm">{new Date(order.tao_luc).toLocaleDateString(language === 'vi' ? 'vi-VN' : 'en-US')}</p>
          <p className="text-white font-bold mt-2">{OrderService.formatMoney(order.tong_tien)}</p>
        </div>
      ))}
    </div>
  );
}

// =====================================================
// M√ÄN H√åNH: NG√îN NG·ªÆ
// =====================================================
function ScreenNgonNgu() {
  const { language, setLanguage, t } = useAppSettings();
  
  const languages: { code: LanguageCode; name: string; flag: string }[] = [
    { code: 'vi', name: 'Ti·∫øng Vi·ªát', flag: 'üáªüá≥' },
    { code: 'en', name: 'English', flag: 'üá∫üá∏' },
  ];

  const handleSelect = (code: LanguageCode) => {
    setLanguage(code);
  };

  return (
    <div className="space-y-4">
      <div className="bg-[var(--bg-card)] border border-[var(--border-color)] rounded-2xl overflow-hidden">
        {languages.map((lang, idx) => (
          <button
            key={lang.code}
            onClick={() => handleSelect(lang.code)}
            className={`w-full px-4 py-4 flex items-center gap-3 hover:bg-[var(--hover-bg)] transition-colors ${idx < languages.length - 1 ? 'border-b border-[var(--border-light)]' : ''}`}
          >
            <span className="text-2xl">{lang.flag}</span>
            <span className="flex-1 text-left text-[var(--text-primary)] font-medium">{lang.name}</span>
            {language === lang.code && (
              <div className="w-6 h-6 rounded-full bg-[var(--accent)] flex items-center justify-center">
                <Check size={14} className="text-black" />
              </div>
            )}
          </button>
        ))}
      </div>
      
      <p className="text-[var(--text-muted)] text-xs text-center">
        {language === 'vi' ? 'Thay ƒë·ªïi ng√¥n ng·ªØ s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng ngay l·∫≠p t·ª©c' : 'Language change will be applied immediately'}
      </p>
    </div>
  );
}

// =====================================================
// M√ÄN H√åNH: GIAO DI·ªÜN
// =====================================================
function ScreenGiaoDien() {
  const { theme, setTheme, t } = useAppSettings();
  
  const themes: { code: ThemeMode; name: string; icon: typeof Moon; desc: string }[] = [
    { code: 'dark', name: t('settings.themeDark'), icon: Moon, desc: t('settings.themeDarkDesc') },
    { code: 'light', name: t('settings.themeLight'), icon: Sun, desc: t('settings.themeLightDesc') },
  ];

  const handleSelect = (code: ThemeMode) => {
    setTheme(code);
  };

  return (
    <div className="space-y-4">
      <div className="bg-[var(--bg-card)] border border-[var(--border-color)] rounded-2xl overflow-hidden">
        {themes.map((themeOption, idx) => {
          const Icon = themeOption.icon;
          return (
            <button
              key={themeOption.code}
              onClick={() => handleSelect(themeOption.code)}
              className={`w-full px-4 py-4 flex items-center gap-3 hover:bg-[var(--hover-bg)] transition-colors ${idx < themes.length - 1 ? 'border-b border-[var(--border-light)]' : ''}`}
            >
              <div className="w-10 h-10 rounded-xl bg-[var(--bg-card)] flex items-center justify-center">
                <Icon size={20} className={themeOption.code === 'dark' ? 'text-purple-400' : 'text-yellow-400'} />
              </div>
              <div className="flex-1 text-left">
                <p className="text-[var(--text-primary)] font-medium">{themeOption.name}</p>
                <p className="text-[var(--text-secondary)] text-sm">{themeOption.desc}</p>
              </div>
              {theme === themeOption.code && (
                <div className="w-6 h-6 rounded-full bg-[var(--accent)] flex items-center justify-center">
                  <Check size={14} className="text-black" />
                </div>
              )}
            </button>
          );
        })}
      </div>
      
      <p className="text-[var(--text-muted)] text-xs text-center">
        {t('settings.language') === 'Ng√¥n Ng·ªØ' ? 'Thay ƒë·ªïi giao di·ªán s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng ngay l·∫≠p t·ª©c' : 'Theme change will be applied immediately'}
      </p>
    </div>
  );
}
</file>

<file path="GiaoDienTong/MenuTren/NutCaNhan/NutCaNhan.tsx">
'use client';
import React, { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { UserCircle } from 'lucide-react';

 
import ModalProfile from '@/app/GiaoDienTong/MenuTren/NutCaNhan/ModalProfile';
import { useAppSettings } from '@/app/ThuVien/AppSettingsContext';

interface Props {
    nguoiDung: any; 
    isOpen: boolean;       
    onToggle: () => void;  
    onClose: () => void;
}

export default function NutCaNhan({ nguoiDung, isOpen, onToggle, onClose }: Props) {
    const [mounted, setMounted] = useState(false);
    const { t } = useAppSettings();

    useEffect(() => {
        setMounted(true);
    }, []);

    // Modal n·ªôi dung Profile m·ªõi
    const modalContent = isOpen && nguoiDung ? (
        <ModalProfile
            isOpen={true}
            onClose={onClose}
            nguoiDung={nguoiDung}
        />
    ) : null;

    return (
        <>
          

            {mounted && modalContent && createPortal(modalContent, document.body)}
        </>
    );
}
</file>

<file path="globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  /* M√ÄU S·∫ÆC CH·ª¶ ƒê·∫†O - DAY MODE */
  --gold-artisan: #c69c6d;
  --gold-hover: #b58b5d;
  --black-matte: #1a120f;
  --void-black: #050505;
  --paper-rice: #f5e6d3;
  --red-seal: #8b0000;

  /* C·∫•u h√¨nh giao di·ªán Light */
  --bg-primary: #f5f5f5;
  --bg-secondary: #ebebeb;
  --bg-card: #ffffff;
  --text-primary: #1a120f;
  --text-secondary: rgba(26, 18, 15, 0.6);
  --border-color: rgba(198, 156, 109, 0.3);

  /* Bi·∫øn chi·ªÅu cao dynamic cho Mobile - M·∫∑c ƒë·ªãnh 100vh */
  --app-height: 100vh;
}

.dark-theme {
  /* C·∫•u h√¨nh giao di·ªán Dark */
  --bg-primary: #050505;
  --bg-secondary: #0a0a0a;
  --bg-card: #1a120f;
  --text-primary: #f5e6d3;
  --text-secondary: rgba(245, 230, 211, 0.5);
  --border-color: rgba(198, 156, 109, 0.2);
}

/* üü¢ C·∫§U H√åNH QUAN TR·ªåNG: FIX L·ªñI SCROLL TR√äN MOBILE */
html,
body {
  background-color: var(--bg-primary);
  color: var(--text-primary);
  font-family: "Inter", sans-serif;
  transition: background-color 0.3s ease, color 0.3s ease;

  /* Kh√≥a viewport: NgƒÉn k√©o d√£n (Rubber-banding) tr√™n iOS */
  height: 100%;
  width: 100%;
  overflow: hidden; /* Ch·∫∑n scroll ·ªü body, b·∫Øt bu·ªôc scroll ·ªü th·∫ª con (div) */
  position: fixed; /* Kh√≥a c·ª©ng body */
  overscroll-behavior: none;
  -webkit-overflow-scrolling: touch;
}

/* Class thay th·∫ø h-screen ƒë·ªÉ t∆∞∆°ng th√≠ch bi·∫øn dynamic */
.h-app {
  height: 100vh; /* Fallback */
  height: var(--app-height);
}

/* üü¢ ARTISAN UTILITIES */
@layer components {
  .btn-artisan {
    @apply px-6 py-3 rounded-xl font-bold uppercase tracking-widest transition-all duration-300;
    background-color: var(--gold-artisan);
    color: #000;
    box-shadow: 0 4px 15px rgba(198, 156, 109, 0.3);
  }
  .btn-artisan:hover {
    background-color: var(--gold-hover);
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(198, 156, 109, 0.4);
  }
  .btn-artisan:active {
    transform: scale(0.98);
  }

  .artisan-card {
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    backdrop-filter: blur(12px);
  }
}

@layer utilities {
  .text-gold {
    color: var(--gold-artisan);
  }
  .bg-gold {
    background-color: var(--gold-artisan);
  }
  .border-gold {
    border-color: var(--gold-artisan);
  }
  .glow-text {
    text-shadow: 0 0 10px rgba(198, 156, 109, 0.5);
  }

  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
}

*::-webkit-scrollbar {
  display: none;
}
* {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

@keyframes hologram {
  0% {
    opacity: 0;
    transform: scale(0.95) translateY(10px);
    filter: blur(5px);
  }
  100% {
    opacity: 1;
    transform: scale(1) translateY(0);
    filter: blur(0);
  }
}
.animate-hologram {
  animation: hologram 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}
</file>

<file path="layout.tsx">
import type { Metadata, Viewport } from "next";
import { Inter, Playfair_Display } from "next/font/google";
import "./globals.css";

// Components
import NutHoTro from "@/app/components/NutHoTro";
import TuVanKhachHang from "@/app/components/TuVanKhachHang";
import ForceFullScreen from "@/app/components/ForceFullScreen";
import PushManager from "@/app/components/PushManager";
import ErrorBoundary from "@/app/components/ErrorBoundary";

// Providers
import QueryProvider from "@/app/QueryProvider";
import { UserProvider } from "@/app/ThuVien/UserContext";
import { AppSettingsProvider } from "@/app/ThuVien/AppSettingsContext";

const inter = Inter({
  subsets: ["latin", "vietnamese"],
  display: "swap",
  variable: "--font-inter",
});

const playfair = Playfair_Display({
  subsets: ["latin", "vietnamese"],
  display: "swap",
  variable: "--font-playfair",
  weight: ["400", "500", "600", "700", "800", "900"],
});

export const metadata: Metadata = {
  title: "H·ªá Th·ªëng Qu·∫£n L√Ω ERP",
  description: "Generated by Tommy Nghiem",
  manifest: "/manifest.json",
  icons: {
    icon: "/icon-192.png",
    shortcut: "/icon-192.png",
    apple: "/icon-192.png",
    other: {
      rel: "apple-touch-icon-precomposed",
      url: "/icon-192.png",
    },
  },
  appleWebApp: {
    capable: true,
    statusBarStyle: "black-translucent",
    title: "NghiemArt ERP",
  },
};

export const viewport: Viewport = {
  width: "device-width",
  initialScale: 1,
  minimumScale: 1,
  maximumScale: 1,
  userScalable: false,
  viewportFit: "cover",
  themeColor: "#000000",
  interactiveWidget: "resizes-visual", // Gi√∫p b√†n ph√≠m ·∫£o kh√¥ng che input
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="vi">
      <body
        className={`${inter.variable} ${playfair.variable} bg-black h-app w-full overflow-hidden font-sans`}
      >
        <UserProvider>
          <AppSettingsProvider>
            <QueryProvider>
              <ErrorBoundary>
                {/* 1. X·ª≠ l√Ω chi·ªÅu cao & Fullscreen cho Mobile PWA */}
                <ForceFullScreen />

                {/* 2. N·ªôi dung ch√≠nh c·ªßa trang (Page) */}
                {children}

                {/* 3. C√°c th√†nh ph·∫ßn Fixed (N·ªïi tr√™n c√πng) */}
                {/* NutHoTro: G√≥c Ph·∫£i (Kh√°ch h√†ng) */}
                <NutHoTro />

                {/* TuVanKhachHang: G√≥c Tr√°i (Nh√¢n vi√™n) */}
                <TuVanKhachHang />

                {/* PushManager: X·ª≠ l√Ω ƒëƒÉng k√Ω nh·∫≠n th√¥ng b√°o ng·∫ßm */}
                <PushManager />
              </ErrorBoundary>
            </QueryProvider>
          </AppSettingsProvider>
        </UserProvider>
      </body>
    </html>
  );
}
</file>

<file path="Music/NhacNen.tsx">
'use client';

import React, { useState, useRef, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { 
    Music, Play, Pause, Volume2, VolumeX, Upload, Loader2, X, 
    SkipForward, Trash2, Repeat1, Shuffle, AlertCircle, Volume1, ChevronUp, ChevronDown, Square
} from 'lucide-react';
import { supabase } from '@/app/ThuVien/ketNoiSupabase'; 

interface BaiHat {
    id: string;
    name: string;
    url: string;
}

export default function NhacNen() {
    const [danhSachNhac, setDanhSachNhac] = useState<BaiHat[]>([]);
    const [isPlaying, setIsPlaying] = useState(false);
    const [volume, setVolume] = useState(0.5);
    const [isMuted, setIsMuted] = useState(false);
    const [isOpen, setIsOpen] = useState(false);
    const [currentSongIndex, setCurrentSongIndex] = useState(0);
    const [mounted, setMounted] = useState(false);
    const [showQuickControls, setShowQuickControls] = useState(false);
    
    // State logic (Gi·ªØ nguy√™n ph·∫ßn n√¢ng c·∫•p logic)
    const [isLooping, setIsLooping] = useState(false);   
    const [isShuffling, setIsShuffling] = useState(false); 

    const [isAdmin, setIsAdmin] = useState(false);
    const [isUploading, setIsUploading] = useState(false);
    const [isDeleting, setIsDeleting] = useState<string | null>(null);
    const [errorMsg, setErrorMsg] = useState<string | null>(null);
    const [isUserAuthenticated, setIsUserAuthenticated] = useState(false);
    const [playlistLoaded, setPlaylistLoaded] = useState(false);
    const [hasAutoPlayed, setHasAutoPlayed] = useState(false); // Flag ƒë·ªÉ ch·ªâ auto-play 1 l·∫ßn
    
    const uploadInputRef = useRef<HTMLInputElement>(null);
    const audioRef = useRef<HTMLAudioElement>(null);
    const controlsRef = useRef<HTMLDivElement>(null);

    // üéµ AUTO-PLAY: Ph√°t nh·∫°c khi user login th√†nh c√¥ng - CH·ªà 1 L·∫¶N
    useEffect(() => {
        console.log('üéµ Auto-play check:', { isUserAuthenticated, playlistLoaded, songsCount: danhSachNhac.length, hasAutoPlayed });
        if (isUserAuthenticated && playlistLoaded && danhSachNhac.length > 0 && !hasAutoPlayed && audioRef.current) {
            // Delay m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o audio element s·∫µn s√†ng
            const timer = setTimeout(() => {
                setHasAutoPlayed(true); // ƒê√°nh d·∫•u TR∆Ø·ªöC khi play ƒë·ªÉ tr√°nh race condition
                audioRef.current?.play().then(() => {
                    setIsPlaying(true);
                    console.log('üéµ Auto-play nh·∫°c th√†nh c√¥ng');
                }).catch(err => {
                    console.warn('Auto-play failed (c√≥ th·ªÉ do browser policy):', err);
                    // Kh√¥ng set isPlaying = true n·∫øu play th·∫•t b·∫°i
                });
            }, 500);
            return () => clearTimeout(timer);
        }
    }, [isUserAuthenticated, playlistLoaded, danhSachNhac.length, hasAutoPlayed]);

    useEffect(() => {
        setMounted(true);
        if (typeof window !== 'undefined') {
            const storedUser = localStorage.getItem('USER_INFO');
            const storedRole = localStorage.getItem('USER_ROLE');
            let role = storedRole || '';
            let isAuthenticated = false;
            
            if (storedUser) {
                try {
                    const parsed = JSON.parse(storedUser);
                    role = parsed.role || parsed.vi_tri || parsed.chuc_vu || role;
                    isAuthenticated = true; // User ƒë√£ ƒëƒÉng nh·∫≠p
                } catch (e) { console.error(e); }
            }
            
            setIsUserAuthenticated(isAuthenticated);
            if (['admin', 'quanly', 'boss'].includes(role.toLowerCase().trim())) {
                setIsAdmin(true);
            }
        }
        fetchDanhSachNhac();
    }, []);

    const fetchDanhSachNhac = async () => {
        try {
            // 'tao_luc' kh√¥ng ph·∫£i column chu·∫©n c·ªßa Storage -> g√¢y 400. D√πng created_at lu√¥n.
            const { data, error } = await supabase.storage
                .from('nhac-nen')
                .list('', { sortBy: { column: 'created_at', order: 'asc' } });

            if (error) {
                console.warn("Kh√¥ng th·ªÉ load playlist nh·∫°c:", error);
                setPlaylistLoaded(true);
                return; // Return early instead of throwing
            }

            if (data) {
                const songs: BaiHat[] = data
                    .filter(file => file.name !== '.emptyFolderPlaceholder')
                    .map((file, index) => {
                        const { data: urlData } = supabase.storage
                            .from('nhac-nen')
                            .getPublicUrl(file.name);
                        return {
                            id: file.name,
                            name: `Giai ƒëi·ªáu ${index + 1}: ${file.name.replace(/\.[^/.]+$/, "")}`,
                            url: urlData.publicUrl
                        };
                    });
                setDanhSachNhac(songs);
                setPlaylistLoaded(true); // üéµ ƒê√°nh d·∫•u playlist ƒë√£ load xong
                setErrorMsg(null);
            }
        } catch (err: any) {
            console.error("L·ªói t·∫£i playlist:", err);
            setErrorMsg("Kh√¥ng th·ªÉ t·∫£i danh s√°ch nh·∫°c.");
            setPlaylistLoaded(true); // C≈©ng ƒë√°nh d·∫•u l√† ƒë√£ c·ªë g·∫Øng load, ƒë·ªÉ auto-play kh√¥ng ch·ªù m√£i
        }
    };

    useEffect(() => { if (audioRef.current) audioRef.current.volume = isMuted ? 0 : volume; }, [volume, isMuted]);

    // Close quick controls when clicking outside
    useEffect(() => {
        const handleClickOutside = (e: MouseEvent) => {
            if (controlsRef.current && !controlsRef.current.contains(e.target as Node)) {
                setShowQuickControls(false);
            }
        };
        if (showQuickControls) {
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
        }
    }, [showQuickControls]);

    useEffect(() => {
        if (audioRef.current && danhSachNhac.length > 0) {
            audioRef.current.load();
            if (isPlaying) {
                audioRef.current.play().catch(() => setIsPlaying(false));
            }
        }
    }, [currentSongIndex, danhSachNhac]);

    const togglePlay = () => {
        if (!audioRef.current || danhSachNhac.length === 0) return;
        if (audioRef.current.paused) { 
            audioRef.current.play().then(() => setIsPlaying(true)).catch(console.error);
        } else { 
            audioRef.current.pause(); 
            setIsPlaying(false); 
        }
    };

    const handleNext = () => {
        if (danhSachNhac.length === 0) return;
        if (isShuffling && danhSachNhac.length > 1) {
            let randomIndex;
            do { randomIndex = Math.floor(Math.random() * danhSachNhac.length); } 
            while (randomIndex === currentSongIndex);
            setCurrentSongIndex(randomIndex);
        } else {
            setCurrentSongIndex((prev) => (prev + 1) % danhSachNhac.length);
        }
    };

    const handlePrev = () => {
        if (danhSachNhac.length === 0) return;
        setCurrentSongIndex((prev) => (prev - 1 + danhSachNhac.length) % danhSachNhac.length);
    };

    const handleSongEnded = () => {
        if (isLooping && audioRef.current) {
            audioRef.current.currentTime = 0;
            audioRef.current.play();
        } else {
            handleNext();
        }
    };

    const handleUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
        if (!isAdmin) return; 
        const file = e.target.files?.[0];
        if (!file || !file.type.startsWith('audio/')) return alert('Ch·ªçn file √¢m thanh!');

        try {
            setIsUploading(true);
            const fileName = `music-${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
            const { error } = await supabase.storage.from('nhac-nen').upload(fileName, file);
            if (error) throw error;
            await fetchDanhSachNhac();
            alert('T·∫£i nh·∫°c th√†nh c√¥ng!');
        } catch (err: any) {
            alert(`L·ªói: ${err.message}`);
        } finally {
            setIsUploading(false);
            if (uploadInputRef.current) uploadInputRef.current.value = ''; 
        }
    };

    const handleDelete = async (songId: string, songName: string) => {
        if (!isAdmin) return;
        if (!confirm(`X√≥a "${songName}"?`)) return;
        try {
            setIsDeleting(songId);
            const { error } = await supabase.storage.from('nhac-nen').remove([songId]);
            if (error) throw error;
            if (danhSachNhac[currentSongIndex]?.id === songId) {
                setIsPlaying(false);
                setCurrentSongIndex(0);
            }
            await fetchDanhSachNhac();
        } catch (err: any) {
            alert('L·ªói x√≥a: ' + err.message);
        } finally {
            setIsDeleting(null);
        }
    };

    const modalContent = isOpen ? (
        <div className="fixed inset-0 z-[9999] bg-black/95 backdrop-blur-xl flex flex-col animate-in fade-in duration-300">
            <div className="flex items-center justify-between p-6 border-b border-white/10 shrink-0">
                <div className="flex items-center gap-3">
                    <Music className="text-[#C69C6D]" />
                    <h2 className="text-xl font-serif text-[#C69C6D]">Music Player</h2>
                </div>
                <button onClick={() => setIsOpen(false)} className="p-2 rounded-full hover:bg-white/10 text-white transition-colors"><X size={24} /></button>
            </div>
            <div className="flex-1 overflow-hidden flex flex-col md:flex-row">
                <div className="w-full md:w-1/2 p-4 md:p-8 flex flex-col items-center justify-center gap-6 md:gap-8 border-b md:border-b-0 md:border-r border-white/10 bg-gradient-to-br from-[#1a1512] to-black">
                    <div className={`w-48 h-48 md:w-64 md:h-64 rounded-full border-4 border-[#C69C6D]/30 shadow-[0_0_50px_rgba(198,156,109,0.2)] flex items-center justify-center relative overflow-hidden ${isPlaying ? 'animate-[spin_10s_linear_infinite]' : ''}`}>
                        <div className="absolute inset-0 bg-gradient-to-tr from-black via-[#C69C6D]/20 to-black opacity-80"></div>
                        <div className="w-16 h-16 md:w-20 md:h-20 bg-black rounded-full border-2 border-[#C69C6D] z-10 flex items-center justify-center">
                             <div className="w-3 h-3 md:w-4 md:h-4 bg-[#C69C6D] rounded-full"></div>
                        </div>
                    </div>
                    <div className="text-center space-y-1 md:space-y-2">
                        <h3 className="text-xl md:text-2xl font-bold text-[#F5F5F5] line-clamp-1 px-4">{danhSachNhac.length > 0 ? danhSachNhac[currentSongIndex]?.name : 'Ch∆∞a c√≥ nh·∫°c trong Playlist'}</h3>
                        {errorMsg && <p className="text-red-500 text-xs flex items-center justify-center gap-1"><AlertCircle size={12}/> {errorMsg}</p>}
                    </div>
                    <div className="flex items-center gap-4 md:gap-8">
                        <button onClick={() => setIsShuffling(!isShuffling)} className={`p-2 transition-all ${isShuffling ? 'text-[#C69C6D]' : 'text-white/30 hover:text-white'}`} title="Tr·ªôn b√†i"><Shuffle size={20} /></button>
                        <button onClick={handlePrev} className="text-white/50 hover:text-white transition-colors disabled:opacity-30" disabled={danhSachNhac.length === 0}><SkipForward size={24} className="rotate-180" /></button>
                        <button onClick={togglePlay} disabled={danhSachNhac.length === 0} className="w-14 h-14 md:w-16 md:h-16 rounded-full bg-[#C69C6D] text-black flex items-center justify-center hover:scale-105 active:scale-95 transition-all shadow-[0_0_20px_rgba(198,156,109,0.5)] disabled:opacity-50 disabled:cursor-not-allowed">
                            {isPlaying ? <Pause size={28} fill="currentColor" /> : <Play size={28} fill="currentColor" className="ml-1" />}
                        </button>
                        <button onClick={handleNext} className="text-white/50 hover:text-white transition-colors disabled:opacity-30" disabled={danhSachNhac.length === 0}><SkipForward size={24} /></button>
                        <button onClick={() => setIsLooping(!isLooping)} className={`p-2 transition-all ${isLooping ? 'text-[#C69C6D]' : 'text-white/30 hover:text-white'}`} title="L·∫∑p l·∫°i 1 b√†i"><Repeat1 size={20} /></button>
                    </div>
                    <div className="w-full max-w-[250px] flex items-center gap-4">
                        <button onClick={() => setVolume(v => v === 0 ? 0.5 : 0)} className="text-gray-400">{volume === 0 ? <VolumeX size={20}/> : <Volume2 size={20}/>}</button>
                        <input type="range" min="0" max="1" step="0.05" value={volume} onChange={(e) => setVolume(parseFloat(e.target.value))} className="flex-1 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[#C69C6D]"/>
                    </div>
                </div>
                <div className="w-full md:w-1/2 flex flex-col bg-[#0a0807] min-h-0">
                    <div className="p-4 border-b border-white/10 flex justify-between items-center bg-white/5 shrink-0">
                        <span className="text-sm font-bold text-white uppercase">Playlist ({danhSachNhac.length})</span>
                        {isAdmin && (
                            <div>
                                <input type="file" ref={uploadInputRef} onChange={handleUpload} accept="audio/*" className="hidden" />
                                <button onClick={() => uploadInputRef.current?.click()} disabled={isUploading} className="flex items-center gap-2 px-4 py-2 bg-[#C69C6D]/20 hover:bg-[#C69C6D] text-[#C69C6D] hover:text-black rounded-full text-xs font-bold uppercase transition-all">
                                    {isUploading ? <Loader2 size={14} className="animate-spin" /> : <Upload size={14} />} {isUploading ? 'ƒêang t·∫£i...' : 'Th√™m nh·∫°c'}
                                </button>
                            </div>
                        )}
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scroll p-4 space-y-2">
                        {danhSachNhac.length === 0 && <div className="text-center text-gray-500 py-10"><Music size={40} className="mx-auto mb-2 opacity-20"/><p>Ch∆∞a c√≥ b√†i h√°t n√†o</p></div>}
                        {danhSachNhac.map((song, idx) => (
                            <div key={song.id} onClick={() => { setCurrentSongIndex(idx); setIsPlaying(true); }} className={`group flex items-center gap-4 p-3 rounded-xl cursor-pointer transition-all border border-transparent ${currentSongIndex === idx ? 'bg-[#C69C6D]/10 border-[#C69C6D]/30 text-[#C69C6D]' : 'hover:bg-white/5 text-gray-400 border-white/5'}`}>
                                <div className="w-8 h-8 flex items-center justify-center rounded bg-black/30 text-[10px] font-mono shrink-0">
                                    {currentSongIndex === idx && isPlaying ? <div className="flex gap-0.5 items-end h-3"><span className="w-0.5 bg-current animate-[bounce_1s_infinite] h-2"></span><span className="w-0.5 bg-current animate-[bounce_1.2s_infinite] h-3"></span></div> : idx + 1}
                                </div>
                                <div className="flex-1 min-w-0"><div className="text-sm font-medium truncate">{song.name}</div></div>
                                {isAdmin && (
                                    <button onClick={(e) => { e.stopPropagation(); handleDelete(song.id, song.name); }} disabled={isDeleting === song.id} className="p-2 text-gray-500 hover:text-red-500 hover:bg-red-500/10 rounded-full transition-all">
                                        {isDeleting === song.id ? <Loader2 size={16} className="animate-spin" /> : <Trash2 size={16} />}
                                    </button>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    ) : null;

    return (
        <>
            <audio 
                ref={audioRef} 
                src={danhSachNhac[currentSongIndex]?.url || ''} 
                onEnded={handleSongEnded} 
                onError={(e) => {
                    console.warn("Audio load error, skipping to next track");
                    handleNext(); // Skip to next song on error
                }}
            />
            
            {/* Main Music Button - INLINE (no fixed positioning) */}
            <div ref={controlsRef} className="relative">
                {/* Quick Controls Panel - Dropdown style */}
                {showQuickControls && (
                    <div className="absolute top-full right-0 mt-2 bg-black/95 backdrop-blur-lg border border-white/20 rounded-2xl shadow-xl animate-in slide-in-from-top-2 duration-200 z-50 min-w-[280px]">
                        {/* Player Controls */}
                        <div className="px-4 py-3 border-b border-white/10 space-y-3">
                            {/* Current Song */}
                            <div className="text-xs font-semibold text-[#C69C6D] px-2 line-clamp-1 text-center">
                                {danhSachNhac.length > 0 ? danhSachNhac[currentSongIndex]?.name : 'Ch∆∞a c√≥ nh·∫°c'}
                            </div>
                            
                        {/* Quick Control Buttons */}
                            <div className="flex items-center justify-center gap-3">
                                {/* Play */}
                                <button
                                    onClick={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        if (audioRef.current?.paused) {
                                            audioRef.current?.play().then(() => setIsPlaying(true)).catch(console.error);
                                        }
                                    }}
                                    disabled={danhSachNhac.length === 0}
                                    className="p-2.5 text-white/60 hover:text-white hover:bg-[#C69C6D]/10 rounded-lg transition-colors disabled:opacity-30"
                                    title="Ph√°t"
                                >
                                    <Play size={18} fill="currentColor" className="ml-0.5" />
                                </button>
                                
                                {/* Stop */}
                                <button
                                    onClick={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        if (audioRef.current) {
                                            audioRef.current.pause();
                                            audioRef.current.currentTime = 0;
                                            setIsPlaying(false);
                                        }
                                    }}
                                    disabled={danhSachNhac.length === 0}
                                    className="p-2.5 text-white/60 hover:text-white hover:bg-[#C69C6D]/10 rounded-lg transition-colors disabled:opacity-30"
                                    title="D·ª´ng"
                                >
                                    <Square size={18} fill="currentColor" />
                                </button>
                            </div>
                        </div>
                        
                        {/* Volume Control */}
                        <div className="px-4 py-3 border-b border-white/10">
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        setIsMuted(!isMuted);
                                    }}
                                    className={`p-1.5 rounded-lg transition-all ${
                                        isMuted 
                                            ? 'bg-red-500/20 text-red-400' 
                                            : 'text-white/60 hover:text-white hover:bg-white/10'
                                    }`}
                                    title={isMuted ? 'B·∫≠t √¢m' : 'T·∫Øt √¢m'}
                                >
                                    {isMuted ? <VolumeX size={16} /> : <Volume1 size={16} />}
                                </button>
                                <input
                                    type="range"
                                    min="0"
                                    max="1"
                                    step="0.05"
                                    value={isMuted ? 0 : volume}
                                    onChange={(e) => {
                                        const val = parseFloat(e.target.value);
                                        setVolume(val);
                                        if (val > 0) setIsMuted(false);
                                    }}
                                    className="flex-1 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[#C69C6D]"
                                />
                                <span className="text-xs text-white/40 w-8">{Math.round((isMuted ? 0 : volume) * 100)}%</span>
                            </div>
                        </div>
                        
                        {/* Mode Buttons */}
                        <div className="px-4 py-3 flex items-center justify-between gap-2">
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    setIsLooping(!isLooping);
                                }}
                                className={`flex-1 p-2 text-xs rounded-lg transition-all font-semibold ${
                                    isLooping
                                        ? 'bg-[#C69C6D]/20 text-[#C69C6D]'
                                        : 'bg-white/5 text-white/60 hover:bg-white/10'
                                }`}
                                title="L·∫∑p 1 b√†i"
                            >
                                <Repeat1 size={14} className="mx-auto" />
                            </button>
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    setIsShuffling(!isShuffling);
                                }}
                                className={`flex-1 p-2 text-xs rounded-lg transition-all font-semibold ${
                                    isShuffling
                                        ? 'bg-[#C69C6D]/20 text-[#C69C6D]'
                                        : 'bg-white/5 text-white/60 hover:bg-white/10'
                                }`}
                                title="Tr·ªôn b√†i"
                            >
                                <Shuffle size={14} className="mx-auto" />
                            </button>
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    setIsOpen(true);
                                }}
                                className="flex-1 p-2 text-xs bg-white/5 text-white/60 hover:bg-white/10 rounded-lg transition-all font-semibold"
                                title="M·ªü playlist ƒë·∫ßy ƒë·ªß"
                            >
                                <Music size={14} className="mx-auto" />
                            </button>
                        </div>
                    </div>
                )}
                
                {/* Main Music Button - 1 n√∫t duy nh·∫•t */}
                {!isOpen && (
                    <button 
                        onClick={() => setShowQuickControls(!showQuickControls)}
                        className={`w-10 h-10 rounded-full flex items-center justify-center relative active:scale-95 transition-all border shadow-lg ${
                            isPlaying 
                                ? 'bg-[#C69C6D] border-[#C69C6D] text-black shadow-[0_0_15px_rgba(198,156,109,0.4)] animate-[spin_4s_linear_infinite]' 
                                : 'bg-black/40 border-white/20 text-white hover:bg-white/10 backdrop-blur-md'
                        }`}
                        title="ƒêi·ªÅu khi·ªÉn nh·∫°c"
                    >
                        <Music size={18} />
                    </button>
                )}
            </div>
            
            {mounted && createPortal(modalContent, document.body)}
        </>
    );
}
</file>

<file path="page.tsx">
"use client";

import React, { useState, useEffect, Suspense } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { MapPin, ArrowRight, LogIn, Loader2 } from "lucide-react";
import CongDangNhap from "@/app/CongDangNhap/CongDangNhap";
import GoogleDich from "@/app/ThuVien/GoogleDich";
import { AuthService } from "@/app/CongDangNhap/AuthService";
import { useAppSettings } from "@/app/ThuVien/AppSettingsContext";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { getRedirectUrl } from "@/app/CongDangNhap/RoleRedirectService";

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const BASE_IMG_URL = `${SUPABASE_URL}/storage/v1/object/public/hinh-nen`;

function TrangChuContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const { language } = useAppSettings();

  const [hienPopupLogin, setHienPopupLogin] = useState(false);
  const [nguoiDung, setNguoiDung] = useState<any>(null);
  const [loiChao, setLoiChao] = useState("");
  const [showGreeting, setShowGreeting] = useState(true);
  const [isCheckingAuth, setIsCheckingAuth] = useState(true);
  const [isRedirecting, setIsRedirecting] = useState(false);
  const [daKiemTraLogin, setDaKiemTraLogin] = useState(false);

  // 1. ZOMBIE KILLER - X·ª≠ l√Ω khi v·ª´a Logout
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get("logout")) {
      console.log("üõë [ZOMBIE KILLER] Logout detected.");
      setNguoiDung(null);
      setDaKiemTraLogin(true); // Cho ph√©p render UI ngay
      setIsCheckingAuth(false);
      if (typeof window !== "undefined") {
        localStorage.clear();
        sessionStorage.clear();
        document.cookie = "VISITOR_MODE=; Path=/; Max-Age=0; SameSite=Lax";
      }
      window.history.replaceState({}, "", "/");
      return;
    }
  }, []);

  // 2. CHECK SESSION + SAFETY TIMER (FIX L·ªñI M√ÄN H√åNH ƒêEN)
  useEffect(() => {
    if (new URLSearchParams(window.location.search).get("logout")) return;

    // üü¢ TIMER C·ª®U H·ªò: Sau 3s n·∫øu ch∆∞a check xong th√¨ coi nh∆∞ ch∆∞a login ƒë·ªÉ hi·ªán n√∫t
    const safetyTimer = setTimeout(() => {
      setDaKiemTraLogin((prev) => {
        if (!prev) {
          console.warn("‚ö†Ô∏è Login check timeout - Force UI render");
          setNguoiDung(null);
          setIsCheckingAuth(false);
          return true; // B·∫Øt bu·ªôc render UI
        }
        return prev;
      });
    }, 3000);

    const checkSession = async () => {
      setIsCheckingAuth(true);
      try {
        // D·ªçn r√°c localStorage
        const cached = localStorage.getItem("USER_INFO");
        if (cached === "undefined") localStorage.removeItem("USER_INFO");
        else if (cached) {
          try {
            JSON.parse(cached);
          } catch {
            localStorage.removeItem("USER_INFO");
          }
        }

        // H·ªèi Supabase
        const {
          data: { session },
          error,
        } = await supabase.auth.getSession();

        if (error || !session) {
          console.log("üö´ No session found.");
          setNguoiDung(null);
          localStorage.removeItem("USER_INFO");
          localStorage.removeItem("USER_ROLE");
        } else {
          console.log("‚úÖ Session valid:", session.user.email);
          const user = await AuthService.getCurrentUser();
          if (user) {
            setNguoiDung(user);
            localStorage.setItem("USER_INFO", JSON.stringify(user));
          } else {
            setNguoiDung(null);
          }
        }
      } catch (e) {
        console.error("Session check error:", e);
        setNguoiDung(null);
      } finally {
        setIsCheckingAuth(false);
        setDaKiemTraLogin(true); // ƒê√°nh d·∫•u ƒë√£ xong
      }
    };

    checkSession();

    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange(async (event) => {
      if (event === "SIGNED_IN") await checkSession();
      else if (event === "SIGNED_OUT") {
        setNguoiDung(null);
        localStorage.removeItem("USER_INFO");
        localStorage.removeItem("USER_ROLE");
      }
    });

    return () => {
      subscription.unsubscribe();
      clearTimeout(safetyTimer); // X√≥a timer khi unmount
    };
  }, []);

  // 3. AUTO-REDIRECT
  useEffect(() => {
    if (!nguoiDung || isRedirecting) return;
    if (new URLSearchParams(window.location.search).get("logout")) return;
    handleMainAction();
  }, [nguoiDung]);

  // 4. L·ªúI CH√ÄO
  useEffect(() => {
    const name = nguoiDung?.ho_ten || (language === "vi" ? "Kh√°ch" : "Guest");
    const h = new Date().getHours();
    let timeGreeting = language === "vi" ? "Ch√†o bu·ªïi t·ªëi" : "Good evening";
    if (h >= 5 && h < 11)
      timeGreeting = language === "vi" ? "Ch√†o bu·ªïi s√°ng" : "Good morning";
    else if (h >= 11 && h < 14)
      timeGreeting = language === "vi" ? "Ch√†o bu·ªïi tr∆∞a" : "Good afternoon";
    else if (h >= 14 && h < 18)
      timeGreeting = language === "vi" ? "Ch√†o bu·ªïi chi·ªÅu" : "Good afternoon";

    setLoiChao(`${timeGreeting}, ${name}!`);
    setShowGreeting(true);
    const timer = setTimeout(() => setShowGreeting(false), 5000);
    return () => clearTimeout(timer);
  }, [nguoiDung, language]);

  const handleGuestVisit = () => {
    document.cookie = "VISITOR_MODE=1; path=/; max-age=86400; SameSite=Lax";
    router.push("/trangchu");
  };

  const handleMainAction = async () => {
    if (!nguoiDung) {
      setHienPopupLogin(true);
      return;
    }
    setIsRedirecting(true);
    try {
      const role =
        nguoiDung.role ||
        nguoiDung.vi_tri_normalized ||
        nguoiDung.phan_loai_normalized ||
        "khach";
      const type = nguoiDung.userType || "khach_hang";
      const targetUrl = await getRedirectUrl(type, role);
      router.push(targetUrl);
    } catch (e) {
      console.error("Redirect error:", e);
      setIsRedirecting(false);
      setNguoiDung(null);
    }
  };

  const bgVersion = React.useMemo(() => Date.now(), []);
  const bgMobile = `${BASE_IMG_URL}/login-mobile.jpg?v=${bgVersion}`;
  const bgDesktop = `${BASE_IMG_URL}/login-desktop.jpg?v=${bgVersion}`;

  // M√ÄN H√åNH CH·ªú (ƒê√£ c√≥ timeout b·∫£o v·ªá n√™n s·∫Ω kh√¥ng treo m√£i)
  if (!daKiemTraLogin)
    return <div className="fixed inset-0 bg-[#050505] z-50" />;

  return (
    <div className="relative h-app w-full bg-[#050505] text-[#F5F5F5] overflow-hidden font-sans flex flex-col">
      {/* Background */}
      <div className="absolute inset-0 w-full h-full z-0 pointer-events-none select-none">
        {SUPABASE_URL && (
          <>
            <img
              src={bgMobile}
              className="absolute inset-0 w-full h-full object-cover md:hidden"
              loading="eager"
              alt="bg"
            />
            <img
              src={bgDesktop}
              className="absolute inset-0 w-full h-full object-cover hidden md:block"
              loading="eager"
              alt="bg"
            />
          </>
        )}
        <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent" />
      </div>

      <GoogleDich />

      <div className="absolute inset-0 z-10 flex flex-col justify-center items-center translate-y-[10%] p-4">
        <div className="w-full max-w-[95%] md:max-w-2xl flex flex-col items-center gap-6 md:gap-8 animate-fade-in-up">
          {/* Header */}
          <div className="text-center w-full">
            <div className="flex items-center justify-center gap-2 mb-2 md:mb-3">
              <MapPin size={16} className="text-yellow-500" />
              <span className="text-sm font-bold tracking-[0.3em] uppercase text-white drop-shadow-md">
                {language === "vi"
                  ? "C·∫¶N TH∆† / VI·ªÜT NAM"
                  : "CAN THO / VIET NAM"}
              </span>
            </div>
            <div className="relative">
              <h1
                className="font-thin tracking-widest leading-none text-white super-text-shadow whitespace-nowrap"
                style={{ fontSize: "clamp(2rem, 5vw, 3.5rem)" }}
              >
                {language === "vi" ? "ƒêƒÇNG NGHI√äM" : "DANG NGHIEM"}
              </h1>
              <p
                className="font-serif italic text-yellow-500 mt-2 tracking-wide font-medium drop-shadow-md"
                style={{ fontSize: "clamp(14px, 1.5vw, 1.2rem)" }}
              >
                Art Gallery
              </p>
            </div>
            <div className="h-8 flex items-center justify-center mt-2">
              {showGreeting && (
                <p className="text-sm md:text-base text-white/80 animate-pulse font-serif italic">
                  {loiChao}
                </p>
              )}
            </div>
          </div>

          {/* Buttons */}
          <div className="flex flex-wrap items-center justify-center gap-6 md:gap-10 w-full">
            <button
              onClick={handleGuestVisit}
              className="group flex flex-col items-center gap-3 opacity-90 hover:opacity-100 transition-all cursor-pointer hover:scale-105 active:scale-95"
            >
              <div className="w-12 h-12 md:w-14 md:h-14 rounded-full flex items-center justify-center bg-white/5 text-white group-hover:bg-yellow-500 group-hover:text-black transition-all duration-500 ease-out shadow-lg border border-white/20 hover:border-yellow-400">
                <ArrowRight
                  size={24}
                  className="group-hover:-rotate-45 transition-transform duration-500"
                />
              </div>
              <div className="flex flex-col items-center gap-1">
                <span className="text-sm font-bold tracking-[0.2em] text-white group-hover:text-yellow-400 transition-colors drop-shadow-lg">
                  {language === "vi" ? "THAM QUAN" : "VISIT"}
                </span>
              </div>
            </button>

            <div className="hidden sm:block w-[1px] h-12 bg-white/20" />

            <button
              onClick={handleMainAction}
              disabled={isCheckingAuth || isRedirecting}
              className="group flex flex-col items-center gap-3 opacity-90 hover:opacity-100 transition-all cursor-pointer hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <div className="w-12 h-12 md:w-14 md:h-14 rounded-full flex items-center justify-center bg-transparent text-gray-400 group-hover:bg-white group-hover:text-black transition-all duration-500 ease-out shadow-lg border border-white/20 hover:border-white">
                {isCheckingAuth || isRedirecting ? (
                  <Loader2 size={24} className="animate-spin" />
                ) : nguoiDung ? (
                  <ArrowRight size={24} />
                ) : (
                  <LogIn size={24} />
                )}
              </div>
              <div className="flex flex-col items-center gap-1">
                <span className="text-sm font-bold tracking-[0.2em] text-gray-400 group-hover:text-white transition-colors drop-shadow-lg">
                  {isCheckingAuth
                    ? "..."
                    : isRedirecting
                    ? language === "vi"
                      ? "ƒêANG V√ÄO..."
                      : "LOADING..."
                    : nguoiDung
                    ? language === "vi"
                      ? "V√ÄO PH√íNG"
                      : "MY ROOM"
                    : language === "vi"
                    ? "ƒêƒÇNG NH·∫¨P"
                    : "LOGIN"}
                </span>
              </div>
            </button>
          </div>
        </div>

        <div className="mt-8 md:mt-12 opacity-40">
          <p className="text-sm tracking-[0.2em] uppercase font-bold text-gray-500 drop-shadow-sm">
            ¬© {new Date().getFullYear()} DANG NghiemArt
          </p>
        </div>
      </div>

      <CongDangNhap
        isOpen={hienPopupLogin}
        onClose={() => setHienPopupLogin(false)}
      />

      <style jsx global>{`
        @keyframes fade-in-up {
          0% {
            opacity: 0;
            transform: translateY(20px);
          }
          100% {
            opacity: 1;
            transform: translateY(0);
          }
        }
        .animate-fade-in-up {
          animation: fade-in-up 1.2s ease-out forwards;
        }
        .super-text-shadow {
          text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9),
            0 8px 16px rgba(0, 0, 0, 0.8), 0 0 20px rgba(0, 0, 0, 0.5);
        }
      `}</style>
    </div>
  );
}

export default function TrangChuDashboard() {
  return (
    <Suspense
      fallback={
        <div className="w-full h-screen bg-[#050505] flex items-center justify-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#C69C6D]"></div>
        </div>
      }
    >
      <TrangChuContent />
    </Suspense>
  );
}
</file>

<file path="phongadmin/page.tsx">
/**
 * ============================================================
 * PH√íNG ADMIN - COMMAND CENTER
 * ============================================================
 *
 * File page duy nh·∫•t c·ªßa ph√≤ng admin.
 * G·ªçi c√°c ch·ª©c nƒÉng t·ª´ cacchucnang v·ªõi quy·ªÅn FULL.
 *
 * QUY·ªÄN H·∫†N PH√íNG ADMIN:
 * - allowView: ‚úÖ Xem t·∫•t c·∫£
 * - allowEdit: ‚úÖ S·ª≠a t·∫•t c·∫£
 * - allowDelete: ‚úÖ X√≥a t·∫•t c·∫£
 * - allowBulk: ‚úÖ Thao t√°c h√†ng lo·∫°t
 *
 * C√ÅC CH·ª®C NƒÇNG:
 * - T·ªïng quan Dashboard
 * - Nh√¢n s·ª± (full quy·ªÅn)
 * - Kh√°ch h√†ng (full quy·ªÅn)
 * - Data Center (admin only)
 * - C√†i ƒë·∫∑t h·ªá th·ªëng (admin only)
 */

"use client";

import React, { useState, useEffect } from "react";
import { useUser } from "@/app/ThuVien/UserContext";
import {
  Users,
  BookUser,
  LayoutDashboard,
  Database,
  Settings,
} from "lucide-react";
import KhungTrangChuan from "@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan";
import ThanhPhongChucNang from "@/app/components/ThanhPhongChucNang";

// Import ch·ª©c nƒÉng t·ª´ cacchucnang
import { NhanSuChucNang } from "@/app/components/cacchucnang";
import { KhachHangChucNang } from "@/app/components/cacchucnang/khachhang";

// ============================================================
// QUY·ªÄN H·∫†N PH√íNG ADMIN - FULL ACCESS
// ============================================================

const ADMIN_PERMISSIONS = {
  nhansu: {
    allowView: true,
    allowEdit: true,
    allowDelete: true,
    allowBulk: true,
  },
  khachhang: {
    allowView: true,
    allowEdit: true,
    allowDelete: true,
    allowBulk: true,
  },
  // Th√™m quy·ªÅn cho c√°c ch·ª©c nƒÉng kh√°c...
};

// ============================================================
// DANH S√ÅCH CH·ª®C NƒÇNG
// ============================================================

const ADMIN_FUNCTIONS = [
  // Qu·∫£n l√Ω ng∆∞·ªùi d√πng
  { id: "nhansu", label: "NH√ÇN S·ª∞", icon: Users },
  { id: "khachhang", label: "KH√ÅCH H√ÄNG", icon: BookUser },
  // Admin only
];

// ============================================================
// COMPONENT CH√çNH
// ============================================================

export default function PhongAdminPage() {
  const { user: contextUser, loading: contextLoading } = useUser();
  const [authLoading, setAuthLoading] = useState(true);
  const [activeFunction, setActiveFunction] = useState<string>("dashboard");

  useEffect(() => {
    if (!contextLoading) setAuthLoading(false);
  }, [contextLoading]);

  // Loading state
  if (authLoading) {
    return (
      <div className="min-h-screen bg-black flex items-center justify-center">
        <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
      </div>
    );
  }

  // Get user info
  let displayUser = contextUser;
  if (!displayUser && typeof window !== "undefined") {
    try {
      const stored = localStorage.getItem("USER_INFO");
      displayUser = stored ? JSON.parse(stored) : null;
    } catch (e) {
      displayUser = null;
    }
  }

  // ========================================
  // RENDER
  // ========================================

  return (
    <KhungTrangChuan
      nguoiDung={displayUser}
      loiChao="ADMIN COMMAND CENTER"
      contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
    >
      {/* Thanh Ph√≤ng + Ch·ª©c NƒÉng */}
      <ThanhPhongChucNang
        tenPhong="PH√íNG ADMIN"
        functions={ADMIN_FUNCTIONS}
        activeFunction={activeFunction}
        onFunctionChange={setActiveFunction}
      />

      {/* Content Area */}
      <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
        <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />

        <div className="absolute inset-0 z-10">
          <div className="w-full h-full flex flex-col relative">
            {/* ====== RENDER C√ÅC CH·ª®C NƒÇNG ====== */}

            {/* Nh√¢n s·ª± - G·ªåI T·ª™ CACCHUCNANG v·ªõi quy·ªÅn ADMIN */}
            {activeFunction === "nhansu" && (
              <NhanSuChucNang permissions={ADMIN_PERMISSIONS.nhansu} />
            )}

            {/* Kh√°ch h√†ng - G·ªåI T·ª™ CACCHUCNANG v·ªõi quy·ªÅn ADMIN */}
            {activeFunction === "khachhang" && (
              <KhachHangChucNang permissions={ADMIN_PERMISSIONS.khachhang} />
            )}
          </div>
        </div>
      </div>
    </KhungTrangChuan>
  );
}

// ============================================================
// COMPONENTS PH·ª§
// ============================================================

function PlaceholderScreen({ text }: { text: string }) {
  return (
    <div className="h-full flex items-center justify-center text-white/30 font-bold uppercase">
      {text}
    </div>
  );
}

function DashboardPlaceholder() {
  return (
    <div className="h-full flex flex-col items-center justify-center text-white/30">
      <LayoutDashboard size={64} className="mb-4 opacity-30" />
      <p className="font-bold uppercase">Dashboard T·ªïng Quan</p>
      <p className="text-sm mt-2">ƒêang ph√°t tri·ªÉn...</p>
    </div>
  );
}
</file>

<file path="phongctv/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { UserCheck } from 'lucide-react';

// Quy·ªÅn c·ªßa CTV: ch·ªâ xem
const CTV_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const CTV_FUNCTIONS = [
    { id: 'khachhang', label: 'KH√ÅCH H√ÄNG', icon: UserCheck },
];

export default function PhongCTV() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('khachhang');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PH√íNG CTV"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PH√íNG CTV"
                functions={CTV_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={CTV_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="phongketoan/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { NhanSuChucNang } from '@/app/components/cacchucnang/nhansu';
import { Users } from 'lucide-react';

// Quy·ªÅn c·ªßa K·∫ø to√°n: xem - KH√îNG s·ª≠a, KH√îNG x√≥a
const KETOAN_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const KETOAN_FUNCTIONS = [
    { id: 'nhansu', label: 'NH√ÇN S·ª∞', icon: Users },
];

export default function PhongKeToan() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('nhansu');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PH√íNG K·∫æ TO√ÅN"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PH√íNG K·∫æ TO√ÅN"
                functions={KETOAN_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'nhansu' && (
                            <NhanSuChucNang permissions={KETOAN_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="phongkhachhang/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { UserCheck } from 'lucide-react';

// Quy·ªÅn c·ªßa Kh√°ch VIP: ch·ªâ xem th√¥ng tin c√° nh√¢n
const KHACHHANG_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const KHACHHANG_FUNCTIONS = [
    { id: 'khachhang', label: 'TH√îNG TIN', icon: UserCheck },
];

export default function PhongKhachHang() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('khachhang');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PH√íNG KH√ÅCH VIP"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PH√íNG KH√ÅCH VIP"
                functions={KHACHHANG_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={KHACHHANG_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="phongkho/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { NhanSuChucNang } from '@/app/components/cacchucnang/nhansu';
import { Users } from 'lucide-react';

// Quy·ªÅn c·ªßa Kho: xem - KH√îNG s·ª≠a, KH√îNG x√≥a
const KHO_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const KHO_FUNCTIONS = [
    { id: 'nhansu', label: 'NH√ÇN S·ª∞', icon: Users },
];

export default function PhongKho() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('nhansu');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PH√íNG KHO"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PH√íNG KHO"
                functions={KHO_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'nhansu' && (
                            <NhanSuChucNang permissions={KHO_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="phongparttime/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { UserCheck } from 'lucide-react';

// Quy·ªÅn c·ªßa Part-time: ch·ªâ xem
const PARTTIME_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const PARTTIME_FUNCTIONS = [
    { id: 'khachhang', label: 'KH√ÅCH H√ÄNG', icon: UserCheck },
];

export default function PhongPartTime() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('khachhang');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PH√íNG PART-TIME"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PH√íNG PART-TIME"
                functions={PARTTIME_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={PARTTIME_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="phongquanly/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { NhanSuChucNang } from '@/app/components/cacchucnang/nhansu';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { Users, UserCheck } from 'lucide-react';

// Quy·ªÅn c·ªßa Qu·∫£n l√Ω: xem, s·ª≠a, bulk - KH√îNG x√≥a
const QUANLY_PERMISSIONS = {
    allowView: true,
    allowEdit: true,
    allowDelete: false,
    allowBulk: true,
};

const QUANLY_FUNCTIONS = [
    { id: 'nhansu', label: 'NH√ÇN S·ª∞', icon: Users },
    { id: 'khachhang', label: 'KH√ÅCH H√ÄNG', icon: UserCheck },
];

export default function PhongQuanLy() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('nhansu');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    // Loading state
    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    // Get user info
    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PH√íNG QU·∫¢N L√ù"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            {/* Thanh Ph√≤ng + Ch·ª©c NƒÉng */}
            <ThanhPhongChucNang
                tenPhong="PH√íNG QU·∫¢N L√ù"
                functions={QUANLY_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            {/* Content Area */}
            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        
                        {/* Nh√¢n s·ª± */}
                        {activeFunction === 'nhansu' && (
                            <NhanSuChucNang permissions={QUANLY_PERMISSIONS} />
                        )}

                        {/* Kh√°ch h√†ng */}
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={QUANLY_PERMISSIONS} />
                        )}
                        
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="phongsales/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { UserCheck } from 'lucide-react';

// Quy·ªÅn c·ªßa Sales: xem, s·ª≠a - KH√îNG x√≥a, KH√îNG bulk
const SALES_PERMISSIONS = {
    allowView: true,
    allowEdit: true,
    allowDelete: false,
    allowBulk: false,
};

const SALES_FUNCTIONS = [
    { id: 'khachhang', label: 'KH√ÅCH H√ÄNG', icon: UserCheck },
];

export default function PhongSales() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('khachhang');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PH√íNG SALES"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PH√íNG SALES"
                functions={SALES_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={SALES_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="phongthietke/page.tsx">
"use client";

import React, { useState, useEffect } from "react";
import { useRouter } from "next/navigation"; // Import Router ƒë·ªÉ chuy·ªÉn trang
import { useUser } from "@/app/ThuVien/UserContext";
import KhungTrangChuan from "@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan";
import ThanhPhongChucNang from "@/app/components/ThanhPhongChucNang";
import { Palette } from "lucide-react";

// Import ch·ª©c nƒÉng M·∫´u Thi·∫øt K·∫ø
import MauThietKeChucNang from "@/app/components/cacchucnang/mauthietke/MauThietKeChucNang";

// ============================================================
// C·∫§U H√åNH QUY·ªÄN H·∫†N PH√íNG THI·∫æT K·∫æ
// ============================================================
const THIETKE_PERMISSIONS = {
  allowView: true,
  allowEdit: true,
  allowDelete: false, // Kh√¥ng ƒë∆∞·ª£c x√≥a
  allowBulk: false,
};

const THIETKE_FUNCTIONS = [
  { id: "mauthietke", label: "KHO THI·∫æT K·∫æ", icon: Palette },
];

// ============================================================
// COMPONENT CH√çNH
// ============================================================

export default function PhongThietKe() {
  const router = useRouter(); // Kh·ªüi t·∫°o router
  const { user: contextUser, loading: contextLoading } = useUser();
  const [authLoading, setAuthLoading] = useState(true);

  // M·∫∑c ƒë·ªãnh v√†o th·∫≥ng M·∫´u thi·∫øt k·∫ø
  const [activeFunction, setActiveFunction] = useState<string>("mauthietke");

  // üü¢ LOGIC KI·ªÇM TRA ƒêƒÇNG NH·∫¨P
  useEffect(() => {
    // Ch·ªâ ch·∫°y khi Context ƒë√£ load xong
    if (!contextLoading) {
      // Ki·ªÉm tra user trong Context ho·∫∑c LocalStorage (ƒë·ªÅ ph√≤ng reload trang)
      let currentUser = contextUser;
      if (!currentUser && typeof window !== "undefined") {
        try {
          const stored = localStorage.getItem("USER_INFO");
          currentUser = stored ? JSON.parse(stored) : null;
        } catch {}
      }

      // N·∫øu v·∫´n kh√¥ng c√≥ user -> ƒê√° v·ªÅ TRANG CH·ª¶
      if (!currentUser) {
        router.push("/trangchu");
      } else {
        // ƒê√£ ƒëƒÉng nh·∫≠p -> T·∫Øt m√†n h√¨nh loading
        setAuthLoading(false);
      }
    }
  }, [contextLoading, contextUser, router]);

  // M√†n h√¨nh ch·ªù trong l√∫c ki·ªÉm tra (Loading Screen)
  if (authLoading) {
    return (
      <div className="min-h-screen bg-black flex items-center justify-center">
        <div className="flex flex-col items-center gap-4">
          <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
          <p className="text-[#C69C6D] text-xs font-bold animate-pulse uppercase">
            ƒêang ki·ªÉm tra quy·ªÅn truy c·∫≠p...
          </p>
        </div>
      </div>
    );
  }

  // Get User info fallback (ƒë·ªÉ hi·ªÉn th·ªã l√™n Header)
  let displayUser = contextUser;
  if (!displayUser && typeof window !== "undefined") {
    try {
      const stored = localStorage.getItem("USER_INFO");
      displayUser = stored ? JSON.parse(stored) : null;
    } catch {
      displayUser = null;
    }
  }

  return (
    <KhungTrangChuan
      nguoiDung={displayUser}
      loiChao="PH√íNG THI·∫æT K·∫æ"
      contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
    >
      {/* Thanh Ch·ª©c NƒÉng */}
      <ThanhPhongChucNang
        tenPhong="PH√íNG THI·∫æT K·∫æ"
        functions={THIETKE_FUNCTIONS}
        activeFunction={activeFunction}
        onFunctionChange={setActiveFunction}
      />

      {/* V√πng N·ªôi Dung Ch√≠nh */}
      <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
        <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />

        <div className="absolute inset-0 z-10">
          <div className="w-full h-full flex flex-col relative">
            {activeFunction === "mauthietke" && (
              <MauThietKeChucNang permissions={THIETKE_PERMISSIONS} />
            )}
          </div>
        </div>
      </div>
    </KhungTrangChuan>
  );
}
</file>

<file path="phongtrungbay/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { UserCheck } from 'lucide-react';

// Quy·ªÅn c·ªßa Tr∆∞ng b√†y: ch·ªâ xem
const TRUNGBAY_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const TRUNGBAY_FUNCTIONS = [
    { id: 'khachhang', label: 'KH√ÅCH H√ÄNG', icon: UserCheck },
];

export default function PhongTrungBay() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('khachhang');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PH√íNG TR∆ØNG B√ÄY"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PH√íNG TR∆ØNG B√ÄY"
                functions={TRUNGBAY_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={TRUNGBAY_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="QueryProvider.tsx">
'use client';

import React, { useState } from 'react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';

export default function QueryProvider({ children }: { children: React.ReactNode }) {
  const [queryClient] = useState(() => new QueryClient({
    defaultOptions: {
      queries: {
        // D·ªØ li·ªáu ƒë∆∞·ª£c coi l√† "t∆∞∆°i" trong 1 ph√∫t, sau ƒë√≥ m·ªõi fetch l·∫°i n·∫øu c·∫ßn
        staleTime: 60 * 1000, 
        // T·ª± ƒë·ªông fetch l·∫°i khi c·ª≠a s·ªï tr√¨nh duy·ªát ƒë∆∞·ª£c focus
        refetchOnWindowFocus: false,
        // S·ªë l·∫ßn th·ª≠ l·∫°i n·∫øu API l·ªói
        retry: 1,
      },
    },
  }));

  return (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  );
}
</file>

<file path="ThuVien/AppSettingsContext.tsx">
'use client';
import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';

// =====================================================
// TYPES
// =====================================================
export type ThemeMode = 'dark' | 'light';
export type LanguageCode = 'vi' | 'en';

interface AppSettings {
  theme: ThemeMode;
  language: LanguageCode;
}

interface AppSettingsContextType {
  // State
  theme: ThemeMode;
  language: LanguageCode;
  
  // Actions
  setTheme: (theme: ThemeMode) => void;
  setLanguage: (language: LanguageCode) => void;
  toggleTheme: () => void;
  
  // Helpers
  isDark: boolean;
  isVietnamese: boolean;
  
  // Translation function
  t: (key: string) => string;
}// =====================================================
// TRANSLATIONS (ƒê√É TH·ªîI H·ªíN NGH·ªÜ THU·∫¨T)
// =====================================================
const translations: Record<LanguageCode, Record<string, string>> = {
  vi: {
    // Chung - T√¥ng gi·ªçng trang tr·ªçng
    'app.name': 'NghiemArt Management',
    'app.loading': 'ƒêang kh·ªüi t·∫°o...',
    'app.error': 'ƒê√£ c√≥ s·ª± c·ªë',
    'app.save': 'L∆∞u T√°c Ph·∫©m',
    'app.cancel': 'H·ªßy B·ªè',
    'app.confirm': 'X√°c Nh·∫≠n',
    'app.close': 'ƒê√≥ng L·∫°i',
    'app.back': 'Tr·ªü V·ªÅ',
    'app.next': 'Ti·∫øp T·ª•c',
    'app.done': 'Ho√†n T·∫•t',
    'app.edit': 'Hi·ªáu Ch·ªânh',
    'app.delete': 'Lo·∫°i B·ªè',
    'app.search': 'T√¨m ki·∫øm tinh hoa...',
    'app.refresh': 'L√†m M·ªõi',
    'app.noData': 'Ch∆∞a c√≥ d·ªØ li·ªáu tr∆∞ng b√†y',
    
    // Navigation - ƒê·ªãnh danh kh√¥ng gian
    'nav.home': 'S·∫£nh Ch√≠nh',
    'nav.account': 'H·ªì S∆° Ngh·ªá Nh√¢n',
    'nav.notifications': 'Th∆∞ T√≠n',
    'nav.department': 'Kh√¥ng Gian',
    
    // Auth - L·ªùi ch√†o m·ªùi
    'auth.login': 'Ti·∫øp B∆∞·ªõc',
    'auth.loginRegister': 'ƒêƒÉng Nh·∫≠p / Gia Nh·∫≠p',
    'auth.logout': 'R·ªùi C√µi Ngh·ªá',
    'auth.logoutConfirm': 'Qu√Ω v·ªã mu·ªën k·∫øt th√∫c phi√™n l√†m vi·ªác?',
    'auth.loggingOut': 'ƒêang ƒëƒÉng xu·∫•t...',
    'auth.loginFailed': 'Ch∆∞a th·ªÉ truy c·∫≠p',
    'auth.loginError': 'Th√¥ng tin ƒë·ªãnh danh ch∆∞a ch√≠nh x√°c.',
    'auth.needHelp': 'C·∫ßn h·ªó tr·ª£ k·ªπ thu·∫≠t?',
    'auth.enterEmail': 'Email ƒë·ªãnh danh',
    'auth.enterPassword': 'M·∫≠t kh·∫©u b·∫£o m·∫≠t',
    'auth.forgotPassword': 'Qu√™n m·∫≠t kh·∫©u?',
    'auth.rememberMe': 'Ghi nh·ªõ phi√™n n√†y',
    
    // Profile Modal
    'profile.title': 'H·ªì S∆° C√° Nh√¢n',
    'profile.settings': 'Thi·∫øt L·∫≠p H·ªá Th·ªëng',
    'profile.settingsDesc': 'Ng√¥n ng·ªØ & Giao di·ªán',
    'profile.myProfile': 'Th√¥ng Tin C·ªßa T√¥i',
    'profile.myProfileDescStaff': 'Ch·ª©c v·ª• & Th√†nh t·ª±u',
    'profile.myProfileDescCustomer': 'L·ªãch s·ª≠ s∆∞u t·∫ßm',
    'profile.personalInfo': 'S∆° Y·∫øu L√Ω L·ªãch',
    'profile.personalInfoDesc': 'Th√¥ng tin li√™n h·ªá ch√≠nh',
    'profile.achievements': 'B·∫£ng V√†ng',
    'profile.achievementsDesc': 'Ghi nh·∫≠n ƒë√≥ng g√≥p',
    'profile.orders': 'B·ªô S∆∞u T·∫≠p ƒê√£ Mua',
    'profile.ordersDesc': 'C√°c t√°c ph·∫©m s·ªü h·ªØu',
    'profile.editInfo': 'C·∫≠p nh·∫≠t th√¥ng tin',
    'profile.user': 'Th√†nh vi√™n',
    
    // Fields
    'field.fullName': 'H·ªç v√† T√™n',
    'field.email': 'Th∆∞ ƒëi·ªán t·ª≠',
    'field.phone': 'S·ªë ƒëi·ªán tho·∫°i',
    'field.address': 'ƒê·ªãa ch·ªâ li√™n h·ªá',
    'field.idCard': 'ƒê·ªãnh danh c√¥ng d√¢n',
    'field.notUpdated': '---',
    
    // Settings
    'settings.language': 'Ng√¥n Ng·ªØ',
    'settings.theme': 'S·∫Øc Th√°i',
    'settings.themeDark': 'Huy·ªÅn B√≠ (T·ªëi)',
    'settings.themeDarkDesc': 'TƒÉng chi·ªÅu s√¢u, d·ªãu m·∫Øt',
    'settings.themeLight': 'Thanh Tao (S√°ng)',
    'settings.themeLightDesc': 'R·ª±c r·ª°, r√µ r√†ng',
    
    // Orders
    'orders.title': 'ƒê∆°n ƒê·∫∑t T√°c Ph·∫©m',
    'orders.empty': 'Ch∆∞a c√≥ t√°c ph·∫©m n√†o',
    'orders.emptyDesc': 'Qu√Ω kh√°ch ch∆∞a s·ªü h·ªØu t√°c ph·∫©m n√†o.',
    
    // Achievements
    'achievements.title': 'Th√†nh T·ª±u',
    'achievements.developing': 'ƒêang ki·∫øn t·∫°o...',
    'achievements.points': 'ƒêi·ªÉm C·ªëng Hi·∫øn',
    'achievements.badges': 'Hu√¢n Ch∆∞∆°ng',
    'achievements.noBadges': 'Ch∆∞a ƒë·∫°t',
    
    // Notifications
    'notifications.title': 'Th√¥ng B√°o',
    'notifications.empty': 'H·ªôp th∆∞ tr·ªëng',
    'notifications.markAllRead': 'ƒê√£ xem t·∫•t c·∫£',
    'notifications.new': 'M·ªõi',
    
    // Homepage
    'home.welcome': 'H√¢n h·∫°nh ƒë√≥n ti·∫øp',
    'home.goodMorning': 'Ch√∫c ng√†y m·ªõi r·ª±c r·ª°',
    'home.goodAfternoon': 'Ch√∫c bu·ªïi chi·ªÅu an l√†nh',
    'home.goodEvening': 'Ch√∫c bu·ªïi t·ªëi ·∫•m √°p',
    'home.guest': 'Qu√Ω Th∆∞·ªüng Kh√°ch',
    
    // Rooms/Departments - T√™n ph√≤ng ban ngh·ªá thu·∫≠t
    'room.admin': 'ƒê√†i Qu·∫£n Tr·ªã',
    'room.manager': 'Ph√≤ng ƒêi·ªÅu H√†nh',
    'room.parttime': 'Kh√¥ng Gian S√°ng T·∫°o',
    'room.showroom': 'Ph√≤ng Tr∆∞ng B√†y',
    'room.vip': 'Ph√≤ng Th∆∞·ª£ng Kh√°ch',
  },
  en: {
    // Common
    'app.name': 'NghiemArt System',
    'app.loading': 'Initializing...',
    'app.error': 'An error occurred',
    'app.save': 'Save Artwork',
    'app.cancel': 'Cancel',
    'app.confirm': 'Confirm',
    'app.close': 'Close',
    'app.back': 'Return',
    'app.next': 'Next',
    'app.done': 'Completed',
    'app.edit': 'Modify',
    'app.delete': 'Remove',
    'app.search': 'Search masterpieces...',
    'app.refresh': 'Refresh',
    'app.noData': 'No data available',
    
    // Navigation
    'nav.home': 'Grand Hall',
    'nav.account': 'Artisan Profile',
    'nav.notifications': 'Messages',
    'nav.department': 'Studio',
    
    // Auth
    'auth.login': 'Enter',
    'auth.loginRegister': 'Login / Join',
    'auth.logout': 'Leave Studio',
    'auth.logoutConfirm': 'Do you wish to end your session?',
    'auth.loggingOut': 'Leaving...',
    'auth.loginFailed': 'Access Denied',
    'auth.loginError': 'Incorrect credentials.',
    'auth.needHelp': 'Need assistance?',
    'auth.enterEmail': 'Your Email',
    'auth.enterPassword': 'Your Password',
    'auth.forgotPassword': 'Lost Key?',
    'auth.rememberMe': 'Remember me',
    
    // Profile
    'profile.title': 'My Dossier',
    'profile.settings': 'Configuration',
    'profile.settingsDesc': 'Language & Aesthetics',
    'profile.myProfile': 'My Portfolio',
    'profile.myProfileDescStaff': 'Career & Awards',
    'profile.myProfileDescCustomer': 'Collection History',
    'profile.personalInfo': 'Biography',
    'profile.personalInfoDesc': 'Contact details',
    'profile.achievements': 'Honors',
    'profile.achievementsDesc': 'Points & Medals',
    'profile.orders': 'Acquisitions',
    'profile.ordersDesc': 'Artwork history',
    'profile.editInfo': 'Update Bio',
    'profile.user': 'Member',
    
    // Fields
    'field.fullName': 'Full Name',
    'field.email': 'Email',
    'field.phone': 'Contact Number',
    'field.address': 'Address',
    'field.idCard': 'ID / Passport',
    'field.notUpdated': '---',
    
    // Settings
    'settings.language': 'Language',
    'settings.theme': 'Ambiance',
    'settings.themeDark': 'Mystic (Dark)',
    'settings.themeDarkDesc': 'Deep & Elegant',
    'settings.themeLight': 'Radiant (Light)',
    'settings.themeLightDesc': 'Bright & Clear',
    
    // Orders
    'orders.title': 'Orders',
    'orders.empty': 'No acquisitions yet',
    'orders.emptyDesc': 'Your collection is empty',
    
    // Achievements
    'achievements.title': 'Achievements',
    'achievements.developing': 'Coming soon...',
    'achievements.points': 'Tribute Points',
    'achievements.badges': 'Badges',
    'achievements.noBadges': 'None',
    
    // Notifications
    'notifications.title': 'Notifications',
    'notifications.empty': 'Silence',
    'notifications.markAllRead': 'Mark all read',
    'notifications.new': 'New',
    
    // Homepage
    'home.welcome': 'Welcome',
    'home.goodMorning': 'Splendid Morning',
    'home.goodAfternoon': 'Good Afternoon',
    'home.goodEvening': 'Tranquil Evening',
    'home.guest': 'Distinguished Guest',
    
    // Rooms
    'room.admin': 'Command Center',
    'room.manager': 'Operations',
    'room.parttime': 'Creative Space',
    'room.showroom': 'Gallery',
    'room.vip': 'VIP Lounge',
  },
};
// =====================================================
// LOCAL STORAGE KEYS
// =====================================================
const STORAGE_KEYS = {
  theme: 'app_theme',
  language: 'app_language',
};

// =====================================================
// CONTEXT
// =====================================================
const AppSettingsContext = createContext<AppSettingsContextType | undefined>(undefined);

// =====================================================
// PROVIDER
// =====================================================
export function AppSettingsProvider({ children }: { children: ReactNode }) {
  const [theme, setThemeState] = useState<ThemeMode>('dark');
  const [language, setLanguageState] = useState<LanguageCode>('vi');
  const [isHydrated, setIsHydrated] = useState(false);

  // Load settings t·ª´ localStorage khi mount
  useEffect(() => {
    const savedTheme = localStorage.getItem(STORAGE_KEYS.theme) as ThemeMode;
    const savedLanguage = localStorage.getItem(STORAGE_KEYS.language) as LanguageCode;
    
    if (savedTheme && ['dark', 'light'].includes(savedTheme)) {
      setThemeState(savedTheme);
    }
    if (savedLanguage && ['vi', 'en'].includes(savedLanguage)) {
      setLanguageState(savedLanguage);
    }
    
    setIsHydrated(true);
  }, []);

  // Apply theme to document
  useEffect(() => {
    if (!isHydrated) return;
    
    const root = document.documentElement;
    const body = document.body;
    
    if (theme === 'light') {
      root.classList.add('light-theme');
      root.classList.remove('dark-theme');
      body.style.backgroundColor = '#f5f5f5';
      body.style.color = '#1a1a1a';
    } else {
      root.classList.add('dark-theme');
      root.classList.remove('light-theme');
      body.style.backgroundColor = '#000000';
      body.style.color = '#ffffff';
    }
    
    // L∆∞u v√†o localStorage
    localStorage.setItem(STORAGE_KEYS.theme, theme);
  }, [theme, isHydrated]);

  // Save language to localStorage
  useEffect(() => {
    if (!isHydrated) return;
    localStorage.setItem(STORAGE_KEYS.language, language);
    document.documentElement.lang = language;
  }, [language, isHydrated]);

  const setTheme = (newTheme: ThemeMode) => {
    setThemeState(newTheme);
  };

  const setLanguage = (newLanguage: LanguageCode) => {
    setLanguageState(newLanguage);
  };

  const toggleTheme = () => {
    setThemeState(prev => prev === 'dark' ? 'light' : 'dark');
  };

  // Translation function
  const t = (key: string): string => {
    return translations[language][key] || key;
  };

  const value: AppSettingsContextType = {
    theme,
    language,
    setTheme,
    setLanguage,
    toggleTheme,
    isDark: theme === 'dark',
    isVietnamese: language === 'vi',
    t,
  };

  return (
    <AppSettingsContext.Provider value={value}>
      {children}
    </AppSettingsContext.Provider>
  );
}

// =====================================================
// HOOK
// =====================================================
export function useAppSettings() {
  const context = useContext(AppSettingsContext);
  if (context === undefined) {
    throw new Error('useAppSettings must be used within an AppSettingsProvider');
  }
  return context;
}

// =====================================================
// CSS VARIABLES (th√™m v√†o globals.css)
// =====================================================
/*
Th√™m v√†o globals.css:

:root {
  --bg-primary: #000000;
  --bg-secondary: #0A0A0A;
  --bg-tertiary: #1A1A1A;
  --text-primary: #ffffff;
  --text-secondary: rgba(255, 255, 255, 0.6);
  --text-muted: rgba(255, 255, 255, 0.3);
  --border-color: rgba(255, 255, 255, 0.1);
  --accent: #C69C6D;
  --accent-light: #F2D3A0;
}

.light-theme {
  --bg-primary: #ffffff;
  --bg-secondary: #f5f5f5;
  --bg-tertiary: #e5e5e5;
  --text-primary: #1a1a1a;
  --text-secondary: rgba(0, 0, 0, 0.6);
  --text-muted: rgba(0, 0, 0, 0.3);
  --border-color: rgba(0, 0, 0, 0.1);
  --accent: #C69C6D;
  --accent-light: #F2D3A0;
}
*/
</file>

<file path="ThuVien/compressImage.ts">
export const compressImage = async (
  file: File,
  quality: number = 0.8,
  maxWidth: number = 1920
): Promise<File> => {
  return new Promise((resolve, reject) => {
    // Validate input
    if (!file) {
      reject(new Error("No file provided"));
      return;
    }

    const reader = new FileReader();
    reader.readAsDataURL(file);

    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target?.result as string;

      img.onload = () => {
        try {
          const canvas = document.createElement("canvas");
          let width = img.width;
          let height = img.height;

          // Resize n·∫øu ·∫£nh qu√° l·ªõn
          if (width > maxWidth) {
            height = Math.round((height * maxWidth) / width);
            width = maxWidth;
          }

          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext("2d");
          if (!ctx) {
            reject(new Error("Canvas context error"));
            return;
          }

          // V·∫Ω ·∫£nh l√™n canvas
          ctx.drawImage(img, 0, 0, width, height);

          // Xu·∫•t blob
          canvas.toBlob(
            (blob) => {
              if (!blob) {
                reject(new Error("Compression failed: Blob is null"));
                return;
              }
              // T·∫°o file m·ªõi t·ª´ blob ƒë√£ n√©n
              const compressedFile = new File([blob], file.name, {
                type: "image/jpeg",
                lastModified: Date.now(),
              });
              resolve(compressedFile);
            },
            "image/jpeg",
            quality
          );
        } catch (e) {
          reject(e);
        }
      };

      img.onerror = (err) => reject(new Error("Image load error"));
    };

    reader.onerror = (err) => reject(new Error("File read error"));
  });
};
</file>

<file path="ThuVien/DataNormalizer.ts">
'use client';

/**
 * üîß DATA NORMALIZER - X·ª≠ l√Ω d·ªØ li·ªáu Vietnamese v·ªõi:
 * - Trim whitespace
 * - Normalize case (UPPERCASE, lowercase, Title Case)
 * - Chu·∫©n h√≥a gi√° tr·ªã ph√¢n lo·∫°i
 */

export class DataNormalizer {
  /**
   * C√°c v·ªã tr√≠ h·ª£p l·ªá trong b·∫£ng nhan_su
   */
  static VALID_VI_TRI = {
    ADMIN: 'Admin',
    QUAN_LY: 'Qu·∫£n l√Ω',
    SALES: 'Sales',
  } as const;

  /**
   * C√°c ph√¢n lo·∫°i h·ª£p l·ªá trong b·∫£ng khach_hang
   */
  static VALID_PHAN_LOAI = {
    VIP: 'VIP',
    KH_TRONG_TAM: 'KH Tr·ªçng t√¢m',
  } as const;

  /**
   * Normalize v·ªã tr√≠ (vi_tri)
   * Chuy·ªÉn ƒë·∫ßu v√†o th√†nh m·ªôt gi√° tr·ªã chu·∫©n
   * V√≠ d·ª•: "  ADMIN  " ‚Üí "Admin"
   *        "qu·∫£n l√Ω" ‚Üí "Qu·∫£n l√Ω"
   *        "sales" ‚Üí "Sales"
   */
  static normalizeViTri(value: string | null | undefined): string | null {
    if (!value) return null;

    const normalized = value.trim().toLowerCase();

    // Check Admin
    if (['admin', 'ad', 'administrator'].includes(normalized)) {
      return this.VALID_VI_TRI.ADMIN;
    }

    // Check Qu·∫£n l√Ω
    if (['qu·∫£n l√Ω', 'ql', 'quan ly', 'manager'].includes(normalized)) {
      return this.VALID_VI_TRI.QUAN_LY;
    }

    // Check Sales
    if (['sales', 'sale', 'b√°n h√†ng'].includes(normalized)) {
      return this.VALID_VI_TRI.SALES;
    }

    return null; // Gi√° tr·ªã kh√¥ng h·ª£p l·ªá
  }

  /**
   * Normalize ph√¢n lo·∫°i kh√°ch h√†ng (phan_loai)
   * V√≠ d·ª•: "  VIP  " ‚Üí "VIP"
   *        "kh tr·ªçng t√¢m" ‚Üí "KH Tr·ªçng t√¢m"
   */
  static normalizePhanLoai(value: string | null | undefined): string | null {
    if (!value) return null;

    const normalized = value.trim().toLowerCase().replace(/\s+/g, ' ');

    // Check VIP
    if (normalized === 'vip') {
      return this.VALID_PHAN_LOAI.VIP;
    }

    // Check KH Tr·ªçng t√¢m
    if (
      ['kh tr·ªçng t√¢m', 'kh trong tam', 'kh√°ch tr·ªçng t√¢m', 'khach trong tam'].includes(normalized)
    ) {
      return this.VALID_PHAN_LOAI.KH_TRONG_TAM;
    }

    return null; // Gi√° tr·ªã kh√¥ng h·ª£p l·ªá
  }

  /**
   * Trim v√† normalize text chung
   */
  static normalizeText(value: string | null | undefined): string | null {
    if (!value) return null;
    return value.trim();
  }

  /**
   * Check xem vi_tri c√≥ ph·∫£i Admin kh√¥ng
   */
  static isAdmin(viTri: string | null | undefined): boolean {
    const normalized = this.normalizeViTri(viTri);
    return normalized === this.VALID_VI_TRI.ADMIN;
  }

  /**
   * Check xem vi_tri c√≥ ph·∫£i Qu·∫£n l√Ω kh√¥ng
   */
  static isQuanLy(viTri: string | null | undefined): boolean {
    const normalized = this.normalizeViTri(viTri);
    return normalized === this.VALID_VI_TRI.QUAN_LY;
  }

  /**
   * Check xem vi_tri c√≥ ph·∫£i Sales kh√¥ng
   */
  static isSales(viTri: string | null | undefined): boolean {
    const normalized = this.normalizeViTri(viTri);
    return normalized === this.VALID_VI_TRI.SALES;
  }

  /**
   * Check xem phan_loai c√≥ ph·∫£i VIP kh√¥ng
   */
  static isVIP(phanLoai: string | null | undefined): boolean {
    const normalized = this.normalizePhanLoai(phanLoai);
    return normalized === this.VALID_PHAN_LOAI.VIP;
  }

  /**
   * Check xem phan_loai c√≥ ph·∫£i KH Tr·ªçng t√¢m kh√¥ng
   */
  static isKHTrongTam(phanLoai: string | null | undefined): boolean {
    const normalized = this.normalizePhanLoai(phanLoai);
    return normalized === this.VALID_PHAN_LOAI.KH_TRONG_TAM;
  }

  /**
   * Get t·∫•t c·∫£ valid vi_tri values
   */
  static getAllViTri(): string[] {
    return Object.values(this.VALID_VI_TRI);
  }

  /**
   * Get t·∫•t c·∫£ valid phan_loai values
   */
  static getAllPhanLoai(): string[] {
    return Object.values(this.VALID_PHAN_LOAI);
  }
}

export type ViTri = typeof DataNormalizer.VALID_VI_TRI[keyof typeof DataNormalizer.VALID_VI_TRI];
export type PhanLoai = typeof DataNormalizer.VALID_PHAN_LOAI[keyof typeof DataNormalizer.VALID_PHAN_LOAI];
</file>

<file path="ThuVien/GoogleDich.tsx">
'use client';
import React, { useEffect, useState } from 'react';
import { useAppSettings, LanguageCode } from '@/app/ThuVien/AppSettingsContext';

const LANGUAGES = [
  { code: 'vi', label: 'Ti·∫øng Vi·ªát', flag: 'https://flagcdn.com/w40/vn.png' },
  { code: 'en', label: 'English', flag: 'https://flagcdn.com/w40/us.png' },
  { code: 'zh-CN', label: 'Chinese', flag: 'https://flagcdn.com/w40/cn.png' },
  { code: 'ja', label: 'Japanese', flag: 'https://flagcdn.com/w40/jp.png' },
  { code: 'fr', label: 'French', flag: 'https://flagcdn.com/w40/fr.png' },
  { code: 'de', label: 'German', flag: 'https://flagcdn.com/w40/de.png' },
];

export default function GoogleDich() {
  // üåê ƒê·ªìng b·ªô v·ªõi AppSettingsContext
  const { language, setLanguage } = useAppSettings();
  
  // currentLang d√πng string v√¨ Google Translate h·ªó tr·ª£ nhi·ªÅu ng√¥n ng·ªØ h∆°n AppSettings
  const [currentLang, setCurrentLang] = useState<string>(language);
  const [showMenu, setShowMenu] = useState(false);
  const [isMounted, setIsMounted] = useState(false);

  // ƒê·ªìng b·ªô khi language t·ª´ context thay ƒë·ªïi
  useEffect(() => {
    setCurrentLang(language);
  }, [language]);

  useEffect(() => {
    setIsMounted(true);
    if (typeof document !== 'undefined') {
        const cookies = document.cookie.split(';');
        const googCookie = cookies.find(c => c.trim().startsWith('googtrans='));
        if (googCookie) {
            const langCode = googCookie.split('/').pop();
            if (langCode) setCurrentLang(langCode);
        }
    }

    if (!document.getElementById('google-translate-script')) {
        const addScript = document.createElement('script');
        addScript.id = 'google-translate-script';
        addScript.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
        document.body.appendChild(addScript);

        // @ts-ignore
        window.googleTranslateElementInit = () => {
             // @ts-ignore
             if (window.google && window.google.translate) {
                // @ts-ignore
                new window.google.translate.TranslateElement({
                    pageLanguage: 'vi',
                    autoDisplay: false, 
                    layout: 0 
                }, 'google_translate_element');
             }
        };
    }
  }, []);

  const changeLanguage = (langCode: string) => {
    document.cookie = `googtrans=/auto/${langCode}; path=/; domain=${window.location.hostname}`;
    document.cookie = `googtrans=/auto/${langCode}; path=/;`;
    setCurrentLang(langCode);
    setShowMenu(false);
    
    // üåê ƒê·ªìng b·ªô v·ªõi AppSettingsContext (ch·ªâ vi/en)
    if (langCode === 'vi' || langCode === 'en') {
      setLanguage(langCode as LanguageCode);
    }
    
    window.location.reload(); 
  };

  if (!isMounted) return null;

  const currentFlag = LANGUAGES.find(l => l.code === currentLang)?.flag || LANGUAGES[0].flag;

  return (
    <div className="absolute top-6 right-6 z-50">
      <div id="google_translate_element" className="hidden" />

      <div className="relative">
        <button 
          onClick={() => setShowMenu(!showMenu)}
          className="w-10 h-10 rounded-full overflow-hidden border-2 border-white/20 hover:border-white transition-all shadow-lg active:scale-95 bg-black/50"
        >
          <img src={currentFlag} alt="Flag" className="w-full h-full object-cover" />
        </button>

        {showMenu && (
          <div className="absolute right-0 top-12 bg-black/90 backdrop-blur-md border border-white/10 rounded-xl overflow-hidden shadow-2xl w-40 z-[60]">
            {LANGUAGES.map((lang) => (
              <button
                key={lang.code}
                onClick={() => changeLanguage(lang.code)}
                className={`flex items-center gap-3 w-full px-4 py-3 hover:bg-white/10 transition-colors text-left ${currentLang === lang.code ? 'bg-white/5' : ''}`}
              >
                <img src={lang.flag} alt={lang.code} className="w-6 h-4 object-cover rounded-sm" />
                <span className={`text-xs font-bold ${currentLang === lang.code ? 'text-yellow-500' : 'text-gray-300'}`}>
                  {lang.label}
                </span>
              </button>
            ))}
          </div>
        )}
      </div>
      
      {/* üü¢ CSS QUAN TR·ªåNG: ·∫®n thanh Google tri·ªát ƒë·ªÉ */}
      <style jsx global>{`
        .goog-te-banner-frame { display: none !important; }
        .skiptranslate { display: none !important; } 
        body { top: 0px !important; }
        #goog-gt-tt { display: none !important; visibility: hidden !important; }
        .goog-tooltip { display: none !important; }
        .goog-text-highlight { background-color: transparent !important; box-shadow: none !important; }
      `}</style>
    </div>
  );
}
</file>

<file path="ThuVien/InputValidator.ts">
// ‚úÖ INPUT VALIDATION & SANITIZATION SERVICE
// Prevents XSS attacks and invalid data entry

/**
 * Sanitize HTML to prevent XSS attacks
 * Removes dangerous tags and attributes
 */
export function sanitizeHtml(html: string): string {
  if (!html || typeof html !== 'string') return '';
  
  // Create a temporary DOM element to safely parse HTML
  const temp = document.createElement('div');
  temp.textContent = html; // textContent prevents HTML parsing
  return temp.innerHTML;
}

/**
 * Sanitize chat message input
 * - Removes excessive whitespace
 * - Prevents XSS via HTML tags
 * - Max length 2000 chars
 */
export function sanitizeChatMessage(message: string): string {
  if (!message || typeof message !== 'string') return '';
  
  // Remove script tags and dangerous HTML
  let sanitized = message
    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
    .replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '')
    .replace(/on\w+\s*=\s*["'][^"']*["']/gi, '') // Remove event handlers
    .trim();
  
  // Limit length
  if (sanitized.length > 2000) {
    sanitized = sanitized.substring(0, 2000);
  }
  
  return sanitized;
}

/**
 * Validate email format
 */
export function validateEmail(email: string): boolean {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

/**
 * Validate phone format (Vietnamese)
 * Accepts: 09xx, 08xx, 07xx, 03xx format
 */
export function validatePhone(phone: string): boolean {
  const phoneRegex = /^(09|08|07|03|01)\d{8}$/;
  return phoneRegex.test(phone.replace(/\s+/g, ''));
}

/**
 * Validate Vietnamese name
 * - No special characters or numbers
 * - Min 2 chars, max 100
 */
export function validateVietnameseName(name: string): boolean {
  if (!name || typeof name !== 'string') return false;
  
  const trimmed = name.trim();
  if (trimmed.length < 2 || trimmed.length > 100) return false;
  
  // Allow Vietnamese characters, spaces, hyphens, apostrophes
  const nameRegex = /^[a-zA-Z√Ä-·ªø\s'-]+$/;
  return nameRegex.test(trimmed);
}

/**
 * Sanitize search query
 * - Max 100 chars
 * - Remove special SQL characters
 */
export function sanitizeSearchQuery(query: string): string {
  if (!query || typeof query !== 'string') return '';
  
  let sanitized = query
    .trim()
    .substring(0, 100)
    .replace(/[;'"%\\]/g, ''); // Remove SQL injection chars
  
  return sanitized;
}

/**
 * Validate and parse JSON safely
 */
export function safeParseJson<T>(json: string, fallback: T): T {
  try {
    return JSON.parse(json) as T;
  } catch {
    return fallback;
  }
}

/**
 * Validate URL format
 */
export function validateUrl(url: string): boolean {
  try {
    new URL(url);
    return true;
  } catch {
    return false;
  }
}

/**
 * Truncate text with ellipsis
 */
export function truncateText(text: string, maxLength: number = 100): string {
  if (!text || typeof text !== 'string') return '';
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + '...';
}

/**
 * Validate password strength
 * - Min 8 chars
 * - At least 1 uppercase, 1 lowercase, 1 number, 1 special char
 */
export function validatePasswordStrength(password: string): {
  isValid: boolean;
  strength: 'weak' | 'fair' | 'good' | 'strong';
  feedback: string[];
} {
  const feedback: string[] = [];
  let score = 0;

  if (!password || password.length < 8) {
    feedback.push('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±');
  } else {
    score++;
  }

  if (!/[A-Z]/.test(password)) {
    feedback.push('Ph·∫£i c√≥ √≠t nh·∫•t 1 ch·ªØ c√°i vi·∫øt hoa');
  } else {
    score++;
  }

  if (!/[a-z]/.test(password)) {
    feedback.push('Ph·∫£i c√≥ √≠t nh·∫•t 1 ch·ªØ c√°i vi·∫øt th∆∞·ªùng');
  } else {
    score++;
  }

  if (!/[0-9]/.test(password)) {
    feedback.push('Ph·∫£i c√≥ √≠t nh·∫•t 1 s·ªë');
  } else {
    score++;
  }

  if (!/[!@#$%^&*]/.test(password)) {
    feedback.push('Ph·∫£i c√≥ √≠t nh·∫•t 1 k√Ω t·ª± ƒë·∫∑c bi·ªát (!@#$%^&*)');
  } else {
    score++;
  }

  let strength: 'weak' | 'fair' | 'good' | 'strong' = 'weak';
  if (score >= 5) strength = 'strong';
  else if (score >= 4) strength = 'good';
  else if (score >= 3) strength = 'fair';

  return {
    isValid: score >= 4,
    strength,
    feedback,
  };
}
</file>

<file path="ThuVien/ketNoiSupabase.ts">
import { createBrowserClient } from '@supabase/ssr'

// 1. L·∫•y bi·∫øn m√¥i tr∆∞·ªùng
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY

// 2. Ki·ªÉm tra bi·∫øn m√¥i tr∆∞·ªùng
if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error(
    'L·ªói nghi√™m tr·ªçng: Kh√¥ng t√¨m th·∫•y bi·∫øn m√¥i tr∆∞·ªùng Supabase! H√£y ki·ªÉm tra file .env.local.'
  )
}

// 3. Kh·ªüi t·∫°o Client cho Tr√¨nh duy·ªát (Browser Client)
// D√πng createBrowserClient c·ªßa @supabase/ssr ƒë·ªÉ t·ª± ƒë·ªông x·ª≠ l√Ω Cookies
export const supabase = createBrowserClient(supabaseUrl, supabaseAnonKey)
</file>

<file path="ThuVien/KieuDuLieu.ts">
// ThuVien/KieuDuLieu.ts

export type LoaiNoiDung = 'image' | 'text' | 'task';

export type DuLieuKhoi = {
  id: string;
  tieuDe: string;
  loai: LoaiNoiDung;
  noiDung: string;
  doRongCot: 1 | 2 | 3 | 4; // ColSpan
};

export type DuLieuHang = {
  id: string;
  chieuCao: number;
  danhSachKhoi: DuLieuKhoi[];
};
</file>

<file path="ThuVien/LoggerService.ts">
// ‚úÖ CENTRALIZED ERROR LOGGING SERVICE
// Provides unified error tracking and logging

type LogLevel = 'debug' | 'info' | 'warn' | 'error';

interface LogEntry {
  timestamp: string;
  level: LogLevel;
  context: string;
  message: string;
  data?: unknown;
  error?: {
    message: string;
    stack?: string;
    code?: string;
  };
}

export class LoggerService {
  private static isDevelopment = process.env.NODE_ENV === 'development';

  /**
   * Log at debug level
   */
  static debug(context: string, message: string, data?: unknown) {
    if (this.isDevelopment) {
      console.debug(`[${context}] ${message}`, data);
    }
    this.captureLog('debug', context, message, data);
  }

  /**
   * Log at info level
   */
  static info(context: string, message: string, data?: unknown) {
    console.info(`[${context}] ${message}`, data);
    this.captureLog('info', context, message, data);
  }

  /**
   * Log at warn level
   */
  static warn(context: string, message: string, data?: unknown) {
    console.warn(`[${context}] ${message}`, data);
    this.captureLog('warn', context, message, data);
  }

  /**
   * Log at error level - recommended for use with try/catch
   */
  static error(context: string, message: string, error?: Error | unknown) {
    const errorObj = error instanceof Error ? error : new Error(String(error));
    
    console.error(`[${context}] ${message}`, errorObj);
    
    this.captureLog('error', context, message, undefined, {
      message: errorObj.message,
      stack: errorObj.stack,
      code: (error as any)?.code,
    });
  }

  /**
   * Capture log entry for analytics/monitoring
   * In production, send to external service (Sentry, LogRocket, etc)
   */
  private static captureLog(
    level: LogLevel,
    context: string,
    message: string,
    data?: unknown,
    error?: LogEntry['error']
  ) {
    const entry: LogEntry = {
      timestamp: new Date().toISOString(),
      level,
      context,
      message,
    };

    if (data !== undefined) {
      entry.data = data;
    }

    if (error) {
      entry.error = error;
    }

    // TODO: In production, send to error tracking service
    // Sentry.captureMessage(message, level);
    // or custom API endpoint
  }

  /**
   * Create a scoped logger for a specific component/service
   */
  static createScoped(context: string) {
    return {
      debug: (msg: string, data?: unknown) => this.debug(context, msg, data),
      info: (msg: string, data?: unknown) => this.info(context, msg, data),
      warn: (msg: string, data?: unknown) => this.warn(context, msg, data),
      error: (msg: string, error?: Error | unknown) => this.error(context, msg, error),
    };
  }
}
</file>

<file path="ThuVien/OrderService.ts">
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { LoggerService } from "@/app/ThuVien/LoggerService";

// Interface kh·ªõp v·ªõi DB b·∫£ng don_hang
export interface Order {
  id: string;
  ma_don: string;
  ten_khach: string | null;
  sdt: string | null;
  dia_chi: string | null;
  ghi_chu: string | null;
  trang_thai: string;
  tong_tien: number;
  nguoi_tao_id: string; // ƒê√£ s·ª≠a t·ª´ nguoi_tao -> nguoi_tao_id cho kh·ªõp DB
  tao_luc: string;
  cap_nhat_luc: string;
}

// Interface kh·ªõp v·ªõi DB b·∫£ng don_hang_chi_tiet
export interface OrderItem {
  id: string;
  don_hang_id: string;
  vat_tu_id: string | null;
  ten_item_hien_thi: string | null; // S·ª≠a t·ª´ ten_san_pham -> ten_item_hien_thi
  so_luong: number;
  don_gia: number;
  thanh_tien?: number; // C√≥ th·ªÉ t√≠nh to√°n ·ªü frontend
}

// Interface d·ªØ li·ªáu ƒë·∫ßu v√†o khi t·∫°o ƒë∆°n (t·ª´ Form)
export interface CreateOrderData {
  ten_khach?: string;
  sdt?: string;
  dia_chi?: string;
  ghi_chu?: string;
  items: Array<{
    id?: string; // Th√™m id (vat_tu_id) ƒë·ªÉ tr·ª´ kho n·∫øu c·∫ßn
    ten_san_pham: string;
    so_luong: number;
    don_gia: number;
  }>;
}

export class OrderService {
  /**
   * T·∫°o ƒë∆°n h√†ng m·ªõi (auto set nguoi_tao_id = auth.uid())
   */
  static async createOrder(data: CreateOrderData): Promise<string | null> {
    try {
      // 1. T√≠nh t·ªïng ti·ªÅn
      const tongTien = data.items.reduce(
        (sum, item) => sum + item.so_luong * item.don_gia,
        0
      );

      // 2. L·∫•y User ID hi·ªán t·∫°i
      const {
        data: { user },
      } = await supabase.auth.getUser();

      // 3. Insert ƒë∆°n h√†ng (Header)
      const { data: orderData, error: orderError } = await supabase
        .from("don_hang")
        .insert({
          ten_khach: data.ten_khach,
          sdt: data.sdt,
          dia_chi: data.dia_chi,
          ghi_chu: data.ghi_chu,
          tong_tien: tongTien,
          trang_thai: "moi",
          nguoi_tao_id: user?.id, // D√πng nguoi_tao_id cho chu·∫©n
          // kenh_ban_hang: 'web' // C√≥ th·ªÉ th√™m n·∫øu c·∫ßn
        })
        .select("id")
        .single();

      if (orderError) {
        LoggerService.error("OrderService", "Error creating order", orderError);
        return null;
      }

      // 4. Insert chi ti·∫øt ƒë∆°n h√†ng (Items)
      if (data.items.length > 0) {
        const itemsToInsert = data.items.map((item) => ({
          don_hang_id: orderData.id,
          vat_tu_id: item.id || null, // Map ID v·∫≠t t∆∞ n·∫øu c√≥
          ten_item_hien_thi: item.ten_san_pham, // Map sang c·ªôt ƒë√∫ng trong DB
          so_luong: item.so_luong,
          don_gia: item.don_gia,
        }));

        const { error: itemsError } = await supabase
          .from("don_hang_chi_tiet") // ‚úÖ ƒê√£ s·ª≠a t√™n b·∫£ng ƒë√∫ng
          .insert(itemsToInsert);

        if (itemsError) {
          console.error("Error creating order items:", itemsError);
          // L∆∞u √Ω: N·∫øu insert items l·ªói, c√≥ th·ªÉ c·∫ßn x√≥a ƒë∆°n h√†ng header (rollback th·ªß c√¥ng)
        }
      }

      return orderData.id;
    } catch (error) {
      console.error("OrderService.createOrder error:", error);
      return null;
    }
  }

  /**
   * L·∫•y danh s√°ch ƒë∆°n h√†ng c·ªßa user hi·ªán t·∫°i
   */
  static async getMyOrders(
    limit = 50
  ): Promise<{ orders: Order[]; error: string | null }> {
    try {
      const {
        data: { user },
      } = await supabase.auth.getUser();

      if (!user) return { orders: [], error: "User not logged in" };

      // L·∫•y ƒë∆°n h√†ng do user t·∫°o HO·∫∂C user l√† kh√°ch h√†ng (d·ª±a tr√™n id)
      // ·ªû ƒë√¢y ta t·∫°m l·∫•y theo nguoi_tao_id ƒë·ªÉ ƒë∆°n gi·∫£n
      const { data, error } = await supabase
        .from("don_hang")
        .select("*")
        .eq("nguoi_tao_id", user.id)
        .order("tao_luc", { ascending: false })
        .limit(limit);

      if (error) {
        console.error("Error fetching orders:", error.message);
        return { orders: [], error: error.message };
      }

      return { orders: (data ?? []) as Order[], error: null };
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : "Unknown error";
      console.error("OrderService.getMyOrders error:", errorMsg);
      return { orders: [], error: errorMsg };
    }
  }

  /**
   * L·∫•y chi ti·∫øt ƒë∆°n h√†ng (bao g·ªìm items)
   */
  static async getOrderById(
    orderId: string
  ): Promise<{ order: Order; items: OrderItem[] } | null> {
    try {
      // L·∫•y Header
      const { data: orderData, error: orderError } = await supabase
        .from("don_hang")
        .select("*")
        .eq("id", orderId)
        .single();

      if (orderError) {
        console.error("Error fetching order:", orderError);
        return null;
      }

      // L·∫•y Items
      const { data: itemsData, error: itemsError } = await supabase
        .from("don_hang_chi_tiet") // ‚úÖ ƒê√£ s·ª≠a t√™n b·∫£ng ƒë√∫ng
        .select("*")
        .eq("don_hang_id", orderId);

      if (itemsError) {
        console.error("Error fetching order items:", itemsError);
        // V·∫´n tr·∫£ v·ªÅ order nh∆∞ng kh√¥ng c√≥ items
        return { order: orderData as Order, items: [] };
      }

      return {
        order: orderData as Order,
        items: itemsData as OrderItem[],
      };
    } catch (error) {
      console.error("OrderService.getOrderById error:", error);
      return null;
    }
  }

  /**
   * C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng
   */
  static async updateOrderStatus(
    orderId: string,
    trangThai: string
  ): Promise<boolean> {
    try {
      const { error } = await supabase
        .from("don_hang")
        .update({ trang_thai: trangThai })
        .eq("id", orderId);

      if (error) {
        console.error("Error updating order status:", error);
        return false;
      }

      return true;
    } catch (error) {
      console.error("OrderService.updateOrderStatus error:", error);
      return false;
    }
  }

  /**
   * L·∫•y ƒë∆°n h√†ng g·∫ßn nh·∫•t
   */
  static async getLatestOrder(): Promise<{
    order: Order | null;
    error: string | null;
  }> {
    try {
      const { data, error } = await supabase
        .from("don_hang")
        .select("*")
        .order("tao_luc", { ascending: false })
        .limit(1)
        .single();

      if (error) {
        // C√≥ th·ªÉ kh√¥ng c√≥ ƒë∆°n h√†ng n√†o
        if (error.code === "PGRST116") return { order: null, error: null };

        console.error("Error fetching latest order:", error);
        return { order: null, error: error.message };
      }

      return { order: data as Order, error: null };
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : "Unknown error";
      console.error("OrderService.getLatestOrder error:", errorMsg);
      return { order: null, error: errorMsg };
    }
  }

  /**
   * Format tr·∫°ng th√°i ƒë∆°n h√†ng th√†nh ti·∫øng Vi·ªát
   */
  static formatStatus(status: string): string {
    const statusMap: Record<string, string> = {
      moi: "üÜï M·ªõi",
      dang_xu_ly: "‚è≥ ƒêang x·ª≠ l√Ω",
      dang_giao: "üöö ƒêang giao",
      hoan_thanh: "‚úÖ Ho√†n th√†nh",
      huy: "‚ùå ƒê√£ h·ªßy",
      dang_san_xuat: "üî® ƒêang s·∫£n xu·∫•t",
    };
    return statusMap[status] || status;
  }

  /**
   * Format s·ªë ti·ªÅn VND
   */
  static formatMoney(amount: number): string {
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
    }).format(amount);
  }
}
</file>

<file path="ThuVien/QueryTimeout.ts">
// ‚úÖ SUPABASE QUERY TIMEOUT WRAPPER
// Prevents hanging queries by adding timeout

export class QueryTimeoutError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'QueryTimeoutError';
  }
}

/**
 * Wrap a promise with a timeout
 * @param promise - The promise to wrap
 * @param timeoutMs - Timeout in milliseconds (default: 10000ms = 10s)
 * @param errorMessage - Custom error message
 */
export async function withTimeout<T>(
  promise: Promise<T>,
  timeoutMs: number = 10000,
  errorMessage: string = 'Truy v·∫•n qu√° l√¢u, vui l√≤ng th·ª≠ l·∫°i'
): Promise<T> {
  let timeoutId: NodeJS.Timeout;

  const timeoutPromise = new Promise<never>((_, reject) => {
    timeoutId = setTimeout(() => {
      reject(new QueryTimeoutError(errorMessage));
    }, timeoutMs);
  });

  try {
    const result = await Promise.race([promise, timeoutPromise]);
    clearTimeout(timeoutId!);
    return result;
  } catch (error) {
    clearTimeout(timeoutId!);
    throw error;
  }
}

/**
 * Wrap Supabase query with timeout
 * Usage:
 * ```ts
 * const { data, error } = await withQueryTimeout(
 *   supabase.from('don_hang').select('*'),
 *   8000, // 8 second timeout
 *   'Kh√¥ng th·ªÉ t·∫£i ƒë∆°n h√†ng'
 * );
 * ```
 */
export async function withQueryTimeout<T>(
  queryPromise: Promise<{ data: T | null; error: any }>,
  timeoutMs: number = 10000,
  errorMessage: string = 'Truy v·∫•n qu√° l√¢u'
): Promise<{ data: T | null; error: any }> {
  try {
    return await withTimeout(queryPromise, timeoutMs, errorMessage);
  } catch (error) {
    if (error instanceof QueryTimeoutError) {
      return {
        data: null,
        error: { message: error.message, code: 'QUERY_TIMEOUT' },
      };
    }
    throw error;
  }
}
</file>

<file path="ThuVien/UserContext.tsx">
"use client";

import React, {
  createContext,
  useContext,
  useEffect,
  useState,
  ReactNode,
} from "react";
import { AuthService, type UserInfo } from "@/app/CongDangNhap/AuthService";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { LoggerService } from "@/app/ThuVien/LoggerService";

interface UserContextType {
  user: UserInfo | null;
  loading: boolean;
  error: string | null;
  refreshUser: () => Promise<void>;
  signOut: () => Promise<void>;
}

const UserContext = createContext<UserContextType | undefined>(undefined);

/**
 * UserProvider - Wrap app ƒë·ªÉ share user info
 * D√πng: <UserProvider><App /></UserProvider>
 */
export function UserProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<UserInfo | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    // ‚úÖ SESSION PERSISTENCE - Check Supabase session first
    const initSession = async () => {
      // üõ°Ô∏è CH·∫∂N NGAY N·∫æU V·ª™A LOGOUT (Tr√°nh load l·∫°i user c≈© t·ª´ cache)
      if (typeof window !== "undefined") {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get("logout")) {
          console.log(
            "üõë [UserContext] Ph√°t hi·ªán v·ª´a ƒëƒÉng xu·∫•t. B·ªè qua init session."
          );
          setLoading(false);
          return;
        }
      }

      try {
        setLoading(true);

        // Check if user has active Supabase session
        const {
          data: { session },
        } = await supabase.auth.getSession();

        if (session?.user) {
          // Has active session - load user data
          const currentUser = await AuthService.getCurrentUser();
          setUser(currentUser);

          // Save to localStorage as backup
          if (currentUser) {
            localStorage.setItem("USER_INFO", JSON.stringify(currentUser));
          }
        } else {
          // No active session - check localStorage as fallback
          const savedUser = localStorage.getItem("USER_INFO");
          if (savedUser) {
            try {
              setUser(JSON.parse(savedUser));
            } catch (e) {
              LoggerService.error("UserContext", "Error parsing saved user", e);
              localStorage.removeItem("USER_INFO");
            }
          }
        }
      } catch (err) {
        LoggerService.error("UserContext", "Error loading user", err);
        setError(err instanceof Error ? err.message : "Unknown error");
      } finally {
        setLoading(false);
      }
    };

    initSession();

    // ‚úÖ Listen for auth state changes (login/logout)
    const { data: authListener } = supabase.auth.onAuthStateChange(
      async (event, session) => {
        if (event === "SIGNED_IN" && session) {
          const currentUser = await AuthService.getCurrentUser();
          setUser(currentUser);
          if (currentUser) {
            localStorage.setItem("USER_INFO", JSON.stringify(currentUser));
          }
        } else if (event === "SIGNED_OUT") {
          setUser(null);
          localStorage.removeItem("USER_INFO");
        }
      }
    );

    return () => {
      authListener.subscription.unsubscribe();
    };
  }, []);

  const loadUser = async () => {
    try {
      setLoading(true);
      setError(null);
      const currentUser = await AuthService.getCurrentUser();
      setUser(currentUser);
    } catch (err: any) {
      console.error("Error loading user:", err);
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const refreshUser = async () => {
    await loadUser();
  };

  // üü¢ LOGIC ƒêƒÇNG XU·∫§T "H·ª¶Y DI·ªÜT" + "ƒêUA T·ªêC ƒê·ªò" (FIX ZOMBIE SESSION & TREO)
  const signOut = async () => {
    try {
      setLoading(true);

      // 1. CHI·∫æN THU·∫¨T: ƒêUA T·ªêC ƒê·ªò (RACE)
      // T·∫°o m·ªôt c√°i ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c 3 gi√¢y
      const timeoutPromise = new Promise((resolve) =>
        setTimeout(resolve, 3000)
      );

      // G·ªçi l·ªánh ƒëƒÉng xu·∫•t c·ªßa Supabase
      const supabaseLogoutPromise = AuthService.signOut();

      // Cho 2 th·∫±ng ƒëua nhau: N·∫øu Supabase xong tr∆∞·ªõc -> T·ªët.
      // N·∫øu 3 gi√¢y tr√¥i qua m√† Supabase ch∆∞a xong -> K·ªá n√≥, ch·∫°y ti·∫øp l·ªánh b√™n d∆∞·ªõi.
      await Promise.race([supabaseLogoutPromise, timeoutPromise]);

      // --- ƒêO·∫†N D∆Ø·ªöI N√ÄY S·∫º LU√îN CH·∫†Y SAU T·ªêI ƒêA 3 GI√ÇY ---

      // 2. Reset State React ngay l·∫≠p t·ª©c
      setUser(null);
      setError(null);

      // 3. X√≥a s·∫°ch Storage th·ªß c√¥ng
      if (typeof window !== "undefined") {
        localStorage.clear();
        sessionStorage.clear();
        // X√≥a cookie visitor
        document.cookie = "VISITOR_MODE=; Path=/; Max-Age=0; SameSite=Lax";

        // X√≥a token Supabase th·ªß c√¥ng
        Object.keys(localStorage).forEach((key) => {
          if (key.startsWith("sb-") || key.includes("supabase")) {
            localStorage.removeItem(key);
          }
        });
      }

      // 4. Redirect c·ª©ng v·ªõi c·ªù hi·ªáu logout
      window.location.href = `/?logout=success&t=${Date.now()}`;
    } catch (err) {
      console.error("Logout error (Force quit):", err);
      // V·∫´n force logout d√π l·ªói
      if (typeof window !== "undefined") localStorage.clear();
      window.location.href = `/?logout=force&t=${Date.now()}`;
    } finally {
      setLoading(false);
    }
  };

  return (
    <UserContext.Provider
      value={{ user, loading, error, refreshUser, signOut }}
    >
      {children}
    </UserContext.Provider>
  );
}

/**
 * Hook ƒë·ªÉ d√πng user info
 * const { user, loading } = useUser();
 */
export function useUser() {
  const context = useContext(UserContext);
  if (context === undefined) {
    throw new Error("useUser must be used within UserProvider");
  }
  return context;
}
</file>

<file path="ThuVien/withTimeout.ts">
// ‚úÖ TIMEOUT WRAPPER for async operations
// Prevents hanging queries and provides fallback

/**
 * Wraps a promise with timeout functionality
 * @param promise The promise to wrap
 * @param ms Timeout in milliseconds (default: 10000ms = 10s)
 * @param timeoutError Custom error message on timeout
 */
export async function withTimeout<T>(
  promise: Promise<T>,
  ms: number = 10000,
  timeoutError: string = 'Operation timed out'
): Promise<T> {
  let timeoutId: NodeJS.Timeout;

  const timeoutPromise = new Promise<never>((_, reject) => {
    timeoutId = setTimeout(() => {
      reject(new Error(timeoutError));
    }, ms);
  });

  try {
    const result = await Promise.race([promise, timeoutPromise]);
    clearTimeout(timeoutId!);
    return result;
  } catch (error) {
    clearTimeout(timeoutId!);
    throw error;
  }
}

/**
 * Create a debounced function that delays invoking until after `ms` milliseconds
 * Useful for search inputs, button clicks, etc.
 */
export function debounce<T extends (...args: any[]) => any>(
  func: T,
  ms: number = 300
): (...args: Parameters<T>) => void {
  let timeoutId: NodeJS.Timeout;

  return function (...args: Parameters<T>) {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
      func(...args);
    }, ms);
  };
}

/**
 * Create a throttled function that only invokes at most once per `ms` milliseconds
 * Useful for scroll handlers, resize handlers
 */
export function throttle<T extends (...args: any[]) => any>(
  func: T,
  ms: number = 300
): (...args: Parameters<T>) => void {
  let lastRun = 0;

  return function (...args: Parameters<T>) {
    const now = Date.now();
    if (now - lastRun >= ms) {
      func(...args);
      lastRun = now;
    }
  };
}
</file>

<file path="trangchu/BackgroundManager.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { Image as ImageIcon, Upload, RefreshCw, Smartphone, Monitor, Tablet, Loader2 } from 'lucide-react';
import { supabase } from '@/app/ThuVien/ketNoiSupabase';
import { compressImage } from '@/app/ThuVien/compressImage';

interface Props {
  onUpdate: () => void;
}

export default function BackgroundManager({ onUpdate }: Props) {
  const [isAdmin, setIsAdmin] = useState(false);
  const [isOpen, setIsOpen] = useState(false);
  const [deviceType, setDeviceType] = useState<'desktop' | 'mobile' | 'tablet'>('desktop');
  const [file, setFile] = useState<File | null>(null);
  
  // Tr·∫°ng th√°i x·ª≠ l√Ω: 'idle' | 'compressing' | 'uploading' | 'waiting' | 'done'
  const [status, setStatus] = useState<string>('idle'); 

  useEffect(() => {
    const role = typeof window !== 'undefined' ? localStorage.getItem('USER_ROLE') : '';
    if (role === 'admin' || role === 'quan_ly') setIsAdmin(true);
  }, []);

  if (!isAdmin) return null;

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      setFile(e.target.files[0]);
    }
  };

  const handleUpload = async () => {
    if (!file) return alert("Vui l√≤ng ch·ªçn ·∫£nh!");
    
    try {
      setStatus('compressing');

      // 1. X√°c ƒë·ªãnh t√™n file chu·∫©n (Hardcode)
      let targetFileName = '';
      let maxWidth = 1920;

      if (deviceType === 'desktop') {
        targetFileName = 'trangchu-desktop.jpg';
        maxWidth = 1920;
      } else if (deviceType === 'tablet') {
        targetFileName = 'trangchu-tablet.jpg';
        maxWidth = 1024;
      } else {
        targetFileName = 'trangchu-mobile.jpg';
        maxWidth = 800;
      }

      // 2. N√©n ·∫£nh
      const compressedBlob = await compressImage(file, 0.8, maxWidth);

      // 3. T√°i t·∫°o file v·ªõi t√™n chu·∫©n (ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªïi t√™n ƒë√∫ng)
      const finalFile = new File([compressedBlob], targetFileName, {
        type: 'image/jpeg',
        lastModified: Date.now(),
      });

      setStatus('uploading');

      // 4. Upload l√™n Supabase (Ghi ƒë√® - Upsert)
      const { data, error } = await supabase.storage
        .from('hinh-nen')
        .upload(targetFileName, finalFile, {
          cacheControl: '0', // Y√™u c·∫ßu kh√¥ng cache
          upsert: true       // B·∫Øt bu·ªôc ghi ƒë√®
        });

      if (error) throw error;

      // 5. QUAN TR·ªåNG: Ch·ªù server ƒë·ªìng b·ªô (Propagation Delay)
      setStatus('waiting');
      
      // ƒê·ª£i 2.5 gi√¢y ƒë·ªÉ CDN Supabase k·ªãp c·∫≠p nh·∫≠t file m·ªõi
      setTimeout(() => {
          setStatus('done');
          alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
          setIsOpen(false);
          setFile(null);
          setStatus('idle');
          
          // L√∫c n√†y m·ªõi b√°o cho trang ch·ªß load l·∫°i ·∫£nh
          onUpdate(); 
      }, 2500);

    } catch (err: any) {
      console.error(err);
      alert("L·ªói upload: " + err.message);
      setStatus('idle');
    }
  };

  // Helper ƒë·ªÉ hi·ªÉn th·ªã text tr·∫°ng th√°i
  const getStatusText = () => {
      switch(status) {
          case 'compressing': return 'ƒêang n√©n ·∫£nh...';
          case 'uploading': return 'ƒêang t·∫£i l√™n...';
          case 'waiting': return 'ƒêang ƒë·ªìng b·ªô...';
          case 'done': return 'Ho√†n t·∫•t!';
          default: return 'L∆∞u Thay ƒê·ªïi';
      }
  };

  return (
   <div className="fixed bottom-32 right-6 z-[200] flex flex-col items-end gap-2">
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className="w-10 h-10 rounded-full bg-white/10 backdrop-blur-md border border-white/20 text-[#C69C6D] flex items-center justify-center hover:bg-[#C69C6D] hover:text-black transition-all shadow-lg"
        title="ƒê·ªïi h√¨nh n·ªÅn (Admin)"
      >
        <ImageIcon size={20} />
      </button>

      {isOpen && (
        <div className="bg-black/90 border border-[#C69C6D] p-4 rounded-lg shadow-2xl w-64 animate-fade-in-up flex flex-col gap-3">
          <h4 className="text-[#C69C6D] text-xs font-bold uppercase border-b border-white/10 pb-2 mb-1">
            C·∫≠p nh·∫≠t h√¨nh n·ªÅn
          </h4>

          <div className="flex gap-1 bg-white/10 p-1 rounded">
            <button onClick={() => setDeviceType('desktop')} className={`flex-1 p-1.5 rounded flex justify-center transition-all active:scale-95 ${deviceType === 'desktop' ? 'bg-[#C69C6D] text-black' : 'text-white hover:bg-white/10'}`} title="Desktop">
                <Monitor size={14} />
            </button>
            <button onClick={() => setDeviceType('tablet')} className={`flex-1 p-1.5 rounded flex justify-center transition-all active:scale-95 ${deviceType === 'tablet' ? 'bg-[#C69C6D] text-black' : 'text-white hover:bg-white/10'}`} title="Tablet">
                <Tablet size={14} />
            </button>
            <button onClick={() => setDeviceType('mobile')} className={`flex-1 p-1.5 rounded flex justify-center transition-all active:scale-95 ${deviceType === 'mobile' ? 'bg-[#C69C6D] text-black' : 'text-white hover:bg-white/10'}`} title="Mobile">
                <Smartphone size={14} />
            </button>
          </div>

          <input type="file" accept="image/*" onChange={handleFileChange} className="text-[10px] text-white file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:bg-[#C69C6D] file:text-black hover:file:bg-white cursor-pointer" />

          <button 
            onClick={handleUpload} 
            disabled={status !== 'idle'}
            className="bg-[#C69C6D] text-black text-xs font-bold py-2 rounded flex items-center justify-center gap-2 hover:bg-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed active:scale-95"
          >
            {status !== 'idle' ? <Loader2 size={14} className="animate-spin"/> : <Upload size={14} />}
            {getStatusText()}
          </button>
          
          <div className="text-[9px] text-gray-400 italic text-center">
            *H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông n√©n & ƒë·ªïi t√™n file chu·∫©n.
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="trangchu/NutDatHang.tsx">
'use client';

import React from 'react';
import { useRouter } from 'next/navigation';
import { ShoppingBag, ArrowRight } from 'lucide-react';

export default function NutDatHang() {
  const router = useRouter();

  return (
    <button 
      onClick={() => router.push('/dathang')}
      className="group relative px-8 py-3 bg-[#C69C6D] hover:bg-[#B58B5D] text-black font-bold text-sm md:text-base uppercase tracking-widest rounded-full shadow-[0_0_20px_rgba(198,156,109,0.3)] hover:shadow-[0_0_30px_rgba(198,156,109,0.5)] transition-all duration-300 flex items-center gap-3 overflow-hidden transform hover:-translate-y-1 active:scale-95"
    >
      {/* Hi·ªáu ·ª©ng qu√©t s√°ng (Shimmer effect) */}
      <div className="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/30 to-transparent -translate-x-[150%] group-hover:translate-x-[150%] transition-transform duration-700 ease-in-out" />
      
      <ShoppingBag size={18} className="shrink-0" />
      <span className="relative z-10">Kh√°m Ph√° T√°c Ph·∫©m</span>
      <ArrowRight size={18} className="shrink-0 group-hover:translate-x-1 transition-transform" />
    </button>
  );
}
</file>

<file path="trangchu/page.tsx">
"use client";

import React, { useState, useEffect, useCallback, Suspense } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { PlayCircle, Star, ArrowRight, UserPlus, LogIn } from "lucide-react";

// Import c√°c component h·ªá th·ªëng
import MenuTren from "@/app/GiaoDienTong/MenuTren/MenuTren";

// Import component con
import Slider1 from "./slider1";
import Slider2 from "./slider2";
import NutDatHang from "./NutDatHang";
import BackgroundManager from "./BackgroundManager";
import { useUser } from "@/app/ThuVien/UserContext";
import { getRedirectUrl } from "@/app/CongDangNhap/RoleRedirectService";
import { useAppSettings } from "@/app/ThuVien/AppSettingsContext";
import CongDangNhap from "@/app/CongDangNhap/CongDangNhap"; // Import Popup

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const BASE_IMG_URL = `${SUPABASE_URL}/storage/v1/object/public/hinh-nen`;

function TrangChuContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const { user: contextUser, loading: contextLoading } = useUser();
  const { t, language } = useAppSettings();

  const [nguoiDung, setNguoiDung] = useState<any>(null);
  const [loiChao, setLoiChao] = useState("");
  const [daKiemTraLogin, setDaKiemTraLogin] = useState(false);
  const [currentTime, setCurrentTime] = useState<string>("");
  const [showGreeting, setShowGreeting] = useState(true);
  const [hasGreetingFinished, setHasGreetingFinished] = useState(false);
  const [showScrollHint, setShowScrollHint] = useState(false);
  const [scrollStartTime, setScrollStartTime] = useState<number | null>(null);

  // UI State
  const [activeOverlays, setActiveOverlays] = useState<Set<string>>(new Set());
  const [bgVersion, setBgVersion] = useState(Date.now());
  const [showHero, setShowHero] = useState(true);
  const [hasScrolled, setHasScrolled] = useState(false);

  // üü¢ STATE ƒêI·ªÄU KHI·ªÇN POPUP AUTH
  const [showAuthModal, setShowAuthModal] = useState(false);
  const [authMode, setAuthMode] = useState<"login" | "register">("login");

  // Smooth Scroll
  const smoothScrollTo = useCallback((targetY: number, duration = 1200) => {
    const startY = typeof window !== "undefined" ? window.scrollY : 0;
    const diff = targetY - startY;
    const start = typeof performance !== "undefined" ? performance.now() : 0;
    const easeInOutCubic = (t: number) =>
      t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
    const step = (now: number) => {
      const elapsed = now - start;
      const t = Math.min(1, elapsed / duration);
      const eased = easeInOutCubic(t);
      window.scrollTo(0, startY + diff * eased);
      if (t < 1) requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
  }, []);

  const bgUrlMobile = `${BASE_IMG_URL}/trangchu-mobile.jpg?t=${bgVersion}`;
  const bgUrlTablet = `${BASE_IMG_URL}/trangchu-tablet.jpg?t=${bgVersion}`;
  const bgUrlDesktop = `${BASE_IMG_URL}/trangchu-desktop.jpg?t=${bgVersion}`;

  // ============================================================
  // üü¢ LOGIC KI·ªÇM TRA USER
  // ============================================================
  useEffect(() => {
    // 1. N·∫øu c√≥ param ?login=1 -> M·ªü popup ƒëƒÉng nh·∫≠p ngay
    const shouldShowLogin = searchParams.get("login") === "1";
    if (shouldShowLogin) {
      setDaKiemTraLogin(true);
      setNguoiDung(null);
      window.history.replaceState({}, "", "/trangchu");

      // M·ªü Modal Login
      setAuthMode("login");
      setShowAuthModal(true);
      return;
    }

    // 2. TIMEOUT FALLBACK
    const timeoutId = setTimeout(() => {
      if (!daKiemTraLogin) {
        setDaKiemTraLogin(true);
        const storedUser = localStorage.getItem("USER_INFO");
        if (storedUser) {
          try {
            setNguoiDung(JSON.parse(storedUser));
          } catch {}
        } else {
          setNguoiDung({ userType: "guest", role: "visitor" });
        }
      }
    }, 2000);

    // 3. X·ª¨ L√ù KHI CONTEXT LOAD XONG
    if (contextLoading) return () => clearTimeout(timeoutId);

    try {
      if (contextUser) {
        const userType = contextUser.userType;
        if (userType === "nhan_su") {
          const role = (contextUser as any)?.vi_tri_normalized;
          getRedirectUrl(userType, role).then((targetRoute: string) => {
            router.replace(targetRoute);
          });
          return;
        }
        setNguoiDung(contextUser);
      } else {
        const storedUser = localStorage.getItem("USER_INFO");
        if (storedUser) {
          try {
            const parsed = JSON.parse(storedUser);
            if (parsed.userType === "nhan_su") {
              getRedirectUrl(parsed.userType, parsed.vi_tri_normalized).then(
                (targetRoute: string) => {
                  router.replace(targetRoute);
                }
              );
              return;
            }
            setNguoiDung(parsed);
          } catch {
            setNguoiDung({ userType: "guest", role: "visitor" });
          }
        } else {
          setNguoiDung({ userType: "guest", role: "visitor" });
        }
      }
    } finally {
      clearTimeout(timeoutId);
      setDaKiemTraLogin(true);
    }
  }, [contextUser, contextLoading, router, searchParams]);

  // Set greeting
  useEffect(() => {
    const name = nguoiDung?.ho_ten || t("home.guest");
    const h = new Date().getHours();
    let timeGreeting = t("home.goodEvening");
    if (h >= 5 && h < 11) timeGreeting = t("home.goodMorning");
    else if (h >= 11 && h < 14)
      timeGreeting = language === "vi" ? "Ch√†o bu·ªïi tr∆∞a" : "Good afternoon";
    else if (h >= 14 && h < 18) timeGreeting = t("home.goodAfternoon");

    setLoiChao(`${timeGreeting}, ${name}!`);
    setShowGreeting(true);
    setHasGreetingFinished(false);
    setScrollStartTime(null);

    const hideTimer = setTimeout(() => {
      setShowGreeting(false);
      setShowScrollHint(true);
    }, 5000);
    const finishTimer = setTimeout(() => {
      setHasGreetingFinished(true);
      setShowScrollHint(false);
    }, 5700);

    return () => {
      clearTimeout(hideTimer);
      clearTimeout(finishTimer);
    };
  }, [nguoiDung, t, language]);

  // Auto scroll
  useEffect(() => {
    if (!hasGreetingFinished) return;
    setShowHero(false);
    const target = document.getElementById("content-start");
    const top = target ? target.offsetTop : window.innerHeight;
    smoothScrollTo(top, 1400);
  }, [hasGreetingFinished, smoothScrollTo]);

  // Clock
  useEffect(() => {
    const updateTime = () => {
      const now = new Date();
      setCurrentTime(
        `${String(now.getHours()).padStart(2, "0")}:${String(
          now.getMinutes()
        ).padStart(2, "0")}:${String(now.getSeconds()).padStart(2, "0")}`
      );
    };
    updateTime();
    const interval = setInterval(updateTime, 1000);
    return () => clearInterval(interval);
  }, []);

  // Events listeners
  useEffect(() => {
    const handleVisibilityChange = (e: any) => {
      const { id, open } = e.detail;
      setActiveOverlays((prev) => {
        const next = new Set(prev);
        if (open) next.add(id);
        else next.delete(id);
        return next;
      });
      if (open) setShowHero(false);
    };
    window.addEventListener(
      "toggle-content-visibility",
      handleVisibilityChange
    );
    return () =>
      window.removeEventListener(
        "toggle-content-visibility",
        handleVisibilityChange
      );
  }, []);

  useEffect(() => {
    const openModal = searchParams.get("openModal");
    if (openModal) {
      window.dispatchEvent(
        new CustomEvent("openModal", { detail: { modalId: openModal } })
      );
      setShowHero(false);
    }
  }, [searchParams]);

  const handleUpdateBackground = useCallback(() => {
    setBgVersion(Date.now());
  }, []);

  const isVisitor =
    nguoiDung?.userType === "guest" || nguoiDung?.role === "visitor";

  // üü¢ H√ÄM M·ªû FORM ƒêƒÇNG K√ù
  const handleOpenRegister = useCallback(() => {
    setAuthMode("register");
    setShowAuthModal(true);
  }, []);

  const hienThiNoiDung = activeOverlays.size === 0;

  useEffect(() => {
    const handleCloseAllOverlays = () => {
      setActiveOverlays(new Set());
      setShowHero(true);
      setHasScrolled(false);
      window.scrollTo({ top: 0, behavior: "smooth" });
    };
    window.addEventListener("closeAllOverlays", handleCloseAllOverlays);
    return () =>
      window.removeEventListener("closeAllOverlays", handleCloseAllOverlays);
  }, []);

  useEffect(() => {
    const handleScroll = () => {
      if (activeOverlays.size === 0) {
        if (window.scrollY > 50 && showScrollHint) {
          if (scrollStartTime === null) setScrollStartTime(Date.now());
          else if (Date.now() - scrollStartTime >= 1000)
            setShowScrollHint(false);
        } else if (window.scrollY <= 50) setScrollStartTime(null);

        if (window.scrollY > 100) {
          setShowHero(false);
          setHasScrolled(true);
        } else {
          setShowHero(true);
          setHasScrolled(false);
        }
      }
    };
    window.addEventListener("scroll", handleScroll);
    return () => window.removeEventListener("scroll", handleScroll);
  }, [activeOverlays.size, showScrollHint, scrollStartTime]);

  // Lock body scroll
  useEffect(() => {
    if (activeOverlays.size > 0) {
      const scrollY = window.scrollY;
      document.body.style.position = "fixed";
      document.body.style.top = `-${scrollY}px`;
      document.body.style.width = "100%";
      document.body.style.overflow = "hidden";
    } else {
      const scrollY = document.body.style.top;
      document.body.style.position = "";
      document.body.style.top = "";
      document.body.style.width = "";
      document.body.style.overflow = "";
      if (scrollY) window.scrollTo(0, parseInt(scrollY || "0") * -1);
    }
    return () => {
      document.body.style.position = "";
      document.body.style.top = "";
      document.body.style.width = "";
      document.body.style.overflow = "";
    };
  }, [activeOverlays.size]);

  if (!daKiemTraLogin) return <div className="fixed inset-0 bg-[#050505]" />;

  return (
    <div className="relative w-full min-h-screen bg-[#050505] text-[#F5F5F5] font-sans selection:bg-[#C69C6D] selection:text-black overflow-x-hidden">
      {/* üü¢ COMPONENT AUTH MODAL */}
      <CongDangNhap
        isOpen={showAuthModal}
        onClose={() => setShowAuthModal(false)}
        initialMode={authMode} // Truy·ªÅn ch·∫ø ƒë·ªô (login/register)
      />

      {/* LAYER 0: H√åNH N·ªÄN */}
      <div className="fixed inset-0 w-full h-full z-0 pointer-events-none select-none bg-black">
        <img
          key={`m-${bgVersion}`}
          src={bgUrlMobile}
          alt="BG"
          className="absolute inset-0 w-full h-full object-cover md:hidden opacity-100 transition-opacity duration-1000"
        />
        <img
          key={`t-${bgVersion}`}
          src={bgUrlTablet}
          alt="BG"
          className="absolute inset-0 w-full h-full object-cover hidden md:block lg:hidden opacity-100 transition-opacity duration-1000"
        />
        <img
          key={`d-${bgVersion}`}
          src={bgUrlDesktop}
          alt="BG"
          className="absolute inset-0 w-full h-full object-cover hidden lg:block opacity-100 transition-opacity duration-1000"
        />
        <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-90" />
      </div>

      {/* LAYER 1: N·ªòI DUNG CH√çNH */}
      <main
        className={`relative z-[10] w-full flex flex-col items-center transition-all duration-500 ease-in-out ${
          hienThiNoiDung
            ? "opacity-100 translate-y-0 blur-0"
            : "opacity-0 translate-y-10 blur-sm pointer-events-none !hidden"
        }`}
      >
        {/* HERO SECTION */}
        <section
          className={`relative w-full h-[100dvh] bg-transparent pointer-events-none flex flex-col items-center justify-center transition-all duration-700 ${
            showHero && hienThiNoiDung
              ? "opacity-100 translate-y-0"
              : "opacity-0 -translate-y-20 pointer-events-none"
          }`}
        >
          <div className="absolute inset-0 flex items-center justify-center pointer-events-none px-4">
            <div className="w-full max-w-4xl">
              <div className="relative p-0 md:p-4 min-h-[60vh] flex items-center justify-center">
                <div className="relative z-10 w-full flex flex-col items-center justify-center gap-6 text-center">
                  {showGreeting && (
                    <h1 className="text-4xl sm:text-5xl md:text-6xl font-serif font-bold text-[#C69C6D] tracking-wide leading-tight greeting-zoom-out text-center">
                      <span
                        className="inline-block"
                        style={{
                          textShadow:
                            "0 4px 30px rgba(0,0,0,0.95), 0 0 60px rgba(198,156,109,0.6), 0 8px 40px rgba(0,0,0,0.8)",
                        }}
                      >
                        {loiChao}
                      </span>
                    </h1>
                  )}
                </div>
              </div>
            </div>
          </div>

          {showScrollHint && (
            <div className="absolute bottom-20 left-0 right-0 flex justify-center pointer-events-none animate-fade-in-up">
              <p
                className="text-[#C69C6D]/70 text-sm md:text-base font-light tracking-wide"
                style={{
                  textShadow:
                    "0 2px 15px rgba(0,0,0,0.9), 0 0 30px rgba(198,156,109,0.4)",
                }}
              >
                Cu·ªôn xu·ªëng ƒë·ªÉ xem n·ªôi dung
              </p>
            </div>
          )}
        </section>

        <div
          id="content-start"
          className="w-full bg-black/90 backdrop-blur-xl min-h-screen pt-20 pb-32 flex flex-col items-center gap-20 relative"
        >
          <div className="absolute -top-32 left-0 right-0 h-32 bg-gradient-to-b from-transparent via-transparent to-black/90 pointer-events-none"></div>

          <div className="w-full max-w-5xl mx-auto px-4 flex flex-col items-center gap-10 relative z-20">
            <div className="w-full h-[60vh] md:h-[70vh] rounded-lg shadow-[0_0_50px_rgba(0,0,0,0.8)] relative">
              <Slider1 />
            </div>
            <div className="animate-fade-in-up">
              <NutDatHang />
            </div>
          </div>

          <div className="w-full max-w-5xl mx-auto px-6 text-center">
            <div className="mb-10 space-y-3">
              <h2 className="text-stroke-title text-3xl md:text-5xl font-serif italic text-transparent drop-shadow-lg">
                Tinh Hoa Ngh·ªá Thu·∫≠t
              </h2>
              <p className="text-white/80 max-w-2xl mx-auto text-sm md:text-base font-light font-sans leading-relaxed drop-shadow-md">
                H√†nh tr√¨nh bi·∫øn nh·ªØng h·∫°t g·∫°o b√¨nh d·ªã th√†nh ki·ªát t√°c tinh x·∫£o,
                m·ªói s·ª£i g·∫°o l√† m·ªôt n√©t v·∫Ω trong b·ª©c tranh cu·ªôc s·ªëng.
              </p>
            </div>
            <div className="w-full aspect-video rounded-xl overflow-hidden shadow-[0_20px_50px_rgba(198,156,109,0.15)] border border-[#C69C6D]/30 relative group bg-black">
              <iframe
                className="w-full h-full object-cover"
                src="https://www.youtube.com/embed/jfKfPfyJRdk?si=9lJ_kH2g0b0b0b0b&rel=0&modestbranding=1"
                title="Video"
                frameBorder="0"
                allowFullScreen
              ></iframe>
            </div>
          </div>

          <div className="w-full max-w-6xl mx-auto px-4">
            <div className="flex items-end justify-between px-2 border-b border-white/10 pb-4 mb-8">
              <div>
                <h3 className="text-[#C69C6D] text-sm font-bold font-sans tracking-[0.2em] uppercase mb-1 shadow-black drop-shadow-md">
                  B·ªô S∆∞u T·∫≠p
                </h3>
                <h2 className="text-stroke-title text-3xl md:text-4xl font-serif text-transparent">
                  T√°c Ph·∫©m Ti√™u Bi·ªÉu
                </h2>
              </div>
              <button className="hidden md:flex items-center gap-2 text-xs font-bold font-sans uppercase text-white/50 hover:text-[#C69C6D] transition-colors">
                Xem t·∫•t c·∫£ <ArrowRight size={14} />
              </button>
            </div>
            <Slider2 />
          </div>

          <div className="w-full max-w-6xl mx-auto px-4 relative z-20">
            <div className="text-center mb-12">
              <h2 className="text-stroke-title text-3xl font-serif mt-2 text-transparent">
                Tri Th·ª©c & H√†nh Tr√¨nh
              </h2>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div className="p-8 rounded-xl bg-white/5 border border-white/10 hover:border-[#C69C6D]/50 transition-all hover:-translate-y-1">
                <div className="flex items-center gap-2 mb-4 text-[#C69C6D] text-xs font-bold font-sans uppercase">
                  <Star size={12} /> <span>Tri·ªÉn L√£m</span>
                </div>
                <h3 className="text-xl text-white font-serif font-bold mb-2">
                  H·ªìn G·∫°o Vi·ªát 2025
                </h3>
                <p className="text-gray-400 text-sm font-sans">
                  Tri·ªÉn l√£m ngh·ªá thu·∫≠t ƒë∆∞∆°ng ƒë·∫°i - n∆°i nh·ªØng t√°c ph·∫©m g·∫°o k·ªÉ c√¢u
                  chuy·ªán v·ªÅ t√¢m h·ªìn d√¢n t·ªôc v√† gi√° tr·ªã vƒ©nh h·∫±ng.
                </p>
              </div>
              <div className="p-8 rounded-xl bg-white/5 border border-white/10 hover:border-[#C69C6D]/50 transition-all hover:-translate-y-1">
                <div className="flex items-center gap-2 mb-4 text-[#C69C6D] text-xs font-bold font-sans uppercase">
                  <PlayCircle size={12} /> <span>Workshop</span>
                </div>
                <h3 className="text-xl text-white font-serif font-bold mb-2">
                  L·ªõp H·ªçc Ngh·ªá Nh√¢n
                </h3>
                <p className="text-gray-400 text-sm font-sans">
                  T·ª± tay t·∫°o n√™n c√µi ngh·ªá thu·∫≠t - workshop m·ªü c·ª≠a cho nh·ªØng ai
                  mu·ªën kh√°m ph√° k·ªπ thu·∫≠t v√† t√¢m huy·∫øt c·ªßa m·ªôt ngh·ªá nh√¢n th·ª±c
                  th·ª•.
                </p>
              </div>
            </div>
          </div>
        </div>
      </main>

      {/* LAYER 2: GRADIENT B·∫¢O V·ªÜ MENU */}
      <div className="fixed top-0 left-0 right-0 h-28 bg-gradient-to-b from-black to-transparent z-[4900] pointer-events-none"></div>
      <div className="fixed bottom-0 left-0 right-0 h-28 bg-gradient-to-t from-black to-transparent z-[4900] pointer-events-none"></div>

      {/* LAYER 3: H·ªÜ TH·ªêNG MENU */}
      <MenuTren nguoiDung={nguoiDung} loiChao={loiChao} />

      {/* Admin Tools */}
      <div className="fixed bottom-32 left-6 z-[5001] flex flex-col gap-4">
        <BackgroundManager onUpdate={handleUpdateBackground} />
      </div>

      {/* üü¢ N√öT ƒêƒÇNG K√ù (ƒê√É C·∫¨P NH·∫¨T: NH·ªé G·ªåN, TRONG SU·ªêT, G√ìC PH·∫¢I) */}
      {isVisitor && (
        <button
          onClick={handleOpenRegister}
          className="fixed bottom-6 right-4 sm:bottom-8 sm:right-6 z-[5002] flex items-center gap-2 px-4 py-2 rounded-full
                        bg-black/30 backdrop-blur-md border border-white/10 hover:bg-black/50 hover:border-[#C69C6D]/50
                        text-white/70 hover:text-[#C69C6D] text-xs font-bold uppercase tracking-wider
                        transition-all duration-300 transform hover:scale-105 active:scale-95 group"
        >
          <UserPlus size={14} className="opacity-70 group-hover:opacity-100" />
          <span className="whitespace-nowrap">ƒêƒÇNG K√ù</span>
        </button>
      )}

      <style jsx global>{`
        ::-webkit-scrollbar {
          display: none;
        }
        html,
        body {
          -ms-overflow-style: none;
          scrollbar-width: none;
          overflow-x: hidden;
          width: 100%;
        }
        .text-stroke-title {
          -webkit-text-stroke: 1px #f5f5f5;
          color: transparent;
          text-shadow: 0 0 15px rgba(198, 156, 109, 0.3);
        }
        @keyframes fade-in-up {
          0% {
            opacity: 0;
            transform: translateY(20px);
          }
          100% {
            opacity: 1;
            transform: translateY(0);
          }
        }
        .animate-fade-in-up {
          animation: fade-in-up 1s ease-out forwards;
        }
        @keyframes greetingZoomOut {
          0% {
            transform: scale(1.15);
            opacity: 1;
          }
          40% {
            transform: scale(1);
            opacity: 0.9;
          }
          70% {
            transform: scale(0.6);
            opacity: 0.5;
          }
          100% {
            transform: scale(0.2);
            opacity: 0;
          }
        }
        .greeting-zoom-out {
          animation: greetingZoomOut 5s ease-in forwards;
        }
      `}</style>
    </div>
  );
}

export default function TrangChuDashboard() {
  return (
    <Suspense
      fallback={
        <div className="w-full h-screen bg-[#050505] flex items-center justify-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#C69C6D]"></div>
        </div>
      }
    >
      <TrangChuContent />
    </Suspense>
  );
}
</file>

<file path="trangchu/slider1.tsx">
'use client';

import React, { useState, useEffect, useRef } from 'react';
import { ChevronLeft, ChevronRight, Edit, Trash2, Plus, Save, X, Image as ImageIcon } from 'lucide-react';
import { supabase } from '@/app/ThuVien/ketNoiSupabase';
import { compressImage } from '@/app/ThuVien/compressImage'; 

interface SlideData {
  id: number;
  tieu_de: string;
  mo_ta: string;
  hinh_anh: string;
}

export default function Slider1() {
  const [slides, setSlides] = useState<SlideData[]>([]);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [isAdmin, setIsAdmin] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  
  // State cho form
  const [editForm, setEditForm] = useState<{ title: string; desc: string; file: File | null; previewUrl: string }>({
    title: '', desc: '', file: null, previewUrl: ''
  });
  const [isLoading, setIsLoading] = useState(false);

  // Load d·ªØ li·ªáu l·∫ßn ƒë·∫ßu
  useEffect(() => {
    fetchSlides();
    checkAdmin();
  }, []);

  // Ki·ªÉm tra quy·ªÅn t·ª´ LocalStorage
  const checkAdmin = () => {
    if (typeof window !== 'undefined') {
        const role = localStorage.getItem('USER_ROLE');
        // N·∫øu l√† admin ho·∫∑c qu·∫£n l√Ω th√¨ hi·ªán n√∫t s·ª≠a
        if (role === 'admin' || role === 'quan_ly') setIsAdmin(true);
    }
  };

  // H√†m l·∫•y d·ªØ li·ªáu t·ª´ Supabase
  const fetchSlides = async () => {
    const { data, error } = await supabase
      .from('slider_data')
      .select('*')
      .eq('loai_slider', 'slider1')
      .order('tao_luc', { ascending: false });
    
    if (error) {
        console.error("L·ªói t·∫£i slider:", error);
    } else if (data && data.length > 0) {
        setSlides(data);
    } else {
        // D·ªØ li·ªáu m·∫´u hi·ªÉn th·ªã khi ch∆∞a c√≥ DB
        setSlides([{
            id: 0, 
            tieu_de: "NGH·ªÜ THU·∫¨T TRANH G·∫†O", 
            mo_ta: "Ch∆∞a c√≥ d·ªØ li·ªáu, vui l√≤ng th√™m m·ªõi.", 
            hinh_anh: "https://images.unsplash.com/photo-1513364776144-60967b0f800f?q=80&w=1000&auto=format&fit=crop"
        }]);
    }
  };

  // Logic chuy·ªÉn slide
  const prevSlide = () => setCurrentIndex((prev) => (prev === 0 ? slides.length - 1 : prev - 1));
  const nextSlide = () => setCurrentIndex((prev) => (prev === slides.length - 1 ? 0 : prev + 1));

  // Logic ch·ªçn file v√† n√©n ·∫£nh
  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      const originalFile = e.target.files[0];
      try {
        // N√©n ·∫£nh xu·ªëng c√≤n t·ªëi ƒëa 1920px chi·ªÅu r·ªông
        const compressed = await compressImage(originalFile, 0.8, 1920); 
        setEditForm(prev => ({ ...prev, file: compressed, previewUrl: URL.createObjectURL(compressed) }));
      } catch (err) {
        console.error("L·ªói n√©n ·∫£nh:", err);
        alert("Kh√¥ng th·ªÉ x·ª≠ l√Ω ·∫£nh n√†y.");
      }
    }
  };

  // Logic L∆∞u Slide (Quan tr·ªçng)
  const handleSave = async () => {
    if (!editForm.file && !isEditing) return alert("Vui l√≤ng ch·ªçn ·∫£nh!");
    setIsLoading(true);

    try {
      let imageUrl = editForm.previewUrl;

      // 1. Upload ·∫£nh n·∫øu c√≥ file m·ªõi
      if (editForm.file) {
        const fileName = `slider1-${Date.now()}.jpg`;
        // Upload l√™n bucket 'slider'
        const { data, error: uploadError } = await supabase.storage.from('slider').upload(fileName, editForm.file);
        
        if (uploadError) {
             console.error("L·ªói Upload:", uploadError);
             throw new Error(`L·ªói Upload Storage: ${uploadError.message}. B·∫°n c·∫ßn ch·∫°y l·ªánh SQL c·∫•p quy·ªÅn Storage.`);
        }
        
        const { data: publicUrl } = supabase.storage.from('slider').getPublicUrl(fileName);
        imageUrl = publicUrl.publicUrl;
      }

      // 2. Insert v√†o b·∫£ng slider_data
      const newSlide = {
        loai_slider: 'slider1',
        tieu_de: editForm.title,
        mo_ta: editForm.desc,
        hinh_anh: imageUrl
      };

      const { error: insertError } = await supabase.from('slider_data').insert([newSlide]);
      
      // B·∫Øt l·ªói Permission c·ª• th·ªÉ ƒë·ªÉ th√¥ng b√°o
      if (insertError) {
          console.error("L·ªói Insert:", insertError);
          if (insertError.code === '42501' || insertError.message.includes('permission denied')) {
              throw new Error("L·ªói Quy·ªÅn (42501): B·∫°n CH∆ØA ch·∫°y l·ªánh SQL m·ªü kh√≥a b·∫£ng slider_data. Vui l√≤ng copy l·ªánh SQL ·ªü tr√™n v√† ch·∫°y trong Supabase SQL Editor.");
          }
          throw insertError;
      }

      alert("Th√™m m·ªõi th√†nh c√¥ng!");
      setIsEditing(false);
      setEditForm({ title: '', desc: '', file: null, previewUrl: '' });
      fetchSlides(); // Reload l·∫°i danh s√°ch
    } catch (err: any) {
      alert(err.message);
    } finally {
      setIsLoading(false);
    }
  };

  // Logic X√≥a Slide
  const handleDelete = async (id: number) => {
      if(!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a slide n√†y?")) return;
      const { error } = await supabase.from('slider_data').delete().eq('id', id);
      if (error) {
          alert("L·ªói x√≥a: " + error.message);
      } else {
          fetchSlides();
          if (currentIndex >= slides.length - 1) setCurrentIndex(0);
      }
  };

  return (
    <div className="relative w-full h-full group/slider flex flex-col items-center justify-center">
      
      {/* KHUNG G·ªñ CAO C·∫§P */}
      <div className="relative w-full h-full overflow-hidden rounded-lg shadow-2xl"
           style={{
               border: '12px solid #5D4037', 
               boxShadow: 'inset 0 0 20px rgba(0,0,0,0.8), 0 10px 30px rgba(0,0,0,0.5)',
               backgroundImage: 'linear-gradient(45deg, #5D4037 25%, #4E342E 25%, #4E342E 50%, #5D4037 50%, #5D4037 75%, #4E342E 75%, #4E342E 100%)',
               backgroundSize: '20px 20px' 
           }}
      >
        {/* Vi·ªÅn v√†ng trang tr√≠ */}
        <div className="absolute inset-0 border-[2px] border-[#FFD700] opacity-50 pointer-events-none z-20 m-1"></div>

        {/* N·ªòI DUNG SLIDE */}
        <div className="relative w-full h-full bg-black">
            {slides.map((slide, index) => (
            <div
                key={slide.id || index}
                className={`absolute inset-0 w-full h-full transition-opacity duration-700 ease-in-out ${index === currentIndex ? 'opacity-100 z-10' : 'opacity-0 z-0'}`}
            >
                <img src={slide.hinh_anh} alt={slide.tieu_de} className="w-full h-full object-cover opacity-80" />
                <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent" />
                
                {/* Text Content: C√≥ Stroke & Shadow */}
                <div className="absolute bottom-16 left-8 right-8 text-center md:text-left">
                    <h2 
                        className="text-3xl md:text-5xl font-serif text-[#F5F5F5] mb-2 drop-shadow-[0_4px_4px_rgba(0,0,0,1)]"
                        style={{ WebkitTextStroke: '1px rgba(0,0,0,0.5)' }}
                    >
                        {slide.tieu_de}
                    </h2>
                    <p 
                        className="text-[#E8D4B9] text-sm md:text-lg font-light drop-shadow-[0_2px_2px_rgba(0,0,0,1)]"
                    >
                        {slide.mo_ta}
                    </p>
                </div>

                {/* N√∫t X√≥a (Admin Only) */}
                {isAdmin && slide.id !== 0 && (
                    <button onClick={() => handleDelete(slide.id)} className="absolute top-4 right-4 z-50 p-2 bg-red-600/80 text-white rounded hover:bg-red-500 shadow-lg border border-white/20">
                        <Trash2 size={16}/>
                    </button>
                )}
            </div>
            ))}
        </div>

        {/* N√öT ƒêI·ªÄU H∆Ø·ªöNG */}
        <button onClick={prevSlide} className="absolute left-4 top-1/2 -translate-y-1/2 z-30 p-3 bg-black/40 border border-[#C69C6D] text-[#C69C6D] hover:bg-[#C69C6D] hover:text-black transition-all rounded-full opacity-0 group-hover/slider:opacity-100 active:scale-95">
            <ChevronLeft size={24} />
        </button>
        <button onClick={nextSlide} className="absolute right-4 top-1/2 -translate-y-1/2 z-30 p-3 bg-black/40 border border-[#C69C6D] text-[#C69C6D] hover:bg-[#C69C6D] hover:text-black transition-all rounded-full opacity-0 group-hover/slider:opacity-100 active:scale-95">
            <ChevronRight size={24} />
        </button>
      </div>

      {/* FORM ADMIN TH√äM M·ªöI */}
      {isAdmin && (
        <div className="absolute top-4 left-4 z-50">
            {!isEditing ? (
                <button onClick={() => setIsEditing(true)} className="flex items-center gap-2 bg-[#C69C6D] text-black px-4 py-2 rounded-md font-bold text-xs shadow-lg hover:bg-white transition-colors border-2 border-white/20 active:scale-95">
                    <Plus size={14}/> Th√™m Slide M·ªõi
                </button>
            ) : (
                <div className="bg-black/95 p-4 rounded-lg border border-[#C69C6D] w-[300px] shadow-[0_0_30px_rgba(0,0,0,0.8)] animate-fade-in-up backdrop-blur-md">
                    <div className="flex justify-between items-center mb-3 text-[#C69C6D] border-b border-white/10 pb-2">
                        <span className="font-bold text-sm uppercase">Th√™m Slide M·ªõi</span>
                        <button onClick={() => setIsEditing(false)} className="hover:text-white"><X size={16}/></button>
                    </div>
                    
                    <div className="space-y-3">
                        {/* Input Title */}
                        <input 
                            type="text" placeholder="Ti√™u ƒë·ªÅ ch√≠nh..." 
                            className="w-full bg-white/10 border border-white/20 rounded p-2 text-white text-xs focus:border-[#C69C6D] outline-none placeholder-white/30"
                            value={editForm.title} onChange={e => setEditForm({...editForm, title: e.target.value})}
                        />
                         {/* Input Desc */}
                        <textarea 
                            placeholder="M√¥ t·∫£ ng·∫Øn..." 
                            className="w-full bg-white/10 border border-white/20 rounded p-2 text-white text-xs focus:border-[#C69C6D] outline-none h-16 resize-none placeholder-white/30"
                            value={editForm.desc} onChange={e => setEditForm({...editForm, desc: e.target.value})}
                        />
                        {/* Input File */}
                        <div className="relative w-full h-28 border-2 border-dashed border-white/20 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-[#C69C6D] hover:bg-white/5 transition-colors overflow-hidden group/upload">
                            {editForm.previewUrl ? (
                                <img src={editForm.previewUrl} className="absolute inset-0 w-full h-full object-cover opacity-60" />
                            ) : <ImageIcon className="text-white/30 mb-1 group-hover/upload:text-[#C69C6D]"/>}
                            <span className="text-[10px] text-white/50 relative z-10 font-bold uppercase">{editForm.file ? "ƒê·ªïi ·∫£nh kh√°c" : "Ch·ªçn ·∫£nh (T·ª± n√©n)"}</span>
                            <input type="file" accept="image/*" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleFileChange} />
                        </div>

                        <button 
                            onClick={handleSave} disabled={isLoading}
                            className="w-full bg-[#C69C6D] text-black font-bold py-2.5 rounded text-xs hover:bg-white transition-colors flex justify-center items-center gap-2 disabled:opacity-50"
                        >
                            {isLoading ? "ƒêang l∆∞u..." : <><Save size={14}/> L∆ØU SLIDE</>}
                        </button>
                    </div>
                </div>
            )}
        </div>
      )}
    </div>
  );
}
</file>

<file path="trangchu/slider2.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { Star, Plus, Trash2, ShoppingCart, Loader2 } from 'lucide-react';
import { supabase } from '@/app/ThuVien/ketNoiSupabase';
import { useRouter } from 'next/navigation';

interface ProductData {
  id: string; // ƒê·ªïi sang string v√¨ UUID
  ten_vat_tu: string;
  gia_ban: number;
  hinh_anh: string;
  bo_suu_tap: string;
}

export default function Slider2() {
  const [products, setProducts] = useState<ProductData[]>([]);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [loading, setLoading] = useState(true);
  const router = useRouter();

  useEffect(() => {
    fetchProducts();
  }, []);

  // T·ª± ƒë·ªông tr∆∞·ª£t
  useEffect(() => {
    if (products.length <= 1) return;
    const timer = setInterval(() => {
      setCurrentIndex(prev => (prev === products.length - 1 ? 0 : prev + 1));
    }, 4000); // 4 gi√¢y tr∆∞·ª£t 1 l·∫ßn
    return () => clearInterval(timer);
  }, [products]);

  const fetchProducts = async () => {
    setLoading(true);
    // üëá L·∫§Y D·ªÆ LI·ªÜU T·ª™ B·∫¢NG VAT_TU (D·ªØ li·ªáu th·∫≠t)
    const { data, error } = await supabase
      .from('vat_tu')
      .select('id, ten_vat_tu, gia_ban, hinh_anh, bo_suu_tap')
      .eq('loai_vat_tu', 'thanh_pham') // Ch·ªâ l·∫•y th√†nh ph·∫©m
      .not('hinh_anh', 'is', null)     // Ch·ªâ l·∫•y c√°i n√†o c√≥ ·∫£nh
      .limit(10); // L·∫•y 10 c√°i ti√™u bi·ªÉu

    if (data) {
      setProducts(data);
    }
    setLoading(false);
  };

  const handleBuy = (id: string) => {
    router.push(`/dathang?product=${id}`);
  };

  if (loading) return <div className="h-64 flex items-center justify-center"><Loader2 className="animate-spin text-[#C69C6D]"/></div>;
  if (products.length === 0) return null;

  return (
    <div className="w-full bg-black/40 backdrop-blur-md border border-white/5 rounded-xl p-4 md:p-6 relative group/container">
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-[#C69C6D] text-sm font-bold uppercase tracking-widest flex items-center gap-2">
          <Star size={14} fill="currentColor" /> T√°c ph·∫©m ti√™u bi·ªÉu ({products.length})
        </h3>
      </div>

      {/* VIEWPORT */}
      <div className="overflow-hidden w-full rounded-lg relative">
        <div 
          className="flex transition-transform duration-700 ease-in-out will-change-transform"
          style={{ transform: `translateX(-${currentIndex * 100}%)` }}
        >
          {products.map((item) => (
            <div key={item.id} className="w-full flex-shrink-0 px-2 relative group">
              <div className="relative overflow-hidden rounded-lg aspect-video md:aspect-[21/9] border border-white/10">
                <img 
                   src={item.hinh_anh} alt={item.ten_vat_tu} 
                   className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                />
                <div className="absolute inset-0 bg-black/20 group-hover:bg-black/40 transition-colors" />
                
                {/* Text Content */}
                <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black via-black/80 to-transparent">
                  <div className="flex justify-between items-end">
                    <div>
                        <span className="text-[10px] bg-[#C69C6D] text-black px-2 py-0.5 rounded font-bold uppercase mb-1 inline-block">
                            BST {item.bo_suu_tap || 'M·ªõi'}
                        </span>
                        <h2 className="text-xl md:text-3xl font-serif text-[#F5F5F5] drop-shadow-md truncate max-w-[200px] md:max-w-md">
                            {item.ten_vat_tu}
                        </h2>
                        <p className="text-[#C69C6D] text-sm md:text-lg font-bold mt-1">
                            {new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.gia_ban)}
                        </p>
                    </div>
                    <button 
                        onClick={() => handleBuy(item.id)}
                        className="bg-white text-black p-3 rounded-full hover:bg-[#C69C6D] transition-colors shadow-lg active:scale-95"
                    >
                        <ShoppingCart size={20} />
                    </button>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>

        {/* N√∫t ƒëi·ªÅu h∆∞·ªõng ·∫£o (Click tr√°i/ph·∫£i ƒë·ªÉ chuy·ªÉn) */}
        <div className="absolute inset-y-0 left-0 w-1/4 cursor-w-resize z-10" onClick={() => setCurrentIndex((prev) => (prev === 0 ? products.length - 1 : prev - 1))}></div>
        <div className="absolute inset-y-0 right-0 w-1/4 cursor-e-resize z-10" onClick={() => setCurrentIndex((prev) => (prev === products.length - 1 ? 0 : prev + 1))}></div>
      </div>
    </div>
  );
}
</file>

<file path="types/index.ts">
// ‚úÖ User & Auth Types
export interface User {
  id: string;
  ho_ten: string;
  email: string;
  avatar_url?: string | null;
  so_dien_thoai?: string | null;
  dia_chi?: string | null;
  cccd?: string | null;
  vi_tri?: string | null;
  phan_loai?: string | null;
  userType: 'nhan_su' | 'khach_hang' | 'guest';
  role?: string;
  permissions?: string[];
}

export interface AuthSession {
  user: User | null;
  isLoading: boolean;
  error?: string | null;
}

// ‚úÖ Event Types
export interface ContentVisibilityEvent extends CustomEvent {
  detail: {
    id: string;
    open: boolean;
  };
}

// ‚úÖ Component Props Types
export interface MenuTrenProps {
  nguoiDung: User | null;
  loiChao: string;
}

export interface MenuDuoiProps {
  currentUser: User | null;
  onToggleContent: (isOpen: boolean) => void;
}

export interface NutVuongProps {
  icon: React.ComponentType<{ size?: number; className?: string }>;
  badge?: number;
  onClick?: () => void;
}

// ‚úÖ Chat Metadata Types
export interface MessageMetadata {
  edited?: boolean;
  edited_at?: string;
  pinned?: boolean;
  forwarded?: boolean;
  forwarded_from?: string;
  [key: string]: any;
}

export interface MessageAttachment {
  id: string;
  type: 'image' | 'file' | 'video' | 'audio';
  url: string;
  filename: string;
  size: number;
  mime_type?: string;
}

export interface ConversationMetadata {
  description?: string;
  avatar_url?: string;
  settings?: {
    mute_notifications?: boolean;
    archive?: boolean;
    pin?: boolean;
  };
  [key: string]: any;
}

// ‚úÖ API Response Types
export interface ApiResponse<T> {
  data: T | null;
  error: string | null;
  success: boolean;
}

// ‚úÖ Chat Types
export interface ChatMessage {
  id: string;
  conversation_id: string;
  sender_id: string;
  sender_name?: string;
  sender_email?: string;
  content: string;
  message_type: 'text' | 'image' | 'file';
  attachments?: Array<{
    id: string;
    url: string;
    type: 'image' | 'file';
    name?: string;
  }>;
  created_at: string;
  updated_at: string;
  reply_to_id?: string;
  reply_to?: ChatMessage;
  reactions?: Array<{
    id: string;
    emoji: string;
    user_id: string;
  }>;
}

export interface Order {
  id: string;
  ma_don: string;
  ten_khach: string | null;
  sdt: string | null;
  dia_chi: string | null;
  ghi_chu: string | null;
  trang_thai: 'moi' | 'dang_xu_ly' | 'dang_giao' | 'hoan_thanh' | 'huy';
  tong_tien: number;
  nguoi_tao: string;
  tao_luc: string;
  cap_nhat_luc: string;
}

export interface OrderItem {
  id: string;
  don_hang_id: string;
  ten_san_pham: string | null;
  so_luong: number;
  don_gia: number;
  thanh_tien: number;
}
</file>

</files>
