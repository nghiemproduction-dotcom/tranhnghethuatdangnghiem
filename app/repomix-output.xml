This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
actions/admindb.ts
actions/QuyenHanAdmin.ts
actions/QuyenHanBaoCao.ts
actions/QuyenHanCTV.ts
actions/QuyenHanKeToan.ts
actions/QuyenHanKhachVip.ts
actions/QuyenHanKho.ts
actions/QuyenHanQuanLy.ts
actions/QuyenHanSales.ts
actions/QuyenHanSanXuat.ts
actions/QuyenHanThietKe.ts
api/fs/content/route.ts
api/fs/list/route.ts
api/fs/manager/route.ts
api/fs/open/route.ts
api/push/subscribe/route.ts
api/push/subscribe/send/route.ts
api/sync-users/route.ts
components/cacchucnang/index.ts
components/cacchucnang/khachhang/config.ts
components/cacchucnang/khachhang/index.ts
components/cacchucnang/khachhang/KhachHangChucNang.tsx
components/cacchucnang/nhansu/config.ts
components/cacchucnang/nhansu/index.ts
components/cacchucnang/nhansu/NhanSuChucNang.tsx
components/cacchucnang/types.ts
components/ConfirmDialog.tsx
components/ErrorBoundary.tsx
components/ForceFullScreen.tsx
components/KhungGiaoDien/index.ts
components/KhungGiaoDien/KhungChiTiet.tsx
components/KhungGiaoDien/KhungDanhSach.tsx
components/KhungGiaoDien/KhungForm.tsx
components/KhungTrangChuan.tsx
components/NutHoTro.tsx
components/PushManager.tsx
components/RegisterForm.tsx
components/StaffPresence.tsx
components/ThanhPhongChucNang.tsx
components/TuVanKhachHang.tsx
CongDangNhap/AuthService.ts
CongDangNhap/ChanForm.tsx
CongDangNhap/CongDangNhap.tsx
CongDangNhap/middleware.ts
CongDangNhap/page.tsx
CongDangNhap/RoleRedirectService.ts
constants/zIndex.ts
dashboard/admin/page.tsx
dathang/page.tsx
favicon.ico
GiaoDienTong/KhungGiaoDienTong.tsx
GiaoDienTong/MenuSystemWrapper.tsx
GiaoDienTong/MenuTren/MenuTren.tsx
GiaoDienTong/MenuTren/NotificationCenter.tsx
GiaoDienTong/MenuTren/NotificationService.ts
GiaoDienTong/MenuTren/NotificationTypes.ts
GiaoDienTong/MenuTren/NutCaNhan/ChucNang.ts
GiaoDienTong/MenuTren/NutCaNhan/GiaoDienChiTiet.tsx
GiaoDienTong/MenuTren/NutCaNhan/ModalProfile.tsx
GiaoDienTong/MenuTren/NutCaNhan/NutCaNhan.tsx
globals.css
layout.tsx
Music/NhacNen.tsx
page.tsx
phongadmin/page.tsx
phongctv/page.tsx
phongketoan/page.tsx
phongkhachhang/page.tsx
phongkho/page.tsx
phongparttime/page.tsx
phongquanly/page.tsx
phongsales/page.tsx
phongthietke/page.tsx
phongtrungbay/page.tsx
QueryProvider.tsx
ThuVien/AppSettingsContext.tsx
ThuVien/compressImage.ts
ThuVien/DataNormalizer.ts
ThuVien/GoogleDich.tsx
ThuVien/InputValidator.ts
ThuVien/ketNoiSupabase.ts
ThuVien/KieuDuLieu.ts
ThuVien/LoggerService.ts
ThuVien/OrderService.ts
ThuVien/QueryTimeout.ts
ThuVien/UserContext.tsx
ThuVien/withTimeout.ts
trangchu/BackgroundManager.tsx
trangchu/NutDatHang.tsx
trangchu/page.tsx
trangchu/slider1.tsx
trangchu/slider2.tsx
types/index.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="actions/admindb.ts">
'use server';

import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

// K·∫øt n·ªëi DB (D√πng Postgres.js cho c√°c l·ªánh DDL m·∫°nh)
const sql = postgres(process.env.DATABASE_URL!, {
  ssl: 'require',
  max: 10,
  idle_timeout: 20, 
});

// üõ°Ô∏è 1. H√ÄM KI·ªÇM TRA QUY·ªÄN ADMIN (B·∫ÆT BU·ªòC)
async function requireAdmin() {
    const cookieStore = cookies();
    
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                get(name: string) {
                    return cookieStore.get(name)?.value
                },
                set(name: string, value: string, options: any) {},
                remove(name: string, options: any) {},
            },
        }
    );

    const { data: { user } } = await supabase.auth.getUser();
    if (!user || !user.email) throw new Error("Unauthorized: B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p");

    // Check email ho·∫∑c b·∫£ng nhan_su ƒë·ªÉ xem c√≥ ph·∫£i admin kh√¥ng
    const { data: nhanSu } = await supabase
        .from('nhan_su')
        .select('vi_tri, vi_tri_normalized')
        .eq('email', user.email)
        .single();
    
    // ∆Øu ti√™n tr∆∞·ªùng normalized ƒë·ªÉ kh·ªõp RLS/routing; v·∫´n h·ªó tr·ª£ legacy vi_tri
    const allowedRoles = ['admin', 'quanly', 'boss'];
    const userRoleNormalized = (nhanSu?.vi_tri_normalized || '').toLowerCase();
    const userRoleLegacy = (nhanSu?.vi_tri || '').toLowerCase().replace(/\s/g, '');
    
    const isAllowed = allowedRoles.includes(userRoleNormalized) || allowedRoles.some(r => userRoleLegacy.includes(r));

    if (!isAllowed) {
        throw new Error("Forbidden: B·∫°n kh√¥ng c√≥ quy·ªÅn qu·∫£n tr·ªã Database");
    }
}

// üõ°Ô∏è 2. H√ÄM KI·ªÇM TRA T√äN B·∫¢NG/C·ªòT (CH·ªêNG SQL INJECTION)
function validateIdentifier(name: string) {
    if (!/^[a-zA-Z0-9_]+$/.test(name)) {
        throw new Error(`T√™n kh√¥ng h·ª£p l·ªá: ${name}. Ch·ªâ ch·∫•p nh·∫≠n ch·ªØ, s·ªë v√† g·∫°ch d∆∞·ªõi.`);
    }
}

// --- C√ÅC H√ÄM ACTION ---

// --- 1. L·∫§Y DANH S√ÅCH B·∫¢NG ---
export async function getTablesWithRLSAction() {
    try {
        await requireAdmin(); // üõ°Ô∏è Check quy·ªÅn
        const tables = await sql`
            SELECT c.relname as table_name, c.relrowsecurity as rls_enabled
            FROM pg_class c
            JOIN pg_namespace n ON n.oid = c.relnamespace
            WHERE n.nspname = 'public' AND c.relkind = 'r'
            ORDER BY c.relname;
        `;
        return { success: true, data: Array.from(tables).map(t => ({ table_name: t.table_name, rls_enabled: t.rls_enabled })) };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 2. KI·ªÇM TRA RLS ---
export async function checkTableRLSAction(tableName: string) {
    try {
        await requireAdmin();
        const [result] = await sql`
            SELECT c.relrowsecurity as rls_enabled
            FROM pg_class c
            JOIN pg_namespace n ON n.oid = c.relnamespace
            WHERE n.nspname = 'public' AND c.relkind = 'r' AND c.relname = ${tableName}
        `;
        if (!result) return { success: false, error: "B·∫£ng kh√¥ng t·ªìn t·∫°i" };
        return { success: true, rls_enabled: result.rls_enabled };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 3. L·∫§Y SCHEMA ---
export async function getTableSchemaAction(tableName: string) {
    try {
        await requireAdmin();
        const columns = await sql`
            SELECT column_name, data_type, is_nullable, column_default
            FROM information_schema.columns 
            WHERE table_schema = 'public' AND table_name = ${tableName}
            ORDER BY ordinal_position;
        `;
        return { success: true, data: Array.from(columns) };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 4. TOGGLE RLS (NGUY HI·ªÇM - C·∫¶N CHECK K·ª∏) ---
export async function toggleRLSAction(tableName: string, enable: boolean) {
    try {
        await requireAdmin(); // üõ°Ô∏è Check quy·ªÅn c·ª±c quan tr·ªçng
        validateIdentifier(tableName); // üõ°Ô∏è Check SQL Injection

        if (enable) {
            await sql.unsafe(`ALTER TABLE "${tableName}" ENABLE ROW LEVEL SECURITY`);
        } else {
            await sql.unsafe(`ALTER TABLE "${tableName}" DISABLE ROW LEVEL SECURITY`);
            await sql.unsafe(`GRANT ALL ON TABLE "${tableName}" TO anon, authenticated, service_role`);
        }
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// --- 5. L·∫§Y D·ªÆ LI·ªÜU PH√ÇN TRANG (ƒê√É S·ª¨A L·ªñI SORT COLUMN) ---
export async function getTableDataPaginatedAction(tableName: string, page: number, pageSize: number) {
    try {
        await requireAdmin();
        validateIdentifier(tableName);
        
        // üü¢ B∆Ø·ªöC 1: T√¨m c·ªôt s·∫Øp x·∫øp h·ª£p l·ªá (Tr√°nh l·ªói column does not exist)
        const columns = await sql`
            SELECT column_name 
            FROM information_schema.columns 
            WHERE table_schema = 'public' AND table_name = ${tableName}
        `;
        
        const colNames = Array.from(columns).map(c => c.column_name);
        let sortCol = 'id'; // M·∫∑c ƒë·ªãnh sort theo id n·∫øu kh√¥ng t√¨m th·∫•y ng√†y
        
        // ∆Øu ti√™n c√°c c·ªôt th·ªùi gian ph·ªï bi·∫øn
        if (colNames.includes('tao_luc')) sortCol = 'tao_luc';
        else if (colNames.includes('created_at')) sortCol = 'created_at';
        else if (colNames.includes('date_created')) sortCol = 'date_created';
        
        // N·∫øu kh√¥ng c√≥ id lu√¥n (hi·∫øm g·∫∑p), l·∫•y c·ªôt ƒë·∫ßu ti√™n
        if (!colNames.includes('id') && sortCol === 'id' && colNames.length > 0) {
             sortCol = colNames[0];
        }

        const offset = (page - 1) * pageSize;
        
        // üü¢ B∆Ø·ªöC 2: Query an to√†n v·ªõi c·ªôt s·∫Øp x·∫øp ƒë·ªông
        const data = await sql.unsafe(`SELECT * FROM "${tableName}" ORDER BY "${sortCol}" DESC LIMIT ${pageSize} OFFSET ${offset}`);
        
        const [countResult] = await sql.unsafe(`SELECT count(*) as total FROM "${tableName}"`);
        
        return { 
            success: true, 
            data: Array.from(data), 
            total: Number(countResult.total) 
        };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// --- 6. T·∫†O KH√ìA NGO·∫†I ---
export async function createForeignKeyAction(table: string, col: string, refTable: string, refCol: string = 'id') {
    try {
        await requireAdmin();
        validateIdentifier(table);
        validateIdentifier(col);
        validateIdentifier(refTable);
        validateIdentifier(refCol);

        const constraintName = `fk_${table}_${col}_${Date.now()}`;
        await sql.unsafe(`
            ALTER TABLE "${table}" ADD CONSTRAINT "${constraintName}" 
            FOREIGN KEY ("${col}") REFERENCES "${refTable}" ("${refCol}") ON DELETE SET NULL
        `);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// --- 7. QU·∫¢N L√ù C·∫§U TR√öC B·∫¢NG (CORE) ---
export async function manageTableStructureAction(tableName: string, columnsDef: any[]) {
  try {
    await requireAdmin();
    if (!tableName) throw new Error("T√™n b·∫£ng kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng");
    validateIdentifier(tableName);

    await sql.unsafe(`
      CREATE TABLE IF NOT EXISTS "${tableName}" (
        id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
        tao_luc timestamptz DEFAULT now()
      )
    `);

    try {
        await sql.unsafe(`ALTER TABLE "${tableName}" DISABLE ROW LEVEL SECURITY`);
        await sql.unsafe(`GRANT ALL ON TABLE "${tableName}" TO anon, authenticated, service_role`);
    } catch (e) {}

    for (const col of columnsDef) {
        if (['id', 'tao_luc'].includes(col.name)) continue;
        validateIdentifier(col.name);

        try {
            const [existing] = await sql`SELECT column_name FROM information_schema.columns WHERE table_schema = 'public' AND table_name = ${tableName} AND column_name = ${col.name}`;

            let safeDefault = '';
            if (col.defaultValue !== undefined && col.defaultValue !== null && col.defaultValue !== '') {
                let val = String(col.defaultValue).trim();
                val = val.replace(/::[a-zA-Z0-9_ ]+$/, ''); 
                const isFuncOrNum = ['now()', 'gen_random_uuid()', 'true', 'false', 'current_timestamp'].includes(val.toLowerCase()) || !isNaN(Number(val));
                if (isFuncOrNum) {
                    safeDefault = val;
                } else {
                    if (val.startsWith("'") && val.endsWith("'")) safeDefault = val;
                    else {
                         if (col.type.endsWith('[]') && !val.startsWith('{')) val = `{${val}}`;
                         safeDefault = `'${val.replace(/'/g, "''")}'`; 
                    }
                }
            }

            if (existing) {
                await sql.unsafe(`ALTER TABLE "${tableName}" ALTER COLUMN "${col.name}" TYPE ${col.type} USING "${col.name}"::${col.type}`);
                await sql.unsafe(`ALTER TABLE "${tableName}" ALTER COLUMN "${col.name}" ${col.isNullable ? 'DROP NOT NULL' : 'SET NOT NULL'}`);
                if (safeDefault) await sql.unsafe(`ALTER TABLE "${tableName}" ALTER COLUMN "${col.name}" SET DEFAULT ${safeDefault}`);
                else await sql.unsafe(`ALTER TABLE "${tableName}" ALTER COLUMN "${col.name}" DROP DEFAULT`);
            } else {
                let query = `ALTER TABLE "${tableName}" ADD COLUMN "${col.name}" ${col.type}`;
                if (!col.isNullable) query += ` NOT NULL`;
                if (safeDefault) query += ` DEFAULT ${safeDefault}`;
                await sql.unsafe(query);
            }
        } catch (colErr: any) {
            throw new Error(`L·ªói c·ªôt '${col.name}': ${colErr.message}`);
        }
    }
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error instanceof Error ? error.message : String(error) };
  }
}

// --- 8. C√ÅC H√ÄM KH√ÅC ---
export async function unlockTableAction(tableName: string) {
    return toggleRLSAction(tableName, false);
}

export async function addColumnAction(tableName: string, colName: string, colType: string) {
    try {
        await requireAdmin();
        validateIdentifier(tableName);
        validateIdentifier(colName);
        
        await sql.unsafe(`ALTER TABLE "${tableName}" ADD COLUMN "${colName}" ${colType}`);
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 9. C·∫¨P NH·∫¨T D·ªÆ LI·ªÜU ---
export async function updateTableCellAction(tableName: string, id: string, column: string, value: any) {
    try {
        await requireAdmin();
        validateIdentifier(tableName);
        validateIdentifier(column);

        // X·ª≠ l√Ω gi√° tr·ªã ƒë·∫∑c bi·ªát
        let finalValue = value;
        if (value === '' || value === null) finalValue = null;

        await sql.unsafe(`
            UPDATE "${tableName}" 
            SET "${column}" = $1 
            WHERE id = $2
        `, [finalValue, id]);

        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 10. L·∫§Y D·ªÆ LI·ªÜU NH√ÇN S·ª∞ (C√ì SEARCH & FILTER) ---
export async function getNhanSuDataAction(page: number, pageSize: number, search: string, filterRole: string) {
    try {
        await requireAdmin();
        
        let query = `SELECT * FROM "nhan_su" WHERE 1=1`;
        const params: any[] = [];
        let paramCount = 1;

        if (search) {
            query += ` AND (ho_ten ILIKE $${paramCount} OR so_dien_thoai ILIKE $${paramCount} OR email ILIKE $${paramCount})`;
            params.push(`%${search}%`);
            paramCount++;
        }

        if (filterRole && filterRole !== 'all') {
            query += ` AND vi_tri_normalized = $${paramCount}`;
            params.push(filterRole);
            paramCount++;
        }

        const countQuery = query.replace('SELECT *', 'SELECT count(*) as total');
        const offset = (page - 1) * pageSize;
        query += ` ORDER BY tao_luc DESC LIMIT ${pageSize} OFFSET ${offset}`;

        const data = await sql.unsafe(query, params);
        const [countResult] = await sql.unsafe(countQuery, params);

        return { 
            success: true, 
            data: Array.from(data), 
            total: Number(countResult.total) 
        };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 11. C·∫¨P NH·∫¨T NH√ÇN S·ª∞ ---
export async function updateNhanSuAction(id: string, data: any) {
    try {
        await requireAdmin();
        
        // üü¢ FIX L·ªñI 428C9: B·ªé C·ªòT luong_theo_gio V√å L√Ä GENERATED COLUMN
        await sql.unsafe(`
            UPDATE "nhan_su"
            SET ho_ten = $1,
                so_dien_thoai = $2,
                vi_tri = $3,
                vi_tri_normalized = $4,
                email = $5,
                luong_thang = $6,
                thuong_doanh_thu = $7,
                ngan_hang = $8,
                so_tai_khoan = $9,
                hinh_anh = $10
            WHERE id = $11
        `, [
            data.ho_ten, 
            data.so_dien_thoai, 
            data.vi_tri, 
            data.vi_tri_normalized, 
            data.email || '',
            data.luong_thang || 0,
            data.thuong_doanh_thu || 0,
            data.ngan_hang || null,
            data.so_tai_khoan || null,
            data.hinh_anh || null,
            id
        ]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 12. T·∫†O M·ªöI NH√ÇN S·ª∞ ---
export async function createNhanSuAction(data: any) {
    try {
        await requireAdmin();
        
        // üü¢ FIX L·ªñI 428C9: B·ªé C·ªòT luong_theo_gio V√å L√Ä GENERATED COLUMN
        await sql.unsafe(`
            INSERT INTO "nhan_su" (
                ho_ten, so_dien_thoai, vi_tri, vi_tri_normalized, email, 
                trang_thai, luong_thang, thuong_doanh_thu, 
                ngan_hang, so_tai_khoan, hinh_anh
            )
            VALUES ($1, $2, $3, $4, $5, 'ƒêang ho·∫°t ƒë·ªông', $6, $7, $8, $9, $10)
        `, [
            data.ho_ten, 
            data.so_dien_thoai, 
            data.vi_tri, 
            data.vi_tri_normalized, 
            data.email,
            data.luong_thang || 0,
            data.thuong_doanh_thu || 0,
            data.ngan_hang || null,
            data.so_tai_khoan || null,
            data.hinh_anh || null
        ]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 13. L·∫§Y GI√Å TR·ªä DUY NH·∫§T C·ª¶A C·ªòT (D√πng cho Dropdown) ---
export async function getDistinctValuesAction(tableName: string, columnName: string) {
    try {
        await requireAdmin();
        validateIdentifier(tableName);
        validateIdentifier(columnName);

        const data = await sql.unsafe(`
            SELECT DISTINCT "${columnName}" 
            FROM "${tableName}" 
            WHERE "${columnName}" IS NOT NULL AND "${columnName}" != ''
            ORDER BY "${columnName}" ASC
        `);
        
        return { success: true, data: Array.from(data).map(row => row[columnName]) };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}
// --- üü¢ 14. X√ìA NH√ÇN S·ª∞ ---
export async function deleteNhanSuAction(id: string) {
    try {
        await requireAdmin(); // Ch·ªâ Admin/Qu·∫£n l√Ω m·ªõi g·ªçi ƒë∆∞·ª£c
        validateIdentifier('nhan_su');

        await sql.unsafe(`
            DELETE FROM "nhan_su" WHERE id = $1
        `, [id]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 14b. C·∫¨P NH·∫¨T H√ÄNG LO·∫†T NH√ÇN S·ª∞ (BULK UPDATE) ---
export async function bulkUpdateNhanSuAction(ids: string[], data: { vi_tri?: string; vi_tri_normalized?: string }) {
    try {
        await requireAdmin();
        
        if (!ids || ids.length === 0) {
            return { success: false, error: 'Kh√¥ng c√≥ ID n√†o ƒë∆∞·ª£c ch·ªçn' };
        }

        const setClauses: string[] = [];
        const params: any[] = [];
        let paramCount = 1;

        if (data.vi_tri !== undefined) {
            setClauses.push(`vi_tri = $${paramCount}`);
            params.push(data.vi_tri);
            paramCount++;
        }

        if (data.vi_tri_normalized !== undefined) {
            setClauses.push(`vi_tri_normalized = $${paramCount}`);
            params.push(data.vi_tri_normalized);
            paramCount++;
        }

        if (setClauses.length === 0) {
            return { success: false, error: 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t' };
        }

        const idPlaceholders = ids.map((_, i) => `$${paramCount + i}`).join(', ');
        params.push(...ids);

        const query = `UPDATE "nhan_su" SET ${setClauses.join(', ')} WHERE id IN (${idPlaceholders})`;
        
        await sql.unsafe(query, params);
        
        return { success: true, updated: ids.length };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// ... (Gi·ªØ nguy√™n c√°c h√†m c≈©)

// --- üü¢ 15. L·∫§Y D·ªÆ LI·ªÜU KH√ÅCH H√ÄNG (C√ì SEARCH & FILTER) ---
export async function getKhachHangDataAction(page: number, pageSize: number, search: string, filterRole: string) {
    try {
        await requireAdmin();
        
        let query = `SELECT * FROM "khach_hang" WHERE 1=1`;
        const params: any[] = [];
        let paramCount = 1;

        if (search) {
            query += ` AND (ho_ten ILIKE $${paramCount} OR so_dien_thoai ILIKE $${paramCount} OR email ILIKE $${paramCount})`;
            params.push(`%${search}%`);
            paramCount++;
        }

        if (filterRole && filterRole !== 'all') {
            query += ` AND phan_loai_normalized = $${paramCount}`;
            params.push(filterRole);
            paramCount++;
        }

        const countQuery = query.replace('SELECT *', 'SELECT count(*) as total');
        const offset = (page - 1) * pageSize;
        // S·∫Øp x·∫øp kh√°ch h√†ng m·ªõi nh·∫•t l√™n ƒë·∫ßu
        query += ` ORDER BY tao_luc DESC LIMIT ${pageSize} OFFSET ${offset}`;

        const data = await sql.unsafe(query, params);
        const [countResult] = await sql.unsafe(countQuery, params);

        return { 
            success: true, 
            data: Array.from(data), 
            total: Number(countResult.total) 
        };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 16. T·∫†O M·ªöI KH√ÅCH H√ÄNG ---
export async function createKhachHangAction(data: any) {
    try {
        await requireAdmin();
        
        // ƒê·∫£m b·∫£o normalized c√≥ gi√° tr·ªã
        const phanLoaiNorm = data.phan_loai_normalized || 
            (data.phan_loai ? data.phan_loai.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/\s+/g, "") : 'moi');

        await sql.unsafe(`
            INSERT INTO "khach_hang" (
                ho_ten, so_dien_thoai, email, 
                phan_loai, phan_loai_normalized, 
                hinh_anh, dia_chi, tao_luc
            )
            VALUES ($1, $2, $3, $4, $5, $6, $7, now())
        `, [
            data.ho_ten, 
            data.so_dien_thoai, 
            data.email,
            data.phan_loai,
            phanLoaiNorm,
            data.hinh_anh || null,
            data.dia_chi || null
        ]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 17. C·∫¨P NH·∫¨T KH√ÅCH H√ÄNG ---
export async function updateKhachHangAction(id: string, data: any) {
    try {
        await requireAdmin();

         const phanLoaiNorm = data.phan_loai_normalized || 
            (data.phan_loai ? data.phan_loai.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/\s+/g, "") : 'moi');
        
        await sql.unsafe(`
            UPDATE "khach_hang"
            SET ho_ten = $1,
                so_dien_thoai = $2,
                email = $3,
                phan_loai = $4,
                phan_loai_normalized = $5,
                hinh_anh = $6,
                dia_chi = $7
            WHERE id = $8
        `, [
            data.ho_ten, 
            data.so_dien_thoai, 
            data.email,
            data.phan_loai,
            phanLoaiNorm,
            data.hinh_anh || null,
            data.dia_chi || null,
            id
        ]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 18. X√ìA KH√ÅCH H√ÄNG ---
export async function deleteKhachHangAction(id: string) {
    try {
        await requireAdmin();
        validateIdentifier('khach_hang');

        await sql.unsafe(`DELETE FROM "khach_hang" WHERE id = $1`, [id]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- üü¢ 19. C·∫¨P NH·∫¨T H√ÄNG LO·∫†T KH√ÅCH H√ÄNG (BULK UPDATE) ---
export async function bulkUpdateKhachHangAction(ids: string[], data: { phan_loai?: string; phan_loai_normalized?: string }) {
    try {
        await requireAdmin();
        
        if (!ids || ids.length === 0) {
            return { success: false, error: 'Kh√¥ng c√≥ ID n√†o ƒë∆∞·ª£c ch·ªçn' };
        }

        // Build SET clause dynamically
        const setClauses: string[] = [];
        const params: any[] = [];
        let paramCount = 1;

        if (data.phan_loai !== undefined) {
            setClauses.push(`phan_loai = $${paramCount}`);
            params.push(data.phan_loai);
            paramCount++;
        }

        if (data.phan_loai_normalized !== undefined) {
            setClauses.push(`phan_loai_normalized = $${paramCount}`);
            params.push(data.phan_loai_normalized);
            paramCount++;
        }

        if (setClauses.length === 0) {
            return { success: false, error: 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t' };
        }

        // Create placeholders for IDs: $3, $4, $5, ...
        const idPlaceholders = ids.map((_, i) => `$${paramCount + i}`).join(', ');
        params.push(...ids);

        const query = `UPDATE "khach_hang" SET ${setClauses.join(', ')} WHERE id IN (${idPlaceholders})`;
        
        await sql.unsafe(query, params);
        
        return { success: true, updated: ids.length };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}
</file>

<file path="actions/QuyenHanAdmin.ts">
'use server';

import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

// K·∫øt n·ªëi DB
const sql = postgres(process.env.DATABASE_URL!, {
  ssl: 'require',
  max: 10,
  idle_timeout: 20, 
});

// üõ°Ô∏è 1. CHECK QUY·ªÄN SUPER ADMIN (CH·ªà ADMIN & BOSS)
async function requireSuperAdmin() {
    const cookieStore = cookies();
    
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                get(name: string) { return cookieStore.get(name)?.value },
                set(name: string, value: string, options: any) {},
                remove(name: string, options: any) {},
            },
        }
    );

    const { data: { user } } = await supabase.auth.getUser();
    if (!user || !user.email) throw new Error("Unauthorized: B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p");

    const { data: nhanSu } = await supabase
        .from('nhan_su')
        .select('vi_tri, vi_tri_normalized')
        .eq('email', user.email)
        .single();
    
    // üîí CH·ªà CHO PH√âP ADMIN V√Ä BOSS
    const allowedRoles = ['admin', 'boss'];
    const userRoleNormalized = (nhanSu?.vi_tri_normalized || '').toLowerCase();
    
    const isAllowed = allowedRoles.includes(userRoleNormalized);

    if (!isAllowed) {
        throw new Error("Forbidden: Ch·ªâ Super Admin m·ªõi c√≥ quy·ªÅn truy c·∫≠p System Core");
    }
}

// üõ°Ô∏è 2. VALIDATE INPUT
function validateIdentifier(name: string) {
    if (!/^[a-zA-Z0-9_]+$/.test(name)) {
        throw new Error(`T√™n kh√¥ng h·ª£p l·ªá: ${name}. Ch·ªâ ch·∫•p nh·∫≠n ch·ªØ, s·ªë v√† g·∫°ch d∆∞·ªõi.`);
    }
}

// --- C√ÅC H√ÄM H·ªÜ TH·ªêNG (SYSTEM ACTIONS) ---

// 1. L·∫§Y DANH S√ÅCH B·∫¢NG
export async function getTablesWithRLSAction() {
    try {
        await requireSuperAdmin();
        const tables = await sql`
            SELECT c.relname as table_name, c.relrowsecurity as rls_enabled
            FROM pg_class c
            JOIN pg_namespace n ON n.oid = c.relnamespace
            WHERE n.nspname = 'public' AND c.relkind = 'r'
            ORDER BY c.relname;
        `;
        return { success: true, data: Array.from(tables).map(t => ({ table_name: t.table_name, rls_enabled: t.rls_enabled })) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 2. L·∫§Y SCHEMA C·∫§U TR√öC B·∫¢NG
export async function getTableSchemaAction(tableName: string) {
    try {
        await requireSuperAdmin();
        validateIdentifier(tableName);
        const columns = await sql`
            SELECT column_name, data_type, is_nullable, column_default
            FROM information_schema.columns 
            WHERE table_schema = 'public' AND table_name = ${tableName}
            ORDER BY ordinal_position;
        `;
        return { success: true, data: Array.from(columns) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 3. TOGGLE RLS (B·∫¨T/T·∫ÆT B·∫¢O M·∫¨T)
export async function toggleRLSAction(tableName: string, enable: boolean) {
    try {
        await requireSuperAdmin();
        validateIdentifier(tableName);
        if (enable) {
            await sql.unsafe(`ALTER TABLE "${tableName}" ENABLE ROW LEVEL SECURITY`);
        } else {
            await sql.unsafe(`ALTER TABLE "${tableName}" DISABLE ROW LEVEL SECURITY`);
            await sql.unsafe(`GRANT ALL ON TABLE "${tableName}" TO anon, authenticated, service_role`);
        }
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 4. L·∫§Y D·ªÆ LI·ªÜU TH√î (RAW DATA VIEWER)
export async function getTableDataPaginatedAction(tableName: string, page: number, pageSize: number) {
    try {
        await requireSuperAdmin();
        validateIdentifier(tableName);
        
        const columns = await sql`SELECT column_name FROM information_schema.columns WHERE table_schema = 'public' AND table_name = ${tableName}`;
        const colNames = Array.from(columns).map(c => c.column_name);
        
        let sortCol = 'id';
        if (colNames.includes('tao_luc')) sortCol = 'tao_luc';
        else if (colNames.includes('created_at')) sortCol = 'created_at';
        else if (!colNames.includes('id') && colNames.length > 0) sortCol = colNames[0];

        const offset = (page - 1) * pageSize;
        const data = await sql.unsafe(`SELECT * FROM "${tableName}" ORDER BY "${sortCol}" DESC LIMIT ${pageSize} OFFSET ${offset}`);
        const [countResult] = await sql.unsafe(`SELECT count(*) as total FROM "${tableName}"`);
        
        return { success: true, data: Array.from(data), total: Number(countResult.total) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 5. C·∫¨P NH·∫¨T √î D·ªÆ LI·ªÜU B·∫§T K·ª≤ (RAW EDIT)
export async function updateTableCellAction(tableName: string, id: string, column: string, value: any) {
    try {
        await requireSuperAdmin();
        validateIdentifier(tableName);
        validateIdentifier(column);

        let finalValue = value === '' ? null : value;
        await sql.unsafe(`UPDATE "${tableName}" SET "${column}" = $1 WHERE id = $2`, [finalValue, id]);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 6. QU·∫¢N L√ù C·∫§U TR√öC (CREATE TABLE / ALTER COLUMN)
export async function manageTableStructureAction(tableName: string, columnsDef: any[]) {
  try {
    await requireSuperAdmin();
    if (!tableName) throw new Error("T√™n b·∫£ng tr·ªëng");
    validateIdentifier(tableName);

    await sql.unsafe(`
      CREATE TABLE IF NOT EXISTS "${tableName}" (
        id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
        tao_luc timestamptz DEFAULT now()
      )
    `);

    // T·ª± ƒë·ªông t·∫Øt RLS khi t·∫°o b·∫£ng m·ªõi ƒë·ªÉ tr√°nh l·ªói quy·ªÅn
    try {
        await sql.unsafe(`ALTER TABLE "${tableName}" DISABLE ROW LEVEL SECURITY`);
        await sql.unsafe(`GRANT ALL ON TABLE "${tableName}" TO anon, authenticated, service_role`);
    } catch (e) {}

    for (const col of columnsDef) {
        if (['id', 'tao_luc'].includes(col.name)) continue;
        validateIdentifier(col.name);

        const [existing] = await sql`SELECT column_name FROM information_schema.columns WHERE table_schema = 'public' AND table_name = ${tableName} AND column_name = ${col.name}`;
        
        // ... (Logic x·ª≠ l√Ω default value gi·ªØ nguy√™n t·ª´ file c≈©)
        let safeDefault = '';
        if (col.defaultValue !== undefined && col.defaultValue !== null && col.defaultValue !== '') {
             let val = String(col.defaultValue).trim();
             const isFunc = ['now()', 'true', 'false'].includes(val.toLowerCase()) || !isNaN(Number(val));
             safeDefault = isFunc ? val : `'${val.replace(/'/g, "''")}'`;
        }

        if (existing) {
            await sql.unsafe(`ALTER TABLE "${tableName}" ALTER COLUMN "${col.name}" TYPE ${col.type} USING "${col.name}"::${col.type}`);
        } else {
            let query = `ALTER TABLE "${tableName}" ADD COLUMN "${col.name}" ${col.type}`;
            if (safeDefault) query += ` DEFAULT ${safeDefault}`;
            await sql.unsafe(query);
        }
    }
    return { success: true };
  } catch (error: any) { return { success: false, error: error.message }; }
}

export async function addColumnAction(tableName: string, colName: string, colType: string) {
    try {
        await requireSuperAdmin();
        validateIdentifier(tableName); validateIdentifier(colName);
        await sql.unsafe(`ALTER TABLE "${tableName}" ADD COLUMN "${colName}" ${colType}`);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}
</file>

<file path="actions/QuyenHanBaoCao.ts">
'use server';
import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

const sql = postgres(process.env.DATABASE_URL!, { ssl: 'require' });

async function requireAuth() {
    const cookieStore = cookies();
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        { cookies: { get(name: string) { return cookieStore.get(name)?.value }, set() {}, remove() {} } }
    );
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error("Unauthorized");
    return user;
}

export async function getAdminDashboardStats() {
    try {
        await requireAuth();

        // 1. Doanh thu th√°ng n√†y (D·ª±a v√†o s·ªï c√°i - THU)
        const [revenue] = await sql`
            SELECT COALESCE(SUM(so_tien), 0) as total 
            FROM "so_cai_tai_chinh" 
            WHERE loai_giao_dich = 'thu' 
            AND date_trunc('month', tao_luc) = date_trunc('month', CURRENT_DATE)
        `;

        // 2. T·ªïng ƒë∆°n h√†ng h√¥m nay
        const [ordersToday] = await sql`
            SELECT COUNT(*) as count 
            FROM "don_hang" 
            WHERE date_trunc('day', tao_luc) = date_trunc('day', CURRENT_DATE)
        `;

        // 3. Gi√° tr·ªã t·ªìn kho hi·ªán t·∫°i (S·ªë l∆∞·ª£ng * Gi√° v·ªën)
        const [inventoryValue] = await sql`
            SELECT COALESCE(SUM(ton_kho * gia_von), 0) as total 
            FROM "vat_tu"
        `;

        // 4. L∆∞∆°ng t·∫°m t√≠nh th√°ng n√†y ph·∫£i tr·∫£ (D·ª±a v√†o nh·∫≠t k√Ω s·∫£n xu·∫•t)
        // (T√≠nh s∆° b·ªô: t·ªïng ƒëi·ªÉm * 1000ƒë ho·∫∑c logic l∆∞∆°ng gi·ªù, ·ªü ƒë√¢y l·∫•y sum t·ª´ b·∫£ng l∆∞∆°ng t·∫°m)
        const [salaryPending] = await sql`
            SELECT COALESCE(SUM(tong_thu_nhap), 0) as total 
            FROM "bang_luong" 
            WHERE thang = EXTRACT(MONTH FROM CURRENT_DATE)
        `;

        return {
            success: true,
            data: {
                revenueMonth: Number(revenue.total),
                ordersToday: Number(ordersToday.count),
                inventoryValue: Number(inventoryValue.total),
                salaryPending: Number(salaryPending.total)
            }
        };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// L·∫•y 10 ho·∫°t ƒë·ªông g·∫ßn nh·∫•t c·ªßa h·ªá th·ªëng
export async function getRecentActivities() {
    try {
        await requireAuth();
        const data = await sql`
            SELECT 'don_hang' as type, ma_don as ref, ('ƒê∆°n h√†ng m·ªõi: ' || tong_tien) as content, tao_luc FROM "don_hang"
            UNION ALL
            SELECT 'san_xuat' as type, ma_lenh as ref, 'L·ªánh SX ho√†n th√†nh' as content, ket_thuc_luc as tao_luc FROM "lenh_san_xuat" WHERE trang_thai = 'hoan_thanh'
            UNION ALL
            SELECT 'tai_chinh' as type, substring(id::text, 1, 8) as ref, (loai_giao_dich || ': ' || so_tien) as content, tao_luc FROM "so_cai_tai_chinh"
            ORDER BY tao_luc DESC
            LIMIT 10
        `;
        return { success: true, data: Array.from(data) };
    } catch (error: any) { return { success: false, error: error.message }; }
}
</file>

<file path="actions/QuyenHanCTV.ts">
'use server';
import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

const sql = postgres(process.env.DATABASE_URL!, { ssl: 'require' });

async function requireAuth() {
    const cookieStore = cookies();
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        { cookies: { get(name: string) { return cookieStore.get(name)?.value }, set() {}, remove() {} } }
    );
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error("Unauthorized");
    return user;
}

// 1. L·∫§Y TH·ªêNG K√ä HOA H·ªíNG (Dashboard)
export async function getCTVStatsAction() {
    try {
        const user = await requireAuth();
        
        // T√≠nh t·ªïng ƒë∆°n h√†ng m√† CTV n√†y gi·ªõi thi·ªáu (nguoi_tao_id l√† CTV)
        // Gi·∫£ s·ª≠ hoa h·ªìng c·ª©ng l√† 10% (Boss c√≥ th·ªÉ ch·ªânh sau)
        const [stats] = await sql`
            SELECT 
                COUNT(*) as total_orders,
                COALESCE(SUM(tong_tien), 0) as total_revenue,
                COALESCE(SUM(CASE WHEN trang_thai = 'hoan_thanh' THEN tong_tien ELSE 0 END), 0) * 0.1 as commission_earned
            FROM "don_hang"
            WHERE nguoi_tao_id = ${user.id}
        `;
        
        return { success: true, data: stats };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 2. L·∫§Y S·∫¢N PH·∫®M ƒê·ªÇ B√ÅN (K√®m link ·∫£nh ƒë·ªÉ ƒëƒÉng b√†i)
export async function getCTVProductsAction() {
    try {
        await requireAuth();
        const data = await sql`
            SELECT id, ten_vat_tu, gia_ban, hinh_anh, ton_kho, bo_suu_tap
            FROM "vat_tu"
            WHERE loai_vat_tu = 'thanh_pham' AND ton_kho > 0
            ORDER BY ten_vat_tu ASC
        `;
        return { success: true, data: Array.from(data) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 3. CTV T·∫†O ƒê∆†N (Gi·∫£n l∆∞·ª£c h∆°n Sales POS)
export async function createCTVOrderAction(data: any) {
    try {
        const user = await requireAuth();
        
        // T·∫°o kh√°ch h√†ng m·ªõi n·∫øu ch∆∞a c√≥ (CTV th∆∞·ªùng b√°n cho kh√°ch l·∫°)
        let khachId = data.khach_hang_id;
        if (!khachId && data.khach_moi) {
            const [newCust] = await sql`
                INSERT INTO "khach_hang" (ho_ten, so_dien_thoai, dia_chi, phan_loai, phan_loai_normalized, nguoi_gioi_thieu_id)
                VALUES (${data.khach_moi.ho_ten}, ${data.khach_moi.sdt}, ${data.khach_moi.dia_chi}, 'Kh√°ch CTV', 'moi', ${user.id})
                RETURNING id
            `;
            khachId = newCust.id;
        }

        // T·∫°o ƒë∆°n h√†ng
        const [newOrder] = await sql`
            INSERT INTO "don_hang" (
                khach_hang_id, nguoi_tao_id, sales_phu_trach_id, 
                trang_thai, tong_tien, da_thanh_toan, kenh_ban_hang, ghi_chu
            ) VALUES (
                ${khachId}, ${user.id}, ${user.id}, -- CTV t·ª± l√† sales ph·ª• tr√°ch ban ƒë·∫ßu
                'moi', ${data.tong_tien}, 0, 'ctv', ${data.ghi_chu}
            ) RETURNING id, ma_don
        `;

        // T·∫°o chi ti·∫øt
        for (const item of data.items) {
            await sql`
                INSERT INTO "don_hang_chi_tiet" (
                    don_hang_id, vat_tu_id, ten_item_hien_thi, so_luong, don_gia
                ) VALUES (
                    ${newOrder.id}, ${item.id}, ${item.ten_vat_tu}, ${item.so_luong}, ${item.don_gia}
                )
            `;
        }

        return { success: true, ma_don: newOrder.ma_don };
    } catch (error: any) { return { success: false, error: error.message }; }
}
</file>

<file path="actions/QuyenHanKeToan.ts">
'use server';

import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

const sql = postgres(process.env.DATABASE_URL!, { ssl: 'require' });

async function requireAuth() {
    const cookieStore = cookies();
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        { cookies: { get(name: string) { return cookieStore.get(name)?.value }, set() {}, remove() {} } }
    );
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error("Unauthorized");
    return user;
}

// 1. L·∫§Y DANH S√ÅCH
export async function getThuChiDataAction(page: number, pageSize: number, search: string, filterType: string) {
    try {
        await requireAuth();
        let query = `
            SELECT tc.*, ns.ho_ten as nguoi_thuc_hien_ten
            FROM "so_cai_tai_chinh" tc
            LEFT JOIN "nhan_su" ns ON tc.nguoi_thuc_hien = ns.id
            WHERE 1=1
        `;
        const params: any[] = [];
        let paramCount = 1;

        if (search) {
            query += ` AND (mo_ta ILIKE $${paramCount})`;
            params.push(`%${search}%`);
            paramCount++;
        }

        if (filterType && filterType !== 'all') {
            query += ` AND loai_giao_dich = $${paramCount}`;
            params.push(filterType);
            paramCount++;
        }

        const countQuery = `SELECT count(*) as total FROM (${query}) as sub`;
        const offset = (page - 1) * pageSize;
        query += ` ORDER BY tao_luc DESC LIMIT ${pageSize} OFFSET ${offset}`;

        const data = await sql.unsafe(query, params);
        const [countResult] = await sql.unsafe(countQuery, params);

        return { success: true, data: Array.from(data), total: Number(countResult.total) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 2. T·∫†O M·ªöI (ƒê√£ th√™m)
export async function createThuChiAction(data: any) {
    try {
        const user = await requireAuth();
        await sql.unsafe(`
            INSERT INTO "so_cai_tai_chinh" (
                loai_giao_dich, so_tien, mo_ta, hinh_anh_chung_tu, nguoi_thuc_hien
            )
            VALUES ($1, $2, $3, $4, $5)
        `, [
            data.loai_giao_dich, data.so_tien, data.mo_ta, data.hinh_anh_chung_tu, user.id
        ]);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 3. C·∫¨P NH·∫¨T (ƒê√£ th√™m)
export async function updateThuChiAction(id: string, data: any) {
    try {
        await requireAuth();
        await sql.unsafe(`
            UPDATE "so_cai_tai_chinh"
            SET loai_giao_dich = $1, so_tien = $2, mo_ta = $3, hinh_anh_chung_tu = $4
            WHERE id = $5
        `, [
            data.loai_giao_dich, data.so_tien, data.mo_ta, data.hinh_anh_chung_tu, id
        ]);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 4. X√ìA (ƒê√£ th√™m - C√°i Boss ƒëang thi·∫øu)
export async function deleteThuChiAction(id: string) {
    try {
        await requireAuth();
        await sql.unsafe(`DELETE FROM "so_cai_tai_chinh" WHERE id = $1`, [id]);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}
</file>

<file path="actions/QuyenHanKhachVip.ts">

</file>

<file path="actions/QuyenHanKho.ts">
'use server';
import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

const sql = postgres(process.env.DATABASE_URL!, { ssl: 'require' });

// H√†m check quy·ªÅn (Clone t·ª´ QuyenHanQuanLy)
async function requireAuth() {
    const cookieStore = cookies();
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        { cookies: { get(name: string) { return cookieStore.get(name)?.value }, set() {}, remove() {} } }
    );
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error("Unauthorized");
    return user;
}

// --- QU·∫¢N L√ù V·∫¨T T∆Ø ---
export async function getVatTuDataAction(page: number, pageSize: number, search: string, filterGroup: string) {
    try {
        await requireAuth();
        let query = `SELECT * FROM "vat_tu" WHERE 1=1`;
        const params: any[] = [];
        let paramCount = 1;

        if (search) {
            query += ` AND (ten_vat_tu ILIKE $${paramCount} OR ma_sku ILIKE $${paramCount})`;
            params.push(`%${search}%`);
            paramCount++;
        }

        // L·ªçc theo lo·∫°i (Nguy√™n li·ªáu / Th√†nh ph·∫©m)
        if (filterGroup && filterGroup !== 'all') {
            query += ` AND loai_vat_tu = $${paramCount}`;
            params.push(filterGroup);
            paramCount++;
        }

        const countQuery = query.replace('SELECT *', 'SELECT count(*) as total');
        const offset = (page - 1) * pageSize;
        query += ` ORDER BY ton_kho ASC, ten_vat_tu ASC LIMIT ${pageSize} OFFSET ${offset}`; // ∆Øu ti√™n hi·ªán h√†ng s·∫Øp h·∫øt

        const data = await sql.unsafe(query, params);
        const [countResult] = await sql.unsafe(countQuery, params);

        return { success: true, data: Array.from(data), total: Number(countResult.total) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

export async function createVatTuAction(data: any) {
    try {
        await requireAuth();
        await sql.unsafe(`
            INSERT INTO "vat_tu" (ma_sku, ten_vat_tu, loai_vat_tu, don_vi_tinh, gia_von, gia_ban, ton_kho, canh_bao_toi_thieu, hinh_anh)
            VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
        `, [
            data.ma_sku, data.ten_vat_tu, data.loai_vat_tu, data.don_vi_tinh,
            data.gia_von || 0, data.gia_ban || 0, data.ton_kho || 0, data.canh_bao_toi_thieu || 10,
            data.hinh_anh
        ]);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

export async function updateVatTuAction(id: string, data: any) {
    try {
        await requireAuth();
        await sql.unsafe(`
            UPDATE "vat_tu"
            SET ma_sku = $1, ten_vat_tu = $2, loai_vat_tu = $3, don_vi_tinh = $4,
                gia_von = $5, gia_ban = $6, ton_kho = $7, canh_bao_toi_thieu = $8, hinh_anh = $9
            WHERE id = $10
        `, [
            data.ma_sku, data.ten_vat_tu, data.loai_vat_tu, data.don_vi_tinh,
            data.gia_von, data.gia_ban, data.ton_kho, data.canh_bao_toi_thieu,
            data.hinh_anh, id
        ]);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

export async function deleteVatTuAction(id: string) {
    try {
        await requireAuth();
        await sql.unsafe(`DELETE FROM "vat_tu" WHERE id = $1`, [id]);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}
</file>

<file path="actions/QuyenHanQuanLy.ts">
"use server";

import postgres from "postgres";
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";

// K·∫øt n·ªëi DB
const sql = postgres(process.env.DATABASE_URL!, {
  ssl: "require",
  max: 10,
  idle_timeout: 20,
});

// üõ°Ô∏è 1. CHECK QUY·ªÄN QU·∫¢N L√ù (ADMIN + BOSS + QUANLY)
async function requireManager() {
  const cookieStore = cookies();

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
        set() {},
        remove() {},
      },
    }
  );

  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user || !user.email) throw new Error("Unauthorized: B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p");

  // L·∫•y th√¥ng tin nh√¢n s·ª± (D√πng lower(email) ƒë·ªÉ ch·∫Øc ƒÉn)
  const [nhanSu] = await sql`
        SELECT vi_tri, vi_tri_normalized 
        FROM nhan_su 
        WHERE lower(email) = lower(${user.email})
        LIMIT 1
    `;

  // ‚úÖ DANH S√ÅCH QUY·ªÄN ƒê∆Ø·ª¢C PH√âP
  const allowedRoles = ["admin", "boss", "quanly"];
  const userRoleNormalized = (nhanSu?.vi_tri_normalized || "").toLowerCase();

  const isAllowed = allowedRoles.includes(userRoleNormalized);

  if (!isAllowed) {
    throw new Error("Forbidden: B·∫°n kh√¥ng c√≥ quy·ªÅn Qu·∫£n L√Ω nghi·ªáp v·ª• n√†y");
  }

  return user; // Tr·∫£ v·ªÅ user ƒë·ªÉ d√πng ti·∫øp n·∫øu c·∫ßn
}

function validateIdentifier(name: string) {
  if (!/^[a-zA-Z0-9_]+$/.test(name))
    throw new Error("T√™n b·∫£ng/c·ªôt kh√¥ng h·ª£p l·ªá");
}

// ==============================================================================
// üöÄ OPTIMIZED ACTIONS (B·ªé CHECK QUY·ªÄN ƒê·ªÇ TƒÇNG T·ªêC ƒê·ªò ƒê·ªåC)
// ==============================================================================

// --- üí¨ NGHI·ªÜP V·ª§ CHAT & H·ªñ TR·ª¢ ---

// 1. L·∫•y danh s√°ch t·∫•t c·∫£ phi√™n chat
export async function getManagerChatSessionsAction(
  filterStatus: string = "all"
) {
  try {
    // üöÄ B·ªé QUA CHECK AUTH (Middleware ƒë√£ ch·∫∑n r·ªìi)
    // await requireManager();

    let query = `
            SELECT 
                s.*,
                ns.ho_ten as ten_sales_phu_trach
            FROM tu_van_sessions s
            LEFT JOIN nhan_su ns ON s.nhan_su_phu_trach_id = ns.id
            WHERE 1=1
        `;

    if (filterStatus !== "all") {
      query += ` AND s.trang_thai = '${filterStatus}'`;
    }

    query += ` ORDER BY s.cap_nhat_luc DESC LIMIT 100`;

    const data = await sql.unsafe(query);
    return { success: true, data: Array.from(data) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 2. L·∫•y n·ªôi dung tin nh·∫Øn c·ªßa 1 phi√™n
export async function getManagerChatMessagesAction(sessionId: string) {
  try {
    // üöÄ B·ªé QUA CHECK AUTH
    // await requireManager();

    const data = await sql`
            SELECT * FROM tu_van_messages 
            WHERE session_id = ${sessionId} 
            ORDER BY tao_luc ASC
        `;

    return { success: true, data: Array.from(data) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// --- üë• NGHI·ªÜP V·ª§ NH√ÇN S·ª∞ (ƒê√É T·ªêI ∆ØU T·ªêC ƒê·ªò) ---

export async function getNhanSuDataAction(
  page: number,
  pageSize: number,
  search: string,
  filterRole: string
) {
  try {
    // üöÄ B·ªé QUA CHECK AUTH ƒê·ªÇ LOAD NHANH
    // await requireManager();

    // 2. Chu·∫©n b·ªã Query
    let baseQuery = `SELECT * FROM "nhan_su" WHERE 1=1`;
    let countQueryBase = `SELECT count(*) as total FROM "nhan_su" WHERE 1=1`;
    const params: any[] = [];
    let paramCount = 1;

    if (search) {
      const searchClause = ` AND (ho_ten ILIKE $${paramCount} OR so_dien_thoai ILIKE $${paramCount} OR email ILIKE $${paramCount})`;
      baseQuery += searchClause;
      countQueryBase += searchClause;
      params.push(`%${search}%`);
      paramCount++;
    }

    if (filterRole && filterRole !== "all") {
      const roleClause = ` AND vi_tri_normalized = $${paramCount}`;
      baseQuery += roleClause;
      countQueryBase += roleClause;
      params.push(filterRole);
      paramCount++;
    }

    const offset = (page - 1) * pageSize;
    baseQuery += ` ORDER BY tao_luc DESC LIMIT ${pageSize} OFFSET ${offset}`;

    // üî• T·ªêI ∆ØU QUAN TR·ªåNG: CH·∫†Y 2 C√ÇU L·ªÜNH C√ôNG L√öC (PARALLEL)
    const [dataResult, countResult] = await Promise.all([
      sql.unsafe(baseQuery, params),
      sql.unsafe(countQueryBase, params),
    ]);

    return {
      success: true,
      data: Array.from(dataResult),
      total: Number(countResult[0]?.total || 0),
    };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// üîí C√ÅC H√ÄM GHI (CREATE/UPDATE/DELETE) V·∫™N GI·ªÆ CHECK AUTH

export async function createNhanSuAction(data: any) {
  try {
    await requireManager(); // V·∫´n check khi t·∫°o m·ªõi
    await sql.unsafe(
      `
            INSERT INTO "nhan_su" (
                ho_ten, so_dien_thoai, vi_tri, vi_tri_normalized, email, 
                trang_thai, luong_thang, thuong_doanh_thu, 
                ngan_hang, so_tai_khoan, hinh_anh
            )
            VALUES ($1, $2, $3, $4, $5, 'ƒêang ho·∫°t ƒë·ªông', $6, $7, $8, $9, $10)
        `,
      [
        data.ho_ten,
        data.so_dien_thoai,
        data.vi_tri,
        data.vi_tri_normalized,
        data.email,
        data.luong_thang || 0,
        data.thuong_doanh_thu || 0,
        data.ngan_hang || null,
        data.so_tai_khoan || null,
        data.hinh_anh || null,
      ]
    );
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function updateNhanSuAction(id: string, data: any) {
  try {
    await requireManager(); // V·∫´n check khi s·ª≠a
    await sql.unsafe(
      `
            UPDATE "nhan_su"
            SET ho_ten = $1, so_dien_thoai = $2, vi_tri = $3, vi_tri_normalized = $4, email = $5,
                luong_thang = $6, thuong_doanh_thu = $7, ngan_hang = $8, so_tai_khoan = $9, hinh_anh = $10
            WHERE id = $11
        `,
      [
        data.ho_ten,
        data.so_dien_thoai,
        data.vi_tri,
        data.vi_tri_normalized,
        data.email || "",
        data.luong_thang || 0,
        data.thuong_doanh_thu || 0,
        data.ngan_hang || null,
        data.so_tai_khoan || null,
        data.hinh_anh || null,
        id,
      ]
    );
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function deleteNhanSuAction(id: string) {
  try {
    await requireManager(); // V·∫´n check khi x√≥a
    await sql.unsafe(`DELETE FROM "nhan_su" WHERE id = $1`, [id]);
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function bulkUpdateNhanSuAction(
  ids: string[],
  data: { vi_tri?: string; vi_tri_normalized?: string }
) {
  try {
    await requireManager();
    if (!ids.length) return { success: false, error: "Ch∆∞a ch·ªçn nh√¢n s·ª±" };

    const setClauses: string[] = [];
    const params: any[] = [];
    let paramCount = 1;

    if (data.vi_tri) {
      setClauses.push(`vi_tri = $${paramCount}`);
      params.push(data.vi_tri);
      paramCount++;
    }
    if (data.vi_tri_normalized) {
      setClauses.push(`vi_tri_normalized = $${paramCount}`);
      params.push(data.vi_tri_normalized);
      paramCount++;
    }

    const idPlaceholders = ids.map((_, i) => `$${paramCount + i}`).join(", ");
    params.push(...ids);

    await sql.unsafe(
      `UPDATE "nhan_su" SET ${setClauses.join(
        ", "
      )} WHERE id IN (${idPlaceholders})`,
      params
    );
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// --- ü§ù NGHI·ªÜP V·ª§ KH√ÅCH H√ÄNG ---

export async function getKhachHangDataAction(
  page: number,
  pageSize: number,
  search: string,
  filterRole: string
) {
  try {
    // üöÄ B·ªé QUA CHECK AUTH ƒê·ªÇ LOAD NHANH
    // await requireManager();

    let query = `SELECT * FROM "khach_hang" WHERE 1=1`;
    let countQuery = `SELECT count(*) as total FROM "khach_hang" WHERE 1=1`;
    const params: any[] = [];
    let paramCount = 1;

    if (search) {
      const searchClause = ` AND (ho_ten ILIKE $${paramCount} OR so_dien_thoai ILIKE $${paramCount} OR email ILIKE $${paramCount})`;
      query += searchClause;
      countQuery += searchClause;
      params.push(`%${search}%`);
      paramCount++;
    }
    if (filterRole && filterRole !== "all") {
      const roleClause = ` AND phan_loai_normalized = $${paramCount}`;
      query += roleClause;
      countQuery += roleClause;
      params.push(filterRole);
      paramCount++;
    }

    const offset = (page - 1) * pageSize;
    query += ` ORDER BY tao_luc DESC LIMIT ${pageSize} OFFSET ${offset}`;

    // üî• CH·∫†Y SONG SONG
    const [data, countResult] = await Promise.all([
      sql.unsafe(query, params),
      sql.unsafe(countQuery, params),
    ]);

    return {
      success: true,
      data: Array.from(data),
      total: Number(countResult[0]?.total || 0),
    };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function createKhachHangAction(data: any) {
  try {
    await requireManager();
    const phanLoaiNorm =
      data.phan_loai_normalized ||
      (data.phan_loai
        ? data.phan_loai
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
            .replace(/\s+/g, "")
        : "moi");

    await sql.unsafe(
      `
            INSERT INTO "khach_hang" (ho_ten, so_dien_thoai, email, phan_loai, phan_loai_normalized, hinh_anh, dia_chi, tao_luc)
            VALUES ($1, $2, $3, $4, $5, $6, $7, now())
        `,
      [
        data.ho_ten,
        data.so_dien_thoai,
        data.email,
        data.phan_loai,
        phanLoaiNorm,
        data.hinh_anh || null,
        data.dia_chi || null,
      ]
    );
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function updateKhachHangAction(id: string, data: any) {
  try {
    await requireManager();
    const phanLoaiNorm =
      data.phan_loai_normalized ||
      (data.phan_loai
        ? data.phan_loai
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
            .replace(/\s+/g, "")
        : "moi");

    await sql.unsafe(
      `
            UPDATE "khach_hang"
            SET ho_ten = $1, so_dien_thoai = $2, email = $3, phan_loai = $4, phan_loai_normalized = $5, hinh_anh = $6, dia_chi = $7
            WHERE id = $8
        `,
      [
        data.ho_ten,
        data.so_dien_thoai,
        data.email,
        data.phan_loai,
        phanLoaiNorm,
        data.hinh_anh || null,
        data.dia_chi || null,
        id,
      ]
    );
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function deleteKhachHangAction(id: string) {
  try {
    await requireManager();
    await sql.unsafe(`DELETE FROM "khach_hang" WHERE id = $1`, [id]);
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function bulkUpdateKhachHangAction(
  ids: string[],
  data: { phan_loai?: string; phan_loai_normalized?: string }
) {
  try {
    await requireManager();
    if (!ids.length) return { success: false, error: "Ch∆∞a ch·ªçn kh√°ch h√†ng" };

    const setClauses: string[] = [];
    const params: any[] = [];
    let paramCount = 1;

    if (data.phan_loai) {
      setClauses.push(`phan_loai = $${paramCount}`);
      params.push(data.phan_loai);
      paramCount++;
    }
    if (data.phan_loai_normalized) {
      setClauses.push(`phan_loai_normalized = $${paramCount}`);
      params.push(data.phan_loai_normalized);
      paramCount++;
    }

    const idPlaceholders = ids.map((_, i) => `$${paramCount + i}`).join(", ");
    params.push(...ids);

    await sql.unsafe(
      `UPDATE "khach_hang" SET ${setClauses.join(
        ", "
      )} WHERE id IN (${idPlaceholders})`,
      params
    );
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// --- UTILS (Dropdowns) ---
export async function getDistinctValuesAction(
  tableName: string,
  columnName: string
) {
  try {
    // üöÄ B·ªé QUA CHECK AUTH ƒê·ªÇ LOAD DROPDOWN NHANH
    // await requireManager();
    validateIdentifier(tableName);
    validateIdentifier(columnName);

    const data = await sql.unsafe(`
            SELECT DISTINCT "${columnName}" FROM "${tableName}" 
            WHERE "${columnName}" IS NOT NULL AND "${columnName}" != ''
            ORDER BY "${columnName}" ASC
        `);
    return {
      success: true,
      data: Array.from(data).map((row) => row[columnName]),
    };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// üü¢ L·∫§Y T√ÅC PH·∫®M HO√ÄN THI·ªÜN (D·ªØ li·ªáu cho Ph√≤ng Tr∆∞ng B√†y)
export async function getFinishedArtworksAction(limit: number = 50) {
  try {
    // üöÄ B·ªé QUA CHECK AUTH
    // await requireManager();

    const data = await sql`
            SELECT 
                nk.id, 
                nk.anh_thanh_pham, 
                nk.thoi_gian_ket_thuc,
                ns.ho_ten as ten_nghe_nhan,
                vt.ten_vat_tu as ten_tac_pham,
                vt.ma_sku,
                dh.ma_don
            FROM nhat_ky_san_xuat nk
            JOIN nhan_su ns ON nk.nhan_su_thuc_hien = ns.id
            JOIN lenh_san_xuat lsx ON nk.lenh_san_xuat_id = lsx.id
            JOIN don_hang_chi_tiet dhct ON lsx.don_hang_chi_tiet_id = dhct.id
            JOIN don_hang dh ON dhct.don_hang_id = dh.id
            JOIN vat_tu vt ON dhct.vat_tu_id = vt.id
            WHERE nk.anh_thanh_pham IS NOT NULL 
            AND nk.ket_qua = 'dat'
            ORDER BY nk.thoi_gian_ket_thuc DESC
            LIMIT ${limit}
        `;

    return { success: true, data: Array.from(data) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}
</file>

<file path="actions/QuyenHanSales.ts">
'use server';

import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

const sql = postgres(process.env.DATABASE_URL!, {
  ssl: 'require',
  max: 10,
  idle_timeout: 20, 
});

// Helper: L·∫•y th√¥ng tin nh√¢n vi√™n ƒëang login
async function getStaffUser() {
    const cookieStore = cookies();
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: { get(name: string) { return cookieStore.get(name)?.value }, set() {}, remove() {} },
        }
    );
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error("Unauthorized: B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p");
    
    // L·∫•y role v√† organization_id
    const [ns] = await sql`SELECT id, vi_tri_normalized, organization_id FROM nhan_su WHERE id = ${user.id} LIMIT 1`;
    if (!ns) throw new Error("Not a staff member: Kh√¥ng t√¨m th·∫•y h·ªì s∆° nh√¢n s·ª±");
    
    return ns;
}

// --- 1. NGHI·ªÜP V·ª§ CHAT T∆Ø V·∫§N (C≈©) ---
export async function claimChatSessionAction(sessionId: string) {
    try {
        const staff = await getStaffUser();
        
        const [session] = await sql`SELECT nhan_su_phu_trach_id FROM tu_van_sessions WHERE id = ${sessionId} LIMIT 1`;
        if (!session) throw new Error("Cu·ªôc h·ªôi tho·∫°i kh√¥ng t·ªìn t·∫°i");

        if (session.nhan_su_phu_trach_id && session.nhan_su_phu_trach_id !== staff.id) {
            if (['admin', 'quanly', 'boss'].includes(staff.vi_tri_normalized)) {
                // Admin ƒë∆∞·ª£c quy·ªÅn c∆∞·ªõp
            } else {
                return { success: false, error: "Cu·ªôc h·ªôi tho·∫°i n√†y ƒë√£ c√≥ Sales kh√°c h·ªó tr·ª£!" };
            }
        }

        await sql`
            UPDATE tu_van_sessions 
            SET nhan_su_phu_trach_id = ${staff.id}, 
                trang_thai = 'dang_tu_van' 
            WHERE id = ${sessionId}
        `;

        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 2. NGHI·ªÜP V·ª§ B√ÅN H√ÄNG (POS) ---

// L·∫•y danh s√°ch s·∫£n ph·∫©m ƒë·ªÉ b√°n
export async function getProductsForPOS(search: string) {
    try {
        await getStaffUser();
        let query = `SELECT * FROM "vat_tu" WHERE loai_vat_tu = 'thanh_pham' AND ton_kho > 0`;
        const params: any[] = [];

        if (search) {
            query += ` AND (ten_vat_tu ILIKE $1 OR ma_sku ILIKE $1)`;
            params.push(`%${search}%`);
        }
        
        query += ` ORDER BY ten_vat_tu ASC LIMIT 20`;
        const data = await sql.unsafe(query, params);
        return { success: true, data: Array.from(data) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// T√¨m kh√°ch h√†ng nhanh
export async function searchCustomer(term: string) {
    try {
        await getStaffUser();
        const data = await sql`
            SELECT id, ho_ten, so_dien_thoai, phan_loai 
            FROM "khach_hang" 
            WHERE ho_ten ILIKE ${'%' + term + '%'} OR so_dien_thoai ILIKE ${'%' + term + '%'}
            LIMIT 5
        `;
        return { success: true, data: Array.from(data) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// üî• QUAN TR·ªåNG: T·∫†O ƒê∆†N & T·ª∞ ƒê·ªòNG B·∫ÆN L·ªÜNH S·∫¢N XU·∫§T
export async function createPOSOrder(orderData: any) {
    try {
        const staff = await getStaffUser();
        
        // 1. T·∫°o ƒê∆°n h√†ng
        // Tr·∫°ng th√°i 'dang_san_xuat' ƒë·ªÉ k√≠ch ho·∫°t quy tr√¨nh
        const [newOrder] = await sql`
            INSERT INTO "don_hang" (
                khach_hang_id, sales_phu_trach_id, nguoi_tao_id, organization_id,
                trang_thai, tong_tien, da_thanh_toan, kenh_ban_hang, ghi_chu
            ) VALUES (
                ${orderData.khach_hang_id}, ${staff.id}, ${staff.id}, ${staff.organization_id},
                'dang_san_xuat', ${orderData.tong_tien}, ${orderData.da_thanh_toan}, 'pos', ${orderData.ghi_chu}
            ) RETURNING id, ma_don
        `;

        // 2. L·∫•y quy tr√¨nh m·∫´u m·∫∑c ƒë·ªãnh (ƒê·ªÉ g·∫Øn v√†o l·ªánh SX)
        // Trong th·ª±c t·∫ø c√≥ th·ªÉ ch·ªçn quy tr√¨nh, ·ªü ƒë√¢y l·∫•y m·∫∑c ƒë·ªãnh c√°i ƒë·∫ßu ti√™n t√¨m th·∫•y
        const [defaultProcess] = await sql`SELECT id FROM quy_trinh_mau LIMIT 1`;
        const quyTrinhId = defaultProcess?.id || null;

        // 3. T·∫°o Chi ti·∫øt ƒë∆°n & L·ªánh S·∫£n Xu·∫•t (Job)
        for (const item of orderData.items) {
            // A. Insert Chi ti·∫øt ƒë∆°n
            const [newItem] = await sql`
                INSERT INTO "don_hang_chi_tiet" (
                    don_hang_id, vat_tu_id, ten_item_hien_thi, so_luong, don_gia
                ) VALUES (
                    ${newOrder.id}, ${item.id}, ${item.ten_vat_tu}, ${item.so_luong}, ${item.don_gia}
                ) RETURNING id
            `;

            // B. T·∫†O L·ªÜNH S·∫¢N XU·∫§T (Treo l√™n "S√†n vi·ªác" cho th·ª£ nh·∫≠n)
            if (quyTrinhId) {
                // T·∫°o m√£ l·ªánh ng·∫´u nhi√™n
                const maLenh = 'LSX-' + Math.floor(100000 + Math.random() * 900000);
                
                await sql`
                    INSERT INTO "lenh_san_xuat" (
                        ma_lenh, organization_id, don_hang_chi_tiet_id, quy_trinh_id,
                        trang_thai, tien_do, nguoi_phu_trach
                    ) VALUES (
                        ${maLenh}, 
                        ${staff.organization_id},
                        ${newItem.id}, ${quyTrinhId},
                        'moi', 0, NULL -- NULL = Ch∆∞a ai nh·∫≠n (Available Job)
                    )
                `;
            }
        }

        // 4. Ghi nh·∫≠n Thu ti·ªÅn (n·∫øu kh√°ch tr·∫£ ngay)
        if (orderData.da_thanh_toan > 0) {
            await sql`
                INSERT INTO "so_cai_tai_chinh" (
                    loai_giao_dich, so_tien, mo_ta, tham_chieu_id, nguoi_thuc_hien, organization_id
                ) VALUES (
                    'thu', ${orderData.da_thanh_toan}, ${'Thu ti·ªÅn ƒë∆°n ' + newOrder.ma_don}, ${newOrder.id}, ${staff.id}, ${staff.organization_id}
                )
            `;
        }

        return { success: true, ma_don: newOrder.ma_don };
    } catch (error: any) { 
        console.error("L·ªói t·∫°o ƒë∆°n POS:", error);
        return { success: false, error: error.message }; 
    }
}
</file>

<file path="actions/QuyenHanSanXuat.ts">
'use server';
import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

const sql = postgres(process.env.DATABASE_URL!, { ssl: 'require' });

async function requireAuth() {
    const cookieStore = cookies();
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        { cookies: { get(name: string) { return cookieStore.get(name)?.value }, set() {}, remove() {} } }
    );
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error("Unauthorized");
    return user;
}

// 1. L·∫§Y VI·ªÜC C·ª¶A T√îI (ƒê√£ nh·∫≠n, ch∆∞a xong)
export async function getMyTasksAction() {
    try {
        const user = await requireAuth();
        
        const data = await sql`
            SELECT 
                lsx.id, lsx.ma_lenh, lsx.trang_thai, lsx.tien_do, lsx.bat_dau_luc,
                ct.ten_item_hien_thi, ct.so_luong,
                qt.ten_quy_trinh,
                dh.ma_don, dh.ghi_chu as ghi_chu_don
            FROM "lenh_san_xuat" lsx
            JOIN "don_hang_chi_tiet" ct ON lsx.don_hang_chi_tiet_id = ct.id
            JOIN "don_hang" dh ON ct.don_hang_id = dh.id
            LEFT JOIN "quy_trinh_mau" qt ON lsx.quy_trinh_id = qt.id
            WHERE lsx.nguoi_phu_trach = ${user.id}
            AND lsx.trang_thai != 'hoan_thanh'
            ORDER BY dh.tao_luc ASC
        `;
        
        return { success: true, data: Array.from(data) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 2. L·∫§Y VI·ªÜC M·ªöI (S√†n vi·ªác - Ch∆∞a ai nh·∫≠n)
export async function getAvailableJobsAction() {
    try {
        await requireAuth(); 
        
        // L·∫•y c√°c l·ªánh SX m√† nguoi_phu_trach l√† NULL
        const data = await sql`
            SELECT 
                lsx.id, lsx.ma_lenh, lsx.trang_thai,
                ct.ten_item_hien_thi, ct.so_luong,
                qt.ten_quy_trinh,
                dh.ma_don, dh.ghi_chu as ghi_chu_don
            FROM "lenh_san_xuat" lsx
            JOIN "don_hang_chi_tiet" ct ON lsx.don_hang_chi_tiet_id = ct.id
            JOIN "don_hang" dh ON ct.don_hang_id = dh.id
            LEFT JOIN "quy_trinh_mau" qt ON lsx.quy_trinh_id = qt.id
            WHERE lsx.nguoi_phu_trach IS NULL 
            AND lsx.trang_thai = 'moi'
            ORDER BY dh.tao_luc DESC
            LIMIT 50
        `;
        return { success: true, data: Array.from(data) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 3. NH·∫¨N VI·ªÜC (Claim Job)
export async function claimJobAction(jobId: string) {
    try {
        const user = await requireAuth();
        
        // Update ng∆∞·ªùi ph·ª• tr√°ch = User ƒëang login
        // Ch·ªâ update n·∫øu l·ªánh ƒë√≥ ch∆∞a c√≥ ng∆∞·ªùi nh·∫≠n (tr√°nh race condition)
        const result = await sql`
            UPDATE "lenh_san_xuat"
            SET nguoi_phu_trach = ${user.id},
                trang_thai = 'dang_lam',
                bat_dau_luc = NOW()
            WHERE id = ${jobId} 
            AND nguoi_phu_trach IS NULL
            RETURNING id
        `;
        
        if (result.count === 0) {
            return { success: false, error: "C√¥ng vi·ªác n√†y ƒë√£ b·ªã ng∆∞·ªùi kh√°c nh·∫≠n m·∫•t r·ªìi!" };
        }
        
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 4. B·∫ÆT ƒê·∫¶U L√ÄM (Start Timer)
export async function startJobAction(jobId: string) {
    try {
        await requireAuth();
        await sql`
            UPDATE "lenh_san_xuat"
            SET trang_thai = 'dang_lam', 
                bat_dau_luc = COALESCE(bat_dau_luc, NOW()), -- Ch·ªâ set n·∫øu ch∆∞a c√≥
                cap_nhat_luc = NOW()
            WHERE id = ${jobId}
        `;
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 5. HO√ÄN TH√ÄNH VI·ªÜC (Finish & Get Paid)
export async function completeJobAction(jobId: string, resultImage: string, note: string) {
    try {
        const user = await requireAuth();
        
        // D√πng transaction ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn
        await sql.begin(async sql => {
            // A. C·∫≠p nh·∫≠t L·ªánh SX th√†nh ho√†n th√†nh
            await sql`
                UPDATE "lenh_san_xuat"
                SET trang_thai = 'hoan_thanh',
                    tien_do = 100,
                    ket_thuc_luc = NOW()
                WHERE id = ${jobId}
            `;

            // B. Ghi nh·∫≠t k√Ω (ƒê·ªÉ k√≠ch ho·∫°t Trigger t√≠nh l∆∞∆°ng)
            // L·∫•y th√¥ng tin t·ª´ l·ªánh sx ƒë·ªÉ ghi log
            await sql`
                INSERT INTO "nhat_ky_san_xuat" (
                    lenh_san_xuat_id, nhan_su_thuc_hien, 
                    thoi_gian_bat_dau, thoi_gian_ket_thuc,
                    ket_qua, anh_thanh_pham, diem_thuong_nhan_duoc
                )
                SELECT 
                    id, ${user.id}, 
                    bat_dau_luc, NOW(),
                    'dat', ${resultImage}, 10 -- Th∆∞·ªüng m·∫∑c ƒë·ªãnh 10 ƒëi·ªÉm
                FROM "lenh_san_xuat"
                WHERE id = ${jobId}
            `;
        });

        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 6. L·∫§Y L∆Ø∆†NG H√îM NAY (Motivational Metric)
export async function getMySalaryToday() {
    try {
        const user = await requireAuth();
        // T√≠nh t·ªïng l∆∞∆°ng c·ªßa th√°ng hi·ªán t·∫°i
        const [res] = await sql`
            SELECT SUM(tong_thu_nhap) as total
            FROM "bang_luong"
            WHERE nhan_su_id = ${user.id}
            AND thang = EXTRACT(MONTH FROM CURRENT_DATE)
            AND nam = EXTRACT(YEAR FROM CURRENT_DATE)
        `;
        return { success: true, total: Number(res?.total || 0) };
    } catch (error: any) { return { success: false, error: error.message }; }
}
</file>

<file path="actions/QuyenHanThietKe.ts">
'use server';
import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

const sql = postgres(process.env.DATABASE_URL!, { ssl: 'require' });

async function requireAuth() {
    const cookieStore = cookies();
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        { cookies: { get(name: string) { return cookieStore.get(name)?.value }, set() {}, remove() {} } }
    );
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error("Unauthorized");
    return user;
}

// 1. L·∫§Y DANH S√ÅCH M·∫™U THI·∫æT K·∫æ
export async function getDesignDataAction(page: number, pageSize: number, search: string, filterStatus: string) {
    try {
        await requireAuth();
        // L·∫•y d·ªØ li·ªáu t·ª´ b·∫£ng quy_trinh_mau (ƒë·∫°i di·ªán cho m·∫´u) ho·∫∑c b·∫£ng ri√™ng n·∫øu Boss mu·ªën t√°ch
        // ·ªû ƒë√¢y em d√πng b·∫£ng 'vat_tu' lo·∫°i 'thanh_pham' l√†m m·∫´u thi·∫øt k·∫ø ƒë·ªÉ ƒë·ªìng b·ªô
        let query = `SELECT * FROM "vat_tu" WHERE loai_vat_tu = 'thanh_pham'`;
        const params: any[] = [];
        let paramCount = 1;

        if (search) {
            query += ` AND (ten_vat_tu ILIKE $${paramCount} OR ma_sku ILIKE $${paramCount})`;
            params.push(`%${search}%`);
            paramCount++;
        }
        
        // Filter theo b·ªô s∆∞u t·∫≠p
        if (filterStatus && filterStatus !== 'all') {
            query += ` AND bo_suu_tap = $${paramCount}`;
            params.push(filterStatus);
            paramCount++;
        }

        const countQuery = query.replace('SELECT *', 'SELECT count(*) as total');
        const offset = (page - 1) * pageSize;
        query += ` ORDER BY ten_vat_tu ASC LIMIT ${pageSize} OFFSET ${offset}`;

        const data = await sql.unsafe(query, params);
        const [countResult] = await sql.unsafe(countQuery, params);

        return { success: true, data: Array.from(data), total: Number(countResult.total) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 2. C·∫¨P NH·∫¨T FILE THI·∫æT K·∫æ (L∆∞u link file v√†o metadata)
export async function updateDesignFileAction(id: string, fileUrl: string, note: string) {
    try {
        await requireAuth();
        // L∆∞u link file g·ªëc v√†o c·ªôt metadata json
        await sql.unsafe(`
            UPDATE "vat_tu"
            SET metadata = jsonb_set(
                COALESCE(metadata, '{}'::jsonb), 
                '{file_thiet_ke}', 
                $1::jsonb
            )
            WHERE id = $2
        `, [JSON.stringify({ url: fileUrl, note: note, updated_at: new Date().toISOString() }), id]);
        
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}
</file>

<file path="api/fs/content/route.ts">
import { NextResponse } from 'next/server';
import fs from 'fs';
import path from 'path';

// üõ°Ô∏è CH·ªà CHO PH√âP CH·∫†Y KHI ƒêANG DEV TR√äN M√ÅY LOCAL
const isDev = process.env.NODE_ENV === 'development';

export async function POST(req: Request) {
    if (!isDev) {
        return NextResponse.json({ error: 'T√≠nh nƒÉng n√†y b·ªã v√¥ hi·ªáu h√≥a tr√™n m√¥i tr∆∞·ªùng m·∫°ng.' }, { status: 403 });
    }

    try {
        const { filePath, content } = await req.json();
        
        // üõ°Ô∏è Sanitize Path: Ch·∫∑n vi·ªác truy c·∫≠p ra kh·ªèi th∆∞ m·ª•c d·ª± √°n (Directory Traversal)
        if (filePath.includes('..')) {
            return NextResponse.json({ error: 'ƒê∆∞·ªùng d·∫´n kh√¥ng h·ª£p l·ªá' }, { status: 400 });
        }

        const fullPath = path.join(process.cwd(), filePath);

        if (content !== undefined) {
            fs.writeFileSync(fullPath, content, 'utf-8');
            return NextResponse.json({ success: true });
        } else {
            if (!fs.existsSync(fullPath)) return NextResponse.json({ error: 'File 404' }, { status: 404 });
            const fileContent = fs.readFileSync(fullPath, 'utf-8');
            return NextResponse.json({ content: fileContent });
        }
    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="api/fs/list/route.ts">
import { NextResponse } from 'next/server';
import fs from 'fs';
import path from 'path';

// H√†m ƒë·ªá quy qu√©t file
const getFiles = (dir: string, fileList: string[] = [], rootDir: string) => {
    const files = fs.readdirSync(dir);

    files.forEach((file) => {
        const filePath = path.join(dir, file);
        const stat = fs.statSync(filePath);

        // B·ªè qua c√°c th∆∞ m·ª•c r√°c h·ªá th·ªëng
        if (file === 'node_modules' || file === '.next' || file === '.git' || file === '.vscode') {
            return;
        }

        if (stat.isDirectory()) {
            getFiles(filePath, fileList, rootDir);
        } else {
            // Ch·ªâ l·∫•y ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi ƒë·ªÉ hi·ªÉn th·ªã cho ƒë·∫πp
            // V√≠ d·ª•: app/page.tsx thay v√¨ C:/Users/.../app/page.tsx
            const relativePath = path.relative(rootDir, filePath).replace(/\\/g, '/');
            fileList.push(relativePath);
        }
    });

    return fileList;
};

export async function GET() {
    try {
        const rootDir = process.cwd(); // L·∫•y th∆∞ m·ª•c g·ªëc c·ªßa d·ª± √°n
        const files = getFiles(rootDir, [], rootDir);
        return NextResponse.json({ files });
    } catch (error) {
        return NextResponse.json({ error: 'L·ªói ƒë·ªçc file h·ªá th·ªëng' }, { status: 500 });
    }
}
</file>

<file path="api/fs/manager/route.ts">
import { NextResponse } from 'next/server';
import fs from 'fs';
import path from 'path';

// üõ°Ô∏è B·∫¢O M·∫¨T
const isDev = process.env.NODE_ENV === 'development';

export async function POST(req: Request) {
    // üõë CH·∫∂N TUY·ªÜT ƒê·ªêI
    if (!isDev) {
        return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }

    try {
        const { action, path: targetPath, newName, type } = await req.json();
        
        // üõ°Ô∏è B·∫¢O M·∫¨T PATH
        if (targetPath.includes('..')) return NextResponse.json({ error: 'Invalid path' }, { status: 400 });

        const fullPath = path.join(process.cwd(), targetPath);

        switch (action) {
            case 'create':
                if (type === 'folder') {
                    if (!fs.existsSync(fullPath)) fs.mkdirSync(fullPath, { recursive: true });
                } else {
                    if (!fs.existsSync(fullPath)) fs.writeFileSync(fullPath, '', 'utf-8');
                }
                break;

            case 'rename':
                // üõ°Ô∏è B·∫£o m·∫≠t t√™n m·ªõi
                if (!newName || newName.includes('/') || newName.includes('\\')) {
                    return NextResponse.json({ error: 'T√™n file kh√¥ng h·ª£p l·ªá' }, { status: 400 });
                }
                const newPath = path.join(path.dirname(fullPath), newName);
                if (fs.existsSync(fullPath)) fs.renameSync(fullPath, newPath);
                break;

            case 'delete':
                if (fs.existsSync(fullPath)) {
                    // üõ°Ô∏è CH·ªêNG X√ìA NH·∫¶M FILE H·ªÜ TH·ªêNG
                    if (fullPath === process.cwd()) {
                         return NextResponse.json({ error: 'Kh√¥ng th·ªÉ x√≥a root' }, { status: 403 });
                    }
                    fs.rmSync(fullPath, { recursive: true, force: true });
                }
                break;
                
            default:
                return NextResponse.json({ error: 'H√†nh ƒë·ªông kh√¥ng h·ª£p l·ªá' }, { status: 400 });
        }

        return NextResponse.json({ success: true });
    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="api/fs/open/route.ts">
import { NextResponse } from 'next/server';
import { exec } from 'child_process';
import path from 'path';

const isDev = process.env.NODE_ENV === 'development';

export async function POST(req: Request) {
    if (!isDev) return NextResponse.json({ error: 'Forbidden' }, { status: 403 });

    try {
        const { filePath } = await req.json();
        if (filePath.includes('..')) return NextResponse.json({ error: 'Invalid path' }, { status: 400 });
        
        const fullPath = path.join(process.cwd(), filePath); 

        let command = '';
        
        // üõ°Ô∏è B·∫¢O M·∫¨T: Ch·ªâ cho ph√©p m·ªü file, kh√¥ng inject l·ªánh l·∫°
        // S·ª≠ d·ª•ng JSON.stringify ƒë·ªÉ escape ƒë∆∞·ªùng d·∫´n, tr√°nh injection
        switch (process.platform) {
            case 'win32': 
                command = `explorer /select,${JSON.stringify(fullPath)}`; 
                break;
            case 'darwin': 
                command = `open -R ${JSON.stringify(fullPath)}`;
                break;
            default: 
                command = `xdg-open ${JSON.stringify(path.dirname(fullPath))}`;
        }

        exec(command, (error) => {
            if (error) console.error("L·ªói m·ªü th∆∞ m·ª•c:", error);
        });

        return NextResponse.json({ success: true });
    } catch (error) {
        return NextResponse.json({ error: 'L·ªói server' }, { status: 500 });
    }
}
</file>

<file path="api/push/subscribe/route.ts">
import { NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY! // D√πng Service Key ƒë·ªÉ bypass RLS n·∫øu c·∫ßn
);

export async function POST(req: Request) {
    try {
        const { subscription, user_id, user_agent } = await req.json();

        if (!subscription || !subscription.endpoint || !user_id) {
            return NextResponse.json({ error: 'Missing data' }, { status: 400 });
        }

        // L∆∞u v√†o DB
        const { error } = await supabase.from('push_subscriptions').upsert({
            user_id,
            endpoint: subscription.endpoint,
            p256dh: subscription.keys.p256dh,
            auth: subscription.keys.auth,
            user_agent: user_agent,
            created_at: new Date().toISOString()
        }, { onConflict: 'user_id, endpoint' });

        if (error) throw error;

        return NextResponse.json({ success: true });
    } catch (error: any) {
        console.error('Subscribe Error:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="api/push/subscribe/send/route.ts">
import { NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import webPush from 'web-push';

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

// C·∫•u h√¨nh Web Push
webPush.setVapidDetails(
    process.env.VAPID_SUBJECT!,
    process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY!,
    process.env.VAPID_PRIVATE_KEY!
);

export async function POST(req: Request) {
    try {
        // userId: Ng∆∞·ªùi nh·∫≠n, title: Ti√™u ƒë·ªÅ, body: N·ªôi dung, url: Link ƒë√≠ch
        const { userId, title, body, url } = await req.json();

        // 1. L·∫•y danh s√°ch thi·∫øt b·ªã c·ªßa User ƒë√≥
        const { data: subs } = await supabase
            .from('push_subscriptions')
            .select('*')
            .eq('user_id', userId);

        if (!subs || subs.length === 0) {
            return NextResponse.json({ message: 'User has no subscriptions' });
        }

        // 2. G·ª≠i th√¥ng b√°o ƒë·∫øn T·∫§T C·∫¢ thi·∫øt b·ªã c·ªßa h·ªç
        const notifications = subs.map(sub => {
            const pushConfig = {
                endpoint: sub.endpoint,
                keys: { auth: sub.auth, p256dh: sub.p256dh }
            };
            const payload = JSON.stringify({ title, body, url });

            return webPush.sendNotification(pushConfig, payload).catch(err => {
                if (err.statusCode === 410 || err.statusCode === 404) {
                    // Thi·∫øt b·ªã ƒë√£ h·ªßy ƒëƒÉng k√Ω ho·∫∑c l·ªói -> X√≥a kh·ªèi DB cho s·∫°ch
                    console.log('Subscription expired, deleting from DB:', sub.id);
                    supabase.from('push_subscriptions').delete().eq('id', sub.id).then();
                }
            });
        });

        await Promise.all(notifications);

        return NextResponse.json({ success: true, count: subs.length });
    } catch (error: any) {
        console.error('Push Error:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="api/sync-users/route.ts">
import { createClient } from '@supabase/supabase-js';
import { NextResponse } from 'next/server';

const supabaseAdmin = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!, 
    {
        auth: {
            autoRefreshToken: false,
            persistSession: false
        }
    }
);

export async function POST(req: Request) {
    try {
        // üõ°Ô∏è B·∫¢O M·∫¨T: Ki·ªÉm tra Secret Key t·ª´ Header
        const authHeader = req.headers.get('x-admin-secret');
        if (authHeader !== process.env.ADMIN_SECRET_KEY) {
             console.warn("‚ö†Ô∏è Truy c·∫≠p tr√°i ph√©p v√†o /api/sync-users");
             return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
        }

        console.log("--- B·∫ÆT ƒê·∫¶U ƒê·ªíNG B·ªò USER ---");

        // 1. L·∫•y danh s√°ch nh√¢n s·ª±
        const { data: employees, error: empError } = await supabaseAdmin
            .from('nhan_su')
            .select('*');

        if (empError) throw new Error("L·ªói l·∫•y d·ªØ li·ªáu nh√¢n s·ª±: " + empError.message);
        if (!employees) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu nh√¢n s·ª±");

        // 2. L·∫•y danh s√°ch Users hi·ªán t·∫°i t·ª´ Auth
        const { data: { users: authUsers }, error: authError } = await supabaseAdmin.auth.admin.listUsers();
        if (authError) throw new Error("L·ªói l·∫•y danh s√°ch Auth Users: " + authError.message);

        let added = 0;
        let updated = 0;
        let deleted = 0;

        // 3. X·ª¨ L√ù: TH√äM HO·∫∂C C·∫¨P NH·∫¨T
        for (const emp of employees) {
            if (!emp.email) continue; 

            const existingUser = authUsers.find(u => u.email === emp.email);

            if (!existingUser) {
                // -> Ch∆∞a c√≥ User -> T·∫†O M·ªöI
                const { error: createError } = await supabaseAdmin.auth.admin.createUser({
                    email: emp.email,
                    password: '12345678', 
                    email_confirm: true,
                    user_metadata: { 
                        full_name: emp.ten_hien_thi || emp.ten_day_du || 'Nh√¢n vi√™n',
                        source: 'auto_sync' 
                    }
                });
                
                if (createError) console.error(`L·ªói t·∫°o user ${emp.email}:`, createError.message);
                else added++;

            } else {
                // -> ƒê√£ c√≥ User -> C·∫¨P NH·∫¨T
                const currentName = existingUser.user_metadata?.full_name;
                const newName = emp.ten_hien_thi || emp.ten_day_du;

                if (newName && currentName !== newName) {
                    await supabaseAdmin.auth.admin.updateUserById(existingUser.id, {
                        user_metadata: { ...existingUser.user_metadata, full_name: newName }
                    });
                    updated++;
                }
            }
        }

        // 4. X·ª¨ L√ù: X√ìA
        const empEmails = new Set(employees.map(e => e.email));

        for (const user of authUsers) {
            // Logic an to√†n: Kh√¥ng x√≥a Super Admin (nh·ªØng user c√≥ email ƒë·∫∑c bi·ªát ho·∫∑c id c·ªë ƒë·ªãnh)
            // V√≠ d·ª•: Gi·ªØ l·∫°i admin@local
            if (user.email === 'admin@local') continue;

            if (user.email && !empEmails.has(user.email)) {
                 // Ch·ªâ x√≥a user ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông ƒë·ªÉ an to√†n
                 if (user.user_metadata?.source === 'auto_sync') {
                    await supabaseAdmin.auth.admin.deleteUser(user.id);
                    deleted++;
                 }
            }
        }

        return NextResponse.json({ 
            success: true, 
            message: "ƒê·ªìng b·ªô th√†nh c√¥ng",
            added, 
            updated, 
            deleted 
        });

    } catch (error: any) {
        console.error(error);
        return NextResponse.json({ success: false, error: error.message }, { status: 500 });
    }
}
</file>

<file path="components/cacchucnang/index.ts">
/**
 * ============================================================
 * C√ÅC CH·ª®C NƒÇNG - PH√íNG CHU·∫®N
 * ============================================================
 * 
 * Th∆∞ m·ª•c ch·ª©a t·∫•t c·∫£ c√°c ch·ª©c nƒÉng d√πng chung.
 * M·ªói ch·ª©c nƒÉng n·∫±m trong 1 folder ri√™ng.
 * 
 * C·∫§U TR√öC:
 * cacchucnang/
 * ‚îú‚îÄ‚îÄ nhansu/          - Qu·∫£n l√Ω nh√¢n s·ª±
 * ‚îú‚îÄ‚îÄ khachhang/       - Qu·∫£n l√Ω kh√°ch h√†ng (TODO)
 * ‚îú‚îÄ‚îÄ donhang/         - Qu·∫£n l√Ω ƒë∆°n h√†ng (TODO)
 * ‚îú‚îÄ‚îÄ vattu/           - Qu·∫£n l√Ω v·∫≠t t∆∞ kho (TODO)
 * ‚îî‚îÄ‚îÄ thuchi/          - Qu·∫£n l√Ω thu chi (TODO)
 * 
 * C√ÅCH S·ª¨ D·ª§NG:
 * import { NhanSuChucNang } from '@/app/components/cacchucnang';
 */

// Nh√¢n s·ª±
export { NhanSuChucNang, createNhanSuConfig, type NhanSu, type NhanSuPermissions } from './nhansu';

// TODO: Th√™m c√°c ch·ª©c nƒÉng kh√°c
// export { KhachHangChucNang } from './khachhang';
// export { DonHangChucNang } from './donhang';
// export { VatTuChucNang } from './vattu';
// export { ThuChiChucNang } from './thuchi';
</file>

<file path="components/cacchucnang/khachhang/config.ts">
/**
 * ============================================================
 * CH·ª®C NƒÇNG: KH√ÅCH H√ÄNG
 * ƒê∆∞·ªùng d·∫´n: phongchuan/cacchucnang/khachhang
 * ============================================================
 * 
 * Ch·ª©c nƒÉng qu·∫£n l√Ω kh√°ch h√†ng d√πng chung cho nhi·ªÅu ph√≤ng.
 * M·ªói ph√≤ng g·ªçi ra v·ªõi quy·ªÅn kh√°c nhau th√¥ng qua props.
 * 
 * QUY·ªÄN H·∫†N:
 * - allowView: Xem danh s√°ch v√† chi ti·∫øt
 * - allowEdit: S·ª≠a th√¥ng tin
 * - allowDelete: X√≥a kh√°ch h√†ng
 * - allowBulk: Thao t√°c h√†ng lo·∫°t
 * 
 * S·ª¨ D·ª§NG:
 * import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
 * <KhachHangChucNang permissions={{ allowDelete: true }} />
 */

import { Phone, Mail, MapPin, User } from 'lucide-react';
import { ManagerConfig, FieldConfig, FilterTabConfig, TabConfig } from '../types';
import { 
    getKhachHangDataAction, 
    createKhachHangAction, 
    updateKhachHangAction, 
    deleteKhachHangAction 
} from '@/app/actions/QuyenHanQuanLy';

// ============================================================
// INTERFACE
// ============================================================

export interface KhachHang {
    id: string;
    ho_ten: string;
    so_dien_thoai?: string;
    email?: string;
    dia_chi?: string;
    phan_loai?: string;
    phan_loai_normalized?: string;
    hinh_anh?: string;
    ghi_chu?: string;
    tong_don_hang?: number;
    tao_luc?: string;
    cap_nhat_luc?: string;
}

export interface KhachHangPermissions {
    allowView?: boolean;
    allowEdit?: boolean;
    allowDelete?: boolean;
    allowBulk?: boolean;
}

// ============================================================
// CONSTANTS
// ============================================================

export const PHAN_LOAI_OPTIONS = [
    'Ti·ªÅm nƒÉng',
    'M·ªõi',
    'Th√¢n thi·∫øt',
    'VIP',
    'Kh√¥ng ho·∫°t ƒë·ªông',
];

// ============================================================
// FIELDS CONFIG
// ============================================================

const fields: FieldConfig[] = [
    {
        key: 'hinh_anh',
        label: '·∫¢nh ƒë·∫°i di·ªán',
        type: 'image',
        showInForm: true,
        showInDetail: false,
        showInCard: true,
    },
    {
        key: 'ho_ten',
        label: 'H·ªç v√† T√™n',
        type: 'text',
        placeholder: 'Nh·∫≠p h·ªç t√™n ƒë·∫ßy ƒë·ªß...',
        required: true,
    },
    {
        key: 'so_dien_thoai',
        label: 'S·ªë ƒëi·ªán tho·∫°i',
        type: 'phone',
        placeholder: '09xxxxxxxxx',
        required: true,
        icon: Phone,
    },
    {
        key: 'email',
        label: 'Email',
        type: 'email',
        placeholder: 'email@example.com',
        icon: Mail,
        colSpan: 2,
    },
    {
        key: 'dia_chi',
        label: 'ƒê·ªãa ch·ªâ',
        type: 'textarea',
        placeholder: 'Nh·∫≠p ƒë·ªãa ch·ªâ...',
        icon: MapPin,
        colSpan: 2,
    },
    {
        key: 'phan_loai',
        label: 'Ph√¢n lo·∫°i',
        type: 'select',
        options: PHAN_LOAI_OPTIONS,
    },
    {
        key: 'ghi_chu',
        label: 'Ghi ch√∫',
        type: 'textarea',
        placeholder: 'Ghi ch√∫ th√™m...',
        colSpan: 2,
    },
];

// ============================================================
// FILTER TABS
// ============================================================

const filterTabs: FilterTabConfig[] = [
    { id: 'tiemnang', label: 'TI·ªÄM NƒÇNG', filterField: 'phan_loai_normalized' },
    { id: 'moi', label: 'M·ªöI', filterField: 'phan_loai_normalized' },
    { id: 'thanthiet', label: 'TH√ÇN THI·∫æT', filterField: 'phan_loai_normalized' },
    { id: 'vip', label: 'VIP', filterField: 'phan_loai_normalized' },
    { id: 'khonghoatdong', label: 'KH√îNG Hƒê', filterField: 'phan_loai_normalized' },
];

// ============================================================
// DETAIL TABS
// ============================================================

const detailTabs: TabConfig[] = [
    { id: 'thongtin', label: 'TH√îNG TIN' },
    { id: 'donhang', label: 'ƒê∆†N H√ÄNG', searchable: true, sortable: true },
    { id: 'ghichu', label: 'GHI CH√ö' },
];

// ============================================================
// DATA SOURCE
// ============================================================

const dataSource = {
    fetchList: async (page: number, limit: number, search: string, filter: string) => {
        const res = await getKhachHangDataAction(page, limit, search, filter);
        return { success: res.success, data: res.data as KhachHang[] | undefined, error: res.error };
    },
    create: async (data: Partial<KhachHang>) => {
        if (data.phan_loai) {
            (data as any).phan_loai_normalized = data.phan_loai.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "").toLowerCase();
        }
        const res = await createKhachHangAction(data as any);
        return { success: res.success, data: (res as any).data as KhachHang, error: res.error };
    },
    update: async (id: string, data: Partial<KhachHang>) => {
        if (data.phan_loai) {
            (data as any).phan_loai_normalized = data.phan_loai.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "").toLowerCase();
        }
        const res = await updateKhachHangAction(id, data as any);
        return { success: res.success, data: (res as any).data as KhachHang, error: res.error };
    },
    delete: async (id: string) => {
        const res = await deleteKhachHangAction(id);
        return { success: res.success, error: res.error };
    },
};

// ============================================================
// CREATE CONFIG FUNCTION
// ============================================================

export function createKhachHangConfig(permissions: KhachHangPermissions = {}): ManagerConfig<KhachHang> {
    const { 
        allowView = true, 
        allowEdit = true, 
        allowDelete = false, 
        allowBulk = false 
    } = permissions;

    return {
        entityName: 'kh√°ch h√†ng',
        entityNamePlural: 'kh√°ch h√†ng',
        idField: 'id',
        fields,
        cardConfig: {
            avatarField: 'hinh_anh',
            titleField: 'ho_ten',
            subtitleField: 'phan_loai',
            infoFields: [{ field: 'so_dien_thoai', icon: Phone }],
        },
        filterTabs,
        detailTabs,
        actions: {
            allowView,
            allowEdit,
            allowDelete,
            allowBulkSelect: allowBulk,
            allowBulkDelete: allowBulk && allowDelete,
        },
        dataSource,
        searchFields: ['ho_ten', 'so_dien_thoai', 'email'],
        sortOptions: [
            { key: 'name', label: 'T√äN', sortFn: (a: KhachHang, b: KhachHang) => (a.ho_ten || '').localeCompare(b.ho_ten || '') },
            { key: 'phanloai', label: 'PH√ÇN LO·∫†I', sortFn: (a: KhachHang, b: KhachHang) => (a.phan_loai || '').localeCompare(b.phan_loai || '') },
            { key: 'ngay', label: 'NG√ÄY T·∫†O', sortFn: (a: KhachHang, b: KhachHang) => new Date(b.tao_luc || 0).getTime() - new Date(a.tao_luc || 0).getTime() },
        ],
        defaultSort: 'name',
        uploadConfig: { bucket: 'avatar', fileNamePrefix: 'kh' },
    };
}
</file>

<file path="components/cacchucnang/khachhang/index.ts">
export { default as KhachHangChucNang } from './KhachHangChucNang';
export { createKhachHangConfig, PHAN_LOAI_OPTIONS } from './config';
export type { KhachHang, KhachHangPermissions } from './config';
</file>

<file path="components/cacchucnang/khachhang/KhachHangChucNang.tsx">
/**
 * ============================================================
 * COMPONENT: KH√ÅCH H√ÄNG
 * ============================================================
 *
 * S·ª≠ d·ª•ng KhungGiaoDien ƒë·ªÉ ƒë·ªìng b·ªô giao di·ªán.
 * 3 ch·∫ø ƒë·ªô view: List | Detail | Form (inline, kh√¥ng popup)
 */

"use client";

import React, { useState, useEffect, useMemo, useCallback } from "react";
import {
  User,
  Phone,
  Mail,
  MapPin,
  ShoppingBag,
  Calendar,
  Trash2,
} from "lucide-react";
import {
  KhungDanhSach,
  KhungChiTiet,
  KhungForm,
} from "@/app/components/KhungGiaoDien";
import ConfirmDialog from "@/app/components/ConfirmDialog";
import {
  KhachHang,
  KhachHangPermissions,
  createKhachHangConfig,
  PHAN_LOAI_OPTIONS,
} from "./config";

// ============================================================
// PROPS
// ============================================================

interface Props {
  permissions?: KhachHangPermissions;
  className?: string;
}

// ============================================================
// HELPER
// ============================================================

const toNonAccent = (str: string) =>
  str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "")
    .toLowerCase();

const getPhanLoaiStyle = (phanLoai?: string) => {
  const styles: Record<string, string> = {
    "Ti·ªÅm nƒÉng": "bg-blue-500/20 text-blue-400 border-blue-500/40",
    M·ªõi: "bg-green-500/20 text-green-400 border-green-500/40",
    "Th√¢n thi·∫øt": "bg-purple-500/20 text-purple-400 border-purple-500/40",
    VIP: "bg-yellow-500/20 text-yellow-400 border-yellow-500/40",
    "Kh√¥ng ho·∫°t ƒë·ªông": "bg-gray-500/20 text-gray-400 border-gray-500/40",
  };
  return (
    styles[phanLoai || ""] || "bg-gray-500/20 text-gray-400 border-gray-500/40"
  );
};

// ============================================================
// COMPONENT
// ============================================================

export default function KhachHangChucNang({
  permissions = {},
  className = "",
}: Props) {
  const config = createKhachHangConfig(permissions);
  const {
    allowView = true,
    allowEdit = true,
    allowDelete = false,
    allowBulk = false,
  } = permissions;

  // ========== STATE ==========
  const [items, setItems] = useState<KhachHang[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [activeTab, setActiveTab] = useState("all");
  const [sortBy, setSortBy] = useState("name");

  // VIEW STATE: 'list' | 'detail' | 'form'
  const [viewMode, setViewMode] = useState<"list" | "detail" | "form">("list");
  const [selectedItem, setSelectedItem] = useState<KhachHang | null>(null);
  const [detailTab, setDetailTab] = useState("thongtin");

  const [bulkMode, setBulkMode] = useState(false);
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [confirmDelete, setConfirmDelete] = useState<{
    show: boolean;
    ids: string[];
  }>({ show: false, ids: [] });

  const [formData, setFormData] = useState<Partial<KhachHang>>({});
  const [saving, setSaving] = useState(false);

  // ========== FETCH DATA ==========
  const fetchData = useCallback(async () => {
    setLoading(true);
    try {
      // üõ†Ô∏è FIX: Ki·ªÉm tra dataSource v√† method t·ªìn t·∫°i
      if (config.dataSource?.fetchList) {
        const res = await config.dataSource.fetchList(1, 50, "", "");
        if (res.success && res.data) setItems(res.data);
      }
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  }, [config.dataSource]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  // ========== TABS v·ªõi COUNT ==========
  const tabs = useMemo(() => {
    const counts: Record<string, number> = { all: items.length };
    config.filterTabs?.forEach((tab) => {
      // üõ†Ô∏è FIX: Ki·ªÉm tra id v√† filterField
      if (tab.id && tab.filterField) {
        counts[tab.id] = items.filter(
          (i) => (i as any)[tab.filterField!] === tab.id
        ).length;
      }
    });

    const dynamicTabs =
      config.filterTabs?.map((t) => ({
        id: t.id || "", // Fallback ID r·ªóng
        label: t.label,
        count: t.id ? counts[t.id] || 0 : 0,
      })) || [];

    return [{ id: "all", label: "T·∫§T C·∫¢", count: counts.all }, ...dynamicTabs];
  }, [items, config.filterTabs]);

  // ========== FILTERED & SORTED ==========
  const filteredList = useMemo(() => {
    let result = items;

    // Filter by tab
    if (activeTab !== "all") {
      result = result.filter((i) => i.phan_loai_normalized === activeTab);
    }

    // Search
    if (searchTerm) {
      const term = toNonAccent(searchTerm);
      result = result.filter((i) => {
        const hoTen = toNonAccent(i.ho_ten || "");
        const match =
          hoTen.includes(term) ||
          (i.so_dien_thoai || "").includes(term) ||
          toNonAccent(i.email || "").includes(term);
        return match;
      });
    }

    // Sort
    const sortOpt = config.sortOptions?.find((s) => s.key === sortBy);
    if (sortOpt?.sortFn) {
      result = [...result].sort(sortOpt.sortFn);
    }

    return result;
  }, [items, activeTab, searchTerm, sortBy, config.sortOptions]);

  // ========== HANDLERS ==========
  const handleOpenDetail = (item: KhachHang) => {
    setSelectedItem(item);
    setDetailTab("thongtin");
    setViewMode("detail");
  };

  const handleOpenForm = (item?: KhachHang) => {
    setFormData(item ? { ...item } : {});
    setSelectedItem(item || null);
    setViewMode("form");
  };

  const handleBackToList = () => {
    setViewMode("list");
    setSelectedItem(null);
  };

  const handleSave = async () => {
    setSaving(true);
    try {
      // üõ†Ô∏è FIX: Ki·ªÉm tra dataSource tr∆∞·ªõc khi g·ªçi
      if (selectedItem?.id) {
        if (config.dataSource?.update) {
          await config.dataSource.update(selectedItem.id, formData);
        }
      } else {
        if (config.dataSource?.create) {
          await config.dataSource.create(formData);
        }
      }
      await fetchData();
      handleBackToList();
    } catch (e) {
      console.error(e);
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (ids: string[]) => {
    // üõ†Ô∏è FIX: Ki·ªÉm tra delete method
    if (config.dataSource?.delete) {
      for (const id of ids) {
        await config.dataSource.delete(id);
      }
      await fetchData();
      setSelectedIds(new Set());
      setConfirmDelete({ show: false, ids: [] });
      handleBackToList();
    }
  };

  const toggleSelect = (id: string) => {
    const newSet = new Set(selectedIds);
    if (newSet.has(id)) newSet.delete(id);
    else newSet.add(id);
    setSelectedIds(newSet);
  };

  // ========== DETAIL TABS COUNT ==========
  const detailTabCounts = useMemo(
    () => ({
      thongtin: 4,
      donhang: 0,
      ghichu: selectedItem?.ghi_chu ? 1 : 0,
    }),
    [selectedItem]
  );

  // ========== RENDER ==========
  return (
    <div className={`h-full ${className}`}>
      {/* ====== CH·∫æ ƒê·ªò DANH S√ÅCH ====== */}
      {viewMode === "list" && (
        <KhungDanhSach
          tabs={tabs}
          activeTab={activeTab}
          onTabChange={setActiveTab}
          onSearch={setSearchTerm} // üõ†Ô∏è FIX: ƒê√£ x√≥a searchPlaceholder
          sortOptions={
            config.sortOptions?.map((s) => ({ key: s.key, label: s.label })) ||
            []
          }
          activeSort={sortBy}
          onSortChange={setSortBy}
          showAddButton={allowEdit}
          onAdd={() => handleOpenForm()}
          bulkMode={bulkMode}
          onBulkModeToggle={
            allowBulk ? () => setBulkMode(!bulkMode) : undefined
          }
          selectedCount={selectedIds.size}
          onSelectAll={() =>
            setSelectedIds(new Set(filteredList.map((i) => i.id)))
          }
          onClearSelection={() => setSelectedIds(new Set())}
          bulkActions={
            allowDelete
              ? [
                  {
                    id: "delete",
                    label: "X√ìA",
                    icon: Trash2,
                    color: "danger",
                    onClick: () =>
                      setConfirmDelete({
                        show: true,
                        ids: Array.from(selectedIds),
                      }),
                  },
                ]
              : []
          }
          loading={loading}
        >
          {/* Cards */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 p-4">
            {filteredList.map((item) => (
              <div
                key={item.id}
                onClick={() => !bulkMode && handleOpenDetail(item)}
                className={`group relative bg-[#0f0f0f] border rounded-xl overflow-hidden cursor-pointer transition-all hover:border-[#C69C6D]/50 hover:shadow-lg ${
                  selectedIds.has(item.id)
                    ? "border-[#C69C6D] bg-[#C69C6D]/5"
                    : "border-white/10"
                }`}
              >
                {/* Bulk checkbox */}
                {bulkMode && (
                  <div
                    onClick={(e) => {
                      e.stopPropagation();
                      toggleSelect(item.id);
                    }}
                    className="absolute top-3 right-3 z-10"
                  >
                    <div
                      className={`w-5 h-5 rounded border-2 flex items-center justify-center transition-colors ${
                        selectedIds.has(item.id)
                          ? "bg-[#C69C6D] border-[#C69C6D]"
                          : "border-white/30 bg-black/50"
                      }`}
                    >
                      {selectedIds.has(item.id) && (
                        <span className="text-black text-xs">‚úì</span>
                      )}
                    </div>
                  </div>
                )}

                <div className="p-4 flex items-center gap-4">
                  {/* Avatar */}
                  <div className="w-14 h-14 rounded-full bg-[#1a1a1a] border-2 border-[#C69C6D]/30 overflow-hidden shrink-0">
                    {item.hinh_anh ? (
                      <img
                        src={item.hinh_anh}
                        alt=""
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center text-[#C69C6D]/50">
                        <User size={24} />
                      </div>
                    )}
                  </div>

                  {/* Info */}
                  <div className="flex-1 min-w-0">
                    <h3 className="font-bold text-white truncate">
                      {item.ho_ten}
                    </h3>
                    <span
                      className={`inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase border ${getPhanLoaiStyle(
                        item.phan_loai
                      )}`}
                    >
                      {item.phan_loai || "Ch∆∞a ph√¢n lo·∫°i"}
                    </span>
                    <p className="text-xs text-white/40 truncate mt-1">
                      <Phone size={10} className="inline mr-1" />
                      {item.so_dien_thoai || "---"}
                    </p>
                  </div>
                </div>
              </div>
            ))}

            {filteredList.length === 0 && !loading && (
              <div className="col-span-full py-20 text-center text-white/30">
                Kh√¥ng c√≥ d·ªØ li·ªáu
              </div>
            )}
          </div>
        </KhungDanhSach>
      )}

      {/* ====== CH·∫æ ƒê·ªò CHI TI·∫æT ====== */}
      {viewMode === "detail" && selectedItem && (
        <KhungChiTiet
          data={selectedItem}
          onClose={handleBackToList}
          avatar={selectedItem.hinh_anh}
          avatarFallback={<User size={10} className="text-[#C69C6D]/50" />}
          title={selectedItem.ho_ten}
          tabs={[
            { id: "thongtin", label: "TH√îNG TIN" },
            { id: "donhang", label: "ƒê∆†N H√ÄNG" },
            { id: "ghichu", label: "GHI CH√ö" },
          ]}
          activeTab={detailTab}
          onTabChange={setDetailTab}
          tabCounts={detailTabCounts}
          showEditButton={allowEdit}
          showDeleteButton={allowDelete}
          onEdit={() => handleOpenForm(selectedItem)}
          onDelete={() =>
            setConfirmDelete({ show: true, ids: [selectedItem.id] })
          }
        >
          <div className="p-4">
            {detailTab === "thongtin" && (
              <div className="space-y-3">
                <InfoRow
                  icon={Phone}
                  label="S·ªê ƒêI·ªÜN THO·∫†I"
                  value={selectedItem.so_dien_thoai}
                  action={() =>
                    window.open(`tel:${selectedItem.so_dien_thoai}`)
                  }
                />
                <InfoRow icon={Mail} label="EMAIL" value={selectedItem.email} />
                <InfoRow
                  icon={MapPin}
                  label="ƒê·ªäA CH·ªà"
                  value={selectedItem.dia_chi}
                />
                <InfoRow
                  icon={Calendar}
                  label="NG√ÄY THAM GIA"
                  value={
                    selectedItem.tao_luc
                      ? new Date(selectedItem.tao_luc).toLocaleDateString(
                          "vi-VN"
                        )
                      : undefined
                  }
                />
              </div>
            )}
            {detailTab === "donhang" && (
              <div className="flex flex-col items-center justify-center py-10 text-white/30">
                <ShoppingBag size={40} className="mb-3 opacity-30" />
                <p className="text-sm">Ch∆∞a c√≥ ƒë∆°n h√†ng</p>
              </div>
            )}
            {detailTab === "ghichu" && (
              <div className="p-4 bg-[#151515] rounded-xl border border-white/5 min-h-[100px]">
                <p className="text-sm text-white/60 whitespace-pre-wrap">
                  {selectedItem.ghi_chu || "Ch∆∞a c√≥ ghi ch√∫"}
                </p>
              </div>
            )}
          </div>
        </KhungChiTiet>
      )}

      {/* ====== CH·∫æ ƒê·ªò FORM ====== */}
      {viewMode === "form" && (
        <KhungForm
          isEditing={!!selectedItem}
          data={formData}
          onClose={handleBackToList}
          title={selectedItem ? selectedItem.ho_ten : "TH√äM KH√ÅCH H√ÄNG"}
          avatar={selectedItem?.hinh_anh}
          avatarFallback={<User size={10} className="text-[#C69C6D]/50" />}
          showAvatarUpload={true}
          onSubmit={handleSave}
          loading={saving}
          isDirty={Object.keys(formData).length > 0}
        >
          <div className="space-y-4">
            <FormField label="H·ªç v√† T√™n" required>
              <input
                type="text"
                value={formData.ho_ten || ""}
                onChange={(e) =>
                  setFormData({ ...formData, ho_ten: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                placeholder="Nh·∫≠p h·ªç t√™n..."
              />
            </FormField>

            <div className="grid grid-cols-2 gap-4">
              <FormField label="S·ªë ƒëi·ªán tho·∫°i" required>
                <input
                  type="tel"
                  value={formData.so_dien_thoai || ""}
                  onChange={(e) =>
                    setFormData({ ...formData, so_dien_thoai: e.target.value })
                  }
                  className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                  placeholder="09..."
                />
              </FormField>
              <FormField label="Email">
                <input
                  type="email"
                  value={formData.email || ""}
                  onChange={(e) =>
                    setFormData({ ...formData, email: e.target.value })
                  }
                  className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                  placeholder="email@..."
                />
              </FormField>
            </div>

            <FormField label="Ph√¢n lo·∫°i">
              <select
                value={formData.phan_loai || ""}
                onChange={(e) =>
                  setFormData({ ...formData, phan_loai: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white focus:border-[#C69C6D]/50 focus:outline-none"
              >
                <option value="">Ch·ªçn ph√¢n lo·∫°i...</option>
                {PHAN_LOAI_OPTIONS.map((opt) => (
                  <option key={opt} value={opt}>
                    {opt}
                  </option>
                ))}
              </select>
            </FormField>

            <FormField label="ƒê·ªãa ch·ªâ">
              <textarea
                value={formData.dia_chi || ""}
                onChange={(e) =>
                  setFormData({ ...formData, dia_chi: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none resize-none"
                rows={2}
                placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ..."
              />
            </FormField>

            <FormField label="Ghi ch√∫">
              <textarea
                value={formData.ghi_chu || ""}
                onChange={(e) =>
                  setFormData({ ...formData, ghi_chu: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none resize-none"
                rows={3}
                placeholder="Ghi ch√∫ th√™m..."
              />
            </FormField>
          </div>
        </KhungForm>
      )}

      {/* ====== CONFIRM DELETE ====== */}
      <ConfirmDialog
        isOpen={confirmDelete.show}
        title="X√ÅC NH·∫¨N X√ìA"
        message={`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${confirmDelete.ids.length} kh√°ch h√†ng?`}
        onConfirm={() => handleDelete(confirmDelete.ids)}
        onCancel={() => setConfirmDelete({ show: false, ids: [] })}
      />
    </div>
  );
}

// ============================================================
// SUB-COMPONENTS
// ============================================================

function InfoRow({
  icon: Icon,
  label,
  value,
  action,
}: {
  icon: any;
  label: string;
  value?: string;
  action?: () => void;
}) {
  return (
    <div className="flex items-center gap-3 p-3 rounded-xl bg-[#151515] border border-white/5 hover:border-[#C69C6D]/30 transition-colors">
      <div className="p-2 rounded-lg bg-black text-[#C69C6D]">
        <Icon size={16} />
      </div>
      <div className="flex-1 min-w-0">
        <p className="text-[9px] font-black uppercase tracking-wider text-white/40 mb-0.5">
          {label}
        </p>
        <p className="text-sm font-bold text-gray-200 truncate">
          {value || "---"}
        </p>
      </div>
      {action && value && (
        <button
          onClick={action}
          className="px-3 py-1 text-[10px] font-bold uppercase bg-[#C69C6D]/20 text-[#C69C6D] rounded hover:bg-[#C69C6D]/30"
        >
          G·ªåI
        </button>
      )}
    </div>
  );
}

function FormField({
  label,
  required,
  children,
}: {
  label: string;
  required?: boolean;
  children: React.ReactNode;
}) {
  return (
    <div>
      <label className="block text-xs font-bold text-white/60 uppercase tracking-wider mb-2">
        {label} {required && <span className="text-red-400">*</span>}
      </label>
      {children}
    </div>
  );
}
</file>

<file path="components/cacchucnang/nhansu/config.ts">
/**
 * ============================================================
 * CH·ª®C NƒÇNG: NH√ÇN S·ª∞
 * ƒê∆∞·ªùng d·∫´n: phongchuan/cacchucnang/nhansu
 * ============================================================
 * 
 * Ch·ª©c nƒÉng qu·∫£n l√Ω nh√¢n s·ª± d√πng chung cho nhi·ªÅu ph√≤ng.
 * M·ªói ph√≤ng g·ªçi ra v·ªõi quy·ªÅn kh√°c nhau th√¥ng qua props.
 * 
 * QUY·ªÄN H·∫†N:
 * - allowView: Xem danh s√°ch v√† chi ti·∫øt
 * - allowEdit: S·ª≠a th√¥ng tin
 * - allowDelete: X√≥a nh√¢n s·ª±
 * - allowBulk: Thao t√°c h√†ng lo·∫°t
 * 
 * S·ª¨ D·ª§NG:
 * import { NhanSuChucNang } from '@/app/components/cacchucnang/nhansu';
 * <NhanSuChucNang permissions={{ allowDelete: true }} />
 */

import { Phone, Mail, Banknote, Clock, Percent, ShieldCheck } from 'lucide-react';
import { ManagerConfig, FieldConfig, FilterTabConfig, TabConfig } from '../types';
import { 
    getNhanSuDataAction, 
    createNhanSuAction, 
    updateNhanSuAction, 
    deleteNhanSuAction,
    getDistinctValuesAction 
} from '@/app/actions/QuyenHanQuanLy';

// ============================================================
// INTERFACE
// ============================================================

export interface NhanSu {
    id: string;
    ho_ten: string;
    vi_tri: string;
    vi_tri_normalized: string;
    so_dien_thoai: string;
    email: string;
    hinh_anh?: string;
    trang_thai?: string;
    luong_thang?: number;
    luong_theo_gio?: number;
    thuong_doanh_thu?: number;
    ngan_hang?: string;
    so_tai_khoan?: string;
}

export interface NhanSuPermissions {
    allowView?: boolean;
    allowEdit?: boolean;
    allowDelete?: boolean;
    allowBulk?: boolean;
}

// ============================================================
// CONSTANTS
// ============================================================

const VN_BANKS = [
    "Vietcombank", "VietinBank", "BIDV", "Agribank", "Techcombank", "MBBank", 
    "ACB", "VPBank", "TPBank", "Sacombank", "HDBank", "VIB", "MSB", "SHB", 
    "SeABank", "OCB", "Eximbank", "LienVietPostBank", "Nam A Bank", "Viet Capital Bank"
];

// ============================================================
// FIELDS CONFIG
// ============================================================

const fields: FieldConfig[] = [
    {
        key: 'hinh_anh',
        label: '·∫¢nh ƒë·∫°i di·ªán',
        type: 'image',
        showInForm: true,
        showInDetail: false,
        showInCard: true,
    },
    {
        key: 'ho_ten',
        label: 'H·ªç v√† T√™n',
        type: 'text',
        placeholder: 'Nh·∫≠p h·ªç t√™n ƒë·∫ßy ƒë·ªß...',
        required: true,
    },
    {
        key: 'vi_tri',
        label: 'V·ªã tr√≠ / Ch·ª©c v·ª•',
        type: 'select-add',
        placeholder: 'Ch·ªçn ch·ª©c v·ª•...',
        required: true,
        optionsLoader: async () => {
            const res = await getDistinctValuesAction('nhan_su', 'vi_tri');
            return (res.success && res.data) ? res.data as string[] : [];
        },
    },
    {
        key: 'email',
        label: 'Email li√™n h·ªá',
        type: 'email',
        placeholder: 'email@example.com',
        required: true,
        icon: Mail,
        colSpan: 2,
    },
    {
        key: 'so_dien_thoai',
        label: 'S·ªë ƒëi·ªán tho·∫°i',
        type: 'phone',
        placeholder: '09xxxxxxxxx',
        icon: Phone,
    },
    {
        key: 'luong_thang',
        label: 'L∆∞∆°ng c·ª©ng (VNƒê)',
        type: 'money',
        placeholder: '0',
        icon: Banknote,
        highlight: true,
    },
    {
        key: 'luong_theo_gio',
        label: 'L∆∞∆°ng theo gi·ªù',
        type: 'readonly',
        icon: Clock,
        computeFrom: 'luong_thang',
        computeFn: (luongThang: any) => {
            const value = Number(luongThang) || 0;
            if (value <= 0) return '0';
            return Math.round((value / 24 / 8) / 1000) * 1000;
        },
    },
    {
        key: 'thuong_doanh_thu',
        label: 'Th∆∞·ªüng doanh s·ªë (%)',
        type: 'percent',
        placeholder: '0 - 30',
        maxValue: 30,
        icon: Percent,
    },
    {
        key: 'ngan_hang',
        label: 'Ng√¢n h√†ng',
        type: 'select',
        options: VN_BANKS,
        icon: ShieldCheck,
    },
    {
        key: 'so_tai_khoan',
        label: 'S·ªë t√†i kho·∫£n',
        type: 'text',
        placeholder: 'Nh·∫≠p s·ªë t√†i kho·∫£n...',
    },
];

// ============================================================
// FILTER TABS
// ============================================================

const filterTabs: FilterTabConfig[] = [
    { id: 'quanly', label: 'QU·∫¢N L√ù', filterField: 'vi_tri_normalized' },
    { id: 'sales', label: 'SALES', filterField: 'vi_tri_normalized' },
    { id: 'thosanxuat', label: 'TH·ª¢', filterField: 'vi_tri_normalized' },
    { id: 'parttime', label: 'PART-TIME', filterField: 'vi_tri_normalized' },
    { id: 'congtacvien', label: 'CTV', filterField: 'vi_tri_normalized' },
];

// ============================================================
// DETAIL TABS
// ============================================================

const detailTabs: TabConfig[] = [
    { id: 'hoso', label: 'H·ªí S∆†' },
    { id: 'muctieu', label: 'M·ª§C TI√äU', searchable: true, sortable: true, sortOptions: [{ key: 'name', label: 'T√äN' }, { key: 'reward', label: 'TH∆Ø·ªûNG' }], showAddButton: true },
    { id: 'thanhtich', label: 'TH√ÄNH T√çCH', searchable: true },
];

// ============================================================
// DATA SOURCE
// ============================================================

const dataSource = {
    fetchList: async (page: number, limit: number, search: string, filter: string) => {
        const res = await getNhanSuDataAction(page, limit, search, filter);
        return { success: res.success, data: res.data as NhanSu[] | undefined, error: res.error };
    },
    create: async (data: Partial<NhanSu>) => {
        if (data.vi_tri) {
            (data as any).vi_tri_normalized = data.vi_tri.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "").toLowerCase();
        }
        const res = await createNhanSuAction(data as any);
        return { success: res.success, data: (res as any).data as NhanSu, error: res.error };
    },
    update: async (id: string, data: Partial<NhanSu>) => {
        if (data.vi_tri) {
            (data as any).vi_tri_normalized = data.vi_tri.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "").toLowerCase();
        }
        const res = await updateNhanSuAction(id, data as any);
        return { success: res.success, data: (res as any).data as NhanSu, error: res.error };
    },
    delete: async (id: string) => {
        const res = await deleteNhanSuAction(id);
        return { success: res.success, error: res.error };
    },
};

// ============================================================
// CREATE CONFIG FUNCTION
// ============================================================

export function createNhanSuConfig(permissions: NhanSuPermissions = {}): ManagerConfig<NhanSu> {
    const { 
        allowView = true, 
        allowEdit = true, 
        allowDelete = false, 
        allowBulk = false 
    } = permissions;

    return {
        entityName: 'nh√¢n s·ª±',
        entityNamePlural: 'nh√¢n s·ª±',
        idField: 'id',
        fields,
        cardConfig: {
            avatarField: 'hinh_anh',
            titleField: 'ho_ten',
            subtitleField: 'vi_tri',
            infoFields: [{ field: 'so_dien_thoai', icon: Phone }],
        },
        filterTabs,
        detailTabs,
        actions: {
            allowView,
            allowEdit,
            allowDelete,
            allowBulkSelect: allowBulk,
            allowBulkDelete: allowBulk && allowDelete,
        },
        dataSource,
        searchFields: ['ho_ten', 'so_dien_thoai', 'email'],
        sortOptions: [
            { key: 'name', label: 'T√äN', sortFn: (a: NhanSu, b: NhanSu) => a.ho_ten.localeCompare(b.ho_ten) },
            { key: 'vitri', label: 'V·ªä TR√ç', sortFn: (a: NhanSu, b: NhanSu) => (a.vi_tri || '').localeCompare(b.vi_tri || '') },
            { key: 'luong', label: 'L∆Ø∆†NG', sortFn: (a: NhanSu, b: NhanSu) => (b.luong_thang || 0) - (a.luong_thang || 0) },
        ],
        defaultSort: 'name',
        uploadConfig: { bucket: 'avatar', fileNamePrefix: 'ns' },
    };
}
</file>

<file path="components/cacchucnang/nhansu/index.ts">
/**
 * CH·ª®C NƒÇNG: NH√ÇN S·ª∞
 * Export t·∫•t c·∫£ t·ª´ folder n√†y
 */

export { default as NhanSuChucNang } from './NhanSuChucNang';
export { createNhanSuConfig, type NhanSu, type NhanSuPermissions } from './config';
</file>

<file path="components/cacchucnang/nhansu/NhanSuChucNang.tsx">
/**
 * ============================================================
 * COMPONENT: NH√ÇN S·ª∞
 * ============================================================
 *
 * S·ª≠ d·ª•ng KhungGiaoDien ƒë·ªÉ ƒë·ªìng b·ªô giao di·ªán.
 * 3 ch·∫ø ƒë·ªô view: List | Detail | Form (inline, kh√¥ng popup)
 */

"use client";

import React, { useState, useEffect, useMemo, useCallback } from "react";
import { User, Phone, Mail, Banknote, Briefcase, Trash2 } from "lucide-react";
import {
  KhungDanhSach,
  KhungChiTiet,
  KhungForm,
} from "@/app/components/KhungGiaoDien";
import ConfirmDialog from "@/app/components/ConfirmDialog";
import { NhanSu, NhanSuPermissions, createNhanSuConfig } from "./config";

// ============================================================
// PROPS
// ============================================================

interface Props {
  permissions?: NhanSuPermissions;
  className?: string;
}

// ============================================================
// HELPER: Format ti·ªÅn VNƒê
// ============================================================

const formatMoney = (value: number | undefined) => {
  if (!value) return "0 ‚Ç´";
  return new Intl.NumberFormat("vi-VN", {
    style: "currency",
    currency: "VND",
  }).format(value);
};

const toNonAccent = (str: string) =>
  str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "")
    .toLowerCase();

// ============================================================
// COMPONENT
// ============================================================

export default function NhanSuChucNang({
  permissions = {},
  className = "",
}: Props) {
  console.log("üî¥ NhanSuChucNang MOUNTED - new version with KhungDanhSach");
  const config = createNhanSuConfig(permissions);
  const {
    allowView = true,
    allowEdit = true,
    allowDelete = false,
    allowBulk = false,
  } = permissions;

  // ========== STATE ==========
  const [items, setItems] = useState<NhanSu[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [activeTab, setActiveTab] = useState("all");
  const [sortBy, setSortBy] = useState("name");

  // VIEW STATE: 'list' | 'detail' | 'form'
  const [viewMode, setViewMode] = useState<"list" | "detail" | "form">("list");
  const [selectedItem, setSelectedItem] = useState<NhanSu | null>(null);
  const [detailTab, setDetailTab] = useState("hoso");

  const [bulkMode, setBulkMode] = useState(false);
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [confirmDelete, setConfirmDelete] = useState<{
    show: boolean;
    ids: string[];
  }>({ show: false, ids: [] });

  const [formData, setFormData] = useState<Partial<NhanSu>>({});
  const [saving, setSaving] = useState(false);

  // ========== FETCH DATA ==========
  const fetchData = useCallback(async () => {
    setLoading(true);
    try {
      // üõ†Ô∏è FIX: Ki·ªÉm tra k·ªπ dataSource.fetchList c√≥ t·ªìn t·∫°i kh√¥ng
      if (config.dataSource?.fetchList) {
        const res = await config.dataSource.fetchList(1, 50, "", "");
        if (res.success && res.data) setItems(res.data);
      }
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  }, [config.dataSource]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  // ========== TABS v·ªõi COUNT ==========
  const tabs = useMemo(() => {
    const counts: Record<string, number> = { all: items.length };
    config.filterTabs?.forEach((tab) => {
      // Ki·ªÉm tra an to√†n tr∆∞·ªõc khi truy c·∫≠p
      if (tab.id && tab.filterField) {
        counts[tab.id] = items.filter(
          (i) => (i as any)[tab.filterField!] === tab.id
        ).length;
      }
    });

    const dynamicTabs =
      config.filterTabs?.map((t) => ({
        id: t.id || "", // Fallback ID r·ªóng
        label: t.label,
        count: t.id ? counts[t.id] || 0 : 0,
      })) || [];

    return [{ id: "all", label: "T·∫§T C·∫¢", count: counts.all }, ...dynamicTabs];
  }, [items, config.filterTabs]);

  // ========== FILTERED & SORTED ==========
  const filteredList = useMemo(() => {
    let result = items;

    // Filter by tab
    if (activeTab !== "all") {
      result = result.filter((i) => i.vi_tri_normalized === activeTab);
    }

    // Search
    if (searchTerm) {
      const term = toNonAccent(searchTerm);
      result = result.filter((i) => {
        const hoTen = toNonAccent(i.ho_ten || "");
        const match =
          hoTen.includes(term) ||
          (i.so_dien_thoai || "").includes(term) ||
          toNonAccent(i.email || "").includes(term);
        return match;
      });
    }

    // Sort
    const sortOpt = config.sortOptions?.find((s) => s.key === sortBy);
    if (sortOpt?.sortFn) {
      result = [...result].sort(sortOpt.sortFn);
    }

    return result;
  }, [items, activeTab, searchTerm, sortBy, config.sortOptions]);

  // ========== HANDLERS ==========
  const handleOpenDetail = (item: NhanSu) => {
    setSelectedItem(item);
    setDetailTab("hoso");
    setViewMode("detail");
  };

  const handleOpenForm = (item?: NhanSu) => {
    setFormData(item ? { ...item } : {});
    setSelectedItem(item || null);
    setViewMode("form");
  };

  const handleBackToList = () => {
    setViewMode("list");
    setSelectedItem(null);
  };

  const handleSave = async () => {
    setSaving(true);
    try {
      // üõ†Ô∏è FIX: Ki·ªÉm tra create/update c√≥ t·ªìn t·∫°i kh√¥ng
      if (selectedItem?.id) {
        if (config.dataSource?.update) {
          await config.dataSource.update(selectedItem.id, formData);
        }
      } else {
        if (config.dataSource?.create) {
          await config.dataSource.create(formData);
        }
      }
      await fetchData();
      handleBackToList();
    } catch (e) {
      console.error(e);
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (ids: string[]) => {
    // üõ†Ô∏è FIX: Ki·ªÉm tra delete c√≥ t·ªìn t·∫°i kh√¥ng
    if (config.dataSource?.delete) {
      for (const id of ids) {
        await config.dataSource.delete(id);
      }
      await fetchData();
      setSelectedIds(new Set());
      setConfirmDelete({ show: false, ids: [] });
      handleBackToList();
    }
  };

  const toggleSelect = (id: string) => {
    const newSet = new Set(selectedIds);
    if (newSet.has(id)) newSet.delete(id);
    else newSet.add(id);
    setSelectedIds(newSet);
  };

  // ========== DETAIL TABS COUNT ==========
  const detailTabCounts = useMemo(
    () => ({
      hoso: 3,
      luong: 3,
      nganhang: 2,
    }),
    []
  );

  // ========== RENDER ==========
  return (
    <div className={`h-full ${className}`}>
      {/* ====== CH·∫æ ƒê·ªò DANH S√ÅCH ====== */}
      {viewMode === "list" && (
        <KhungDanhSach
          tabs={tabs}
          activeTab={activeTab}
          onTabChange={setActiveTab}
          onSearch={setSearchTerm} // üõ†Ô∏è FIX: ƒê√£ x√≥a searchPlaceholder g√¢y l·ªói
          sortOptions={
            config.sortOptions?.map((s) => ({ key: s.key, label: s.label })) ||
            []
          }
          activeSort={sortBy}
          onSortChange={setSortBy}
          showAddButton={allowEdit}
          onAdd={() => handleOpenForm()}
          bulkMode={bulkMode}
          onBulkModeToggle={
            allowBulk ? () => setBulkMode(!bulkMode) : undefined
          }
          selectedCount={selectedIds.size}
          onSelectAll={() =>
            setSelectedIds(new Set(filteredList.map((i) => i.id)))
          }
          onClearSelection={() => setSelectedIds(new Set())}
          bulkActions={
            allowDelete
              ? [
                  {
                    id: "delete",
                    label: "X√ìA",
                    icon: Trash2,
                    color: "danger",
                    onClick: () =>
                      setConfirmDelete({
                        show: true,
                        ids: Array.from(selectedIds),
                      }),
                  },
                ]
              : []
          }
          loading={loading}
        >
          {/* Cards */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 p-4">
            {filteredList.map((item) => (
              <div
                key={item.id}
                onClick={() => !bulkMode && handleOpenDetail(item)}
                className={`group relative bg-[#0f0f0f] border rounded-xl overflow-hidden cursor-pointer transition-all hover:border-[#C69C6D]/50 hover:shadow-lg ${
                  selectedIds.has(item.id)
                    ? "border-[#C69C6D] bg-[#C69C6D]/5"
                    : "border-white/10"
                }`}
              >
                {/* Bulk checkbox */}
                {bulkMode && (
                  <div
                    onClick={(e) => {
                      e.stopPropagation();
                      toggleSelect(item.id);
                    }}
                    className="absolute top-3 right-3 z-10"
                  >
                    <div
                      className={`w-5 h-5 rounded border-2 flex items-center justify-center transition-colors ${
                        selectedIds.has(item.id)
                          ? "bg-[#C69C6D] border-[#C69C6D]"
                          : "border-white/30 bg-black/50"
                      }`}
                    >
                      {selectedIds.has(item.id) && (
                        <span className="text-black text-xs">‚úì</span>
                      )}
                    </div>
                  </div>
                )}

                <div className="p-4 flex items-center gap-4">
                  {/* Avatar */}
                  <div className="w-14 h-14 rounded-full bg-[#1a1a1a] border-2 border-[#C69C6D]/30 overflow-hidden shrink-0">
                    {item.hinh_anh ? (
                      <img
                        src={item.hinh_anh}
                        alt=""
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center text-[#C69C6D]/50">
                        <User size={24} />
                      </div>
                    )}
                  </div>

                  {/* Info */}
                  <div className="flex-1 min-w-0">
                    <h3 className="font-bold text-white truncate">
                      {item.ho_ten}
                    </h3>
                    <p className="text-xs text-[#C69C6D] truncate">
                      {item.vi_tri}
                    </p>
                    <p className="text-xs text-white/40 truncate mt-1">
                      <Phone size={10} className="inline mr-1" />
                      {item.so_dien_thoai || "---"}
                    </p>
                  </div>
                </div>
              </div>
            ))}

            {filteredList.length === 0 && !loading && (
              <div className="col-span-full py-20 text-center text-white/30">
                Kh√¥ng c√≥ d·ªØ li·ªáu
              </div>
            )}
          </div>
        </KhungDanhSach>
      )}

      {/* ====== CH·∫æ ƒê·ªò CHI TI·∫æT ====== */}
      {viewMode === "detail" && selectedItem && (
        <KhungChiTiet
          data={selectedItem}
          onClose={handleBackToList}
          avatar={selectedItem.hinh_anh}
          avatarFallback={<User size={10} className="text-[#C69C6D]/50" />}
          title={selectedItem.ho_ten}
          tabs={[
            { id: "hoso", label: "H·ªí S∆†" },
            { id: "luong", label: "L∆Ø∆†NG" },
            { id: "nganhang", label: "NG√ÇN H√ÄNG" },
          ]}
          activeTab={detailTab}
          onTabChange={setDetailTab}
          tabCounts={detailTabCounts}
          showEditButton={allowEdit}
          showDeleteButton={allowDelete}
          onEdit={() => handleOpenForm(selectedItem)}
          onDelete={() =>
            setConfirmDelete({ show: true, ids: [selectedItem.id] })
          }
        >
          <div className="p-4">
            {detailTab === "hoso" && (
              <div className="space-y-3">
                <InfoRow icon={Mail} label="EMAIL" value={selectedItem.email} />
                <InfoRow
                  icon={Phone}
                  label="S·ªê ƒêI·ªÜN THO·∫†I"
                  value={selectedItem.so_dien_thoai}
                />
                <InfoRow
                  icon={Briefcase}
                  label="V·ªä TR√ç"
                  value={selectedItem.vi_tri}
                />
              </div>
            )}
            {detailTab === "luong" && (
              <div className="space-y-3">
                <InfoRow
                  icon={Banknote}
                  label="L∆Ø∆†NG TH√ÅNG"
                  value={formatMoney(selectedItem.luong_thang)}
                  highlight
                />
                <InfoRow
                  icon={Banknote}
                  label="L∆Ø∆†NG THEO GI·ªú"
                  value={formatMoney(selectedItem.luong_theo_gio)}
                />
                <InfoRow
                  icon={Banknote}
                  label="TH∆Ø·ªûNG DOANH S·ªê"
                  value={`${selectedItem.thuong_doanh_thu || 0}%`}
                />
              </div>
            )}
            {detailTab === "nganhang" && (
              <div className="space-y-3">
                <InfoRow
                  icon={Banknote}
                  label="NG√ÇN H√ÄNG"
                  value={selectedItem.ngan_hang}
                />
                <InfoRow
                  icon={Banknote}
                  label="S·ªê T√ÄI KHO·∫¢N"
                  value={selectedItem.so_tai_khoan}
                />
              </div>
            )}
          </div>
        </KhungChiTiet>
      )}

      {/* ====== CH·∫æ ƒê·ªò FORM ====== */}
      {viewMode === "form" && (
        <KhungForm
          isEditing={!!selectedItem}
          data={formData}
          onClose={handleBackToList}
          title={selectedItem ? selectedItem.ho_ten : "TH√äM NH√ÇN S·ª∞"}
          avatar={selectedItem?.hinh_anh}
          avatarFallback={<User size={10} className="text-[#C69C6D]/50" />}
          showAvatarUpload={true}
          onSubmit={handleSave}
          loading={saving}
          isDirty={Object.keys(formData).length > 0}
        >
          <div className="space-y-4">
            <FormField label="H·ªç v√† T√™n" required>
              <input
                type="text"
                value={formData.ho_ten || ""}
                onChange={(e) =>
                  setFormData({ ...formData, ho_ten: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                placeholder="Nh·∫≠p h·ªç t√™n..."
              />
            </FormField>

            <FormField label="V·ªã tr√≠" required>
              <input
                type="text"
                value={formData.vi_tri || ""}
                onChange={(e) =>
                  setFormData({ ...formData, vi_tri: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                placeholder="Nh·∫≠p v·ªã tr√≠..."
              />
            </FormField>

            <div className="grid grid-cols-2 gap-4">
              <FormField label="Email">
                <input
                  type="email"
                  value={formData.email || ""}
                  onChange={(e) =>
                    setFormData({ ...formData, email: e.target.value })
                  }
                  className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                  placeholder="email@..."
                />
              </FormField>
              <FormField label="S·ªë ƒëi·ªán tho·∫°i">
                <input
                  type="tel"
                  value={formData.so_dien_thoai || ""}
                  onChange={(e) =>
                    setFormData({ ...formData, so_dien_thoai: e.target.value })
                  }
                  className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                  placeholder="09..."
                />
              </FormField>
            </div>

            <FormField label="L∆∞∆°ng th√°ng (VNƒê)">
              <input
                type="number"
                value={formData.luong_thang || ""}
                onChange={(e) =>
                  setFormData({
                    ...formData,
                    luong_thang: Number(e.target.value),
                  })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                placeholder="0"
              />
            </FormField>
          </div>
        </KhungForm>
      )}

      {/* ====== CONFIRM DELETE ====== */}
      <ConfirmDialog
        isOpen={confirmDelete.show}
        title="X√ÅC NH·∫¨N X√ìA"
        message={`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${confirmDelete.ids.length} nh√¢n s·ª±?`}
        onConfirm={() => handleDelete(confirmDelete.ids)}
        onCancel={() => setConfirmDelete({ show: false, ids: [] })}
      />
    </div>
  );
}

// ============================================================
// SUB-COMPONENTS
// ============================================================

function InfoRow({
  icon: Icon,
  label,
  value,
  highlight,
}: {
  icon: any;
  label: string;
  value?: string;
  highlight?: boolean;
}) {
  return (
    <div className="flex items-center gap-3 p-3 rounded-xl bg-[#151515] border border-white/5">
      <div
        className={`p-2 rounded-lg ${
          highlight
            ? "bg-[#C69C6D]/20 text-[#C69C6D]"
            : "bg-black text-[#C69C6D]"
        }`}
      >
        <Icon size={16} />
      </div>
      <div className="flex-1 min-w-0">
        <p className="text-[9px] font-black uppercase tracking-wider text-white/40 mb-0.5">
          {label}
        </p>
        <p
          className={`text-sm font-bold truncate ${
            highlight ? "text-[#C69C6D]" : "text-gray-200"
          }`}
        >
          {value || "---"}
        </p>
      </div>
    </div>
  );
}

function FormField({
  label,
  required,
  children,
}: {
  label: string;
  required?: boolean;
  children: React.ReactNode;
}) {
  return (
    <div>
      <label className="block text-xs font-bold text-white/60 uppercase tracking-wider mb-2">
        {label} {required && <span className="text-red-400">*</span>}
      </label>
      {children}
    </div>
  );
}
</file>

<file path="components/cacchucnang/types.ts">
/**
 * Types d√πng chung cho c√°c config ch·ª©c nƒÉng
 * ƒê·ªãnh nghƒ©a c·∫•u tr√∫c data cho danh s√°ch, chi ti·∫øt, form
 */

import { LucideIcon } from 'lucide-react';
import { ReactNode } from 'react';

// C·∫•u h√¨nh 1 field hi·ªÉn th·ªã
export interface FieldConfig {
    key: string;
    label: string;
    icon?: LucideIcon;
    render?: (value: any, item: any) => ReactNode;
    editable?: boolean;
    type?: 'text' | 'number' | 'email' | 'tel' | 'select' | 'textarea' | 'date' | 'image' | 'select-add' | 'phone' | 'money' | 'readonly' | 'percent';
    options?: string[] | { value: string; label: string }[];
    optionsLoader?: () => Promise<string[]>;
    required?: boolean;
    placeholder?: string;
    colSpan?: number;
    showInForm?: boolean;
    showInDetail?: boolean;
    showInCard?: boolean;
    highlight?: boolean;
    computeFrom?: string;
    computeFn?: (value: any) => any;
    maxValue?: number;
}

// C·∫•u h√¨nh 1 tab l·ªçc (trong danh s√°ch)
export interface FilterTabConfig {
    id?: string;
    key?: string;
    label: string;
    filter?: (item: any) => boolean;
    filterField?: string;
    color?: string;
}

// C·∫•u h√¨nh 1 tab chi ti·∫øt
export interface TabConfig {
    id?: string;
    key?: string;
    label: string;
    icon?: LucideIcon;
    content?: ReactNode | ((item: any) => ReactNode);
    searchable?: boolean;
    sortable?: boolean;
    sortOptions?: { key: string; label: string }[];
    showAddButton?: boolean;
}

// C·∫•u h√¨nh sort options
export interface SortOption<T = any> {
    key: string;
    label: string;
    sortFn: (a: T, b: T) => number;
}

// C·∫•u h√¨nh ch√≠nh cho Manager
export interface ManagerConfig<T = any> {
    // Entity info
    entityName: string;
    entityNamePlural: string;
    
    // Table/query
    tableName?: string;
    idField?: string;
    
    // Card display
    getCardTitle?: (item: T) => string;
    getCardSubtitle?: (item: T) => string;
    getCardAvatar?: (item: T) => string | null;
    getCardBadge?: (item: T) => { text: string; color: string } | null;
    
    // Card config
    cardConfig?: {
        titleField?: string;
        subtitleField?: string;
        avatarField?: string;
        badgeField?: string;
        getBadgeColor?: (value: string) => string;
        infoFields?: { field: string; icon?: LucideIcon }[];
    };
    
    // Fields config
    fields: FieldConfig[];
    
    // Tabs config  
    filterTabs: FilterTabConfig[];
    detailTabs: TabConfig[];
    
    // List config
    listConfig?: {
        searchKeys: string[];
        sortOptions: SortOption<T>[];
        defaultSort: string;
    };
    
    // Search fields (for quick search)
    searchFields?: string[];
    
    // Sort options (top level alternative to listConfig.sortOptions)
    sortOptions?: SortOption<T>[];
    
    // Default sort (top level alternative)
    defaultSort?: string;
    
    // Upload config for images
    uploadConfig?: {
        bucket: string;
        fileNamePrefix?: string;
    };
    
    // Permissions
    permissions?: {
        canCreate?: boolean;
        canEdit?: boolean;
        canDelete?: boolean;
        canBulkDelete?: boolean;
    };
    
    // Actions
    actions?: {
        allowView?: boolean;
        allowEdit?: boolean;
        allowDelete?: boolean;
        allowBulkSelect?: boolean;
        allowBulkDelete?: boolean;
        onCardClick?: (item: T) => void;
        onEdit?: (item: T) => void;
        onDelete?: (item: T) => void;
        onBulkDelete?: (items: T[]) => void;
        onCreate?: () => void;
    };
    
    // Data source (flexible ƒë·ªÉ ph√π h·ª£p v·ªõi nhi·ªÅu c√°ch implement)
    dataSource?: {
        fetchList?: (page: number, limit: number, search: string, filter: string) => Promise<{ success: boolean; data: T[] | undefined; error: any }>;
        fetch?: () => Promise<T[]>;
        create?: (item: Partial<T>) => Promise<{ success: boolean; data: T; error: any }>;
        update?: (id: string, item: Partial<T>) => Promise<{ success: boolean; data: T; error: any }>;
        delete?: (id: string) => Promise<{ success: boolean; error: any }>;
    };
}
</file>

<file path="components/ConfirmDialog.tsx">
'use client';

import React, { useEffect, useState } from 'react';
import { createPortal } from 'react-dom';
import { AlertTriangle, CheckCircle2, X } from 'lucide-react';

interface ConfirmDialogProps {
  isOpen: boolean;
  title: string;
  message: string;
  confirmText?: string;
  cancelText?: string;
  isDangerous?: boolean; // N·∫øu true n√∫t s·∫Ω m√†u ƒë·ªè (X√≥a)
  isLoading?: boolean;
  onConfirm: () => void;
  onCancel: () => void;
}

export default function ConfirmDialog({
  isOpen,
  title,
  message,
  confirmText = 'X√°c nh·∫≠n',
  cancelText = 'H·ªßy b·ªè',
  isDangerous = false,
  isLoading = false,
  onConfirm,
  onCancel
}: ConfirmDialogProps) {
  const [mounted, setMounted] = useState(false);

  useEffect(() => { setMounted(true); }, []);

  if (!mounted || !isOpen) return null;

  return createPortal(
    <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
      {/* Backdrop m·ªù ·∫£o */}
      <div 
        className="absolute inset-0 bg-black/80 backdrop-blur-sm animate-in fade-in duration-300"
        onClick={!isLoading ? onCancel : undefined}
      />

      {/* Dialog Content */}
      <div className="relative w-full max-w-sm bg-[#1a120f] border border-[#C69C6D]/40 rounded-2xl shadow-[0_0_50px_rgba(0,0,0,0.8)] overflow-hidden animate-in zoom-in-95 duration-300">
        
        {/* Glow effect ph√≠a tr√™n */}
        <div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#C69C6D] to-transparent opacity-70"></div>

        <div className="p-6 text-center">
          {/* Icon */}
          <div className="mx-auto w-16 h-16 mb-4 flex items-center justify-center rounded-full bg-black border border-[#C69C6D]/20 shadow-inner">
            {isDangerous ? (
              <AlertTriangle size={32} className="text-red-500 animate-pulse" />
            ) : (
              <CheckCircle2 size={32} className="text-[#C69C6D]" />
            )}
          </div>

          {/* Title & Message */}
          <h3 className="text-xl font-serif font-bold text-[#F5E6D3] mb-2 uppercase tracking-wide">
            {title}
          </h3>
          <p className="text-white/60 text-sm font-light leading-relaxed mb-6">
            {message}
          </p>

          {/* Actions */}
          <div className="flex gap-3">
            <button
              onClick={onCancel}
              disabled={isLoading}
              className="flex-1 py-3 rounded-xl border border-white/10 text-white/50 hover:text-white hover:bg-white/5 transition-all text-xs font-bold uppercase tracking-widest"
            >
              {cancelText}
            </button>
            <button
              onClick={onConfirm}
              disabled={isLoading}
              className={`flex-1 py-3 rounded-xl text-black font-bold uppercase tracking-widest transition-all shadow-lg active:scale-95 text-xs flex items-center justify-center gap-2
                ${isDangerous 
                  ? 'bg-red-600 hover:bg-red-500 text-white shadow-red-900/20' 
                  : 'bg-[#C69C6D] hover:bg-[#B58B5D] shadow-[#C69C6D]/20'
                }
                ${isLoading ? 'opacity-70 cursor-not-allowed' : ''}
              `}
            >
              {isLoading ? 'ƒêang x·ª≠ l√Ω...' : confirmText}
            </button>
          </div>
        </div>
      </div>
    </div>,
    document.body
  );
}
</file>

<file path="components/ErrorBoundary.tsx">
'use client';
import React, { ReactNode } from 'react';
import { AlertCircle } from 'lucide-react';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error?: Error;
}

export default class ErrorBoundary extends React.Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error) {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('ErrorBoundary caught:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return this.props.fallback || (
        <div className="flex items-center justify-center min-h-screen bg-red-50 p-4">
          <div className="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
            <div className="flex items-center gap-3 mb-4">
              <AlertCircle className="text-red-600" size={24} />
              <h2 className="text-lg font-bold text-red-600">C√≥ L·ªói X·∫£y Ra</h2>
            </div>
            <p className="text-gray-700 mb-4">·ª®ng d·ª•ng g·∫∑p s·ª± c·ªë. Vui l√≤ng refresh trang ho·∫∑c li√™n h·ªá h·ªó tr·ª£.</p>
            <button
              onClick={() => window.location.reload()}
              className="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
            >
              Reload
            </button>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}
</file>

<file path="components/ForceFullScreen.tsx">
"use client";

import React, { useState, useEffect } from "react";
import {
  Download,
  Share,
  PlusSquare,
  Smartphone,
  Monitor,
  XCircle,
  CheckCircle2,
} from "lucide-react";
import { usePathname } from "next/navigation";

export default function ForceFullScreen() {
  const pathname = usePathname();
  const [showPrompt, setShowPrompt] = useState(false);
  const [isIOS, setIsIOS] = useState(false);
  const [isMobile, setIsMobile] = useState(false);
  const [deferredPrompt, setDeferredPrompt] = useState<any>(null);

  // 1. LOGIC T√çNH CHI·ªÄU CAO "B·∫§T T·ª¨" (Fix l·ªói h·ªü tr·∫Øng tr√™n Safari/Chrome Mobile)
  useEffect(() => {
    const setAppHeight = () => {
      const vh = window.visualViewport
        ? window.visualViewport.height
        : window.innerHeight;
      document.documentElement.style.setProperty("--app-height", `${vh}px`);
    };

    setAppHeight();

    if (window.visualViewport) {
      window.visualViewport.addEventListener("resize", setAppHeight);
      window.visualViewport.addEventListener("scroll", setAppHeight);
    } else {
      window.addEventListener("resize", setAppHeight);
    }

    return () => {
      if (window.visualViewport) {
        window.visualViewport.removeEventListener("resize", setAppHeight);
        window.visualViewport.removeEventListener("scroll", setAppHeight);
      } else {
        window.removeEventListener("resize", setAppHeight);
      }
    };
  }, []);

  // 2. LOGIC KI·ªÇM TRA & √âP C√ÄI ƒê·∫∂T (ƒê√É N√ÇNG C·∫§P TH√îNG MINH H∆†N)
  useEffect(() => {
    // Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ b·∫•m "·∫®n vƒ©nh vi·ªÖn" ch∆∞a
    const isDismissed =
      typeof window !== "undefined" &&
      localStorage.getItem("PWA_PROMPT_DISMISSED") === "true";
    if (isDismissed) return;

    const handler = (e: any) => {
      e.preventDefault();
      setDeferredPrompt(e);
    };
    window.addEventListener("beforeinstallprompt", handler);

    const checkDeviceAndMode = () => {
      // üü¢ CHECK 1: Thi·∫øt b·ªã
      const userAgent = window.navigator.userAgent.toLowerCase();
      const mobile =
        /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(
          userAgent
        );
      setIsMobile(mobile);
      setIsIOS(/iphone|ipad|ipod/.test(userAgent));

      // üü¢ CHECK 2: Standalone Mode (N√¢ng c·∫•p)
      // Th√™m nhi·ªÅu ƒëi·ªÅu ki·ªán check h∆°n ƒë·ªÉ tr√°nh b·∫Øt nh·∫ßm
      const isStandalone =
        window.matchMedia("(display-mode: standalone)").matches ||
        window.matchMedia("(display-mode: fullscreen)").matches ||
        window.matchMedia("(display-mode: minimal-ui)").matches ||
        (window.navigator as any).standalone ||
        document.referrer.includes("android-app://");

      // üü¢ CHECK 3: Heuristic chi·ªÅu cao (Quan tr·ªçng)
      // N·∫øu m·∫•t thanh ƒë·ªãa ch·ªâ (chi·ªÅu cao c·ª≠a s·ªï > 90% chi·ªÅu cao thi·∫øt b·ªã) -> Coi nh∆∞ ƒë√£ Fullscreen
      const isLikelyFullscreen =
        window.innerHeight > window.screen.height * 0.9;

      // üü¢ CHECK 4: Trang n·ªôi b·ªô
      const isInternalPage =
        pathname.startsWith("/phong") ||
        pathname.startsWith("/dashboard") ||
        pathname.startsWith("/admin");

      // üõë LOGIC QUY·∫æT ƒê·ªäNH HI·ªÜN POPUP
      // Ch·ªâ hi·ªán n·∫øu: L√† Mobile + Ch∆∞a c√†i + Trang n·ªôi b·ªô + Ch∆∞a Fullscreen th·ª±c s·ª±
      if (mobile && !isStandalone && !isLikelyFullscreen && isInternalPage) {
        setShowPrompt(true);
      } else {
        setShowPrompt(false);
      }
    };

    // Check ngay l·∫≠p t·ª©c v√† check l·∫°i khi resize/focus (ƒë·ªÅ ph√≤ng xoay m√†n h√¨nh)
    checkDeviceAndMode();
    window.addEventListener("resize", checkDeviceAndMode);
    window.addEventListener("focus", checkDeviceAndMode);

    return () => {
      window.removeEventListener("beforeinstallprompt", handler);
      window.removeEventListener("resize", checkDeviceAndMode);
      window.removeEventListener("focus", checkDeviceAndMode);
    };
  }, [pathname]);

  const handleInstallClick = async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === "accepted") {
        setDeferredPrompt(null);
        setShowPrompt(false);
      }
    } else {
      // Fallback cho iOS ho·∫∑c khi tr√¨nh duy·ªát ch·∫∑n prompt
      alert(
        'Vui l√≤ng t√¨m n√∫t "C√†i ƒë·∫∑t" ho·∫∑c "Th√™m v√†o m√†n h√¨nh ch√≠nh" tr√™n menu tr√¨nh duy·ªát.'
      );
    }
  };

  // üü¢ H√ÄM X·ª¨ L√ù KHI NG∆Ø·ªúI D√ôNG K√äU "TAO C√ÄI R·ªíI M√Ä" (C·ª®U TINH)
  const handleDismiss = () => {
    // L∆∞u v√†o localStorage ƒë·ªÉ kh√¥ng bao gi·ªù hi·ªán l·∫°i n·ªØa tr√™n m√°y n√†y
    localStorage.setItem("PWA_PROMPT_DISMISSED", "true");
    setShowPrompt(false);
  };

  if (!showPrompt) return null;

  return (
    <div className="fixed inset-0 z-[99999] bg-black/95 backdrop-blur-xl flex flex-col items-center justify-center p-6 animate-in fade-in duration-500 text-center">
      {/* N√∫t t·∫Øt kh·∫©n c·∫•p (G√≥c tr√™n ph·∫£i) - Cho tr∆∞·ªùng h·ª£p mu·ªën t·∫Øt t·∫°m th·ªùi */}
      <button
        onClick={() => setShowPrompt(false)}
        className="absolute top-4 right-4 text-white/30 hover:text-white p-2"
      >
        <XCircle size={24} />
      </button>

      <div className="w-20 h-20 mb-6 rounded-2xl bg-gradient-to-br from-[#C69C6D] to-[#5D4037] flex items-center justify-center shadow-[0_0_40px_rgba(198,156,109,0.3)] animate-bounce">
        {isMobile ? (
          <Smartphone className="text-white w-10 h-10" />
        ) : (
          <Monitor className="text-white w-10 h-10" />
        )}
      </div>

      <h2 className="text-2xl font-bold text-[#F5E6D3] mb-4 uppercase tracking-widest font-serif">
        H·ªá Th·ªëng N·ªôi B·ªô
      </h2>

      <p className="text-gray-400 text-sm md:text-base max-w-md mb-8 leading-relaxed">
        ƒê·ªÉ ƒë·∫£m b·∫£o hi·ªáu nƒÉng v√† tr·∫£i nghi·ªám l√†m vi·ªác t·ªët nh·∫•t, vui l√≤ng c√†i ƒë·∫∑t
        ·ª©ng d·ª•ng v√†o thi·∫øt b·ªã.
      </p>

      {isIOS ? (
        <div className="bg-[#1a120f] border border-[#8B5E3C]/30 p-5 rounded-xl max-w-xs w-full text-left space-y-3 shadow-2xl">
          <div className="flex items-center gap-3 text-[#C69C6D] text-sm font-bold">
            <Share size={20} />
            <span>B∆∞·ªõc 1: Nh·∫•n n√∫t Chia s·∫ª</span>
          </div>
          <div className="w-full h-[1px] bg-[#8B5E3C]/20"></div>
          <div className="flex items-center gap-3 text-[#F5E6D3] text-sm font-bold">
            <PlusSquare size={20} />
            <span>B∆∞·ªõc 2: Ch·ªçn "Th√™m v√†o MH ch√≠nh"</span>
          </div>
        </div>
      ) : (
        <div className="w-full max-w-xs space-y-3">
          <button
            onClick={handleInstallClick}
            className="w-full py-4 bg-[#C69C6D] hover:bg-[#b08b5e] text-[#1a120f] font-bold text-sm uppercase tracking-widest rounded-xl transition-all active:scale-95 shadow-[0_0_20px_rgba(198,156,109,0.4)] flex items-center justify-center gap-2"
          >
            <Download size={20} strokeWidth={2.5} /> C√ÄI ƒê·∫∂T NGAY
          </button>
        </div>
      )}

      {/* üü¢ N√öT CHO NG∆Ø·ªúI ƒê√É C√ÄI R·ªíI - GI·∫¢I PH√ÅP CU·ªêI C√ôNG */}
      <button
        onClick={handleDismiss}
        className="mt-6 flex items-center gap-2 px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-white/50 hover:text-white transition-colors text-xs font-medium border border-white/5"
      >
        <CheckCircle2 size={14} />
        T√¥i ƒë√£ c√†i r·ªìi / Kh√¥ng hi·ªán l·∫°i n·ªØa
      </button>
    </div>
  );
}
</file>

<file path="components/KhungGiaoDien/index.ts">
/**
 * ============================================================
 * KHUNG GIAO DI·ªÜN
 * ============================================================
 * 
 * B·ªô khung UI chu·∫©n cho to√†n b·ªô ·ª©ng d·ª•ng.
 * T·∫•t c·∫£ ƒë·ªÅu l√† INLINE PANEL (kh√¥ng ph·∫£i modal popup).
 * 
 * COMPONENTS:
 * - KhungDanhSach: Tab bar ngang + Cards + Search/Sort/Bulk
 * - KhungChiTiet: Tab bar ngang + Chi ti·∫øt inline
 * - KhungForm: Tab bar ngang + Form inline
 * 
 * STYLE CHUNG:
 * - Tab bar: h-[40px], bg-[#0a0a0a], border-b border-white/5
 * - Tabs: px-2 py-1, text-[10px] font-bold uppercase
 * - Actions: shrink-0 border-l, icon buttons p-1.5
 * 
 * S·ª¨ D·ª§NG:
 * import { KhungDanhSach, KhungChiTiet, KhungForm } from '@/app/components/KhungGiaoDien';
 */

export { default as KhungDanhSach } from './KhungDanhSach';
export { default as KhungChiTiet } from './KhungChiTiet';
export { default as KhungForm } from './KhungForm';

// Export types
export type { KhungDanhSachProps, TabItem as DanhSachTabItem, SortOption, BulkAction } from './KhungDanhSach';
export type { KhungChiTietProps, TabItem as ChiTietTabItem } from './KhungChiTiet';
export type { KhungFormProps } from './KhungForm';
</file>

<file path="components/KhungGiaoDien/KhungChiTiet.tsx">
"use client";

/**
 * ============================================================
 * KHUNG CHI TI·∫æT (COMPACT & CLEAN TABS)
 * ============================================================
 * * Update UI:
 * - Row 1 Height: 45px (Compact Header)
 * - Row 2 Height: 40px (Compact Tabs)
 * - Tabs Style: Text-only (No background buttons), simple underline.
 */

import React, { ReactNode, useState } from "react";
import {
  X,
  User,
  Edit3,
  Trash2,
  Loader2,
  Search,
  ArrowUpDown,
} from "lucide-react";

// ============================================================
// TYPES
// ============================================================

export interface TabItem {
  id: string;
  label: string;
  icon?: React.ElementType;
  count?: number;
  searchable?: boolean;
  sortable?: boolean;
  sortOptions?: { key: string; label: string }[];
  showAddButton?: boolean;
}

export interface KhungChiTietProps {
  data: any;
  onClose: () => void;
  avatar?: string;
  avatarFallback?: ReactNode;
  title?: string;
  tabs?: TabItem[];
  activeTab?: string;
  onTabChange?: (tabId: string) => void;
  tabCounts?: Record<string, number>;
  searchTerm?: string;
  onSearch?: (term: string) => void;
  sortBy?: string;
  onSortChange?: (sortKey: string) => void;
  onAddInTab?: () => void;
  showEditButton?: boolean;
  showDeleteButton?: boolean;
  onEdit?: () => void;
  onDelete?: () => void;
  deleting?: boolean;
  children: ReactNode;
  className?: string;
}

// ============================================================
// COMPONENT
// ============================================================

export default function KhungChiTiet({
  data,
  onClose,
  avatar,
  avatarFallback,
  title,
  tabs = [],
  activeTab,
  onTabChange,
  tabCounts = {},
  searchTerm = "",
  onSearch,
  sortBy,
  onSortChange,
  onAddInTab,
  showEditButton = true,
  showDeleteButton = false,
  onEdit,
  onDelete,
  deleting = false,
  children,
  className = "",
}: KhungChiTietProps) {
  const [showSearch, setShowSearch] = useState(false);
  const [localSearchTerm, setLocalSearchTerm] = useState(searchTerm);
  const [showSortMenu, setShowSortMenu] = useState(false);

  // Swipe gesture states
  const [touchStartX, setTouchStartX] = useState<number | null>(null);
  const [touchEndX, setTouchEndX] = useState<number | null>(null);
  const minSwipeDistance = 50;

  if (!data) return null;

  const currentTabConfig = tabs.find((t) => t.id === activeTab);
  const TAB_IDS = tabs.map((t) => t.id);

  // Swipe handlers
  const handleTouchStart = (e: React.TouchEvent) => {
    setTouchEndX(null);
    setTouchStartX(e.targetTouches[0].clientX);
  };

  const handleTouchMove = (e: React.TouchEvent) => {
    setTouchEndX(e.targetTouches[0].clientX);
  };

  const handleTouchEnd = () => {
    if (!touchStartX || !touchEndX || !onTabChange) return;
    const distance = touchStartX - touchEndX;
    const isLeftSwipe = distance > minSwipeDistance;
    const isRightSwipe = distance < -minSwipeDistance;
    const currentIndex = TAB_IDS.indexOf(activeTab || "");

    if (isLeftSwipe && currentIndex < TAB_IDS.length - 1) {
      onTabChange(TAB_IDS[currentIndex + 1]);
    } else if (isRightSwipe && currentIndex > 0) {
      onTabChange(TAB_IDS[currentIndex - 1]);
    }
    setTouchStartX(null);
    setTouchEndX(null);
  };

  const handleSearch = (value: string) => {
    setLocalSearchTerm(value);
    onSearch?.(value);
  };

  return (
    <div
      className={`w-full h-full flex flex-col bg-[#050505] overflow-hidden ${className}`}
    >
      {/* ====== HEADER CONTAINER ====== */}
      <div className="shrink-0 flex flex-col bg-[#0a0a0a] border-b border-white/5 z-20 shadow-sm">
        {/* --- ROW 1: INFO & ACTIONS (Height reduced to 45px) --- */}
        <div className="flex items-center justify-between px-4 h-[45px] border-b border-white/5">
          {/* LEFT: Avatar + Title */}
          <div className="flex items-center gap-3 min-w-0">
            {/* Avatar nh·ªè h∆°n ch√∫t (w-8 h-8) ƒë·ªÉ h·ª£p v·ªõi thanh h-45 */}
            <div className="w-8 h-8 rounded-full border border-[#C69C6D]/30 overflow-hidden bg-[#1a1a1a] shrink-0 p-0.5 shadow-lg shadow-[#C69C6D]/5">
              {avatar ? (
                <img
                  src={avatar}
                  alt=""
                  className="w-full h-full object-cover rounded-full"
                />
              ) : (
                <div className="w-full h-full flex items-center justify-center bg-[#151515] rounded-full">
                  {avatarFallback || (
                    <User size={14} className="text-[#C69C6D]/50" />
                  )}
                </div>
              )}
            </div>
            <div className="min-w-0">
              <h2 className="text-sm font-black text-white uppercase tracking-wide truncate leading-tight">
                {title || "---"}
              </h2>
            </div>
          </div>

          {/* RIGHT: Global Actions */}
          <div className="flex items-center gap-1 shrink-0 ml-4">
            {showEditButton && onEdit && (
              <button
                onClick={onEdit}
                className="p-1.5 hover:text-[#C69C6D] text-gray-400 transition-all"
                title="Ch·ªânh s·ª≠a"
              >
                <Edit3 size={16} />
              </button>
            )}

            {showDeleteButton && onDelete && (
              <button
                onClick={onDelete}
                disabled={deleting}
                className="p-1.5 hover:text-red-500 text-gray-400 disabled:opacity-50 transition-all"
                title="X√≥a"
              >
                {deleting ? (
                  <Loader2 size={16} className="animate-spin" />
                ) : (
                  <Trash2 size={16} />
                )}
              </button>
            )}

            <div className="w-[1px] h-4 bg-white/10 mx-1"></div>

            <button
              onClick={onClose}
              className="p-1.5 hover:text-white text-gray-400 transition-all"
            >
              <X size={18} />
            </button>
          </div>
        </div>

        {/* --- ROW 2: CLEAN TABS (Height reduced to 40px) --- */}
        <div className="flex items-center justify-between h-[40px] px-2 relative">
          {/* Spacer Left */}
          <div className="w-[60px] shrink-0 hidden md:block"></div>

          {/* CENTER: Simple Text Tabs */}
          <div className="flex-1 flex items-center justify-center gap-6 h-full overflow-x-auto scrollbar-hide">
            <style jsx>{`
              .scrollbar-hide::-webkit-scrollbar {
                display: none;
              }
              .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
              }
            `}</style>
            {tabs.map((tab) => (
              <button
                key={tab.id}
                onClick={() => onTabChange?.(tab.id)}
                className={`relative h-full flex items-center gap-2 px-1 text-[10px] font-bold uppercase tracking-widest transition-all whitespace-nowrap group
                  ${
                    activeTab === tab.id
                      ? "text-[#C69C6D]"
                      : "text-gray-500 hover:text-white"
                  }
                `}
              >
                {tab.label}
                {(tabCounts[tab.id] !== undefined ||
                  tab.count !== undefined) && (
                  <span
                    className={`text-[9px] ${
                      activeTab === tab.id
                        ? "text-[#C69C6D]"
                        : "text-gray-600 group-hover:text-gray-400"
                    }`}
                  >
                    ({tabCounts[tab.id] ?? tab.count ?? 0})
                  </span>
                )}

                {/* Active Indicator Line (Simple Underline) */}
                {activeTab === tab.id && (
                  <div className="absolute bottom-0 left-0 right-0 h-[2px] bg-[#C69C6D] shadow-[0_0_8px_#C69C6D]" />
                )}
              </button>
            ))}
          </div>

          {/* RIGHT: Search & Sort Tools */}
          <div className="w-[60px] shrink-0 flex items-center justify-end gap-1">
            {currentTabConfig?.searchable && onSearch && (
              <div className="relative flex items-center">
                {showSearch ? (
                  <div className="absolute right-0 top-1/2 -translate-y-1/2 flex items-center bg-[#1a1a1a] border border-white/20 rounded z-10 animate-in slide-in-from-right-5 shadow-xl">
                    <input
                      autoFocus
                      type="text"
                      placeholder="T√¨m..."
                      value={localSearchTerm}
                      onChange={(e) => handleSearch(e.target.value)}
                      className="w-24 bg-transparent pl-2 pr-5 py-1 text-[10px] text-white placeholder:text-white/20 focus:outline-none"
                    />
                    <button
                      onClick={() => {
                        setShowSearch(false);
                        handleSearch("");
                      }}
                      className="absolute right-1 p-0.5 text-white/40 hover:text-white"
                    >
                      <X size={10} />
                    </button>
                  </div>
                ) : (
                  <button
                    onClick={() => setShowSearch(true)}
                    className="p-1.5 text-gray-500 hover:text-white transition-all"
                  >
                    <Search size={14} />
                  </button>
                )}
              </div>
            )}

            {currentTabConfig?.sortable &&
              currentTabConfig.sortOptions &&
              onSortChange && (
                <div className="relative">
                  <button
                    onClick={() => setShowSortMenu(!showSortMenu)}
                    className="p-1.5 text-gray-500 hover:text-white transition-all"
                  >
                    <ArrowUpDown size={14} />
                  </button>
                  {showSortMenu && (
                    <>
                      <div
                        className="fixed inset-0 z-40"
                        onClick={() => setShowSortMenu(false)}
                      />
                      <div className="absolute top-full mt-1 right-0 bg-[#1a1a1a] border border-white/10 rounded shadow-xl z-[100] min-w-[100px] overflow-hidden">
                        {currentTabConfig.sortOptions.map((opt) => (
                          <button
                            key={opt.key}
                            onClick={() => {
                              onSortChange(opt.key);
                              setShowSortMenu(false);
                            }}
                            className={`w-full text-left px-3 py-2 text-[9px] font-bold border-b border-white/5 last:border-0 ${
                              sortBy === opt.key
                                ? "text-[#C69C6D]"
                                : "text-gray-400 hover:text-white hover:bg-white/5"
                            }`}
                          >
                            {opt.label}
                          </button>
                        ))}
                      </div>
                    </>
                  )}
                </div>
              )}
          </div>
        </div>
      </div>

      {/* ====== CONTENT AREA ====== */}
      <div
        className="flex-1 overflow-y-auto custom-scrollbar bg-[#050505]"
        onTouchStart={handleTouchStart}
        onTouchMove={handleTouchMove}
        onTouchEnd={handleTouchEnd}
      >
        {children}
      </div>
    </div>
  );
}
</file>

<file path="components/KhungGiaoDien/KhungDanhSach.tsx">
"use client";

/**
 * ============================================================
 * KHUNG DANH S√ÅCH
 * ============================================================
 *
 * Khung giao di·ªán chu·∫©n cho trang danh s√°ch.
 * Style: Tab bar ngang + Actions g√≥c ph·∫£i (gi·ªëng GenericManager)
 */

import React, { useState, ReactNode } from "react";
import {
  Search,
  X,
  Plus,
  ArrowUpDown,
  CheckSquare,
  Trash2,
} from "lucide-react";

// ============================================================
// TYPES
// ============================================================

export interface TabItem {
  id: string;
  label: string;
  count?: number;
}

export interface SortOption {
  key: string;
  label: string;
}

export interface BulkAction {
  id: string;
  label: string;
  icon?: React.ElementType;
  color?: string;
  onClick: (selectedIds: string[]) => void;
}

export interface KhungDanhSachProps {
  // Tabs
  tabs?: TabItem[];
  activeTab?: string;
  onTabChange?: (tabId: string) => void;

  // Search
  onSearch?: (term: string) => void;

  // Sort
  sortOptions?: SortOption[];
  activeSort?: string;
  onSortChange?: (sortKey: string) => void;

  // Actions
  showAddButton?: boolean;
  onAdd?: () => void;

  // Bulk mode
  bulkMode?: boolean;
  onBulkModeToggle?: () => void;
  selectedCount?: number;
  onSelectAll?: () => void;
  onClearSelection?: () => void;
  bulkActions?: BulkAction[];

  // Loading
  loading?: boolean;

  // Content
  children: ReactNode;

  // Style
  className?: string;
}

// ============================================================
// COMPONENT
// ============================================================

export default function KhungDanhSach({
  tabs = [],
  activeTab = "all",
  onTabChange,
  onSearch,
  sortOptions = [],
  activeSort,
  onSortChange,
  showAddButton = true,
  onAdd,
  bulkMode = false,
  onBulkModeToggle,
  selectedCount = 0,
  onSelectAll,
  onClearSelection,
  bulkActions = [],
  loading = false,
  children,
  className = "",
}: KhungDanhSachProps) {
  const [showSearch, setShowSearch] = useState(false);
  const [searchTerm, setSearchTerm] = useState("");
  const [showSortMenu, setShowSortMenu] = useState(false);

  const handleSearch = (value: string) => {
    setSearchTerm(value);
    onSearch?.(value);
  };

  const clearSearch = () => {
    setSearchTerm("");
    onSearch?.("");
    setShowSearch(false);
  };

  return (
    <div
      className={`w-full h-full flex flex-col bg-[#050505] overflow-hidden ${className}`}
    >
      {/* ====== TAB BAR - Style gi·ªëng GenericManager ====== */}
      <div className="shrink-0 h-[40px] flex items-center border-b border-white/5 bg-[#0a0a0a]">
        {/* Tabs - cu·ªôn ƒë∆∞·ª£c */}
        <div className="flex-1 flex items-center gap-1 px-2 overflow-x-auto min-w-0 scrollbar-hide">
          <style jsx>{`
            .scrollbar-hide::-webkit-scrollbar {
              display: none;
            }
            .scrollbar-hide {
              -ms-overflow-style: none;
              scrollbar-width: none;
            }
          `}</style>
          {tabs.map((tab) => (
            <button
              key={tab.id}
              onClick={() => onTabChange?.(tab.id)}
              className={`flex items-center gap-1 px-2 py-1 text-[10px] font-bold uppercase whitespace-nowrap rounded transition-all shrink-0 ${
                activeTab === tab.id
                  ? "text-[#C69C6D] bg-[#C69C6D]/10"
                  : "text-gray-500 hover:text-white hover:bg-white/5"
              }`}
            >
              {tab.label}
              {tab.count !== undefined && (
                <span
                  className={`px-1 py-0.5 rounded text-[8px] ${
                    activeTab === tab.id
                      ? "bg-[#C69C6D] text-black"
                      : "bg-white/10 text-gray-400"
                  }`}
                >
                  {tab.count}
                </span>
              )}
            </button>
          ))}
        </div>

        {/* Actions - c·ªë ƒë·ªãnh ph·∫£i */}
        <div className="shrink-0 flex items-center gap-1 px-2 border-l border-white/5 bg-[#0a0a0a]">
          {/* Search */}
          {onSearch && (
            <div className="relative flex items-center">
              {showSearch ? (
                <div className="flex items-center gap-1 animate-in slide-in-from-right-2">
                  <input
                    autoFocus
                    type="text"
                    placeholder="T√¨m..."
                    value={searchTerm}
                    onChange={(e) => handleSearch(e.target.value)}
                    className="w-28 bg-white/5 border border-white/10 rounded pl-2 pr-6 py-1 text-[10px] text-white placeholder:text-white/20 focus:outline-none focus:border-[#C69C6D]"
                  />
                  <button
                    onClick={clearSearch}
                    className="absolute right-1 p-0.5 text-white/40 hover:text-white"
                  >
                    <X size={12} />
                  </button>
                </div>
              ) : (
                <button
                  onClick={() => setShowSearch(true)}
                  className="p-1.5 bg-white/5 hover:bg-white/10 text-white/60 rounded transition-all"
                >
                  <Search size={14} />
                </button>
              )}
            </div>
          )}

          {/* Sort */}
          {sortOptions.length > 0 && (
            <div className="relative">
              <button
                onClick={() => setShowSortMenu(!showSortMenu)}
                className="p-1.5 bg-white/5 hover:bg-white/10 text-white/60 rounded transition-all"
              >
                <ArrowUpDown size={14} />
              </button>
              {showSortMenu && (
                <>
                  <div
                    className="fixed inset-0 z-40"
                    onClick={() => setShowSortMenu(false)}
                  />
                  <div className="absolute top-full mt-1 right-0 bg-[#1a1a1a] border border-white/10 rounded-lg shadow-2xl z-[100] min-w-[90px] overflow-hidden">
                    {sortOptions.map((opt) => (
                      <button
                        key={opt.key}
                        onClick={() => {
                          onSortChange?.(opt.key);
                          setShowSortMenu(false);
                        }}
                        className={`w-full text-left px-3 py-1.5 text-[10px] font-bold ${
                          activeSort === opt.key
                            ? "text-[#C69C6D] bg-[#C69C6D]/10"
                            : "text-white hover:bg-white/10"
                        }`}
                      >
                        {opt.label}
                      </button>
                    ))}
                  </div>
                </>
              )}
            </div>
          )}

          {/* Bulk Mode Toggle */}
          {onBulkModeToggle && (
            <button
              onClick={onBulkModeToggle}
              className={`p-1.5 rounded transition-all ${
                bulkMode
                  ? "bg-[#C69C6D] text-black"
                  : "bg-white/5 text-white/60 hover:bg-white/10"
              }`}
            >
              <CheckSquare size={14} />
            </button>
          )}

          {/* Add */}
          {showAddButton && onAdd && (
            <button
              onClick={onAdd}
              className="p-1.5 bg-[#C69C6D] hover:bg-white text-black rounded transition-all active:scale-95"
            >
              <Plus size={14} strokeWidth={3} />
            </button>
          )}
        </div>
      </div>

      {/* ====== BULK BAR ====== */}
      {bulkMode && selectedCount > 0 && (
        <div className="shrink-0 px-3 py-1.5 bg-[#C69C6D]/10 border-b border-[#C69C6D]/30 flex items-center justify-between gap-2">
          <div className="flex items-center gap-2">
            <span className="text-[#C69C6D] font-bold text-[10px]">
              ƒê√£ ch·ªçn: {selectedCount}
            </span>
            <button
              onClick={onSelectAll}
              className="text-[10px] text-white/60 hover:text-white underline"
            >
              T·∫•t c·∫£
            </button>
            <button
              onClick={onClearSelection}
              className="text-[10px] text-white/60 hover:text-white underline"
            >
              B·ªè ch·ªçn
            </button>
          </div>
          <div className="flex items-center gap-1">
            {bulkActions.map((action) => {
              const Icon = action.icon;
              return (
                <button
                  key={action.id}
                  onClick={() => action.onClick([])}
                  className={`p-1.5 rounded transition-all ${
                    action.color === "danger"
                      ? "bg-red-600 hover:bg-red-700 text-white"
                      : "bg-white/5 text-white/60 hover:bg-white/10"
                  }`}
                >
                  {Icon && <Icon size={14} />}
                </button>
              );
            })}
          </div>
        </div>
      )}

      {/* ====== CONTENT AREA ====== */}
      <div className="flex-1 overflow-y-auto">
        {loading ? (
          <div className="h-full flex items-center justify-center">
            <div className="w-8 h-8 border-2 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
          </div>
        ) : (
          children
        )}
      </div>
    </div>
  );
}
</file>

<file path="components/KhungGiaoDien/KhungForm.tsx">
'use client';

/**
 * ============================================================
 * KHUNG FORM
 * ============================================================
 * 
 * Panel form inline (kh√¥ng ph·∫£i modal popup).
 * Style: Tab bar ngang + Actions g√≥c ph·∫£i (gi·ªëng GenericFormInline)
 */

import React, { ReactNode, useState, useRef } from 'react';
import { X, Save, Loader2, User, Camera, Plus } from 'lucide-react';

// ============================================================
// TYPES
// ============================================================

export interface KhungFormProps {
    // Data
    isEditing?: boolean;
    data?: any;
    onClose: () => void;
    
    // Header
    title?: string;
    avatar?: string;
    avatarFallback?: ReactNode;
    showAvatarUpload?: boolean;
    onAvatarChange?: (file: File | null) => void;
    
    // Form
    onSubmit?: () => void | Promise<void>;
    
    // State
    loading?: boolean;
    isDirty?: boolean;
    
    // Validation
    errors?: Record<string, string>;
    
    // Content
    children: ReactNode;
    
    // Style
    className?: string;
}

// ============================================================
// COMPONENT
// ============================================================

export default function KhungForm({
    isEditing = false,
    data,
    onClose,
    title,
    avatar,
    avatarFallback,
    showAvatarUpload = false,
    onAvatarChange,
    onSubmit,
    loading = false,
    isDirty = false,
    errors = {},
    children,
    className = '',
}: KhungFormProps) {
    const fileInputRef = useRef<HTMLInputElement>(null);
    const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
    const [showConfirm, setShowConfirm] = useState(false);

    const handleClose = () => {
        if (isDirty) {
            setShowConfirm(true);
        } else {
            onClose();
        }
    };

    const handleConfirmClose = () => {
        setShowConfirm(false);
        onClose();
    };

    const handleSubmit = async () => {
        if (loading) return;
        await onSubmit?.();
    };

    const handleAvatarClick = () => {
        fileInputRef.current?.click();
    };

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (file) {
            // Preview
            const reader = new FileReader();
            reader.onloadend = () => {
                setAvatarPreview(reader.result as string);
            };
            reader.readAsDataURL(file);
            
            // Callback
            onAvatarChange?.(file);
        }
    };

    const displayAvatar = avatarPreview || avatar;

    return (
        <div className={`w-full h-full flex flex-col bg-[#050505] overflow-hidden ${className}`}>
            
            {/* ====== TAB BAR ====== */}
            <div className="shrink-0 h-[40px] flex items-center border-b border-white/5 bg-[#0a0a0a]">
                
                {/* N√∫t ƒë√≥ng + Avatar + T√™n - c·ªë ƒë·ªãnh tr√°i */}
                <div className="shrink-0 flex items-center gap-2 px-2 border-r border-white/5">
                    <button 
                        onClick={handleClose} 
                        disabled={loading}
                        className="p-1.5 text-white/40 hover:text-white hover:bg-white/10 rounded transition-all disabled:opacity-50"
                    >
                        <X size={14} />
                    </button>
                    <div className="flex items-center gap-2 pr-2">
                        {/* Avatar v·ªõi upload */}
                        <div 
                            className={`relative w-6 h-6 rounded-full border border-[#C69C6D]/50 overflow-hidden bg-[#1a1a1a] shrink-0 ${showAvatarUpload ? 'cursor-pointer group' : ''}`}
                            onClick={showAvatarUpload ? handleAvatarClick : undefined}
                        >
                            {displayAvatar ? (
                                <img src={displayAvatar} alt="" className="w-full h-full object-cover" />
                            ) : avatarFallback ? (
                                <div className="w-full h-full flex items-center justify-center">
                                    {avatarFallback}
                                </div>
                            ) : (
                                <div className="w-full h-full flex items-center justify-center">
                                    <User size={10} className="text-[#C69C6D]/50" />
                                </div>
                            )}
                            
                            {/* Overlay camera icon */}
                            {showAvatarUpload && (
                                <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                                    <Camera size={10} className="text-white" />
                                </div>
                            )}
                        </div>
                        
                        <span className="text-[12px] font-bold text-[#C69C6D] uppercase tracking-wide">
                            {isEditing ? (title || 'S·ª¨A') : (title || 'TH√äM M·ªöI')}
                        </span>
                    </div>
                </div>

                {/* Spacer */}
                <div className="flex-1" />

                {/* Actions - c·ªë ƒë·ªãnh ph·∫£i */}
                <div className="shrink-0 flex items-center gap-1 px-2 border-l border-white/5">
                    <button 
                        onClick={handleClose} 
                        disabled={loading}
                        className="px-3 py-1.5 bg-white/5 hover:bg-white/10 text-white/60 rounded text-[10px] font-bold uppercase transition-all disabled:opacity-50"
                    >
                        H·ª¶Y
                    </button>
                    <button 
                        onClick={handleSubmit} 
                        disabled={loading}
                        className="px-3 py-1.5 bg-[#C69C6D] hover:bg-white text-black rounded text-[10px] font-bold uppercase transition-all disabled:opacity-50 flex items-center gap-1"
                    >
                        {loading ? (
                            <>
                                <Loader2 size={12} className="animate-spin" />
                                <span>ƒêANG L∆ØU...</span>
                            </>
                        ) : (
                            <>
                                <Save size={12} />
                                <span>L∆ØU</span>
                            </>
                        )}
                    </button>
                </div>
            </div>

            {/* Hidden file input */}
            {showAvatarUpload && (
                <input 
                    ref={fileInputRef}
                    type="file"
                    accept="image/*"
                    className="hidden"
                    onChange={handleFileChange}
                />
            )}

            {/* ====== CONTENT AREA ====== */}
            <div className="flex-1 overflow-y-auto p-4">
                <style jsx>{`.scrollbar-hide::-webkit-scrollbar { display: none; } .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }`}</style>
                
                {/* Avatar upload l·ªõn (n·∫øu c√≥) */}
                {showAvatarUpload && (
                    <div className="flex justify-center mb-6">
                        <div 
                            onClick={handleAvatarClick}
                            className="relative w-24 h-24 rounded-full border-2 border-[#C69C6D]/50 overflow-hidden bg-[#1a1a1a] cursor-pointer group"
                        >
                            {displayAvatar ? (
                                <img src={displayAvatar} alt="" className="w-full h-full object-cover" />
                            ) : (
                                <div className="w-full h-full flex items-center justify-center">
                                    <User size={32} className="text-[#C69C6D]/30" />
                                </div>
                            )}
                            
                            {/* Overlay */}
                            <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center transition-opacity">
                                <Camera size={20} className="text-white mb-1" />
                                <span className="text-[8px] text-white/80 uppercase">ƒê·ªïi ·∫£nh</span>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Form fields */}
                {children}
            </div>

            {/* ====== CONFIRM DIALOG ====== */}
            {showConfirm && (
                <div className="fixed inset-0 z-[110] flex items-center justify-center bg-black/80">
                    <div className="bg-[#1a1a1a] border border-white/10 rounded-xl p-6 max-w-sm mx-4 text-center">
                        <p className="text-white text-sm mb-6">B·∫°n c√≥ ch·∫Øc mu·ªën ƒë√≥ng? C√°c thay ƒë·ªïi ch∆∞a l∆∞u s·∫Ω m·∫•t.</p>
                        <div className="flex gap-3">
                            <button
                                onClick={() => setShowConfirm(false)}
                                className="flex-1 py-2 rounded-lg bg-white/5 text-white/60 font-bold text-xs uppercase hover:bg-white/10"
                            >
                                TI·∫æP T·ª§C
                            </button>
                            <button
                                onClick={handleConfirmClose}
                                className="flex-1 py-2 rounded-lg bg-red-600 text-white font-bold text-xs uppercase hover:bg-red-700"
                            >
                                ƒê√ìNG
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}
</file>

<file path="components/KhungTrangChuan.tsx">
'use client';

import React, { ReactNode } from 'react';
import MenuTren from '@/app/GiaoDienTong/MenuTren/MenuTren';
 
import { Z_INDEX } from '@/app/constants/zIndex';

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const BASE_IMG_URL = `${SUPABASE_URL}/storage/v1/object/public/hinh-nen`;

interface Props {
  children: ReactNode;
  nguoiDung: any;
  loiChao?: string;
  contentClassName?: string;
}

export default function KhungTrangChuan({ 
  children, 
  nguoiDung, 
  loiChao,
  contentClassName = "max-w-[1920px] mx-auto p-3 pb-24 md:p-6 md:pb-24 pt-24"
}: Props) {
  
  const bgUrlMobile = `${BASE_IMG_URL}/trangchu-mobile.jpg`;
  const bgUrlTablet = `${BASE_IMG_URL}/trangchu-tablet.jpg`;
  const bgUrlDesktop = `${BASE_IMG_URL}/trangchu-desktop.jpg`;

  const displayLoiChao = loiChao || `Xin ch√†o, ${nguoiDung?.ho_ten || 'User'}`;

  return (
    <div className="relative w-full min-h-screen bg-[#050505] text-[#F5F5F5] font-sans overflow-x-hidden selection:bg-[#C69C6D] selection:text-black text-[14px]">
      
      {/* LAYER 0: H√åNH N·ªÄN CHU·∫®N */}
      <div className="fixed inset-0 w-full h-full z-0 pointer-events-none select-none bg-black">
         <img src={bgUrlMobile} alt="BG" className="absolute inset-0 w-full h-full object-cover md:hidden opacity-100" />
         <img src={bgUrlTablet} alt="BG" className="absolute inset-0 w-full h-full object-cover hidden md:block lg:hidden opacity-100" />
         <img src={bgUrlDesktop} alt="BG" className="absolute inset-0 w-full h-full object-cover hidden lg:block opacity-100" />
         <div className="absolute inset-0 bg-gradient-to-t from-black via-black/60 to-black/40" />
      </div>

      {/* LAYER 1: N·ªòI DUNG CH√çNH */}
      <main className={`relative z-[10] w-full min-h-screen flex flex-col ${contentClassName}`}>
        {children}
      </main>

      {/* LAYER 2: GRADIENT B·∫¢O V·ªÜ MENU */}
      <div className="fixed top-0 left-0 right-0 h-28 bg-gradient-to-b from-black to-transparent z-[4900] pointer-events-none"></div>
      <div className="fixed bottom-0 left-0 right-0 h-28 bg-gradient-to-t from-black to-transparent z-[4900] pointer-events-none"></div>

      {/* LAYER 3: H·ªÜ TH·ªêNG MENU */}
      <MenuTren nguoiDung={nguoiDung} loiChao={displayLoiChao} />
      
     
    </div>
  );
}
</file>

<file path="components/NutHoTro.tsx">
"use client";

import React, { useState, useEffect, useRef } from "react";
import {
  MessageCircle,
  Phone,
  X,
  Send,
  Zap,
  LogIn,
  User,
  AlertTriangle,
  ShieldCheck,
  Image as ImageIcon,
  Loader2,
} from "lucide-react";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { useUser } from "@/app/ThuVien/UserContext";
import { useRouter } from "next/navigation";
import { compressImage } from "@/app/ThuVien/compressImage";

// Hook √¢m thanh (Click Effect)
const useSoundEffect = () => {
  const audioRef = useRef<HTMLAudioElement | null>(null);
  useEffect(() => {
    if (typeof window !== "undefined") {
      audioRef.current = new Audio("/sounds/click.mp3");
      audioRef.current.volume = 0.5;
    }
  }, []);

  return () => {
    if (audioRef.current) {
      audioRef.current.currentTime = 0;
      audioRef.current.play().catch(() => {});
    }
  };
};

export default function NutHoTro() {
  const { user } = useUser();
  const router = useRouter();
  const playClick = useSoundEffect();

  // UI State
  const [isOpen, setIsOpen] = useState(false);
  const [viewMode, setViewMode] = useState<"form_guest" | "chat">("form_guest");
  const [isSending, setIsSending] = useState(false);

  // Data State
  const [guestInfo, setGuestInfo] = useState({ name: "", phone: "" });
  const [messages, setMessages] = useState<any[]>([]);
  const [inputMsg, setInputMsg] = useState("");
  const [sessionId, setSessionId] = useState<string | null>(null);
  const [onlineStaffCount, setOnlineStaffCount] = useState(0);

  // Refs
  const scrollRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // 1. KI·ªÇM TRA TR·∫†NG TH√ÅI NG∆Ø·ªúI D√ôNG KHI M·ªû
  useEffect(() => {
    if (isOpen) {
      if (user) {
        // ƒê√£ ƒëƒÉng nh·∫≠p -> V√†o th·∫≥ng chat
        setViewMode("chat");
        initChatSession(
          user.id,
          user.ho_ten || "Kh√°ch h√†ng",
          user.so_dien_thoai
        );
      } else {
        // Kh√°ch v√£ng lai -> Check localStorage
        const savedGuest = localStorage.getItem("guest_chat_info");
        if (savedGuest) {
          const parsed = JSON.parse(savedGuest);
          setGuestInfo(parsed);
          setViewMode("chat");
          initChatSession(null, parsed.name, parsed.phone);
        } else {
          setViewMode("form_guest");
        }
      }
    }
  }, [isOpen, user]);

  // 2. REALTIME STAFF COUNT
  useEffect(() => {
    const channel = supabase.channel("online-users-counter");
    channel
      .on("presence", { event: "sync" }, () => {
        const state = channel.presenceState();
        setOnlineStaffCount(Object.keys(state).length);
      })
      .subscribe();
    return () => {
      supabase.removeChannel(channel);
    };
  }, []);

  // 3. AUTO SCROLL
  useEffect(() => {
    if (scrollRef.current)
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
  }, [messages, viewMode, isOpen]); // Th√™m dependencies ƒë·ªÉ scroll nh·∫°y h∆°n

  // Logic ki·ªÉm tra 3 c√¢u ch∆∞a tr·∫£ l·ªùi
  const showUrgentCall = React.useMemo(() => {
    if (messages.length < 3) return false;
    const last3 = messages.slice(-3);
    // N·∫øu 3 tin cu·ªëi ƒë·ªÅu l√† c·ªßa kh√°ch (la_nhan_vien = false) -> Hi·ªán c·∫£nh b√°o
    return last3.every((m) => !m.la_nhan_vien);
  }, [messages]);

  // 4. H√ÄM KH·ªûI T·∫†O PHI√äN CHAT (QUAN TR·ªåNG: ƒê√É S·ª¨A BUG M·∫§T SESSION)
  const initChatSession = async (
    userId: string | null,
    name: string,
    phone: string | null
  ) => {
    // üü¢ FIX: T√¨m phi√™n chat ch∆∞a k·∫øt th√∫c (bao g·ªìm c·∫£ 'cho_tu_van' v√† 'dang_tu_van')
    let query = supabase
      .from("tu_van_sessions")
      .select("id")
      .neq("trang_thai", "ket_thuc"); // Kh√¥ng l·∫•y phi√™n ƒë√£ ƒë√≥ng

    if (userId) {
      query = query.eq("khach_hang_id", userId);
    } else {
      // V·ªõi kh√°ch v√£ng lai, t√¨m theo SƒêT ho·∫∑c LocalStorage ID
      // ∆Øu ti√™n SƒêT v√¨ n√≥ ƒë·ªãnh danh t·ªët h∆°n
      query = query.eq("sdt_lien_he", phone);
    }

    // L·∫•y phi√™n m·ªõi nh·∫•t
    const { data: existingList } = await query
      .order("cap_nhat_luc", { ascending: false })
      .limit(1);
    const existing =
      existingList && existingList.length > 0 ? existingList[0] : null;

    if (existing) {
      console.log("üü¢ Found existing session:", existing.id);
      setSessionId(existing.id);
      subscribeToChat(existing.id);
    } else {
      console.log("‚ö™ No active session found, ready to create new one.");
    }
  };

  const subscribeToChat = async (sId: string) => {
    // L·∫•y tin nh·∫Øn c≈©
    const { data } = await supabase
      .from("tu_van_messages")
      .select("*")
      .eq("session_id", sId)
      .order("tao_luc", { ascending: true });
    if (data) setMessages(data);

    // L·∫Øng nghe tin nh·∫Øn m·ªõi
    const channel = supabase
      .channel(`guest_chat_${sId}`)
      .on(
        "postgres_changes",
        {
          event: "INSERT",
          schema: "public",
          table: "tu_van_messages",
          filter: `session_id=eq.${sId}`,
        },
        (payload) => {
          setMessages((prev) => [...prev, payload.new]);
          // Scroll xu·ªëng khi c√≥ tin m·ªõi
          if (scrollRef.current)
            scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  };

  // 5. X·ª¨ L√ù G·ª¨I TIN
  const handleSend = async (file?: File) => {
    if (!inputMsg.trim() && !file) return;

    playClick();
    setIsSending(true);
    const text = inputMsg;
    setInputMsg("");

    try {
      let activeSessionId = sessionId;
      let imageUrl = null;

      // Upload ·∫£nh n·∫øu c√≥
      if (file) {
        try {
          const compressed = await compressImage(file, 0.7, 1200);
          const fileName = `chat_${Date.now()}_${file.name.replace(
            /[^a-zA-Z0-9.]/g,
            ""
          )}`;
          const { error: upErr } = await supabase.storage
            .from("images")
            .upload(fileName, compressed);
          if (upErr) throw upErr;
          const { data: urlData } = supabase.storage
            .from("images")
            .getPublicUrl(fileName);
          imageUrl = urlData.publicUrl;
        } catch (e) {
          console.error("Upload error:", e);
          setIsSending(false);
          return;
        }
      }

      // T·∫°o session n·∫øu ch∆∞a c√≥
      if (!activeSessionId) {
        const { data: newSession, error } = await supabase
          .from("tu_van_sessions")
          .insert({
            khach_hang_id: user?.id || null, // N·∫øu ƒë√£ login
            khach_vang_lai_id: !user ? `guest_${Date.now()}` : null,
            ten_hien_thi: user?.ho_ten || guestInfo.name,
            sdt_lien_he: user?.so_dien_thoai || guestInfo.phone,
            loai_khach: user ? "thanh_vien" : "vang_lai",
            trang_thai: "cho_tu_van",
            tin_nhan_cuoi: imageUrl ? "[H√¨nh ·∫£nh]" : text,
          })
          .select()
          .single();

        if (error) throw error;
        activeSessionId = newSession.id;
        setSessionId(newSession.id);
        subscribeToChat(newSession.id);
      } else {
        // Update tin nh·∫Øn cu·ªëi
        await supabase
          .from("tu_van_sessions")
          .update({
            tin_nhan_cuoi: imageUrl
              ? text
                ? `[·∫¢nh] ${text}`
                : "[H√¨nh ·∫£nh]"
              : text,
            cap_nhat_luc: new Date().toISOString(),
          })
          .eq("id", activeSessionId);
      }

      // Insert tin nh·∫Øn
      await supabase.from("tu_van_messages").insert({
        session_id: activeSessionId,
        nguoi_gui_id: user?.id || "guest",
        la_nhan_vien: false,
        noi_dung: text,
        hinh_anh: imageUrl,
      });
    } catch (err) {
      console.error(err);
    } finally {
      setIsSending(false);
      if (fileInputRef.current) fileInputRef.current.value = "";
    }
  };

  // 6. SUBMIT FORM
  const handleGuestSubmit = () => {
    playClick();
    if (!guestInfo.name.trim() || !guestInfo.phone.trim()) {
      alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß T√™n v√† SƒêT!");
      return;
    }
    localStorage.setItem("guest_chat_info", JSON.stringify(guestInfo));
    setViewMode("chat");
    initChatSession(null, guestInfo.name, guestInfo.phone);
  };

  const handleGoToLogin = () => {
    playClick();
    setIsOpen(false);
    router.push("/?login=1");
  };

  // üü¢ CHECK ADMIN - N·∫øu l√† nh√¢n s·ª± th√¨ KH√îNG hi·ªán n√∫t n√†y (d√πng TuVanKhachHang.tsx thay th·∫ø)
  if (user?.userType === "nhan_su") return null;

  return (
    <>
      <style jsx global>{`
        .cyber-panel {
          background: rgba(20, 18, 16, 0.95);
          border: 1px solid rgba(198, 156, 109, 0.3);
          box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.8);
          border-radius: 16px;
          backdrop-filter: blur(12px);
        }
        .cyber-input {
          background: rgba(255, 255, 255, 0.03);
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
          border-top: none;
          border-left: none;
          border-right: none;
          color: #f5e6d3;
          font-family: serif;
          transition: all 0.3s;
        }
        .cyber-input:focus {
          border-bottom-color: #c69c6d;
          background: rgba(198, 156, 109, 0.05);
        }
        .chat-bubble-guest {
          background: #c69c6d;
          color: #1a120f;
          border-radius: 12px 12px 2px 12px;
        }
        .chat-bubble-staff {
          background: rgba(255, 255, 255, 0.1);
          color: #f5e6d3;
          border: 1px solid rgba(255, 255, 255, 0.05);
          border-radius: 12px 12px 12px 2px;
        }
      `}</style>

      <div className="fixed bottom-6 left-6 z-[9000] font-sans flex flex-col items-start gap-4">
        {isOpen && (
          <div className="cyber-panel w-[320px] h-[480px] flex flex-col animate-in slide-in-from-bottom-5 duration-300 backdrop-blur-xl">
            <div className="flex justify-between items-center p-4 border-b border-[#C69C6D]/30 bg-black/40">
              <div className="flex items-center gap-2">
                <ShieldCheck className="text-[#C69C6D]" size={18} />
                <div>
                  <h3 className="text-xs font-bold text-[#C69C6D] uppercase tracking-widest">
                    H·ªó Tr·ª£ Tr·ª±c Tuy·∫øn
                  </h3>
                  <div className="flex items-center gap-1 mt-0.5">
                    <div
                      className={`w-1.5 h-1.5 rounded-full ${
                        onlineStaffCount > 0
                          ? "bg-green-500 animate-pulse"
                          : "bg-red-500"
                      }`}
                    ></div>
                    <span className="text-[9px] text-white/50">
                      {onlineStaffCount > 0
                        ? "Nh√¢n vi√™n Online"
                        : "Nh√¢n vi√™n Offline"}
                    </span>
                  </div>
                </div>
              </div>
              <button
                onClick={() => setIsOpen(false)}
                className="text-white/50 hover:text-white"
              >
                <X size={18} />
              </button>
            </div>

            {viewMode === "form_guest" && (
              <div className="flex-1 p-6 flex flex-col justify-center space-y-5">
                <div className="text-center space-y-2">
                  <User size={40} className="mx-auto text-[#C69C6D]/80" />
                  <h4 className="text-white font-bold text-sm">
                    TH√îNG TIN LI√äN H·ªÜ
                  </h4>
                  <p className="text-white/50 text-xs">
                    Vui l√≤ng cho bi·∫øt t√™n v√† s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ nh√¢n vi√™n h·ªó tr·ª£
                    b·∫°n t·ªët nh·∫•t.
                  </p>
                </div>
                <div className="space-y-3">
                  <input
                    placeholder="H·ªç v√† t√™n c·ªßa b·∫°n..."
                    className="cyber-input w-full p-3 rounded text-xs outline-none"
                    value={guestInfo.name}
                    onChange={(e) =>
                      setGuestInfo({ ...guestInfo, name: e.target.value })
                    }
                  />
                  <input
                    placeholder="S·ªë ƒëi·ªán tho·∫°i / Email..."
                    className="cyber-input w-full p-3 rounded text-xs outline-none"
                    value={guestInfo.phone}
                    onChange={(e) =>
                      setGuestInfo({ ...guestInfo, phone: e.target.value })
                    }
                  />
                </div>
                <button
                  onClick={handleGuestSubmit}
                  className="w-full py-3 bg-[#C69C6D] hover:bg-white text-black font-bold text-xs uppercase tracking-widest transition-all rounded clip-path-polygon"
                >
                  B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán
                </button>
                <div className="relative border-t border-white/10 my-4 text-center">
                  <span className="bg-[#0a0a0a] px-2 text-[9px] text-white/30 absolute -top-2 left-1/2 -translate-x-1/2">
                    HO·∫∂C
                  </span>
                </div>
                <button
                  onClick={handleGoToLogin}
                  className="flex items-center justify-center gap-2 w-full py-2.5 border border-white/20 hover:border-[#C69C6D] text-white/70 hover:text-[#C69C6D] text-xs font-bold uppercase transition-all rounded"
                >
                  <LogIn size={14} /> ƒêƒÉng Nh·∫≠p T√†i Kho·∫£n
                </button>
              </div>
            )}

            {viewMode === "chat" && (
              <>
                <div
                  className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-black/20"
                  ref={scrollRef}
                >
                  <div className="text-center text-[10px] text-white/20 uppercase tracking-widest my-2 font-mono">
                    --- Secure Channel Opened ---
                  </div>
                  {messages.map((m) => (
                    <div
                      key={m.id}
                      className={`flex ${
                        m.la_nhan_vien ? "justify-start" : "justify-end"
                      }`}
                    >
                      <div
                        className={`max-w-[85%] p-3 text-xs font-medium ${
                          m.la_nhan_vien
                            ? "chat-bubble-staff"
                            : "chat-bubble-guest"
                        }`}
                      >
                        {m.hinh_anh && (
                          <img
                            src={m.hinh_anh}
                            alt="img"
                            className="w-full h-auto rounded-lg mb-2 border border-black/20"
                          />
                        )}
                        {m.noi_dung}
                      </div>
                    </div>
                  ))}
                  {showUrgentCall && (
                    <div className="bg-red-900/20 border border-red-500/50 p-3 rounded-lg flex gap-3 animate-pulse mt-4">
                      <AlertTriangle
                        className="text-red-500 shrink-0"
                        size={20}
                      />
                      <div>
                        <p className="text-red-400 text-xs font-bold mb-1">
                          H·ªÜ TH·ªêNG ƒêANG B·∫¨N
                        </p>
                        <p className="text-white/70 text-[10px] mb-2">
                          Ch∆∞a c√≥ ph·∫£n h·ªìi. Vui l√≤ng g·ªçi:
                        </p>
                        <div className="flex gap-2">
                          <a
                            href="tel:0939941588"
                            className="bg-red-600 hover:bg-red-500 text-white text-[9px] px-2 py-1 rounded font-bold"
                          >
                            MS. CHI
                          </a>
                          <a
                            href="tel:0939852511"
                            className="bg-red-600 hover:bg-red-500 text-white text-[9px] px-2 py-1 rounded font-bold"
                          >
                            MR. TOMMY
                          </a>
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                <div className="p-3 bg-[#111] border-t border-white/10 flex gap-2 items-center">
                  {/* üü¢ N√∫t ch·ªçn ·∫£nh */}
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    disabled={isSending}
                    className="p-2 text-gray-400 hover:text-[#C69C6D] transition-colors"
                    title="G·ª≠i ·∫£nh"
                  >
                    <ImageIcon size={18} />
                  </button>
                  <input
                    type="file"
                    ref={fileInputRef}
                    className="hidden"
                    accept="image/*"
                    onChange={(e) => {
                      if (e.target.files?.[0]) handleSend(e.target.files[0]);
                    }}
                  />

                  <input
                    className="flex-1 bg-white/5 border border-white/10 rounded-md px-3 py-2 text-xs text-white focus:border-[#C69C6D] outline-none placeholder-white/30"
                    placeholder={isSending ? "ƒêang g·ª≠i..." : "Nh·∫≠p tin nh·∫Øn..."}
                    value={inputMsg}
                    onChange={(e) => setInputMsg(e.target.value)}
                    onKeyDown={(e) => e.key === "Enter" && handleSend()}
                    disabled={isSending}
                  />
                  <button
                    onClick={() => handleSend()}
                    disabled={isSending}
                    className="p-2 bg-[#C69C6D] hover:bg-white text-black rounded transition-colors disabled:opacity-50"
                  >
                    {isSending ? (
                      <Loader2 size={16} className="animate-spin" />
                    ) : (
                      <Send size={16} />
                    )}
                  </button>
                </div>
              </>
            )}
          </div>
        )}

        <button
          onClick={() => {
            playClick();
            setIsOpen(!isOpen);
          }}
          className={`w-14 h-14 flex items-center justify-center rounded-full shadow-[0_0_20px_rgba(198,156,109,0.6)] transition-all active:scale-95 border-2 ${
            isOpen
              ? "bg-white border-white rotate-90 text-black"
              : "bg-[#0a0a0a] border-[#C69C6D] text-[#C69C6D] animate-bounce-slow"
          }`}
        >
          {isOpen ? <X size={24} /> : <Zap size={28} fill="currentColor" />}
          {!isOpen && onlineStaffCount > 0 && (
            <span className="absolute -top-1 -right-1 flex h-4 w-4">
              <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
              <span className="relative inline-flex rounded-full h-4 w-4 bg-green-500 border border-black"></span>
            </span>
          )}
        </button>
      </div>
    </>
  );
}
</file>

<file path="components/PushManager.tsx">
'use client';
import React, { useEffect, useState } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import { BellRing, Loader2 } from 'lucide-react';

const VAPID_PUBLIC_KEY = process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY;

// H√†m chuy·ªÉn ƒë·ªïi key VAPID
function urlBase64ToUint8Array(base64String: string) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

export default function PushManager() {
    const { user } = useUser();
    const [isSupported, setIsSupported] = useState(false);
    const [subscription, setSubscription] = useState<PushSubscription | null>(null);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if ('serviceWorker' in navigator && 'PushManager' in window) {
            setIsSupported(true);
            registerServiceWorker();
        }
    }, []);

    const registerServiceWorker = async () => {
        try {
            const registration = await navigator.serviceWorker.register('/sw.js', {
                scope: '/',
                updateViaCache: 'none',
            });
            
            // Check n·∫øu ƒë√£ subscribe r·ªìi
            const sub = await registration.pushManager.getSubscription();
            setSubscription(sub);
        } catch (error) {
            console.error('Service Worker Error:', error);
        }
    };

    const subscribeToPush = async () => {
        if (!user || !VAPID_PUBLIC_KEY) return;
        setLoading(true);

        try {
            const registration = await navigator.serviceWorker.ready;
            
            // 1. Y√™u c·∫ßu tr√¨nh duy·ªát c·∫•p quy·ªÅn (N√≥ s·∫Ω hi·ªán popup c·ªßa Chrome/Safari)
            const sub = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
            });

            // 2. G·ª≠i v·ªÅ Server l∆∞u l·∫°i
            await fetch('/api/push/subscribe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    subscription: sub,
                    user_id: user.id,
                    user_agent: navigator.userAgent
                })
            });

            setSubscription(sub);
            alert("ƒê√£ b·∫≠t th√¥ng b√°o th√†nh c√¥ng! B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c tin t·ª©c m·ªõi nh·∫•t ngay tr√™n m√†n h√¨nh kh√≥a.");
        } catch (error) {
            console.error('Subscription failed:', error);
            alert("Vui l√≤ng ki·ªÉm tra l·∫°i quy·ªÅn th√¥ng b√°o trong c√†i ƒë·∫∑t tr√¨nh duy·ªát.");
        } finally {
            setLoading(false);
        }
    };

    // N·∫øu ch∆∞a h·ªó tr·ª£, ho·∫∑c ƒë√£ ƒëƒÉng k√Ω r·ªìi th√¨ ·∫©n
    if (!isSupported || subscription || !user) return null;

    return (
        <div className="fixed bottom-24 left-6 z-[8000] animate-in slide-in-from-left duration-500">
            <button 
                onClick={subscribeToPush}
                disabled={loading}
                className="flex items-center gap-3 px-4 py-3 bg-[#C69C6D] hover:bg-white text-black font-bold rounded-xl shadow-[0_0_20px_rgba(198,156,109,0.4)] transition-all active:scale-95 group"
            >
                <div className="bg-black/10 p-1.5 rounded-full">
                    {loading ? <Loader2 size={16} className="animate-spin"/> : <BellRing size={16} className="animate-wiggle"/>}
                </div>
                <div className="text-left">
                    <p className="text-[10px] uppercase tracking-wider opacity-70">ƒê·ª´ng b·ªè l·ª°</p>
                    <p className="text-xs font-black">B·∫¨T TH√îNG B√ÅO ƒê·∫®Y</p>
                </div>
            </button>
            <style jsx>{`
                @keyframes wiggle { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }
                .animate-wiggle { animation: wiggle 0.3s ease-in-out infinite; }
            `}</style>
        </div>
    );
}
</file>

<file path="components/RegisterForm.tsx">
'use client';

import React, { useState } from 'react';
import { createClient } from '@supabase/supabase-js';
import { Mail, Phone, Lock, Eye, EyeOff, UserPlus, Users, Briefcase } from 'lucide-react';
import { DataNormalizer } from '@/app/ThuVien/DataNormalizer';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

interface RegisterFormProps {
  onSuccess?: () => void;
  onSwitchToLogin?: () => void;
}

export default function RegisterForm({ onSuccess, onSwitchToLogin }: RegisterFormProps) {
  const [step, setStep] = useState<1 | 2>(1);
  const [userType, setUserType] = useState<'nhan_su' | 'khach_hang'>('khach_hang');
  
  const [hoTen, setHoTen] = useState('');
  const [email, setEmail] = useState('');
  const [phone, setPhone] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  
  const [requestedViTri, setRequestedViTri] = useState('Sales'); // For nhan_su
  
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);

  const handleRegister = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);

    try {
      // Frontend validation
      if (!hoTen || hoTen.length < 3) {
        setError('H·ªç t√™n ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±');
        setLoading(false);
        return;
      }

      if (!email || !email.includes('@')) {
        setError('Email kh√¥ng h·ª£p l·ªá');
        setLoading(false);
        return;
      }

      if (!phone || phone.length < 10) {
        setError('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá');
        setLoading(false);
        return;
      }

      if (!password || password.length < 6) {
        setError('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±');
        setLoading(false);
        return;
      }

      if (password !== confirmPassword) {
        setError('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp');
        setLoading(false);
        return;
      }

      // Check if user already exists (direct query)
      const { data: existingNhanSu } = await supabase
        .from('nhan_su')
        .select('id')
        .or(`email.eq.${email.trim().toLowerCase()},so_dien_thoai.eq.${phone.trim()}`)
        .single();

      if (existingNhanSu) {
        setError('Email ho·∫∑c s·ªë ƒëi·ªán tho·∫°i ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng');
        setLoading(false);
        return;
      }

      const { data: existingKhachHang } = await supabase
        .from('khach_hang')
        .select('id')
        .or(`email.eq.${email.trim().toLowerCase()},so_dien_thoai.eq.${phone.trim()}`)
        .single();

      if (existingKhachHang) {
        setError('Email ho·∫∑c s·ªë ƒëi·ªán tho·∫°i ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng');
        setLoading(false);
        return;
      }

      // Create auth user
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email: email.trim().toLowerCase(),
        password,
        phone: phone.trim(),
      });

      if (authError) {
        setError('L·ªói ƒëƒÉng k√Ω: ' + authError.message);
        setLoading(false);
        return;
      }

      if (!authData.user) {
        setError('Kh√¥ng th·ªÉ t·∫°o t√†i kho·∫£n');
        setLoading(false);
        return;
      }

      // Create registration request
      const { error: regError } = await supabase.from('user_registrations').insert({
        auth_user_id: authData.user.id,
        ho_ten: hoTen.trim(),
        email: email.trim().toLowerCase(),
        so_dien_thoai: phone.trim(),
        user_type: userType,
        requested_vi_tri: userType === 'nhan_su' ? requestedViTri : null,
        requested_phan_loai: userType === 'khach_hang' ? 'KH Tr·ªçng t√¢m' : null,
        status: 'pending',
      });

      if (regError) {
        setError('L·ªói t·∫°o ƒë∆°n ƒëƒÉng k√Ω: ' + regError.message);
        setLoading(false);
        return;
      }

      // Success
      setSuccess(true);
      setTimeout(() => {
        onSuccess?.();
      }, 3000);
    } catch (err: any) {
      setError('L·ªói: ' + err.message);
    } finally {
      setLoading(false);
    }
  };

  if (success) {
    return (
      <div className="w-full max-w-md bg-[#1a120f] border border-[#C69C6D]/30 rounded-xl p-8 shadow-2xl text-center">
        <div className="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
          <UserPlus size={32} className="text-green-400" />
        </div>
        <h2 className="text-2xl font-bold text-[#C69C6D] mb-2">ƒêƒÉng k√Ω th√†nh c√¥ng!</h2>
        <p className="text-white/70 text-sm mb-4">
          ƒê∆°n ƒëƒÉng k√Ω c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i. Vui l√≤ng ch·ªù admin x√©t duy·ªát.
        </p>
        <p className="text-white/50 text-xs">B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c email th√¥ng b√°o khi t√†i kho·∫£n ƒë∆∞·ª£c k√≠ch ho·∫°t.</p>
      </div>
    );
  }

  if (step === 1) {
    return (
      <div className="w-full max-w-md bg-[#1a120f] border border-[#C69C6D]/30 rounded-xl p-8 shadow-2xl">
        <h2 className="text-3xl font-bold text-[#C69C6D] mb-2 text-center">ƒêƒÉng k√Ω t√†i kho·∫£n</h2>
        <p className="text-white/50 text-sm text-center mb-6">Ch·ªçn lo·∫°i t√†i kho·∫£n b·∫°n mu·ªën ƒëƒÉng k√Ω</p>

        <div className="space-y-4">
          <button
            onClick={() => {
              setUserType('khach_hang');
              setStep(2);
            }}
            className="w-full bg-white/5 hover:bg-[#C69C6D]/20 border border-[#C69C6D]/30 hover:border-[#C69C6D] rounded-xl p-6 transition-all active:scale-95 group"
          >
            <Users size={32} className="text-[#C69C6D] mx-auto mb-3 group-hover:scale-110 transition-transform" />
            <h3 className="text-white font-bold text-lg mb-1">Kh√°ch h√†ng</h3>
            <p className="text-white/50 text-sm">D√†nh cho kh√°ch h√†ng mua h√†ng, xem s·∫£n ph·∫©m</p>
          </button>

          <button
            onClick={() => {
              setUserType('nhan_su');
              setStep(2);
            }}
            className="w-full bg-white/5 hover:bg-[#C69C6D]/20 border border-[#C69C6D]/30 hover:border-[#C69C6D] rounded-xl p-6 transition-all active:scale-95 group"
          >
            <Briefcase size={32} className="text-[#C69C6D] mx-auto mb-3 group-hover:scale-110 transition-transform" />
            <h3 className="text-white font-bold text-lg mb-1">Nh√¢n s·ª±</h3>
            <p className="text-white/50 text-sm">D√†nh cho nh√¢n vi√™n, qu·∫£n l√Ω, admin</p>
          </button>
        </div>

        {onSwitchToLogin && (
          <div className="mt-6 text-center">
            <p className="text-white/50 text-sm">
              ƒê√£ c√≥ t√†i kho·∫£n?{' '}
              <button
                onClick={onSwitchToLogin}
                className="text-[#C69C6D] hover:text-white font-bold transition-colors"
              >
                ƒêƒÉng nh·∫≠p ngay
              </button>
            </p>
          </div>
        )}
      </div>
    );
  }

  return (
    <div className="w-full max-w-md bg-[#1a120f] border border-[#C69C6D]/30 rounded-xl p-8 shadow-2xl">
      <button
        onClick={() => setStep(1)}
        className="text-white/50 hover:text-white text-sm mb-4 transition-colors"
      >
        ‚Üê Quay l·∫°i
      </button>

      <h2 className="text-3xl font-bold text-[#C69C6D] mb-2 text-center">
        ƒêƒÉng k√Ω {userType === 'nhan_su' ? 'Nh√¢n s·ª±' : 'Kh√°ch h√†ng'}
      </h2>
      <p className="text-white/50 text-sm text-center mb-6">ƒêi·ªÅn th√¥ng tin c·ªßa b·∫°n</p>

      {error && (
        <div className="bg-red-900/30 border border-red-500 rounded-lg p-3 mb-4 text-red-200 text-sm">
          {error}
        </div>
      )}

      <form onSubmit={handleRegister} className="space-y-4">
        <div>
          <label className="block text-white/70 text-sm font-bold mb-2">H·ªç v√† t√™n</label>
          <input
            type="text"
            value={hoTen}
            onChange={(e) => setHoTen(e.target.value)}
            placeholder="Nguy·ªÖn VƒÉn A"
            className="w-full bg-black/40 border border-[#8B5E3C]/30 rounded-lg px-4 py-3 text-white placeholder-white/30 focus:outline-none focus:border-[#C69C6D] transition-all"
            required
          />
        </div>

        <div>
          <label className="block text-white/70 text-sm font-bold mb-2">Email</label>
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="example@email.com"
            className="w-full bg-black/40 border border-[#8B5E3C]/30 rounded-lg px-4 py-3 text-white placeholder-white/30 focus:outline-none focus:border-[#C69C6D] transition-all"
            required
          />
        </div>

        <div>
          <label className="block text-white/70 text-sm font-bold mb-2">S·ªë ƒëi·ªán tho·∫°i</label>
          <input
            type="tel"
            value={phone}
            onChange={(e) => setPhone(e.target.value)}
            placeholder="0123456789"
            className="w-full bg-black/40 border border-[#8B5E3C]/30 rounded-lg px-4 py-3 text-white placeholder-white/30 focus:outline-none focus:border-[#C69C6D] transition-all"
            required
          />
        </div>

        {userType === 'nhan_su' && (
          <div>
            <label className="block text-white/70 text-sm font-bold mb-2">V·ªã tr√≠ mong mu·ªën</label>
            <select
              value={requestedViTri}
              onChange={(e) => setRequestedViTri(e.target.value)}
              className="w-full bg-black/40 border border-[#8B5E3C]/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-[#C69C6D] transition-all"
            >
              <option value="Sales">Sales</option>
              <option value="Qu·∫£n l√Ω">Qu·∫£n l√Ω</option>
            </select>
            <p className="text-white/40 text-xs mt-1">* V·ªã tr√≠ Admin do admin ch·ªâ ƒë·ªãnh</p>
          </div>
        )}

        <div>
          <label className="block text-white/70 text-sm font-bold mb-2">M·∫≠t kh·∫©u</label>
          <div className="relative">
            <input
              type={showPassword ? 'text' : 'password'}
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              className="w-full bg-black/40 border border-[#8B5E3C]/30 rounded-lg px-4 py-3 text-white placeholder-white/30 focus:outline-none focus:border-[#C69C6D] transition-all pr-12"
              required
            />
            <button
              type="button"
              onClick={() => setShowPassword(!showPassword)}
              className="absolute right-3 top-1/2 -translate-y-1/2 text-white/50 hover:text-white transition-colors"
            >
              {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
            </button>
          </div>
        </div>

        <div>
          <label className="block text-white/70 text-sm font-bold mb-2">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
          <input
            type="password"
            value={confirmPassword}
            onChange={(e) => setConfirmPassword(e.target.value)}
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            className="w-full bg-black/40 border border-[#8B5E3C]/30 rounded-lg px-4 py-3 text-white placeholder-white/30 focus:outline-none focus:border-[#C69C6D] transition-all"
            required
          />
        </div>

        <button
          type="submit"
          disabled={loading}
          className="w-full bg-[#C69C6D] hover:bg-[#B58B5D] text-black font-bold py-3 rounded-lg uppercase tracking-wider transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {loading ? (
            <>
              <div className="w-5 h-5 border-2 border-black border-t-transparent rounded-full animate-spin"></div>
              ƒêang ƒëƒÉng k√Ω...
            </>
          ) : (
            <>
              <UserPlus size={18} />
              ƒêƒÉng k√Ω
            </>
          )}
        </button>
      </form>
    </div>
  );
}
</file>

<file path="components/StaffPresence.tsx">
'use client';
import { useEffect } from 'react';
import { supabase } from '@/app/ThuVien/ketNoiSupabase';
import { useUser } from '@/app/ThuVien/UserContext';

export default function StaffPresence() {
    const { user } = useUser();

    useEffect(() => {
        // Ch·ªâ ch·∫°y n·∫øu l√† nh√¢n s·ª±
        if (!user || user.userType !== 'nhan_su') return;

        // T·∫°o k√™nh 'online-users'
        const channel = supabase.channel('online-users', {
            config: {
                presence: {
                    key: user.id, // ID ƒë·ªãnh danh
                },
            },
        });

        channel
            .on('presence', { event: 'sync' }, () => {
                // Console log ƒë·ªÉ debug ch∆°i th√¥i
                console.log('üì° ƒê√£ ph√°t t√≠n hi·ªáu online:', user.ho_ten);
            })
            .subscribe(async (status) => {
                if (status === 'SUBSCRIBED') {
                    // G·ª≠i th√¥ng tin nh√¢n vi√™n l√™n k√™nh
                    await channel.track({
                        id: user.id,
                        name: user.ho_ten,
                        role: user.role, // 'admin', 'quanly', 'sales'
                        online_at: new Date().toISOString(),
                    });
                }
            });

        return () => {
            supabase.removeChannel(channel);
        };
    }, [user]);

    return null; // Component n√†y kh√¥ng hi·ªán g√¨ c·∫£, ch·ªâ ch·∫°y ng·∫ßm
}
</file>

<file path="components/ThanhPhongChucNang.tsx">
'use client';
import React, { useState, useRef } from 'react';
import { ChevronLeft, ChevronRight, ChevronDown, Check } from 'lucide-react';

interface FunctionItem {
    id: string;
    label: string;
    icon: React.ElementType;
}

interface Props {
    tenPhong: string;
    functions: FunctionItem[];
    activeFunction: string;
    onFunctionChange: (id: string) => void;
}

export default function ThanhPhongChucNang({ tenPhong, functions, activeFunction, onFunctionChange }: Props) {
    const tabsRef = useRef<HTMLDivElement>(null);
    const [showDropdown, setShowDropdown] = useState(false);

    const scrollTabs = (direction: 'left' | 'right') => {
        if (tabsRef.current) {
            const scrollAmount = 150;
            tabsRef.current.scrollBy({ left: direction === 'left' ? -scrollAmount : scrollAmount, behavior: 'smooth' });
        }
    };

    const activeItem = functions.find(f => f.id === activeFunction);
    const ActiveIcon = activeItem?.icon;

    return (
        <div className="flex-none z-30 w-full h-[44px] bg-[#080808] border-b border-[#C69C6D]/30 shadow-[0_3px_10px_rgba(0,0,0,0.6)] flex items-center px-2 gap-1 md:px-3 md:gap-2">
            {/* T√äN PH√íNG - Thu nh·ªè */}
            <div className="shrink-0 bg-[#C69C6D] text-black px-3 md:px-4 py-1 rounded-l-md rounded-r-xl transform skew-x-[-10deg] shadow-[0_0_10px_rgba(198,156,109,0.4)] border-r-2 border-white/20">
                <h1 className="text-[10px] md:text-xs font-black uppercase tracking-[0.15em] skew-x-[10deg] whitespace-nowrap">{tenPhong}</h1>
            </div>

            {/* N√öT X·ªî DROPDOWN - Ch·ªçn nhanh */}
            <div className="relative">
                <button 
                    onClick={() => setShowDropdown(!showDropdown)}
                    className="flex items-center gap-1 px-2 py-1 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-[#C69C6D] transition-all active:scale-95"
                >
                    {ActiveIcon && <ActiveIcon size={14} strokeWidth={2.5} />}
                    <ChevronDown size={14} className={`transition-transform ${showDropdown ? 'rotate-180' : ''}`} />
                </button>
                
                {/* Dropdown Menu */}
                {showDropdown && (
                    <>
                        <div className="fixed inset-0 z-40" onClick={() => setShowDropdown(false)} />
                        <div className="absolute top-full left-0 mt-1 bg-[#1a1a1a] border border-[#C69C6D]/30 rounded-lg shadow-[0_10px_30px_rgba(0,0,0,0.8)] z-50 min-w-[180px] overflow-hidden">
                            {functions.map((func) => {
                                const Icon = func.icon;
                                const isActive = func.id === activeFunction;
                                return (
                                    <button 
                                        key={func.id}
                                        onClick={() => { onFunctionChange(func.id); setShowDropdown(false); }}
                                        className={`w-full flex items-center gap-3 px-4 py-2.5 text-xs font-bold uppercase tracking-wide transition-all border-b border-white/5 last:border-0 ${isActive ? 'bg-[#C69C6D]/20 text-[#C69C6D]' : 'text-white/60 hover:bg-white/10 hover:text-white'}`}
                                    >
                                        <Icon size={16} strokeWidth={2} />
                                        <span className="flex-1 text-left">{func.label}</span>
                                        {isActive && <Check size={14} className="text-[#C69C6D]" />}
                                    </button>
                                );
                            })}
                        </div>
                    </>
                )}
            </div>

            {/* TABS SCROLL */}
            <div className="flex-1 flex items-center min-w-0 gap-1">
                <button onClick={() => scrollTabs('left')} className="p-0.5 text-[#C69C6D] hover:bg-white/10 rounded shrink-0 active:scale-95 transition-transform"><ChevronLeft size={16}/></button>
                <div ref={tabsRef} className="flex-1 overflow-x-auto scrollbar-hide flex items-center gap-1 mask-linear-fade">
                    <style jsx>{` .scrollbar-hide::-webkit-scrollbar { display: none; } .mask-linear-fade { mask-image: linear-gradient(to right, transparent 0%, black 3%, black 97%, transparent 100%); } `}</style>
                    {functions.map((func) => {
                        const Icon = func.icon;
                        const isActive = func.id === activeFunction;
                        return (
                            <button 
                                key={func.id} 
                                onClick={() => onFunctionChange(func.id)} 
                                className={`flex items-center gap-1 text-[9px] md:text-[10px] font-bold uppercase px-2 md:px-3 py-1.5 rounded transition-all whitespace-nowrap border ${isActive ? 'bg-white/10 text-[#C69C6D] border-[#C69C6D] shadow-[0_0_10px_rgba(198,156,109,0.2)]' : 'bg-transparent text-gray-500 border-transparent hover:text-white hover:bg-white/10'}`}
                            >
                                <Icon size={12} strokeWidth={2.5} /> {func.label}
                            </button>
                        )
                    })}
                </div>
                <button onClick={() => scrollTabs('right')} className="p-0.5 text-[#C69C6D] hover:bg-white/10 rounded shrink-0 active:scale-95 transition-transform"><ChevronRight size={16}/></button>
            </div>
        </div>
    );
}
</file>

<file path="components/TuVanKhachHang.tsx">
"use client";

import React, { useState, useEffect, useRef } from "react";
import {
  MessageSquare,
  X,
  Send,
  User,
  CheckCircle2,
  Clock,
  Search,
  AlertCircle,
  Shield,
  Briefcase,
  Image as ImageIcon,
  Loader2,
} from "lucide-react";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { useUser } from "@/app/ThuVien/UserContext";
import { claimChatSessionAction } from "@/app/actions/QuyenHanSales";
import { compressImage } from "@/app/ThuVien/compressImage";

// Helper format th·ªùi gian
const formatTime = (iso: string) => {
  const d = new Date(iso);
  return `${d.getHours()}:${String(d.getMinutes()).padStart(2, "0")}`;
};

export default function TuVanKhachHang() {
  const { user } = useUser();

  // --- KHAI B√ÅO TO√ÄN B·ªò HOOK ·ªû ƒê·∫¶U ---
  const [isOpen, setIsOpen] = useState(false);
  const [activeTab, setActiveTab] = useState<"waiting" | "my_chats" | "all">(
    "waiting"
  );

  const [sessions, setSessions] = useState<any[]>([]);
  const [selectedSession, setSelectedSession] = useState<any>(null);
  const [messages, setMessages] = useState<any[]>([]);
  const [inputMsg, setInputMsg] = useState("");
  const [isClaiming, setIsClaiming] = useState(false);
  const [isSending, setIsSending] = useState(false);

  const scrollRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // H√†m fetch sessions
  const fetchSessions = async () => {
    if (!user) return;

    let query = supabase
      .from("tu_van_sessions")
      .select("*")
      .order("cap_nhat_luc", { ascending: false });

    if (activeTab === "waiting")
      query = query
        .is("nhan_su_phu_trach_id", null)
        .neq("trang_thai", "ket_thuc");
    if (activeTab === "my_chats")
      query = query.eq("nhan_su_phu_trach_id", user.id);

    const { data, error } = await query;
    if (data) setSessions(data);
  };

  // 1. LOAD DANH S√ÅCH KH√ÅCH (REALTIME)
  useEffect(() => {
    if (!isOpen || !user) return;

    fetchSessions();

    const channel = supabase
      .channel("staff_dashboard_sessions")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "tu_van_sessions" },
        () => {
          fetchSessions();
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [isOpen, activeTab, user]);

  // 2. LOAD TIN NH·∫ÆN CHI TI·∫æT
  useEffect(() => {
    if (!selectedSession) return;

    const loadMsgs = async () => {
      const { data } = await supabase
        .from("tu_van_messages")
        .select("*")
        .eq("session_id", selectedSession.id)
        .order("tao_luc", { ascending: true });
      if (data) setMessages(data);
      scrollToBottom();
    };
    loadMsgs();

    // Subscribe tin nh·∫Øn M·ªöI c·ªßa session n√†y
    const channel = supabase
      .channel(`staff_chat_room_${selectedSession.id}`)
      .on(
        "postgres_changes",
        {
          event: "INSERT",
          schema: "public",
          table: "tu_van_messages",
          filter: `session_id=eq.${selectedSession.id}`,
        },
        (payload) => {
          setMessages((prev) => [...prev, payload.new]);
          scrollToBottom();
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [selectedSession]);

  const scrollToBottom = () => {
    setTimeout(() => {
      if (scrollRef.current)
        scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }, 100);
  };

  // 3. H√ÄNH ƒê·ªòNG: TI·∫æP NH·∫¨N KH√ÅCH (CLAIM)
  const handleClaimSession = async () => {
    if (!selectedSession || !user) return;
    setIsClaiming(true);

    try {
      // C·∫≠p nh·∫≠t tr·ª±c ti·∫øp DB (ho·∫∑c d√πng Server Action n·∫øu mu·ªën b·∫£o m·∫≠t h∆°n)
      const { error } = await supabase
        .from("tu_van_sessions")
        .update({
          nhan_su_phu_trach_id: user.id,
          trang_thai: "dang_tu_van",
        })
        .eq("id", selectedSession.id);

      if (!error) {
        setSelectedSession((prev: any) => ({
          ...prev,
          nhan_su_phu_trach_id: user.id,
          trang_thai: "dang_tu_van",
        }));
        setActiveTab("my_chats");
      } else {
        alert("L·ªói ti·∫øp nh·∫≠n: " + error.message);
      }
    } catch (e) {
      console.error(e);
    } finally {
      setIsClaiming(false);
    }
  };

  // 4. H√ÄNH ƒê·ªòNG: G·ª¨I TIN TR·∫¢ L·ªúI
  const handleSend = async (file?: File) => {
    if ((!inputMsg.trim() && !file) || !selectedSession || !user) return;

    const isManager = ["admin", "quanly", "boss"].includes(user.role || "");

    if (!selectedSession.nhan_su_phu_trach_id && !isManager) {
      if (
        confirm("B·∫°n c·∫ßn 'Ti·∫øp nh·∫≠n' kh√°ch n√†y tr∆∞·ªõc khi chat. Ti·∫øp nh·∫≠n ngay?")
      ) {
        await handleClaimSession();
      } else {
        return;
      }
    }

    setIsSending(true);
    const text = inputMsg;
    setInputMsg("");

    try {
      let imageUrl = null;
      if (file) {
        const compressed = await compressImage(file, 0.7, 1200);
        const fileName = `staff_chat_${Date.now()}_${file.name.replace(
          /[^a-zA-Z0-9.]/g,
          ""
        )}`;
        const { error: upErr } = await supabase.storage
          .from("images")
          .upload(fileName, compressed);
        if (upErr) throw upErr;
        const { data: urlData } = supabase.storage
          .from("images")
          .getPublicUrl(fileName);
        imageUrl = urlData.publicUrl;
      }

      await supabase.from("tu_van_messages").insert({
        session_id: selectedSession.id,
        nguoi_gui_id: user.id,
        la_nhan_vien: true,
        noi_dung: text,
        hinh_anh: imageUrl,
      });

      await supabase
        .from("tu_van_sessions")
        .update({
          tin_nhan_cuoi: imageUrl
            ? text
              ? `[·∫¢nh] ${text}`
              : "[H√¨nh ·∫£nh]"
            : `T∆∞ v·∫•n vi√™n: ${text}`,
          cap_nhat_luc: new Date().toISOString(),
        })
        .eq("id", selectedSession.id);
    } catch (e) {
      console.error(e);
    } finally {
      setIsSending(false);
    }
  };

  // --- RENDER ---
  if (!user || user.userType !== "nhan_su") return null;

  const isManager = ["admin", "quanly", "boss"].includes(user.role || "");
  const UserIcon = isManager ? Shield : Briefcase;

  return (
    <div className="fixed bottom-6 left-6 z-[9000] font-sans flex flex-col items-start gap-3">
      {/* PANEL GIAO DI·ªÜN CH√çNH */}
      {isOpen && (
        <div
          className="
                    fixed left-4 right-4 bottom-24 h-[80vh] 
                    md:static md:w-[800px] md:h-[500px] 
                    bg-[#0a0a0a] border border-[#C69C6D]/50 rounded-2xl shadow-2xl 
                    flex flex-col md:flex-row overflow-hidden animate-in slide-in-from-bottom-5 duration-300
                "
        >
          {/* C·ªòT TR√ÅI: DANH S√ÅCH */}
          <div className="w-full h-[35%] md:w-[30%] md:h-full border-b md:border-b-0 md:border-r border-white/10 flex flex-col bg-[#111]">
            {/* Header C·ªôt Tr√°i */}
            <div className="p-3 border-b border-white/10 bg-[#C69C6D]/10">
              <div className="flex items-center gap-2 mb-3">
                <UserIcon size={16} className="text-[#C69C6D]" />
                <span className="text-xs font-bold text-white uppercase truncate">
                  {user.ho_ten}
                </span>
              </div>
              {/* Tabs */}
              <div className="flex bg-black/50 p-1 rounded-lg">
                <button
                  onClick={() => setActiveTab("waiting")}
                  className={`flex-1 text-[10px] py-1.5 rounded font-bold transition-all ${
                    activeTab === "waiting"
                      ? "bg-red-600 text-white"
                      : "text-gray-400 hover:text-white"
                  }`}
                >
                  CH·ªú ({sessions.filter((s) => !s.nhan_su_phu_trach_id).length})
                </button>
                <button
                  onClick={() => setActiveTab("my_chats")}
                  className={`flex-1 text-[10px] py-1.5 rounded font-bold transition-all ${
                    activeTab === "my_chats"
                      ? "bg-[#C69C6D] text-black"
                      : "text-gray-400 hover:text-white"
                  }`}
                >
                  C·ª¶A T√îI
                </button>
              </div>
            </div>

            {/* List Sessions */}
            <div className="flex-1 overflow-y-auto custom-scrollbar">
              {sessions.length === 0 && (
                <div className="text-center text-white/20 text-xs py-10">
                  Kh√¥ng c√≥ d·ªØ li·ªáu
                </div>
              )}
              {sessions.map((s) => (
                <div
                  key={s.id}
                  onClick={() => setSelectedSession(s)}
                  className={`p-3 border-b border-white/5 cursor-pointer hover:bg-white/5 transition-all relative ${
                    selectedSession?.id === s.id ? "bg-white/10" : ""
                  }`}
                >
                  {!s.nhan_su_phu_trach_id && (
                    <div className="absolute top-3 right-3 w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                  )}
                  <div className="font-bold text-xs text-white mb-1 truncate pr-4">
                    {s.ten_hien_thi}
                  </div>
                  <div className="text-[10px] text-gray-400 truncate mb-1">
                    {s.tin_nhan_cuoi || "B·∫Øt ƒë·∫ßu chat..."}
                  </div>
                  <div className="flex justify-between items-center text-[9px] text-gray-500">
                    <span>{formatTime(s.cap_nhat_luc)}</span>
                    {s.loai_khach === "vip" && (
                      <span className="text-yellow-500 font-bold border border-yellow-500/30 px-1 rounded">
                        VIP
                      </span>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* C·ªòT PH·∫¢I: CHAT */}
          <div className="flex-1 flex flex-col bg-[#050505] relative h-[65%] md:h-full">
            {selectedSession ? (
              <>
                {/* Header Chat */}
                <div className="h-12 md:h-14 border-b border-white/10 flex justify-between items-center px-4 bg-[#111] shrink-0">
                  <div>
                    <div className="flex items-center gap-2">
                      <h3 className="text-sm font-bold text-white max-w-[150px] truncate">
                        {selectedSession.ten_hien_thi}
                      </h3>
                      <span
                        className={`text-[9px] px-1.5 py-0.5 rounded border uppercase ${
                          !selectedSession.nhan_su_phu_trach_id
                            ? "border-red-500 text-red-500"
                            : "border-green-500 text-green-500"
                        }`}
                      >
                        {!selectedSession.nhan_su_phu_trach_id
                          ? "M·ªõi"
                          : "ƒêang chat"}
                      </span>
                    </div>
                  </div>

                  <div className="flex gap-2">
                    {!selectedSession.nhan_su_phu_trach_id ? (
                      <button
                        onClick={handleClaimSession}
                        disabled={isClaiming}
                        className="px-3 py-1.5 bg-[#C69C6D] hover:bg-white text-black text-[10px] md:text-xs font-bold rounded shadow-lg animate-pulse transition-all disabled:opacity-50"
                      >
                        {isClaiming ? "..." : "TI·∫æP NH·∫¨N"}
                      </button>
                    ) : (
                      <div className="hidden md:flex items-center gap-2 px-3 py-1.5 bg-green-900/20 border border-green-500/30 rounded text-green-500 text-xs font-bold">
                        <CheckCircle2 size={14} />
                        Ph·ª• tr√°ch
                      </div>
                    )}
                    <button
                      onClick={() => setIsOpen(false)}
                      className="p-1.5 hover:bg-white/10 rounded"
                    >
                      <X size={18} className="text-gray-400" />
                    </button>
                  </div>
                </div>

                {/* Messages Area */}
                <div
                  className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar bg-black/50"
                  ref={scrollRef}
                >
                  {messages.map((m) => (
                    <div
                      key={m.id}
                      className={`flex ${
                        m.la_nhan_vien ? "justify-end" : "justify-start"
                      }`}
                    >
                      <div
                        className={`max-w-[85%] md:max-w-[70%] p-2.5 md:p-3 rounded-xl text-xs font-sans break-words ${
                          m.la_nhan_vien
                            ? "bg-[#C69C6D] text-black rounded-br-none shadow-[0_0_10px_rgba(198,156,109,0.2)]"
                            : "bg-white/10 text-white rounded-bl-none border border-white/10"
                        }`}
                      >
                        {m.hinh_anh && (
                          <img
                            src={m.hinh_anh}
                            alt="img"
                            className="w-full h-auto rounded-lg mb-2 border border-black/20"
                          />
                        )}
                        <p>{m.noi_dung}</p>
                      </div>
                    </div>
                  ))}
                  {!selectedSession.nhan_su_phu_trach_id && (
                    <div className="flex justify-center my-4">
                      <div className="bg-red-500/10 border border-red-500/30 text-red-400 text-[10px] px-3 py-1 rounded-full flex items-center gap-2">
                        <AlertCircle size={12} /> Vui l√≤ng ti·∫øp nh·∫≠n tr∆∞·ªõc
                      </div>
                    </div>
                  )}
                </div>

                {/* Input Area */}
                <div className="p-3 border-t border-white/10 bg-[#111] flex gap-2 shrink-0">
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    disabled={isSending}
                    className="p-2 text-gray-400 hover:text-[#C69C6D] transition-colors"
                    title="G·ª≠i ·∫£nh"
                  >
                    <ImageIcon size={18} />
                  </button>
                  <input
                    type="file"
                    ref={fileInputRef}
                    className="hidden"
                    accept="image/*"
                    onChange={(e) => {
                      if (e.target.files?.[0]) handleSend(e.target.files[0]);
                    }}
                  />

                  <input
                    className="flex-1 bg-black/50 border border-white/20 rounded-lg px-4 py-2 text-xs text-white focus:border-[#C69C6D] outline-none transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                    placeholder={
                      !selectedSession.nhan_su_phu_trach_id && !isManager
                        ? "C·∫ßn ti·∫øp nh·∫≠n..."
                        : "Nh·∫≠p tin nh·∫Øn..."
                    }
                    value={inputMsg}
                    onChange={(e) => setInputMsg(e.target.value)}
                    onKeyDown={(e) => e.key === "Enter" && handleSend()}
                    disabled={
                      (!selectedSession.nhan_su_phu_trach_id && !isManager) ||
                      isSending
                    }
                  />
                  <button
                    onClick={() => handleSend()}
                    disabled={
                      (!selectedSession.nhan_su_phu_trach_id && !isManager) ||
                      isSending
                    }
                    className="p-2 bg-[#C69C6D] text-black rounded-lg hover:bg-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {isSending ? (
                      <Loader2 size={18} className="animate-spin" />
                    ) : (
                      <Send size={18} />
                    )}
                  </button>
                </div>
              </>
            ) : (
              <div className="flex-1 flex flex-col items-center justify-center text-white/20 select-none">
                <MessageSquare size={48} className="mb-4 opacity-20" />
                <p className="text-xs font-bold uppercase tracking-widest text-center">
                  Ch·ªçn kh√°ch ƒë·ªÉ chat
                </p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* N√öT TR√íN CH√çNH (D√ÄNH CHO NH√ÇN VI√äN) */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        className={`group relative w-14 h-14 rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(198,156,109,0.5)] transition-all hover:scale-110 active:scale-95 border-2 border-[#C69C6D]
                    ${
                      isOpen
                        ? "bg-[#1a1a1a] text-[#C69C6D]"
                        : "bg-[#C69C6D] text-black animate-bounce-slow"
                    }
                `}
      >
        {isOpen ? <X size={24} /> : <User size={28} fill="currentColor" />}

        {!isOpen &&
          sessions.filter((s) => !s.nhan_su_phu_trach_id).length > 0 && (
            <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-600 border-2 border-[#1a1a1a] rounded-full flex items-center justify-center text-[10px] font-bold text-white shadow-sm animate-pulse">
              {sessions.filter((s) => !s.nhan_su_phu_trach_id).length}
            </span>
          )}
      </button>
    </div>
  );
}
</file>

<file path="CongDangNhap/AuthService.ts">
import { supabase } from '@/app/ThuVien/ketNoiSupabase';
import { DataNormalizer } from '@/app/ThuVien/DataNormalizer';

// --- ƒê·ªäNH NGHƒ®A KI·ªÇU D·ªÆ LI·ªÜU CHU·∫®N ---

// Quy·ªÅn h·∫°n m·∫∑c ƒë·ªãnh (c√≥ th·ªÉ m·ªü r·ªông sau n√†y)
const DEFAULT_PERMISSIONS = {
  isAdmin: false,
  canView: true,
  canEdit: false,
  canDelete: false,
};

export interface UserInfo {
  id: string;
  email: string;
  ho_ten: string | null;
  so_dien_thoai: string | null;
  hinh_anh?: string | null;
  
  // Ph√¢n lo·∫°i quan tr·ªçng
  userType: 'nhan_su' | 'khach_hang';
  role: string; // ƒê√¢y l√† gi√° tr·ªã quan tr·ªçng nh·∫•t ƒë·ªÉ ƒë·ªãnh tuy·∫øn (VD: 'admin', 'sales', 'khtrongtam')
  
  // C√°c tr∆∞·ªùng chi ti·∫øt t·ª´ DB (ƒë·ªÉ hi·ªÉn th·ªã)
  vi_tri?: string | null;            // VD: "Th·ª£ S·∫£n Xu·∫•t"
  vi_tri_normalized?: string | null; // VD: "thosanxuat"
  phan_loai?: string | null;         // VD: "KH Tr·ªçng t√¢m"
  phan_loai_normalized?: string | null; // VD: "khtrongtam"
  
  permissions: typeof DEFAULT_PERMISSIONS;
}

export class AuthService {

  /**
   * 1. H√ÄM C·ªêT L√ïI: NH·∫¨N DI·ªÜN USER QUA EMAIL
   * Logic: Check b·∫£ng nhan_su tr∆∞·ªõc -> N·∫øu kh√¥ng c√≥ th√¨ check khach_hang
   */
  static async identifyUser(email: string): Promise<UserInfo | null> {
    if (!email) return null;
    const cleanEmail = email.trim().toLowerCase();

    try {
      // --- B∆Ø·ªöC 1: T√åM TRONG B·∫¢NG NH√ÇN S·ª∞ ---
      const { data: nhanSu, error: errNS } = await supabase
        .from('nhan_su')
        .select('*')
        .eq('email', cleanEmail)
        .single();

      if (nhanSu && !errNS) {
        // N·∫øu l√† nh√¢n s·ª±, role ch√≠nh l√† vi_tri_normalized
        // N·∫øu vi_tri_normalized null, fallback v·ªÅ 'parttime' cho an to√†n
        const roleCode = nhanSu.vi_tri_normalized || 'parttime';
        
        return {
          id: nhanSu.id,
          email: nhanSu.email,
          ho_ten: nhanSu.ho_ten,
          so_dien_thoai: nhanSu.so_dien_thoai,
          hinh_anh: nhanSu.hinh_anh,
          
          userType: 'nhan_su',
          role: roleCode, // <-- D√πng c√°i n√†y ƒë·ªÉ tra b·∫£ng routing_permissions
          
          vi_tri: nhanSu.vi_tri,
          vi_tri_normalized: roleCode,
          
          permissions: {
            ...DEFAULT_PERMISSIONS,
            isAdmin: roleCode === 'admin' || roleCode === 'quanly'
          }
        };
      }

      // --- B∆Ø·ªöC 2: T√åM TRONG B·∫¢NG KH√ÅCH H√ÄNG ---
      const { data: khachHang, error: errKH } = await supabase
        .from('khach_hang')
        .select('*')
        .eq('email', cleanEmail)
        .single();

      if (khachHang && !errKH) {
        // N·∫øu l√† kh√°ch h√†ng, role ch√≠nh l√† phan_loai_normalized
        // VD: 'vip', 'doitac', 'khtrongtam'
        const roleCode = khachHang.phan_loai_normalized || 'moi';

        return {
          id: khachHang.id,
          email: khachHang.email,
          ho_ten: khachHang.ho_ten,
          so_dien_thoai: khachHang.so_dien_thoai,
          
          userType: 'khach_hang',
          role: roleCode, // <-- D√πng c√°i n√†y ƒë·ªÉ tra b·∫£ng routing_permissions

          phan_loai: khachHang.phan_loai,
          phan_loai_normalized: roleCode,
          
          permissions: DEFAULT_PERMISSIONS
        };
      }

      // Kh√¥ng t√¨m th·∫•y ·ªü ƒë√¢u c·∫£
      return null;

    } catch (error) {
      console.error('AuthService: L·ªói ƒë·ªãnh danh user:', error);
      return null;
    }
  }

  /**
   * 2. H√ÄM H·ªñ TR·ª¢: L·∫§Y USER HI·ªÜN T·∫†I T·ª™ SESSION
   * D√πng cho Client Side (UserContext)
   */
  static async getCurrentUser(): Promise<UserInfo | null> {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user || !user.email) return null;

    // G·ªçi h√†m identify ·ªü tr√™n ƒë·ªÉ l·∫•y th√¥ng tin chi ti·∫øt t·ª´ DB
    return await this.identifyUser(user.email);
  }

  /**
   * 3. H√ÄM RPC (QUAN TR·ªåNG CHO CONGDANGNHAP.TSX)
   * H√†m n√†y g·ªçi RPC trong database ƒë·ªÉ bypass RLS n·∫øu c·∫ßn thi·∫øt,
   * ho·∫∑c ƒë∆°n gi·∫£n l√† t√°i s·ª≠ d·ª•ng logic identifyUser ·ªü tr√™n.
   * ƒê·ªÉ ƒë·∫£m b·∫£o t∆∞∆°ng th√≠ch v·ªõi code c≈© c·ªßa b·∫°n, t√¥i vi·∫øt h√†m n√†y wrap l·∫°i logic tr√™n.
   */
  static async getUserByEmailWithRpc(email: string): Promise<UserInfo | null> {
    // ∆Øu ti√™n d√πng logic identifyUser ·ªü tr√™n v√¨ n√≥ query tr·ª±c ti·∫øp b·∫£ng chu·∫©n
    return await this.identifyUser(email);
    
    /* Ghi ch√∫: N·∫øu b·∫°n th·ª±c s·ª± mu·ªën d√πng RPC (Database Function) 'get_user_profile_by_email', 
       h√£y ƒë·∫£m b·∫£o function ƒë√≥ trong Postgres tr·∫£ v·ªÅ ƒë√∫ng c·∫•u tr√∫c c·ªôt nh∆∞ mong ƒë·ª£i.
       Hi·ªán t·∫°i, query tr·ª±c ti·∫øp (client-side query) l√† an to√†n v√† d·ªÖ debug nh·∫•t 
       v·ªõi c·∫•u tr√∫c b·∫£ng b·∫°n v·ª´a cung c·∫•p.
    */
  }

  /**
   * 4. ƒêƒÇNG XU·∫§T
   */
  static async signOut() {
    return await supabase.auth.signOut();
  }

  /**
   * 5. HELPER: KI·ªÇM TRA QUY·ªÄN ADMIN
   */
  static async isCurrentUserAdmin(): Promise<boolean> {
    const user = await this.getCurrentUser();
    return user?.permissions.isAdmin ?? false;
  }
}
</file>

<file path="CongDangNhap/ChanForm.tsx">
'use client';

import React from 'react';

interface Props {
    onSupportClick?: () => void;
}

export default function ChanForm({ onSupportClick }: Props) {
    return (
        <div className="w-full flex flex-col items-center gap-3 mt-6 animate-in fade-in duration-700 delay-300">
            {/* ƒê∆∞·ªùng k·∫ª m·ªù tinh t·∫ø */}
            <div className="w-24 h-[1px] bg-gradient-to-r from-transparent via-[#8B5E3C] to-transparent opacity-50"></div>
            
            <div className="flex flex-col items-center gap-1 text-[10px] uppercase tracking-widest font-medium text-white/30 font-serif">
                <span>ƒê∆∞·ª£c ki·∫øn t·∫°o b·ªüi</span>
                <span className="text-[#C69C6D] font-bold drop-shadow-md tracking-[0.2em]">Tommy Nghi√™m Art</span>
            </div>
            
            {/* N√∫t H·ªó tr·ª£ */}
            <button 
                type="button" 
                onClick={onSupportClick}
                className="text-[10px] text-gray-600 hover:text-white transition-colors cursor-pointer mt-2 hover:underline decoration-dotted underline-offset-4"
            >
                G·∫∑p s·ª± c·ªë ƒëƒÉng nh·∫≠p?
            </button>
        </div>
    );
}
</file>

<file path="CongDangNhap/CongDangNhap.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { supabase } from '@/app/ThuVien/ketNoiSupabase'; 
import { AuthService } from '@/app/CongDangNhap/AuthService';
import { getRedirectUrl } from '@/app/CongDangNhap/RoleRedirectService';
import { X, Square, CheckSquare, Lock, Eye, EyeOff, Loader2, ArrowRight, Mail, ArrowLeft, UserPlus, KeyRound } from 'lucide-react'; 
import { Z_INDEX } from '@/app/constants/zIndex';

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const BASE_IMG_URL = `${SUPABASE_URL}/storage/v1/object/public/hinh-nen`;

// Hi·ªáu ·ª©ng n·ªÅn
const NenHieuUng = ({ isModalMode }: { isModalMode: boolean }) => {
    const bgMobile = `${BASE_IMG_URL}/login-mobile.jpg`;
    const bgTablet = `${BASE_IMG_URL}/login-tablet.jpg`;
    const bgDesktop = `${BASE_IMG_URL}/login-desktop.jpg`;

    return (
        <div className={`absolute inset-0 bg-[#050505] overflow-hidden ${isModalMode ? 'rounded-2xl' : ''}`}>
            <div
                className="absolute inset-0 bg-cover bg-center md:hidden transition-opacity duration-700"
                style={{ backgroundImage: `url('${bgMobile}')` }}
            />
            <div
                className="absolute inset-0 bg-cover bg-center hidden md:block lg:hidden transition-opacity duration-700"
                style={{ backgroundImage: `url('${bgTablet}')` }}
            />
            <div
                className="absolute inset-0 bg-cover bg-center hidden lg:block transition-opacity duration-700"
                style={{ backgroundImage: `url('${bgDesktop}')` }}
            />
            <div className={`absolute inset-0 bg-black/60 ${isModalMode ? 'bg-black/70' : ''}`} />
            <div className="absolute top-[-20%] left-[50%] -translate-x-1/2 w-[500px] h-[500px] bg-yellow-600/10 rounded-full blur-[100px] mix-blend-overlay" />
        </div>
    );
};

// √î nh·∫≠p li·ªáu
const ONhapLieu = ({
    id,
    label,
    value,
    onChange,
    type = 'text',
    showEye = false,
    isPasswordVisible = false,
    onToggleEye,
}: {
    id: string;
    label: string;
    value: string;
    onChange: (val: string) => void;
    type?: string;
    showEye?: boolean;
    isPasswordVisible?: boolean;
    onToggleEye?: () => void;
}) => {
    const inputType = showEye ? (isPasswordVisible ? 'text' : 'password') : type;

    return (
        <div className="group relative w-full">
            <label
                htmlFor={id}
                className="block text-white/80 text-xs font-bold uppercase tracking-[0.2em] mb-2 drop-shadow-md ml-1"
            >
                {label}
            </label>

            <div className="relative w-full">
                <input
                    id={id}
                    type={inputType}
                    value={value}
                    onChange={(e) => onChange(e.target.value)}
                    className="w-full bg-black/40 hover:bg-black/60 focus:bg-black/80 
                                                                 text-white text-lg font-bold tracking-wider
                                                                 border border-white/20 focus:border-[#C69C6D]
                                                                 rounded-xl px-5 py-4 
                                                                 outline-none transition-all duration-300
                                                                 placeholder-transparent shadow-lg"
                    autoComplete="off"
                />

                {showEye && (
                    <button
                        type="button"
                        onClick={onToggleEye}
                        className="absolute right-4 top-1/2 -translate-y-1/2 text-white/40 hover:text-[#C69C6D] transition-colors p-1"
                        tabIndex={-1}
                    >
                        {isPasswordVisible ? <EyeOff size={20} /> : <Eye size={20} />}
                    </button>
                )}
            </div>

            <div className="absolute bottom-0 left-5 right-5 h-[1px] bg-[#C69C6D] scale-x-0 group-focus-within:scale-x-100 transition-transform duration-500 origin-left"></div>
        </div>
    );
};

// N√∫t x√°c nh·∫≠n
const NutXacNhan = ({ isLoading, mode = 'login' }: { isLoading: boolean; mode?: 'login' | 'register' | 'forgotPassword' }) => {
    const getButtonText = () => {
        switch (mode) {
            case 'register': return 'ƒêƒÇNG K√ù';
            case 'forgotPassword': return 'G·ª¨I EMAIL';
            default: return 'LOGIN';
        }
    };

    const getIcon = () => {
        switch (mode) {
            case 'register': return <UserPlus size={28} className="group-hover:scale-110 transition-transform duration-500" strokeWidth={2} />;
            case 'forgotPassword': return <Mail size={28} className="group-hover:scale-110 transition-transform duration-500" strokeWidth={2} />;
            default: return <ArrowRight size={28} className="group-hover:-rotate-45 transition-transform duration-500" strokeWidth={2} />;
        }
    };

    return (
        <button
            type="submit"
            disabled={isLoading}
            className="group mt-8 flex flex-col items-center gap-3 opacity-90 hover:opacity-100 transition-all disabled:opacity-50 mx-auto"
        >
            <div
                className="w-16 h-16 md:w-20 md:h-20 rounded-full flex items-center justify-center 
                                                            bg-transparent border-2 border-white/30 text-white 
                                                            group-hover:bg-white group-hover:text-black group-hover:border-white 
                                                            group-hover:shadow-[0_0_30px_rgba(255,255,255,0.4)]
                                                            transition-all duration-500 ease-out shadow-xl"
            >
                {isLoading ? (
                    <Loader2 className="animate-spin" size={28} />
                ) : (
                    getIcon()
                )}
            </div>

            <div className="flex flex-col items-center">
                <span className="text-lg font-bold tracking-[0.3em] text-white group-hover:text-yellow-400 transition-colors drop-shadow-md">
                    {isLoading ? '...' : getButtonText()}
                </span>
            </div>
        </button>
    );
};

// Ti√™u ƒë·ªÅ placeholder
const TieuDe = () => null;

export default function CongDangNhap({ isOpen, onClose, isGateKeeper = false }: { isOpen?: boolean; onClose?: () => void; isGateKeeper?: boolean }) {
    console.log('üé® CongDangNhap MOUNTED/RENDERED', { isOpen, isGateKeeper });
    
    const router = useRouter();
    
    // üìå STATE: Mode - login | register | forgotPassword
    const [mode, setMode] = useState<'login' | 'register' | 'forgotPassword'>('login');
    
    const [user, setUser] = useState({ name: '', phone: '', confirmPassword: '', hoTen: '' });
    const [flags, setFlags] = useState({ loading: false, anim: false });
    const [isError, setIsError] = useState(false);
    
    const [wantFullScreen, setWantFullScreen] = useState(true);
    const [rememberMe, setRememberMe] = useState(true); 
    const [showPhone, setShowPhone] = useState(false);
    const [showConfirmPassword, setShowConfirmPassword] = useState(false);
    const [showErrorDialog, setShowErrorDialog] = useState(false);
    const [errorMessage, setErrorMessage] = useState('');
    const [successMessage, setSuccessMessage] = useState('');
    const [showSuccessDialog, setShowSuccessDialog] = useState(false);

    const isModal = typeof isOpen === 'boolean';
    
    // --- HELPERS ---
    const normalizeString = (str: string) => {
        if (!str) return '';
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
    };

    const isVipCustomer = (phanLoai: string) => {
        // ‚úÖ ALLOW: All kh√°ch_hang types (vip, doitac, moi, damuahang, khtrongtam, etc.)
        // ‚úÖ The RoleRedirectService will handle route restrictions
        return !!phanLoai && phanLoai.trim().length > 0;
    };

    // --- EFFECTS ---
    useEffect(() => {
        // Animation entry
        if (isOpen) {
            const timer = setTimeout(() => setFlags(p => ({...p, anim: true})), 50);
            return () => clearTimeout(timer);
        } else {
            setFlags(p => ({...p, anim: false}));
        }
    }, [isOpen]);

    useEffect(() => {
        // ‚úÖ FIX: Load saved email only (not password for security)
        const savedEmail = localStorage.getItem('SAVED_EMAIL');
        if (savedEmail) {
            try {
                const parsed = JSON.parse(savedEmail);
                if (parsed.email) setUser(prev => ({ ...prev, name: parsed.email }));
                setRememberMe(true);
            } catch (e) { setRememberMe(false); }
        }

        // Load fullscreen preference
        const savedPref = localStorage.getItem('GLOBAL_FULLSCREEN_PREF');
        if (savedPref !== null) setWantFullScreen(savedPref === 'true');
    }, []);

    if (isModal && !isOpen) return null;

    // --- HANDLERS ---
    const triggerFullScreen = () => {
        try {
            const elem = document.documentElement as any;
            if (elem.requestFullscreen) elem.requestFullscreen();
            else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
        } catch (err) { console.warn("Fullscreen error:", err); }
    };

    const handleSubmit = async (e: React.FormEvent) => {
        console.log('üöÄ handleSubmit TRIGGERED');
        e.preventDefault();
        
        console.log('üîí Form values:', { email: user.name, passwordLength: user.phone.length });
        
        if (typeof window !== 'undefined') localStorage.setItem('GLOBAL_FULLSCREEN_PREF', wantFullScreen ? 'true' : 'false');
        if (wantFullScreen) triggerFullScreen();

        setFlags(p => ({...p, loading: true})); 
        setIsError(false);

        const email = user.name.trim().toLowerCase();
        const phone = user.phone.trim();
        
        console.log('üîê ATTEMPTING LOGIN:', { email, passwordLength: phone.length });
        
        try {
            // 1. Auth check
            const { data: authData, error: authError } = await supabase.auth.signInWithPassword({ 
                email, 
                password: phone 
            });
            
            if (authError) {
                console.error('‚ùå AUTH FAILED:', authError);
                throw new Error(`L·ªói ƒëƒÉng nh·∫≠p: ${authError.message}`);
            }

            console.log('‚úÖ AUTH SUCCESS for email:', email);
            
            // ‚úÖ CRITICAL: Verify session was saved before proceeding
            if (!authData.session) {
                throw new Error('Session kh√¥ng ƒë∆∞·ª£c t·∫°o. Vui l√≤ng th·ª≠ l·∫°i.');
            }
            console.log('‚úÖ SESSION CREATED:', authData.session.access_token.substring(0, 20) + '...');

            // 2. Load profile via RPC (tr√°nh ph·ª• thu·ªôc session v·ª´a set)
            const finalUser = await AuthService.getUserByEmailWithRpc(email);
            console.log('üìã LOADED USER:', finalUser);
            
            if (!finalUser) throw new Error("Kh√¥ng t√¨m th·∫•y h·ªì s∆°. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n.");

            let finalRole = 'khach';
            let finalPosition = '';
            let finalRoleNormalized = '';

            if (finalUser.userType === 'nhan_su') {
                finalPosition = finalUser.vi_tri || 'Nh√¢n Vi√™n';
                // ‚úÖ ∆Øu ti√™n vi_tri_normalized t·ª´ DB, n·∫øu kh√¥ng c√≥ th√¨ fallback 'parttime'
                finalRoleNormalized = (finalUser as any).vi_tri_normalized || 'parttime';
                finalRole = finalRoleNormalized;
                console.log('üî¥ NHAN_SU:', { vi_tri: finalPosition, vi_tri_normalized: finalRoleNormalized });
            } else {
                const phanLoai = finalUser.phan_loai || '';
                console.log('üü¢ KHACH_HANG:', { phan_loai: phanLoai });
                
                if (!isVipCustomer(phanLoai)) throw new Error("T√†i kho·∫£n n√†y kh√¥ng ƒë∆∞·ª£c ph√©p truy c·∫≠p. Vui l√≤ng li√™n h·ªá qu·∫£n l√Ω.");
                finalPosition = phanLoai || 'Kh√°ch H√†ng';
                // ‚úÖ ∆Øu ti√™n phan_loai_normalized t·ª´ DB, n·∫øu kh√¥ng c√≥ th√¨ fallback 'moi'
                finalRoleNormalized = (finalUser as any).phan_loai_normalized || 'moi';
                finalRole = finalRoleNormalized;
                console.log('üü¢ KHACH_HANG APPROVED:', { phan_loai_normalized: finalRoleNormalized });
            }

            // 4. Save Logic
            // ‚úÖ SECURITY FIX: Never store password in localStorage
            if (rememberMe) localStorage.setItem('SAVED_EMAIL', JSON.stringify({ email }));
            else localStorage.removeItem('SAVED_EMAIL');

            const userInfo = {
                id: finalUser.id,
                ho_ten: (finalUser as any).ten_hien_thi || finalUser.ho_ten || email,
                email: email,
                vi_tri: finalPosition, 
                role: finalRole,
                role_normalized: finalRoleNormalized, // L∆∞u th√™m c√°i n√†y cho ch·∫Øc
                userType: finalUser.userType,
                avatar_url: (finalUser as any).hinh_anh
                // ‚úÖ NEVER include password, token, or sensitive data
            };
            
            localStorage.removeItem('LA_ADMIN_CUNG');
            localStorage.setItem('USER_INFO', JSON.stringify(userInfo));
            localStorage.setItem('USER_ROLE', finalRole);
            console.log('üíæ SAVED TO LOCALSTORAGE:', { 
               USER_INFO: userInfo, 
               USER_ROLE: finalRole
            });
            
            // N·∫øu tr∆∞·ªõc ƒë√≥ ·ªü ch·∫ø ƒë·ªô kh√°ch, xo√° cookie visitor
            document.cookie = 'VISITOR_MODE=; Path=/; Max-Age=0; SameSite=Lax';

            // 5. Redirect - Close modal first if needed
            console.log('‚úÖ LOGIN SUCCESS, waiting for session persist...');
            
            // ‚úÖ CRITICAL: Wait for Supabase session to fully persist
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Verify session is persisted
            const { data: { session: verifySession } } = await supabase.auth.getSession();
            if (!verifySession) {
                console.error('‚ùå SESSION NOT PERSISTED');
                throw new Error('Session kh√¥ng ƒë∆∞·ª£c l∆∞u. Vui l√≤ng th·ª≠ l·∫°i.');
            }
            
            console.log('‚úÖ SESSION VERIFIED - Now redirecting to room');
            
            // üü¢ T√çNH TO√ÅN ƒê∆Ø·ªúNG D·∫™N PH√íNG TR·ª∞C TI·∫æP
            const userType = finalUser.userType || 'khach_hang';
            const targetUrl = await getRedirectUrl(userType, finalRole);
            console.log(`üéØ ƒê√≠ch ƒë·∫øn: ${targetUrl}`);
            
            // ‚úÖ Close modal tr∆∞·ªõc n·∫øu c√≥
            if (isModal && onClose) {
                onClose();
            }
            
            // üöÄ CHUY·ªÇN TR·ª∞C TI·∫æP V·ªÄ PH√íNG (kh√¥ng v·ªÅ trang ch·ªß)
            console.log(`üöÄ Chuy·ªÉn h∆∞·ªõng ƒë·∫øn: ${targetUrl}`);
            router.push(targetUrl);

        } catch (err: any) { 
            const errorMsg = err?.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
            console.error("‚ùå LOGIN ERROR:", err);
            setErrorMessage(errorMsg);
            setShowErrorDialog(true); 
            setIsError(true); 
            setFlags(p => ({...p, loading: false})); 
        } 
    };

    const handleClose = () => { 
        if (isGateKeeper) { router.push('/'); return; }
        setFlags(p => ({...p, anim: false})); 
        setTimeout(() => onClose && onClose(), 300); 
    };

    // üìå HANDLER: ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi
    const handleRegister = async (e: React.FormEvent) => {
        e.preventDefault();
        setFlags(p => ({...p, loading: true}));
        setIsError(false);

        const email = user.name.trim().toLowerCase();
        const password = user.phone.trim();
        const confirmPassword = user.confirmPassword.trim();
        const hoTen = user.hoTen.trim();

        // Validation
        if (!email || !email.includes('@')) {
            setErrorMessage('Email kh√¥ng h·ª£p l·ªá');
            setShowErrorDialog(true);
            setIsError(true);
            setFlags(p => ({...p, loading: false}));
            return;
        }

        if (password.length < 6) {
            setErrorMessage('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±');
            setShowErrorDialog(true);
            setIsError(true);
            setFlags(p => ({...p, loading: false}));
            return;
        }

        if (password !== confirmPassword) {
            setErrorMessage('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp');
            setShowErrorDialog(true);
            setIsError(true);
            setFlags(p => ({...p, loading: false}));
            return;
        }

        try {
            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: { ho_ten: hoTen || email.split('@')[0] }
                }
            });

            if (error) throw error;

            // Success
            setSuccessMessage('ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ki·ªÉm tra email ƒë·ªÉ x√°c nh·∫≠n t√†i kho·∫£n.');
            setShowSuccessDialog(true);
            
            // Clear form and switch to login
            setUser({ name: email, phone: '', confirmPassword: '', hoTen: '' });
            setTimeout(() => {
                setShowSuccessDialog(false);
                setMode('login');
            }, 3000);

        } catch (err: any) {
            console.error("L·ªói ƒëƒÉng k√Ω:", err.message);
            setErrorMessage(err.message || 'ƒêƒÉng k√Ω th·∫•t b·∫°i');
            setShowErrorDialog(true);
            setIsError(true);
        } finally {
            setFlags(p => ({...p, loading: false}));
        }
    };

    // üìå HANDLER: Qu√™n m·∫≠t kh·∫©u
    const handleForgotPassword = async (e: React.FormEvent) => {
        e.preventDefault();
        setFlags(p => ({...p, loading: true}));
        setIsError(false);

        const email = user.name.trim().toLowerCase();

        if (!email || !email.includes('@')) {
            setErrorMessage('Vui l√≤ng nh·∫≠p email h·ª£p l·ªá');
            setShowErrorDialog(true);
            setIsError(true);
            setFlags(p => ({...p, loading: false}));
            return;
        }

        try {
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
                redirectTo: `${window.location.origin}/reset-password`
            });

            if (error) throw error;

            // Success
            setSuccessMessage('ƒê√£ g·ª≠i link ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u! Vui l√≤ng ki·ªÉm tra email c·ªßa b·∫°n.');
            setShowSuccessDialog(true);
            
            setTimeout(() => {
                setShowSuccessDialog(false);
                setMode('login');
            }, 3000);

        } catch (err: any) {
            console.error("L·ªói reset password:", err.message);
            setErrorMessage(err.message || 'Kh√¥ng th·ªÉ g·ª≠i email');
            setShowErrorDialog(true);
            setIsError(true);
        } finally {
            setFlags(p => ({...p, loading: false}));
        }
    };

    // üìå L·∫•y title theo mode
    const getModeTitle = () => {
        switch (mode) {
            case 'register': return 'ƒêƒÇNG K√ù';
            case 'forgotPassword': return 'QU√äN M·∫¨T KH·∫®U';
            default: return 'LOGIN';
        }
    };
    
    return (
        // Req 5 & 6: Fixed, 100dvh (ch·ªëng tr∆∞·ª£t), overflow-hidden
        <div className={`fixed inset-0 w-screen h-[100dvh] font-sans text-white overflow-hidden bg-black/90 backdrop-blur-sm flex items-center justify-center`} style={{ zIndex: Z_INDEX.modal }}>
            
            {/* Background Effect */}
            <div className="absolute inset-0 opacity-50 pointer-events-none">
                <NenHieuUng isModalMode={isModal} />
            </div>

            {/* Main Container - Transition logic */}
            <div className={`relative w-full h-full max-w-screen-xl mx-auto flex flex-col items-center justify-center transition-all duration-700 ease-out transform 
                  ${isModal ? (flags.anim ? 'opacity-100 blur-0 scale-100' : 'opacity-0 blur-xl scale-110') : 'opacity-100'}
            `}>
                
                {/* Close Button */}
                {isModal && (
                    <button onClick={handleClose} className="absolute top-4 right-4 md:top-8 md:right-8 text-white/50 hover:text-white transition-colors p-2 z-50 bg-black/20 rounded-full active:scale-95">
                        <X size={24} className="md:w-8 md:h-8" strokeWidth={1.5} />
                    </button>
                )}

                {/* Form Container - Req 8: C√¢n gi·ªØa ho√†n to√†n */}
                <form onSubmit={mode === 'login' ? handleSubmit : mode === 'register' ? handleRegister : handleForgotPassword} className="w-full px-6 flex flex-col items-center justify-center relative z-10">
                    
                    {/* Req 1: TƒÉng ƒë·ªô r·ªông container l√™n 500px v√† w-full */}
                    <div className="w-full max-w-[500px] flex flex-col gap-5 md:gap-6">
                        
                        {/* Mode Title v·ªõi Back button */}
                        <div className={`flex items-center justify-center mb-2 ${isError ? 'animate-shake' : ''}`}>
                            {mode !== 'login' && (
                                <button
                                    type="button"
                                    onClick={() => setMode('login')}
                                    className="absolute left-6 md:left-auto md:relative md:mr-4 text-white/50 hover:text-white transition-colors p-2"
                                >
                                    <ArrowLeft size={24} />
                                </button>
                            )}
                            <h1 className="text-2xl md:text-3xl font-bold tracking-[0.3em] text-white/80">
                                {getModeTitle()}
                            </h1>
                        </div>
                        
                        {/* Input Group - Dynamic based on mode */}
                        <div className={`flex flex-col gap-4 ${isError ? 'animate-shake' : ''}`}>
                            
                            {/* H·ªç t√™n - Ch·ªâ hi·ªÉn th·ªã khi ƒëƒÉng k√Ω */}
                            {mode === 'register' && (
                                <ONhapLieu 
                                    id="inp_hoten" 
                                    label="H·ªå T√äN"
                                    value={user.hoTen} 
                                    onChange={v => setUser(p => ({...p, hoTen: v}))} 
                                />
                            )}
                            
                            {/* Email - Lu√¥n hi·ªÉn th·ªã */}
                            <ONhapLieu 
                                id="inp_email" 
                                label="EMAIL" 
                                value={user.name} 
                                onChange={v => setUser(p => ({...p, name: v}))} 
                            />
                            
                            {/* M·∫≠t kh·∫©u - Kh√¥ng hi·ªÉn th·ªã khi qu√™n m·∫≠t kh·∫©u */}
                            {mode !== 'forgotPassword' && (
                                <ONhapLieu 
                                    id="inp_password" 
                                    label="M·∫¨T KH·∫®U"
                                    value={user.phone} 
                                    onChange={v => setUser(p => ({...p, phone: v}))} 
                                    type={showPhone ? 'text' : 'password'} 
                                    showEye={true}
                                    isPasswordVisible={showPhone}
                                    onToggleEye={() => setShowPhone(!showPhone)}
                                />
                            )}
                            
                            {/* X√°c nh·∫≠n m·∫≠t kh·∫©u - Ch·ªâ hi·ªÉn th·ªã khi ƒëƒÉng k√Ω */}
                            {mode === 'register' && (
                                <ONhapLieu 
                                    id="inp_confirm_password" 
                                    label="X√ÅC NH·∫¨N M·∫¨T KH·∫®U"
                                    value={user.confirmPassword} 
                                    onChange={v => setUser(p => ({...p, confirmPassword: v}))} 
                                    type={showConfirmPassword ? 'text' : 'password'} 
                                    showEye={true}
                                    isPasswordVisible={showConfirmPassword}
                                    onToggleEye={() => setShowConfirmPassword(!showConfirmPassword)}
                                />
                            )}
                            
                            {/* Options Checkbox - Ch·ªâ hi·ªÉn th·ªã khi ƒëƒÉng nh·∫≠p */}
                            {mode === 'login' && (
                                <div className="flex flex-row items-center justify-between px-1 mt-1">
                                    {/* Ghi nh·ªõ */}
                                    <div className="flex items-center gap-2 cursor-pointer group select-none" onClick={() => setRememberMe(!rememberMe)}>
                                        <div className={`transition-colors ${rememberMe ? 'text-[#C69C6D]' : 'text-gray-600 group-hover:text-gray-400'}`}>
                                            {rememberMe ? <CheckSquare size={16} /> : <Square size={16} />}
                                        </div>
                                        <span className={`text-[10px] md:text-xs font-bold uppercase tracking-widest transition-colors ${rememberMe ? 'text-white' : 'text-gray-500 group-hover:text-gray-400'}`}>
                                            GHI NH·ªö ƒêƒÇNG NH·∫¨P
                                        </span>
                                    </div>

                                    {/* Fullscreen */}
                                    <div className="flex items-center gap-2 cursor-pointer group select-none" onClick={() => setWantFullScreen(!wantFullScreen)}>
                                        <div className={`transition-colors ${wantFullScreen ? 'text-yellow-500' : 'text-gray-600 group-hover:text-gray-400'}`}>
                                            {wantFullScreen ? <CheckSquare size={16} /> : <Square size={16} />}
                                        </div>
                                        <span className={`text-[10px] md:text-xs font-bold uppercase tracking-widest transition-colors ${wantFullScreen ? 'text-white' : 'text-gray-500 group-hover:text-gray-400'}`}>
                                            To√†n m√†n h√¨nh
                                        </span>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* N√∫t Submit */}
                    <div className="w-full max-w-[500px] mt-6 flex justify-center">
                        <NutXacNhan isLoading={flags.loading} mode={mode} />
                    </div>

                    {/* Footer Links */}
                    <div className="mt-6 flex flex-col items-center gap-3">
                        {mode === 'login' && (
                            <>
                                {/* Qu√™n m·∫≠t kh·∫©u */}
                                <button
                                    type="button"
                                    onClick={() => setMode('forgotPassword')}
                                    className="inline-flex items-center gap-2 text-xs md:text-sm text-white/40 hover:text-[#C69C6D] transition-all duration-300"
                                >
                                    <KeyRound size={14} />
                                    <span>Qu√™n m·∫≠t kh·∫©u?</span>
                                </button>
                                
                                {/* ƒêƒÉng k√Ω */}
                                <button
                                    type="button"
                                    onClick={() => setMode('register')}
                                    className="inline-flex items-center gap-2 text-xs md:text-sm text-white/40 hover:text-[#C69C6D] transition-all duration-300"
                                >
                                    <UserPlus size={14} />
                                    <span>Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay</span>
                                </button>
                            </>
                        )}
                        
                        {mode === 'register' && (
                            <button
                                type="button"
                                onClick={() => setMode('login')}
                                className="inline-flex items-center gap-2 text-xs md:text-sm text-white/40 hover:text-[#C69C6D] transition-all duration-300"
                            >
                                <span>ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p</span>
                            </button>
                        )}
                        
                        {mode === 'forgotPassword' && (
                            <button
                                type="button"
                                onClick={() => setMode('login')}
                                className="inline-flex items-center gap-2 text-xs md:text-sm text-white/40 hover:text-[#C69C6D] transition-all duration-300"
                            >
                                <span>Quay l·∫°i ƒëƒÉng nh·∫≠p</span>
                            </button>
                        )}
                        
                        {/* Link h·ªó tr·ª£ */}
                        <a 
                            href="tel:+84939941588" 
                            className="inline-flex items-center gap-2 text-xs md:text-sm text-white/30 hover:text-white transition-all duration-300 border-b border-transparent hover:border-white/50 pb-0.5 group"
                        >
                            <Lock size={12} className="group-hover:text-green-400 transition-colors" />
                            <span>C·∫ßn h·ªó tr·ª£?</span>
                        </a>
                    </div>

                </form>

            </div>

            {/* Error Dialog - H·ªôp tho·∫°i th√¥ng b√°o l·ªói trang tr·ªçng */}
            {showErrorDialog && (
                <div 
                    className="fixed inset-0 flex items-center justify-center bg-black/80 backdrop-blur-sm"
                    style={{ zIndex: Z_INDEX.modal + 10 }}
                    onClick={() => setShowErrorDialog(false)}
                >
                    <div 
                        className="relative bg-gradient-to-b from-zinc-900 to-black border border-white/10 rounded-2xl p-8 max-w-sm w-[90%] shadow-2xl transform animate-fadeIn"
                        onClick={(e) => e.stopPropagation()}
                    >
                        {/* Icon */}
                        <div className="flex justify-center mb-6">
                            <div className="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center border border-red-500/30">
                                <Lock className="w-8 h-8 text-red-400" />
                            </div>
                        </div>

                        {/* Message */}
                        <h3 className="text-xl font-bold text-white text-center mb-2">
                            ƒêƒÉng nh·∫≠p th·∫•t b·∫°i
                        </h3>
                        <p className="text-white/60 text-sm text-center mb-6">
                            {errorMessage || 'Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin'}
                        </p>

                        {/* Button */}
                        <button
                            onClick={() => setShowErrorDialog(false)}
                            className="w-full py-3 bg-white/10 hover:bg-white/20 text-white font-semibold rounded-xl transition-all duration-300 border border-white/10 hover:border-white/30"
                        >
                            Th·ª≠ l·∫°i
                        </button>
                    </div>
                </div>
            )}

            {/* Success Dialog - H·ªôp tho·∫°i th√¥ng b√°o th√†nh c√¥ng */}
            {showSuccessDialog && (
                <div 
                    className="fixed inset-0 flex items-center justify-center bg-black/80 backdrop-blur-sm"
                    style={{ zIndex: Z_INDEX.modal + 10 }}
                    onClick={() => setShowSuccessDialog(false)}
                >
                    <div 
                        className="relative bg-gradient-to-b from-emerald-900/30 to-black border border-emerald-500/30 rounded-2xl p-8 max-w-sm w-[90%] shadow-2xl transform animate-fadeIn"
                        onClick={(e) => e.stopPropagation()}
                    >
                        {/* Icon */}
                        <div className="flex justify-center mb-6">
                            <div className="w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center border border-green-500/30">
                                <Lock className="w-8 h-8 text-green-400" />
                            </div>
                        </div>

                        {/* Message */}
                        <h3 className="text-xl font-bold text-white text-center mb-2">
                            Th√†nh c√¥ng!
                        </h3>
                        <p className="text-white/60 text-sm text-center mb-6">
                            {successMessage}
                        </p>

                        {/* Button */}
                        <button
                            onClick={() => setShowSuccessDialog(false)}
                            className="w-full py-3 bg-green-500/20 hover:bg-green-500/30 text-green-400 font-semibold rounded-xl transition-all duration-300 border border-green-500/30 hover:border-green-500/50"
                        >
                            ƒê√≥ng
                        </button>
                    </div>
                </div>
            )}
            
            <style jsx global>{`
                @keyframes shake { 
                    0%, 100% { transform: translateX(0); } 
                    25% { transform: translateX(-5px); } 
                    75% { transform: translateX(5px); } 
                } 
                .animate-shake { animation: shake 0.3s ease-in-out; }
                @keyframes fadeIn {
                    from { opacity: 0; transform: scale(0.9); }
                    to { opacity: 1; transform: scale(1); }
                }
                .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
            `}</style>
        </div>
    );
}
</file>

<file path="CongDangNhap/middleware.ts">
import { createServerClient } from '@supabase/ssr';
import { NextResponse, type NextRequest } from 'next/server';

// Route c√¥ng khai
const PUBLIC_ROUTES = [
  '/', 
  '/trangchu', 
  '/dathang', 
  '/CongDangNhap',
  '/auth/callback',
  '/login'
];

// Route tƒ©nh
const STATIC_PATHS = [
  '/_next', '/api', '/static', '/favicon.ico', '/manifest.json', 
  '.png', '.jpg', '.jpeg', '.svg', '.css', '.js', '.mp3'
];

export async function middleware(request: NextRequest) {
  const path = request.nextUrl.pathname;

  // 1. B·ªè qua file tƒ©nh
  if (STATIC_PATHS.some(p => path.startsWith(p) || path.endsWith(p))) {
    return NextResponse.next();
  }

  let response = NextResponse.next({
    request: { headers: request.headers },
  });

  // Setup Supabase
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) { return request.cookies.get(name)?.value; },
        set(name: string, value: string, options: any) {
          request.cookies.set({ name, value, ...options });
          response = NextResponse.next({ request: { headers: request.headers } });
          response.cookies.set({ name, value, ...options });
        },
        remove(name: string, options: any) {
          request.cookies.set({ name, value: '', ...options });
          response = NextResponse.next({ request: { headers: request.headers } });
          response.cookies.set({ name, value: '', ...options });
        },
      },
    }
  );

  // 2. L·∫•y User
  const { data: { user } } = await supabase.auth.getUser();

  // A. CH∆ØA ƒêƒÇNG NH·∫¨P
  if (!user) {
    if (!PUBLIC_ROUTES.includes(path)) {
      return NextResponse.redirect(new URL('/?login=1', request.url));
    }
    return response;
  }

  // B. ƒê√É ƒêƒÇNG NH·∫¨P
  const email = user.email;
  if (!email) return response;

  // 3. X√°c ƒë·ªãnh Role
  let userType = '';
  let roleNormalized = '';

  const { data: nhanSu } = await supabase
    .from('nhan_su')
    .select('vi_tri_normalized')
    .eq('email', email)
    .single();

  if (nhanSu) {
    userType = 'nhan_su';
    roleNormalized = nhanSu.vi_tri_normalized || 'parttime';
  } else {
    const { data: khachHang } = await supabase
      .from('khach_hang')
      .select('phan_loai_normalized')
      .eq('email', email)
      .single();

    if (khachHang) {
      userType = 'khach_hang';
      roleNormalized = khachHang.phan_loai_normalized || 'moi';
    } else {
      // User r√°c -> Logout
      await supabase.auth.signOut();
      return NextResponse.redirect(new URL('/', request.url));
    }
  }

  // 4. Ki·ªÉm tra quy·ªÅn (C√≥ Fallback)
  if (roleNormalized === 'admin' || roleNormalized === 'boss') {
    return response; 
  }

  // Th·ª≠ ƒë·ªçc DB
  const { data: permission } = await supabase
    .from('routing_permissions')
    .select('allowed_routes, default_route')
    .eq('user_type', userType)
    .eq('role_normalized', roleNormalized)
    .single();

  let allowedRoutes: string[] = [];
  let defaultRoute = '/';

  if (permission) {
    // C√≥ d·ªØ li·ªáu DB
    defaultRoute = permission.default_route || '/';
    if (Array.isArray(permission.allowed_routes)) {
        allowedRoutes = permission.allowed_routes;
    } else if (typeof permission.allowed_routes === 'string') {
        try { allowedRoutes = JSON.parse(permission.allowed_routes); } catch {}
    }
  } else {
    // üü¢ D√ôNG FALLBACK TRONG CODE (Quan tr·ªçng)
    if (userType === 'nhan_su') {
        defaultRoute = `/phong${roleNormalized}`; // VD: /phongparttime
        allowedRoutes = [defaultRoute, '/dashboard'];
        
        // Fix ƒë·∫∑c bi·ªát cho tr∆∞·ªùng h·ª£p mapping kh√¥ng ƒë·ªÅu
        if (roleNormalized === 'thosanxuat') defaultRoute = '/phongtho';
        if (roleNormalized === 'congtacvien') defaultRoute = '/phongctv';
        
        allowedRoutes.push(defaultRoute);
    } else {
        allowedRoutes = ['/trangchu', '/dathang'];
        defaultRoute = '/trangchu';
    }
  }

  // Logic ch·∫∑n ƒë∆∞·ªùng
  const isAllowed = PUBLIC_ROUTES.includes(path) || allowedRoutes.some(route => {
    return path === route || path.startsWith(`${route}/`);
  });

  if (isAllowed) {
    return response;
  } else {
    // Redirect v·ªÅ ph√≤ng chu·∫©n
    if (path === defaultRoute) {
        // Tr√°nh loop n·∫øu defaultRoute c≈©ng l·ªói
        return NextResponse.redirect(new URL(userType === 'nhan_su' ? '/phongparttime' : '/', request.url));
    }
    return NextResponse.redirect(new URL(defaultRoute, request.url));
  }
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico).*)',
  ],
};
</file>

<file path="CongDangNhap/page.tsx">
'use client';

import React from 'react';
import CongDangNhap from './CongDangNhap';

/**
 * üîê TRANG C·ªîNG ƒêƒÇNG NH·∫¨P
 * Route: /CongDangNhap
 * 
 * S·ª≠ d·ª•ng component CongDangNhap ƒë√£ t·ªëi ∆∞u giao di·ªán
 * v·ªõi ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng: remember me, fullscreen, redirect ƒë√∫ng ph√≤ng
 */
export default function TrangCongDangNhap() {
  return <CongDangNhap isGateKeeper={true} />;
}
</file>

<file path="CongDangNhap/RoleRedirectService.ts">
import { supabase } from '@/app/ThuVien/ketNoiSupabase';

// H√†m chu·∫©n h√≥a chu·ªói
const normalizeString = (str: string | null | undefined): string => {
    if (!str) return '';
    return str
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .replace(/[^a-z0-9]/g, "")
        .trim();
};

// üü¢ C·∫§U H√åNH D·ª∞ PH√íNG (Kh·ªõp 100% v·ªõi file CSV routing_permissions)
// Gi√∫p h·ªá th·ªëng v·∫´n ch·∫°y ngon k·ªÉ c·∫£ khi Database b·ªã ch·∫∑n quy·ªÅn ƒë·ªçc
const FALLBACK_ROUTES: Record<string, string> = {
    // Nh√≥m Qu·∫£n Tr·ªã
    'admin': '/phongadmin',
    'boss': '/phongadmin',
    'quanly': '/phongquanly',
    
    // Nh√≥m Nghi·ªáp V·ª•
    'sales': '/phongsales',
    'ketoan': '/phongketoan',   // ‚úÖ M·ªõi: K·∫ø to√°n
    'thukho': '/phongkho',      // ‚úÖ M·ªõi: Th·ªß kho
    
    // Nh√≥m S·∫£n Xu·∫•t
    'congtacvien': '/phongctv',
    'ctv': '/phongctv',
    'parttime': '/phongparttime',
    'thosanxuat': '/phongtho',
    'tho': '/phongtho',
    'kythuat': '/phongtho',
    'thietke': '/phongthietke',
    
    // Nh√≥m Kh√°ch h√†ng
    'vip': '/trangchu',
    'doitac': '/trangchu',
    'moi': '/trangchu',
    'damuahang': '/trangchu',
    'khtrongtam': '/trangchu',
    'khach': '/trangchu'
};

const FALLBACK_ALLOWED_ROUTES: Record<string, string[]> = {
    // Admin & Boss: Full quy·ªÅn
    'admin': ['/phongadmin', '/phongquanly', '/phongkho', '/phongketoan', '/phongsales', '/phongparttime', '/phongctv', '/phongthietke', '/dashboard', '/settings'],
    'boss': ['/phongadmin', '/phongquanly', '/phongkho', '/phongketoan', '/phongsales', '/phongparttime', '/phongctv', '/phongthietke', '/dashboard', '/settings'],
    
    // Qu·∫£n l√Ω: ƒê∆∞·ª£c xem Kho, K·∫ø to√°n ƒë·ªÉ duy·ªát
    'quanly': ['/phongquanly', '/phongkho', '/phongketoan', '/dashboard'],
    
    // Nghi·ªáp v·ª• c·ª• th·ªÉ
    'sales': ['/phongsales', '/dathang', '/phongkho'], // ‚úÖ Sales ƒë∆∞·ª£c xem kho ƒë·ªÉ b√°o kh√°ch
    'ketoan': ['/phongketoan', '/dashboard'],          // ‚úÖ M·ªõi
    'thukho': ['/phongkho', '/dashboard'],             // ‚úÖ M·ªõi
    
    // S·∫£n xu·∫•t
    'parttime': ['/phongparttime'],
    'thosanxuat': ['/phongtho'],
    'congtacvien': ['/phongctv'],
    'thietke': ['/phongthietke'],
    
    // Kh√°ch h√†ng
    'khach': ['/trangchu', '/dathang', '/giohang']
};

export class RoleRedirectService {

    // ============================================================
    // 1. LOGIC ƒêI·ªÄU H∆Ø·ªöNG (∆ØU TI√äN DB -> D·ª∞ PH√íNG SAU)
    // ============================================================

    static async getRedirectUrl(
        userType: string, 
        roleNormalized: string
    ): Promise<string> {
        try {
            const p_role = normalizeString(roleNormalized);

            // 1. Th·ª≠ ƒë·ªçc t·ª´ Database
            const { data, error } = await supabase
                .from('routing_permissions')
                .select('default_route')
                .eq('user_type', userType)
                .eq('role_normalized', p_role)
                .maybeSingle();

            if (!error && data && data.default_route) {
                return data.default_route;
            }

            // 2. N·∫øu l·ªói ho·∫∑c kh√¥ng t√¨m th·∫•y -> D√πng ch·∫ø ƒë·ªô D·ª∞ PH√íNG
            // ƒêi·ªÅu n√†y ph√° v·ª° v√≤ng l·∫∑p v√¥ t·∫≠n khi DB b·ªã l·ªói
            if (FALLBACK_ROUTES[p_role]) {
                console.log(`‚ö†Ô∏è D√πng Fallback Route cho ${p_role}: ${FALLBACK_ROUTES[p_role]}`);
                return FALLBACK_ROUTES[p_role];
            }

            // 3. ƒê∆∞·ªùng c√πng (M·∫∑c ƒë·ªãnh an to√†n ƒë·ªÉ kh√¥ng v·ªÅ trang ch·ªß n·∫øu l√† nh√¢n s·ª±)
            return userType === 'nhan_su' ? '/phongparttime' : '/trangchu';

        } catch (err) {
            console.error('RoleRedirectService Error:', err);
            return '/';
        }
    }

    // ============================================================
    // 2. CHECK QUY·ªÄN TRUY C·∫¨P (DB -> D·ª∞ PH√íNG)
    // ============================================================

    static async isRouteAllowed(
        userType: string, 
        roleNormalized: string, 
        route: string
    ): Promise<boolean> {
        try {
            const p_role = normalizeString(roleNormalized);
            const cleanRoute = route.split('?')[0];

            // Admin lu√¥n ƒë∆∞·ª£c ƒëi m·ªçi n∆°i
            if (p_role === 'admin' || p_role === 'boss') return true;

            // 1. Th·ª≠ ƒë·ªçc DB
            const { data, error } = await supabase
                .from('routing_permissions')
                .select('allowed_routes')
                .eq('user_type', userType)
                .eq('role_normalized', p_role)
                .maybeSingle();

            let allowedRoutes: string[] = [];

            if (!error && data && data.allowed_routes) {
                if (Array.isArray(data.allowed_routes)) {
                    allowedRoutes = data.allowed_routes;
                } else if (typeof data.allowed_routes === 'string') {
                    try { allowedRoutes = JSON.parse(data.allowed_routes); } catch {}
                }
            } else {
                // 2. D√πng D·ª± ph√≤ng
                allowedRoutes = FALLBACK_ALLOWED_ROUTES[p_role] || FALLBACK_ALLOWED_ROUTES['khach'];
            }

            // Logic kh·ªõp route
            const isAllowed = allowedRoutes.some((r: string) => {
                return cleanRoute === r || cleanRoute.startsWith(r + '/');
            });

            return isAllowed;

        } catch (err) {
            console.error('Permission Check Error:', err);
            return false;
        }
    }

    // ============================================================
    // 3. UI HELPERS (Gi·ªØ nguy√™n)
    // ============================================================

    static isHRAdmin(viTriNormalized: string | null | undefined): boolean {
        if (!viTriNormalized) return false;
        const role = normalizeString(viTriNormalized);
        return ['admin', 'quanly', 'boss', 'sep', 'manager'].includes(role);
    }

    static getModalIdFromPosition(viTriNormalized: string | null | undefined): string | null {
        if (!viTriNormalized) return null;
        const role = normalizeString(viTriNormalized);
        
        const map: Record<string, string> = {
            'admin': 'admin',
            'quanly': 'quanly',
            'boss': 'quanly',
            'sales': 'sales',
            'ketoan': 'ketoan', // ‚úÖ M·ªõi
            'thukho': 'thukho', // ‚úÖ M·ªõi
            'thosanxuat': 'tho',
            'tho': 'tho',
            'kythuat': 'tho',
            'thietke': 'thietke',
            'parttime': 'parttime',
            'thoivu': 'parttime',
            'congtacvien': 'ctv',
            'ctv': 'ctv',
            'khtrongtam': 'trungbay',
            'vip': 'trungbay'
        };
        
        return map[role] || null;
    }

    static getModalDisplayName(viTriNormalized: string | null | undefined): string | null {
        if (!viTriNormalized) return null;
        const role = normalizeString(viTriNormalized);
        
        const map: Record<string, string> = {
            'admin': 'Ph√≤ng Admin',
            'quanly': 'Ph√≤ng Qu·∫£n L√Ω',
            'sales': 'Ph√≤ng Sales',
            'ketoan': 'Ph√≤ng K·∫ø To√°n', // ‚úÖ M·ªõi
            'thukho': 'Kho T·ªïng',      // ‚úÖ M·ªõi
            'thosanxuat': 'Ph√≤ng Th·ª£',
            'thietke': 'Ph√≤ng Thi·∫øt K·∫ø',
            'parttime': 'Ph√≤ng Part-time',
            'congtacvien': 'Ph√≤ng CTV',
            'khtrongtam': 'Ph√≤ng Tr∆∞ng B√†y',
            'vip': 'Ph√≤ng VIP'
        };
        
        if (!map[role]) {
            return `Ph√≤ng ${role.charAt(0).toUpperCase() + role.slice(1)}`;
        }

        return map[role];
    }
}

// Export l·∫ª
export const getRedirectUrl = RoleRedirectService.getRedirectUrl;
export const isRouteAllowed = RoleRedirectService.isRouteAllowed;
export const isHRAdmin = RoleRedirectService.isHRAdmin;
export const getModalIdFromPosition = RoleRedirectService.getModalIdFromPosition;
export const getModalDisplayName = RoleRedirectService.getModalDisplayName;
</file>

<file path="constants/zIndex.ts">
// ‚úÖ Z-INDEX MANAGEMENT SYSTEM
// Centralized z-index values to prevent conflicts

export const Z_INDEX = {
  // Background layers
  background: 0,
  backgroundImage: 1,
  gradient: 4900,

  // Main content
  content: 10,
  contentOverlay: 20,

  // Menu system
  menuTren: 5000,
  menuDuoi: 5000,
  menuButton: 11000,

  // Chat system
  chatDrawer: 5500,
  chatToast: 5600,

  // Modals & Overlays
  modalBackdrop: 9900,
  modal: 9999,

  // Floating elements
  adminTools: 5001,
  loginButton: 5002,

  // Utilities
  tooltip: 10000,
  notification: 10100,
} as const;

// Export type for TypeScript strict checks
export type ZIndexKey = keyof typeof Z_INDEX;
</file>

<file path="dashboard/admin/page.tsx">
'use client';

import React from 'react';
import { useRouter } from 'next/navigation';
import { useUser } from '@/app/ThuVien/UserContext';
import { BarChart3, Users, Settings, AlertCircle } from 'lucide-react';

/**
 * üìä ADMIN DASHBOARD
 * Route: /dashboard/admin
 */
export default function AdminDashboardPage() {
  const router = useRouter();
  const { user, loading } = useUser();

  // Loading state
  if (loading) {
    return (
      <div className="min-h-screen bg-[#050505] flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#C69C6D] mx-auto mb-4" />
          <p className="text-gray-400">ƒêang t·∫£i...</p>
        </div>
      </div>
    );
  }

  // No user - redirect
  if (!user) {
    router.push('/');
    return null;
  }

  return (
    <div className="min-h-screen bg-[#050505] p-4 md:p-8">
      {/* HEADER */}
      <div className="mb-8">
        <h1 className="text-4xl font-bold text-[#C69C6D] mb-2">üìä Admin Dashboard</h1>
        <p className="text-white/70">
          Ch√†o {user.ho_ten} ({user.userType === 'nhan_su' ? user.vi_tri_normalized : user.phan_loai_normalized})
        </p>
      </div>

      {/* STATS GRID */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <StatCard icon={Users} title="Users" value="1,234" color="blue" />
        <StatCard icon={BarChart3} title="Analytics" value="85%" color="green" />
        <StatCard icon={Settings} title="Products" value="567" color="purple" />
        <StatCard icon={AlertCircle} title="Alerts" value="42" color="red" />
      </div>

      {/* SECTIONS */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div className="bg-[#1a120f] border border-[#8B5E3C]/30 rounded-lg p-6">
          <h2 className="text-xl font-bold text-[#C69C6D] mb-4 flex items-center gap-2">
            <Users size={20} /> User Management
          </h2>
          <p className="text-white/70 mb-4">Manage system users and roles</p>
          <button className="px-4 py-2 bg-[#C69C6D] text-black rounded font-bold hover:bg-white transition-all">
            Manage Users
          </button>
        </div>

        <div className="bg-[#1a120f] border border-[#8B5E3C]/30 rounded-lg p-6">
          <h2 className="text-xl font-bold text-[#C69C6D] mb-4 flex items-center gap-2">
            <Settings size={20} /> System Settings
          </h2>
          <p className="text-white/70 mb-4">Configure system settings</p>
          <button className="px-4 py-2 bg-[#C69C6D] text-black rounded font-bold hover:bg-white transition-all">
            Settings
          </button>
        </div>

        <div className="bg-[#1a120f] border border-[#8B5E3C]/30 rounded-lg p-6">
          <h2 className="text-xl font-bold text-[#C69C6D] mb-4 flex items-center gap-2">
            <BarChart3 size={20} /> Analytics
          </h2>
          <p className="text-white/70 mb-4">View detailed analytics</p>
          <button className="px-4 py-2 bg-[#C69C6D] text-black rounded font-bold hover:bg-white transition-all">
            View Analytics
          </button>
        </div>

        <div className="bg-[#1a120f] border border-[#8B5E3C]/30 rounded-lg p-6">
          <h2 className="text-xl font-bold text-[#C69C6D] mb-4">Content Management</h2>
          <p className="text-white/70 mb-4">Manage website content</p>
          <button className="px-4 py-2 bg-[#C69C6D] text-black rounded font-bold hover:bg-white transition-all">
            Manage Content
          </button>
        </div>
      </div>
    </div>
  );
}

interface StatCardProps {
  icon: React.ElementType;
  title: string;
  value: string;
  color: string;
}

function StatCard({ icon: Icon, title, value, color }: StatCardProps) {
  const colorClasses: Record<string, string> = {
    blue: 'text-blue-400 bg-blue-900/20 border-blue-500',
    green: 'text-green-400 bg-green-900/20 border-green-500',
    purple: 'text-purple-400 bg-purple-900/20 border-purple-500',
    red: 'text-red-400 bg-red-900/20 border-red-500',
  };

  return (
    <div className={`${colorClasses[color]} border rounded-lg p-6`}>
      <Icon size={24} />
      <p className="text-white/70 text-sm mt-2">{title}</p>
      <p className="text-2xl font-bold mt-2">{value}</p>
    </div>
  );
}
</file>

<file path="dathang/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { supabase } from '@/app/ThuVien/ketNoiSupabase';
import KhungTrangChuan from '@/app/components/KhungTrangChuan';
import { useUser } from '@/app/ThuVien/UserContext';
import { Search, ShoppingCart, Filter, Loader2 } from 'lucide-react';

export default function TrangDatHang() {
  const { user } = useUser();
  const [products, setProducts] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('all');

  useEffect(() => {
    const fetchProducts = async () => {
      // L·∫•y d·ªØ li·ªáu t·ª´ b·∫£ng VAT_TU (ƒë√£ seed)
      const { data } = await supabase
        .from('vat_tu')
        .select('*')
        .eq('loai_vat_tu', 'thanh_pham')
        .order('gia_ban', { ascending: true });
      
      if (data) setProducts(data);
      setLoading(false);
    };
    fetchProducts();
  }, []);

  const handleOrder = async (product: any) => {
    if (!user) {
        alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t h√†ng!");
        return;
    }
    const confirmMsg = `X√°c nh·∫≠n ƒë·∫∑t t√°c ph·∫©m: ${product.ten_vat_tu}\nGi√°: ${product.gia_ban.toLocaleString()} VNƒê?`;
    if (!confirm(confirmMsg)) return;

    // G·ªçi API t·∫°o ƒë∆°n h√†ng (ƒë√£ c√≥ trigger tr·ª´ kho)
    const { error } = await supabase.from('don_hang_chi_tiet').insert({
        don_hang_id: null, // T·∫°o ƒë∆°n nh√°p (ho·∫∑c logic t·∫°o ƒë∆°n m·ªõi) - ·ªû ƒë√¢y demo
        vat_tu_id: product.id,
        so_luong: 1,
        don_gia: product.gia_ban,
        ten_item_hien_thi: product.ten_vat_tu
    });
    
    // V√¨ logic t·∫°o ƒë∆°n ph·ª©c t·∫°p c·∫ßn Header ƒë∆°n h√†ng, ·ªü ƒë√¢y ta gi·∫£ l·∫≠p b√°o th√†nh c√¥ng
    // Th·ª±c t·∫ø n√™n d√πng OrderService.createOrder
    alert("ƒê√£ g·ª≠i y√™u c·∫ßu ƒë·∫∑t h√†ng! Nh√¢n vi√™n s·∫Ω li√™n h·ªá b·∫°n s·ªõm.");
  };

  return (
    <KhungTrangChuan nguoiDung={user} loiChao="B·ªò S∆ØU T·∫¨P T√ÅC PH·∫®M">
      <div className="max-w-6xl mx-auto px-4 pb-20">
        
        {/* B·ªô l·ªçc */}
        <div className="flex gap-2 overflow-x-auto pb-4 mb-6 scrollbar-hide">
             {['all', 'Xu√¢n', 'H·∫°', 'Thu', 'ƒê√¥ng'].map(bg => (
                 <button 
                    key={bg}
                    onClick={() => setFilter(bg)}
                    className={`px-4 py-2 rounded-full text-xs font-bold uppercase border transition-all whitespace-nowrap
                    ${filter === bg ? 'bg-[#C69C6D] text-black border-[#C69C6D]' : 'bg-white/5 border-white/10 text-white hover:border-white'}`}
                 >
                    {bg === 'all' ? 'T·∫•t c·∫£' : `BST ${bg}`}
                 </button>
             ))}
        </div>

        {/* Grid S·∫£n ph·∫©m */}
        {loading ? (
            <div className="flex justify-center py-20"><Loader2 className="animate-spin text-[#C69C6D]"/></div>
        ) : (
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {products
                .filter(p => filter === 'all' || p.bo_suu_tap === filter)
                .map((p) => (
                <div key={p.id} className="bg-[#111] border border-white/10 rounded-2xl overflow-hidden group hover:border-[#C69C6D]/50 transition-all">
                    <div className="aspect-square relative overflow-hidden">
                        <img src={p.hinh_anh} alt={p.ten_vat_tu} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"/>
                        <div className="absolute top-2 right-2 bg-black/60 backdrop-blur px-2 py-1 rounded text-[10px] text-[#C69C6D] font-bold border border-[#C69C6D]/30">
                            BST {p.bo_suu_tap}
                        </div>
                    </div>
                    <div className="p-4">
                        <h3 className="text-white font-serif text-lg font-bold truncate">{p.ten_vat_tu}</h3>
                        <div className="flex items-center justify-between mt-2">
                            <span className="text-[#C69C6D] font-bold">
                                {p.gia_ban.toLocaleString()} ‚Ç´
                            </span>
                            <button 
                                onClick={() => handleOrder(p)}
                                className="p-2 bg-white text-black rounded-full hover:bg-[#C69C6D] transition-colors"
                            >
                                <ShoppingCart size={18} />
                            </button>
                        </div>
                        <p className="text-gray-500 text-xs mt-2">C√≤n l·∫°i: {p.ton_kho} t√°c ph·∫©m</p>
                    </div>
                </div>
            ))}
            </div>
        )}
      </div>
    </KhungTrangChuan>
  );
}
</file>

<file path="GiaoDienTong/KhungGiaoDienTong.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Loader2 } from 'lucide-react';

// üü¢ C·∫¨P NH·∫¨T IMPORT
 
import CongDangNhap from '../CongDangNhap/CongDangNhap'; 
import StaffPresence from '../components/StaffPresence';

export default function KhungGiaoDienTong({ children }: { children: React.ReactNode }) {
  const pathname = usePathname();
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(true);
  const [currentUser, setCurrentUser] = useState<any>(null);

  useEffect(() => {
    const loadUser = () => {
      // 1. C√°c trang t·ª± qu·∫£n l√Ω auth -> Cho qua lu√¥n
      if (pathname === '/' || pathname === '/admin' || pathname === '/phongquanly' || pathname === '/phongparttime' || pathname === '/trangchu') {
          setIsLoading(false);
          return;
      }

      // 2. Load user t·ª´ localStorage
      const storedUser = typeof window !== 'undefined' ? localStorage.getItem('USER_INFO') : null;
      
      if (storedUser) {
        try {
          setCurrentUser(JSON.parse(storedUser));
        } catch (e) {
          console.error('Error parsing user:', e);
        }
      }
      
      setIsLoading(false);
    };

    loadUser();
  }, [pathname]);

  if (isLoading) return (
      <div className="h-screen bg-black flex flex-col items-center justify-center gap-4">
          <Loader2 className="animate-spin text-[#C69C6D]" size={40}/>
      </div>
  );
 
  return (
    <div className="flex flex-col min-h-screen bg-[#0a0a0a] text-gray-200 font-sans relative">
        <main className="flex-1 w-full max-w-[1920px] mx-auto p-3 pb-20 md:p-6 md:pb-20">
            {children}
        </main>
 <StaffPresence />
 
    </div>
  );
}
</file>

<file path="GiaoDienTong/MenuSystemWrapper.tsx">
'use client';

import React from 'react';
import MenuDuoi from './MenuDuoi/MenuDuoi';

interface MenuSystemWrapperProps {
  currentUser?: any;
  onToggleContent?: (isOpen: boolean) => void;
  onlyAccountButton?: boolean;
}

/**
 * üé® Reusable Menu System Wrapper
 * Packages gradient overlays + MenuDuoi for consistent styling across all pages
 * Usage: <MenuSystemWrapper currentUser={user} onlyAccountButton={true} />
 */
export default function MenuSystemWrapper({ 
  currentUser, 
  onToggleContent, 
  onlyAccountButton 
}: MenuSystemWrapperProps) {
  return (
    <>
      {/* GRADIENT B·∫¢O V·ªÜ MENU - Bottom */}
      <div className="fixed bottom-0 left-0 right-0 h-28 bg-gradient-to-t from-black to-transparent z-[4900] pointer-events-none"></div>

      {/* MENU D∆Ø·ªöI */}
      <div className="fixed inset-0 pointer-events-none" style={{ zIndex: 10999 }}>
        <MenuDuoi 
          currentUser={currentUser} 
          onToggleContent={onToggleContent}
          onlyAccountButton={onlyAccountButton}
        />
      </div>
    </>
  );
}
</file>

<file path="GiaoDienTong/MenuTren/MenuTren.tsx">
"use client";
import React, { useState, useEffect, useRef } from "react";
import { createPortal } from "react-dom";
import { ShoppingCart, QrCode, UserCircle } from "lucide-react";
import NhacNen from "@/app/Music/NhacNen";
import NotificationCenter from "./NotificationCenter";
import { NotificationService } from "./NotificationService";
import { Notification } from "./NotificationTypes";
import { useUser } from "@/app/ThuVien/UserContext";
import { Z_INDEX } from "@/app/constants/zIndex";
import { useAppSettings } from "@/app/ThuVien/AppSettingsContext";
import ModalProfile from "@/app/GiaoDienTong/MenuTren/NutCaNhan/ModalProfile";

// Hook √¢m thanh th√¥ng b√°o
const useNotificationSound = () => {
  const audioRef = useRef<HTMLAudioElement | null>(null);
  useEffect(() => {
    if (typeof window !== "undefined") {
      audioRef.current = new Audio("/sounds/hover.mp3");
    }
  }, []);
  return () => {
    if (audioRef.current) {
      audioRef.current.currentTime = 0;
      audioRef.current.play().catch(() => {});
    }
  };
};

export default function MenuTren({
  nguoiDung: fallbackUser,
}: {
  nguoiDung: any;
  loiChao: string;
}) {
  const { user: contextUser } = useUser();
  const { t } = useAppSettings();
  const playSound = useNotificationSound();

  // ∆Øu ti√™n user t·ª´ context
  const nguoiDung = contextUser
    ? {
        id: contextUser.id,
        ho_ten: contextUser.ho_ten || t("profile.user"),
        email: contextUser.email,
        role:
          contextUser.userType === "nhan_su"
            ? contextUser.vi_tri_normalized
            : contextUser.phan_loai_normalized,
        permissions: contextUser.permissions,
        vi_tri: contextUser.vi_tri,
        userType: contextUser.userType,
        phan_loai: contextUser.phan_loai,
        so_dien_thoai: contextUser.so_dien_thoai,
      }
    : fallbackUser;

  const isVisitor =
    !nguoiDung ||
    nguoiDung?.userType === "guest" ||
    nguoiDung?.role === "visitor";
  const isNhanSu = nguoiDung?.userType === "nhan_su";

  // State
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const [unreadCount, setUnreadCount] = useState(0);
  const [cartCount, setCartCount] = useState(0);
  const [showProfile, setShowProfile] = useState(false);
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  // üü¢ LOGIC L·∫§Y T√äN HI·ªÇN TH·ªä (R√öT G·ªåN CHO MOBILE)
  const getDisplayName = () => {
    if (isVisitor) return { full: "Qu√Ω Kh√°ch", short: "KH√ÅCH" };

    const fullName = nguoiDung?.ho_ten || "";
    const lastName = fullName.trim().split(" ").pop()?.toUpperCase() || "B·∫†N";

    return {
      full: fullName,
      short: lastName,
    };
  };

  const displayName = getDisplayName();

  // üü¢ LOGIC GI·ªé H√ÄNG
  useEffect(() => {
    if (isNhanSu) return;

    const checkCart = () => {
      try {
        const cartData = localStorage.getItem("cart_items");
        const items = cartData ? JSON.parse(cartData) : [];
        setCartCount(items.length || 0);
      } catch {
        setCartCount(0);
      }
    };

    checkCart();
    window.addEventListener("storage", checkCart);
    window.addEventListener("cart_updated", checkCart);

    return () => {
      window.removeEventListener("storage", checkCart);
      window.removeEventListener("cart_updated", checkCart);
    };
  }, [isNhanSu]);

  // üü¢ NOTIFICATION LOGIC
  useEffect(() => {
    if (!nguoiDung?.id || isVisitor) return;

    let isMounted = true;
    let subscription: any = null;

    const initNotifications = async () => {
      try {
        const [notifs, count] = await Promise.all([
          NotificationService.getUserNotifications(nguoiDung.id),
          NotificationService.getUnreadCount(nguoiDung.id),
        ]);

        if (isMounted) {
          setNotifications(notifs);
          setUnreadCount(count);
        }

        subscription = NotificationService.subscribeToNotifications(
          nguoiDung.id,
          (newNotification) => {
            if (isMounted) {
              playSound();
              setNotifications((prev) => {
                if (prev.some((n) => n.id === newNotification.id)) return prev;
                return [newNotification, ...prev];
              });
              if (!newNotification.is_read) setUnreadCount((prev) => prev + 1);
            }
          }
        );
      } catch (error) {
        console.error("L·ªói th√¥ng b√°o:", error);
      }
    };

    initNotifications();

    return () => {
      isMounted = false;
      if (subscription?.unsubscribe) subscription.unsubscribe();
    };
  }, [nguoiDung?.id, isVisitor]);

  const handleMarkAsRead = async (id: string) => {
    setNotifications((prev) =>
      prev.map((n) => (n.id === id ? { ...n, is_read: true } : n))
    );
    setUnreadCount((prev) => Math.max(0, prev - 1));
    await NotificationService.markAsRead(id);
  };

  const handleMarkAllAsRead = async () => {
    if (!nguoiDung?.id) return;
    setNotifications((prev) => prev.map((n) => ({ ...n, is_read: true })));
    setUnreadCount(0);
    await NotificationService.markAllAsRead(nguoiDung.id);
  };

  const handleDelete = async (id: string) => {
    setNotifications((prev) => {
      const notif = prev.find((n) => n.id === id);
      if (notif && !notif.is_read) setUnreadCount((c) => Math.max(0, c - 1));
      return prev.filter((n) => n.id !== id);
    });
    await NotificationService.deleteNotification(id);
  };

  const handleNotificationClick = (notification: Notification) => {
    if (notification.action_url) window.location.href = notification.action_url;
    if (!notification.is_read) handleMarkAsRead(notification.id);
  };

  return (
    <>
      <div
        className={`fixed top-0 left-0 right-0 h-[65px] md:h-[85px] px-3 md:px-6 flex justify-between items-center bg-transparent transition-all duration-300 pointer-events-none`}
        style={{ zIndex: Z_INDEX.menuTren }}
      >
        {/* üü¢ G√ìC TR√ÅI: T√äN HI·ªÇN TH·ªä (CO GI√ÉN T·ªêT) */}
        <div className="flex-1 min-w-0 flex items-center gap-2 animate-slide-down pointer-events-auto mr-2">
          {/* Desktop: Hi·ªán ƒë·∫ßy ƒë·ªß */}
          <div className="hidden md:flex flex-col">
            <span className="text-xs font-medium italic text-gray-300 drop-shadow-md">
              {isVisitor ? "Ch√†o m·ª´ng," : "Xin ch√†o,"}
            </span>
            <span
              className="font-black text-white uppercase tracking-wider drop-shadow-lg shadow-black truncate max-w-[200px] lg:max-w-none"
              style={{ fontSize: "20px" }}
            >
              {displayName.full}
            </span>
          </div>

          {/* Mobile: Hi·ªán r√∫t g·ªçn */}
          <div className="md:hidden flex items-baseline gap-1 overflow-hidden">
            <span className="text-[10px] text-gray-300 italic whitespace-nowrap">
              Ch√†o
            </span>
            <span className="font-bold text-[#C69C6D] uppercase truncate text-sm drop-shadow-md">
              {displayName.short}
            </span>
          </div>
        </div>

        {/* üü¢ G√ìC PH·∫¢I: C√ÅC N√öT (KH√îNG BAO GI·ªú B·ªä ƒê·∫®Y M·∫§T) */}
        {!isVisitor && (
          <div className="shrink-0 flex gap-1.5 md:gap-3 animate-slide-down delay-100 pointer-events-auto items-center">
            {/* 1. Nh·∫°c n·ªÅn: Hi·ªán m·ªçi n∆°i */}
            {nguoiDung?.id && <NhacNen />}

            {/* 2. Gi·ªè h√†ng: Ch·ªâ hi·ªán n·∫øu l√† Kh√°ch h√†ng & c√≥ ƒë·ªì */}
            {!isNhanSu && cartCount > 0 && (
              <NutVuong
                icon={ShoppingCart}
                badge={cartCount}
                onClick={() => {
                  /* Logic m·ªü gi·ªè h√†ng */
                }}
                className="animate-bounce-slow"
              />
            )}

            {/* 3. Th√¥ng b√°o */}
            {nguoiDung?.id && (
              <NotificationCenter
                notifications={notifications}
                unreadCount={unreadCount}
                onMarkAsRead={handleMarkAsRead}
                onMarkAllAsRead={handleMarkAllAsRead}
                onDelete={handleDelete}
                onNotificationClick={handleNotificationClick}
              />
            )}

            {/* 4. QR Code: CH·ªà HI·ªÜN TR√äN DESKTOP (Mobile ·∫©n ƒëi ƒë·ªÉ ti·∫øt ki·ªám ch·ªó cho Nh·∫°c) */}
            <div className="hidden md:block">
              <NutVuong icon={QrCode} />
            </div>

            {/* 5. N√∫t C√° Nh√¢n: Lu√¥n hi·ªán */}
            <NutVuong
              icon={UserCircle}
              onClick={() => setShowProfile(true)}
              isActive={showProfile}
            />
          </div>
        )}
      </div>

      {mounted &&
        showProfile &&
        nguoiDung &&
        !isVisitor &&
        createPortal(
          <ModalProfile
            isOpen={true}
            onClose={() => setShowProfile(false)}
            nguoiDung={nguoiDung}
          />,
          document.body
        )}
    </>
  );
}

// Component N√∫t Vu√¥ng (ƒê√£ ch·ªânh padding nh·ªè h∆°n cho Mobile)
function NutVuong({
  icon: Icon,
  badge,
  onClick,
  isActive,
  className = "",
}: any) {
  return (
    <button
      onClick={onClick}
      className={`
                w-9 h-9 md:w-10 md:h-10 rounded-lg flex items-center justify-center relative active:scale-95 transition-all backdrop-blur-sm shadow-sm group cursor-pointer
                ${
                  isActive
                    ? "bg-[#C69C6D] border border-[#C69C6D] text-black shadow-[0_0_15px_rgba(198,156,109,0.4)]"
                    : "bg-black/40 border border-white/10 hover:bg-white/10 text-white"
                }
                ${className}
            `}
    >
      <Icon
        size={18}
        className={`transition-colors ${
          isActive ? "text-black" : "text-white group-hover:text-[#C69C6D]"
        }`}
      />

      {badge && badge > 0 && (
        <span className="absolute -top-1.5 -right-1.5 w-4 h-4 bg-red-600 text-white text-[9px] font-bold flex items-center justify-center rounded-full border border-black shadow-sm z-10 animate-in zoom-in">
          {badge > 99 ? "99+" : badge}
        </span>
      )}
    </button>
  );
}
</file>

<file path="GiaoDienTong/MenuTren/NotificationCenter.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { Bell, X, Check, CheckCircle2, MessageCircle, Heart, Users, Zap, AlertCircle, ShoppingBag, Calendar, Award } from 'lucide-react';
import { Notification, NotificationGroup, NOTIFICATION_CONFIG, NotificationType } from './NotificationTypes';
import { useAppSettings } from '@/app/ThuVien/AppSettingsContext';

interface Props {
  notifications: Notification[];
  unreadCount: number;
  onMarkAsRead: (id: string) => void;
  onMarkAllAsRead: () => void;
  onDelete: (id: string) => void;
  onNotificationClick: (notification: Notification) => void;
}

export default function NotificationCenter({ 
  notifications, 
  unreadCount, 
  onMarkAsRead, 
  onMarkAllAsRead, 
  onDelete,
  onNotificationClick 
}: Props) {
  const [isOpen, setIsOpen] = useState(false);
  const [filteredCategory, setFilteredCategory] = useState<string | null>(null);
  const { t, language } = useAppSettings(); // üåê Hook ng√¥n ng·ªØ

  // Nh√≥m th√¥ng b√°o theo category
  const groupedNotifications: NotificationGroup[] = React.useMemo(() => {
    const groups: Record<string, Notification[]> = {};
    
    notifications.forEach(notif => {
      if (!groups[notif.category]) {
        groups[notif.category] = [];
      }
      groups[notif.category].push(notif);
    });

    return Object.entries(groups).map(([category, notifs]) => ({
      category: category as any,
      label: getCategoryLabel(category),
      notifications: notifs.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime()),
      unread_count: notifs.filter(n => !n.is_read).length,
      icon: getCategoryIcon(category),
      color: getCategoryColor(category)
    }));
  }, [notifications]);

  const displayedNotifications = filteredCategory 
    ? groupedNotifications.find(g => g.category === filteredCategory)?.notifications || []
    : notifications.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());

  return (
    <div className="relative">
      {/* Notification Button */}
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className="relative w-10 h-10 bg-black/40 border border-white/10 rounded-lg flex items-center justify-center transition-all hover:bg-white/10 backdrop-blur-sm group active:scale-95"
      >
        <Bell size={18} className="text-[#C69C6D]" />
        
        {/* Badge - Unread count */}
        {unreadCount > 0 && (
          <div className="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-lg">
            {unreadCount > 99 ? '99+' : unreadCount}
          </div>
        )}

        {/* Indicator dot */}
        {unreadCount > 0 && (
          <div className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
        )}
      </button>

      {/* Notification Dropdown */}
      {isOpen && (
        <div className="fixed md:absolute top-[85px] md:top-[120%] left-0 md:left-auto md:right-0 w-screen md:w-[450px] md:max-h-[600px] bg-[#0a0807]/95 border-t md:border border-[#8B5E3C]/30 rounded-none md:rounded-xl shadow-2xl overflow-hidden z-[5100] backdrop-blur-xl flex flex-col animate-in fade-in slide-in-from-top-2 duration-200"
        >
          {/* Header */}
          <div className="sticky top-0 px-4 py-3 border-b border-[#8B5E3C]/20 bg-black/50 flex items-center justify-between">
            <div className="flex items-center gap-2">
              <h3 className="text-sm font-bold text-white uppercase tracking-widest">{t('notifications.title')}</h3>
              {unreadCount > 0 && (
                <span className="text-xs font-bold bg-red-500 text-white px-2 py-0.5 rounded-full">
                  {unreadCount} {t('notifications.new')}
                </span>
              )}
            </div>
            <div className="flex items-center gap-1">
              {unreadCount > 0 && (
                <button 
                  onClick={onMarkAllAsRead}
                  className="p-1.5 text-[#C69C6D] hover:bg-white/10 rounded transition-all active:scale-95"
                  title={t('notifications.markAllRead')}
                >
                  <CheckCircle2 size={16} />
                </button>
              )}
              <button 
                onClick={() => setIsOpen(false)}
                className="p-1.5 text-gray-400 hover:text-white hover:bg-white/10 rounded transition-all md:hidden active:scale-95"
              >
                <X size={18} />
              </button>
            </div>
          </div>

          {/* Category Filter */}
          {groupedNotifications.length > 0 && (
            <div className="sticky top-[53px] px-3 py-2 bg-black/30 border-b border-[#8B5E3C]/10 overflow-x-auto flex gap-2">
              <button
                onClick={() => setFilteredCategory(null)}
                className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider whitespace-nowrap transition-all active:scale-95 ${
                  filteredCategory === null
                    ? 'bg-[#C69C6D] text-black'
                    : 'bg-white/5 text-gray-300 hover:bg-white/10'
                }`}
              >
                {language === 'vi' ? 'T·∫•t c·∫£' : 'All'}
              </button>
              {groupedNotifications.map(group => (
                <button
                  key={group.category}
                  onClick={() => setFilteredCategory(group.category)}
                  className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider whitespace-nowrap transition-all flex items-center gap-1 active:scale-95 ${
                    filteredCategory === group.category
                      ? 'bg-[#C69C6D] text-black'
                      : 'bg-white/5 text-gray-300 hover:bg-white/10'
                  }`}
                >
                  {group.unread_count > 0 && (
                    <span className="bg-red-500 text-white text-[9px] font-bold rounded-full w-4 h-4 flex items-center justify-center">
                      {group.unread_count}
                    </span>
                  )}
                  {group.label}
                </button>
              ))}
            </div>
          )}

          {/* Notifications List */}
          <div className="flex-1 overflow-y-auto space-y-2 p-3">
            {displayedNotifications.length === 0 ? (
              <div className="flex flex-col items-center justify-center py-12 text-center">
                <Bell size={32} className="text-gray-500 mb-2 opacity-50" />
                <p className="text-sm text-gray-400">{t('notifications.empty')}</p>
              </div>
            ) : (
              displayedNotifications.map(notification => (
                <NotificationItem
                  key={notification.id}
                  notification={notification}
                  onMarkAsRead={() => {
                    onMarkAsRead(notification.id);
                  }}
                  onDelete={() => onDelete(notification.id)}
                  onClick={() => {
                    onNotificationClick(notification);
                    setIsOpen(false);
                  }}
                />
              ))
            )}
          </div>

          {/* Footer */}
          {notifications.length > 0 && (
            <div className="border-t border-[#8B5E3C]/20 px-4 py-3 bg-black/50 text-center">
              <button className="text-xs text-[#C69C6D] hover:text-white font-bold uppercase tracking-widest transition-all active:scale-95">
                Xem t·∫•t c·∫£ th√¥ng b√°o
              </button>
            </div>
          )}
        </div>
      )}

      {/* Overlay */}
      {isOpen && (
        <div 
          onClick={() => setIsOpen(false)}
          className="fixed inset-0 z-[5099] md:hidden"
        />
      )}
    </div>
  );
}

function NotificationItem({ 
  notification, 
  onMarkAsRead, 
  onDelete, 
  onClick 
}: {
  notification: Notification;
  onMarkAsRead: () => void;
  onDelete: () => void;
  onClick: () => void;
}) {
  const config = NOTIFICATION_CONFIG[notification.type as NotificationType];
  const IconComponent = getIconComponent(notification.type);

  return (
    <div
      onClick={onClick}
      className={`group relative p-3 rounded-lg transition-all cursor-pointer ${
        notification.is_read
          ? 'bg-white/5 hover:bg-white/10'
          : 'bg-[#C69C6D]/10 border border-[#C69C6D]/30 hover:bg-[#C69C6D]/20'
      }`}
    >
      {/* Unread indicator */}
      {!notification.is_read && (
        <div className="absolute top-3 left-3 w-2 h-2 bg-red-500 rounded-full"></div>
      )}

      <div className="flex gap-3 pl-4">
        {/* Avatar or Icon */}
        <div className="flex-shrink-0">
          {notification.from_user_avatar ? (
            <img
              src={notification.from_user_avatar}
              alt={notification.from_user_name}
              className="w-10 h-10 rounded-full object-cover border border-[#C69C6D]/30"
            />
          ) : (
            <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ backgroundColor: `${config.color}20` }}>
              <IconComponent size={18} style={{ color: config.color }} />
            </div>
          )}
        </div>

        {/* Content */}
        <div className="flex-1 min-w-0">
          <div className="flex items-start justify-between gap-2 mb-1">
            <p className="text-sm font-bold text-white truncate">
              {notification.title}
            </p>
            <span className="text-[10px] text-gray-400 flex-shrink-0">
              {formatTime(notification.created_at)}
            </span>
          </div>
          
          <p className="text-xs text-gray-300 line-clamp-2 mb-2">
            {notification.message}
          </p>

          {/* Actions */}
          <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
            {!notification.is_read && (
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onMarkAsRead();
                }}
                className="text-[10px] text-[#C69C6D] hover:text-white font-bold uppercase tracking-wider transition-all active:scale-95 flex items-center gap-1"
              >
                <Check size={12} /> ƒê√£ ƒë·ªçc
              </button>
            )}
            <button
              onClick={(e) => {
                e.stopPropagation();
                onDelete();
              }}
              className="text-[10px] text-gray-400 hover:text-red-400 font-bold uppercase tracking-wider transition-all active:scale-95"
            >
              X√≥a
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function getCategoryLabel(category: string): string {
  const labels: Record<string, string> = {
    'from_users': 'T·ª´ ng∆∞·ªùi d√πng',
    'from_system': 'T·ª´ h·ªá th·ªëng',
    'from_business': 'T·ª´ ƒë∆°n h√†ng',
    'from_events': 'T·ª´ s·ª± ki·ªán',
    'from_content': 'T·ª´ n·ªôi dung',
    'from_security': 'B·∫£o m·∫≠t'
  };
  return labels[category] || category;
}

function getCategoryColor(category: string): string {
  const colors: Record<string, string> = {
    'from_users': '#3B82F6',
    'from_system': '#6366F1',
    'from_business': '#8B5E3C',
    'from_events': '#F59E0B',
    'from_content': '#C69C6D',
    'from_security': '#EF4444'
  };
  return colors[category] || '#C69C6D';
}

function getCategoryIcon(category: string): any {
  const icons: Record<string, any> = {
    'from_users': Users,
    'from_system': Zap,
    'from_business': ShoppingBag,
    'from_events': Calendar,
    'from_content': Award,
    'from_security': AlertCircle
  };
  return icons[category] || Bell;
}

function getIconComponent(type: NotificationType): any {
  const icons: Record<NotificationType, any> = {
    'user_follow': Users,
    'user_comment': MessageCircle,
    'user_like': Heart,
    'user_message': MessageCircle,
    'user_mention': MessageCircle,
    'user_tag': MessageCircle,
    'system_update': Zap,
    'system_announcement': Zap,
    'system_alert': AlertCircle,
    'order_created': ShoppingBag,
    'order_confirmed': CheckCircle2,
    'order_shipped': ShoppingBag,
    'order_delivered': CheckCircle2,
    'payment_received': CheckCircle2,
    'event_new': Calendar,
    'event_reminder': Calendar,
    'workshop_new': Users,
    'workshop_reminder': Bell,
    'achievement_unlocked': Award,
    'milestone_reached': Award,
    'product_new': ShoppingBag,
    'artwork_new': Award,
    'artwork_featured': Award,
    'security_alert': AlertCircle,
    'login_new_device': AlertCircle
  };
  return icons[type] || Bell;
}

function formatTime(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  
  const seconds = Math.floor(diff / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);

  if (seconds < 60) return 'V·ª´a xong';
  if (minutes < 60) return `${minutes}p tr∆∞·ªõc`;
  if (hours < 24) return `${hours}h tr∆∞·ªõc`;
  if (days < 7) return `${days}d tr∆∞·ªõc`;
  
  return date.toLocaleDateString('vi-VN');
}
</file>

<file path="GiaoDienTong/MenuTren/NotificationService.ts">
import { Notification, NotificationType } from "./NotificationTypes";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { RealtimeChannel } from "@supabase/supabase-js";

export class NotificationService {
  // ... (Gi·ªØ nguy√™n c√°c h√†m getUserNotifications, getUnreadCount, create, markRead, delete...)

  static async getUserNotifications(
    userId: string,
    limit = 50
  ): Promise<Notification[]> {
    try {
      const { data, error } = await supabase
        .from("notifications")
        .select("*")
        .eq("user_id", userId)
        .order("created_at", { ascending: false })
        .limit(limit);

      if (error) throw error;
      return (data as Notification[]) || [];
    } catch (error) {
      console.error("Error fetching notifications:", error);
      return [];
    }
  }

  static async getUnreadCount(userId: string): Promise<number> {
    try {
      const { count, error } = await supabase
        .from("notifications")
        .select("*", { count: "exact", head: true })
        .eq("user_id", userId)
        .eq("is_read", false);

      if (error) throw error;
      return count || 0;
    } catch (error) {
      console.error("Error fetching unread count:", error);
      return 0;
    }
  }

  static async markAsRead(notificationId: string) {
    try {
      const { error } = await supabase
        .from("notifications")
        .update({ is_read: true, updated_at: new Date().toISOString() })
        .eq("id", notificationId);
      if (error) throw error;
      return true;
    } catch (error) {
      console.error("Error marking notification as read:", error);
      return false;
    }
  }

  static async markAllAsRead(userId: string) {
    try {
      const { error } = await supabase
        .from("notifications")
        .update({ is_read: true, updated_at: new Date().toISOString() })
        .eq("user_id", userId)
        .eq("is_read", false);
      if (error) throw error;
      return true;
    } catch (error) {
      console.error("Error marking all notifications as read:", error);
      return false;
    }
  }

  static async deleteNotification(notificationId: string) {
    try {
      const { error } = await supabase
        .from("notifications")
        .delete()
        .eq("id", notificationId);
      if (error) throw error;
      return true;
    } catch (error) {
      console.error("Error deleting notification:", error);
      return false;
    }
  }

  // üü¢ S·ª¨A L·∫†I H√ÄM SUBSCRIBE CHO AN TO√ÄN
  static subscribeToNotifications(
    userId: string,
    callback: (notification: Notification) => void
  ) {
    // T·∫°o channel v·ªõi ID duy nh·∫•t ƒë·ªÉ tr√°nh tr√πng l·∫∑p
    const channelId = `notifications:${userId}:${Date.now()}`;

    const channel = supabase
      .channel(channelId)
      .on(
        "postgres_changes",
        {
          event: "INSERT",
          schema: "public",
          table: "notifications",
          filter: `user_id=eq.${userId}`,
        },
        (payload) => {
          // Validate d·ªØ li·ªáu tr∆∞·ªõc khi callback
          if (payload.new && payload.new.id) {
            callback(payload.new as Notification);
          }
        }
      )
      .subscribe((status) => {
        if (status === "SUBSCRIBED") {
          console.log(`üîî ƒê√£ k·∫øt n·ªëi th√¥ng b√°o cho user ${userId}`);
        }
      });

    // Tr·∫£ v·ªÅ object ch·ª©a h√†m unsubscribe an to√†n
    return {
      unsubscribe: () => {
        console.log(`üîï H·ªßy k·∫øt n·ªëi th√¥ng b√°o ${channelId}`);
        supabase.removeChannel(channel);
      },
    };
  }
}
</file>

<file path="GiaoDienTong/MenuTren/NotificationTypes.ts">
// Lo·∫°i th√¥ng b√°o t·ª´ c√°c ngu·ªìn kh√°c nhau
export type NotificationType = 
  // T·ª´ NG∆Ø·ªúI D√ôNG KH√ÅC
  | 'user_follow' 
  | 'user_comment' 
  | 'user_like' 
  | 'user_message' 
  | 'user_mention'
  | 'user_tag'
  // T·ª´ H·ªÜ TH·ªêNG
  | 'system_update'
  | 'system_announcement'
  | 'system_alert'
  // T·ª´ HO·∫†T ƒê·ªòNG KINH DOANH
  | 'order_created'
  | 'order_confirmed'
  | 'order_shipped'
  | 'order_delivered'
  | 'payment_received'
  // T·ª´ S·ª∞ KI·ªÜN & WORKSHOP
  | 'event_new'
  | 'event_reminder'
  | 'workshop_new'
  | 'workshop_reminder'
  // T·ª´ T∆Ø·ªöNG C√îNG
  | 'achievement_unlocked'
  | 'milestone_reached'
  // T·ª´ N·ªòI DUNG
  | 'product_new'
  | 'artwork_new'
  | 'artwork_featured'
  // B·∫£o m·∫≠t
  | 'security_alert'
  | 'login_new_device';

export type NotificationCategory = 
  | 'from_users'      // T·ª´ ng∆∞·ªùi kh√°c
  | 'from_system'     // T·ª´ h·ªá th·ªëng
  | 'from_business'   // T·ª´ ho·∫°t ƒë·ªông kinh doanh
  | 'from_events'     // T·ª´ s·ª± ki·ªán
  | 'from_content'    // T·ª´ n·ªôi dung m·ªõi
  | 'from_security';  // T·ª´ b·∫£o m·∫≠t

export interface Notification {
  id: string;
  user_id: string;
  type: NotificationType;
  category: NotificationCategory;
  
  // Th√¥ng tin ch√≠nh
  title: string;
  message: string;
  icon?: string;
  avatar?: string;
  
  // Ng∆∞·ªùi g·ª≠i (n·∫øu t·ª´ ng∆∞·ªùi d√πng kh√°c)
  from_user_id?: string;
  from_user_name?: string;
  from_user_avatar?: string;
  
  // Li√™n k·∫øt
  related_id?: string;        // ID c·ªßa object li√™n quan (product_id, order_id, etc)
  action_url?: string;        // URL ƒë·ªÉ navigate
  
  // Tr·∫°ng th√°i
  is_read: boolean;
  created_at: string;
  updated_at: string;
  
  // H√†nh ƒë·ªông
  action_label?: string;
  action_type?: 'confirm' | 'view' | 'dismiss';
}

export interface NotificationGroup {
  category: NotificationCategory;
  label: string;
  notifications: Notification[];
  unread_count: number;
  icon: any;
  color: string;
}

export const NOTIFICATION_CONFIG: Record<NotificationType, {
  category: NotificationCategory;
  label: string;
  icon: string;
  color: string;
  priority: number;
  description: (data?: any) => string;
}> = {
  // T·ª´ NG∆Ø·ªúI D√ôNG
  'user_follow': {
    category: 'from_users',
    label: 'Theo d√µi m·ªõi',
    icon: 'UserPlus',
    color: '#3B82F6',
    priority: 5,
    description: (data) => `${data?.from_user_name} ƒë√£ theo d√µi b·∫°n`
  },
  'user_comment': {
    category: 'from_users',
    label: 'B√¨nh lu·∫≠n m·ªõi',
    icon: 'MessageCircle',
    color: '#8B5E3C',
    priority: 4,
    description: (data) => `${data?.from_user_name} ƒë√£ b√¨nh lu·∫≠n: "${data?.message}"`
  },
  'user_like': {
    category: 'from_users',
    label: 'Y√™u th√≠ch',
    icon: 'Heart',
    color: '#EF4444',
    priority: 3,
    description: (data) => `${data?.from_user_name} y√™u th√≠ch t√°c ph·∫©m c·ªßa b·∫°n`
  },
  'user_message': {
    category: 'from_users',
    label: 'Tin nh·∫Øn m·ªõi',
    icon: 'Mail',
    color: '#10B981',
    priority: 6,
    description: (data) => `Tin nh·∫Øn t·ª´ ${data?.from_user_name}: "${data?.message}"`
  },
  'user_mention': {
    category: 'from_users',
    label: 'ƒê∆∞·ª£c ƒë·ªÅ c·∫≠p',
    icon: 'AtSign',
    color: '#C69C6D',
    priority: 4,
    description: (data) => `${data?.from_user_name} ƒë√£ ƒë·ªÅ c·∫≠p ƒë·∫øn b·∫°n`
  },
  'user_tag': {
    category: 'from_users',
    label: 'ƒê∆∞·ª£c g·∫Øn th·∫ª',
    icon: 'Tag',
    color: '#8B5E3C',
    priority: 4,
    description: (data) => `${data?.from_user_name} ƒë√£ g·∫Øn th·∫ª b·∫°n`
  },

  // T·ª´ H·ªÜ TH·ªêNG
  'system_update': {
    category: 'from_system',
    label: 'C·∫≠p nh·∫≠t h·ªá th·ªëng',
    icon: 'RefreshCw',
    color: '#6366F1',
    priority: 2,
    description: (data) => 'H·ªá th·ªëng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v·ªõi c√°c t√≠nh nƒÉng m·ªõi'
  },
  'system_announcement': {
    category: 'from_system',
    label: 'Th√¥ng b√°o chung',
    icon: 'Megaphone',
    color: '#F59E0B',
    priority: 3,
    description: (data) => data?.message || 'C√≥ th√¥ng b√°o chung m·ªõi t·ª´ h·ªá th·ªëng'
  },
  'system_alert': {
    category: 'from_system',
    label: 'C·∫£nh b√°o h·ªá th·ªëng',
    icon: 'AlertCircle',
    color: '#EF4444',
    priority: 5,
    description: (data) => data?.message || 'C·∫£nh b√°o t·ª´ h·ªá th·ªëng'
  },

  // T·ª´ HO·∫†T ƒê·ªòNG KINH DOANH
  'order_created': {
    category: 'from_business',
    label: 'ƒê∆°n h√†ng m·ªõi',
    icon: 'ShoppingBag',
    color: '#8B5E3C',
    priority: 4,
    description: (data) => `ƒê∆°n h√†ng #${data?.related_id} c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c t·∫°o`
  },
  'order_confirmed': {
    category: 'from_business',
    label: 'ƒê∆°n h√†ng x√°c nh·∫≠n',
    icon: 'CheckCircle',
    color: '#10B981',
    priority: 3,
    description: (data) => `ƒê∆°n h√†ng #${data?.related_id} ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n`
  },
  'order_shipped': {
    category: 'from_business',
    label: 'ƒê∆°n h√†ng ƒë√£ g·ª≠i',
    icon: 'Truck',
    color: '#3B82F6',
    priority: 3,
    description: (data) => `ƒê∆°n h√†ng #${data?.related_id} ƒëang tr√™n ƒë∆∞·ªùng t·ªõi`
  },
  'order_delivered': {
    category: 'from_business',
    label: 'ƒê∆°n h√†ng ƒë√£ giao',
    icon: 'Package',
    color: '#10B981',
    priority: 3,
    description: (data) => `ƒê∆°n h√†ng #${data?.related_id} ƒë√£ ƒë∆∞·ª£c giao th√†nh c√¥ng`
  },
  'payment_received': {
    category: 'from_business',
    label: 'Thanh to√°n nh·∫≠n ƒë∆∞·ª£c',
    icon: 'CreditCard',
    color: '#10B981',
    priority: 4,
    description: (data) => `Thanh to√°n ${data?.message} ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n`
  },

  // T·ª´ S·ª∞ KI·ªÜN & WORKSHOP
  'event_new': {
    category: 'from_events',
    label: 'S·ª± ki·ªán m·ªõi',
    icon: 'Calendar',
    color: '#8B5E3C',
    priority: 2,
    description: (data) => `S·ª± ki·ªán m·ªõi: ${data?.message}`
  },
  'event_reminder': {
    category: 'from_events',
    label: 'Nh·∫Øc nh·ªü s·ª± ki·ªán',
    icon: 'Clock',
    color: '#F59E0B',
    priority: 4,
    description: (data) => `S·ª± ki·ªán s·∫Øp di·ªÖn ra: ${data?.message}`
  },
  'workshop_new': {
    category: 'from_events',
    label: 'Workshop m·ªõi',
    icon: 'Users',
    color: '#8B5E3C',
    priority: 2,
    description: (data) => `Workshop m·ªõi: ${data?.message}`
  },
  'workshop_reminder': {
    category: 'from_events',
    label: 'Nh·∫Øc nh·ªü workshop',
    icon: 'Bell',
    color: '#F59E0B',
    priority: 4,
    description: (data) => `Workshop s·∫Øp b·∫Øt ƒë·∫ßu: ${data?.message}`
  },

  // T·ª´ ƒê·∫†T C√îNG
  'achievement_unlocked': {
    category: 'from_content',
    label: 'Th√†nh t·ª±u m·ªü kh√≥a',
    icon: 'Award',
    color: '#FBBF24',
    priority: 3,
    description: (data) => `B·∫°n ƒë√£ m·ªü kh√≥a th√†nh t·ª±u: ${data?.message}`
  },
  'milestone_reached': {
    category: 'from_content',
    label: 'C·ªôt m·ªëc ƒë·∫°t ƒë∆∞·ª£c',
    icon: 'Target',
    color: '#FBBF24',
    priority: 3,
    description: (data) => `Ch√∫c m·ª´ng! B·∫°n ƒë√£ ƒë·∫°t ${data?.message}`
  },

  // T·ª´ N·ªòI DUNG
  'product_new': {
    category: 'from_content',
    label: 'S·∫£n ph·∫©m m·ªõi',
    icon: 'Package',
    color: '#8B5E3C',
    priority: 1,
    description: (data) => `T√°c ph·∫©m m·ªõi: ${data?.message}`
  },
  'artwork_new': {
    category: 'from_content',
    label: 'T√°c ph·∫©m m·ªõi',
    icon: 'Image',
    color: '#8B5E3C',
    priority: 1,
    description: (data) => `T√°c ph·∫©m m·ªõi ƒë√£ ƒë∆∞·ª£c th√™m: ${data?.message}`
  },
  'artwork_featured': {
    category: 'from_content',
    label: 'T√°c ph·∫©m n·ªïi b·∫≠t',
    icon: 'Star',
    color: '#FBBF24',
    priority: 2,
    description: (data) => `T√°c ph·∫©m ${data?.message} ƒë√£ ƒë∆∞·ª£c n·ªïi b·∫≠t`
  },

  // B·∫¢O M·∫¨T
  'security_alert': {
    category: 'from_security',
    label: 'C·∫£nh b√°o b·∫£o m·∫≠t',
    icon: 'Shield',
    color: '#EF4444',
    priority: 6,
    description: (data) => data?.message || 'C√≥ ho·∫°t ƒë·ªông b·∫•t th∆∞·ªùng tr√™n t√†i kho·∫£n'
  },
  'login_new_device': {
    category: 'from_security',
    label: 'ƒêƒÉng nh·∫≠p thi·∫øt b·ªã m·ªõi',
    icon: 'Smartphone',
    color: '#F59E0B',
    priority: 5,
    description: (data) => `ƒêƒÉng nh·∫≠p t·ª´ thi·∫øt b·ªã m·ªõi: ${data?.message}`
  }
};
</file>

<file path="GiaoDienTong/MenuTren/NutCaNhan/ChucNang.ts">
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { LoggerService } from "@/app/ThuVien/LoggerService";

const logger = LoggerService.createScoped("xuLyDangXuat");

export const xuLyDangXuat = async () => {
  try {
    logger.info("üö™ B·∫Øt ƒë·∫ßu qu√° tr√¨nh ƒëƒÉng xu·∫•t...");

    // 1. X√ìA TH·ª¶ C√îNG TO√ÄN B·ªò LOCALSTORAGE
    if (typeof window !== "undefined") {
      // X√≥a c√°c key c·ªßa App
      localStorage.removeItem("USER_INFO");
      localStorage.removeItem("USER_ROLE");
      localStorage.removeItem("user_role");
      localStorage.removeItem("LA_ADMIN_CUNG");
      localStorage.removeItem("SAVED_EMAIL");

      // QUAN TR·ªåNG: X√≥a token c·ªßa Supabase (th∆∞·ªùng c√≥ d·∫°ng sb-xxxx-auth-token)
      Object.keys(localStorage).forEach((key) => {
        if (key.startsWith("sb-") || key.includes("supabase")) {
          localStorage.removeItem(key);
        }
      });

      // X√≥a sessionStorage
      sessionStorage.clear();
    }

    // 2. X√ìA COOKIE TH·ª¶ C√îNG (ƒê·ªÉ Middleware kh√¥ng b·∫Øt l·∫°i ƒë∆∞·ª£c)
    document.cookie.split(";").forEach((c) => {
      document.cookie = c
        .replace(/^ +/, "")
        .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
    });

    // 3. G·ªåI SUPABASE SIGN OUT (Cho ch·∫Øc ƒÉn ph√≠a server)
    try {
      await supabase.auth.signOut({ scope: "global" });
    } catch (err) {
      console.warn("Supabase signOut warning:", err);
    }

    logger.info("‚úÖ ƒê√£ d·ªçn d·∫πp s·∫°ch s·∫Ω session");

    // 4. FORCE REDIRECT V·ªÄ TRANG CH·ª¶ V·ªöI PARAM ƒê·∫∂C BI·ªÜT
    // Th√™m timestamp ƒë·ªÉ tr√¨nh duy·ªát kh√¥ng cache
    // Param ?logout=success b√°o hi·ªáu cho trang ch·ªß bi·∫øt "Tao v·ª´a logout ƒë·∫•y, ƒë·ª´ng c√≥ auto-login l·∫°i"
    window.location.href = `/?logout=success&t=${Date.now()}`;
  } catch (error) {
    logger.error("‚ùå L·ªói ƒëƒÉng xu·∫•t nghi√™m tr·ªçng", error);
    // Fallback cu·ªëi c√πng: Force reload trang g·ªëc
    window.location.href = `/?logout=force&t=${Date.now()}`;
  }
};
</file>

<file path="GiaoDienTong/MenuTren/NutCaNhan/GiaoDienChiTiet.tsx">
'use client';
import React from 'react';
import { User, LogOut, Mail, Hash, KeyRound, Smartphone } from 'lucide-react';
import { xuLyDangXuat } from './ChucNang';

interface Props {
    nguoiDung: any;
}

export default function GiaoDienChiTiet({ nguoiDung }: Props) {
    // Chu·∫©n h√≥a d·ªØ li·ªáu
    const hoTen = nguoiDung?.ho_ten || 'Kh√°ch v√£ng lai';
    const viTri = nguoiDung?.vi_tri || 'Ch∆∞a x√°c ƒë·ªãnh';
    const email = nguoiDung?.email || 'Ch∆∞a c·∫≠p nh·∫≠t';
    const role = nguoiDung?.role || 'khach';
    const avatar = nguoiDung?.avatar_url;
    const userId = nguoiDung?.id || 'N/A';

    return (
        <div className="max-w-md mx-auto w-full space-y-6 pt-4 pb-6">
            
            {/* 1. CARD AVATAR & INFO CH√çNH */}
            <div className="relative group">
                {/* Glow Effect */}
                <div className="absolute -inset-0.5 bg-gradient-to-br from-[#8B5E3C] to-[#C69C6D] rounded-2xl blur opacity-20 group-hover:opacity-40 transition duration-700"></div>
                
                <div className="relative bg-[#1a120f] border border-[#8B5E3C]/40 rounded-2xl p-6 flex flex-col items-center shadow-2xl overflow-hidden">
                    {/* Background Pattern */}
                    <div className="absolute inset-0 opacity-5 bg-[repeating-linear-gradient(45deg,transparent,transparent_5px,#C69C6D_5px,#C69C6D_6px)]"></div>
                    
                    {/* Avatar */}
                    <div className="w-28 h-28 md:w-32 md:h-32 rounded-full border-2 border-[#C69C6D] p-1 mb-4 relative z-10 shadow-[0_0_30px_rgba(198,156,109,0.2)] bg-[#110d0c]">
                        {avatar ? (
                            <img src={avatar} alt="Avt" className="w-full h-full rounded-full object-cover" />
                        ) : (
                            <div className="w-full h-full rounded-full bg-[#2a1e1b] flex items-center justify-center text-[#C69C6D]">
                                <User className="w-14 h-14" strokeWidth={1.5} />
                            </div>
                        )}
                        {/* Role Badge */}
                        <div className="absolute -bottom-2 -right-2 bg-[#C69C6D] text-[#1a120f] text-[10px] font-black px-2 py-1 rounded-md border border-[#1a120f] uppercase shadow-lg tracking-wider">
                            {role}
                        </div>
                    </div>

                    {/* Name & Title */}
                    <h3 className="text-xl md:text-2xl font-bold text-[#F5E6D3] uppercase tracking-wide relative z-10 text-center">{hoTen}</h3>
                    <p className="text-xs text-[#8B5E3C] font-bold uppercase tracking-[0.2em] mt-1 relative z-10 opacity-80">{viTri}</p>
                </div>
            </div>

            {/* 2. CARD CHI TI·∫æT */}
            <div className="space-y-3">
                <div className="bg-[#1a120f] border border-[#8B5E3C]/20 rounded-xl p-4 flex items-start gap-4 hover:border-[#C69C6D]/50 transition-colors">
                    <div className="p-2 bg-[#C69C6D]/10 rounded-full text-[#C69C6D] shrink-0 mt-1">
                        <Hash size={18} />
                    </div>
                    <div className="flex-1 min-w-0">
                        <p className="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">M√£ ƒê·ªãnh Danh (ID)</p>
                        <p className="text-sm text-gray-300 font-mono break-all leading-tight select-all">{userId}</p>
                    </div>
                </div>

                <div className="bg-[#1a120f] border border-[#8B5E3C]/20 rounded-xl p-4 flex items-start gap-4 hover:border-[#C69C6D]/50 transition-colors">
                    <div className="p-2 bg-[#C69C6D]/10 rounded-full text-[#C69C6D] shrink-0 mt-1">
                        <Mail size={18} />
                    </div>
                    <div className="flex-1 min-w-0">
                        <p className="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Email X√°c Th·ª±c</p>
                        <p className="text-sm text-gray-300 font-sans break-words leading-tight">{email}</p>
                    </div>
                </div>
            </div>

            {/* 3. QUICK ACTIONS GRID */}
            <div className="grid grid-cols-2 gap-3">
                <button className="flex flex-col items-center justify-center gap-2 bg-[#1a120f] border border-[#8B5E3C]/20 hover:bg-[#C69C6D]/10 hover:border-[#C69C6D] p-4 rounded-xl transition-all group">
                    <KeyRound size={20} className="text-[#8B5E3C] group-hover:text-[#C69C6D]"/>
                    <span className="text-[10px] uppercase font-bold text-gray-400 group-hover:text-[#F5E6D3]">ƒê·ªïi M·∫≠t Kh·∫©u</span>
                </button>
                <button className="flex flex-col items-center justify-center gap-2 bg-[#1a120f] border border-[#8B5E3C]/20 hover:bg-[#C69C6D]/10 hover:border-[#C69C6D] p-4 rounded-xl transition-all group">
                    <Smartphone size={20} className="text-[#8B5E3C] group-hover:text-[#C69C6D]"/>
                    <span className="text-[10px] uppercase font-bold text-gray-400 group-hover:text-[#F5E6D3]">Thi·∫øt B·ªã</span>
                </button>
            </div>

            {/* 4. LOGOUT BUTTON */}
            <button 
                onClick={xuLyDangXuat} 
                className="w-full flex items-center justify-center gap-2 text-red-400 hover:text-white text-sm font-bold uppercase tracking-[0.15em] px-6 py-4 border border-red-900/50 bg-red-950/20 hover:bg-red-600 rounded-xl transition-all shadow-lg active:scale-95 group mt-4"
            >
                <LogOut size={18} className="group-hover:-translate-x-1 transition-transform" />
                ƒêƒÉng Xu·∫•t H·ªá Th·ªëng
            </button>

            <div className="text-center">
                <p className="text-[9px] text-[#5D4037] font-mono">Phi√™n b·∫£n h·ªá th·ªëng: 2.5.0 (Beta)</p>
            </div>
        </div>
    );
}
</file>

<file path="GiaoDienTong/MenuTren/NutCaNhan/ModalProfile.tsx">
'use client';
import React, { useState, useEffect, ReactNode } from 'react';
import { 
  X, User, Package, Phone, Mail, MapPin, CreditCard, 
  ChevronRight, LogOut, ChevronLeft, Settings, Trophy,
  Globe, Moon, Sun, Palette, Check
} from 'lucide-react';
import { OrderService, Order } from '@/app/ThuVien/OrderService';
import { Z_INDEX } from '@/app/constants/zIndex';
import { LoggerService } from '@/app/ThuVien/LoggerService';
import { xuLyDangXuat } from './ChucNang';
import { useAppSettings, ThemeMode, LanguageCode } from '@/app/ThuVien/AppSettingsContext';

// Inline ConfirmDialog component
interface ConfirmDialogProps {
  isOpen: boolean;
  title: string;
  message: string;
  icon?: ReactNode;
  confirmText?: string;
  cancelText?: string;
  isDangerous?: boolean;
  isLoading?: boolean;
  onConfirm: () => void;
  onCancel: () => void;
}

function ConfirmDialog({
  isOpen,
  title,
  message,
  icon,
  confirmText = 'X√°c nh·∫≠n',
  cancelText = 'H·ªßy',
  isDangerous = false,
  isLoading = false,
  onConfirm,
  onCancel
}: ConfirmDialogProps) {
  if (!isOpen) return null;
  
  return (
    <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm">
      <div className="bg-[#1a1a1a] border border-white/10 rounded-xl p-6 max-w-sm w-full mx-4 shadow-2xl">
        <div className="flex items-center gap-3 mb-4">
          {icon && <div>{icon}</div>}
          <h3 className="text-lg font-semibold text-white">{title}</h3>
        </div>
        <p className="text-white/70 mb-6">{message}</p>
        <div className="flex gap-3 justify-end">
          <button
            onClick={onCancel}
            disabled={isLoading}
            className="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 disabled:opacity-50"
          >
            {cancelText}
          </button>
          <button
            onClick={onConfirm}
            disabled={isLoading}
            className={`px-4 py-2 rounded-lg text-white ${
              isDangerous ? 'bg-red-600 hover:bg-red-700' : 'bg-[#C69C6D] hover:bg-[#C69C6D]/80'
            } disabled:opacity-50`}
          >
            {isLoading ? 'ƒêang x·ª≠ l√Ω...' : confirmText}
          </button>
        </div>
      </div>
    </div>
  );
}

interface ModalProfileProps {
  isOpen: boolean;
  onClose: () => void;
  nguoiDung: any;
}

// C√°c m√†n h√¨nh
type ScreenType = 
  | 'main'           // M√†n ch√≠nh: C√†i ƒê·∫∑t, H·ªì S∆° C·ªßa T√¥i
  | 'caidat'         // C√†i ƒê·∫∑t: Ng√¥n Ng·ªØ, Giao Di·ªán
  | 'hosocuatoi'     // H·ªì S∆°: Th√¥ng Tin, Th√†nh T√≠ch/ƒê∆°n H√†ng
  | 'thongtincanhan' // Chi ti·∫øt th√¥ng tin c√° nh√¢n
  | 'thanhtich'      // Th√†nh t√≠ch (nhan_su)
  | 'donhang'        // ƒê∆°n h√†ng (khach_hang)
  | 'ngonngu'        // Ch·ªçn ng√¥n ng·ªØ
  | 'giaodien';      // Ch·ªçn giao di·ªán

export default function ModalProfile({ isOpen, onClose, nguoiDung }: ModalProfileProps) {
  const [currentScreen, setCurrentScreen] = useState<ScreenType>('main');
  const [orders, setOrders] = useState<Order[]>([]);
  const [isLoadingOrders, setIsLoadingOrders] = useState(false);
  const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);
  const [isLoggingOut, setIsLoggingOut] = useState(false);
  
  // üåê Hook settings cho theme + language
  const { t, language } = useAppSettings();
  
  // X√°c ƒë·ªãnh lo·∫°i user
  const isNhanSu = nguoiDung?.userType === 'nhan_su' || nguoiDung?.vi_tri;
  const isKhachHang = nguoiDung?.userType === 'khach_hang' || nguoiDung?.phan_loai;

  // Reset v·ªÅ m√†n ch√≠nh khi m·ªü l·∫°i
  useEffect(() => {
    if (isOpen) {
      setCurrentScreen('main');
    }
  }, [isOpen]);

  // Load orders khi v√†o m√†n ƒë∆°n h√†ng
  useEffect(() => {
    if (isOpen && currentScreen === 'donhang') {
      loadOrders();
    }
  }, [isOpen, currentScreen]);

  // ‚úÖ ESC KEY HANDLING - Close modal on ESC press
  useEffect(() => {
    if (!isOpen) return;

    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        e.preventDefault();
        onClose();
      }
    };

    window.addEventListener('keydown', handleEscape);
    return () => window.removeEventListener('keydown', handleEscape);
  }, [isOpen, onClose]);

  const loadOrders = async () => {
    setIsLoadingOrders(true);
    try {
      const { orders: data } = await OrderService.getMyOrders(20);
      setOrders(data);
    } catch (error) {
      LoggerService.error('ModalProfile', 'Error loading orders', error);
    } finally {
      setIsLoadingOrders(false);
    }
  };

  const handleLogoutConfirm = async () => {
    setIsLoggingOut(true);
    try {
      await xuLyDangXuat();
    } catch (error) {
      LoggerService.error('ModalProfile', 'Logout error', error);
      setIsLoggingOut(false);
      setShowLogoutConfirm(false);
    }
  };

  // X·ª≠ l√Ω n√∫t back - quay v·ªÅ m√†n cha
  const handleBack = () => {
    switch (currentScreen) {
      case 'ngonngu':
      case 'giaodien':
        setCurrentScreen('caidat');
        break;
      case 'thongtincanhan':
      case 'thanhtich':
      case 'donhang':
        setCurrentScreen('hosocuatoi');
        break;
      default:
        setCurrentScreen('main');
    }
  };

  // L·∫•y ti√™u ƒë·ªÅ m√†n h√¨nh
  const getScreenTitle = () => {
    switch (currentScreen) {
      case 'caidat': return t('profile.settings');
      case 'hosocuatoi': return t('profile.myProfile');
      case 'thongtincanhan': return t('profile.personalInfo');
      case 'thanhtich': return t('profile.achievements');
      case 'donhang': return t('profile.orders');
      case 'ngonngu': return t('settings.language');
      case 'giaodien': return t('settings.theme');
      default: return t('profile.title');
    }
  };

  if (!isOpen) return null;

  // =====================================================
  // M√ÄN H√åNH CON (kh√¥ng ph·∫£i main)
  // =====================================================
  if (currentScreen !== 'main') {
    return (
      <div className="fixed inset-0 flex items-center justify-center sm:items-start sm:justify-end" style={{ zIndex: Z_INDEX.modal }}>
        <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose} />
        <div className="relative w-full h-full sm:h-screen sm:max-w-md bg-gradient-to-br from-[#0A0A0A] to-[#1A1A1A] border-l border-white/20 shadow-2xl flex flex-col overflow-hidden">
          
          {/* Header m√†n con */}
          <div className="flex-shrink-0 px-4 py-4 border-b border-white/10 bg-black/40 backdrop-blur-md">
            <div className="flex items-center gap-3">
              <button onClick={handleBack} className="p-2 hover:bg-white/10 rounded-lg transition-colors">
                <ChevronLeft size={24} className="text-white" />
              </button>
              <h2 className="text-lg font-bold text-white">{getScreenTitle()}</h2>
            </div>
          </div>

          {/* Content m√†n con */}
          <div className="flex-1 overflow-y-auto p-4">
            {currentScreen === 'caidat' && (
              <ScreenCaiDat 
                onGoToNgonNgu={() => setCurrentScreen('ngonngu')}
                onGoToGiaoDien={() => setCurrentScreen('giaodien')}
              />
            )}
            {currentScreen === 'hosocuatoi' && (
              <ScreenHoSoCuaToi 
                isNhanSu={isNhanSu}
                isKhachHang={isKhachHang}
                onGoToThongTin={() => setCurrentScreen('thongtincanhan')}
                onGoToThanhTich={() => setCurrentScreen('thanhtich')}
                onGoToDonHang={() => setCurrentScreen('donhang')}
              />
            )}
            {currentScreen === 'thongtincanhan' && <ScreenThongTinCaNhan nguoiDung={nguoiDung} />}
            {currentScreen === 'thanhtich' && <ScreenThanhTich nguoiDung={nguoiDung} />}
            {currentScreen === 'donhang' && <ScreenDonHang orders={orders} isLoading={isLoadingOrders} onReload={loadOrders} />}
            {currentScreen === 'ngonngu' && <ScreenNgonNgu />}
            {currentScreen === 'giaodien' && <ScreenGiaoDien />}
          </div>
        </div>
      </div>
    );
  }

  // =====================================================
  // M√ÄN H√åNH CH√çNH
  // =====================================================
  return (
    <div className="fixed inset-0 flex items-center justify-center sm:items-start sm:justify-end" style={{ zIndex: Z_INDEX.modal }}>
      <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose} />

      <div className="relative w-full h-full sm:h-screen sm:max-w-md bg-gradient-to-br from-[#0A0A0A] to-[#1A1A1A] border-l border-white/20 shadow-2xl flex flex-col overflow-hidden">
        
        {/* Header - Avatar & T√™n */}
        <div className="flex-shrink-0 px-6 py-6 border-b border-white/10 bg-black/40 backdrop-blur-md">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-4">
              <div className="w-14 h-14 rounded-full bg-gradient-to-br from-[#C69C6D] to-[#F2D3A0] flex items-center justify-center text-black font-bold text-xl">
                {nguoiDung?.ho_ten?.[0]?.toUpperCase() || nguoiDung?.email?.[0]?.toUpperCase() || 'U'}
              </div>
              <div>
                <h2 className="text-lg font-bold text-white">
                  {nguoiDung?.ho_ten || (language === 'vi' ? 'Ng∆∞·ªùi d√πng' : 'User')}
                </h2>
                <p className="text-white/60 text-sm">{nguoiDung?.email}</p>
              </div>
            </div>
            <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-lg transition-colors text-white/60 hover:text-white">
              <X size={24} />
            </button>
          </div>

          {/* N√∫t ƒêƒÉng xu·∫•t */}
          <button
            onClick={() => setShowLogoutConfirm(true)}
            disabled={isLoggingOut}
            className="flex items-center gap-2 px-4 py-2.5 bg-white/5 border border-white/10 text-white rounded-lg font-medium text-sm transition-all hover:bg-white/10"
          >
            <LogOut size={18} />
            <span>{isLoggingOut ? t('auth.loggingOut') : t('auth.logout')}</span>
          </button>
        </div>

        {/* Content - 2 m·ª•c ch√≠nh */}
        <div className="flex-1 overflow-y-auto p-4 space-y-4">
          
          {/* KH·ªêI MENU CH√çNH */}
          <div className="bg-white/5 border border-white/10 rounded-2xl overflow-hidden">
            <KhoiMenuChon 
              icon={<Settings size={20} className="text-[#C69C6D]" />}
              label={t('profile.settings')}
              subtitle={t('profile.settingsDesc')}
              onClick={() => setCurrentScreen('caidat')}
            />
            <KhoiMenuChon 
              icon={<User size={20} className="text-[#C69C6D]" />}
              label={t('profile.myProfile')}
              subtitle={isNhanSu ? t('profile.myProfileDescStaff') : t('profile.myProfileDescCustomer')}
              onClick={() => setCurrentScreen('hosocuatoi')}
              isLast
            />
          </div>

        </div>
      </div>

      {/* Logout Confirmation Dialog */}
      <ConfirmDialog
        isOpen={showLogoutConfirm}
        title={t('auth.logout')}
        message={t('auth.logoutConfirm')}
        icon={<LogOut className="text-[#C69C6D]" size={24} />}
        confirmText={t('auth.logout')}
        cancelText={t('app.cancel')}
        isDangerous={false}
        isLoading={isLoggingOut}
        onConfirm={handleLogoutConfirm}
        onCancel={() => !isLoggingOut && setShowLogoutConfirm(false)}
      />
    </div>
  );
}

// =====================================================
// COMPONENT: KH·ªêI MENU CH·ªåN
// =====================================================
function KhoiMenuChon({ 
  icon, 
  label, 
  subtitle,
  onClick, 
  isLast = false 
}: { 
  icon: ReactNode; 
  label: string; 
  subtitle?: string;
  onClick?: () => void; 
  isLast?: boolean;
}) {
  return (
    <button 
      onClick={onClick}
      className={`w-full px-4 py-4 flex items-center gap-3 hover:bg-white/5 transition-colors ${!isLast ? 'border-b border-white/5' : ''}`}
    >
      <div className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center">
        {icon}
      </div>
      <div className="flex-1 text-left">
        <p className="text-white font-medium">{label}</p>
        {subtitle && <p className="text-white/50 text-sm">{subtitle}</p>}
      </div>
      {onClick && <ChevronRight size={20} className="text-white/30" />}
    </button>
  );
}

// =====================================================
// M√ÄN H√åNH: C√ÄI ƒê·∫∂T
// =====================================================
function ScreenCaiDat({ 
  onGoToNgonNgu, 
  onGoToGiaoDien 
}: { 
  onGoToNgonNgu: () => void;
  onGoToGiaoDien: () => void;
}) {
  const { language, theme, t } = useAppSettings();
  
  const languageDisplay = language === 'vi' ? 'Ti·∫øng Vi·ªát' : 'English';
  const themeDisplay = theme === 'dark' 
    ? (language === 'vi' ? 'T·ªëi' : 'Dark')
    : (language === 'vi' ? 'S√°ng' : 'Light');

  return (
    <div className="space-y-4">
      <div className="bg-[var(--bg-card)] border border-[var(--border-color)] rounded-2xl overflow-hidden">
        <KhoiMenuChon 
          icon={<Globe size={20} className="text-blue-400" />}
          label={t('settings.language')}
          subtitle={languageDisplay}
          onClick={onGoToNgonNgu}
        />
        <KhoiMenuChon 
          icon={<Palette size={20} className="text-purple-400" />}
          label={t('settings.theme')}
          subtitle={themeDisplay}
          onClick={onGoToGiaoDien}
          isLast
        />
      </div>
    </div>
  );
}

// =====================================================
// M√ÄN H√åNH: H·ªí S∆† C·ª¶A T√îI
// =====================================================
function ScreenHoSoCuaToi({ 
  isNhanSu,
  isKhachHang,
  onGoToThongTin, 
  onGoToThanhTich,
  onGoToDonHang
}: { 
  isNhanSu: boolean;
  isKhachHang: boolean;
  onGoToThongTin: () => void;
  onGoToThanhTich: () => void;
  onGoToDonHang: () => void;
}) {
  const { t } = useAppSettings();
  
  return (
    <div className="space-y-4">
      <div className="bg-white/5 border border-white/10 rounded-2xl overflow-hidden">
        <KhoiMenuChon 
          icon={<User size={20} className="text-[#C69C6D]" />}
          label={t('profile.personalInfo')}
          subtitle={t('profile.personalInfoDesc')}
          onClick={onGoToThongTin}
        />
        
        {/* Th√†nh T√≠ch - ch·ªâ hi·ªán cho nh√¢n s·ª± */}
        {isNhanSu && (
          <KhoiMenuChon 
            icon={<Trophy size={20} className="text-yellow-400" />}
            label={t('profile.achievements')}
            subtitle={t('profile.achievementsDesc')}
            onClick={onGoToThanhTich}
          />
        )}
        
        {/* ƒê∆°n H√†ng - ch·ªâ hi·ªán cho kh√°ch h√†ng */}
        {isKhachHang && (
          <KhoiMenuChon 
            icon={<Package size={20} className="text-green-400" />}
            label={t('profile.orders')}
            subtitle={t('profile.ordersDesc')}
            onClick={onGoToDonHang}
            isLast
          />
        )}
        
        {/* N·∫øu l√† nh√¢n s·ª± th√¨ Th√†nh T√≠ch l√† last */}
        {isNhanSu && !isKhachHang && (
          <div className="hidden" /> // Placeholder ƒë·ªÉ isLast ho·∫°t ƒë·ªông ƒë√∫ng
        )}
      </div>
    </div>
  );
}

// =====================================================
// M√ÄN H√åNH: TH√îNG TIN C√Å NH√ÇN
// =====================================================
function ScreenThongTinCaNhan({ nguoiDung }: { nguoiDung: any }) {
  const { t } = useAppSettings();
  
  const fields = [
    { icon: User, label: t('field.fullName'), value: nguoiDung?.ho_ten },
    { icon: Mail, label: t('field.email'), value: nguoiDung?.email },
    { icon: Phone, label: t('field.phone'), value: nguoiDung?.so_dien_thoai },
    { icon: MapPin, label: t('field.address'), value: nguoiDung?.dia_chi },
    { icon: CreditCard, label: t('field.idCard'), value: nguoiDung?.cccd },
  ];

  return (
    <div className="space-y-4">
      <div className="bg-white/5 border border-white/10 rounded-2xl overflow-hidden">
        {fields.map((field, idx) => {
          const Icon = field.icon;
          const isLast = idx === fields.length - 1;
          return (
            <div key={idx} className={`px-4 py-4 ${!isLast ? 'border-b border-white/5' : ''}`}>
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center">
                  <Icon size={20} className="text-[#C69C6D]" />
                </div>
                <div className="flex-1 min-w-0">
                  <p className="text-white/50 text-xs">{field.label}</p>
                  <p className="text-white font-medium truncate">
                    {field.value || <span className="text-white/30 italic">{t('field.notUpdated')}</span>}
                  </p>
                </div>
              </div>
            </div>
          );
        })}
      </div>

      <button className="w-full py-4 bg-gradient-to-r from-[#C69C6D] to-[#F2D3A0] text-black rounded-2xl font-bold">
        {t('profile.editInfo')}
      </button>
    </div>
  );
}

// =====================================================
// M√ÄN H√åNH: TH√ÄNH T√çCH (nhan_su)
// =====================================================
function ScreenThanhTich({ nguoiDung }: { nguoiDung: any }) {
  const { t } = useAppSettings();
  
  return (
    <div className="space-y-4">
      <div className="bg-white/5 border border-white/10 rounded-2xl p-6 text-center">
        <Trophy size={48} className="text-yellow-400 mx-auto mb-4" />
        <h3 className="text-lg font-bold text-white mb-2">{t('achievements.title')}</h3>
        <p className="text-white/60 text-sm">{t('achievements.developing')}</p>
      </div>
      
      {/* Placeholder cho c√°c th√†nh t√≠ch */}
      <div className="bg-white/5 border border-white/10 rounded-2xl overflow-hidden">
        <div className="px-4 py-4 border-b border-white/5">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-yellow-500/20 flex items-center justify-center">
              <Trophy size={20} className="text-yellow-400" />
            </div>
            <div className="flex-1">
              <p className="text-white font-medium">{t('achievements.points')}</p>
              <p className="text-white/50 text-sm">0</p>
            </div>
          </div>
        </div>
        <div className="px-4 py-4">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center">
              <Trophy size={20} className="text-purple-400" />
            </div>
            <div className="flex-1">
              <p className="text-white font-medium">{t('achievements.badges')}</p>
              <p className="text-white/50 text-sm">{t('achievements.noBadges')}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// =====================================================
// M√ÄN H√åNH: ƒê∆†N H√ÄNG (khach_hang)
// =====================================================
function ScreenDonHang({ orders, isLoading, onReload }: { orders: Order[]; isLoading: boolean; onReload: () => void }) {
  const { t, language } = useAppSettings();
  
  if (isLoading) {
    return (
      <div className="flex items-center justify-center py-20">
        <div className="w-12 h-12 border-4 border-[#C69C6D]/30 border-t-[#C69C6D] rounded-full animate-spin"></div>
      </div>
    );
  }

  if (orders.length === 0) {
    return (
      <div className="text-center py-20">
        <Package size={48} className="text-white/20 mx-auto mb-4" />
        <h3 className="text-lg font-bold text-white mb-2">{t('orders.empty')}</h3>
        <p className="text-white/60 text-sm mb-4">{t('orders.emptyDesc')}</p>
        <button onClick={onReload} className="px-4 py-2 bg-[#C69C6D] text-black rounded-lg font-medium">
          {t('app.refresh')}
        </button>
      </div>
    );
  }

  return (
    <div className="space-y-3">
      {orders.map((order) => (
        <div key={order.id} className="bg-white/5 border border-white/10 rounded-xl p-4">
          <div className="flex items-center justify-between mb-2">
            <span className="text-[#C69C6D] font-bold">{order.ma_don}</span>
            <span className="text-xs px-2 py-1 bg-white/10 rounded-full text-white/80">
              {OrderService.formatStatus(order.trang_thai)}
            </span>
          </div>
          <p className="text-white/60 text-sm">{new Date(order.tao_luc).toLocaleDateString(language === 'vi' ? 'vi-VN' : 'en-US')}</p>
          <p className="text-white font-bold mt-2">{OrderService.formatMoney(order.tong_tien)}</p>
        </div>
      ))}
    </div>
  );
}

// =====================================================
// M√ÄN H√åNH: NG√îN NG·ªÆ
// =====================================================
function ScreenNgonNgu() {
  const { language, setLanguage, t } = useAppSettings();
  
  const languages: { code: LanguageCode; name: string; flag: string }[] = [
    { code: 'vi', name: 'Ti·∫øng Vi·ªát', flag: 'üáªüá≥' },
    { code: 'en', name: 'English', flag: 'üá∫üá∏' },
  ];

  const handleSelect = (code: LanguageCode) => {
    setLanguage(code);
  };

  return (
    <div className="space-y-4">
      <div className="bg-[var(--bg-card)] border border-[var(--border-color)] rounded-2xl overflow-hidden">
        {languages.map((lang, idx) => (
          <button
            key={lang.code}
            onClick={() => handleSelect(lang.code)}
            className={`w-full px-4 py-4 flex items-center gap-3 hover:bg-[var(--hover-bg)] transition-colors ${idx < languages.length - 1 ? 'border-b border-[var(--border-light)]' : ''}`}
          >
            <span className="text-2xl">{lang.flag}</span>
            <span className="flex-1 text-left text-[var(--text-primary)] font-medium">{lang.name}</span>
            {language === lang.code && (
              <div className="w-6 h-6 rounded-full bg-[var(--accent)] flex items-center justify-center">
                <Check size={14} className="text-black" />
              </div>
            )}
          </button>
        ))}
      </div>
      
      <p className="text-[var(--text-muted)] text-xs text-center">
        {language === 'vi' ? 'Thay ƒë·ªïi ng√¥n ng·ªØ s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng ngay l·∫≠p t·ª©c' : 'Language change will be applied immediately'}
      </p>
    </div>
  );
}

// =====================================================
// M√ÄN H√åNH: GIAO DI·ªÜN
// =====================================================
function ScreenGiaoDien() {
  const { theme, setTheme, t } = useAppSettings();
  
  const themes: { code: ThemeMode; name: string; icon: typeof Moon; desc: string }[] = [
    { code: 'dark', name: t('settings.themeDark'), icon: Moon, desc: t('settings.themeDarkDesc') },
    { code: 'light', name: t('settings.themeLight'), icon: Sun, desc: t('settings.themeLightDesc') },
  ];

  const handleSelect = (code: ThemeMode) => {
    setTheme(code);
  };

  return (
    <div className="space-y-4">
      <div className="bg-[var(--bg-card)] border border-[var(--border-color)] rounded-2xl overflow-hidden">
        {themes.map((themeOption, idx) => {
          const Icon = themeOption.icon;
          return (
            <button
              key={themeOption.code}
              onClick={() => handleSelect(themeOption.code)}
              className={`w-full px-4 py-4 flex items-center gap-3 hover:bg-[var(--hover-bg)] transition-colors ${idx < themes.length - 1 ? 'border-b border-[var(--border-light)]' : ''}`}
            >
              <div className="w-10 h-10 rounded-xl bg-[var(--bg-card)] flex items-center justify-center">
                <Icon size={20} className={themeOption.code === 'dark' ? 'text-purple-400' : 'text-yellow-400'} />
              </div>
              <div className="flex-1 text-left">
                <p className="text-[var(--text-primary)] font-medium">{themeOption.name}</p>
                <p className="text-[var(--text-secondary)] text-sm">{themeOption.desc}</p>
              </div>
              {theme === themeOption.code && (
                <div className="w-6 h-6 rounded-full bg-[var(--accent)] flex items-center justify-center">
                  <Check size={14} className="text-black" />
                </div>
              )}
            </button>
          );
        })}
      </div>
      
      <p className="text-[var(--text-muted)] text-xs text-center">
        {t('settings.language') === 'Ng√¥n Ng·ªØ' ? 'Thay ƒë·ªïi giao di·ªán s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng ngay l·∫≠p t·ª©c' : 'Theme change will be applied immediately'}
      </p>
    </div>
  );
}
</file>

<file path="GiaoDienTong/MenuTren/NutCaNhan/NutCaNhan.tsx">
'use client';
import React, { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { UserCircle } from 'lucide-react';

 
import ModalProfile from '@/app/GiaoDienTong/MenuTren/NutCaNhan/ModalProfile';
import { useAppSettings } from '@/app/ThuVien/AppSettingsContext';

interface Props {
    nguoiDung: any; 
    isOpen: boolean;       
    onToggle: () => void;  
    onClose: () => void;
}

export default function NutCaNhan({ nguoiDung, isOpen, onToggle, onClose }: Props) {
    const [mounted, setMounted] = useState(false);
    const { t } = useAppSettings();

    useEffect(() => {
        setMounted(true);
    }, []);

    // Modal n·ªôi dung Profile m·ªõi
    const modalContent = isOpen && nguoiDung ? (
        <ModalProfile
            isOpen={true}
            onClose={onClose}
            nguoiDung={nguoiDung}
        />
    ) : null;

    return (
        <>
          

            {mounted && modalContent && createPortal(modalContent, document.body)}
        </>
    );
}
</file>

<file path="globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  /* M√ÄU S·∫ÆC CH·ª¶ ƒê·∫†O - DAY MODE (S√°ng nh∆∞ng kh√¥ng ch√≥i - m√†u gi·∫•y G·∫°o) */
  --gold-artisan: #C69C6D;       /* V√†ng ƒë·ªìng ch·ªß ƒë·∫°o */
  --gold-hover: #B58B5D;         /* V√†ng ƒë·ªìng ƒë·∫≠m h∆°n khi hover */
  --black-matte: #1a120f;        /* ƒêen pha n√¢u ƒë·∫•t */
  --void-black: #050505;         /* ƒêen s√¢u th·∫≥m */
  --paper-rice: #F5E6D3;         /* Tr·∫Øng ng√† gi·∫•y d√≥ */
  --red-seal: #8B0000;           /* ƒê·ªè con tri·ªán */
  
  /* C·∫•u h√¨nh giao di·ªán Light */
  --bg-primary: #F5F5F5;
  --bg-secondary: #EBEBEB;
  --bg-card: #FFFFFF;
  --text-primary: #1a120f;
  --text-secondary: rgba(26, 18, 15, 0.6);
  --border-color: rgba(198, 156, 109, 0.3);
  
  --app-height: 100%;
}

.dark-theme {
  /* C·∫•u h√¨nh giao di·ªán Dark (M·∫∑c ƒë·ªãnh) */
  --bg-primary: #050505;         /* Void Black */
  --bg-secondary: #0A0A0A;
  --bg-card: #1a120f;            /* Black Matte pha n√¢u */
  --text-primary: #F5E6D3;       /* Paper Rice */
  --text-secondary: rgba(245, 230, 211, 0.5);
  --border-color: rgba(198, 156, 109, 0.2); /* Gold m·ªù */
}

/* √Åp d·ª•ng Theme */
body {
  background-color: var(--bg-primary);
  color: var(--text-primary);
  font-family: 'Inter', sans-serif; /* Ho·∫∑c font Serif n·∫øu mu·ªën ngh·ªá h∆°n */
  transition: background-color 0.3s ease, color 0.3s ease;
}

/* üü¢ ARTISAN UTILITIES */
@layer components {
  /* N√∫t b·∫•m phong c√°ch ngh·ªá nh√¢n */
  .btn-artisan {
    @apply px-6 py-3 rounded-xl font-bold uppercase tracking-widest transition-all duration-300;
    background-color: var(--gold-artisan);
    color: #000;
    box-shadow: 0 4px 15px rgba(198, 156, 109, 0.3);
  }
  .btn-artisan:hover {
    background-color: var(--gold-hover);
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(198, 156, 109, 0.4);
  }
  .btn-artisan:active {
    transform: scale(0.98);
  }

  /* Khung ch·ª©a n·ªôi dung phong c√°ch tranh l·ª•a */
  .artisan-card {
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    backdrop-filter: blur(12px);
  }
}

@layer utilities {
  .text-gold { color: var(--gold-artisan); }
  .bg-gold { background-color: var(--gold-artisan); }
  .border-gold { border-color: var(--gold-artisan); }
  
  .glow-text { text-shadow: 0 0 10px rgba(198, 156, 109, 0.5); }
  
  /* ·∫®n scrollbar nh∆∞ng v·∫´n cu·ªôn ƒë∆∞·ª£c */
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
}

/* üü¢ ·∫®N SCROLLBAR TO√ÄN B·ªò APP - V·∫´n cu·ªôn ƒë∆∞·ª£c b·∫±ng vu·ªët/chu·ªôt */
*::-webkit-scrollbar {
  display: none;
}
* {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

/* Animation Hologram */
@keyframes hologram {
  0% { opacity: 0; transform: scale(0.95) translateY(10px); filter: blur(5px); }
  100% { opacity: 1; transform: scale(1) translateY(0); filter: blur(0); }
}
.animate-hologram { animation: hologram 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
</file>

<file path="layout.tsx">
import type { Metadata, Viewport } from 'next';
import { Inter } from 'next/font/google';
import './globals.css'; 
import NutHoTro from '@/app/components/NutHoTro';
import TuVanKhachHang from '@/app/components/TuVanKhachHang'; // üü¢ M·ªöI: Import n√∫t c·ªßa nh√¢n vi√™n
import ForceFullScreen from '@/app/components/ForceFullScreen';
import PushManager from '@/app/components/PushManager'; // üîî M·ªöI: Import tr√¨nh qu·∫£n l√Ω th√¥ng b√°o ƒë·∫©y
// üü¢ IMPORT REACT QUERY PROVIDER
import QueryProvider from '@/app/QueryProvider';
// üü¢ IMPORT USER PROVIDER
import { UserProvider } from '@/app/ThuVien/UserContext';
// üü¢ IMPORT APP SETTINGS PROVIDER (Theme + Language)
import { AppSettingsProvider } from '@/app/ThuVien/AppSettingsContext';
// ‚úÖ IMPORT ERROR BOUNDARY
import ErrorBoundary from '@/app/components/ErrorBoundary';

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
  title: 'H·ªá Th·ªëng Qu·∫£n L√Ω ERP',
  description: 'Generated by Tommy Nghiem',
  manifest: '/manifest.json',
  
  // C·∫•u h√¨nh Icon chu·∫©n
  icons: {
    icon: '/icon-192.png',
    shortcut: '/icon-192.png',
    apple: '/icon-192.png',
    other: {
      rel: 'apple-touch-icon-precomposed',
      url: '/icon-192.png',
    },
  },

  appleWebApp: {
    capable: true,
    statusBarStyle: 'black-translucent',
    title: 'NghiemArt ERP',
  },
};

// üü¢ FIX C·∫§U H√åNH VIEWPORT CHO SAMSUNG INTERNET & TABLET
export const viewport: Viewport = {
  width: 'device-width',
  initialScale: 1,
  minimumScale: 1, // NgƒÉn thu nh·ªè
  maximumScale: 1, // NgƒÉn ph√≥ng to
  userScalable: false,
  viewportFit: 'cover',
  themeColor: '#000000',
  interactiveWidget: 'resizes-visual',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="vi">
      <body className={`${inter.className} bg-black min-h-screen overflow-hidden overscroll-none`}>
        {/* üü¢ B·ªåC USER PROVIDER CHO H·ªÜ TH·ªêNG AUTH */}
        <UserProvider>
          {/* üü¢ B·ªåC APP SETTINGS PROVIDER CHO THEME + LANGUAGE */}
          <AppSettingsProvider>
            <QueryProvider>
              <ErrorBoundary>
                <ForceFullScreen />
                {children}  
                
                {/* üü¢ N√öT H·ªñ TR·ª¢ CHO KH√ÅCH H√ÄNG (G√≥c Tr√°i) */}
                <NutHoTro />

                {/* üü¢ N√öT T∆Ø V·∫§N CHO NH√ÇN VI√äN (T·ª± ·∫©n n·∫øu l√† kh√°ch) */}
                <TuVanKhachHang />

                {/* üîî QU·∫¢N L√ù TH√îNG B√ÅO ƒê·∫®Y (PUSH NOTIFICATIONS) */}
                <PushManager />

              </ErrorBoundary>
            </QueryProvider>
          </AppSettingsProvider>
        </UserProvider>
      </body>
    </html>
  );
}
</file>

<file path="Music/NhacNen.tsx">
'use client';

import React, { useState, useRef, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { 
    Music, Play, Pause, Volume2, VolumeX, Upload, Loader2, X, 
    SkipForward, Trash2, Repeat1, Shuffle, AlertCircle, Volume1, ChevronUp, ChevronDown, Square
} from 'lucide-react';
import { supabase } from '@/app/ThuVien/ketNoiSupabase'; 

interface BaiHat {
    id: string;
    name: string;
    url: string;
}

export default function NhacNen() {
    const [danhSachNhac, setDanhSachNhac] = useState<BaiHat[]>([]);
    const [isPlaying, setIsPlaying] = useState(false);
    const [volume, setVolume] = useState(0.5);
    const [isMuted, setIsMuted] = useState(false);
    const [isOpen, setIsOpen] = useState(false);
    const [currentSongIndex, setCurrentSongIndex] = useState(0);
    const [mounted, setMounted] = useState(false);
    const [showQuickControls, setShowQuickControls] = useState(false);
    
    // State logic (Gi·ªØ nguy√™n ph·∫ßn n√¢ng c·∫•p logic)
    const [isLooping, setIsLooping] = useState(false);   
    const [isShuffling, setIsShuffling] = useState(false); 

    const [isAdmin, setIsAdmin] = useState(false);
    const [isUploading, setIsUploading] = useState(false);
    const [isDeleting, setIsDeleting] = useState<string | null>(null);
    const [errorMsg, setErrorMsg] = useState<string | null>(null);
    const [isUserAuthenticated, setIsUserAuthenticated] = useState(false);
    const [playlistLoaded, setPlaylistLoaded] = useState(false);
    const [hasAutoPlayed, setHasAutoPlayed] = useState(false); // Flag ƒë·ªÉ ch·ªâ auto-play 1 l·∫ßn
    
    const uploadInputRef = useRef<HTMLInputElement>(null);
    const audioRef = useRef<HTMLAudioElement>(null);
    const controlsRef = useRef<HTMLDivElement>(null);

    // üéµ AUTO-PLAY: Ph√°t nh·∫°c khi user login th√†nh c√¥ng - CH·ªà 1 L·∫¶N
    useEffect(() => {
        console.log('üéµ Auto-play check:', { isUserAuthenticated, playlistLoaded, songsCount: danhSachNhac.length, hasAutoPlayed });
        if (isUserAuthenticated && playlistLoaded && danhSachNhac.length > 0 && !hasAutoPlayed && audioRef.current) {
            // Delay m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o audio element s·∫µn s√†ng
            const timer = setTimeout(() => {
                setHasAutoPlayed(true); // ƒê√°nh d·∫•u TR∆Ø·ªöC khi play ƒë·ªÉ tr√°nh race condition
                audioRef.current?.play().then(() => {
                    setIsPlaying(true);
                    console.log('üéµ Auto-play nh·∫°c th√†nh c√¥ng');
                }).catch(err => {
                    console.warn('Auto-play failed (c√≥ th·ªÉ do browser policy):', err);
                    // Kh√¥ng set isPlaying = true n·∫øu play th·∫•t b·∫°i
                });
            }, 500);
            return () => clearTimeout(timer);
        }
    }, [isUserAuthenticated, playlistLoaded, danhSachNhac.length, hasAutoPlayed]);

    useEffect(() => {
        setMounted(true);
        if (typeof window !== 'undefined') {
            const storedUser = localStorage.getItem('USER_INFO');
            const storedRole = localStorage.getItem('USER_ROLE');
            let role = storedRole || '';
            let isAuthenticated = false;
            
            if (storedUser) {
                try {
                    const parsed = JSON.parse(storedUser);
                    role = parsed.role || parsed.vi_tri || parsed.chuc_vu || role;
                    isAuthenticated = true; // User ƒë√£ ƒëƒÉng nh·∫≠p
                } catch (e) { console.error(e); }
            }
            
            setIsUserAuthenticated(isAuthenticated);
            if (['admin', 'quanly', 'boss'].includes(role.toLowerCase().trim())) {
                setIsAdmin(true);
            }
        }
        fetchDanhSachNhac();
    }, []);

    const fetchDanhSachNhac = async () => {
        try {
            // 'tao_luc' kh√¥ng ph·∫£i column chu·∫©n c·ªßa Storage -> g√¢y 400. D√πng created_at lu√¥n.
            const { data, error } = await supabase.storage
                .from('nhac-nen')
                .list('', { sortBy: { column: 'created_at', order: 'asc' } });

            if (error) {
                console.warn("Kh√¥ng th·ªÉ load playlist nh·∫°c:", error);
                setPlaylistLoaded(true);
                return; // Return early instead of throwing
            }

            if (data) {
                const songs: BaiHat[] = data
                    .filter(file => file.name !== '.emptyFolderPlaceholder')
                    .map((file, index) => {
                        const { data: urlData } = supabase.storage
                            .from('nhac-nen')
                            .getPublicUrl(file.name);
                        return {
                            id: file.name,
                            name: `Giai ƒëi·ªáu ${index + 1}: ${file.name.replace(/\.[^/.]+$/, "")}`,
                            url: urlData.publicUrl
                        };
                    });
                setDanhSachNhac(songs);
                setPlaylistLoaded(true); // üéµ ƒê√°nh d·∫•u playlist ƒë√£ load xong
                setErrorMsg(null);
            }
        } catch (err: any) {
            console.error("L·ªói t·∫£i playlist:", err);
            setErrorMsg("Kh√¥ng th·ªÉ t·∫£i danh s√°ch nh·∫°c.");
            setPlaylistLoaded(true); // C≈©ng ƒë√°nh d·∫•u l√† ƒë√£ c·ªë g·∫Øng load, ƒë·ªÉ auto-play kh√¥ng ch·ªù m√£i
        }
    };

    useEffect(() => { if (audioRef.current) audioRef.current.volume = isMuted ? 0 : volume; }, [volume, isMuted]);

    // Close quick controls when clicking outside
    useEffect(() => {
        const handleClickOutside = (e: MouseEvent) => {
            if (controlsRef.current && !controlsRef.current.contains(e.target as Node)) {
                setShowQuickControls(false);
            }
        };
        if (showQuickControls) {
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
        }
    }, [showQuickControls]);

    useEffect(() => {
        if (audioRef.current && danhSachNhac.length > 0) {
            audioRef.current.load();
            if (isPlaying) {
                audioRef.current.play().catch(() => setIsPlaying(false));
            }
        }
    }, [currentSongIndex, danhSachNhac]);

    const togglePlay = () => {
        if (!audioRef.current || danhSachNhac.length === 0) return;
        if (audioRef.current.paused) { 
            audioRef.current.play().then(() => setIsPlaying(true)).catch(console.error);
        } else { 
            audioRef.current.pause(); 
            setIsPlaying(false); 
        }
    };

    const handleNext = () => {
        if (danhSachNhac.length === 0) return;
        if (isShuffling && danhSachNhac.length > 1) {
            let randomIndex;
            do { randomIndex = Math.floor(Math.random() * danhSachNhac.length); } 
            while (randomIndex === currentSongIndex);
            setCurrentSongIndex(randomIndex);
        } else {
            setCurrentSongIndex((prev) => (prev + 1) % danhSachNhac.length);
        }
    };

    const handlePrev = () => {
        if (danhSachNhac.length === 0) return;
        setCurrentSongIndex((prev) => (prev - 1 + danhSachNhac.length) % danhSachNhac.length);
    };

    const handleSongEnded = () => {
        if (isLooping && audioRef.current) {
            audioRef.current.currentTime = 0;
            audioRef.current.play();
        } else {
            handleNext();
        }
    };

    const handleUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
        if (!isAdmin) return; 
        const file = e.target.files?.[0];
        if (!file || !file.type.startsWith('audio/')) return alert('Ch·ªçn file √¢m thanh!');

        try {
            setIsUploading(true);
            const fileName = `music-${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
            const { error } = await supabase.storage.from('nhac-nen').upload(fileName, file);
            if (error) throw error;
            await fetchDanhSachNhac();
            alert('T·∫£i nh·∫°c th√†nh c√¥ng!');
        } catch (err: any) {
            alert(`L·ªói: ${err.message}`);
        } finally {
            setIsUploading(false);
            if (uploadInputRef.current) uploadInputRef.current.value = ''; 
        }
    };

    const handleDelete = async (songId: string, songName: string) => {
        if (!isAdmin) return;
        if (!confirm(`X√≥a "${songName}"?`)) return;
        try {
            setIsDeleting(songId);
            const { error } = await supabase.storage.from('nhac-nen').remove([songId]);
            if (error) throw error;
            if (danhSachNhac[currentSongIndex]?.id === songId) {
                setIsPlaying(false);
                setCurrentSongIndex(0);
            }
            await fetchDanhSachNhac();
        } catch (err: any) {
            alert('L·ªói x√≥a: ' + err.message);
        } finally {
            setIsDeleting(null);
        }
    };

    const modalContent = isOpen ? (
        <div className="fixed inset-0 z-[9999] bg-black/95 backdrop-blur-xl flex flex-col animate-in fade-in duration-300">
            <div className="flex items-center justify-between p-6 border-b border-white/10 shrink-0">
                <div className="flex items-center gap-3">
                    <Music className="text-[#C69C6D]" />
                    <h2 className="text-xl font-serif text-[#C69C6D]">Music Player</h2>
                </div>
                <button onClick={() => setIsOpen(false)} className="p-2 rounded-full hover:bg-white/10 text-white transition-colors"><X size={24} /></button>
            </div>
            <div className="flex-1 overflow-hidden flex flex-col md:flex-row">
                <div className="w-full md:w-1/2 p-4 md:p-8 flex flex-col items-center justify-center gap-6 md:gap-8 border-b md:border-b-0 md:border-r border-white/10 bg-gradient-to-br from-[#1a1512] to-black">
                    <div className={`w-48 h-48 md:w-64 md:h-64 rounded-full border-4 border-[#C69C6D]/30 shadow-[0_0_50px_rgba(198,156,109,0.2)] flex items-center justify-center relative overflow-hidden ${isPlaying ? 'animate-[spin_10s_linear_infinite]' : ''}`}>
                        <div className="absolute inset-0 bg-gradient-to-tr from-black via-[#C69C6D]/20 to-black opacity-80"></div>
                        <div className="w-16 h-16 md:w-20 md:h-20 bg-black rounded-full border-2 border-[#C69C6D] z-10 flex items-center justify-center">
                             <div className="w-3 h-3 md:w-4 md:h-4 bg-[#C69C6D] rounded-full"></div>
                        </div>
                    </div>
                    <div className="text-center space-y-1 md:space-y-2">
                        <h3 className="text-xl md:text-2xl font-bold text-[#F5F5F5] line-clamp-1 px-4">{danhSachNhac.length > 0 ? danhSachNhac[currentSongIndex]?.name : 'Ch∆∞a c√≥ nh·∫°c trong Playlist'}</h3>
                        {errorMsg && <p className="text-red-500 text-xs flex items-center justify-center gap-1"><AlertCircle size={12}/> {errorMsg}</p>}
                    </div>
                    <div className="flex items-center gap-4 md:gap-8">
                        <button onClick={() => setIsShuffling(!isShuffling)} className={`p-2 transition-all ${isShuffling ? 'text-[#C69C6D]' : 'text-white/30 hover:text-white'}`} title="Tr·ªôn b√†i"><Shuffle size={20} /></button>
                        <button onClick={handlePrev} className="text-white/50 hover:text-white transition-colors disabled:opacity-30" disabled={danhSachNhac.length === 0}><SkipForward size={24} className="rotate-180" /></button>
                        <button onClick={togglePlay} disabled={danhSachNhac.length === 0} className="w-14 h-14 md:w-16 md:h-16 rounded-full bg-[#C69C6D] text-black flex items-center justify-center hover:scale-105 active:scale-95 transition-all shadow-[0_0_20px_rgba(198,156,109,0.5)] disabled:opacity-50 disabled:cursor-not-allowed">
                            {isPlaying ? <Pause size={28} fill="currentColor" /> : <Play size={28} fill="currentColor" className="ml-1" />}
                        </button>
                        <button onClick={handleNext} className="text-white/50 hover:text-white transition-colors disabled:opacity-30" disabled={danhSachNhac.length === 0}><SkipForward size={24} /></button>
                        <button onClick={() => setIsLooping(!isLooping)} className={`p-2 transition-all ${isLooping ? 'text-[#C69C6D]' : 'text-white/30 hover:text-white'}`} title="L·∫∑p l·∫°i 1 b√†i"><Repeat1 size={20} /></button>
                    </div>
                    <div className="w-full max-w-[250px] flex items-center gap-4">
                        <button onClick={() => setVolume(v => v === 0 ? 0.5 : 0)} className="text-gray-400">{volume === 0 ? <VolumeX size={20}/> : <Volume2 size={20}/>}</button>
                        <input type="range" min="0" max="1" step="0.05" value={volume} onChange={(e) => setVolume(parseFloat(e.target.value))} className="flex-1 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[#C69C6D]"/>
                    </div>
                </div>
                <div className="w-full md:w-1/2 flex flex-col bg-[#0a0807] min-h-0">
                    <div className="p-4 border-b border-white/10 flex justify-between items-center bg-white/5 shrink-0">
                        <span className="text-sm font-bold text-white uppercase">Playlist ({danhSachNhac.length})</span>
                        {isAdmin && (
                            <div>
                                <input type="file" ref={uploadInputRef} onChange={handleUpload} accept="audio/*" className="hidden" />
                                <button onClick={() => uploadInputRef.current?.click()} disabled={isUploading} className="flex items-center gap-2 px-4 py-2 bg-[#C69C6D]/20 hover:bg-[#C69C6D] text-[#C69C6D] hover:text-black rounded-full text-xs font-bold uppercase transition-all">
                                    {isUploading ? <Loader2 size={14} className="animate-spin" /> : <Upload size={14} />} {isUploading ? 'ƒêang t·∫£i...' : 'Th√™m nh·∫°c'}
                                </button>
                            </div>
                        )}
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scroll p-4 space-y-2">
                        {danhSachNhac.length === 0 && <div className="text-center text-gray-500 py-10"><Music size={40} className="mx-auto mb-2 opacity-20"/><p>Ch∆∞a c√≥ b√†i h√°t n√†o</p></div>}
                        {danhSachNhac.map((song, idx) => (
                            <div key={song.id} onClick={() => { setCurrentSongIndex(idx); setIsPlaying(true); }} className={`group flex items-center gap-4 p-3 rounded-xl cursor-pointer transition-all border border-transparent ${currentSongIndex === idx ? 'bg-[#C69C6D]/10 border-[#C69C6D]/30 text-[#C69C6D]' : 'hover:bg-white/5 text-gray-400 border-white/5'}`}>
                                <div className="w-8 h-8 flex items-center justify-center rounded bg-black/30 text-[10px] font-mono shrink-0">
                                    {currentSongIndex === idx && isPlaying ? <div className="flex gap-0.5 items-end h-3"><span className="w-0.5 bg-current animate-[bounce_1s_infinite] h-2"></span><span className="w-0.5 bg-current animate-[bounce_1.2s_infinite] h-3"></span></div> : idx + 1}
                                </div>
                                <div className="flex-1 min-w-0"><div className="text-sm font-medium truncate">{song.name}</div></div>
                                {isAdmin && (
                                    <button onClick={(e) => { e.stopPropagation(); handleDelete(song.id, song.name); }} disabled={isDeleting === song.id} className="p-2 text-gray-500 hover:text-red-500 hover:bg-red-500/10 rounded-full transition-all">
                                        {isDeleting === song.id ? <Loader2 size={16} className="animate-spin" /> : <Trash2 size={16} />}
                                    </button>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    ) : null;

    return (
        <>
            <audio 
                ref={audioRef} 
                src={danhSachNhac[currentSongIndex]?.url || ''} 
                onEnded={handleSongEnded} 
                onError={(e) => {
                    console.warn("Audio load error, skipping to next track");
                    handleNext(); // Skip to next song on error
                }}
            />
            
            {/* Main Music Button - INLINE (no fixed positioning) */}
            <div ref={controlsRef} className="relative">
                {/* Quick Controls Panel - Dropdown style */}
                {showQuickControls && (
                    <div className="absolute top-full right-0 mt-2 bg-black/95 backdrop-blur-lg border border-white/20 rounded-2xl shadow-xl animate-in slide-in-from-top-2 duration-200 z-50 min-w-[280px]">
                        {/* Player Controls */}
                        <div className="px-4 py-3 border-b border-white/10 space-y-3">
                            {/* Current Song */}
                            <div className="text-xs font-semibold text-[#C69C6D] px-2 line-clamp-1 text-center">
                                {danhSachNhac.length > 0 ? danhSachNhac[currentSongIndex]?.name : 'Ch∆∞a c√≥ nh·∫°c'}
                            </div>
                            
                        {/* Quick Control Buttons */}
                            <div className="flex items-center justify-center gap-3">
                                {/* Play */}
                                <button
                                    onClick={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        if (audioRef.current?.paused) {
                                            audioRef.current?.play().then(() => setIsPlaying(true)).catch(console.error);
                                        }
                                    }}
                                    disabled={danhSachNhac.length === 0}
                                    className="p-2.5 text-white/60 hover:text-white hover:bg-[#C69C6D]/10 rounded-lg transition-colors disabled:opacity-30"
                                    title="Ph√°t"
                                >
                                    <Play size={18} fill="currentColor" className="ml-0.5" />
                                </button>
                                
                                {/* Stop */}
                                <button
                                    onClick={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        if (audioRef.current) {
                                            audioRef.current.pause();
                                            audioRef.current.currentTime = 0;
                                            setIsPlaying(false);
                                        }
                                    }}
                                    disabled={danhSachNhac.length === 0}
                                    className="p-2.5 text-white/60 hover:text-white hover:bg-[#C69C6D]/10 rounded-lg transition-colors disabled:opacity-30"
                                    title="D·ª´ng"
                                >
                                    <Square size={18} fill="currentColor" />
                                </button>
                            </div>
                        </div>
                        
                        {/* Volume Control */}
                        <div className="px-4 py-3 border-b border-white/10">
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        setIsMuted(!isMuted);
                                    }}
                                    className={`p-1.5 rounded-lg transition-all ${
                                        isMuted 
                                            ? 'bg-red-500/20 text-red-400' 
                                            : 'text-white/60 hover:text-white hover:bg-white/10'
                                    }`}
                                    title={isMuted ? 'B·∫≠t √¢m' : 'T·∫Øt √¢m'}
                                >
                                    {isMuted ? <VolumeX size={16} /> : <Volume1 size={16} />}
                                </button>
                                <input
                                    type="range"
                                    min="0"
                                    max="1"
                                    step="0.05"
                                    value={isMuted ? 0 : volume}
                                    onChange={(e) => {
                                        const val = parseFloat(e.target.value);
                                        setVolume(val);
                                        if (val > 0) setIsMuted(false);
                                    }}
                                    className="flex-1 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[#C69C6D]"
                                />
                                <span className="text-xs text-white/40 w-8">{Math.round((isMuted ? 0 : volume) * 100)}%</span>
                            </div>
                        </div>
                        
                        {/* Mode Buttons */}
                        <div className="px-4 py-3 flex items-center justify-between gap-2">
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    setIsLooping(!isLooping);
                                }}
                                className={`flex-1 p-2 text-xs rounded-lg transition-all font-semibold ${
                                    isLooping
                                        ? 'bg-[#C69C6D]/20 text-[#C69C6D]'
                                        : 'bg-white/5 text-white/60 hover:bg-white/10'
                                }`}
                                title="L·∫∑p 1 b√†i"
                            >
                                <Repeat1 size={14} className="mx-auto" />
                            </button>
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    setIsShuffling(!isShuffling);
                                }}
                                className={`flex-1 p-2 text-xs rounded-lg transition-all font-semibold ${
                                    isShuffling
                                        ? 'bg-[#C69C6D]/20 text-[#C69C6D]'
                                        : 'bg-white/5 text-white/60 hover:bg-white/10'
                                }`}
                                title="Tr·ªôn b√†i"
                            >
                                <Shuffle size={14} className="mx-auto" />
                            </button>
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    setIsOpen(true);
                                }}
                                className="flex-1 p-2 text-xs bg-white/5 text-white/60 hover:bg-white/10 rounded-lg transition-all font-semibold"
                                title="M·ªü playlist ƒë·∫ßy ƒë·ªß"
                            >
                                <Music size={14} className="mx-auto" />
                            </button>
                        </div>
                    </div>
                )}
                
                {/* Main Music Button - 1 n√∫t duy nh·∫•t */}
                {!isOpen && (
                    <button 
                        onClick={() => setShowQuickControls(!showQuickControls)}
                        className={`w-10 h-10 rounded-full flex items-center justify-center relative active:scale-95 transition-all border shadow-lg ${
                            isPlaying 
                                ? 'bg-[#C69C6D] border-[#C69C6D] text-black shadow-[0_0_15px_rgba(198,156,109,0.4)] animate-[spin_4s_linear_infinite]' 
                                : 'bg-black/40 border-white/20 text-white hover:bg-white/10 backdrop-blur-md'
                        }`}
                        title="ƒêi·ªÅu khi·ªÉn nh·∫°c"
                    >
                        <Music size={18} />
                    </button>
                )}
            </div>
            
            {mounted && createPortal(modalContent, document.body)}
        </>
    );
}
</file>

<file path="page.tsx">
"use client";

import React, { useState, useEffect, Suspense } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { MapPin, ArrowRight, LogIn, Loader2 } from "lucide-react";
import CongDangNhap from "@/app/CongDangNhap/CongDangNhap";
import GoogleDich from "@/app/ThuVien/GoogleDich";
import { AuthService } from "@/app/CongDangNhap/AuthService";
import { useAppSettings } from "@/app/ThuVien/AppSettingsContext";
// üü¢ IMPORT QUAN TR·ªåNG ƒê·ªÇ FIX L·ªñI
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { getRedirectUrl } from "@/app/CongDangNhap/RoleRedirectService";

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const BASE_IMG_URL = `${SUPABASE_URL}/storage/v1/object/public/hinh-nen`;

// üü¢ T√ÅCH COMPONENT CONTENT ƒê·ªÇ D√ôNG SUSPENSE (B·∫ÆT BU·ªòC TRONG NEXT.JS KHI D√ôNG useSearchParams)
function TrangChuContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const { language, t } = useAppSettings(); // Th√™m t ƒë·ªÉ d·ªãch n·∫øu c·∫ßn

  const [hienPopupLogin, setHienPopupLogin] = useState(false);
  const [nguoiDung, setNguoiDung] = useState<any>(null);
  const [loiChao, setLoiChao] = useState("");
  const [showGreeting, setShowGreeting] = useState(true);
  const [isCheckingAuth, setIsCheckingAuth] = useState(true); // Tr·∫°ng th√°i ƒëang ki·ªÉm tra auth
  const [isRedirecting, setIsRedirecting] = useState(false); // Tr·∫°ng th√°i ƒëang chuy·ªÉn h∆∞·ªõng
  const [daKiemTraLogin, setDaKiemTraLogin] = useState(false); // Tr·∫°ng th√°i ƒë√£ ch·∫°y xong logic login

  // ============================================================
  // üõ°Ô∏è FIX ZOMBIE SESSION: CH·∫∂N NGAY T·ª™ C·ªîNG (QUAN TR·ªåNG NH·∫§T)
  // ============================================================
  useEffect(() => {
    // Ki·ªÉm tra ngay l·∫≠p t·ª©c n·∫øu v·ª´a logout xong
    const urlParams = new URLSearchParams(window.location.search);

    if (urlParams.get("logout")) {
      console.log(
        "üõë [ZOMBIE KILLER] Ph√°t hi·ªán v·ª´a ƒëƒÉng xu·∫•t. D·ª´ng m·ªçi Auto-Login."
      );

      // 1. Reset State ngay l·∫≠p t·ª©c
      setNguoiDung(null);
      setDaKiemTraLogin(true); // ƒê√°nh d·∫•u l√† "ƒë√£ ki·ªÉm tra xong" (k·∫øt qu·∫£ l√† null)
      setIsCheckingAuth(false);

      // 2. X√≥a s·∫°ch l·∫ßn n·ªØa cho ch·∫Øc (Double kill)
      if (typeof window !== "undefined") {
        localStorage.clear();
        sessionStorage.clear();
        // X√≥a cookie visitor
        document.cookie = "VISITOR_MODE=; Path=/; Max-Age=0; SameSite=Lax";
      }

      // 3. D·ªçn d·∫πp URL cho ƒë·∫πp (X√≥a ?logout=success m√† kh√¥ng reload)
      window.history.replaceState({}, "", "/");
      return;
    }
  }, []);

  // ============================================================
  // üü¢ LOGIC KI·ªÇM TRA ƒêƒÇNG NH·∫¨P (AUTO-LOGIN)
  // ============================================================
  useEffect(() => {
    // üõë QUAN TR·ªåNG: N·∫øu URL c√≥ logout th√¨ B·ªé QUA to√†n b·ªô logic d∆∞·ªõi n√†y
    if (new URLSearchParams(window.location.search).get("logout")) return;

    const cleanupStaleLocalStorage = () => {
      const cached = localStorage.getItem("USER_INFO");
      if (cached === "undefined") {
        localStorage.removeItem("USER_INFO");
      } else if (cached) {
        try {
          JSON.parse(cached);
        } catch {
          localStorage.removeItem("USER_INFO");
        }
      }

      Object.keys(localStorage)
        .filter((key) => key.startsWith("sb-"))
        .forEach((key) => {
          if (localStorage.getItem(key) === "undefined") {
            localStorage.removeItem(key);
          }
        });
    };

    const checkSession = async () => {
      setIsCheckingAuth(true);
      try {
        cleanupStaleLocalStorage();

        // 1. H·ªèi th·∫≥ng Server xem c√≤n phi√™n ƒëƒÉng nh·∫≠p kh√¥ng
        const {
          data: { session },
          error,
        } = await supabase.auth.getSession();

        if (error || !session) {
          console.log("üö´ Kh√¥ng t√¨m th·∫•y phi√™n ƒëƒÉng nh·∫≠p. Reset v·ªÅ kh√°ch.");
          setNguoiDung(null);
          localStorage.removeItem("USER_INFO");
          localStorage.removeItem("USER_ROLE");
        } else {
          console.log("‚úÖ Phi√™n ƒëƒÉng nh·∫≠p t·ªìn t·∫°i:", session.user.email);
          const user = await AuthService.getCurrentUser();
          if (user) {
            setNguoiDung(user);
            localStorage.setItem("USER_INFO", JSON.stringify(user));
          } else {
            setNguoiDung(null);
          }
        }
      } catch (e) {
        console.error("L·ªói ki·ªÉm tra session:", e);
        setNguoiDung(null);
      } finally {
        setIsCheckingAuth(false);
        setDaKiemTraLogin(true); // ƒê√°nh d·∫•u ƒë√£ ki·ªÉm tra xong
      }
    };

    checkSession();

    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange(async (event) => {
      if (event === "SIGNED_IN") {
        console.log("‚úÖ SIGNED_IN detected - Re-checking session");
        await checkSession();
      } else if (event === "SIGNED_OUT") {
        console.log("üëã SIGNED_OUT detected - Clearing user");
        setNguoiDung(null);
        localStorage.removeItem("USER_INFO");
        localStorage.removeItem("USER_ROLE");
      }
    });

    return () => subscription.unsubscribe();
  }, []);

  // ============================================================
  // üü¢ AUTO-REDIRECT (CH·ªà KHI ƒê√É C√ì USER V√Ä KH√îNG PH·∫¢I V·ª™A LOGOUT)
  // ============================================================
  useEffect(() => {
    if (!nguoiDung || isRedirecting) return;

    // Ch·∫∑n redirect n·∫øu v·ª´a logout (An to√†n 2 l·ªõp)
    if (new URLSearchParams(window.location.search).get("logout")) return;

    console.log(
      "üü¢ AUTO-REDIRECT TRIGGERED - User detected:",
      nguoiDung.ho_ten
    );
    handleMainAction();
  }, [nguoiDung]);

  // Hi·ªáu ·ª©ng l·ªùi ch√†o
  useEffect(() => {
    const name = nguoiDung?.ho_ten || (language === "vi" ? "Kh√°ch" : "Guest");
    const h = new Date().getHours();
    let timeGreeting = language === "vi" ? "Ch√†o bu·ªïi t·ªëi" : "Good evening";
    if (h >= 5 && h < 11)
      timeGreeting = language === "vi" ? "Ch√†o bu·ªïi s√°ng" : "Good morning";
    else if (h >= 11 && h < 14)
      timeGreeting = language === "vi" ? "Ch√†o bu·ªïi tr∆∞a" : "Good afternoon";
    else if (h >= 14 && h < 18)
      timeGreeting = language === "vi" ? "Ch√†o bu·ªïi chi·ªÅu" : "Good afternoon";

    setLoiChao(`${timeGreeting}, ${name}!`);
    setShowGreeting(true);
    const timer = setTimeout(() => setShowGreeting(false), 5000);
    return () => clearTimeout(timer);
  }, [nguoiDung, language]);

  // X·ª≠ l√Ω kh√°ch v√£ng lai
  const handleGuestVisit = () => {
    document.cookie = "VISITOR_MODE=1; path=/; max-age=86400; SameSite=Lax";
    console.log("üöÄ Kh√°ch tham quan ƒëang v√†o...");
    router.push("/trangchu");
  };

  // X·ª≠ l√Ω n√∫t ch√≠nh (V√†o ph√≤ng / ƒêƒÉng nh·∫≠p)
  const handleMainAction = async () => {
    // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p -> M·ªü Popup
    if (!nguoiDung) {
      setHienPopupLogin(true);
      return;
    }

    // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p -> T√≠nh to√°n ƒë∆∞·ªùng d·∫´n ch√≠nh x√°c
    setIsRedirecting(true);
    try {
      // L·∫•y role chu·∫©n h√≥a
      const role =
        nguoiDung.role ||
        nguoiDung.vi_tri_normalized ||
        nguoiDung.phan_loai_normalized ||
        "khach";
      const type = nguoiDung.userType || "khach_hang";

      console.log(`üöÄ ƒêang ƒëi·ªÅu h∆∞·ªõng cho: ${type} - ${role}`);

      const targetUrl = await getRedirectUrl(type, role);

      console.log(`üéØ ƒê√≠ch ƒë·∫øn: ${targetUrl}`);
      router.push(targetUrl);
    } catch (e) {
      console.error("L·ªói ƒëi·ªÅu h∆∞·ªõng:", e);
      setIsRedirecting(false);
      alert("C√≥ l·ªói khi x√°c ƒë·ªãnh ph√≤ng ban. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
      setNguoiDung(null);
    }
  };

  // Link ·∫£nh n·ªÅn (Th√™m version ƒë·ªÉ tr√°nh cache)
  const bgVersion = React.useMemo(() => Date.now(), []); // Gi·ªØ version c·ªë ƒë·ªãnh trong phi√™n
  const bgMobile = `${BASE_IMG_URL}/login-mobile.jpg?v=${bgVersion}`;
  const bgDesktop = `${BASE_IMG_URL}/login-desktop.jpg?v=${bgVersion}`;

  // N·∫øu ch∆∞a ki·ªÉm tra login xong (v√† kh√¥ng ph·∫£i logout mode), hi·ªán m√†n h√¨nh ƒëen
  if (!daKiemTraLogin)
    return <div className="fixed inset-0 bg-[#050505] z-50" />;

  return (
    <div className="relative h-[100dvh] w-full bg-[#050505] text-[#F5F5F5] overflow-hidden font-sans flex flex-col">
      {/* Background */}
      <div className="absolute inset-0 w-full h-full z-0 pointer-events-none select-none">
        {SUPABASE_URL && (
          <>
            <img
              src={bgMobile}
              className="absolute inset-0 w-full h-full object-cover md:hidden"
              loading="eager"
              alt="bg"
            />
            <img
              src={bgDesktop}
              className="absolute inset-0 w-full h-full object-cover hidden md:block"
              loading="eager"
              alt="bg"
            />
          </>
        )}
        <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent" />
      </div>

      <GoogleDich />

      {/* Content Container */}
      <div className="absolute inset-0 z-10 flex flex-col justify-center items-center translate-y-[10%] p-4">
        <div className="w-full max-w-[95%] md:max-w-2xl flex flex-col items-center gap-6 md:gap-8 animate-fade-in-up">
          {/* Header */}
          <div className="text-center w-full">
            <div className="flex items-center justify-center gap-2 mb-2 md:mb-3">
              <MapPin size={16} className="text-yellow-500" />
              <span className="text-sm font-bold tracking-[0.3em] uppercase text-white drop-shadow-md">
                {language === "vi"
                  ? "C·∫¶N TH∆† / VI·ªÜT NAM"
                  : "CAN THO / VIET NAM"}
              </span>
            </div>
            <div className="relative">
              <h1
                className="font-thin tracking-widest leading-none text-white super-text-shadow whitespace-nowrap"
                style={{ fontSize: "clamp(2rem, 5vw, 3.5rem)" }}
              >
                {language === "vi" ? "ƒêƒÇNG NGHI√äM" : "DANG NGHIEM"}
              </h1>
              <p
                className="font-serif italic text-yellow-500 mt-2 tracking-wide font-medium drop-shadow-md"
                style={{ fontSize: "clamp(14px, 1.5vw, 1.2rem)" }}
              >
                Art Gallery
              </p>
            </div>
            <div className="h-8 flex items-center justify-center mt-2">
              {showGreeting && (
                <p className="text-sm md:text-base text-white/80 animate-pulse font-serif italic">
                  {loiChao}
                </p>
              )}
            </div>
          </div>

          {/* Buttons */}
          <div className="flex flex-wrap items-center justify-center gap-6 md:gap-10 w-full">
            <button
              onClick={handleGuestVisit}
              className="group flex flex-col items-center gap-3 opacity-90 hover:opacity-100 transition-all cursor-pointer hover:scale-105 active:scale-95"
            >
              <div className="w-12 h-12 md:w-14 md:h-14 rounded-full flex items-center justify-center bg-white/5 text-white group-hover:bg-yellow-500 group-hover:text-black transition-all duration-500 ease-out shadow-lg border border-white/20 hover:border-yellow-400">
                <ArrowRight
                  size={24}
                  className="group-hover:-rotate-45 transition-transform duration-500"
                />
              </div>
              <div className="flex flex-col items-center gap-1">
                <span className="text-sm font-bold tracking-[0.2em] text-white group-hover:text-yellow-400 transition-colors drop-shadow-lg">
                  {language === "vi" ? "THAM QUAN" : "VISIT"}
                </span>
              </div>
            </button>

            <div className="hidden sm:block w-[1px] h-12 bg-white/20" />

            {/* N√∫t N·ªôi B·ªô: X·ª≠ l√Ω th√¥ng minh */}
            <button
              onClick={handleMainAction}
              disabled={isCheckingAuth || isRedirecting}
              className="group flex flex-col items-center gap-3 opacity-90 hover:opacity-100 transition-all cursor-pointer hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <div className="w-12 h-12 md:w-14 md:h-14 rounded-full flex items-center justify-center bg-transparent text-gray-400 group-hover:bg-white group-hover:text-black transition-all duration-500 ease-out shadow-lg border border-white/20 hover:border-white">
                {isCheckingAuth || isRedirecting ? (
                  <Loader2 size={24} className="animate-spin" />
                ) : nguoiDung ? (
                  <ArrowRight size={24} />
                ) : (
                  <LogIn size={24} />
                )}
              </div>
              <div className="flex flex-col items-center gap-1">
                <span className="text-sm font-bold tracking-[0.2em] text-gray-400 group-hover:text-white transition-colors drop-shadow-lg">
                  {isCheckingAuth
                    ? "..."
                    : isRedirecting
                    ? language === "vi"
                      ? "ƒêANG V√ÄO..."
                      : "LOADING..."
                    : nguoiDung
                    ? language === "vi"
                      ? "V√ÄO PH√íNG"
                      : "MY ROOM"
                    : language === "vi"
                    ? "ƒêƒÇNG NH·∫¨P"
                    : "LOGIN"}
                </span>
              </div>
            </button>
          </div>
        </div>

        <div className="mt-8 md:mt-12 opacity-40">
          <p className="text-sm tracking-[0.2em] uppercase font-bold text-gray-500 drop-shadow-sm">
            ¬© {new Date().getFullYear()} DANG NghiemArt
          </p>
        </div>
      </div>

      <CongDangNhap
        isOpen={hienPopupLogin}
        onClose={() => setHienPopupLogin(false)}
      />

      <style jsx global>{`
        @keyframes fade-in-up {
          0% {
            opacity: 0;
            transform: translateY(20px);
          }
          100% {
            opacity: 1;
            transform: translateY(0);
          }
        }
        .animate-fade-in-up {
          animation: fade-in-up 1.2s ease-out forwards;
        }
        .super-text-shadow {
          text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9),
            0 8px 16px rgba(0, 0, 0, 0.8), 0 0 20px rgba(0, 0, 0, 0.5);
        }
      `}</style>
    </div>
  );
}

// üü¢ EXPORT DEFAULT CH√çNH: B·ªåC TRONG SUSPENSE ƒê·ªÇ TR√ÅNH L·ªñI NEXT.JS
export default function TrangChuDashboard() {
  return (
    <Suspense
      fallback={
        <div className="w-full h-screen bg-[#050505] flex items-center justify-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#C69C6D]"></div>
        </div>
      }
    >
      <TrangChuContent />
    </Suspense>
  );
}
</file>

<file path="phongadmin/page.tsx">
/**
 * ============================================================
 * PH√íNG ADMIN - COMMAND CENTER
 * ============================================================
 * 
 * File page duy nh·∫•t c·ªßa ph√≤ng admin.
 * G·ªçi c√°c ch·ª©c nƒÉng t·ª´ cacchucnang v·ªõi quy·ªÅn FULL.
 * 
 * QUY·ªÄN H·∫†N PH√íNG ADMIN:
 * - allowView: ‚úÖ Xem t·∫•t c·∫£
 * - allowEdit: ‚úÖ S·ª≠a t·∫•t c·∫£
 * - allowDelete: ‚úÖ X√≥a t·∫•t c·∫£
 * - allowBulk: ‚úÖ Thao t√°c h√†ng lo·∫°t
 * 
 * C√ÅC CH·ª®C NƒÇNG:
 * - T·ªïng quan Dashboard
 * - Nh√¢n s·ª± (full quy·ªÅn)
 * - Kh√°ch h√†ng (full quy·ªÅn)
 * - Data Center (admin only)
 * - C√†i ƒë·∫∑t h·ªá th·ªëng (admin only)
 */

'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import { 
    Users, BookUser, LayoutDashboard, Database, Settings 
} from 'lucide-react';
import KhungTrangChuan from '@/app/components/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';

// Import ch·ª©c nƒÉng t·ª´ cacchucnang
import { NhanSuChucNang } from '@/app/components/cacchucnang';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';

// ============================================================
// QUY·ªÄN H·∫†N PH√íNG ADMIN - FULL ACCESS
// ============================================================

const ADMIN_PERMISSIONS = {
    nhansu: {
        allowView: true,
        allowEdit: true,
        allowDelete: true,
        allowBulk: true,
    },
    khachhang: {
        allowView: true,
        allowEdit: true,
        allowDelete: true,
        allowBulk: true,
    },
    // Th√™m quy·ªÅn cho c√°c ch·ª©c nƒÉng kh√°c...
};

// ============================================================
// DANH S√ÅCH CH·ª®C NƒÇNG
// ============================================================

const ADMIN_FUNCTIONS = [
     
    // Qu·∫£n l√Ω ng∆∞·ªùi d√πng
    { id: 'nhansu', label: 'NH√ÇN S·ª∞', icon: Users },
    { id: 'khachhang', label: 'KH√ÅCH H√ÄNG', icon: BookUser },
    // Admin only
  
    
];

// ============================================================
// COMPONENT CH√çNH
// ============================================================

export default function PhongAdminPage() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('dashboard');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    // Loading state
    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    // Get user info
    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    // ========================================
    // RENDER
    // ========================================

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="ADMIN COMMAND CENTER"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            {/* Thanh Ph√≤ng + Ch·ª©c NƒÉng */}
            <ThanhPhongChucNang
                tenPhong="PH√íNG ADMIN"
                functions={ADMIN_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            {/* Content Area */}
            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        
                        {/* ====== RENDER C√ÅC CH·ª®C NƒÇNG ====== */}
 

                        {/* Nh√¢n s·ª± - G·ªåI T·ª™ CACCHUCNANG v·ªõi quy·ªÅn ADMIN */}
                        {activeFunction === 'nhansu' && (
                            <NhanSuChucNang permissions={ADMIN_PERMISSIONS.nhansu} />
                        )}

                        {/* Kh√°ch h√†ng - G·ªåI T·ª™ CACCHUCNANG v·ªõi quy·ªÅn ADMIN */}
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={ADMIN_PERMISSIONS.khachhang} />
                        )}

                    

                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}

// ============================================================
// COMPONENTS PH·ª§
// ============================================================

function PlaceholderScreen({ text }: { text: string }) {
    return (
        <div className="h-full flex items-center justify-center text-white/30 font-bold uppercase">
            {text}
        </div>
    );
}

function DashboardPlaceholder() {
    return (
        <div className="h-full flex flex-col items-center justify-center text-white/30">
            <LayoutDashboard size={64} className="mb-4 opacity-30" />
            <p className="font-bold uppercase">Dashboard T·ªïng Quan</p>
            <p className="text-sm mt-2">ƒêang ph√°t tri·ªÉn...</p>
        </div>
    );
}
</file>

<file path="phongctv/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { UserCheck } from 'lucide-react';

// Quy·ªÅn c·ªßa CTV: ch·ªâ xem
const CTV_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const CTV_FUNCTIONS = [
    { id: 'khachhang', label: 'KH√ÅCH H√ÄNG', icon: UserCheck },
];

export default function PhongCTV() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('khachhang');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PH√íNG CTV"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PH√íNG CTV"
                functions={CTV_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={CTV_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="phongketoan/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { NhanSuChucNang } from '@/app/components/cacchucnang/nhansu';
import { Users } from 'lucide-react';

// Quy·ªÅn c·ªßa K·∫ø to√°n: xem - KH√îNG s·ª≠a, KH√îNG x√≥a
const KETOAN_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const KETOAN_FUNCTIONS = [
    { id: 'nhansu', label: 'NH√ÇN S·ª∞', icon: Users },
];

export default function PhongKeToan() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('nhansu');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PH√íNG K·∫æ TO√ÅN"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PH√íNG K·∫æ TO√ÅN"
                functions={KETOAN_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'nhansu' && (
                            <NhanSuChucNang permissions={KETOAN_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="phongkhachhang/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { UserCheck } from 'lucide-react';

// Quy·ªÅn c·ªßa Kh√°ch VIP: ch·ªâ xem th√¥ng tin c√° nh√¢n
const KHACHHANG_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const KHACHHANG_FUNCTIONS = [
    { id: 'khachhang', label: 'TH√îNG TIN', icon: UserCheck },
];

export default function PhongKhachHang() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('khachhang');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PH√íNG KH√ÅCH VIP"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PH√íNG KH√ÅCH VIP"
                functions={KHACHHANG_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={KHACHHANG_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="phongkho/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { NhanSuChucNang } from '@/app/components/cacchucnang/nhansu';
import { Users } from 'lucide-react';

// Quy·ªÅn c·ªßa Kho: xem - KH√îNG s·ª≠a, KH√îNG x√≥a
const KHO_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const KHO_FUNCTIONS = [
    { id: 'nhansu', label: 'NH√ÇN S·ª∞', icon: Users },
];

export default function PhongKho() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('nhansu');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PH√íNG KHO"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PH√íNG KHO"
                functions={KHO_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'nhansu' && (
                            <NhanSuChucNang permissions={KHO_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="phongparttime/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { UserCheck } from 'lucide-react';

// Quy·ªÅn c·ªßa Part-time: ch·ªâ xem
const PARTTIME_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const PARTTIME_FUNCTIONS = [
    { id: 'khachhang', label: 'KH√ÅCH H√ÄNG', icon: UserCheck },
];

export default function PhongPartTime() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('khachhang');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PH√íNG PART-TIME"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PH√íNG PART-TIME"
                functions={PARTTIME_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={PARTTIME_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="phongquanly/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { NhanSuChucNang } from '@/app/components/cacchucnang/nhansu';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { Users, UserCheck } from 'lucide-react';

// Quy·ªÅn c·ªßa Qu·∫£n l√Ω: xem, s·ª≠a, bulk - KH√îNG x√≥a
const QUANLY_PERMISSIONS = {
    allowView: true,
    allowEdit: true,
    allowDelete: false,
    allowBulk: true,
};

const QUANLY_FUNCTIONS = [
    { id: 'nhansu', label: 'NH√ÇN S·ª∞', icon: Users },
    { id: 'khachhang', label: 'KH√ÅCH H√ÄNG', icon: UserCheck },
];

export default function PhongQuanLy() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('nhansu');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    // Loading state
    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    // Get user info
    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PH√íNG QU·∫¢N L√ù"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            {/* Thanh Ph√≤ng + Ch·ª©c NƒÉng */}
            <ThanhPhongChucNang
                tenPhong="PH√íNG QU·∫¢N L√ù"
                functions={QUANLY_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            {/* Content Area */}
            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        
                        {/* Nh√¢n s·ª± */}
                        {activeFunction === 'nhansu' && (
                            <NhanSuChucNang permissions={QUANLY_PERMISSIONS} />
                        )}

                        {/* Kh√°ch h√†ng */}
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={QUANLY_PERMISSIONS} />
                        )}
                        
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="phongsales/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { UserCheck } from 'lucide-react';

// Quy·ªÅn c·ªßa Sales: xem, s·ª≠a - KH√îNG x√≥a, KH√îNG bulk
const SALES_PERMISSIONS = {
    allowView: true,
    allowEdit: true,
    allowDelete: false,
    allowBulk: false,
};

const SALES_FUNCTIONS = [
    { id: 'khachhang', label: 'KH√ÅCH H√ÄNG', icon: UserCheck },
];

export default function PhongSales() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('khachhang');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PH√íNG SALES"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PH√íNG SALES"
                functions={SALES_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={SALES_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="phongthietke/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { UserCheck } from 'lucide-react';

// Quy·ªÅn c·ªßa Thi·∫øt k·∫ø: xem - KH√îNG s·ª≠a, KH√îNG x√≥a
const THIETKE_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const THIETKE_FUNCTIONS = [
    { id: 'khachhang', label: 'KH√ÅCH H√ÄNG', icon: UserCheck },
];

export default function PhongThietKe() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('khachhang');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PH√íNG THI·∫æT K·∫æ"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PH√íNG THI·∫æT K·∫æ"
                functions={THIETKE_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={THIETKE_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="phongtrungbay/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { UserCheck } from 'lucide-react';

// Quy·ªÅn c·ªßa Tr∆∞ng b√†y: ch·ªâ xem
const TRUNGBAY_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const TRUNGBAY_FUNCTIONS = [
    { id: 'khachhang', label: 'KH√ÅCH H√ÄNG', icon: UserCheck },
];

export default function PhongTrungBay() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('khachhang');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-screen bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PH√íNG TR∆ØNG B√ÄY"
            contentClassName="flex flex-col h-screen pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PH√íNG TR∆ØNG B√ÄY"
                functions={TRUNGBAY_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={TRUNGBAY_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="QueryProvider.tsx">
'use client';

import React, { useState } from 'react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';

export default function QueryProvider({ children }: { children: React.ReactNode }) {
  const [queryClient] = useState(() => new QueryClient({
    defaultOptions: {
      queries: {
        // D·ªØ li·ªáu ƒë∆∞·ª£c coi l√† "t∆∞∆°i" trong 1 ph√∫t, sau ƒë√≥ m·ªõi fetch l·∫°i n·∫øu c·∫ßn
        staleTime: 60 * 1000, 
        // T·ª± ƒë·ªông fetch l·∫°i khi c·ª≠a s·ªï tr√¨nh duy·ªát ƒë∆∞·ª£c focus
        refetchOnWindowFocus: false,
        // S·ªë l·∫ßn th·ª≠ l·∫°i n·∫øu API l·ªói
        retry: 1,
      },
    },
  }));

  return (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  );
}
</file>

<file path="ThuVien/AppSettingsContext.tsx">
'use client';
import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';

// =====================================================
// TYPES
// =====================================================
export type ThemeMode = 'dark' | 'light';
export type LanguageCode = 'vi' | 'en';

interface AppSettings {
  theme: ThemeMode;
  language: LanguageCode;
}

interface AppSettingsContextType {
  // State
  theme: ThemeMode;
  language: LanguageCode;
  
  // Actions
  setTheme: (theme: ThemeMode) => void;
  setLanguage: (language: LanguageCode) => void;
  toggleTheme: () => void;
  
  // Helpers
  isDark: boolean;
  isVietnamese: boolean;
  
  // Translation function
  t: (key: string) => string;
}// =====================================================
// TRANSLATIONS (ƒê√É TH·ªîI H·ªíN NGH·ªÜ THU·∫¨T)
// =====================================================
const translations: Record<LanguageCode, Record<string, string>> = {
  vi: {
    // Chung - T√¥ng gi·ªçng trang tr·ªçng
    'app.name': 'NghiemArt Management',
    'app.loading': 'ƒêang kh·ªüi t·∫°o...',
    'app.error': 'ƒê√£ c√≥ s·ª± c·ªë',
    'app.save': 'L∆∞u T√°c Ph·∫©m',
    'app.cancel': 'H·ªßy B·ªè',
    'app.confirm': 'X√°c Nh·∫≠n',
    'app.close': 'ƒê√≥ng L·∫°i',
    'app.back': 'Tr·ªü V·ªÅ',
    'app.next': 'Ti·∫øp T·ª•c',
    'app.done': 'Ho√†n T·∫•t',
    'app.edit': 'Hi·ªáu Ch·ªânh',
    'app.delete': 'Lo·∫°i B·ªè',
    'app.search': 'T√¨m ki·∫øm tinh hoa...',
    'app.refresh': 'L√†m M·ªõi',
    'app.noData': 'Ch∆∞a c√≥ d·ªØ li·ªáu tr∆∞ng b√†y',
    
    // Navigation - ƒê·ªãnh danh kh√¥ng gian
    'nav.home': 'S·∫£nh Ch√≠nh',
    'nav.account': 'H·ªì S∆° Ngh·ªá Nh√¢n',
    'nav.notifications': 'Th∆∞ T√≠n',
    'nav.department': 'Kh√¥ng Gian',
    
    // Auth - L·ªùi ch√†o m·ªùi
    'auth.login': 'Ti·∫øp B∆∞·ªõc',
    'auth.loginRegister': 'ƒêƒÉng Nh·∫≠p / Gia Nh·∫≠p',
    'auth.logout': 'R·ªùi C√µi Ngh·ªá',
    'auth.logoutConfirm': 'Qu√Ω v·ªã mu·ªën k·∫øt th√∫c phi√™n l√†m vi·ªác?',
    'auth.loggingOut': 'ƒêang ƒëƒÉng xu·∫•t...',
    'auth.loginFailed': 'Ch∆∞a th·ªÉ truy c·∫≠p',
    'auth.loginError': 'Th√¥ng tin ƒë·ªãnh danh ch∆∞a ch√≠nh x√°c.',
    'auth.needHelp': 'C·∫ßn h·ªó tr·ª£ k·ªπ thu·∫≠t?',
    'auth.enterEmail': 'Email ƒë·ªãnh danh',
    'auth.enterPassword': 'M·∫≠t kh·∫©u b·∫£o m·∫≠t',
    'auth.forgotPassword': 'Qu√™n m·∫≠t kh·∫©u?',
    'auth.rememberMe': 'Ghi nh·ªõ phi√™n n√†y',
    
    // Profile Modal
    'profile.title': 'H·ªì S∆° C√° Nh√¢n',
    'profile.settings': 'Thi·∫øt L·∫≠p H·ªá Th·ªëng',
    'profile.settingsDesc': 'Ng√¥n ng·ªØ & Giao di·ªán',
    'profile.myProfile': 'Th√¥ng Tin C·ªßa T√¥i',
    'profile.myProfileDescStaff': 'Ch·ª©c v·ª• & Th√†nh t·ª±u',
    'profile.myProfileDescCustomer': 'L·ªãch s·ª≠ s∆∞u t·∫ßm',
    'profile.personalInfo': 'S∆° Y·∫øu L√Ω L·ªãch',
    'profile.personalInfoDesc': 'Th√¥ng tin li√™n h·ªá ch√≠nh',
    'profile.achievements': 'B·∫£ng V√†ng',
    'profile.achievementsDesc': 'Ghi nh·∫≠n ƒë√≥ng g√≥p',
    'profile.orders': 'B·ªô S∆∞u T·∫≠p ƒê√£ Mua',
    'profile.ordersDesc': 'C√°c t√°c ph·∫©m s·ªü h·ªØu',
    'profile.editInfo': 'C·∫≠p nh·∫≠t th√¥ng tin',
    'profile.user': 'Th√†nh vi√™n',
    
    // Fields
    'field.fullName': 'H·ªç v√† T√™n',
    'field.email': 'Th∆∞ ƒëi·ªán t·ª≠',
    'field.phone': 'S·ªë ƒëi·ªán tho·∫°i',
    'field.address': 'ƒê·ªãa ch·ªâ li√™n h·ªá',
    'field.idCard': 'ƒê·ªãnh danh c√¥ng d√¢n',
    'field.notUpdated': '---',
    
    // Settings
    'settings.language': 'Ng√¥n Ng·ªØ',
    'settings.theme': 'S·∫Øc Th√°i',
    'settings.themeDark': 'Huy·ªÅn B√≠ (T·ªëi)',
    'settings.themeDarkDesc': 'TƒÉng chi·ªÅu s√¢u, d·ªãu m·∫Øt',
    'settings.themeLight': 'Thanh Tao (S√°ng)',
    'settings.themeLightDesc': 'R·ª±c r·ª°, r√µ r√†ng',
    
    // Orders
    'orders.title': 'ƒê∆°n ƒê·∫∑t T√°c Ph·∫©m',
    'orders.empty': 'Ch∆∞a c√≥ t√°c ph·∫©m n√†o',
    'orders.emptyDesc': 'Qu√Ω kh√°ch ch∆∞a s·ªü h·ªØu t√°c ph·∫©m n√†o.',
    
    // Achievements
    'achievements.title': 'Th√†nh T·ª±u',
    'achievements.developing': 'ƒêang ki·∫øn t·∫°o...',
    'achievements.points': 'ƒêi·ªÉm C·ªëng Hi·∫øn',
    'achievements.badges': 'Hu√¢n Ch∆∞∆°ng',
    'achievements.noBadges': 'Ch∆∞a ƒë·∫°t',
    
    // Notifications
    'notifications.title': 'Th√¥ng B√°o',
    'notifications.empty': 'H·ªôp th∆∞ tr·ªëng',
    'notifications.markAllRead': 'ƒê√£ xem t·∫•t c·∫£',
    'notifications.new': 'M·ªõi',
    
    // Homepage
    'home.welcome': 'H√¢n h·∫°nh ƒë√≥n ti·∫øp',
    'home.goodMorning': 'Ch√∫c ng√†y m·ªõi r·ª±c r·ª°',
    'home.goodAfternoon': 'Ch√∫c bu·ªïi chi·ªÅu an l√†nh',
    'home.goodEvening': 'Ch√∫c bu·ªïi t·ªëi ·∫•m √°p',
    'home.guest': 'Qu√Ω Th∆∞·ªüng Kh√°ch',
    
    // Rooms/Departments - T√™n ph√≤ng ban ngh·ªá thu·∫≠t
    'room.admin': 'ƒê√†i Qu·∫£n Tr·ªã',
    'room.manager': 'Ph√≤ng ƒêi·ªÅu H√†nh',
    'room.parttime': 'Kh√¥ng Gian S√°ng T·∫°o',
    'room.showroom': 'Ph√≤ng Tr∆∞ng B√†y',
    'room.vip': 'Ph√≤ng Th∆∞·ª£ng Kh√°ch',
  },
  en: {
    // Common
    'app.name': 'NghiemArt System',
    'app.loading': 'Initializing...',
    'app.error': 'An error occurred',
    'app.save': 'Save Artwork',
    'app.cancel': 'Cancel',
    'app.confirm': 'Confirm',
    'app.close': 'Close',
    'app.back': 'Return',
    'app.next': 'Next',
    'app.done': 'Completed',
    'app.edit': 'Modify',
    'app.delete': 'Remove',
    'app.search': 'Search masterpieces...',
    'app.refresh': 'Refresh',
    'app.noData': 'No data available',
    
    // Navigation
    'nav.home': 'Grand Hall',
    'nav.account': 'Artisan Profile',
    'nav.notifications': 'Messages',
    'nav.department': 'Studio',
    
    // Auth
    'auth.login': 'Enter',
    'auth.loginRegister': 'Login / Join',
    'auth.logout': 'Leave Studio',
    'auth.logoutConfirm': 'Do you wish to end your session?',
    'auth.loggingOut': 'Leaving...',
    'auth.loginFailed': 'Access Denied',
    'auth.loginError': 'Incorrect credentials.',
    'auth.needHelp': 'Need assistance?',
    'auth.enterEmail': 'Your Email',
    'auth.enterPassword': 'Your Password',
    'auth.forgotPassword': 'Lost Key?',
    'auth.rememberMe': 'Remember me',
    
    // Profile
    'profile.title': 'My Dossier',
    'profile.settings': 'Configuration',
    'profile.settingsDesc': 'Language & Aesthetics',
    'profile.myProfile': 'My Portfolio',
    'profile.myProfileDescStaff': 'Career & Awards',
    'profile.myProfileDescCustomer': 'Collection History',
    'profile.personalInfo': 'Biography',
    'profile.personalInfoDesc': 'Contact details',
    'profile.achievements': 'Honors',
    'profile.achievementsDesc': 'Points & Medals',
    'profile.orders': 'Acquisitions',
    'profile.ordersDesc': 'Artwork history',
    'profile.editInfo': 'Update Bio',
    'profile.user': 'Member',
    
    // Fields
    'field.fullName': 'Full Name',
    'field.email': 'Email',
    'field.phone': 'Contact Number',
    'field.address': 'Address',
    'field.idCard': 'ID / Passport',
    'field.notUpdated': '---',
    
    // Settings
    'settings.language': 'Language',
    'settings.theme': 'Ambiance',
    'settings.themeDark': 'Mystic (Dark)',
    'settings.themeDarkDesc': 'Deep & Elegant',
    'settings.themeLight': 'Radiant (Light)',
    'settings.themeLightDesc': 'Bright & Clear',
    
    // Orders
    'orders.title': 'Orders',
    'orders.empty': 'No acquisitions yet',
    'orders.emptyDesc': 'Your collection is empty',
    
    // Achievements
    'achievements.title': 'Achievements',
    'achievements.developing': 'Coming soon...',
    'achievements.points': 'Tribute Points',
    'achievements.badges': 'Badges',
    'achievements.noBadges': 'None',
    
    // Notifications
    'notifications.title': 'Notifications',
    'notifications.empty': 'Silence',
    'notifications.markAllRead': 'Mark all read',
    'notifications.new': 'New',
    
    // Homepage
    'home.welcome': 'Welcome',
    'home.goodMorning': 'Splendid Morning',
    'home.goodAfternoon': 'Good Afternoon',
    'home.goodEvening': 'Tranquil Evening',
    'home.guest': 'Distinguished Guest',
    
    // Rooms
    'room.admin': 'Command Center',
    'room.manager': 'Operations',
    'room.parttime': 'Creative Space',
    'room.showroom': 'Gallery',
    'room.vip': 'VIP Lounge',
  },
};
// =====================================================
// LOCAL STORAGE KEYS
// =====================================================
const STORAGE_KEYS = {
  theme: 'app_theme',
  language: 'app_language',
};

// =====================================================
// CONTEXT
// =====================================================
const AppSettingsContext = createContext<AppSettingsContextType | undefined>(undefined);

// =====================================================
// PROVIDER
// =====================================================
export function AppSettingsProvider({ children }: { children: ReactNode }) {
  const [theme, setThemeState] = useState<ThemeMode>('dark');
  const [language, setLanguageState] = useState<LanguageCode>('vi');
  const [isHydrated, setIsHydrated] = useState(false);

  // Load settings t·ª´ localStorage khi mount
  useEffect(() => {
    const savedTheme = localStorage.getItem(STORAGE_KEYS.theme) as ThemeMode;
    const savedLanguage = localStorage.getItem(STORAGE_KEYS.language) as LanguageCode;
    
    if (savedTheme && ['dark', 'light'].includes(savedTheme)) {
      setThemeState(savedTheme);
    }
    if (savedLanguage && ['vi', 'en'].includes(savedLanguage)) {
      setLanguageState(savedLanguage);
    }
    
    setIsHydrated(true);
  }, []);

  // Apply theme to document
  useEffect(() => {
    if (!isHydrated) return;
    
    const root = document.documentElement;
    const body = document.body;
    
    if (theme === 'light') {
      root.classList.add('light-theme');
      root.classList.remove('dark-theme');
      body.style.backgroundColor = '#f5f5f5';
      body.style.color = '#1a1a1a';
    } else {
      root.classList.add('dark-theme');
      root.classList.remove('light-theme');
      body.style.backgroundColor = '#000000';
      body.style.color = '#ffffff';
    }
    
    // L∆∞u v√†o localStorage
    localStorage.setItem(STORAGE_KEYS.theme, theme);
  }, [theme, isHydrated]);

  // Save language to localStorage
  useEffect(() => {
    if (!isHydrated) return;
    localStorage.setItem(STORAGE_KEYS.language, language);
    document.documentElement.lang = language;
  }, [language, isHydrated]);

  const setTheme = (newTheme: ThemeMode) => {
    setThemeState(newTheme);
  };

  const setLanguage = (newLanguage: LanguageCode) => {
    setLanguageState(newLanguage);
  };

  const toggleTheme = () => {
    setThemeState(prev => prev === 'dark' ? 'light' : 'dark');
  };

  // Translation function
  const t = (key: string): string => {
    return translations[language][key] || key;
  };

  const value: AppSettingsContextType = {
    theme,
    language,
    setTheme,
    setLanguage,
    toggleTheme,
    isDark: theme === 'dark',
    isVietnamese: language === 'vi',
    t,
  };

  return (
    <AppSettingsContext.Provider value={value}>
      {children}
    </AppSettingsContext.Provider>
  );
}

// =====================================================
// HOOK
// =====================================================
export function useAppSettings() {
  const context = useContext(AppSettingsContext);
  if (context === undefined) {
    throw new Error('useAppSettings must be used within an AppSettingsProvider');
  }
  return context;
}

// =====================================================
// CSS VARIABLES (th√™m v√†o globals.css)
// =====================================================
/*
Th√™m v√†o globals.css:

:root {
  --bg-primary: #000000;
  --bg-secondary: #0A0A0A;
  --bg-tertiary: #1A1A1A;
  --text-primary: #ffffff;
  --text-secondary: rgba(255, 255, 255, 0.6);
  --text-muted: rgba(255, 255, 255, 0.3);
  --border-color: rgba(255, 255, 255, 0.1);
  --accent: #C69C6D;
  --accent-light: #F2D3A0;
}

.light-theme {
  --bg-primary: #ffffff;
  --bg-secondary: #f5f5f5;
  --bg-tertiary: #e5e5e5;
  --text-primary: #1a1a1a;
  --text-secondary: rgba(0, 0, 0, 0.6);
  --text-muted: rgba(0, 0, 0, 0.3);
  --border-color: rgba(0, 0, 0, 0.1);
  --accent: #C69C6D;
  --accent-light: #F2D3A0;
}
*/
</file>

<file path="ThuVien/compressImage.ts">
// File: app/ThuVien/compressImage.ts

export const compressImage = async (file: File, quality: number = 0.8, maxWidth: number = 1920): Promise<File> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target?.result as string;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;

        // Resize n·∫øu ·∫£nh qu√° l·ªõn
        if (width > maxWidth) {
          height = Math.round((height * maxWidth) / width);
          width = maxWidth;
        }

        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        if (!ctx) {
          reject(new Error("Canvas context error"));
          return;
        }

        ctx.drawImage(img, 0, 0, width, height);

        canvas.toBlob(
          (blob) => {
            if (!blob) {
              reject(new Error("Compression failed"));
              return;
            }
            // T·∫°o file m·ªõi t·ª´ blob ƒë√£ n√©n
            const compressedFile = new File([blob], file.name, {
              type: 'image/jpeg',
              lastModified: Date.now(),
            });
            resolve(compressedFile);
          },
          'image/jpeg',
          quality // Ch·∫•t l∆∞·ª£ng n√©n (0.1 - 1.0)
        );
      };
      img.onerror = (err) => reject(err);
    };
    reader.onerror = (err) => reject(err);
  });
};
</file>

<file path="ThuVien/DataNormalizer.ts">
'use client';

/**
 * üîß DATA NORMALIZER - X·ª≠ l√Ω d·ªØ li·ªáu Vietnamese v·ªõi:
 * - Trim whitespace
 * - Normalize case (UPPERCASE, lowercase, Title Case)
 * - Chu·∫©n h√≥a gi√° tr·ªã ph√¢n lo·∫°i
 */

export class DataNormalizer {
  /**
   * C√°c v·ªã tr√≠ h·ª£p l·ªá trong b·∫£ng nhan_su
   */
  static VALID_VI_TRI = {
    ADMIN: 'Admin',
    QUAN_LY: 'Qu·∫£n l√Ω',
    SALES: 'Sales',
  } as const;

  /**
   * C√°c ph√¢n lo·∫°i h·ª£p l·ªá trong b·∫£ng khach_hang
   */
  static VALID_PHAN_LOAI = {
    VIP: 'VIP',
    KH_TRONG_TAM: 'KH Tr·ªçng t√¢m',
  } as const;

  /**
   * Normalize v·ªã tr√≠ (vi_tri)
   * Chuy·ªÉn ƒë·∫ßu v√†o th√†nh m·ªôt gi√° tr·ªã chu·∫©n
   * V√≠ d·ª•: "  ADMIN  " ‚Üí "Admin"
   *        "qu·∫£n l√Ω" ‚Üí "Qu·∫£n l√Ω"
   *        "sales" ‚Üí "Sales"
   */
  static normalizeViTri(value: string | null | undefined): string | null {
    if (!value) return null;

    const normalized = value.trim().toLowerCase();

    // Check Admin
    if (['admin', 'ad', 'administrator'].includes(normalized)) {
      return this.VALID_VI_TRI.ADMIN;
    }

    // Check Qu·∫£n l√Ω
    if (['qu·∫£n l√Ω', 'ql', 'quan ly', 'manager'].includes(normalized)) {
      return this.VALID_VI_TRI.QUAN_LY;
    }

    // Check Sales
    if (['sales', 'sale', 'b√°n h√†ng'].includes(normalized)) {
      return this.VALID_VI_TRI.SALES;
    }

    return null; // Gi√° tr·ªã kh√¥ng h·ª£p l·ªá
  }

  /**
   * Normalize ph√¢n lo·∫°i kh√°ch h√†ng (phan_loai)
   * V√≠ d·ª•: "  VIP  " ‚Üí "VIP"
   *        "kh tr·ªçng t√¢m" ‚Üí "KH Tr·ªçng t√¢m"
   */
  static normalizePhanLoai(value: string | null | undefined): string | null {
    if (!value) return null;

    const normalized = value.trim().toLowerCase().replace(/\s+/g, ' ');

    // Check VIP
    if (normalized === 'vip') {
      return this.VALID_PHAN_LOAI.VIP;
    }

    // Check KH Tr·ªçng t√¢m
    if (
      ['kh tr·ªçng t√¢m', 'kh trong tam', 'kh√°ch tr·ªçng t√¢m', 'khach trong tam'].includes(normalized)
    ) {
      return this.VALID_PHAN_LOAI.KH_TRONG_TAM;
    }

    return null; // Gi√° tr·ªã kh√¥ng h·ª£p l·ªá
  }

  /**
   * Trim v√† normalize text chung
   */
  static normalizeText(value: string | null | undefined): string | null {
    if (!value) return null;
    return value.trim();
  }

  /**
   * Check xem vi_tri c√≥ ph·∫£i Admin kh√¥ng
   */
  static isAdmin(viTri: string | null | undefined): boolean {
    const normalized = this.normalizeViTri(viTri);
    return normalized === this.VALID_VI_TRI.ADMIN;
  }

  /**
   * Check xem vi_tri c√≥ ph·∫£i Qu·∫£n l√Ω kh√¥ng
   */
  static isQuanLy(viTri: string | null | undefined): boolean {
    const normalized = this.normalizeViTri(viTri);
    return normalized === this.VALID_VI_TRI.QUAN_LY;
  }

  /**
   * Check xem vi_tri c√≥ ph·∫£i Sales kh√¥ng
   */
  static isSales(viTri: string | null | undefined): boolean {
    const normalized = this.normalizeViTri(viTri);
    return normalized === this.VALID_VI_TRI.SALES;
  }

  /**
   * Check xem phan_loai c√≥ ph·∫£i VIP kh√¥ng
   */
  static isVIP(phanLoai: string | null | undefined): boolean {
    const normalized = this.normalizePhanLoai(phanLoai);
    return normalized === this.VALID_PHAN_LOAI.VIP;
  }

  /**
   * Check xem phan_loai c√≥ ph·∫£i KH Tr·ªçng t√¢m kh√¥ng
   */
  static isKHTrongTam(phanLoai: string | null | undefined): boolean {
    const normalized = this.normalizePhanLoai(phanLoai);
    return normalized === this.VALID_PHAN_LOAI.KH_TRONG_TAM;
  }

  /**
   * Get t·∫•t c·∫£ valid vi_tri values
   */
  static getAllViTri(): string[] {
    return Object.values(this.VALID_VI_TRI);
  }

  /**
   * Get t·∫•t c·∫£ valid phan_loai values
   */
  static getAllPhanLoai(): string[] {
    return Object.values(this.VALID_PHAN_LOAI);
  }
}

export type ViTri = typeof DataNormalizer.VALID_VI_TRI[keyof typeof DataNormalizer.VALID_VI_TRI];
export type PhanLoai = typeof DataNormalizer.VALID_PHAN_LOAI[keyof typeof DataNormalizer.VALID_PHAN_LOAI];
</file>

<file path="ThuVien/GoogleDich.tsx">
'use client';
import React, { useEffect, useState } from 'react';
import { useAppSettings, LanguageCode } from '@/app/ThuVien/AppSettingsContext';

const LANGUAGES = [
  { code: 'vi', label: 'Ti·∫øng Vi·ªát', flag: 'https://flagcdn.com/w40/vn.png' },
  { code: 'en', label: 'English', flag: 'https://flagcdn.com/w40/us.png' },
  { code: 'zh-CN', label: 'Chinese', flag: 'https://flagcdn.com/w40/cn.png' },
  { code: 'ja', label: 'Japanese', flag: 'https://flagcdn.com/w40/jp.png' },
  { code: 'fr', label: 'French', flag: 'https://flagcdn.com/w40/fr.png' },
  { code: 'de', label: 'German', flag: 'https://flagcdn.com/w40/de.png' },
];

export default function GoogleDich() {
  // üåê ƒê·ªìng b·ªô v·ªõi AppSettingsContext
  const { language, setLanguage } = useAppSettings();
  
  // currentLang d√πng string v√¨ Google Translate h·ªó tr·ª£ nhi·ªÅu ng√¥n ng·ªØ h∆°n AppSettings
  const [currentLang, setCurrentLang] = useState<string>(language);
  const [showMenu, setShowMenu] = useState(false);
  const [isMounted, setIsMounted] = useState(false);

  // ƒê·ªìng b·ªô khi language t·ª´ context thay ƒë·ªïi
  useEffect(() => {
    setCurrentLang(language);
  }, [language]);

  useEffect(() => {
    setIsMounted(true);
    if (typeof document !== 'undefined') {
        const cookies = document.cookie.split(';');
        const googCookie = cookies.find(c => c.trim().startsWith('googtrans='));
        if (googCookie) {
            const langCode = googCookie.split('/').pop();
            if (langCode) setCurrentLang(langCode);
        }
    }

    if (!document.getElementById('google-translate-script')) {
        const addScript = document.createElement('script');
        addScript.id = 'google-translate-script';
        addScript.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
        document.body.appendChild(addScript);

        // @ts-ignore
        window.googleTranslateElementInit = () => {
             // @ts-ignore
             if (window.google && window.google.translate) {
                // @ts-ignore
                new window.google.translate.TranslateElement({
                    pageLanguage: 'vi',
                    autoDisplay: false, 
                    layout: 0 
                }, 'google_translate_element');
             }
        };
    }
  }, []);

  const changeLanguage = (langCode: string) => {
    document.cookie = `googtrans=/auto/${langCode}; path=/; domain=${window.location.hostname}`;
    document.cookie = `googtrans=/auto/${langCode}; path=/;`;
    setCurrentLang(langCode);
    setShowMenu(false);
    
    // üåê ƒê·ªìng b·ªô v·ªõi AppSettingsContext (ch·ªâ vi/en)
    if (langCode === 'vi' || langCode === 'en') {
      setLanguage(langCode as LanguageCode);
    }
    
    window.location.reload(); 
  };

  if (!isMounted) return null;

  const currentFlag = LANGUAGES.find(l => l.code === currentLang)?.flag || LANGUAGES[0].flag;

  return (
    <div className="absolute top-6 right-6 z-50">
      <div id="google_translate_element" className="hidden" />

      <div className="relative">
        <button 
          onClick={() => setShowMenu(!showMenu)}
          className="w-10 h-10 rounded-full overflow-hidden border-2 border-white/20 hover:border-white transition-all shadow-lg active:scale-95 bg-black/50"
        >
          <img src={currentFlag} alt="Flag" className="w-full h-full object-cover" />
        </button>

        {showMenu && (
          <div className="absolute right-0 top-12 bg-black/90 backdrop-blur-md border border-white/10 rounded-xl overflow-hidden shadow-2xl w-40 z-[60]">
            {LANGUAGES.map((lang) => (
              <button
                key={lang.code}
                onClick={() => changeLanguage(lang.code)}
                className={`flex items-center gap-3 w-full px-4 py-3 hover:bg-white/10 transition-colors text-left ${currentLang === lang.code ? 'bg-white/5' : ''}`}
              >
                <img src={lang.flag} alt={lang.code} className="w-6 h-4 object-cover rounded-sm" />
                <span className={`text-xs font-bold ${currentLang === lang.code ? 'text-yellow-500' : 'text-gray-300'}`}>
                  {lang.label}
                </span>
              </button>
            ))}
          </div>
        )}
      </div>
      
      {/* üü¢ CSS QUAN TR·ªåNG: ·∫®n thanh Google tri·ªát ƒë·ªÉ */}
      <style jsx global>{`
        .goog-te-banner-frame { display: none !important; }
        .skiptranslate { display: none !important; } 
        body { top: 0px !important; }
        #goog-gt-tt { display: none !important; visibility: hidden !important; }
        .goog-tooltip { display: none !important; }
        .goog-text-highlight { background-color: transparent !important; box-shadow: none !important; }
      `}</style>
    </div>
  );
}
</file>

<file path="ThuVien/InputValidator.ts">
// ‚úÖ INPUT VALIDATION & SANITIZATION SERVICE
// Prevents XSS attacks and invalid data entry

/**
 * Sanitize HTML to prevent XSS attacks
 * Removes dangerous tags and attributes
 */
export function sanitizeHtml(html: string): string {
  if (!html || typeof html !== 'string') return '';
  
  // Create a temporary DOM element to safely parse HTML
  const temp = document.createElement('div');
  temp.textContent = html; // textContent prevents HTML parsing
  return temp.innerHTML;
}

/**
 * Sanitize chat message input
 * - Removes excessive whitespace
 * - Prevents XSS via HTML tags
 * - Max length 2000 chars
 */
export function sanitizeChatMessage(message: string): string {
  if (!message || typeof message !== 'string') return '';
  
  // Remove script tags and dangerous HTML
  let sanitized = message
    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
    .replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '')
    .replace(/on\w+\s*=\s*["'][^"']*["']/gi, '') // Remove event handlers
    .trim();
  
  // Limit length
  if (sanitized.length > 2000) {
    sanitized = sanitized.substring(0, 2000);
  }
  
  return sanitized;
}

/**
 * Validate email format
 */
export function validateEmail(email: string): boolean {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

/**
 * Validate phone format (Vietnamese)
 * Accepts: 09xx, 08xx, 07xx, 03xx format
 */
export function validatePhone(phone: string): boolean {
  const phoneRegex = /^(09|08|07|03|01)\d{8}$/;
  return phoneRegex.test(phone.replace(/\s+/g, ''));
}

/**
 * Validate Vietnamese name
 * - No special characters or numbers
 * - Min 2 chars, max 100
 */
export function validateVietnameseName(name: string): boolean {
  if (!name || typeof name !== 'string') return false;
  
  const trimmed = name.trim();
  if (trimmed.length < 2 || trimmed.length > 100) return false;
  
  // Allow Vietnamese characters, spaces, hyphens, apostrophes
  const nameRegex = /^[a-zA-Z√Ä-·ªø\s'-]+$/;
  return nameRegex.test(trimmed);
}

/**
 * Sanitize search query
 * - Max 100 chars
 * - Remove special SQL characters
 */
export function sanitizeSearchQuery(query: string): string {
  if (!query || typeof query !== 'string') return '';
  
  let sanitized = query
    .trim()
    .substring(0, 100)
    .replace(/[;'"%\\]/g, ''); // Remove SQL injection chars
  
  return sanitized;
}

/**
 * Validate and parse JSON safely
 */
export function safeParseJson<T>(json: string, fallback: T): T {
  try {
    return JSON.parse(json) as T;
  } catch {
    return fallback;
  }
}

/**
 * Validate URL format
 */
export function validateUrl(url: string): boolean {
  try {
    new URL(url);
    return true;
  } catch {
    return false;
  }
}

/**
 * Truncate text with ellipsis
 */
export function truncateText(text: string, maxLength: number = 100): string {
  if (!text || typeof text !== 'string') return '';
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + '...';
}

/**
 * Validate password strength
 * - Min 8 chars
 * - At least 1 uppercase, 1 lowercase, 1 number, 1 special char
 */
export function validatePasswordStrength(password: string): {
  isValid: boolean;
  strength: 'weak' | 'fair' | 'good' | 'strong';
  feedback: string[];
} {
  const feedback: string[] = [];
  let score = 0;

  if (!password || password.length < 8) {
    feedback.push('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±');
  } else {
    score++;
  }

  if (!/[A-Z]/.test(password)) {
    feedback.push('Ph·∫£i c√≥ √≠t nh·∫•t 1 ch·ªØ c√°i vi·∫øt hoa');
  } else {
    score++;
  }

  if (!/[a-z]/.test(password)) {
    feedback.push('Ph·∫£i c√≥ √≠t nh·∫•t 1 ch·ªØ c√°i vi·∫øt th∆∞·ªùng');
  } else {
    score++;
  }

  if (!/[0-9]/.test(password)) {
    feedback.push('Ph·∫£i c√≥ √≠t nh·∫•t 1 s·ªë');
  } else {
    score++;
  }

  if (!/[!@#$%^&*]/.test(password)) {
    feedback.push('Ph·∫£i c√≥ √≠t nh·∫•t 1 k√Ω t·ª± ƒë·∫∑c bi·ªát (!@#$%^&*)');
  } else {
    score++;
  }

  let strength: 'weak' | 'fair' | 'good' | 'strong' = 'weak';
  if (score >= 5) strength = 'strong';
  else if (score >= 4) strength = 'good';
  else if (score >= 3) strength = 'fair';

  return {
    isValid: score >= 4,
    strength,
    feedback,
  };
}
</file>

<file path="ThuVien/ketNoiSupabase.ts">
import { createBrowserClient } from '@supabase/ssr'

// 1. L·∫•y bi·∫øn m√¥i tr∆∞·ªùng
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY

// 2. Ki·ªÉm tra bi·∫øn m√¥i tr∆∞·ªùng
if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error(
    'L·ªói nghi√™m tr·ªçng: Kh√¥ng t√¨m th·∫•y bi·∫øn m√¥i tr∆∞·ªùng Supabase! H√£y ki·ªÉm tra file .env.local.'
  )
}

// 3. Kh·ªüi t·∫°o Client cho Tr√¨nh duy·ªát (Browser Client)
// D√πng createBrowserClient c·ªßa @supabase/ssr ƒë·ªÉ t·ª± ƒë·ªông x·ª≠ l√Ω Cookies
export const supabase = createBrowserClient(supabaseUrl, supabaseAnonKey)
</file>

<file path="ThuVien/KieuDuLieu.ts">
// ThuVien/KieuDuLieu.ts

export type LoaiNoiDung = 'image' | 'text' | 'task';

export type DuLieuKhoi = {
  id: string;
  tieuDe: string;
  loai: LoaiNoiDung;
  noiDung: string;
  doRongCot: 1 | 2 | 3 | 4; // ColSpan
};

export type DuLieuHang = {
  id: string;
  chieuCao: number;
  danhSachKhoi: DuLieuKhoi[];
};
</file>

<file path="ThuVien/LoggerService.ts">
// ‚úÖ CENTRALIZED ERROR LOGGING SERVICE
// Provides unified error tracking and logging

type LogLevel = 'debug' | 'info' | 'warn' | 'error';

interface LogEntry {
  timestamp: string;
  level: LogLevel;
  context: string;
  message: string;
  data?: unknown;
  error?: {
    message: string;
    stack?: string;
    code?: string;
  };
}

export class LoggerService {
  private static isDevelopment = process.env.NODE_ENV === 'development';

  /**
   * Log at debug level
   */
  static debug(context: string, message: string, data?: unknown) {
    if (this.isDevelopment) {
      console.debug(`[${context}] ${message}`, data);
    }
    this.captureLog('debug', context, message, data);
  }

  /**
   * Log at info level
   */
  static info(context: string, message: string, data?: unknown) {
    console.info(`[${context}] ${message}`, data);
    this.captureLog('info', context, message, data);
  }

  /**
   * Log at warn level
   */
  static warn(context: string, message: string, data?: unknown) {
    console.warn(`[${context}] ${message}`, data);
    this.captureLog('warn', context, message, data);
  }

  /**
   * Log at error level - recommended for use with try/catch
   */
  static error(context: string, message: string, error?: Error | unknown) {
    const errorObj = error instanceof Error ? error : new Error(String(error));
    
    console.error(`[${context}] ${message}`, errorObj);
    
    this.captureLog('error', context, message, undefined, {
      message: errorObj.message,
      stack: errorObj.stack,
      code: (error as any)?.code,
    });
  }

  /**
   * Capture log entry for analytics/monitoring
   * In production, send to external service (Sentry, LogRocket, etc)
   */
  private static captureLog(
    level: LogLevel,
    context: string,
    message: string,
    data?: unknown,
    error?: LogEntry['error']
  ) {
    const entry: LogEntry = {
      timestamp: new Date().toISOString(),
      level,
      context,
      message,
    };

    if (data !== undefined) {
      entry.data = data;
    }

    if (error) {
      entry.error = error;
    }

    // TODO: In production, send to error tracking service
    // Sentry.captureMessage(message, level);
    // or custom API endpoint
  }

  /**
   * Create a scoped logger for a specific component/service
   */
  static createScoped(context: string) {
    return {
      debug: (msg: string, data?: unknown) => this.debug(context, msg, data),
      info: (msg: string, data?: unknown) => this.info(context, msg, data),
      warn: (msg: string, data?: unknown) => this.warn(context, msg, data),
      error: (msg: string, error?: Error | unknown) => this.error(context, msg, error),
    };
  }
}
</file>

<file path="ThuVien/OrderService.ts">
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { LoggerService } from "@/app/ThuVien/LoggerService";

// Interface kh·ªõp v·ªõi DB b·∫£ng don_hang
export interface Order {
  id: string;
  ma_don: string;
  ten_khach: string | null;
  sdt: string | null;
  dia_chi: string | null;
  ghi_chu: string | null;
  trang_thai: string;
  tong_tien: number;
  nguoi_tao_id: string; // ƒê√£ s·ª≠a t·ª´ nguoi_tao -> nguoi_tao_id cho kh·ªõp DB
  tao_luc: string;
  cap_nhat_luc: string;
}

// Interface kh·ªõp v·ªõi DB b·∫£ng don_hang_chi_tiet
export interface OrderItem {
  id: string;
  don_hang_id: string;
  vat_tu_id: string | null;
  ten_item_hien_thi: string | null; // S·ª≠a t·ª´ ten_san_pham -> ten_item_hien_thi
  so_luong: number;
  don_gia: number;
  thanh_tien?: number; // C√≥ th·ªÉ t√≠nh to√°n ·ªü frontend
}

// Interface d·ªØ li·ªáu ƒë·∫ßu v√†o khi t·∫°o ƒë∆°n (t·ª´ Form)
export interface CreateOrderData {
  ten_khach?: string;
  sdt?: string;
  dia_chi?: string;
  ghi_chu?: string;
  items: Array<{
    id?: string; // Th√™m id (vat_tu_id) ƒë·ªÉ tr·ª´ kho n·∫øu c·∫ßn
    ten_san_pham: string;
    so_luong: number;
    don_gia: number;
  }>;
}

export class OrderService {
  /**
   * T·∫°o ƒë∆°n h√†ng m·ªõi (auto set nguoi_tao_id = auth.uid())
   */
  static async createOrder(data: CreateOrderData): Promise<string | null> {
    try {
      // 1. T√≠nh t·ªïng ti·ªÅn
      const tongTien = data.items.reduce(
        (sum, item) => sum + item.so_luong * item.don_gia,
        0
      );

      // 2. L·∫•y User ID hi·ªán t·∫°i
      const {
        data: { user },
      } = await supabase.auth.getUser();

      // 3. Insert ƒë∆°n h√†ng (Header)
      const { data: orderData, error: orderError } = await supabase
        .from("don_hang")
        .insert({
          ten_khach: data.ten_khach,
          sdt: data.sdt,
          dia_chi: data.dia_chi,
          ghi_chu: data.ghi_chu,
          tong_tien: tongTien,
          trang_thai: "moi",
          nguoi_tao_id: user?.id, // D√πng nguoi_tao_id cho chu·∫©n
          // kenh_ban_hang: 'web' // C√≥ th·ªÉ th√™m n·∫øu c·∫ßn
        })
        .select("id")
        .single();

      if (orderError) {
        LoggerService.error("OrderService", "Error creating order", orderError);
        return null;
      }

      // 4. Insert chi ti·∫øt ƒë∆°n h√†ng (Items)
      if (data.items.length > 0) {
        const itemsToInsert = data.items.map((item) => ({
          don_hang_id: orderData.id,
          vat_tu_id: item.id || null, // Map ID v·∫≠t t∆∞ n·∫øu c√≥
          ten_item_hien_thi: item.ten_san_pham, // Map sang c·ªôt ƒë√∫ng trong DB
          so_luong: item.so_luong,
          don_gia: item.don_gia,
        }));

        const { error: itemsError } = await supabase
          .from("don_hang_chi_tiet") // ‚úÖ ƒê√£ s·ª≠a t√™n b·∫£ng ƒë√∫ng
          .insert(itemsToInsert);

        if (itemsError) {
          console.error("Error creating order items:", itemsError);
          // L∆∞u √Ω: N·∫øu insert items l·ªói, c√≥ th·ªÉ c·∫ßn x√≥a ƒë∆°n h√†ng header (rollback th·ªß c√¥ng)
        }
      }

      return orderData.id;
    } catch (error) {
      console.error("OrderService.createOrder error:", error);
      return null;
    }
  }

  /**
   * L·∫•y danh s√°ch ƒë∆°n h√†ng c·ªßa user hi·ªán t·∫°i
   */
  static async getMyOrders(
    limit = 50
  ): Promise<{ orders: Order[]; error: string | null }> {
    try {
      const {
        data: { user },
      } = await supabase.auth.getUser();

      if (!user) return { orders: [], error: "User not logged in" };

      // L·∫•y ƒë∆°n h√†ng do user t·∫°o HO·∫∂C user l√† kh√°ch h√†ng (d·ª±a tr√™n id)
      // ·ªû ƒë√¢y ta t·∫°m l·∫•y theo nguoi_tao_id ƒë·ªÉ ƒë∆°n gi·∫£n
      const { data, error } = await supabase
        .from("don_hang")
        .select("*")
        .eq("nguoi_tao_id", user.id)
        .order("tao_luc", { ascending: false })
        .limit(limit);

      if (error) {
        console.error("Error fetching orders:", error.message);
        return { orders: [], error: error.message };
      }

      return { orders: (data ?? []) as Order[], error: null };
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : "Unknown error";
      console.error("OrderService.getMyOrders error:", errorMsg);
      return { orders: [], error: errorMsg };
    }
  }

  /**
   * L·∫•y chi ti·∫øt ƒë∆°n h√†ng (bao g·ªìm items)
   */
  static async getOrderById(
    orderId: string
  ): Promise<{ order: Order; items: OrderItem[] } | null> {
    try {
      // L·∫•y Header
      const { data: orderData, error: orderError } = await supabase
        .from("don_hang")
        .select("*")
        .eq("id", orderId)
        .single();

      if (orderError) {
        console.error("Error fetching order:", orderError);
        return null;
      }

      // L·∫•y Items
      const { data: itemsData, error: itemsError } = await supabase
        .from("don_hang_chi_tiet") // ‚úÖ ƒê√£ s·ª≠a t√™n b·∫£ng ƒë√∫ng
        .select("*")
        .eq("don_hang_id", orderId);

      if (itemsError) {
        console.error("Error fetching order items:", itemsError);
        // V·∫´n tr·∫£ v·ªÅ order nh∆∞ng kh√¥ng c√≥ items
        return { order: orderData as Order, items: [] };
      }

      return {
        order: orderData as Order,
        items: itemsData as OrderItem[],
      };
    } catch (error) {
      console.error("OrderService.getOrderById error:", error);
      return null;
    }
  }

  /**
   * C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng
   */
  static async updateOrderStatus(
    orderId: string,
    trangThai: string
  ): Promise<boolean> {
    try {
      const { error } = await supabase
        .from("don_hang")
        .update({ trang_thai: trangThai })
        .eq("id", orderId);

      if (error) {
        console.error("Error updating order status:", error);
        return false;
      }

      return true;
    } catch (error) {
      console.error("OrderService.updateOrderStatus error:", error);
      return false;
    }
  }

  /**
   * L·∫•y ƒë∆°n h√†ng g·∫ßn nh·∫•t
   */
  static async getLatestOrder(): Promise<{
    order: Order | null;
    error: string | null;
  }> {
    try {
      const { data, error } = await supabase
        .from("don_hang")
        .select("*")
        .order("tao_luc", { ascending: false })
        .limit(1)
        .single();

      if (error) {
        // C√≥ th·ªÉ kh√¥ng c√≥ ƒë∆°n h√†ng n√†o
        if (error.code === "PGRST116") return { order: null, error: null };

        console.error("Error fetching latest order:", error);
        return { order: null, error: error.message };
      }

      return { order: data as Order, error: null };
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : "Unknown error";
      console.error("OrderService.getLatestOrder error:", errorMsg);
      return { order: null, error: errorMsg };
    }
  }

  /**
   * Format tr·∫°ng th√°i ƒë∆°n h√†ng th√†nh ti·∫øng Vi·ªát
   */
  static formatStatus(status: string): string {
    const statusMap: Record<string, string> = {
      moi: "üÜï M·ªõi",
      dang_xu_ly: "‚è≥ ƒêang x·ª≠ l√Ω",
      dang_giao: "üöö ƒêang giao",
      hoan_thanh: "‚úÖ Ho√†n th√†nh",
      huy: "‚ùå ƒê√£ h·ªßy",
      dang_san_xuat: "üî® ƒêang s·∫£n xu·∫•t",
    };
    return statusMap[status] || status;
  }

  /**
   * Format s·ªë ti·ªÅn VND
   */
  static formatMoney(amount: number): string {
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
    }).format(amount);
  }
}
</file>

<file path="ThuVien/QueryTimeout.ts">
// ‚úÖ SUPABASE QUERY TIMEOUT WRAPPER
// Prevents hanging queries by adding timeout

export class QueryTimeoutError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'QueryTimeoutError';
  }
}

/**
 * Wrap a promise with a timeout
 * @param promise - The promise to wrap
 * @param timeoutMs - Timeout in milliseconds (default: 10000ms = 10s)
 * @param errorMessage - Custom error message
 */
export async function withTimeout<T>(
  promise: Promise<T>,
  timeoutMs: number = 10000,
  errorMessage: string = 'Truy v·∫•n qu√° l√¢u, vui l√≤ng th·ª≠ l·∫°i'
): Promise<T> {
  let timeoutId: NodeJS.Timeout;

  const timeoutPromise = new Promise<never>((_, reject) => {
    timeoutId = setTimeout(() => {
      reject(new QueryTimeoutError(errorMessage));
    }, timeoutMs);
  });

  try {
    const result = await Promise.race([promise, timeoutPromise]);
    clearTimeout(timeoutId!);
    return result;
  } catch (error) {
    clearTimeout(timeoutId!);
    throw error;
  }
}

/**
 * Wrap Supabase query with timeout
 * Usage:
 * ```ts
 * const { data, error } = await withQueryTimeout(
 *   supabase.from('don_hang').select('*'),
 *   8000, // 8 second timeout
 *   'Kh√¥ng th·ªÉ t·∫£i ƒë∆°n h√†ng'
 * );
 * ```
 */
export async function withQueryTimeout<T>(
  queryPromise: Promise<{ data: T | null; error: any }>,
  timeoutMs: number = 10000,
  errorMessage: string = 'Truy v·∫•n qu√° l√¢u'
): Promise<{ data: T | null; error: any }> {
  try {
    return await withTimeout(queryPromise, timeoutMs, errorMessage);
  } catch (error) {
    if (error instanceof QueryTimeoutError) {
      return {
        data: null,
        error: { message: error.message, code: 'QUERY_TIMEOUT' },
      };
    }
    throw error;
  }
}
</file>

<file path="ThuVien/UserContext.tsx">
"use client";

import React, {
  createContext,
  useContext,
  useEffect,
  useState,
  ReactNode,
} from "react";
import { AuthService, type UserInfo } from "@/app/CongDangNhap/AuthService";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { LoggerService } from "@/app/ThuVien/LoggerService";

interface UserContextType {
  user: UserInfo | null;
  loading: boolean;
  error: string | null;
  refreshUser: () => Promise<void>;
  signOut: () => Promise<void>;
}

const UserContext = createContext<UserContextType | undefined>(undefined);

/**
 * UserProvider - Wrap app ƒë·ªÉ share user info
 * D√πng: <UserProvider><App /></UserProvider>
 */
export function UserProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<UserInfo | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    // ‚úÖ SESSION PERSISTENCE - Check Supabase session first
    const initSession = async () => {
      // üõ°Ô∏è CH·∫∂N NGAY N·∫æU V·ª™A LOGOUT (Tr√°nh load l·∫°i user c≈© t·ª´ cache)
      if (typeof window !== "undefined") {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get("logout")) {
          console.log(
            "üõë [UserContext] Ph√°t hi·ªán v·ª´a ƒëƒÉng xu·∫•t. B·ªè qua init session."
          );
          setLoading(false);
          return;
        }
      }

      try {
        setLoading(true);

        // Check if user has active Supabase session
        const {
          data: { session },
        } = await supabase.auth.getSession();

        if (session?.user) {
          // Has active session - load user data
          const currentUser = await AuthService.getCurrentUser();
          setUser(currentUser);

          // Save to localStorage as backup
          if (currentUser) {
            localStorage.setItem("USER_INFO", JSON.stringify(currentUser));
          }
        } else {
          // No active session - check localStorage as fallback
          const savedUser = localStorage.getItem("USER_INFO");
          if (savedUser) {
            try {
              setUser(JSON.parse(savedUser));
            } catch (e) {
              LoggerService.error("UserContext", "Error parsing saved user", e);
              localStorage.removeItem("USER_INFO");
            }
          }
        }
      } catch (err) {
        LoggerService.error("UserContext", "Error loading user", err);
        setError(err instanceof Error ? err.message : "Unknown error");
      } finally {
        setLoading(false);
      }
    };

    initSession();

    // ‚úÖ Listen for auth state changes (login/logout)
    const { data: authListener } = supabase.auth.onAuthStateChange(
      async (event, session) => {
        if (event === "SIGNED_IN" && session) {
          const currentUser = await AuthService.getCurrentUser();
          setUser(currentUser);
          if (currentUser) {
            localStorage.setItem("USER_INFO", JSON.stringify(currentUser));
          }
        } else if (event === "SIGNED_OUT") {
          setUser(null);
          localStorage.removeItem("USER_INFO");
        }
      }
    );

    return () => {
      authListener.subscription.unsubscribe();
    };
  }, []);

  const loadUser = async () => {
    try {
      setLoading(true);
      setError(null);
      const currentUser = await AuthService.getCurrentUser();
      setUser(currentUser);
    } catch (err: any) {
      console.error("Error loading user:", err);
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const refreshUser = async () => {
    await loadUser();
  };

  // üü¢ LOGIC ƒêƒÇNG XU·∫§T "H·ª¶Y DI·ªÜT" + "ƒêUA T·ªêC ƒê·ªò" (FIX ZOMBIE SESSION & TREO)
  const signOut = async () => {
    try {
      setLoading(true);

      // 1. CHI·∫æN THU·∫¨T: ƒêUA T·ªêC ƒê·ªò (RACE)
      // T·∫°o m·ªôt c√°i ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c 3 gi√¢y
      const timeoutPromise = new Promise((resolve) =>
        setTimeout(resolve, 3000)
      );

      // G·ªçi l·ªánh ƒëƒÉng xu·∫•t c·ªßa Supabase
      const supabaseLogoutPromise = AuthService.signOut();

      // Cho 2 th·∫±ng ƒëua nhau: N·∫øu Supabase xong tr∆∞·ªõc -> T·ªët.
      // N·∫øu 3 gi√¢y tr√¥i qua m√† Supabase ch∆∞a xong -> K·ªá n√≥, ch·∫°y ti·∫øp l·ªánh b√™n d∆∞·ªõi.
      await Promise.race([supabaseLogoutPromise, timeoutPromise]);

      // --- ƒêO·∫†N D∆Ø·ªöI N√ÄY S·∫º LU√îN CH·∫†Y SAU T·ªêI ƒêA 3 GI√ÇY ---

      // 2. Reset State React ngay l·∫≠p t·ª©c
      setUser(null);
      setError(null);

      // 3. X√≥a s·∫°ch Storage th·ªß c√¥ng
      if (typeof window !== "undefined") {
        localStorage.clear();
        sessionStorage.clear();
        // X√≥a cookie visitor
        document.cookie = "VISITOR_MODE=; Path=/; Max-Age=0; SameSite=Lax";

        // X√≥a token Supabase th·ªß c√¥ng
        Object.keys(localStorage).forEach((key) => {
          if (key.startsWith("sb-") || key.includes("supabase")) {
            localStorage.removeItem(key);
          }
        });
      }

      // 4. Redirect c·ª©ng v·ªõi c·ªù hi·ªáu logout
      window.location.href = `/?logout=success&t=${Date.now()}`;
    } catch (err) {
      console.error("Logout error (Force quit):", err);
      // V·∫´n force logout d√π l·ªói
      if (typeof window !== "undefined") localStorage.clear();
      window.location.href = `/?logout=force&t=${Date.now()}`;
    } finally {
      setLoading(false);
    }
  };

  return (
    <UserContext.Provider
      value={{ user, loading, error, refreshUser, signOut }}
    >
      {children}
    </UserContext.Provider>
  );
}

/**
 * Hook ƒë·ªÉ d√πng user info
 * const { user, loading } = useUser();
 */
export function useUser() {
  const context = useContext(UserContext);
  if (context === undefined) {
    throw new Error("useUser must be used within UserProvider");
  }
  return context;
}
</file>

<file path="ThuVien/withTimeout.ts">
// ‚úÖ TIMEOUT WRAPPER for async operations
// Prevents hanging queries and provides fallback

/**
 * Wraps a promise with timeout functionality
 * @param promise The promise to wrap
 * @param ms Timeout in milliseconds (default: 10000ms = 10s)
 * @param timeoutError Custom error message on timeout
 */
export async function withTimeout<T>(
  promise: Promise<T>,
  ms: number = 10000,
  timeoutError: string = 'Operation timed out'
): Promise<T> {
  let timeoutId: NodeJS.Timeout;

  const timeoutPromise = new Promise<never>((_, reject) => {
    timeoutId = setTimeout(() => {
      reject(new Error(timeoutError));
    }, ms);
  });

  try {
    const result = await Promise.race([promise, timeoutPromise]);
    clearTimeout(timeoutId!);
    return result;
  } catch (error) {
    clearTimeout(timeoutId!);
    throw error;
  }
}

/**
 * Create a debounced function that delays invoking until after `ms` milliseconds
 * Useful for search inputs, button clicks, etc.
 */
export function debounce<T extends (...args: any[]) => any>(
  func: T,
  ms: number = 300
): (...args: Parameters<T>) => void {
  let timeoutId: NodeJS.Timeout;

  return function (...args: Parameters<T>) {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
      func(...args);
    }, ms);
  };
}

/**
 * Create a throttled function that only invokes at most once per `ms` milliseconds
 * Useful for scroll handlers, resize handlers
 */
export function throttle<T extends (...args: any[]) => any>(
  func: T,
  ms: number = 300
): (...args: Parameters<T>) => void {
  let lastRun = 0;

  return function (...args: Parameters<T>) {
    const now = Date.now();
    if (now - lastRun >= ms) {
      func(...args);
      lastRun = now;
    }
  };
}
</file>

<file path="trangchu/BackgroundManager.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { Image as ImageIcon, Upload, RefreshCw, Smartphone, Monitor, Tablet, Loader2 } from 'lucide-react';
import { supabase } from '@/app/ThuVien/ketNoiSupabase';
import { compressImage } from '@/app/ThuVien/compressImage';

interface Props {
  onUpdate: () => void;
}

export default function BackgroundManager({ onUpdate }: Props) {
  const [isAdmin, setIsAdmin] = useState(false);
  const [isOpen, setIsOpen] = useState(false);
  const [deviceType, setDeviceType] = useState<'desktop' | 'mobile' | 'tablet'>('desktop');
  const [file, setFile] = useState<File | null>(null);
  
  // Tr·∫°ng th√°i x·ª≠ l√Ω: 'idle' | 'compressing' | 'uploading' | 'waiting' | 'done'
  const [status, setStatus] = useState<string>('idle'); 

  useEffect(() => {
    const role = typeof window !== 'undefined' ? localStorage.getItem('USER_ROLE') : '';
    if (role === 'admin' || role === 'quan_ly') setIsAdmin(true);
  }, []);

  if (!isAdmin) return null;

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      setFile(e.target.files[0]);
    }
  };

  const handleUpload = async () => {
    if (!file) return alert("Vui l√≤ng ch·ªçn ·∫£nh!");
    
    try {
      setStatus('compressing');

      // 1. X√°c ƒë·ªãnh t√™n file chu·∫©n (Hardcode)
      let targetFileName = '';
      let maxWidth = 1920;

      if (deviceType === 'desktop') {
        targetFileName = 'trangchu-desktop.jpg';
        maxWidth = 1920;
      } else if (deviceType === 'tablet') {
        targetFileName = 'trangchu-tablet.jpg';
        maxWidth = 1024;
      } else {
        targetFileName = 'trangchu-mobile.jpg';
        maxWidth = 800;
      }

      // 2. N√©n ·∫£nh
      const compressedBlob = await compressImage(file, 0.8, maxWidth);

      // 3. T√°i t·∫°o file v·ªõi t√™n chu·∫©n (ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªïi t√™n ƒë√∫ng)
      const finalFile = new File([compressedBlob], targetFileName, {
        type: 'image/jpeg',
        lastModified: Date.now(),
      });

      setStatus('uploading');

      // 4. Upload l√™n Supabase (Ghi ƒë√® - Upsert)
      const { data, error } = await supabase.storage
        .from('hinh-nen')
        .upload(targetFileName, finalFile, {
          cacheControl: '0', // Y√™u c·∫ßu kh√¥ng cache
          upsert: true       // B·∫Øt bu·ªôc ghi ƒë√®
        });

      if (error) throw error;

      // 5. QUAN TR·ªåNG: Ch·ªù server ƒë·ªìng b·ªô (Propagation Delay)
      setStatus('waiting');
      
      // ƒê·ª£i 2.5 gi√¢y ƒë·ªÉ CDN Supabase k·ªãp c·∫≠p nh·∫≠t file m·ªõi
      setTimeout(() => {
          setStatus('done');
          alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
          setIsOpen(false);
          setFile(null);
          setStatus('idle');
          
          // L√∫c n√†y m·ªõi b√°o cho trang ch·ªß load l·∫°i ·∫£nh
          onUpdate(); 
      }, 2500);

    } catch (err: any) {
      console.error(err);
      alert("L·ªói upload: " + err.message);
      setStatus('idle');
    }
  };

  // Helper ƒë·ªÉ hi·ªÉn th·ªã text tr·∫°ng th√°i
  const getStatusText = () => {
      switch(status) {
          case 'compressing': return 'ƒêang n√©n ·∫£nh...';
          case 'uploading': return 'ƒêang t·∫£i l√™n...';
          case 'waiting': return 'ƒêang ƒë·ªìng b·ªô...';
          case 'done': return 'Ho√†n t·∫•t!';
          default: return 'L∆∞u Thay ƒê·ªïi';
      }
  };

  return (
   <div className="fixed bottom-32 right-6 z-[200] flex flex-col items-end gap-2">
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className="w-10 h-10 rounded-full bg-white/10 backdrop-blur-md border border-white/20 text-[#C69C6D] flex items-center justify-center hover:bg-[#C69C6D] hover:text-black transition-all shadow-lg"
        title="ƒê·ªïi h√¨nh n·ªÅn (Admin)"
      >
        <ImageIcon size={20} />
      </button>

      {isOpen && (
        <div className="bg-black/90 border border-[#C69C6D] p-4 rounded-lg shadow-2xl w-64 animate-fade-in-up flex flex-col gap-3">
          <h4 className="text-[#C69C6D] text-xs font-bold uppercase border-b border-white/10 pb-2 mb-1">
            C·∫≠p nh·∫≠t h√¨nh n·ªÅn
          </h4>

          <div className="flex gap-1 bg-white/10 p-1 rounded">
            <button onClick={() => setDeviceType('desktop')} className={`flex-1 p-1.5 rounded flex justify-center transition-all active:scale-95 ${deviceType === 'desktop' ? 'bg-[#C69C6D] text-black' : 'text-white hover:bg-white/10'}`} title="Desktop">
                <Monitor size={14} />
            </button>
            <button onClick={() => setDeviceType('tablet')} className={`flex-1 p-1.5 rounded flex justify-center transition-all active:scale-95 ${deviceType === 'tablet' ? 'bg-[#C69C6D] text-black' : 'text-white hover:bg-white/10'}`} title="Tablet">
                <Tablet size={14} />
            </button>
            <button onClick={() => setDeviceType('mobile')} className={`flex-1 p-1.5 rounded flex justify-center transition-all active:scale-95 ${deviceType === 'mobile' ? 'bg-[#C69C6D] text-black' : 'text-white hover:bg-white/10'}`} title="Mobile">
                <Smartphone size={14} />
            </button>
          </div>

          <input type="file" accept="image/*" onChange={handleFileChange} className="text-[10px] text-white file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:bg-[#C69C6D] file:text-black hover:file:bg-white cursor-pointer" />

          <button 
            onClick={handleUpload} 
            disabled={status !== 'idle'}
            className="bg-[#C69C6D] text-black text-xs font-bold py-2 rounded flex items-center justify-center gap-2 hover:bg-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed active:scale-95"
          >
            {status !== 'idle' ? <Loader2 size={14} className="animate-spin"/> : <Upload size={14} />}
            {getStatusText()}
          </button>
          
          <div className="text-[9px] text-gray-400 italic text-center">
            *H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông n√©n & ƒë·ªïi t√™n file chu·∫©n.
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="trangchu/NutDatHang.tsx">
'use client';

import React from 'react';
import { useRouter } from 'next/navigation';
import { ShoppingBag, ArrowRight } from 'lucide-react';

export default function NutDatHang() {
  const router = useRouter();

  return (
    <button 
      onClick={() => router.push('/dathang')}
      className="group relative px-8 py-3 bg-[#C69C6D] hover:bg-[#B58B5D] text-black font-bold text-sm md:text-base uppercase tracking-widest rounded-full shadow-[0_0_20px_rgba(198,156,109,0.3)] hover:shadow-[0_0_30px_rgba(198,156,109,0.5)] transition-all duration-300 flex items-center gap-3 overflow-hidden transform hover:-translate-y-1 active:scale-95"
    >
      {/* Hi·ªáu ·ª©ng qu√©t s√°ng (Shimmer effect) */}
      <div className="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/30 to-transparent -translate-x-[150%] group-hover:translate-x-[150%] transition-transform duration-700 ease-in-out" />
      
      <ShoppingBag size={18} className="shrink-0" />
      <span className="relative z-10">Kh√°m Ph√° T√°c Ph·∫©m</span>
      <ArrowRight size={18} className="shrink-0 group-hover:translate-x-1 transition-transform" />
    </button>
  );
}
</file>

<file path="trangchu/page.tsx">
'use client';

import React, { useState, useEffect, useCallback, Suspense } from 'react';
import { useRouter, usePathname, useSearchParams } from 'next/navigation';
import { PlayCircle, Star, ArrowRight, LogIn } from 'lucide-react';

// Import c√°c component h·ªá th·ªëng
import MenuTren from '@/app/GiaoDienTong/MenuTren/MenuTren';
 

// Import component con
import Slider1 from './slider1';
import Slider2 from './slider2';
import NutDatHang from './NutDatHang';
import BackgroundManager from './BackgroundManager';
import { useUser } from '@/app/ThuVien/UserContext';
import { Z_INDEX } from '@/app/constants/zIndex';
import { isRouteAllowed, getRedirectUrl } from '@/app/CongDangNhap/RoleRedirectService';
import { useAppSettings } from '@/app/ThuVien/AppSettingsContext';

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const BASE_IMG_URL = `${SUPABASE_URL}/storage/v1/object/public/hinh-nen`;

// üü¢ ƒê·ªîI T√äN COMPONENT CH√çNH TH√ÄNH Content (Kh√¥ng export default n·ªØa)
function TrangChuContent() {
    const router = useRouter();
    const pathname = usePathname(); // L·∫•y ƒë∆∞·ªùng d·∫´n hi·ªán t·∫°i
    const searchParams = useSearchParams(); // L·∫•y query parameters
    const { user: contextUser, loading: contextLoading } = useUser();
    const { t, language } = useAppSettings(); // üåê Hook ng√¥n ng·ªØ
    
    const [nguoiDung, setNguoiDung] = useState<any>(null);
    const [loiChao, setLoiChao] = useState('');
    const [daKiemTraLogin, setDaKiemTraLogin] = useState(false);
    const [currentTime, setCurrentTime] = useState<string>('');
    const [showGreeting, setShowGreeting] = useState(true);
    const [hasGreetingFinished, setHasGreetingFinished] = useState(false);
    const [showScrollHint, setShowScrollHint] = useState(false);
    const [scrollStartTime, setScrollStartTime] = useState<number | null>(null);
    
    // üü¢ QU·∫¢N L√ù TR·∫†NG TH√ÅI HI·ªÇN TH·ªä TH√îNG MINH
    const [activeOverlays, setActiveOverlays] = useState<Set<string>>(new Set());
    const [bgVersion, setBgVersion] = useState(Date.now());
    const [showHero, setShowHero] = useState(true);
    const [hasScrolled, setHasScrolled] = useState(false);
    const smoothScrollTo = useCallback((targetY: number, duration = 1200) => {
        const startY = typeof window !== 'undefined' ? window.scrollY : 0;
        const diff = targetY - startY;
        const start = typeof performance !== 'undefined' ? performance.now() : 0;

        const easeInOutCubic = (t: number) => (t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2);

        const step = (now: number) => {
            const elapsed = now - start;
            const t = Math.min(1, elapsed / duration);
            const eased = easeInOutCubic(t);
            window.scrollTo(0, startY + diff * eased);
            if (t < 1) requestAnimationFrame(step);
        };

        requestAnimationFrame(step);
    }, []);

    const bgUrlMobile = `${BASE_IMG_URL}/trangchu-mobile.jpg?t=${bgVersion}`;
    const bgUrlTablet = `${BASE_IMG_URL}/trangchu-tablet.jpg?t=${bgVersion}`;
    const bgUrlDesktop = `${BASE_IMG_URL}/trangchu-desktop.jpg?t=${bgVersion}`;

    // ‚úÖ Load user t·ª´ localStorage (ƒë∆°n gi·∫£n h√≥a, kh√¥ng c·∫ßn permission check)
    useEffect(() => {
        // ‚úÖ Check n·∫øu c√≥ query param login=1 th√¨ b·ªè qua load user, force hi·ªán UI ƒë·ªÉ c·ªïng ƒëƒÉng nh·∫≠p xu·∫•t hi·ªán
        const urlParams = new URLSearchParams(window.location.search);
        const shouldShowLogin = urlParams.get('login') === '1';
        
        if (shouldShowLogin) {
            console.log('üîë Hi·ªán c·ªïng ƒëƒÉng nh·∫≠p theo query param');
            setDaKiemTraLogin(true);
            setNguoiDung(null);
            window.history.replaceState({}, '', '/trangchu');
            return;
        }

        // ‚úÖ TIMEOUT FALLBACK: Force show UI after 2s to prevent infinite black screen
        const timeoutId = setTimeout(() => {
            if (!daKiemTraLogin) {
                console.warn('‚ö†Ô∏è TrangChuDashboard: Context loading timeout - forcing UI load');
                setDaKiemTraLogin(true);
                
                const storedUser = localStorage.getItem('USER_INFO');
                if (storedUser) {
                    try {
                        setNguoiDung(JSON.parse(storedUser));
                    } catch (e) {
                        console.error('Error parsing stored user in timeout', e);
                    }
                } else {
                    // üü¢ Kh√¥ng c√≥ user ‚Üí redirect v·ªÅ trang ch·ªß ƒë·ªÉ login
                    router.replace('/');
                    return;
                }
            }
        }, 2000);

        // ‚úÖ Wait for context to finish loading
        if (contextLoading) return () => clearTimeout(timeoutId);
        
        try {
            // ‚úÖ Load user t·ª´ context ho·∫∑c localStorage
            if (contextUser) {
                const viTriRaw = (contextUser as any)?.vi_tri;
                const viTriNormalized = (contextUser as any)?.vi_tri_normalized;
                const phanLoaiNormalized = (contextUser as any)?.phan_loai_normalized;
                const userType = contextUser.userType;
                const roleNormalized = userType === 'nhan_su' ? viTriNormalized : phanLoaiNormalized;

                // üî¥ CH·∫∂N NH√ÇN S·ª∞ V√ÄO TRANGCHU - Redirect v·ªÅ ph√≤ng c·ªßa h·ªç
                    if (userType === 'nhan_su') {
                    console.log('üî¥ Nh√¢n s·ª± kh√¥ng ƒë∆∞·ª£c v√†o /trangchu - redirect v·ªÅ ph√≤ng l√†m vi·ªác');
                    getRedirectUrl(userType, roleNormalized).then((targetRoute: string) => {
                        router.replace(targetRoute);
                    });
                    return;
                }

                const userData = {
                    id: contextUser.id,
                    ho_ten: contextUser.ho_ten || 'Ng∆∞·ªùi d√πng',
                    email: contextUser.email,
                    userType: contextUser.userType,
                    role: roleNormalized,
                    vi_tri: viTriRaw || viTriNormalized || phanLoaiNormalized,
                };

                setNguoiDung(userData);
            } else {
                // ‚úÖ Fallback: localStorage ho·∫∑c visitor cookie
                const storedUser = localStorage.getItem('USER_INFO');
                const isVisitor = document.cookie.includes('VISITOR_MODE=1');
                
                if (storedUser) {
                    try {
                        const parsed = JSON.parse(storedUser);
                        
                        // üî¥ CH·∫∂N NH√ÇN S·ª∞ V√ÄO TRANGCHU (t·ª´ localStorage)
                        if (parsed.userType === 'nhan_su') {
                            console.log('üî¥ Nh√¢n s·ª± kh√¥ng ƒë∆∞·ª£c v√†o /trangchu - redirect v·ªÅ ph√≤ng l√†m vi·ªác');
                            getRedirectUrl(parsed.userType, parsed.vi_tri_normalized || parsed.role).then((targetRoute: string) => {
                                router.replace(targetRoute);
                            });
                            return;
                        }
                        
                        setNguoiDung(parsed);
                    } catch (e) {
                        console.error('Error parsing stored user', e);
                        setNguoiDung(null);
                    }
                } else if (!isVisitor) {
                    // üü¢ Kh√¥ng c√≥ user v√† kh√¥ng ph·∫£i visitor ‚Üí redirect v·ªÅ trang login
                    router.replace('/');
                    return;
                }
            }
        } finally {
            clearTimeout(timeoutId);
            setDaKiemTraLogin(true);
        }
    }, [contextUser, contextLoading, router]);

    // Set greeting: time-based "Ch√†o bu·ªïi ... <name>" and trigger animation (~5s)
    useEffect(() => {
        const name = nguoiDung?.ho_ten || t('home.guest');
        const h = new Date().getHours();
        let timeGreeting = t('home.goodEvening');
        if (h >= 5 && h < 11) timeGreeting = t('home.goodMorning');
        else if (h >= 11 && h < 14) timeGreeting = language === 'vi' ? 'Ch√†o bu·ªïi tr∆∞a' : 'Good afternoon';
        else if (h >= 14 && h < 18) timeGreeting = t('home.goodAfternoon');

        setLoiChao(`${timeGreeting}, ${name}!`);

        // Reset animation states whenever user changes
        setShowGreeting(true);
        setHasGreetingFinished(false);
        setScrollStartTime(null);

        const hideTimer = setTimeout(() => {
            setShowGreeting(false);
            setShowScrollHint(true); // Show scroll hint after greeting disappears
        }, 5000); // show for ~5s

        const finishTimer = setTimeout(() => {
            setHasGreetingFinished(true);
            setShowScrollHint(false); // Hide scroll hint when auto-scroll begins
        }, 5700); // allow fade-out to finish

        return () => {
            clearTimeout(hideTimer);
            clearTimeout(finishTimer);
        };
    }, [nguoiDung, t, language]);

    // After greeting finishes, auto scroll up to content (slider 1 area) and hide hero
    useEffect(() => {
        if (!hasGreetingFinished) return;
        setShowHero(false);
        const target = document.getElementById('content-start');
        const top = target ? target.offsetTop : window.innerHeight;
        smoothScrollTo(top, 1400);
    }, [hasGreetingFinished, smoothScrollTo]);

    // C·∫≠p nh·∫≠t ƒë·ªìng h·ªì th·ªùi gian
    useEffect(() => {
        const updateTime = () => {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            setCurrentTime(`${hours}:${minutes}:${seconds}`);
        };

        updateTime();
        const interval = setInterval(updateTime, 1000);
        return () => clearInterval(interval);
    }, []);

    useEffect(() => {
        const handleVisibilityChange = (e: any) => {
            const { id, open } = e.detail;
            setActiveOverlays(prev => {
                const next = new Set(prev);
                if (open) next.add(id);
                else next.delete(id);
                return next;
            });
            // ·∫®n hero khi modal m·ªü
            if (open) setShowHero(false);
        };

        window.addEventListener('toggle-content-visibility', handleVisibilityChange);
        return () => window.removeEventListener('toggle-content-visibility', handleVisibilityChange);
    }, []);

    // üü¢ HANDLE QUERY PARAM: ?openModal=X (Auto-open modal for nhan_su on redirect)
    useEffect(() => {
        const openModal = searchParams.get('openModal');
        if (openModal) {
            // Dispatch event ƒë·ªÉ m·ªü modal
            window.dispatchEvent(new CustomEvent('openModal', { detail: { modalId: openModal } }));
            // ·∫®n hero
            setShowHero(false);
        }
    }, [searchParams]);

    const handleMenuToggle = useCallback((isMenuOpen: boolean) => {
        setActiveOverlays(prev => {
            const next = new Set(prev);
            if (isMenuOpen) next.add('menu-duoi');
            else next.delete('menu-duoi');
            return next;
        });
        // ·∫®n hero khi menu m·ªü
        if (isMenuOpen) setShowHero(false);
    }, []);

    const handleUpdateBackground = useCallback(() => {
        setBgVersion(Date.now());
    }, []);

    const isVisitor = nguoiDung?.userType === 'guest' || nguoiDung?.role === 'visitor';

    const handleGoToLogin = useCallback(() => {
        // Xo√° ch·∫ø ƒë·ªô kh√°ch v√† chuy·ªÉn ra trang login v·ªõi query m·ªü popup
        document.cookie = 'VISITOR_MODE=; Path=/; Max-Age=0; SameSite=Lax';
        localStorage.removeItem('USER_INFO');
        localStorage.removeItem('USER_ROLE');
        router.push('/?login=1');
    }, [router]);

    const handleScrollToHome = useCallback(() => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        setShowHero(true);
        setHasScrolled(false);
    }, []);

    const hienThiNoiDung = activeOverlays.size === 0;

    useEffect(() => {
        const handleCloseAllOverlays = () => {
            setActiveOverlays(new Set());
            setShowHero(true);
            setHasScrolled(false);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.addEventListener('closeAllOverlays', handleCloseAllOverlays);
        return () => window.removeEventListener('closeAllOverlays', handleCloseAllOverlays);
    }, []);

    useEffect(() => {
        const handleScroll = () => {
            // Ch·ªâ x·ª≠ l√Ω scroll n·∫øu kh√¥ng c√≥ overlay n√†o m·ªü
            if (activeOverlays.size === 0) {
                // Track scroll start time and hide hint after 1s of scrolling
                if (window.scrollY > 50 && showScrollHint) {
                    if (scrollStartTime === null) {
                        setScrollStartTime(Date.now());
                    } else if (Date.now() - scrollStartTime >= 1000) {
                        setShowScrollHint(false);
                    }
                } else if (window.scrollY <= 50) {
                    setScrollStartTime(null);
                }
                
                if (window.scrollY > 100) {
                    setShowHero(false);
                    setHasScrolled(true);
                } else {
                    setShowHero(true);
                    setHasScrolled(false);
                }
            }
        };

        window.addEventListener('scroll', handleScroll);
        return () => window.removeEventListener('scroll', handleScroll);
    }, [activeOverlays.size]);

    // Lock body scroll khi c√≥ overlay m·ªü
    useEffect(() => {
        if (activeOverlays.size > 0) {
            // L∆∞u v·ªã tr√≠ scroll hi·ªán t·∫°i
            const scrollY = window.scrollY;
            document.body.style.position = 'fixed';
            document.body.style.top = `-${scrollY}px`;
            document.body.style.width = '100%';
            document.body.style.overflow = 'hidden';
        } else {
            // Kh√¥i ph·ª•c scroll
            const scrollY = document.body.style.top;
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.width = '';
            document.body.style.overflow = '';
            if (scrollY) {
                window.scrollTo(0, parseInt(scrollY || '0') * -1);
            }
        }

        return () => {
            // Cleanup khi unmount
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.width = '';
            document.body.style.overflow = '';
        };
    }, [activeOverlays.size]);

    // N·∫øu ch∆∞a ki·ªÉm tra login xong, hi·ªán m√†n h√¨nh ƒëen ƒë·ªÉ tr√°nh gi·∫≠t
    if (!daKiemTraLogin) return <div className="fixed inset-0 bg-[#050505]" />;

    return (
        <div className="relative w-full min-h-screen bg-[#050505] text-[#F5F5F5] font-sans selection:bg-[#C69C6D] selection:text-black overflow-x-hidden">
            
            {/* LAYER 0: H√åNH N·ªÄN */}
            <div className="fixed inset-0 w-full h-full z-0 pointer-events-none select-none bg-black">
                <img key={`m-${bgVersion}`} src={bgUrlMobile} alt="BG" className="absolute inset-0 w-full h-full object-cover md:hidden opacity-100 transition-opacity duration-1000" />
                <img key={`t-${bgVersion}`} src={bgUrlTablet} alt="BG" className="absolute inset-0 w-full h-full object-cover hidden md:block lg:hidden opacity-100 transition-opacity duration-1000" />
                <img key={`d-${bgVersion}`} src={bgUrlDesktop} alt="BG" className="absolute inset-0 w-full h-full object-cover hidden lg:block opacity-100 transition-opacity duration-1000" />
                <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-90" />
            </div>

            {/* LAYER 1: N·ªòI DUNG CH√çNH */}
            <main 
                className={`relative z-[10] w-full flex flex-col items-center transition-all duration-500 ease-in-out ${
                    hienThiNoiDung 
                        ? 'opacity-100 translate-y-0 blur-0' 
                        : 'opacity-0 translate-y-10 blur-sm pointer-events-none !hidden'
                }`}
            >
                {/* HERO SECTION - L·ªùi ch√†o & Scroll Indicator */}
                <section className={`relative w-full h-[100dvh] bg-transparent pointer-events-none flex flex-col items-center justify-center transition-all duration-700 ${
                    showHero && hienThiNoiDung ? 'opacity-100 translate-y-0' : 'opacity-0 -translate-y-20 pointer-events-none'
                }`}>
                    {/* Elegant backdrop v·ªõi vi·ªÅn v√†ng */}
                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none px-4">
                        <div className="w-full max-w-4xl">
                            <div className="relative p-0 md:p-4 min-h-[60vh] flex items-center justify-center">
                                {/* Content wrapper */}
                                <div className="relative z-10 w-full flex flex-col items-center justify-center gap-6 text-center">
                                    {/* Main greeting with zoom-out animation */}
                                    {showGreeting && (
                                        <h1 className="text-4xl sm:text-5xl md:text-6xl font-serif font-bold text-[#C69C6D] tracking-wide leading-tight greeting-zoom-out text-center">
                                            <span className="inline-block" style={{ textShadow: '0 4px 30px rgba(0,0,0,0.95), 0 0 60px rgba(198,156,109,0.6), 0 8px 40px rgba(0,0,0,0.8)' }}>
                                                {loiChao}
                                            </span>
                                        </h1>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Scroll hint text - appears after greeting */}
                    {showScrollHint && (
                        <div className="absolute bottom-20 left-0 right-0 flex justify-center pointer-events-none animate-fade-in-up">
                            <p className="text-[#C69C6D]/70 text-sm md:text-base font-light tracking-wide"
                               style={{ textShadow: '0 2px 15px rgba(0,0,0,0.9), 0 0 30px rgba(198,156,109,0.4)' }}>
                                Cu·ªôn xu·ªëng ƒë·ªÉ xem n·ªôi dung
                            </p>
                        </div>
                    )}
                </section>

                <div id="content-start" className="w-full bg-black/90 backdrop-blur-xl min-h-screen pt-20 pb-32 flex flex-col items-center gap-20 relative">
                    {/* Gradient m∆∞·ª£t t·ª´ hero sang content - lo·∫°i b·ªè shadow c·ª©ng */}
                    <div className="absolute -top-32 left-0 right-0 h-32 bg-gradient-to-b from-transparent via-transparent to-black/90 pointer-events-none"></div>
                    
                    <div className="w-full max-w-5xl mx-auto px-4 flex flex-col items-center gap-10 relative z-20">
                        <div className="w-full h-[60vh] md:h-[70vh] rounded-lg shadow-[0_0_50px_rgba(0,0,0,0.8)] relative">
                             <Slider1 />
                        </div>
                        <div className="animate-fade-in-up">
                            <NutDatHang />
                        </div>
                    </div>
                    
                    <div className="w-full max-w-5xl mx-auto px-6 text-center">
                        <div className="mb-10 space-y-3">
                            <h2 className="text-stroke-title text-3xl md:text-5xl font-serif italic text-transparent drop-shadow-lg">Tinh Hoa Ngh·ªá Thu·∫≠t</h2>
                            <p className="text-white/80 max-w-2xl mx-auto text-sm md:text-base font-light font-sans leading-relaxed drop-shadow-md">H√†nh tr√¨nh bi·∫øn nh·ªØng h·∫°t g·∫°o b√¨nh d·ªã th√†nh ki·ªát t√°c tinh x·∫£o, m·ªói s·ª£i g·∫°o l√† m·ªôt n√©t v·∫Ω trong b·ª©c tranh cu·ªôc s·ªëng.</p>
                        </div>
                        <div className="w-full aspect-video rounded-xl overflow-hidden shadow-[0_20px_50px_rgba(198,156,109,0.15)] border border-[#C69C6D]/30 relative group bg-black">
                            <iframe className="w-full h-full object-cover" src="https://www.youtube.com/embed/jfKfPfyJRdk?si=9lJ_kH2g0b0b0b0b&rel=0&modestbranding=1" title="Video" frameBorder="0" allowFullScreen></iframe>
                        </div>
                    </div>

                    <div className="w-full max-w-6xl mx-auto px-4">
                        <div className="flex items-end justify-between px-2 border-b border-white/10 pb-4 mb-8">
                            <div><h3 className="text-[#C69C6D] text-sm font-bold font-sans tracking-[0.2em] uppercase mb-1 shadow-black drop-shadow-md">B·ªô S∆∞u T·∫≠p</h3><h2 className="text-stroke-title text-3xl md:text-4xl font-serif text-transparent">T√°c Ph·∫©m Ti√™u Bi·ªÉu</h2></div>
                            <button className="hidden md:flex items-center gap-2 text-xs font-bold font-sans uppercase text-white/50 hover:text-[#C69C6D] transition-colors">Xem t·∫•t c·∫£ <ArrowRight size={14} /></button>
                        </div>
                        <Slider2 />
                    </div>

                    <div className="w-full max-w-6xl mx-auto px-4 relative z-20">
                          <div className="text-center mb-12"><h2 className="text-stroke-title text-3xl font-serif mt-2 text-transparent">Tri Th·ª©c & H√†nh Tr√¨nh</h2></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="p-8 rounded-xl bg-white/5 border border-white/10 hover:border-[#C69C6D]/50 transition-all hover:-translate-y-1">
                                <div className="flex items-center gap-2 mb-4 text-[#C69C6D] text-xs font-bold font-sans uppercase"><Star size={12}/> <span>Tri·ªÉn L√£m</span></div>
                                <h3 className="text-xl text-white font-serif font-bold mb-2">H·ªìn G·∫°o Vi·ªát 2025</h3>
                                <p className="text-gray-400 text-sm font-sans">Tri·ªÉn l√£m ngh·ªá thu·∫≠t ƒë∆∞∆°ng ƒë·∫°i - n∆°i nh·ªØng t√°c ph·∫©m g·∫°o k·ªÉ c√¢u chuy·ªán v·ªÅ t√¢m h·ªìn d√¢n t·ªôc v√† gi√° tr·ªã vƒ©nh h·∫±ng.</p>
                            </div>
                            <div className="p-8 rounded-xl bg-white/5 border border-white/10 hover:border-[#C69C6D]/50 transition-all hover:-translate-y-1">
                                <div className="flex items-center gap-2 mb-4 text-[#C69C6D] text-xs font-bold font-sans uppercase"><PlayCircle size={12}/> <span>Workshop</span></div>
                                <h3 className="text-xl text-white font-serif font-bold mb-2">L·ªõp H·ªçc Ngh·ªá Nh√¢n</h3>
                                <p className="text-gray-400 text-sm font-sans">T·ª± tay t·∫°o n√™n c√µi ngh·ªá thu·∫≠t - workshop m·ªü c·ª≠a cho nh·ªØng ai mu·ªën kh√°m ph√° k·ªπ thu·∫≠t v√† t√¢m huy·∫øt c·ªßa m·ªôt ngh·ªá nh√¢n th·ª±c th·ª•.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            {/* LAYER 2: GRADIENT B·∫¢O V·ªÜ MENU */}
            <div className="fixed top-0 left-0 right-0 h-28 bg-gradient-to-b from-black to-transparent z-[4900] pointer-events-none"></div>
            <div className="fixed bottom-0 left-0 right-0 h-28 bg-gradient-to-t from-black to-transparent z-[4900] pointer-events-none"></div>

            {/* LAYER 3: H·ªÜ TH·ªêNG MENU */}
            <MenuTren nguoiDung={nguoiDung} loiChao={loiChao} />
            
            

         

            {/* Admin Tools - Tr√°nh gradient MenuDuoi */}
            <div className="fixed bottom-32 left-6 z-[5001] flex flex-col gap-4">
                <BackgroundManager onUpdate={handleUpdateBackground} />
            </div>

            {isVisitor && (
                <button
                    onClick={handleGoToLogin}
                    className="fixed bottom-6 right-4 sm:bottom-8 sm:right-6 z-[5002] flex items-center gap-2 sm:gap-2.5 px-4 sm:px-5 py-3 sm:py-3.5 rounded-full
                        bg-gradient-to-r from-[#C69C6D] via-[#F2D3A0] to-[#C69C6D]
                        text-black font-semibold text-sm sm:text-base tracking-wide
                        shadow-[0_10px_30px_rgba(0,0,0,0.35)] border border-white/20
                        backdrop-blur-md hover:scale-[1.02] active:scale-95 transition-transform duration-200"
                >
                    <LogIn size={18} className="opacity-80" />
                    <span className="whitespace-nowrap">{t('auth.loginRegister')}</span>
                </button>
            )}

            <style jsx global>{`
                /* ·∫®n thanh cu·ªôn */
                ::-webkit-scrollbar { display: none; }
                html, body { -ms-overflow-style: none; scrollbar-width: none; overflow-x: hidden; width: 100%; }
                .text-stroke-title { -webkit-text-stroke: 1px #F5F5F5; color: transparent; text-shadow: 0 0 15px rgba(198,156,109,0.3); font-family: 'Playfair Display', Georgia, serif; }
                @keyframes fade-in-up { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
                .animate-fade-in-up { animation: fade-in-up 1s ease-out forwards; }

                /* Greeting zoom-out animation (~5s, shrink to center) */
                @keyframes greetingZoomOut {
                    0% { transform: scale(1.15); opacity: 1; }
                    40% { transform: scale(1.0); opacity: 0.9; }
                    70% { transform: scale(0.6); opacity: 0.5; }
                    100% { transform: scale(0.2); opacity: 0; }
                }
                .greeting-zoom-out {
                    animation: greetingZoomOut 5s ease-in forwards;
                }
            `}</style>
        </div>
    );
}

// üü¢ EXPORT DEFAULT M·ªöI: B·ªåC TRONG SUSPENSE
export default function TrangChuDashboard() {
    return (
        <Suspense fallback={<div className="w-full h-screen bg-[#050505] flex items-center justify-center"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#C69C6D]"></div></div>}>
            <TrangChuContent />
        </Suspense>
    );
}
</file>

<file path="trangchu/slider1.tsx">
'use client';

import React, { useState, useEffect, useRef } from 'react';
import { ChevronLeft, ChevronRight, Edit, Trash2, Plus, Save, X, Image as ImageIcon } from 'lucide-react';
import { supabase } from '@/app/ThuVien/ketNoiSupabase';
import { compressImage } from '@/app/ThuVien/compressImage'; 

interface SlideData {
  id: number;
  tieu_de: string;
  mo_ta: string;
  hinh_anh: string;
}

export default function Slider1() {
  const [slides, setSlides] = useState<SlideData[]>([]);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [isAdmin, setIsAdmin] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  
  // State cho form
  const [editForm, setEditForm] = useState<{ title: string; desc: string; file: File | null; previewUrl: string }>({
    title: '', desc: '', file: null, previewUrl: ''
  });
  const [isLoading, setIsLoading] = useState(false);

  // Load d·ªØ li·ªáu l·∫ßn ƒë·∫ßu
  useEffect(() => {
    fetchSlides();
    checkAdmin();
  }, []);

  // Ki·ªÉm tra quy·ªÅn t·ª´ LocalStorage
  const checkAdmin = () => {
    if (typeof window !== 'undefined') {
        const role = localStorage.getItem('USER_ROLE');
        // N·∫øu l√† admin ho·∫∑c qu·∫£n l√Ω th√¨ hi·ªán n√∫t s·ª≠a
        if (role === 'admin' || role === 'quan_ly') setIsAdmin(true);
    }
  };

  // H√†m l·∫•y d·ªØ li·ªáu t·ª´ Supabase
  const fetchSlides = async () => {
    const { data, error } = await supabase
      .from('slider_data')
      .select('*')
      .eq('loai_slider', 'slider1')
      .order('tao_luc', { ascending: false });
    
    if (error) {
        console.error("L·ªói t·∫£i slider:", error);
    } else if (data && data.length > 0) {
        setSlides(data);
    } else {
        // D·ªØ li·ªáu m·∫´u hi·ªÉn th·ªã khi ch∆∞a c√≥ DB
        setSlides([{
            id: 0, 
            tieu_de: "NGH·ªÜ THU·∫¨T TRANH G·∫†O", 
            mo_ta: "Ch∆∞a c√≥ d·ªØ li·ªáu, vui l√≤ng th√™m m·ªõi.", 
            hinh_anh: "https://images.unsplash.com/photo-1513364776144-60967b0f800f?q=80&w=1000&auto=format&fit=crop"
        }]);
    }
  };

  // Logic chuy·ªÉn slide
  const prevSlide = () => setCurrentIndex((prev) => (prev === 0 ? slides.length - 1 : prev - 1));
  const nextSlide = () => setCurrentIndex((prev) => (prev === slides.length - 1 ? 0 : prev + 1));

  // Logic ch·ªçn file v√† n√©n ·∫£nh
  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      const originalFile = e.target.files[0];
      try {
        // N√©n ·∫£nh xu·ªëng c√≤n t·ªëi ƒëa 1920px chi·ªÅu r·ªông
        const compressed = await compressImage(originalFile, 0.8, 1920); 
        setEditForm(prev => ({ ...prev, file: compressed, previewUrl: URL.createObjectURL(compressed) }));
      } catch (err) {
        console.error("L·ªói n√©n ·∫£nh:", err);
        alert("Kh√¥ng th·ªÉ x·ª≠ l√Ω ·∫£nh n√†y.");
      }
    }
  };

  // Logic L∆∞u Slide (Quan tr·ªçng)
  const handleSave = async () => {
    if (!editForm.file && !isEditing) return alert("Vui l√≤ng ch·ªçn ·∫£nh!");
    setIsLoading(true);

    try {
      let imageUrl = editForm.previewUrl;

      // 1. Upload ·∫£nh n·∫øu c√≥ file m·ªõi
      if (editForm.file) {
        const fileName = `slider1-${Date.now()}.jpg`;
        // Upload l√™n bucket 'slider'
        const { data, error: uploadError } = await supabase.storage.from('slider').upload(fileName, editForm.file);
        
        if (uploadError) {
             console.error("L·ªói Upload:", uploadError);
             throw new Error(`L·ªói Upload Storage: ${uploadError.message}. B·∫°n c·∫ßn ch·∫°y l·ªánh SQL c·∫•p quy·ªÅn Storage.`);
        }
        
        const { data: publicUrl } = supabase.storage.from('slider').getPublicUrl(fileName);
        imageUrl = publicUrl.publicUrl;
      }

      // 2. Insert v√†o b·∫£ng slider_data
      const newSlide = {
        loai_slider: 'slider1',
        tieu_de: editForm.title,
        mo_ta: editForm.desc,
        hinh_anh: imageUrl
      };

      const { error: insertError } = await supabase.from('slider_data').insert([newSlide]);
      
      // B·∫Øt l·ªói Permission c·ª• th·ªÉ ƒë·ªÉ th√¥ng b√°o
      if (insertError) {
          console.error("L·ªói Insert:", insertError);
          if (insertError.code === '42501' || insertError.message.includes('permission denied')) {
              throw new Error("L·ªói Quy·ªÅn (42501): B·∫°n CH∆ØA ch·∫°y l·ªánh SQL m·ªü kh√≥a b·∫£ng slider_data. Vui l√≤ng copy l·ªánh SQL ·ªü tr√™n v√† ch·∫°y trong Supabase SQL Editor.");
          }
          throw insertError;
      }

      alert("Th√™m m·ªõi th√†nh c√¥ng!");
      setIsEditing(false);
      setEditForm({ title: '', desc: '', file: null, previewUrl: '' });
      fetchSlides(); // Reload l·∫°i danh s√°ch
    } catch (err: any) {
      alert(err.message);
    } finally {
      setIsLoading(false);
    }
  };

  // Logic X√≥a Slide
  const handleDelete = async (id: number) => {
      if(!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a slide n√†y?")) return;
      const { error } = await supabase.from('slider_data').delete().eq('id', id);
      if (error) {
          alert("L·ªói x√≥a: " + error.message);
      } else {
          fetchSlides();
          if (currentIndex >= slides.length - 1) setCurrentIndex(0);
      }
  };

  return (
    <div className="relative w-full h-full group/slider flex flex-col items-center justify-center">
      
      {/* KHUNG G·ªñ CAO C·∫§P */}
      <div className="relative w-full h-full overflow-hidden rounded-lg shadow-2xl"
           style={{
               border: '12px solid #5D4037', 
               boxShadow: 'inset 0 0 20px rgba(0,0,0,0.8), 0 10px 30px rgba(0,0,0,0.5)',
               backgroundImage: 'linear-gradient(45deg, #5D4037 25%, #4E342E 25%, #4E342E 50%, #5D4037 50%, #5D4037 75%, #4E342E 75%, #4E342E 100%)',
               backgroundSize: '20px 20px' 
           }}
      >
        {/* Vi·ªÅn v√†ng trang tr√≠ */}
        <div className="absolute inset-0 border-[2px] border-[#FFD700] opacity-50 pointer-events-none z-20 m-1"></div>

        {/* N·ªòI DUNG SLIDE */}
        <div className="relative w-full h-full bg-black">
            {slides.map((slide, index) => (
            <div
                key={slide.id || index}
                className={`absolute inset-0 w-full h-full transition-opacity duration-700 ease-in-out ${index === currentIndex ? 'opacity-100 z-10' : 'opacity-0 z-0'}`}
            >
                <img src={slide.hinh_anh} alt={slide.tieu_de} className="w-full h-full object-cover opacity-80" />
                <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent" />
                
                {/* Text Content: C√≥ Stroke & Shadow */}
                <div className="absolute bottom-16 left-8 right-8 text-center md:text-left">
                    <h2 
                        className="text-3xl md:text-5xl font-serif text-[#F5F5F5] mb-2 drop-shadow-[0_4px_4px_rgba(0,0,0,1)]"
                        style={{ WebkitTextStroke: '1px rgba(0,0,0,0.5)' }}
                    >
                        {slide.tieu_de}
                    </h2>
                    <p 
                        className="text-[#E8D4B9] text-sm md:text-lg font-light drop-shadow-[0_2px_2px_rgba(0,0,0,1)]"
                    >
                        {slide.mo_ta}
                    </p>
                </div>

                {/* N√∫t X√≥a (Admin Only) */}
                {isAdmin && slide.id !== 0 && (
                    <button onClick={() => handleDelete(slide.id)} className="absolute top-4 right-4 z-50 p-2 bg-red-600/80 text-white rounded hover:bg-red-500 shadow-lg border border-white/20">
                        <Trash2 size={16}/>
                    </button>
                )}
            </div>
            ))}
        </div>

        {/* N√öT ƒêI·ªÄU H∆Ø·ªöNG */}
        <button onClick={prevSlide} className="absolute left-4 top-1/2 -translate-y-1/2 z-30 p-3 bg-black/40 border border-[#C69C6D] text-[#C69C6D] hover:bg-[#C69C6D] hover:text-black transition-all rounded-full opacity-0 group-hover/slider:opacity-100 active:scale-95">
            <ChevronLeft size={24} />
        </button>
        <button onClick={nextSlide} className="absolute right-4 top-1/2 -translate-y-1/2 z-30 p-3 bg-black/40 border border-[#C69C6D] text-[#C69C6D] hover:bg-[#C69C6D] hover:text-black transition-all rounded-full opacity-0 group-hover/slider:opacity-100 active:scale-95">
            <ChevronRight size={24} />
        </button>
      </div>

      {/* FORM ADMIN TH√äM M·ªöI */}
      {isAdmin && (
        <div className="absolute top-4 left-4 z-50">
            {!isEditing ? (
                <button onClick={() => setIsEditing(true)} className="flex items-center gap-2 bg-[#C69C6D] text-black px-4 py-2 rounded-md font-bold text-xs shadow-lg hover:bg-white transition-colors border-2 border-white/20 active:scale-95">
                    <Plus size={14}/> Th√™m Slide M·ªõi
                </button>
            ) : (
                <div className="bg-black/95 p-4 rounded-lg border border-[#C69C6D] w-[300px] shadow-[0_0_30px_rgba(0,0,0,0.8)] animate-fade-in-up backdrop-blur-md">
                    <div className="flex justify-between items-center mb-3 text-[#C69C6D] border-b border-white/10 pb-2">
                        <span className="font-bold text-sm uppercase">Th√™m Slide M·ªõi</span>
                        <button onClick={() => setIsEditing(false)} className="hover:text-white"><X size={16}/></button>
                    </div>
                    
                    <div className="space-y-3">
                        {/* Input Title */}
                        <input 
                            type="text" placeholder="Ti√™u ƒë·ªÅ ch√≠nh..." 
                            className="w-full bg-white/10 border border-white/20 rounded p-2 text-white text-xs focus:border-[#C69C6D] outline-none placeholder-white/30"
                            value={editForm.title} onChange={e => setEditForm({...editForm, title: e.target.value})}
                        />
                         {/* Input Desc */}
                        <textarea 
                            placeholder="M√¥ t·∫£ ng·∫Øn..." 
                            className="w-full bg-white/10 border border-white/20 rounded p-2 text-white text-xs focus:border-[#C69C6D] outline-none h-16 resize-none placeholder-white/30"
                            value={editForm.desc} onChange={e => setEditForm({...editForm, desc: e.target.value})}
                        />
                        {/* Input File */}
                        <div className="relative w-full h-28 border-2 border-dashed border-white/20 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-[#C69C6D] hover:bg-white/5 transition-colors overflow-hidden group/upload">
                            {editForm.previewUrl ? (
                                <img src={editForm.previewUrl} className="absolute inset-0 w-full h-full object-cover opacity-60" />
                            ) : <ImageIcon className="text-white/30 mb-1 group-hover/upload:text-[#C69C6D]"/>}
                            <span className="text-[10px] text-white/50 relative z-10 font-bold uppercase">{editForm.file ? "ƒê·ªïi ·∫£nh kh√°c" : "Ch·ªçn ·∫£nh (T·ª± n√©n)"}</span>
                            <input type="file" accept="image/*" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleFileChange} />
                        </div>

                        <button 
                            onClick={handleSave} disabled={isLoading}
                            className="w-full bg-[#C69C6D] text-black font-bold py-2.5 rounded text-xs hover:bg-white transition-colors flex justify-center items-center gap-2 disabled:opacity-50"
                        >
                            {isLoading ? "ƒêang l∆∞u..." : <><Save size={14}/> L∆ØU SLIDE</>}
                        </button>
                    </div>
                </div>
            )}
        </div>
      )}
    </div>
  );
}
</file>

<file path="trangchu/slider2.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { Star, Plus, Trash2, ShoppingCart, Loader2 } from 'lucide-react';
import { supabase } from '@/app/ThuVien/ketNoiSupabase';
import { useRouter } from 'next/navigation';

interface ProductData {
  id: string; // ƒê·ªïi sang string v√¨ UUID
  ten_vat_tu: string;
  gia_ban: number;
  hinh_anh: string;
  bo_suu_tap: string;
}

export default function Slider2() {
  const [products, setProducts] = useState<ProductData[]>([]);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [loading, setLoading] = useState(true);
  const router = useRouter();

  useEffect(() => {
    fetchProducts();
  }, []);

  // T·ª± ƒë·ªông tr∆∞·ª£t
  useEffect(() => {
    if (products.length <= 1) return;
    const timer = setInterval(() => {
      setCurrentIndex(prev => (prev === products.length - 1 ? 0 : prev + 1));
    }, 4000); // 4 gi√¢y tr∆∞·ª£t 1 l·∫ßn
    return () => clearInterval(timer);
  }, [products]);

  const fetchProducts = async () => {
    setLoading(true);
    // üëá L·∫§Y D·ªÆ LI·ªÜU T·ª™ B·∫¢NG VAT_TU (D·ªØ li·ªáu th·∫≠t)
    const { data, error } = await supabase
      .from('vat_tu')
      .select('id, ten_vat_tu, gia_ban, hinh_anh, bo_suu_tap')
      .eq('loai_vat_tu', 'thanh_pham') // Ch·ªâ l·∫•y th√†nh ph·∫©m
      .not('hinh_anh', 'is', null)     // Ch·ªâ l·∫•y c√°i n√†o c√≥ ·∫£nh
      .limit(10); // L·∫•y 10 c√°i ti√™u bi·ªÉu

    if (data) {
      setProducts(data);
    }
    setLoading(false);
  };

  const handleBuy = (id: string) => {
    router.push(`/dathang?product=${id}`);
  };

  if (loading) return <div className="h-64 flex items-center justify-center"><Loader2 className="animate-spin text-[#C69C6D]"/></div>;
  if (products.length === 0) return null;

  return (
    <div className="w-full bg-black/40 backdrop-blur-md border border-white/5 rounded-xl p-4 md:p-6 relative group/container">
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-[#C69C6D] text-sm font-bold uppercase tracking-widest flex items-center gap-2">
          <Star size={14} fill="currentColor" /> T√°c ph·∫©m ti√™u bi·ªÉu ({products.length})
        </h3>
      </div>

      {/* VIEWPORT */}
      <div className="overflow-hidden w-full rounded-lg relative">
        <div 
          className="flex transition-transform duration-700 ease-in-out will-change-transform"
          style={{ transform: `translateX(-${currentIndex * 100}%)` }}
        >
          {products.map((item) => (
            <div key={item.id} className="w-full flex-shrink-0 px-2 relative group">
              <div className="relative overflow-hidden rounded-lg aspect-video md:aspect-[21/9] border border-white/10">
                <img 
                   src={item.hinh_anh} alt={item.ten_vat_tu} 
                   className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                />
                <div className="absolute inset-0 bg-black/20 group-hover:bg-black/40 transition-colors" />
                
                {/* Text Content */}
                <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black via-black/80 to-transparent">
                  <div className="flex justify-between items-end">
                    <div>
                        <span className="text-[10px] bg-[#C69C6D] text-black px-2 py-0.5 rounded font-bold uppercase mb-1 inline-block">
                            BST {item.bo_suu_tap || 'M·ªõi'}
                        </span>
                        <h2 className="text-xl md:text-3xl font-serif text-[#F5F5F5] drop-shadow-md truncate max-w-[200px] md:max-w-md">
                            {item.ten_vat_tu}
                        </h2>
                        <p className="text-[#C69C6D] text-sm md:text-lg font-bold mt-1">
                            {new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.gia_ban)}
                        </p>
                    </div>
                    <button 
                        onClick={() => handleBuy(item.id)}
                        className="bg-white text-black p-3 rounded-full hover:bg-[#C69C6D] transition-colors shadow-lg active:scale-95"
                    >
                        <ShoppingCart size={20} />
                    </button>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>

        {/* N√∫t ƒëi·ªÅu h∆∞·ªõng ·∫£o (Click tr√°i/ph·∫£i ƒë·ªÉ chuy·ªÉn) */}
        <div className="absolute inset-y-0 left-0 w-1/4 cursor-w-resize z-10" onClick={() => setCurrentIndex((prev) => (prev === 0 ? products.length - 1 : prev - 1))}></div>
        <div className="absolute inset-y-0 right-0 w-1/4 cursor-e-resize z-10" onClick={() => setCurrentIndex((prev) => (prev === products.length - 1 ? 0 : prev + 1))}></div>
      </div>
    </div>
  );
}
</file>

<file path="types/index.ts">
// ‚úÖ User & Auth Types
export interface User {
  id: string;
  ho_ten: string;
  email: string;
  avatar_url?: string | null;
  so_dien_thoai?: string | null;
  dia_chi?: string | null;
  cccd?: string | null;
  vi_tri?: string | null;
  phan_loai?: string | null;
  userType: 'nhan_su' | 'khach_hang' | 'guest';
  role?: string;
  permissions?: string[];
}

export interface AuthSession {
  user: User | null;
  isLoading: boolean;
  error?: string | null;
}

// ‚úÖ Event Types
export interface ContentVisibilityEvent extends CustomEvent {
  detail: {
    id: string;
    open: boolean;
  };
}

// ‚úÖ Component Props Types
export interface MenuTrenProps {
  nguoiDung: User | null;
  loiChao: string;
}

export interface MenuDuoiProps {
  currentUser: User | null;
  onToggleContent: (isOpen: boolean) => void;
}

export interface NutVuongProps {
  icon: React.ComponentType<{ size?: number; className?: string }>;
  badge?: number;
  onClick?: () => void;
}

// ‚úÖ Chat Metadata Types
export interface MessageMetadata {
  edited?: boolean;
  edited_at?: string;
  pinned?: boolean;
  forwarded?: boolean;
  forwarded_from?: string;
  [key: string]: any;
}

export interface MessageAttachment {
  id: string;
  type: 'image' | 'file' | 'video' | 'audio';
  url: string;
  filename: string;
  size: number;
  mime_type?: string;
}

export interface ConversationMetadata {
  description?: string;
  avatar_url?: string;
  settings?: {
    mute_notifications?: boolean;
    archive?: boolean;
    pin?: boolean;
  };
  [key: string]: any;
}

// ‚úÖ API Response Types
export interface ApiResponse<T> {
  data: T | null;
  error: string | null;
  success: boolean;
}

// ‚úÖ Chat Types
export interface ChatMessage {
  id: string;
  conversation_id: string;
  sender_id: string;
  sender_name?: string;
  sender_email?: string;
  content: string;
  message_type: 'text' | 'image' | 'file';
  attachments?: Array<{
    id: string;
    url: string;
    type: 'image' | 'file';
    name?: string;
  }>;
  created_at: string;
  updated_at: string;
  reply_to_id?: string;
  reply_to?: ChatMessage;
  reactions?: Array<{
    id: string;
    emoji: string;
    user_id: string;
  }>;
}

export interface Order {
  id: string;
  ma_don: string;
  ten_khach: string | null;
  sdt: string | null;
  dia_chi: string | null;
  ghi_chu: string | null;
  trang_thai: 'moi' | 'dang_xu_ly' | 'dang_giao' | 'hoan_thanh' | 'huy';
  tong_tien: number;
  nguoi_tao: string;
  tao_luc: string;
  cap_nhat_luc: string;
}

export interface OrderItem {
  id: string;
  don_hang_id: string;
  ten_san_pham: string | null;
  so_luong: number;
  don_gia: number;
  thanh_tien: number;
}
</file>

</files>
