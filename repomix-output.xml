This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
app/actions/admindb.ts
app/actions/NotificationAction.ts
app/actions/QuyenHanAdmin.ts
app/actions/QuyenHanBaoCao.ts
app/actions/QuyenHanCTV.ts
app/actions/QuyenHanKeToan.ts
app/actions/QuyenHanKhachVip.ts
app/actions/QuyenHanKho.ts
app/actions/QuyenHanQuanLy.ts
app/actions/QuyenHanSales.ts
app/actions/QuyenHanSanXuat.ts
app/actions/QuyenHanThietKe.ts
app/api/fs/content/route.ts
app/api/fs/list/route.ts
app/api/fs/manager/route.ts
app/api/fs/open/route.ts
app/api/push/notify-staff/route.ts
app/api/push/subscribe/notify-staff/route.ts
app/api/push/subscribe/route.ts
app/api/push/subscribe/send/route.ts
app/api/sync-users/route.ts
app/components/cacchucnang/index.ts
app/components/cacchucnang/khachhang/config.ts
app/components/cacchucnang/khachhang/index.ts
app/components/cacchucnang/khachhang/KhachHangChucNang.tsx
app/components/cacchucnang/KhungGiaoDienChucNang/index.ts
app/components/cacchucnang/KhungGiaoDienChucNang/KhungChiTiet.tsx
app/components/cacchucnang/KhungGiaoDienChucNang/KhungDanhSach.tsx
app/components/cacchucnang/KhungGiaoDienChucNang/KhungForm.tsx
app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan.tsx
app/components/cacchucnang/KhungXuLyChucNang/index.ts
app/components/cacchucnang/KhungXuLyChucNang/useQuanLyDanhSach.ts
app/components/cacchucnang/KhungXuLyChucNang/useQuanLyForm.ts
app/components/cacchucnang/mauthietke/config.ts
app/components/cacchucnang/mauthietke/index.ts
app/components/cacchucnang/mauthietke/MauThietKeChucNang.tsx
app/components/cacchucnang/mauthietke/MauThietKeDetail.tsx
app/components/cacchucnang/mauthietke/MauThietKeForm.tsx
app/components/cacchucnang/mauthietke/MauThietKeList.tsx
app/components/cacchucnang/nhansu/config.ts
app/components/cacchucnang/nhansu/index.ts
app/components/cacchucnang/nhansu/NhanSuChucNang.tsx
app/components/cacchucnang/types.ts
app/components/cacchucnang/viecmau/config.ts
app/components/cacchucnang/viecmau/index.ts
app/components/cacchucnang/viecmau/MauThietKeChucNang.tsx
app/components/cacchucnang/viecmau/MauThietKeDetail.tsx
app/components/cacchucnang/viecmau/MauThietKeForm.tsx
app/components/cacchucnang/viecmau/MauThietKeList.tsx
app/components/ConfirmDialog.tsx
app/components/ErrorBoundary.tsx
app/components/ForceFullScreen.tsx
app/components/IOSInstallGuide.tsx
app/components/NutHoTro.tsx
app/components/PushManager.tsx
app/components/RegisterForm.tsx
app/components/StaffPresence.tsx
app/components/ThanhPhongChucNang.tsx
app/components/TuVanKhachHang.tsx
app/CongDangNhap/AuthService.ts
app/CongDangNhap/ChanForm.tsx
app/CongDangNhap/CongDangNhap.tsx
app/CongDangNhap/middleware.ts
app/CongDangNhap/page.tsx
app/CongDangNhap/RoleRedirectService.ts
app/constants/zIndex.ts
app/dashboard/admin/page.tsx
app/dathang/page.tsx
app/DuLieuBackend.md
app/favicon.ico
app/GiaoDienTong/KhungGiaoDienTong.tsx
app/GiaoDienTong/MenuSystemWrapper.tsx
app/GiaoDienTong/MenuTren/MenuTren.tsx
app/GiaoDienTong/MenuTren/NotificationCenter.tsx
app/GiaoDienTong/MenuTren/NotificationService.ts
app/GiaoDienTong/MenuTren/NotificationTypes.ts
app/GiaoDienTong/MenuTren/NutCaNhan/ChucNang.ts
app/GiaoDienTong/MenuTren/NutCaNhan/GiaoDienChiTiet.tsx
app/GiaoDienTong/MenuTren/NutCaNhan/ModalProfile.tsx
app/GiaoDienTong/MenuTren/NutCaNhan/NutCaNhan.tsx
app/globals.css
app/layout.tsx
app/Music/NhacNen.tsx
app/page.tsx
app/phongadmin/page.tsx
app/phongctv/page.tsx
app/phongketoan/page.tsx
app/phongkhachhang/page.tsx
app/phongkho/page.tsx
app/phongparttime/page.tsx
app/phongquanly/page.tsx
app/phongsales/page.tsx
app/phongthietke/page.tsx
app/phongtrungbay/page.tsx
app/QueryProvider.tsx
app/ThuVien/AppSettingsContext.tsx
app/ThuVien/compressImage.ts
app/ThuVien/DataNormalizer.ts
app/ThuVien/GoogleDich.tsx
app/ThuVien/InputValidator.ts
app/ThuVien/ketNoiSupabase.ts
app/ThuVien/KieuDuLieu.ts
app/ThuVien/LoggerService.ts
app/ThuVien/OrderService.ts
app/ThuVien/QueryTimeout.ts
app/ThuVien/UserContext.tsx
app/ThuVien/withTimeout.ts
app/trangchu/BackgroundManager.tsx
app/trangchu/NutDatHang.tsx
app/trangchu/page.tsx
app/trangchu/slider1.tsx
app/trangchu/slider2.tsx
app/types/index.ts
docs/CauLenhLayDuLieuBackEnd.md
eslint.config.mjs
next.config.mjs
package.json
postcss.config.js
public/file.svg
public/globe.svg
public/icon-192.png
public/icon-512.png
public/manifest.json
public/next.svg
public/sounds/bai-1.mp3
public/sounds/bai-2.mp3
public/sounds/bai-3.mp3
public/sounds/bai-4.mp3
public/sounds/bgm_menu.mp3
public/sounds/click.mp3
public/sounds/hover.mp3
public/sw.js
public/vercel.svg
public/window.svg
README.md
tailwind.config.ts
tsconfig.json
typeDefs.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/components/IOSInstallGuide.tsx">
"use client";
import { useState, useEffect } from "react";
import { X, Share, PlusSquare } from "lucide-react"; // Hoặc dùng icon svg nào ông có

export default function IOSInstallGuide({ isOpen, onClose }: { isOpen: boolean; onClose: () => void }) {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/60 backdrop-blur-sm sm:items-center">
      <div className="w-full max-w-md bg-zinc-900 p-6 rounded-t-2xl sm:rounded-2xl border border-zinc-800 shadow-2xl animate-in slide-in-from-bottom duration-300">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-lg font-bold text-white">Cài đặt ứng dụng</h3>
          <button onClick={onClose} className="p-1 text-zinc-400 hover:text-white">
            <X size={24} />
          </button>
        </div>
        
        <div className="space-y-4 text-zinc-300">
          <p>Để cài đặt ứng dụng lên màn hình chính iPhone/iPad:</p>
          
          <div className="flex items-center gap-3 p-3 bg-zinc-800/50 rounded-lg">
            <Share className="text-blue-500" />
            <span>1. Bấm vào nút <strong>Chia sẻ</strong> ở thanh dưới cùng.</span>
          </div>

          <div className="flex items-center gap-3 p-3 bg-zinc-800/50 rounded-lg">
            <PlusSquare className="text-white" />
            <span>2. Chọn dòng <strong>Thêm vào MH chính</strong> (Add to Home Screen).</span>
          </div>
        </div>
        
        <div className="mt-6 text-center text-sm text-zinc-500">
          Bấm xong nó sẽ hiện icon app ở màn hình chính như app thật.
        </div>
      </div>
    </div>
  );
}
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="app/actions/NotificationAction.ts">
"use server";

import postgres from "postgres";
import webPush from "web-push";

// Kết nối DB
const sql = postgres(process.env.DATABASE_URL!, { ssl: "require" });

// Cấu hình Web Push (Lấy từ biến môi trường của bạn)
if (
  !process.env.VAPID_PRIVATE_KEY ||
  !process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY
) {
  console.warn(
    "⚠️ [NotificationAction] Chưa cấu hình VAPID keys. Web Push sẽ không hoạt động."
  );
} else {
  try {
    webPush.setVapidDetails(
      process.env.VAPID_SUBJECT || "mailto:admin@nghiemart.com",
      process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY!,
      process.env.VAPID_PRIVATE_KEY!
    );
  } catch (err) {
    console.error("⚠️ [NotificationAction] Lỗi cấu hình VAPID:", err);
  }
}

/**
 * HÀM GỬI THÔNG BÁO THÔNG MINH (Centralized Notification Handler)
 * ------------------------------------------------------------------
 * @param targetRoles Danh sách role/phòng nhận tin (vd: ['admin', 'thietke', 'quanly'])
 * @param title Tiêu đề thông báo (vd: "Mẫu thiết kế mới")
 * @param message Nội dung chi tiết
 * @param url Link khi click vào (vd: '/phongthietke')
 * @param type Loại icon hiển thị (mặc định: 'system_alert')
 * @param senderName Tên người gửi (Optional, mặc định là Hệ thống)
 */
export async function sendNotificationToRoles(
  targetRoles: string[],
  title: string,
  message: string,
  url: string = "/",
  type: string = "system_alert",
  senderName: string = "Hệ thống"
) {
  try {
    // 1. CHUẨN HÓA ROLE & TÌM USER
    // Chuyển hết về chữ thường để so sánh chính xác với vi_tri_normalized
    const rolesNormalized = targetRoles.map((r) => r.toLowerCase().trim());

    // Tìm ID của những nhân sự thuộc các phòng này VÀ đang hoạt động
    // Lưu ý: Nếu muốn gửi cho tất cả nhân viên (vd: thông báo chung), truyền targetRoles = ['all']
    let users;
    if (rolesNormalized.includes("all")) {
      users =
        await sql`SELECT id FROM "nhan_su" WHERE trang_thai = 'dang_lam_viec'`;
    } else {
      users = await sql`
        SELECT id FROM "nhan_su" 
        WHERE vi_tri_normalized = ANY(${rolesNormalized})
        AND trang_thai = 'dang_lam_viec' 
        `;
    }

    if (users.length === 0) {
      return {
        success: true,
        count: 0,
        message: "Không tìm thấy người nhận phù hợp",
      };
    }

    const userIds = users.map((u) => u.id);

    // 2. LƯU VÀO DATABASE (Bảng notifications) - Để hiện chuông đỏ trên Web
    // Tạo avatar mặc định dựa trên tên người gửi
    const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(
      senderName
    )}&background=C69C6D&color=fff&size=128`;

    const notificationsToInsert = userIds.map((uid) => ({
      user_id: uid,
      type: type,
      category: "from_system",
      title: title,
      message: message,
      action_url: url,
      is_read: false,
      created_at: new Date().toISOString(),
      from_user_name: senderName,
      from_user_avatar: avatarUrl,
    }));

    // Batch Insert (Nhanh hơn insert từng dòng)
    if (notificationsToInsert.length > 0) {
      await sql`INSERT INTO "notifications" ${sql(notificationsToInsert)}`;
    }

    // 3. GỬI PUSH NOTIFICATION (Đến điện thoại/trình duyệt)
    // Tìm các thiết bị đã đăng ký nhận tin của những user này
    const subscriptions = await sql`
      SELECT * FROM "push_subscriptions" 
      WHERE user_id = ANY(${userIds})
    `;

    if (subscriptions.length > 0) {
      const payload = JSON.stringify({
        title: title,
        body: message,
        url: url,
        icon: "/icon-192.png", // Icon app
        data: { url: url }, // Dữ liệu mở rộng cho Service Worker
      });

      // Gửi song song (Promise.all)
      const pushPromises = subscriptions.map(async (sub) => {
        try {
          await webPush.sendNotification(
            {
              endpoint: sub.endpoint,
              keys: { auth: sub.auth, p256dh: sub.p256dh },
            },
            payload
          );
        } catch (err: any) {
          // Xử lý thiết bị cũ/hỏng (Lỗi 410 Gone hoặc 404 Not Found)
          if (err.statusCode === 410 || err.statusCode === 404) {
            await sql`DELETE FROM "push_subscriptions" WHERE id = ${sub.id}`;
          }
        }
      });

      // Chạy ngầm, không await để trả kết quả nhanh
      Promise.all(pushPromises).catch((err) =>
        console.error("Lỗi Push Batch:", err)
      );
    }

    return { success: true, count: userIds.length };
  } catch (error: any) {
    console.error("❌ Lỗi [sendNotificationToRoles]:", error);
    // Không throw error để tránh làm crash chức năng chính
    return { success: false, error: error.message };
  }
}
</file>

<file path="app/actions/QuyenHanBaoCao.ts">
'use server';
import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

const sql = postgres(process.env.DATABASE_URL!, { ssl: 'require' });

async function requireAuth() {
    const cookieStore = cookies();
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        { cookies: { get(name: string) { return cookieStore.get(name)?.value }, set() {}, remove() {} } }
    );
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error("Unauthorized");
    return user;
}

export async function getAdminDashboardStats() {
    try {
        await requireAuth();

        // 1. Doanh thu tháng này (Dựa vào sổ cái - THU)
        const [revenue] = await sql`
            SELECT COALESCE(SUM(so_tien), 0) as total 
            FROM "so_cai_tai_chinh" 
            WHERE loai_giao_dich = 'thu' 
            AND date_trunc('month', tao_luc) = date_trunc('month', CURRENT_DATE)
        `;

        // 2. Tổng đơn hàng hôm nay
        const [ordersToday] = await sql`
            SELECT COUNT(*) as count 
            FROM "don_hang" 
            WHERE date_trunc('day', tao_luc) = date_trunc('day', CURRENT_DATE)
        `;

        // 3. Giá trị tồn kho hiện tại (Số lượng * Giá vốn)
        const [inventoryValue] = await sql`
            SELECT COALESCE(SUM(ton_kho * gia_von), 0) as total 
            FROM "vat_tu"
        `;

        // 4. Lương tạm tính tháng này phải trả (Dựa vào nhật ký sản xuất)
        // (Tính sơ bộ: tổng điểm * 1000đ hoặc logic lương giờ, ở đây lấy sum từ bảng lương tạm)
        const [salaryPending] = await sql`
            SELECT COALESCE(SUM(tong_thu_nhap), 0) as total 
            FROM "bang_luong" 
            WHERE thang = EXTRACT(MONTH FROM CURRENT_DATE)
        `;

        return {
            success: true,
            data: {
                revenueMonth: Number(revenue.total),
                ordersToday: Number(ordersToday.count),
                inventoryValue: Number(inventoryValue.total),
                salaryPending: Number(salaryPending.total)
            }
        };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// Lấy 10 hoạt động gần nhất của hệ thống
export async function getRecentActivities() {
    try {
        await requireAuth();
        const data = await sql`
            SELECT 'don_hang' as type, ma_don as ref, ('Đơn hàng mới: ' || tong_tien) as content, tao_luc FROM "don_hang"
            UNION ALL
            SELECT 'san_xuat' as type, ma_lenh as ref, 'Lệnh SX hoàn thành' as content, ket_thuc_luc as tao_luc FROM "lenh_san_xuat" WHERE trang_thai = 'hoan_thanh'
            UNION ALL
            SELECT 'tai_chinh' as type, substring(id::text, 1, 8) as ref, (loai_giao_dich || ': ' || so_tien) as content, tao_luc FROM "so_cai_tai_chinh"
            ORDER BY tao_luc DESC
            LIMIT 10
        `;
        return { success: true, data: Array.from(data) };
    } catch (error: any) { return { success: false, error: error.message }; }
}
</file>

<file path="app/actions/QuyenHanCTV.ts">
'use server';
import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

const sql = postgres(process.env.DATABASE_URL!, { ssl: 'require' });

async function requireAuth() {
    const cookieStore = cookies();
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        { cookies: { get(name: string) { return cookieStore.get(name)?.value }, set() {}, remove() {} } }
    );
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error("Unauthorized");
    return user;
}

// 1. LẤY THỐNG KÊ HOA HỒNG (Dashboard)
export async function getCTVStatsAction() {
    try {
        const user = await requireAuth();
        
        // Tính tổng đơn hàng mà CTV này giới thiệu (nguoi_tao_id là CTV)
        // Giả sử hoa hồng cứng là 10% (Boss có thể chỉnh sau)
        const [stats] = await sql`
            SELECT 
                COUNT(*) as total_orders,
                COALESCE(SUM(tong_tien), 0) as total_revenue,
                COALESCE(SUM(CASE WHEN trang_thai = 'hoan_thanh' THEN tong_tien ELSE 0 END), 0) * 0.1 as commission_earned
            FROM "don_hang"
            WHERE nguoi_tao_id = ${user.id}
        `;
        
        return { success: true, data: stats };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 2. LẤY SẢN PHẨM ĐỂ BÁN (Kèm link ảnh để đăng bài)
export async function getCTVProductsAction() {
    try {
        await requireAuth();
        const data = await sql`
            SELECT id, ten_vat_tu, gia_ban, hinh_anh, ton_kho, bo_suu_tap
            FROM "vat_tu"
            WHERE loai_vat_tu = 'thanh_pham' AND ton_kho > 0
            ORDER BY ten_vat_tu ASC
        `;
        return { success: true, data: Array.from(data) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 3. CTV TẠO ĐƠN (Giản lược hơn Sales POS)
export async function createCTVOrderAction(data: any) {
    try {
        const user = await requireAuth();
        
        // Tạo khách hàng mới nếu chưa có (CTV thường bán cho khách lạ)
        let khachId = data.khach_hang_id;
        if (!khachId && data.khach_moi) {
            const [newCust] = await sql`
                INSERT INTO "khach_hang" (ho_ten, so_dien_thoai, dia_chi, phan_loai, phan_loai_normalized, nguoi_gioi_thieu_id)
                VALUES (${data.khach_moi.ho_ten}, ${data.khach_moi.sdt}, ${data.khach_moi.dia_chi}, 'Khách CTV', 'moi', ${user.id})
                RETURNING id
            `;
            khachId = newCust.id;
        }

        // Tạo đơn hàng
        const [newOrder] = await sql`
            INSERT INTO "don_hang" (
                khach_hang_id, nguoi_tao_id, sales_phu_trach_id, 
                trang_thai, tong_tien, da_thanh_toan, kenh_ban_hang, ghi_chu
            ) VALUES (
                ${khachId}, ${user.id}, ${user.id}, -- CTV tự là sales phụ trách ban đầu
                'moi', ${data.tong_tien}, 0, 'ctv', ${data.ghi_chu}
            ) RETURNING id, ma_don
        `;

        // Tạo chi tiết
        for (const item of data.items) {
            await sql`
                INSERT INTO "don_hang_chi_tiet" (
                    don_hang_id, vat_tu_id, ten_item_hien_thi, so_luong, don_gia
                ) VALUES (
                    ${newOrder.id}, ${item.id}, ${item.ten_vat_tu}, ${item.so_luong}, ${item.don_gia}
                )
            `;
        }

        return { success: true, ma_don: newOrder.ma_don };
    } catch (error: any) { return { success: false, error: error.message }; }
}
</file>

<file path="app/actions/QuyenHanKhachVip.ts">

</file>

<file path="app/actions/QuyenHanKho.ts">
'use server';
import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

const sql = postgres(process.env.DATABASE_URL!, { ssl: 'require' });

// Hàm check quyền (Clone từ QuyenHanQuanLy)
async function requireAuth() {
    const cookieStore = cookies();
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        { cookies: { get(name: string) { return cookieStore.get(name)?.value }, set() {}, remove() {} } }
    );
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error("Unauthorized");
    return user;
}

// --- QUẢN LÝ VẬT TƯ ---
export async function getVatTuDataAction(page: number, pageSize: number, search: string, filterGroup: string) {
    try {
        await requireAuth();
        let query = `SELECT * FROM "vat_tu" WHERE 1=1`;
        const params: any[] = [];
        let paramCount = 1;

        if (search) {
            query += ` AND (ten_vat_tu ILIKE $${paramCount} OR ma_sku ILIKE $${paramCount})`;
            params.push(`%${search}%`);
            paramCount++;
        }

        // Lọc theo loại (Nguyên liệu / Thành phẩm)
        if (filterGroup && filterGroup !== 'all') {
            query += ` AND loai_vat_tu = $${paramCount}`;
            params.push(filterGroup);
            paramCount++;
        }

        const countQuery = query.replace('SELECT *', 'SELECT count(*) as total');
        const offset = (page - 1) * pageSize;
        query += ` ORDER BY ton_kho ASC, ten_vat_tu ASC LIMIT ${pageSize} OFFSET ${offset}`; // Ưu tiên hiện hàng sắp hết

        const data = await sql.unsafe(query, params);
        const [countResult] = await sql.unsafe(countQuery, params);

        return { success: true, data: Array.from(data), total: Number(countResult.total) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

export async function createVatTuAction(data: any) {
    try {
        await requireAuth();
        await sql.unsafe(`
            INSERT INTO "vat_tu" (ma_sku, ten_vat_tu, loai_vat_tu, don_vi_tinh, gia_von, gia_ban, ton_kho, canh_bao_toi_thieu, hinh_anh)
            VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
        `, [
            data.ma_sku, data.ten_vat_tu, data.loai_vat_tu, data.don_vi_tinh,
            data.gia_von || 0, data.gia_ban || 0, data.ton_kho || 0, data.canh_bao_toi_thieu || 10,
            data.hinh_anh
        ]);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

export async function updateVatTuAction(id: string, data: any) {
    try {
        await requireAuth();
        await sql.unsafe(`
            UPDATE "vat_tu"
            SET ma_sku = $1, ten_vat_tu = $2, loai_vat_tu = $3, don_vi_tinh = $4,
                gia_von = $5, gia_ban = $6, ton_kho = $7, canh_bao_toi_thieu = $8, hinh_anh = $9
            WHERE id = $10
        `, [
            data.ma_sku, data.ten_vat_tu, data.loai_vat_tu, data.don_vi_tinh,
            data.gia_von, data.gia_ban, data.ton_kho, data.canh_bao_toi_thieu,
            data.hinh_anh, id
        ]);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

export async function deleteVatTuAction(id: string) {
    try {
        await requireAuth();
        await sql.unsafe(`DELETE FROM "vat_tu" WHERE id = $1`, [id]);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}
</file>

<file path="app/api/fs/list/route.ts">
import { NextResponse } from 'next/server';
import fs from 'fs';
import path from 'path';

// Hàm đệ quy quét file
const getFiles = (dir: string, fileList: string[] = [], rootDir: string) => {
    const files = fs.readdirSync(dir);

    files.forEach((file) => {
        const filePath = path.join(dir, file);
        const stat = fs.statSync(filePath);

        // Bỏ qua các thư mục rác hệ thống
        if (file === 'node_modules' || file === '.next' || file === '.git' || file === '.vscode') {
            return;
        }

        if (stat.isDirectory()) {
            getFiles(filePath, fileList, rootDir);
        } else {
            // Chỉ lấy đường dẫn tương đối để hiển thị cho đẹp
            // Ví dụ: app/page.tsx thay vì C:/Users/.../app/page.tsx
            const relativePath = path.relative(rootDir, filePath).replace(/\\/g, '/');
            fileList.push(relativePath);
        }
    });

    return fileList;
};

export async function GET() {
    try {
        const rootDir = process.cwd(); // Lấy thư mục gốc của dự án
        const files = getFiles(rootDir, [], rootDir);
        return NextResponse.json({ files });
    } catch (error) {
        return NextResponse.json({ error: 'Lỗi đọc file hệ thống' }, { status: 500 });
    }
}
</file>

<file path="app/api/push/notify-staff/route.ts">
import { createClient } from "@supabase/supabase-js";
import { NextResponse } from "next/server";

// Khởi tạo Supabase Admin (Quyền tối cao để ghi thông báo cho người khác)
const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY! // Lưu ý: Cần biến môi trường này trong .env.local
);

export async function POST(req: Request) {
  try {
    const body = await req.json();
    const { title, body: message, url, sessionId, targetStaffId } = body;

    // 1. XÁC ĐỊNH NGƯỜI NHẬN
    let targetIds: string[] = [];

    if (targetStaffId) {
      // A. Nếu đã chỉ định đích danh (VD: Khách cũ nhắn cho Sales phụ trách)
      targetIds = [targetStaffId];
    } else {
      // B. Nếu không chỉ định (VD: Khách mới, Đăng ký mới) -> Gửi cho toàn bộ Admin/Sales/Quản lý
      // Lấy danh sách nhân viên đang làm việc có role phù hợp
      const { data: staff } = await supabaseAdmin
        .from("nhan_su")
        .select("id")
        .eq("trang_thai", "dang_lam_viec")
        .in("vi_tri_normalized", ["admin", "quanly", "sales"]);

      if (staff) {
        targetIds = staff.map((s) => s.id);
      }
    }

    if (targetIds.length === 0) {
      return NextResponse.json(
        { message: "Không tìm thấy nhân viên nào để báo" },
        { status: 200 }
      );
    }

    // 2. TẠO DỮ LIỆU THÔNG BÁO (Chuẩn bị insert vào DB)
    const notificationsToInsert = targetIds.map((userId) => ({
      user_id: userId,
      type: "system_alert", // Loại thông báo
      category: sessionId ? "chat" : "system", // Phân loại
      title: title,
      message: message,
      action_url: url,
      related_id: sessionId || null,
      is_read: false,
      from_user_name: "Hệ thống",
      from_user_avatar:
        "https://ui-avatars.com/api/?name=System&background=C69C6D&color=fff",
    }));

    // 3. LƯU VÀO BẢNG notifications
    const { error } = await supabaseAdmin
      .from("notifications")
      .insert(notificationsToInsert);

    if (error) {
      console.error("Lỗi lưu thông báo:", error);
      return NextResponse.json({ error: error.message }, { status: 500 });
    }

    // --- (NÂNG CAO) PHẦN BẮN WEB PUSH (Nếu mày có cài thư viện web-push) ---
    // Phần này để mở rộng sau: Duyệt qua bảng push_subscriptions và bắn tin tới trình duyệt
    // ...

    return NextResponse.json({ success: true, count: targetIds.length });
  } catch (err: any) {
    console.error("API Error:", err);
    return NextResponse.json(
      { error: "Internal Server Error" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/push/subscribe/notify-staff/route.ts">
import { NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";
import webPush from "web-push";

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

webPush.setVapidDetails(
  process.env.VAPID_SUBJECT!,
  process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY!,
  process.env.VAPID_PRIVATE_KEY!
);

export async function POST(req: Request) {
  try {
    const { title, body, url } = await req.json();

    // 1. Lấy danh sách ID của nhân sự có quyền Sales/Admin/Quản lý
    const { data: staffList } = await supabase
      .from("nhan_su")
      .select("id")
      .in("vi_tri_normalized", ["admin", "boss", "quanly", "sales"]);

    if (!staffList || staffList.length === 0) {
      return NextResponse.json({ message: "No staff found" });
    }

    const staffIds = staffList.map((s) => s.id);

    // 2. Lấy các thiết bị đã đăng ký Push của những nhân sự này
    const { data: subs } = await supabase
      .from("push_subscriptions")
      .select("*")
      .in("user_id", staffIds);

    if (!subs || subs.length === 0) {
      return NextResponse.json({ message: "No subscriptions found" });
    }

    // 3. Gửi thông báo hàng loạt
    const payload = JSON.stringify({
      title: title || "Khách hàng mới!",
      body: body || "Có khách hàng đang cần tư vấn.",
      url: url || "/phongsales",
    });

    const promises = subs.map((sub) => {
      const pushConfig = {
        endpoint: sub.endpoint,
        keys: { auth: sub.auth, p256dh: sub.p256dh },
      };
      return webPush.sendNotification(pushConfig, payload).catch((err) => {
        if (err.statusCode === 410 || err.statusCode === 404) {
          supabase.from("push_subscriptions").delete().eq("id", sub.id).then();
        }
      });
    });

    await Promise.all(promises);

    return NextResponse.json({ success: true, count: subs.length });
  } catch (error: any) {
    console.error("Notify Staff Error:", error);
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}
</file>

<file path="app/api/push/subscribe/route.ts">
import { NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY! // Dùng Service Key để bypass RLS nếu cần
);

export async function POST(req: Request) {
    try {
        const { subscription, user_id, user_agent } = await req.json();

        if (!subscription || !subscription.endpoint || !user_id) {
            return NextResponse.json({ error: 'Missing data' }, { status: 400 });
        }

        // Lưu vào DB
        const { error } = await supabase.from('push_subscriptions').upsert({
            user_id,
            endpoint: subscription.endpoint,
            p256dh: subscription.keys.p256dh,
            auth: subscription.keys.auth,
            user_agent: user_agent,
            created_at: new Date().toISOString()
        }, { onConflict: 'user_id, endpoint' });

        if (error) throw error;

        return NextResponse.json({ success: true });
    } catch (error: any) {
        console.error('Subscribe Error:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="app/api/push/subscribe/send/route.ts">
import { NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import webPush from 'web-push';

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

// Cấu hình Web Push
webPush.setVapidDetails(
    process.env.VAPID_SUBJECT!,
    process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY!,
    process.env.VAPID_PRIVATE_KEY!
);

export async function POST(req: Request) {
    try {
        // userId: Người nhận, title: Tiêu đề, body: Nội dung, url: Link đích
        const { userId, title, body, url } = await req.json();

        // 1. Lấy danh sách thiết bị của User đó
        const { data: subs } = await supabase
            .from('push_subscriptions')
            .select('*')
            .eq('user_id', userId);

        if (!subs || subs.length === 0) {
            return NextResponse.json({ message: 'User has no subscriptions' });
        }

        // 2. Gửi thông báo đến TẤT CẢ thiết bị của họ
        const notifications = subs.map(sub => {
            const pushConfig = {
                endpoint: sub.endpoint,
                keys: { auth: sub.auth, p256dh: sub.p256dh }
            };
            const payload = JSON.stringify({ title, body, url });

            return webPush.sendNotification(pushConfig, payload).catch(err => {
                if (err.statusCode === 410 || err.statusCode === 404) {
                    // Thiết bị đã hủy đăng ký hoặc lỗi -> Xóa khỏi DB cho sạch
                    console.log('Subscription expired, deleting from DB:', sub.id);
                    supabase.from('push_subscriptions').delete().eq('id', sub.id).then();
                }
            });
        });

        await Promise.all(notifications);

        return NextResponse.json({ success: true, count: subs.length });
    } catch (error: any) {
        console.error('Push Error:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="app/components/cacchucnang/khachhang/config.ts">
/**
 * ============================================================
 * CHỨC NĂNG: KHÁCH HÀNG
 * Đường dẫn: phongchuan/cacchucnang/khachhang
 * ============================================================
 * 
 * Chức năng quản lý khách hàng dùng chung cho nhiều phòng.
 * Mỗi phòng gọi ra với quyền khác nhau thông qua props.
 * 
 * QUYỀN HẠN:
 * - allowView: Xem danh sách và chi tiết
 * - allowEdit: Sửa thông tin
 * - allowDelete: Xóa khách hàng
 * - allowBulk: Thao tác hàng loạt
 * 
 * SỬ DỤNG:
 * import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
 * <KhachHangChucNang permissions={{ allowDelete: true }} />
 */

import { Phone, Mail, MapPin, User } from 'lucide-react';
import { ManagerConfig, FieldConfig, FilterTabConfig, TabConfig } from '../types';
import { 
    getKhachHangDataAction, 
    createKhachHangAction, 
    updateKhachHangAction, 
    deleteKhachHangAction 
} from '@/app/actions/QuyenHanQuanLy';

// ============================================================
// INTERFACE
// ============================================================

export interface KhachHang {
    id: string;
    ho_ten: string;
    so_dien_thoai?: string;
    email?: string;
    dia_chi?: string;
    phan_loai?: string;
    phan_loai_normalized?: string;
    hinh_anh?: string;
    ghi_chu?: string;
    tong_don_hang?: number;
    tao_luc?: string;
    cap_nhat_luc?: string;
}

export interface KhachHangPermissions {
    allowView?: boolean;
    allowEdit?: boolean;
    allowDelete?: boolean;
    allowBulk?: boolean;
}

// ============================================================
// CONSTANTS
// ============================================================

export const PHAN_LOAI_OPTIONS = [
    'Tiềm năng',
    'Mới',
    'Thân thiết',
    'VIP',
    'Không hoạt động',
];

// ============================================================
// FIELDS CONFIG
// ============================================================

const fields: FieldConfig[] = [
    {
        key: 'hinh_anh',
        label: 'Ảnh đại diện',
        type: 'image',
        showInForm: true,
        showInDetail: false,
        showInCard: true,
    },
    {
        key: 'ho_ten',
        label: 'Họ và Tên',
        type: 'text',
        placeholder: 'Nhập họ tên đầy đủ...',
        required: true,
    },
    {
        key: 'so_dien_thoai',
        label: 'Số điện thoại',
        type: 'phone',
        placeholder: '09xxxxxxxxx',
        required: true,
        icon: Phone,
    },
    {
        key: 'email',
        label: 'Email',
        type: 'email',
        placeholder: 'email@example.com',
        icon: Mail,
        colSpan: 2,
    },
    {
        key: 'dia_chi',
        label: 'Địa chỉ',
        type: 'textarea',
        placeholder: 'Nhập địa chỉ...',
        icon: MapPin,
        colSpan: 2,
    },
    {
        key: 'phan_loai',
        label: 'Phân loại',
        type: 'select',
        options: PHAN_LOAI_OPTIONS,
    },
    {
        key: 'ghi_chu',
        label: 'Ghi chú',
        type: 'textarea',
        placeholder: 'Ghi chú thêm...',
        colSpan: 2,
    },
];

// ============================================================
// FILTER TABS
// ============================================================

const filterTabs: FilterTabConfig[] = [
    { id: 'tiemnang', label: 'TIỀM NĂNG', filterField: 'phan_loai_normalized' },
    { id: 'moi', label: 'MỚI', filterField: 'phan_loai_normalized' },
    { id: 'thanthiet', label: 'THÂN THIẾT', filterField: 'phan_loai_normalized' },
    { id: 'vip', label: 'VIP', filterField: 'phan_loai_normalized' },
    { id: 'khonghoatdong', label: 'KHÔNG HĐ', filterField: 'phan_loai_normalized' },
];

// ============================================================
// DETAIL TABS
// ============================================================

const detailTabs: TabConfig[] = [
    { id: 'thongtin', label: 'THÔNG TIN' },
    { id: 'donhang', label: 'ĐƠN HÀNG', searchable: true, sortable: true },
    { id: 'ghichu', label: 'GHI CHÚ' },
];

// ============================================================
// DATA SOURCE
// ============================================================

const dataSource = {
    fetchList: async (page: number, limit: number, search: string, filter: string) => {
        const res = await getKhachHangDataAction(page, limit, search, filter);
        return { success: res.success, data: res.data as KhachHang[] | undefined, error: res.error };
    },
    create: async (data: Partial<KhachHang>) => {
        if (data.phan_loai) {
            (data as any).phan_loai_normalized = data.phan_loai.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "").toLowerCase();
        }
        const res = await createKhachHangAction(data as any);
        return { success: res.success, data: (res as any).data as KhachHang, error: res.error };
    },
    update: async (id: string, data: Partial<KhachHang>) => {
        if (data.phan_loai) {
            (data as any).phan_loai_normalized = data.phan_loai.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "").toLowerCase();
        }
        const res = await updateKhachHangAction(id, data as any);
        return { success: res.success, data: (res as any).data as KhachHang, error: res.error };
    },
    delete: async (id: string) => {
        const res = await deleteKhachHangAction(id);
        return { success: res.success, error: res.error };
    },
};

// ============================================================
// CREATE CONFIG FUNCTION
// ============================================================

export function createKhachHangConfig(permissions: KhachHangPermissions = {}): ManagerConfig<KhachHang> {
    const { 
        allowView = true, 
        allowEdit = true, 
        allowDelete = false, 
        allowBulk = false 
    } = permissions;

    return {
        entityName: 'khách hàng',
        entityNamePlural: 'khách hàng',
        idField: 'id',
        fields,
        cardConfig: {
            avatarField: 'hinh_anh',
            titleField: 'ho_ten',
            subtitleField: 'phan_loai',
            infoFields: [{ field: 'so_dien_thoai', icon: Phone }],
        },
        filterTabs,
        detailTabs,
        actions: {
            allowView,
            allowEdit,
            allowDelete,
            allowBulkSelect: allowBulk,
            allowBulkDelete: allowBulk && allowDelete,
        },
        dataSource,
        searchFields: ['ho_ten', 'so_dien_thoai', 'email'],
        sortOptions: [
            { key: 'name', label: 'TÊN', sortFn: (a: KhachHang, b: KhachHang) => (a.ho_ten || '').localeCompare(b.ho_ten || '') },
            { key: 'phanloai', label: 'PHÂN LOẠI', sortFn: (a: KhachHang, b: KhachHang) => (a.phan_loai || '').localeCompare(b.phan_loai || '') },
            { key: 'ngay', label: 'NGÀY TẠO', sortFn: (a: KhachHang, b: KhachHang) => new Date(b.tao_luc || 0).getTime() - new Date(a.tao_luc || 0).getTime() },
        ],
        defaultSort: 'name',
        uploadConfig: { bucket: 'avatar', fileNamePrefix: 'kh' },
    };
}
</file>

<file path="app/components/cacchucnang/khachhang/index.ts">
export { default as KhachHangChucNang } from './KhachHangChucNang';
export { createKhachHangConfig, PHAN_LOAI_OPTIONS } from './config';
export type { KhachHang, KhachHangPermissions } from './config';
</file>

<file path="app/components/cacchucnang/KhungGiaoDienChucNang/index.ts">
/**
 * ============================================================
 * KHUNG GIAO DIỆN
 * ============================================================
 * 
 * Bộ khung UI chuẩn cho toàn bộ ứng dụng.
 * Tất cả đều là INLINE PANEL (không phải modal popup).
 * 
 * COMPONENTS:
 * - KhungDanhSach: Tab bar ngang + Cards + Search/Sort/Bulk
 * - KhungChiTiet: Tab bar ngang + Chi tiết inline
 * - KhungForm: Tab bar ngang + Form inline
 * 
 * STYLE CHUNG:
 * - Tab bar: h-[40px], bg-[#0a0a0a], border-b border-white/5
 * - Tabs: px-2 py-1, text-[10px] font-bold uppercase
 * - Actions: shrink-0 border-l, icon buttons p-1.5
 * 
 * SỬ DỤNG:
 * import { KhungDanhSach, KhungChiTiet, KhungForm } from '@/app/components/KhungGiaoDien';
 */

export { default as KhungDanhSach } from './KhungDanhSach';
export { default as KhungChiTiet } from './KhungChiTiet';
export { default as KhungForm } from './KhungForm';

// Export types
export type { KhungDanhSachProps, TabItem as DanhSachTabItem, SortOption, BulkAction } from './KhungDanhSach';
export type { KhungChiTietProps, TabItem as ChiTietTabItem } from './KhungChiTiet';
export type { KhungFormProps } from './KhungForm';
</file>

<file path="app/components/cacchucnang/KhungGiaoDienChucNang/KhungChiTiet.tsx">
"use client";

/**
 * ============================================================
 * KHUNG CHI TIẾT (COMPACT & CLEAN TABS)
 * ============================================================
 * * Update UI:
 * - Row 1 Height: 45px (Compact Header)
 * - Row 2 Height: 40px (Compact Tabs)
 * - Tabs Style: Text-only (No background buttons), simple underline.
 */

import React, { ReactNode, useState } from "react";
import {
  X,
  User,
  Edit3,
  Trash2,
  Loader2,
  Search,
  ArrowUpDown,
} from "lucide-react";

// ============================================================
// TYPES
// ============================================================

export interface TabItem {
  id: string;
  label: string;
  icon?: React.ElementType;
  count?: number;
  searchable?: boolean;
  sortable?: boolean;
  sortOptions?: { key: string; label: string }[];
  showAddButton?: boolean;
}

export interface KhungChiTietProps {
  data: any;
  onClose: () => void;
  avatar?: string;
  avatarFallback?: ReactNode;
  title?: string;
  tabs?: TabItem[];
  activeTab?: string;
  onTabChange?: (tabId: string) => void;
  tabCounts?: Record<string, number>;
  searchTerm?: string;
  onSearch?: (term: string) => void;
  sortBy?: string;
  onSortChange?: (sortKey: string) => void;
  onAddInTab?: () => void;
  showEditButton?: boolean;
  showDeleteButton?: boolean;
  onEdit?: () => void;
  onDelete?: () => void;
  deleting?: boolean;
  children: ReactNode;
  className?: string;
}

// ============================================================
// COMPONENT
// ============================================================

export default function KhungChiTiet({
  data,
  onClose,
  avatar,
  avatarFallback,
  title,
  tabs = [],
  activeTab,
  onTabChange,
  tabCounts = {},
  searchTerm = "",
  onSearch,
  sortBy,
  onSortChange,
  onAddInTab,
  showEditButton = true,
  showDeleteButton = false,
  onEdit,
  onDelete,
  deleting = false,
  children,
  className = "",
}: KhungChiTietProps) {
  const [showSearch, setShowSearch] = useState(false);
  const [localSearchTerm, setLocalSearchTerm] = useState(searchTerm);
  const [showSortMenu, setShowSortMenu] = useState(false);

  // Swipe gesture states
  const [touchStartX, setTouchStartX] = useState<number | null>(null);
  const [touchEndX, setTouchEndX] = useState<number | null>(null);
  const minSwipeDistance = 50;

  if (!data) return null;

  const currentTabConfig = tabs.find((t) => t.id === activeTab);
  const TAB_IDS = tabs.map((t) => t.id);

  // Swipe handlers
  const handleTouchStart = (e: React.TouchEvent) => {
    setTouchEndX(null);
    setTouchStartX(e.targetTouches[0].clientX);
  };

  const handleTouchMove = (e: React.TouchEvent) => {
    setTouchEndX(e.targetTouches[0].clientX);
  };

  const handleTouchEnd = () => {
    if (!touchStartX || !touchEndX || !onTabChange) return;
    const distance = touchStartX - touchEndX;
    const isLeftSwipe = distance > minSwipeDistance;
    const isRightSwipe = distance < -minSwipeDistance;
    const currentIndex = TAB_IDS.indexOf(activeTab || "");

    if (isLeftSwipe && currentIndex < TAB_IDS.length - 1) {
      onTabChange(TAB_IDS[currentIndex + 1]);
    } else if (isRightSwipe && currentIndex > 0) {
      onTabChange(TAB_IDS[currentIndex - 1]);
    }
    setTouchStartX(null);
    setTouchEndX(null);
  };

  const handleSearch = (value: string) => {
    setLocalSearchTerm(value);
    onSearch?.(value);
  };

  return (
    <div
      className={`w-full h-full flex flex-col bg-[#050505] overflow-hidden ${className}`}
    >
      {/* ====== HEADER CONTAINER ====== */}
      <div className="shrink-0 flex flex-col bg-[#0a0a0a] border-b border-white/5 z-20 shadow-sm">
        {/* --- ROW 1: INFO & ACTIONS (Height reduced to 45px) --- */}
        <div className="flex items-center justify-between px-4 h-[45px] border-b border-white/5">
          {/* LEFT: Avatar + Title */}
          <div className="flex items-center gap-3 min-w-0">
            {/* Avatar nhỏ hơn chút (w-8 h-8) để hợp với thanh h-45 */}
            <div className="w-8 h-8 rounded-full border border-[#C69C6D]/30 overflow-hidden bg-[#1a1a1a] shrink-0 p-0.5 shadow-lg shadow-[#C69C6D]/5">
              {avatar ? (
                <img
                  src={avatar}
                  alt=""
                  className="w-full h-full object-cover rounded-full"
                />
              ) : (
                <div className="w-full h-full flex items-center justify-center bg-[#151515] rounded-full">
                  {avatarFallback || (
                    <User size={14} className="text-[#C69C6D]/50" />
                  )}
                </div>
              )}
            </div>
            <div className="min-w-0">
              <h2 className="text-sm font-black text-white uppercase tracking-wide truncate leading-tight">
                {title || "---"}
              </h2>
            </div>
          </div>

          {/* RIGHT: Global Actions */}
          <div className="flex items-center gap-1 shrink-0 ml-4">
            {showEditButton && onEdit && (
              <button
                onClick={onEdit}
                className="p-1.5 hover:text-[#C69C6D] text-gray-400 transition-all"
                title="Chỉnh sửa"
              >
                <Edit3 size={16} />
              </button>
            )}

            {showDeleteButton && onDelete && (
              <button
                onClick={onDelete}
                disabled={deleting}
                className="p-1.5 hover:text-red-500 text-gray-400 disabled:opacity-50 transition-all"
                title="Xóa"
              >
                {deleting ? (
                  <Loader2 size={16} className="animate-spin" />
                ) : (
                  <Trash2 size={16} />
                )}
              </button>
            )}

            <div className="w-[1px] h-4 bg-white/10 mx-1"></div>

            <button
              onClick={onClose}
              className="p-1.5 hover:text-white text-gray-400 transition-all"
            >
              <X size={18} />
            </button>
          </div>
        </div>

        {/* --- ROW 2: CLEAN TABS (Height reduced to 40px) --- */}
        <div className="flex items-center justify-between h-[40px] px-2 relative">
          {/* Spacer Left */}
          <div className="w-[60px] shrink-0 hidden md:block"></div>

          {/* CENTER: Simple Text Tabs */}
          <div className="flex-1 flex items-center justify-center gap-6 h-full overflow-x-auto scrollbar-hide">
            <style jsx>{`
              .scrollbar-hide::-webkit-scrollbar {
                display: none;
              }
              .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
              }
            `}</style>
            {tabs.map((tab) => (
              <button
                key={tab.id}
                onClick={() => onTabChange?.(tab.id)}
                className={`relative h-full flex items-center gap-2 px-1 text-[10px] font-bold uppercase tracking-widest transition-all whitespace-nowrap group
                  ${
                    activeTab === tab.id
                      ? "text-[#C69C6D]"
                      : "text-gray-500 hover:text-white"
                  }
                `}
              >
                {tab.label}
                {(tabCounts[tab.id] !== undefined ||
                  tab.count !== undefined) && (
                  <span
                    className={`text-[9px] ${
                      activeTab === tab.id
                        ? "text-[#C69C6D]"
                        : "text-gray-600 group-hover:text-gray-400"
                    }`}
                  >
                    ({tabCounts[tab.id] ?? tab.count ?? 0})
                  </span>
                )}

                {/* Active Indicator Line (Simple Underline) */}
                {activeTab === tab.id && (
                  <div className="absolute bottom-0 left-0 right-0 h-[2px] bg-[#C69C6D] shadow-[0_0_8px_#C69C6D]" />
                )}
              </button>
            ))}
          </div>

          {/* RIGHT: Search & Sort Tools */}
          <div className="w-[60px] shrink-0 flex items-center justify-end gap-1">
            {currentTabConfig?.searchable && onSearch && (
              <div className="relative flex items-center">
                {showSearch ? (
                  <div className="absolute right-0 top-1/2 -translate-y-1/2 flex items-center bg-[#1a1a1a] border border-white/20 rounded z-10 animate-in slide-in-from-right-5 shadow-xl">
                    <input
                      autoFocus
                      type="text"
                      placeholder="Tìm..."
                      value={localSearchTerm}
                      onChange={(e) => handleSearch(e.target.value)}
                      className="w-24 bg-transparent pl-2 pr-5 py-1 text-[10px] text-white placeholder:text-white/20 focus:outline-none"
                    />
                    <button
                      onClick={() => {
                        setShowSearch(false);
                        handleSearch("");
                      }}
                      className="absolute right-1 p-0.5 text-white/40 hover:text-white"
                    >
                      <X size={10} />
                    </button>
                  </div>
                ) : (
                  <button
                    onClick={() => setShowSearch(true)}
                    className="p-1.5 text-gray-500 hover:text-white transition-all"
                  >
                    <Search size={14} />
                  </button>
                )}
              </div>
            )}

            {currentTabConfig?.sortable &&
              currentTabConfig.sortOptions &&
              onSortChange && (
                <div className="relative">
                  <button
                    onClick={() => setShowSortMenu(!showSortMenu)}
                    className="p-1.5 text-gray-500 hover:text-white transition-all"
                  >
                    <ArrowUpDown size={14} />
                  </button>
                  {showSortMenu && (
                    <>
                      <div
                        className="fixed inset-0 z-40"
                        onClick={() => setShowSortMenu(false)}
                      />
                      <div className="absolute top-full mt-1 right-0 bg-[#1a1a1a] border border-white/10 rounded shadow-xl z-[100] min-w-[100px] overflow-hidden">
                        {currentTabConfig.sortOptions.map((opt) => (
                          <button
                            key={opt.key}
                            onClick={() => {
                              onSortChange(opt.key);
                              setShowSortMenu(false);
                            }}
                            className={`w-full text-left px-3 py-2 text-[9px] font-bold border-b border-white/5 last:border-0 ${
                              sortBy === opt.key
                                ? "text-[#C69C6D]"
                                : "text-gray-400 hover:text-white hover:bg-white/5"
                            }`}
                          >
                            {opt.label}
                          </button>
                        ))}
                      </div>
                    </>
                  )}
                </div>
              )}
          </div>
        </div>
      </div>

      {/* ====== CONTENT AREA ====== */}
      <div
        className="flex-1 overflow-y-auto custom-scrollbar bg-[#050505]"
        onTouchStart={handleTouchStart}
        onTouchMove={handleTouchMove}
        onTouchEnd={handleTouchEnd}
      >
        {children}
      </div>
    </div>
  );
}
</file>

<file path="app/components/cacchucnang/KhungGiaoDienChucNang/KhungDanhSach.tsx">
"use client";

/**
 * ============================================================
 * KHUNG DANH SÁCH
 * ============================================================
 *
 * Khung giao diện chuẩn cho trang danh sách.
 * Style: Tab bar ngang + Actions góc phải (giống GenericManager)
 */

import React, { useState, ReactNode } from "react";
import {
  Search,
  X,
  Plus,
  ArrowUpDown,
  CheckSquare,
  Trash2,
} from "lucide-react";

// ============================================================
// TYPES
// ============================================================

export interface TabItem {
  id: string;
  label: string;
  count?: number;
}

export interface SortOption {
  key: string;
  label: string;
}

export interface BulkAction {
  id: string;
  label: string;
  icon?: React.ElementType;
  color?: string;
  onClick: (selectedIds: string[]) => void;
}

export interface KhungDanhSachProps {
  // Tabs
  tabs?: TabItem[];
  activeTab?: string;
  onTabChange?: (tabId: string) => void;

  // Search
  onSearch?: (term: string) => void;

  // Sort
  sortOptions?: SortOption[];
  activeSort?: string;
  onSortChange?: (sortKey: string) => void;

  // Actions
  showAddButton?: boolean;
  onAdd?: () => void;
  // 🟢 THÊM: Cho phép chèn nút tùy chỉnh (vd: Sync User)
  extraActions?: ReactNode; 

  // Bulk mode
  bulkMode?: boolean;
  onBulkModeToggle?: () => void;
  selectedCount?: number;
  onSelectAll?: () => void;
  onClearSelection?: () => void;
  bulkActions?: BulkAction[];

  // Loading
  loading?: boolean;

  // Content
  children: ReactNode;

  // Style
  className?: string;
}

// ============================================================
// COMPONENT
// ============================================================

export default function KhungDanhSach({
  tabs = [],
  activeTab = "all",
  onTabChange,
  onSearch,
  sortOptions = [],
  activeSort,
  onSortChange,
  showAddButton = true,
  onAdd,
  extraActions, // 🟢 Nhận prop này
  bulkMode = false,
  onBulkModeToggle,
  selectedCount = 0,
  onSelectAll,
  onClearSelection,
  bulkActions = [],
  loading = false,
  children,
  className = "",
}: KhungDanhSachProps) {
  const [showSearch, setShowSearch] = useState(false);
  const [searchTerm, setSearchTerm] = useState("");
  const [showSortMenu, setShowSortMenu] = useState(false);

  const handleSearch = (value: string) => {
    setSearchTerm(value);
    onSearch?.(value);
  };

  const clearSearch = () => {
    setSearchTerm("");
    onSearch?.("");
    setShowSearch(false);
  };

  return (
    <div
      className={`w-full h-full flex flex-col bg-[#050505] overflow-hidden ${className}`}
    >
      {/* ====== TAB BAR - Style giống GenericManager ====== */}
      <div className="shrink-0 h-[40px] flex items-center border-b border-white/5 bg-[#0a0a0a]">
        {/* Tabs - cuộn được */}
        <div className="flex-1 flex items-center gap-1 px-2 overflow-x-auto min-w-0 scrollbar-hide">
          <style jsx>{`
            .scrollbar-hide::-webkit-scrollbar {
              display: none;
            }
            .scrollbar-hide {
              -ms-overflow-style: none;
              scrollbar-width: none;
            }
          `}</style>
          {tabs.map((tab) => (
            <button
              key={tab.id}
              onClick={() => onTabChange?.(tab.id)}
              className={`flex items-center gap-1 px-2 py-1 text-[10px] font-bold uppercase whitespace-nowrap rounded transition-all shrink-0 ${
                activeTab === tab.id
                  ? "text-[#C69C6D] bg-[#C69C6D]/10"
                  : "text-gray-500 hover:text-white hover:bg-white/5"
              }`}
            >
              {tab.label}
              {tab.count !== undefined && (
                <span
                  className={`px-1 py-0.5 rounded text-[8px] ${
                    activeTab === tab.id
                      ? "bg-[#C69C6D] text-black"
                      : "bg-white/10 text-gray-400"
                  }`}
                >
                  {tab.count}
                </span>
              )}
            </button>
          ))}
        </div>

        {/* Actions - cố định phải */}
        <div className="shrink-0 flex items-center gap-1 px-2 border-l border-white/5 bg-[#0a0a0a]">
          
          {/* Search */}
          {onSearch && (
            <div className="relative flex items-center">
              {showSearch ? (
                <div className="flex items-center gap-1 animate-in slide-in-from-right-2">
                  <input
                    autoFocus
                    type="text"
                    placeholder="Tìm..."
                    value={searchTerm}
                    onChange={(e) => handleSearch(e.target.value)}
                    className="w-28 bg-white/5 border border-white/10 rounded pl-2 pr-6 py-1 text-[10px] text-white placeholder:text-white/20 focus:outline-none focus:border-[#C69C6D]"
                  />
                  <button
                    onClick={clearSearch}
                    className="absolute right-1 p-0.5 text-white/40 hover:text-white"
                  >
                    <X size={12} />
                  </button>
                </div>
              ) : (
                <button
                  onClick={() => setShowSearch(true)}
                  className="p-1.5 bg-white/5 hover:bg-white/10 text-white/60 rounded transition-all"
                >
                  <Search size={14} />
                </button>
              )}
            </div>
          )}

          {/* Sort */}
          {sortOptions.length > 0 && (
            <div className="relative">
              <button
                onClick={() => setShowSortMenu(!showSortMenu)}
                className="p-1.5 bg-white/5 hover:bg-white/10 text-white/60 rounded transition-all"
              >
                <ArrowUpDown size={14} />
              </button>
              {showSortMenu && (
                <>
                  <div
                    className="fixed inset-0 z-40"
                    onClick={() => setShowSortMenu(false)}
                  />
                  <div className="absolute top-full mt-1 right-0 bg-[#1a1a1a] border border-white/10 rounded-lg shadow-2xl z-[100] min-w-[90px] overflow-hidden">
                    {sortOptions.map((opt) => (
                      <button
                        key={opt.key}
                        onClick={() => {
                          onSortChange?.(opt.key);
                          setShowSortMenu(false);
                        }}
                        className={`w-full text-left px-3 py-1.5 text-[10px] font-bold ${
                          activeSort === opt.key
                            ? "text-[#C69C6D] bg-[#C69C6D]/10"
                            : "text-white hover:bg-white/10"
                        }`}
                      >
                        {opt.label}
                      </button>
                    ))}
                  </div>
                </>
              )}
            </div>
          )}

          {/* 🟢 EXTRA ACTIONS (Nút Sync, Export...) */}
          {extraActions && (
            <div className="flex items-center gap-1 pl-1 border-l border-white/5 ml-1">
               {extraActions}
            </div>
          )}

          {/* Bulk Mode Toggle */}
          {onBulkModeToggle && (
            <button
              onClick={onBulkModeToggle}
              className={`p-1.5 rounded transition-all ${
                bulkMode
                  ? "bg-[#C69C6D] text-black"
                  : "bg-white/5 text-white/60 hover:bg-white/10"
              }`}
            >
              <CheckSquare size={14} />
            </button>
          )}

          {/* Add */}
          {showAddButton && onAdd && (
            <button
              onClick={onAdd}
              className="p-1.5 bg-[#C69C6D] hover:bg-white text-black rounded transition-all active:scale-95"
            >
              <Plus size={14} strokeWidth={3} />
            </button>
          )}
        </div>
      </div>

      {/* ====== BULK BAR ====== */}
      {bulkMode && selectedCount > 0 && (
        <div className="shrink-0 px-3 py-1.5 bg-[#C69C6D]/10 border-b border-[#C69C6D]/30 flex items-center justify-between gap-2">
          <div className="flex items-center gap-2">
            <span className="text-[#C69C6D] font-bold text-[10px]">
              Đã chọn: {selectedCount}
            </span>
            <button
              onClick={onSelectAll}
              className="text-[10px] text-white/60 hover:text-white underline"
            >
              Tất cả
            </button>
            <button
              onClick={onClearSelection}
              className="text-[10px] text-white/60 hover:text-white underline"
            >
              Bỏ chọn
            </button>
          </div>
          <div className="flex items-center gap-1">
            {bulkActions.map((action) => {
              const Icon = action.icon;
              return (
                <button
                  key={action.id}
                  onClick={() => action.onClick([])}
                  className={`p-1.5 rounded transition-all ${
                    action.color === "danger"
                      ? "bg-red-600 hover:bg-red-700 text-white"
                      : "bg-white/5 text-white/60 hover:bg-white/10"
                  }`}
                >
                  {Icon && <Icon size={14} />}
                </button>
              );
            })}
          </div>
        </div>
      )}

      {/* ====== CONTENT AREA ====== */}
      <div className="flex-1 overflow-y-auto">
        {loading ? (
          <div className="h-full flex items-center justify-center">
            <div className="w-8 h-8 border-2 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
          </div>
        ) : (
          children
        )}
      </div>
    </div>
  );
}
</file>

<file path="app/components/cacchucnang/KhungGiaoDienChucNang/KhungForm.tsx">
"use client";

/**
 * ============================================================
 * KHUNG FORM (CORE COMPONENT)
 * ============================================================
 * * Panel form inline chuẩn cho toàn hệ thống.
 * * TÍNH NĂNG TÍCH HỢP SẴN:
 * 1. Giao diện Header/Footer chuẩn.
 * 2. Xác nhận khi đóng form nếu dữ liệu thay đổi (isDirty).
 * 3. Tự động Nén ảnh (<1MB) và Upload lên Supabase (nếu có prop uploadBucket).
 */

import React, { ReactNode, useState, useRef } from "react";
import { X, Save, Loader2, User, Camera } from "lucide-react";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { compressImage } from "@/app/ThuVien/compressImage";

// ============================================================
// TYPES
// ============================================================

export interface KhungFormProps {
  // Data
  isEditing?: boolean;
  data?: any;
  onClose: () => void;

  // Header Info
  title?: string;
  avatar?: string; // URL ảnh hiện tại
  avatarFallback?: ReactNode;

  // 🟢 CẤU HÌNH UPLOAD ẢNH TỰ ĐỘNG
  showAvatarUpload?: boolean;
  uploadBucket?: string; // Tên bucket trên Supabase (vd: 'images')
  onUploadComplete?: (url: string) => void; // Callback trả về URL sau khi upload xong
  onAvatarChange?: (file: File | null) => void; // (Legacy) Callback trả về file thô nếu muốn tự xử lý

  // Form Actions
  onSubmit?: () => void | Promise<void>;

  // State
  loading?: boolean; // Trạng thái đang lưu form
  isDirty?: boolean; // Trạng thái đã chỉnh sửa (để hiện confirm khi đóng)

  // Content
  children: ReactNode;
  className?: string;
}

// ============================================================
// COMPONENT
// ============================================================

export default function KhungForm({
  isEditing = false,
  onClose,
  title,
  avatar,
  avatarFallback,
  showAvatarUpload = false,
  uploadBucket, // 🟢 Nhận tên bucket để kích hoạt auto-upload
  onUploadComplete,
  onAvatarChange,
  onSubmit,
  loading = false,
  isDirty = false,
  children,
  className = "",
}: KhungFormProps) {
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [showConfirm, setShowConfirm] = useState(false);

  // 🟢 State nội bộ để quản lý trạng thái upload ảnh
  const [isUploading, setIsUploading] = useState(false);

  // Xử lý đóng form an toàn
  const handleClose = () => {
    if (isUploading) return; // Không cho đóng khi đang upload dở
    if (isDirty) {
      setShowConfirm(true);
    } else {
      onClose();
    }
  };

  const handleConfirmClose = () => {
    setShowConfirm(false);
    onClose();
  };

  // Xử lý submit form
  const handleSubmit = async () => {
    if (loading || isUploading) return; // Chặn nếu đang bận
    await onSubmit?.();
  };

  // Kích hoạt input file
  const handleAvatarClick = () => {
    if (!isUploading) fileInputRef.current?.click();
  };

  // 🟢 CORE LOGIC: XỬ LÝ ẢNH (Nén -> Upload -> Lấy URL)
  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // 1. Preview ngay lập tức cho mượt
    const reader = new FileReader();
    reader.onloadend = () => setAvatarPreview(reader.result as string);
    reader.readAsDataURL(file);

    // 2. Nếu có cấu hình bucket -> Tự động Nén & Upload
    if (uploadBucket) {
      try {
        setIsUploading(true); // Bật loading

        // A. Nén ảnh (Giảm dung lượng để tiết kiệm băng thông và Storage)
        // Quality 0.7, Max width 1200px là đủ nét cho web
        const compressedFile = await compressImage(file, 0.7, 1200);

        // B. Tạo tên file an toàn (Timestamp + Random + Extension)
        // Thay thế các ký tự đặc biệt để tránh lỗi URL
        const safeName = file.name.replace(/[^a-zA-Z0-9]/g, "_");
        const fileName = `img_${Date.now()}_${Math.floor(
          Math.random() * 1000
        )}_${safeName}.jpg`;

        // C. Upload lên Supabase
        const { error: uploadError } = await supabase.storage
          .from(uploadBucket)
          .upload(fileName, compressedFile, {
            upsert: true,
            contentType: "image/jpeg",
          });

        if (uploadError) throw uploadError;

        // D. Lấy URL công khai
        const { data: urlData } = supabase.storage
          .from(uploadBucket)
          .getPublicUrl(fileName);

        // E. Trả về URL cho form cha để lưu vào DB
        if (onUploadComplete) {
          onUploadComplete(urlData.publicUrl);
        }
      } catch (error: any) {
        console.error("🔥 Upload failed:", error);
        alert(`Lỗi tải ảnh: ${error.message || "Vui lòng kiểm tra kết nối"}`);
        setAvatarPreview(null); // Reset preview nếu lỗi
      } finally {
        setIsUploading(false); // Tắt loading dù thành công hay thất bại
      }
    }
    // 3. Nếu không cấu hình bucket -> Trả file thô về cho cha tự xử lý (Legacy support)
    else {
      onAvatarChange?.(file);
    }
  };

  // Ảnh hiển thị: Ưu tiên Preview mới chọn > Ảnh cũ từ DB
  const displayAvatar = avatarPreview || avatar;

  return (
    <div
      className={`w-full h-full flex flex-col bg-[#050505] overflow-hidden ${className}`}
    >
      {/* ====== HEADER BAR ====== */}
      <div className="shrink-0 h-[45px] flex items-center border-b border-white/5 bg-[#0a0a0a]">
        {/* TRÁI: Nút đóng + Info */}
        <div className="shrink-0 flex items-center gap-3 px-3 border-r border-white/5">
          <button
            onClick={handleClose}
            disabled={loading || isUploading}
            className="p-2 text-white/40 hover:text-white hover:bg-white/10 rounded-full transition-all disabled:opacity-50"
          >
            <X size={16} />
          </button>
          <div className="flex items-center gap-2 pr-2">
            {/* Avatar Mini trên thanh header */}
            <div className="relative w-7 h-7 rounded-full border border-[#C69C6D]/50 overflow-hidden bg-[#1a1a1a] shrink-0">
              {displayAvatar ? (
                <img
                  src={displayAvatar}
                  alt=""
                  className="w-full h-full object-cover"
                />
              ) : (
                <div className="w-full h-full flex items-center justify-center text-[#C69C6D]/50">
                  <User size={12} />
                </div>
              )}
            </div>
            <span className="text-[11px] md:text-xs font-bold text-[#C69C6D] uppercase tracking-wider truncate max-w-[150px]">
              {isEditing ? title || "CẬP NHẬT" : title || "THÊM MỚI"}
            </span>
          </div>
        </div>

        <div className="flex-1" />

        {/* PHẢI: Actions Buttons */}
        <div className="shrink-0 flex items-center gap-2 px-3 border-l border-white/5">
          <button
            onClick={handleClose}
            disabled={loading || isUploading}
            className="hidden md:block px-4 py-1.5 bg-white/5 hover:bg-white/10 text-white/60 rounded-lg text-[10px] font-bold uppercase transition-all"
          >
            HỦY BỎ
          </button>
          <button
            onClick={handleSubmit}
            disabled={loading || isUploading}
            className={`
                            px-4 py-1.5 rounded-lg text-[10px] font-bold uppercase transition-all flex items-center gap-2
                            ${
                              loading || isUploading
                                ? "bg-white/10 text-white/50 cursor-not-allowed"
                                : "bg-[#C69C6D] hover:bg-[#b58b5d] text-black shadow-[0_0_10px_rgba(198,156,109,0.3)]"
                            }
                        `}
          >
            {loading || isUploading ? (
              <Loader2 size={14} className="animate-spin" />
            ) : (
              <Save size={14} />
            )}
            <span>
              {isUploading
                ? "ĐANG TẢI ẢNH..."
                : loading
                ? "ĐANG LƯU..."
                : "LƯU LẠI"}
            </span>
          </button>
        </div>
      </div>

      {/* Hidden Input File */}
      {showAvatarUpload && (
        <input
          ref={fileInputRef}
          type="file"
          accept="image/*"
          className="hidden"
          onChange={handleFileChange}
        />
      )}

      {/* ====== CONTENT AREA ====== */}
      <div className="flex-1 overflow-y-auto p-4 md:p-6 custom-scrollbar">
        {/* Khu vực Upload Ảnh Lớn */}
        {showAvatarUpload && (
          <div className="flex justify-center mb-8">
            <div
              onClick={handleAvatarClick}
              className={`
                                relative w-28 h-28 rounded-full border-2 overflow-hidden bg-[#1a1a1a] group transition-all
                                ${
                                  isUploading
                                    ? "border-[#C69C6D] cursor-wait scale-95"
                                    : "border-[#C69C6D]/30 hover:border-[#C69C6D] cursor-pointer hover:shadow-lg"
                                }
                            `}
            >
              {displayAvatar ? (
                <img
                  src={displayAvatar}
                  alt=""
                  className={`w-full h-full object-cover transition-opacity ${
                    isUploading ? "opacity-50" : "opacity-100"
                  }`}
                />
              ) : (
                <div className="w-full h-full flex items-center justify-center text-[#C69C6D]/30">
                  <User size={40} />
                </div>
              )}

              {/* Overlay hiệu ứng */}
              <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center transition-opacity">
                {isUploading ? (
                  <div className="text-[#C69C6D] flex flex-col items-center gap-1">
                    <Loader2 size={24} className="animate-spin" />
                    <span className="text-[8px] font-bold uppercase">
                      Uploading...
                    </span>
                  </div>
                ) : (
                  <div className="text-white flex flex-col items-center gap-1">
                    <Camera size={24} />
                    <span className="text-[8px] font-bold uppercase">
                      Thay đổi
                    </span>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Form Fields Children */}
        {children}
      </div>

      {/* ====== CONFIRM DIALOG ====== */}
      {showConfirm && (
        <div className="fixed inset-0 z-[110] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-in fade-in duration-200">
          <div className="bg-[#1a1a1a] border border-white/10 rounded-xl p-6 max-w-xs w-full text-center shadow-2xl">
            <h3 className="text-white font-bold text-lg mb-2">
              Dữ liệu chưa lưu
            </h3>
            <p className="text-white/60 text-sm mb-6">
              Bạn có chắc muốn đóng không? Mọi thay đổi sẽ bị mất.
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setShowConfirm(false)}
                className="flex-1 py-2.5 rounded-lg bg-white/5 text-white/70 font-bold text-xs uppercase hover:bg-white/10 transition-all"
              >
                Ở Lại
              </button>
              <button
                onClick={handleConfirmClose}
                className="flex-1 py-2.5 rounded-lg bg-red-600/80 hover:bg-red-600 text-white font-bold text-xs uppercase transition-all shadow-lg shadow-red-900/20"
              >
                Đóng & Hủy
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan.tsx">
"use client";

import React, { ReactNode } from "react";
import MenuTren from "@/app/GiaoDienTong/MenuTren/MenuTren";

import { Z_INDEX } from "@/app/constants/zIndex";

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const BASE_IMG_URL = `${SUPABASE_URL}/storage/v1/object/public/hinh-nen`;

interface Props {
  children: ReactNode;
  nguoiDung: any;
  loiChao?: string;
  contentClassName?: string;
}

export default function KhungTrangChuan({
  children,
  nguoiDung,
  loiChao,
  contentClassName = "max-w-[1920px] mx-auto p-3 pb-24 md:p-6 md:pb-24 pt-24",
}: Props) {
  const bgUrlMobile = `${BASE_IMG_URL}/trangchu-mobile.jpg`;
  const bgUrlTablet = `${BASE_IMG_URL}/trangchu-tablet.jpg`;
  const bgUrlDesktop = `${BASE_IMG_URL}/trangchu-desktop.jpg`;

  const displayLoiChao = loiChao || `Xin chào, ${nguoiDung?.ho_ten || "User"}`;

  return (
    <div className="relative w-full min-h-[100dvh] bg-[#050505] text-[#F5F5F5] font-sans overflow-x-hidden selection:bg-[#C69C6D] selection:text-black text-[14px]">
      {/* LAYER 0: HÌNH NỀN CHUẨN */}
      <div className="fixed inset-0 w-full h-full z-0 pointer-events-none select-none bg-black">
        <img
          src={bgUrlMobile}
          alt="BG"
          className="absolute inset-0 w-full h-full object-cover md:hidden opacity-100"
        />
        <img
          src={bgUrlTablet}
          alt="BG"
          className="absolute inset-0 w-full h-full object-cover hidden md:block lg:hidden opacity-100"
        />
        <img
          src={bgUrlDesktop}
          alt="BG"
          className="absolute inset-0 w-full h-full object-cover hidden lg:block opacity-100"
        />
        <div className="absolute inset-0 bg-gradient-to-t from-black via-black/60 to-black/40" />
      </div>

      {/* LAYER 1: NỘI DUNG CHÍNH */}
      <main
        className={`relative z-[10] w-full min-h-[100dvh] flex flex-col ${contentClassName}`}
      >
        {children}
      </main>

      {/* LAYER 2: GRADIENT BẢO VỆ MENU */}
      <div className="fixed top-0 left-0 right-0 h-28 bg-gradient-to-b from-black to-transparent z-[4900] pointer-events-none"></div>
      <div className="fixed bottom-0 left-0 right-0 h-28 bg-gradient-to-t from-black to-transparent z-[4900] pointer-events-none"></div>

      {/* LAYER 3: HỆ THỐNG MENU */}
      <MenuTren nguoiDung={nguoiDung} loiChao={displayLoiChao} />
    </div>
  );
}
</file>

<file path="app/components/cacchucnang/KhungXuLyChucNang/index.ts">

</file>

<file path="app/components/cacchucnang/KhungXuLyChucNang/useQuanLyDanhSach.ts">
// app/components/KhungXuLyChucNang/useQuanLyDanhSach.ts
import { useState, useEffect, useMemo, useCallback } from 'react';

export function useQuanLyDanhSach<T>(dataSource: any, initialSort: string = 'name') {
    const [items, setItems] = useState<T[]>([]);
    const [loading, setLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState("");
    const [sortBy, setSortBy] = useState(initialSort);
    const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());

    // Tự động fetch data khi mount
    const fetchData = useCallback(async () => {
        setLoading(true);
        try {
            const res = await dataSource.fetchList(1, 100, "", ""); // Gọi API
            if (res.success) setItems(res.data);
        } finally {
            setLoading(false);
        }
    }, [dataSource]);

    useEffect(() => { fetchData(); }, [fetchData]);

    // Logic lọc và search chung (giúp file chính gọn hơn)
    const processedItems = useMemo(() => {
        let result = items;
        // ... logic search và sort dùng chung ở đây ...
        return result;
    }, [items, searchTerm, sortBy]);

    return {
        items: processedItems,
        loading,
        searchTerm,
        setSearchTerm,
        sortBy,
        setSortBy,
        refresh: fetchData,
        selection: { selectedIds, setSelectedIds }
    };
}
</file>

<file path="app/components/cacchucnang/KhungXuLyChucNang/useQuanLyForm.ts">
// app/components/KhungXuLyChucNang/useQuanLyForm.ts
import { useState } from 'react';

export function useQuanLyForm<T>(dataSource: any, onSuccess: () => void) {
    const [isSaving, setIsSaving] = useState(false);
    const [formData, setFormData] = useState<Partial<T>>({});
    const [isOpen, setIsOpen] = useState(false);

    const handleOpen = (item?: T) => {
        setFormData(item ? { ...item } : {});
        setIsOpen(true);
    };

    const handleSave = async () => {
        setIsSaving(true);
        try {
            // Tự động phân biệt Create hay Update
            if ((formData as any).id) {
                await dataSource.update((formData as any).id, formData);
            } else {
                await dataSource.create(formData);
            }
            onSuccess(); // Refresh list
            setIsOpen(false);
        } catch (e) {
            console.error(e);
            alert("Lỗi lưu dữ liệu");
        } finally {
            setIsSaving(false);
        }
    };

    return {
        isOpen,
        close: () => setIsOpen(false),
        open: handleOpen,
        formData,
        setFormData,
        save: handleSave,
        isSaving
    };
}
</file>

<file path="app/components/cacchucnang/mauthietke/config.ts">
import { Palette, Image as ImageIcon, Tag, User } from "lucide-react";
import {
  ManagerConfig,
  FieldConfig,
  FilterTabConfig,
  TabConfig,
} from "../types";
import {
  getMauThietKeDataAction,
  createMauThietKeAction,
  updateMauThietKeAction,
  deleteMauThietKeAction,
} from "@/app/actions/QuyenHanThietKe";

// 1. CẬP NHẬT INTERFACE (Thêm file_thiet_ke)
export interface MauThietKe {
  id: string;
  mo_ta: string;
  phan_loai: string;
  phan_loai_normalized: string;
  hinh_anh: string;
  // Thêm trường này để lưu danh sách link
  file_thiet_ke?: string[];
  nguoi_tao: string;
  ten_nguoi_tao?: string;
  tao_luc: string;
}

export interface MauThietKePermissions {
  allowView?: boolean;
  allowEdit?: boolean;
  allowDelete?: boolean;
  allowBulk?: boolean;
}

// Các loại phân loại chuẩn hóa
const PHAN_LOAI_OPTIONS = [
  "Tranh chân dung gạo In UV + Vẽ mặt",
  "Tranh phong cảnh Gạo - Tấm - Cám",
  "Đĩa Tranh Gạo",
  "Tranh gạo In UV",
  "Tranh In Để Bàn",
  "Nón lá gạo",
  "Tranh gạo in UV có đồng hồ",
  "Tranh chân dung thủ công 100%",
];

const fields: FieldConfig[] = [
  {
    key: "hinh_anh",
    label: "Hình ảnh mẫu",
    type: "image",
    showInForm: true,
    showInDetail: false,
    showInCard: true,
  },
  {
    key: "mo_ta",
    label: "Mô tả / Tên mẫu",
    type: "text",
    placeholder: "Nhập tên mẫu thiết kế...",
    required: true,
    icon: Palette,
  },
  {
    key: "phan_loai",
    label: "Phân loại",
    type: "select",
    options: PHAN_LOAI_OPTIONS,
    required: true,
    icon: Tag,
  },
  {
    key: "ten_nguoi_tao",
    label: "Người thiết kế",
    type: "readonly",
    icon: User,
    showInForm: false,
  },
];

// 2. CẬP NHẬT BỘ LỌC (Thêm tab lọc File Thiết Kế)
const filterTabs: FilterTabConfig[] = [
  // Tab mới: Lọc những mẫu đã có file
  {
    id: "has_file",
    label: "ĐÃ CÓ FILE",
    filterField: "file_thiet_ke", // Trường này sẽ được xử lý logic riêng ở Controller
  },
  {
    id: "tranhchandunggaoinuv+vemat",
    label: "CHÂN DUNG UV",
    filterField: "phan_loai_normalized",
  },
  {
    id: "tranhphongcanhgao-tam-cam",
    label: "PHONG CẢNH",
    filterField: "phan_loai_normalized",
  },
  { id: "tranhgaoinuv", label: "IN UV", filterField: "phan_loai_normalized" },
  {
    id: "diatranhgao",
    label: "ĐĨA TRANH",
    filterField: "phan_loai_normalized",
  },
  { id: "tranhindeban", label: "ĐỂ BÀN", filterField: "phan_loai_normalized" },
];

const detailTabs: TabConfig[] = [{ id: "thongtin", label: "CHI TIẾT" }];

const dataSource = {
  fetchList: async (
    page: number,
    limit: number,
    search: string,
    filter: string
  ) => {
    const res = await getMauThietKeDataAction(page, limit, search, filter);
    return {
      success: res.success,
      data: res.data as MauThietKe[] | undefined,
      error: res.error,
    };
  },
  create: async (data: Partial<MauThietKe>) => {
    const res = await createMauThietKeAction(data);
    return { success: res.success, data: (res as any)?.data, error: res.error };
  },
  update: async (id: string, data: Partial<MauThietKe>) => {
    const res = await updateMauThietKeAction(id, data);
    return { success: res.success, data: (res as any)?.data, error: res.error };
  },
  delete: async (id: string) => {
    const res = await deleteMauThietKeAction(id);
    return { success: res.success, error: res.error };
  },
};

export function createMauThietKeConfig(
  permissions: MauThietKePermissions = {}
): ManagerConfig<MauThietKe> {
  const {
    allowView = true,
    allowEdit = true,
    allowDelete = false,
    allowBulk = false,
  } = permissions;

  return {
    entityName: "mẫu thiết kế",
    entityNamePlural: "mẫu thiết kế",
    idField: "id",
    fields,
    cardConfig: {
      avatarField: "hinh_anh",
      titleField: "mo_ta",
      subtitleField: "phan_loai",
      infoFields: [{ field: "ten_nguoi_tao", icon: User }],
    },
    filterTabs,
    detailTabs,
    actions: {
      allowView,
      allowEdit,
      allowDelete,
      allowBulkSelect: allowBulk,
      allowBulkDelete: allowBulk && allowDelete,
    },
    dataSource,
    searchFields: ["mo_ta"],
    sortOptions: [
      {
        key: "newest",
        label: "MỚI NHẤT",
        sortFn: (a: MauThietKe, b: MauThietKe) =>
          new Date(b.tao_luc).getTime() - new Date(a.tao_luc).getTime(),
      },
      {
        key: "name",
        label: "TÊN A-Z",
        sortFn: (a: MauThietKe, b: MauThietKe) =>
          a.mo_ta.localeCompare(b.mo_ta),
      },
    ],
    defaultSort: "newest",
    uploadConfig: { bucket: "images", fileNamePrefix: "mau" }, // Đã chuẩn hóa về 'images'
  };
}
</file>

<file path="app/components/cacchucnang/mauthietke/index.ts">
export { default as MauThietKeChucNang } from "./MauThietKeChucNang";
export { createMauThietKeConfig } from "./config";
export type { MauThietKe, MauThietKePermissions } from "./config";
</file>

<file path="app/components/cacchucnang/mauthietke/MauThietKeList.tsx">
"use client";

import React from "react";
import { Palette, User, Link as LinkIcon } from "lucide-react";
import { MauThietKe } from "./config";

interface Props {
  items: MauThietKe[];
  bulkMode: boolean;
  selectedIds: Set<string>;
  onToggleSelect: (id: string) => void;
  onClickItem: (item: MauThietKe) => void;
}

export default function MauThietKeList({
  items,
  bulkMode,
  selectedIds,
  onToggleSelect,
  onClickItem,
}: Props) {
  // Helper: Đếm số lượng file thiết kế
  const getFileCount = (item: MauThietKe) => {
    const files = item.file_thiet_ke;
    if (Array.isArray(files))
      return files.filter((f) => f && f.trim() !== "").length;
    if (typeof files === "string") {
      try {
        const parsed = JSON.parse(files);
        return Array.isArray(parsed)
          ? parsed.filter((f: any) => f && f.trim() !== "").length
          : 0;
      } catch {
        return 0;
      }
    }
    return 0;
  };

  return (
    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-2 p-2 md:p-4">
      {items.map((item) => {
        const fileCount = getFileCount(item);

        return (
          <div
            key={item.id}
            onClick={(e) => {
              if (bulkMode) {
                e.stopPropagation();
                onToggleSelect(item.id);
              } else {
                onClickItem(item);
              }
            }}
            className={`
                group relative bg-[#0f0f0f] border border-white/10 rounded-lg overflow-hidden cursor-pointer 
                hover:border-[#C69C6D]/50 transition-all 
                ${
                  selectedIds.has(item.id)
                    ? "border-[#C69C6D] bg-[#C69C6D]/10"
                    : ""
                }
            `}
          >
            {/* 🟢 HIỂN THỊ SỐ LƯỢNG FILE THIẾT KẾ (Badge) */}
            {fileCount > 0 && (
              <div className="absolute top-1 left-1 z-10 flex items-center gap-1 bg-black/60 backdrop-blur-sm px-1.5 py-0.5 rounded text-[9px] font-bold text-[#C69C6D] border border-white/10 shadow-sm">
                <LinkIcon size={10} />
                <span>{fileCount}</span>
              </div>
            )}

            {/* Checkbox Bulk Mode */}
            {bulkMode && (
              <div className="absolute top-1 right-1 z-10 w-5 h-5 border-2 rounded flex items-center justify-center transition-colors border-white/30 bg-black/50">
                {selectedIds.has(item.id) && (
                  <span className="text-[#C69C6D] font-bold text-xs">✓</span>
                )}
              </div>
            )}

            {/* Hình ảnh */}
            <div className="aspect-square w-full bg-[#1a1a1a] relative group-hover:opacity-90 transition-opacity">
              {item.hinh_anh ? (
                <img
                  src={item.hinh_anh}
                  alt=""
                  className="w-full h-full object-cover"
                  loading="lazy"
                />
              ) : (
                <div className="w-full h-full flex items-center justify-center text-white/10">
                  <Palette size={24} />
                </div>
              )}
            </div>

            {/* Nội dung (Đã căn giữa) */}
            <div className="p-2 text-center">
              <h3 className="font-bold text-white truncate text-xs leading-tight">
                {item.mo_ta}
              </h3>
              <p className="text-[9px] text-[#C69C6D] mt-0.5 truncate uppercase opacity-80">
                {item.phan_loai}
              </p>
              <div className="mt-1 flex items-center justify-center gap-1 text-[9px] text-white/30 truncate">
                <User size={8} />
                <span className="truncate">{item.ten_nguoi_tao || "---"}</span>
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
}
</file>

<file path="app/components/cacchucnang/nhansu/config.ts">
/**
 * ============================================================
 * CHỨC NĂNG: NHÂN SỰ
 * Đường dẫn: phongchuan/cacchucnang/nhansu
 * ============================================================
 * 
 * Chức năng quản lý nhân sự dùng chung cho nhiều phòng.
 * Mỗi phòng gọi ra với quyền khác nhau thông qua props.
 * 
 * QUYỀN HẠN:
 * - allowView: Xem danh sách và chi tiết
 * - allowEdit: Sửa thông tin
 * - allowDelete: Xóa nhân sự
 * - allowBulk: Thao tác hàng loạt
 * 
 * SỬ DỤNG:
 * import { NhanSuChucNang } from '@/app/components/cacchucnang/nhansu';
 * <NhanSuChucNang permissions={{ allowDelete: true }} />
 */

import { Phone, Mail, Banknote, Clock, Percent, ShieldCheck } from 'lucide-react';
import { ManagerConfig, FieldConfig, FilterTabConfig, TabConfig } from '../types';
import { 
    getNhanSuDataAction, 
    createNhanSuAction, 
    updateNhanSuAction, 
    deleteNhanSuAction,
    getDistinctValuesAction 
} from '@/app/actions/QuyenHanQuanLy';

// ============================================================
// INTERFACE
// ============================================================

export interface NhanSu {
    id: string;
    ho_ten: string;
    vi_tri: string;
    vi_tri_normalized: string;
    so_dien_thoai: string;
    email: string;
    hinh_anh?: string;
    trang_thai?: string;
    luong_thang?: number;
    luong_theo_gio?: number;
    thuong_doanh_thu?: number;
    ngan_hang?: string;
    so_tai_khoan?: string;
}

export interface NhanSuPermissions {
    allowView?: boolean;
    allowEdit?: boolean;
    allowDelete?: boolean;
    allowBulk?: boolean;
}

// ============================================================
// CONSTANTS
// ============================================================

const VN_BANKS = [
    "Vietcombank", "VietinBank", "BIDV", "Agribank", "Techcombank", "MBBank", 
    "ACB", "VPBank", "TPBank", "Sacombank", "HDBank", "VIB", "MSB", "SHB", 
    "SeABank", "OCB", "Eximbank", "LienVietPostBank", "Nam A Bank", "Viet Capital Bank"
];

// ============================================================
// FIELDS CONFIG
// ============================================================

const fields: FieldConfig[] = [
    {
        key: 'hinh_anh',
        label: 'Ảnh đại diện',
        type: 'image',
        showInForm: true,
        showInDetail: false,
        showInCard: true,
    },
    {
        key: 'ho_ten',
        label: 'Họ và Tên',
        type: 'text',
        placeholder: 'Nhập họ tên đầy đủ...',
        required: true,
    },
    {
        key: 'vi_tri',
        label: 'Vị trí / Chức vụ',
        type: 'select-add',
        placeholder: 'Chọn chức vụ...',
        required: true,
        optionsLoader: async () => {
            const res = await getDistinctValuesAction('nhan_su', 'vi_tri');
            return (res.success && res.data) ? res.data as string[] : [];
        },
    },
    {
        key: 'email',
        label: 'Email liên hệ',
        type: 'email',
        placeholder: 'email@example.com',
        required: true,
        icon: Mail,
        colSpan: 2,
    },
    {
        key: 'so_dien_thoai',
        label: 'Số điện thoại',
        type: 'phone',
        placeholder: '09xxxxxxxxx',
        icon: Phone,
    },
    {
        key: 'luong_thang',
        label: 'Lương cứng (VNĐ)',
        type: 'money',
        placeholder: '0',
        icon: Banknote,
        highlight: true,
    },
    {
        key: 'luong_theo_gio',
        label: 'Lương theo giờ',
        type: 'readonly',
        icon: Clock,
        computeFrom: 'luong_thang',
        computeFn: (luongThang: any) => {
            const value = Number(luongThang) || 0;
            if (value <= 0) return '0';
            return Math.round((value / 24 / 8) / 1000) * 1000;
        },
    },
    {
        key: 'thuong_doanh_thu',
        label: 'Thưởng doanh số (%)',
        type: 'percent',
        placeholder: '0 - 30',
        maxValue: 30,
        icon: Percent,
    },
    {
        key: 'ngan_hang',
        label: 'Ngân hàng',
        type: 'select',
        options: VN_BANKS,
        icon: ShieldCheck,
    },
    {
        key: 'so_tai_khoan',
        label: 'Số tài khoản',
        type: 'text',
        placeholder: 'Nhập số tài khoản...',
    },
];

// ============================================================
// FILTER TABS
// ============================================================

const filterTabs: FilterTabConfig[] = [
    { id: 'quanly', label: 'QUẢN LÝ', filterField: 'vi_tri_normalized' },
    { id: 'sales', label: 'SALES', filterField: 'vi_tri_normalized' },
    { id: 'thosanxuat', label: 'THỢ', filterField: 'vi_tri_normalized' },
    { id: 'parttime', label: 'PART-TIME', filterField: 'vi_tri_normalized' },
    { id: 'congtacvien', label: 'CTV', filterField: 'vi_tri_normalized' },
];

// ============================================================
// DETAIL TABS
// ============================================================

const detailTabs: TabConfig[] = [
    { id: 'hoso', label: 'HỒ SƠ' },
    { id: 'muctieu', label: 'MỤC TIÊU', searchable: true, sortable: true, sortOptions: [{ key: 'name', label: 'TÊN' }, { key: 'reward', label: 'THƯỞNG' }], showAddButton: true },
    { id: 'thanhtich', label: 'THÀNH TÍCH', searchable: true },
];

// ============================================================
// DATA SOURCE
// ============================================================

const dataSource = {
    fetchList: async (page: number, limit: number, search: string, filter: string) => {
        const res = await getNhanSuDataAction(page, limit, search, filter);
        return { success: res.success, data: res.data as NhanSu[] | undefined, error: res.error };
    },
    create: async (data: Partial<NhanSu>) => {
        if (data.vi_tri) {
            (data as any).vi_tri_normalized = data.vi_tri.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "").toLowerCase();
        }
        const res = await createNhanSuAction(data as any);
        return { success: res.success, data: (res as any).data as NhanSu, error: res.error };
    },
    update: async (id: string, data: Partial<NhanSu>) => {
        if (data.vi_tri) {
            (data as any).vi_tri_normalized = data.vi_tri.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "").toLowerCase();
        }
        const res = await updateNhanSuAction(id, data as any);
        return { success: res.success, data: (res as any).data as NhanSu, error: res.error };
    },
    delete: async (id: string) => {
        const res = await deleteNhanSuAction(id);
        return { success: res.success, error: res.error };
    },
};

// ============================================================
// CREATE CONFIG FUNCTION
// ============================================================

export function createNhanSuConfig(permissions: NhanSuPermissions = {}): ManagerConfig<NhanSu> {
    const { 
        allowView = true, 
        allowEdit = true, 
        allowDelete = false, 
        allowBulk = false 
    } = permissions;

    return {
        entityName: 'nhân sự',
        entityNamePlural: 'nhân sự',
        idField: 'id',
        fields,
        cardConfig: {
            avatarField: 'hinh_anh',
            titleField: 'ho_ten',
            subtitleField: 'vi_tri',
            infoFields: [{ field: 'so_dien_thoai', icon: Phone }],
        },
        filterTabs,
        detailTabs,
        actions: {
            allowView,
            allowEdit,
            allowDelete,
            allowBulkSelect: allowBulk,
            allowBulkDelete: allowBulk && allowDelete,
        },
        dataSource,
        searchFields: ['ho_ten', 'so_dien_thoai', 'email'],
        sortOptions: [
            { key: 'name', label: 'TÊN', sortFn: (a: NhanSu, b: NhanSu) => a.ho_ten.localeCompare(b.ho_ten) },
            { key: 'vitri', label: 'VỊ TRÍ', sortFn: (a: NhanSu, b: NhanSu) => (a.vi_tri || '').localeCompare(b.vi_tri || '') },
            { key: 'luong', label: 'LƯƠNG', sortFn: (a: NhanSu, b: NhanSu) => (b.luong_thang || 0) - (a.luong_thang || 0) },
        ],
        defaultSort: 'name',
        uploadConfig: { bucket: 'avatar', fileNamePrefix: 'ns' },
    };
}
</file>

<file path="app/components/cacchucnang/nhansu/index.ts">
/**
 * CHỨC NĂNG: NHÂN SỰ
 * Export tất cả từ folder này
 */

export { default as NhanSuChucNang } from './NhanSuChucNang';
export { createNhanSuConfig, type NhanSu, type NhanSuPermissions } from './config';
</file>

<file path="app/components/cacchucnang/types.ts">
/**
 * Types dùng chung cho các config chức năng
 * Định nghĩa cấu trúc data cho danh sách, chi tiết, form
 */

import { LucideIcon } from 'lucide-react';
import { ReactNode } from 'react';

// Cấu hình 1 field hiển thị
export interface FieldConfig {
    key: string;
    label: string;
    icon?: LucideIcon;
    render?: (value: any, item: any) => ReactNode;
    editable?: boolean;
    type?: 'text' | 'number' | 'email' | 'tel' | 'select' | 'textarea' | 'date' | 'image' | 'select-add' | 'phone' | 'money' | 'readonly' | 'percent';
    options?: string[] | { value: string; label: string }[];
    optionsLoader?: () => Promise<string[]>;
    required?: boolean;
    placeholder?: string;
    colSpan?: number;
    showInForm?: boolean;
    showInDetail?: boolean;
    showInCard?: boolean;
    highlight?: boolean;
    computeFrom?: string;
    computeFn?: (value: any) => any;
    maxValue?: number;
}

// Cấu hình 1 tab lọc (trong danh sách)
export interface FilterTabConfig {
    id?: string;
    key?: string;
    label: string;
    filter?: (item: any) => boolean;
    filterField?: string;
    color?: string;
}

// Cấu hình 1 tab chi tiết
export interface TabConfig {
    id?: string;
    key?: string;
    label: string;
    icon?: LucideIcon;
    content?: ReactNode | ((item: any) => ReactNode);
    searchable?: boolean;
    sortable?: boolean;
    sortOptions?: { key: string; label: string }[];
    showAddButton?: boolean;
}

// Cấu hình sort options
export interface SortOption<T = any> {
    key: string;
    label: string;
    sortFn: (a: T, b: T) => number;
}

// Cấu hình chính cho Manager
export interface ManagerConfig<T = any> {
    // Entity info
    entityName: string;
    entityNamePlural: string;
    
    // Table/query
    tableName?: string;
    idField?: string;
    
    // Card display
    getCardTitle?: (item: T) => string;
    getCardSubtitle?: (item: T) => string;
    getCardAvatar?: (item: T) => string | null;
    getCardBadge?: (item: T) => { text: string; color: string } | null;
    
    // Card config
    cardConfig?: {
        titleField?: string;
        subtitleField?: string;
        avatarField?: string;
        badgeField?: string;
        getBadgeColor?: (value: string) => string;
        infoFields?: { field: string; icon?: LucideIcon }[];
    };
    
    // Fields config
    fields: FieldConfig[];
    
    // Tabs config  
    filterTabs: FilterTabConfig[];
    detailTabs: TabConfig[];
    
    // List config
    listConfig?: {
        searchKeys: string[];
        sortOptions: SortOption<T>[];
        defaultSort: string;
    };
    
    // Search fields (for quick search)
    searchFields?: string[];
    
    // Sort options (top level alternative to listConfig.sortOptions)
    sortOptions?: SortOption<T>[];
    
    // Default sort (top level alternative)
    defaultSort?: string;
    
    // Upload config for images
    uploadConfig?: {
        bucket: string;
        fileNamePrefix?: string;
    };
    
    // Permissions
    permissions?: {
        canCreate?: boolean;
        canEdit?: boolean;
        canDelete?: boolean;
        canBulkDelete?: boolean;
    };
    
    // Actions
    actions?: {
        allowView?: boolean;
        allowEdit?: boolean;
        allowDelete?: boolean;
        allowBulkSelect?: boolean;
        allowBulkDelete?: boolean;
        onCardClick?: (item: T) => void;
        onEdit?: (item: T) => void;
        onDelete?: (item: T) => void;
        onBulkDelete?: (items: T[]) => void;
        onCreate?: () => void;
    };
    
    // Data source (flexible để phù hợp với nhiều cách implement)
    dataSource?: {
        fetchList?: (page: number, limit: number, search: string, filter: string) => Promise<{ success: boolean; data: T[] | undefined; error: any }>;
        fetch?: () => Promise<T[]>;
        create?: (item: Partial<T>) => Promise<{ success: boolean; data: T; error: any }>;
        update?: (id: string, item: Partial<T>) => Promise<{ success: boolean; data: T; error: any }>;
        delete?: (id: string) => Promise<{ success: boolean; error: any }>;
    };
}
</file>

<file path="app/components/cacchucnang/viecmau/config.ts">
import { Palette, Image as ImageIcon, Tag, User } from "lucide-react";
import {
  ManagerConfig,
  FieldConfig,
  FilterTabConfig,
  TabConfig,
} from "../types";
import {
  getMauThietKeDataAction,
  createMauThietKeAction,
  updateMauThietKeAction,
  deleteMauThietKeAction,
} from "@/app/actions/QuyenHanThietKe";

// 1. CẬP NHẬT INTERFACE (Thêm file_thiet_ke)
export interface MauThietKe {
  id: string;
  mo_ta: string;
  phan_loai: string;
  phan_loai_normalized: string;
  hinh_anh: string;
  // Thêm trường này để lưu danh sách link
  file_thiet_ke?: string[];
  nguoi_tao: string;
  ten_nguoi_tao?: string;
  tao_luc: string;
}

export interface MauThietKePermissions {
  allowView?: boolean;
  allowEdit?: boolean;
  allowDelete?: boolean;
  allowBulk?: boolean;
}

// Các loại phân loại chuẩn hóa
const PHAN_LOAI_OPTIONS = [
  "Tranh chân dung gạo In UV + Vẽ mặt",
  "Tranh phong cảnh Gạo - Tấm - Cám",
  "Đĩa Tranh Gạo",
  "Tranh gạo In UV",
  "Tranh In Để Bàn",
  "Nón lá gạo",
  "Tranh gạo in UV có đồng hồ",
  "Tranh chân dung thủ công 100%",
];

const fields: FieldConfig[] = [
  {
    key: "hinh_anh",
    label: "Hình ảnh mẫu",
    type: "image",
    showInForm: true,
    showInDetail: false,
    showInCard: true,
  },
  {
    key: "mo_ta",
    label: "Mô tả / Tên mẫu",
    type: "text",
    placeholder: "Nhập tên mẫu thiết kế...",
    required: true,
    icon: Palette,
  },
  {
    key: "phan_loai",
    label: "Phân loại",
    type: "select",
    options: PHAN_LOAI_OPTIONS,
    required: true,
    icon: Tag,
  },
  {
    key: "ten_nguoi_tao",
    label: "Người thiết kế",
    type: "readonly",
    icon: User,
    showInForm: false,
  },
];

// 2. CẬP NHẬT BỘ LỌC (Thêm tab lọc File Thiết Kế)
const filterTabs: FilterTabConfig[] = [
  // Tab mới: Lọc những mẫu đã có file
  {
    id: "has_file",
    label: "ĐÃ CÓ FILE",
    filterField: "file_thiet_ke", // Trường này sẽ được xử lý logic riêng ở Controller
  },
  {
    id: "tranhchandunggaoinuv+vemat",
    label: "CHÂN DUNG UV",
    filterField: "phan_loai_normalized",
  },
  {
    id: "tranhphongcanhgao-tam-cam",
    label: "PHONG CẢNH",
    filterField: "phan_loai_normalized",
  },
  { id: "tranhgaoinuv", label: "IN UV", filterField: "phan_loai_normalized" },
  {
    id: "diatranhgao",
    label: "ĐĨA TRANH",
    filterField: "phan_loai_normalized",
  },
  { id: "tranhindeban", label: "ĐỂ BÀN", filterField: "phan_loai_normalized" },
];

const detailTabs: TabConfig[] = [{ id: "thongtin", label: "CHI TIẾT" }];

const dataSource = {
  fetchList: async (
    page: number,
    limit: number,
    search: string,
    filter: string
  ) => {
    const res = await getMauThietKeDataAction(page, limit, search, filter);
    return {
      success: res.success,
      data: res.data as MauThietKe[] | undefined,
      error: res.error,
    };
  },
  create: async (data: Partial<MauThietKe>) => {
    const res = await createMauThietKeAction(data);
    return { success: res.success, data: (res as any)?.data, error: res.error };
  },
  update: async (id: string, data: Partial<MauThietKe>) => {
    const res = await updateMauThietKeAction(id, data);
    return { success: res.success, data: (res as any)?.data, error: res.error };
  },
  delete: async (id: string) => {
    const res = await deleteMauThietKeAction(id);
    return { success: res.success, error: res.error };
  },
};

export function createMauThietKeConfig(
  permissions: MauThietKePermissions = {}
): ManagerConfig<MauThietKe> {
  const {
    allowView = true,
    allowEdit = true,
    allowDelete = false,
    allowBulk = false,
  } = permissions;

  return {
    entityName: "mẫu thiết kế",
    entityNamePlural: "mẫu thiết kế",
    idField: "id",
    fields,
    cardConfig: {
      avatarField: "hinh_anh",
      titleField: "mo_ta",
      subtitleField: "phan_loai",
      infoFields: [{ field: "ten_nguoi_tao", icon: User }],
    },
    filterTabs,
    detailTabs,
    actions: {
      allowView,
      allowEdit,
      allowDelete,
      allowBulkSelect: allowBulk,
      allowBulkDelete: allowBulk && allowDelete,
    },
    dataSource,
    searchFields: ["mo_ta"],
    sortOptions: [
      {
        key: "newest",
        label: "MỚI NHẤT",
        sortFn: (a: MauThietKe, b: MauThietKe) =>
          new Date(b.tao_luc).getTime() - new Date(a.tao_luc).getTime(),
      },
      {
        key: "name",
        label: "TÊN A-Z",
        sortFn: (a: MauThietKe, b: MauThietKe) =>
          a.mo_ta.localeCompare(b.mo_ta),
      },
    ],
    defaultSort: "newest",
    uploadConfig: { bucket: "images", fileNamePrefix: "mau" }, // Đã chuẩn hóa về 'images'
  };
}
</file>

<file path="app/components/cacchucnang/viecmau/index.ts">
export { default as MauThietKeChucNang } from "./MauThietKeChucNang";
export { createMauThietKeConfig } from "./config";
export type { MauThietKe, MauThietKePermissions } from "./config";
</file>

<file path="app/components/cacchucnang/viecmau/MauThietKeChucNang.tsx">
"use client";

import React, { useState, useEffect, useMemo, useCallback } from "react";
import { Trash2 } from "lucide-react";
import { KhungDanhSach } from "@/app/components/cacchucnang/KhungGiaoDienChucNang";
import ConfirmDialog from "@/app/components/ConfirmDialog";
import {
  MauThietKe,
  MauThietKePermissions,
  createMauThietKeConfig,
} from "./config";

// IMPORT 3 THÀNH PHẦN ĐÃ TÁCH
import MauThietKeList from "./MauThietKeList";
import MauThietKeForm from "./MauThietKeForm";
import MauThietKeDetail from "./MauThietKeDetail";

interface Props {
  permissions?: MauThietKePermissions;
  className?: string;
}

const toNonAccent = (str: string) =>
  str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "")
    .toLowerCase();

export default function MauThietKeChucNang({
  permissions = {},
  className = "",
}: Props) {
  const config = createMauThietKeConfig(permissions);
  const {
    allowEdit = true,
    allowDelete = false,
    allowBulk = false,
  } = permissions;

  // --- STATE QUẢN LÝ ---
  const [items, setItems] = useState<MauThietKe[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [activeTab, setActiveTab] = useState("all");
  const [sortBy, setSortBy] = useState("newest");

  // View State
  const [viewMode, setViewMode] = useState<"list" | "detail" | "form">("list");
  const [selectedItem, setSelectedItem] = useState<MauThietKe | null>(null);

  // Action State
  const [bulkMode, setBulkMode] = useState(false);
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [confirmDelete, setConfirmDelete] = useState<{
    show: boolean;
    ids: string[];
  }>({ show: false, ids: [] });
  const [saving, setSaving] = useState(false);

  // --- FETCH DATA ---
  const fetchData = useCallback(async () => {
    setLoading(true);
    try {
      if (config.dataSource?.fetchList) {
        const res = await config.dataSource.fetchList(1, 100, "", "");
        if (res.success && res.data) setItems(res.data);
      }
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  }, [config.dataSource]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  // --- FILTER & SORT LOGIC ---
  const filteredList = useMemo(() => {
    let result = items;

    // 1. LOGIC LỌC MỚI (Xử lý tab 'ĐÃ CÓ FILE')
    if (activeTab === "has_file") {
      result = result.filter((i) => {
        // Kiểm tra xem có file thiết kế không (Array hoặc JSON string)
        const files = i.file_thiet_ke;
        if (Array.isArray(files) && files.length > 0) return true;
        if (typeof files === "string") {
          try {
            const parsed = JSON.parse(files);
            return Array.isArray(parsed) && parsed.length > 0;
          } catch {
            return false;
          }
        }
        return false;
      });
    }
    // Lọc theo phân loại thông thường
    else if (activeTab !== "all") {
      result = result.filter((i) => i.phan_loai_normalized === activeTab);
    }

    // Tìm kiếm
    if (searchTerm) {
      const term = toNonAccent(searchTerm);
      result = result.filter((i) => toNonAccent(i.mo_ta).includes(term));
    }

    // Sắp xếp
    const sortOpt = config.sortOptions?.find((s) => s.key === sortBy);
    if (sortOpt?.sortFn) {
      result = [...result].sort(sortOpt.sortFn);
    }
    return result;
  }, [items, activeTab, searchTerm, sortBy, config.sortOptions]);

  const tabs = useMemo(() => {
    const counts: Record<string, number> = { all: items.length };

    config.filterTabs?.forEach((tab) => {
      // 2. LOGIC ĐẾM SỐ LƯỢNG MỚI CHO TAB 'HAS_FILE'
      if (tab.id === "has_file") {
        counts[tab.id] = items.filter((i) => {
          const files = i.file_thiet_ke;
          if (Array.isArray(files) && files.length > 0) return true;
          if (typeof files === "string") {
            try {
              const parsed = JSON.parse(files);
              return Array.isArray(parsed) && parsed.length > 0;
            } catch {
              return false;
            }
          }
          return false;
        }).length;
      }
      // Đếm cho các tab phân loại bình thường
      else if (tab.id && tab.filterField) {
        counts[tab.id] = items.filter(
          (i) => (i as any)[tab.filterField!] === tab.id
        ).length;
      }
    });

    const dynamicTabs =
      config.filterTabs?.map((t) => ({
        id: t.id || "",
        label: t.label,
        count: t.id ? counts[t.id] || 0 : 0,
      })) || [];
    return [{ id: "all", label: "TẤT CẢ", count: counts.all }, ...dynamicTabs];
  }, [items, config.filterTabs]);

  // --- ACTION HANDLERS ---
  const handleOpenDetail = (item: MauThietKe) => {
    setSelectedItem(item);
    setViewMode("detail");
  };

  const handleOpenForm = (item?: MauThietKe) => {
    setSelectedItem(item || null);
    setViewMode("form");
  };

  // --- [UPDATED] LOGIC CHECK KẾT QUẢ TRẢ VỀ TỪ BACKEND ---
  const handleSave = async (formData: any) => {
    setSaving(true);
    try {
      let res; // Biến hứng kết quả

      if (selectedItem?.id) {
        if (config.dataSource?.update) {
          res = await config.dataSource.update(selectedItem.id, formData);
        }
      } else {
        if (config.dataSource?.create) {
          res = await config.dataSource.create(formData);
        }
      }

      // KIỂM TRA: Nếu Backend trả về success: false (do không có quyền sửa, lỗi logic...)
      if (res && !res.success) {
        // Hiện thông báo lỗi và KHÔNG đóng form
        alert(
          res.error || "Thao tác thất bại. Vui lòng kiểm tra lại quyền hạn!"
        );
        return; // Dừng hàm tại đây
      }

      // Nếu thành công -> Tải lại dữ liệu và đóng form
      await fetchData();
      setViewMode("list");
      setSelectedItem(null);
    } catch (e) {
      console.error(e);
      alert("Đã có lỗi hệ thống xảy ra!");
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (ids: string[]) => {
    if (config.dataSource?.delete) {
      // Logic xóa cũng nên có try/catch tương tự nhưng tạm thời giữ nguyên theo code gốc
      // để tránh ảnh hưởng logic delete hàng loạt
      for (const id of ids) await config.dataSource.delete(id);
      await fetchData();
      setSelectedIds(new Set());
      setConfirmDelete({ show: false, ids: [] });
      setViewMode("list");
    }
  };

  const handleBulkSelect = (id: string) => {
    const newSet = new Set(selectedIds);
    if (newSet.has(id)) newSet.delete(id);
    else newSet.add(id);
    setSelectedIds(newSet);
  };

  // --- RENDER ---
  return (
    <div className={`h-full ${className}`}>
      {/* 1. LIST VIEW */}
      {viewMode === "list" && (
        <KhungDanhSach
          tabs={tabs}
          activeTab={activeTab}
          onTabChange={setActiveTab}
          onSearch={setSearchTerm}
          sortOptions={
            config.sortOptions?.map((s) => ({ key: s.key, label: s.label })) ||
            []
          }
          activeSort={sortBy}
          onSortChange={setSortBy}
          showAddButton={allowEdit}
          onAdd={() => handleOpenForm()}
          bulkMode={bulkMode}
          onBulkModeToggle={
            allowBulk ? () => setBulkMode(!bulkMode) : undefined
          }
          selectedCount={selectedIds.size}
          onSelectAll={() =>
            setSelectedIds(new Set(filteredList.map((i) => i.id)))
          }
          onClearSelection={() => setSelectedIds(new Set())}
          bulkActions={
            allowDelete
              ? [
                  {
                    id: "delete",
                    label: "XÓA",
                    icon: Trash2,
                    color: "danger",
                    onClick: () =>
                      setConfirmDelete({
                        show: true,
                        ids: Array.from(selectedIds),
                      }),
                  },
                ]
              : []
          }
          loading={loading}
        >
          <MauThietKeList
            items={filteredList}
            bulkMode={bulkMode}
            selectedIds={selectedIds}
            onToggleSelect={handleBulkSelect}
            onClickItem={handleOpenDetail}
          />
        </KhungDanhSach>
      )}

      {/* 2. FORM VIEW */}
      {viewMode === "form" && (
        <MauThietKeForm
          data={selectedItem}
          onClose={() => {
            setViewMode("list");
            setSelectedItem(null);
          }}
          onSubmit={handleSave}
          loading={saving}
        />
      )}

      {/* 3. DETAIL VIEW */}
      {viewMode === "detail" && selectedItem && (
        <MauThietKeDetail
          data={selectedItem}
          onClose={() => {
            setViewMode("list");
            setSelectedItem(null);
          }}
          allowEdit={allowEdit}
          allowDelete={allowDelete}
          onEdit={() => handleOpenForm(selectedItem)}
          onDelete={() =>
            setConfirmDelete({ show: true, ids: [selectedItem.id] })
          }
        />
      )}

      <ConfirmDialog
        isOpen={confirmDelete.show}
        title="XÁC NHẬN XÓA"
        message={`Bạn có chắc muốn xóa ${confirmDelete.ids.length} mẫu thiết kế?`}
        onConfirm={() => handleDelete(confirmDelete.ids)}
        onCancel={() => setConfirmDelete({ show: false, ids: [] })}
      />
    </div>
  );
}
</file>

<file path="app/components/cacchucnang/viecmau/MauThietKeDetail.tsx">
"use client";

import React, { useState } from "react";
import {
  Tag,
  User,
  Calendar,
  Link as LinkIcon,
  Palette,
  ExternalLink,
  Clock,
} from "lucide-react";
import { KhungChiTiet } from "@/app/components/cacchucnang/KhungGiaoDienChucNang";
import { MauThietKe, createMauThietKeConfig } from "./config";

interface Props {
  data: MauThietKe;
  onClose: () => void;
  allowEdit: boolean;
  allowDelete: boolean;
  onEdit: () => void;
  onDelete: () => void;
}

// Interface mở rộng để hứng các trường mới từ backend
interface FileItem {
  ten: string;
  url: string;
  nguoi_dang?: string; // Tên người upload
  last_modified?: string; // Thời gian upload
}

export default function MauThietKeDetail({
  data,
  onClose,
  allowEdit,
  allowDelete,
  onEdit,
  onDelete,
}: Props) {
  const config = createMauThietKeConfig();
  const [activeTab, setActiveTab] = useState("thongtin");
  const tabs = config.detailTabs.map((t) => ({ ...t, id: t.id || "" }));

  const item = data as any;

  // Helper format thời gian ngắn gọn (VD: 14:30 25/12)
  const formatTime = (isoString?: string) => {
    if (!isoString) return "";
    const date = new Date(isoString);
    return date.toLocaleString("vi-VN", {
      hour: "2-digit",
      minute: "2-digit",
      day: "2-digit",
      month: "2-digit",
      year: "numeric", // Có thể bỏ year nếu muốn gọn hơn
    });
  };

  const getFileNameFromUrl = (url: string) => {
    try {
      return decodeURIComponent(url).split("?")[0].split("/").pop() || url;
    } catch {
      return url;
    }
  };

  const getDesignFiles = (): FileItem[] => {
    if (!item || !item.file_thiet_ke) return [];
    let parsed: any[] = [];
    const rawData = item.file_thiet_ke;

    try {
      if (Array.isArray(rawData)) parsed = rawData;
      else if (typeof rawData === "string" && rawData.trim()) {
        const result = JSON.parse(rawData);
        if (Array.isArray(result)) parsed = result;
      }
    } catch {
      return [];
    }

    return parsed
      .map((entry: any) => {
        // Data cũ (String)
        if (typeof entry === "string") {
          return { ten: getFileNameFromUrl(entry), url: entry };
        }
        // Data mới (Object)
        if (typeof entry === "object" && entry !== null) {
          return {
            ten:
              entry.ten ||
              getFileNameFromUrl(entry.url || "") ||
              "File đính kèm",
            url: entry.url || "",
            nguoi_dang: entry.nguoi_dang,
            last_modified: entry.last_modified,
          };
        }
        return null;
      })
      .filter((f): f is FileItem => f !== null && f.url.trim() !== "");
  };

  const designFiles = getDesignFiles();

  return (
    <KhungChiTiet
      data={data}
      onClose={onClose}
      avatar={item.hinh_anh}
      title={item.ten || item.mo_ta || "Chi tiết mẫu"}
      tabs={tabs}
      activeTab={activeTab}
      onTabChange={setActiveTab}
      showEditButton={allowEdit}
      showDeleteButton={allowDelete}
      onEdit={onEdit}
      onDelete={onDelete}
    >
      <div className="p-4 space-y-4">
        {/* HÌNH ẢNH */}
        <div className="aspect-video w-full rounded-xl overflow-hidden bg-[#1a1a1a] border border-white/10 relative group">
          {item.hinh_anh ? (
            <img
              src={item.hinh_anh}
              alt=""
              className="w-full h-full object-contain"
            />
          ) : (
            <div className="w-full h-full flex items-center justify-center text-white/20">
              <Palette size={48} />
            </div>
          )}
        </div>

        {/* DANH SÁCH FILE - GIAO DIỆN MỚI */}
        {designFiles.length > 0 ? (
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <label className="text-[10px] text-white/40 font-bold uppercase">
                File Thiết Kế Gốc ({designFiles.length})
              </label>
            </div>

            <div className="grid gap-2">
              {designFiles.map((file, idx) => (
                <a
                  key={idx}
                  href={file.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="group flex items-center gap-3 p-3 bg-[#151515] hover:bg-[#C69C6D] border border-white/10 hover:border-[#C69C6D] rounded-lg transition-all relative overflow-hidden"
                  title={file.url}
                >
                  {/* Icon File */}
                  <div className="w-10 h-10 rounded bg-black/20 flex items-center justify-center text-[#C69C6D] group-hover:text-black shrink-0">
                    <LinkIcon size={18} />
                  </div>

                  {/* Thông tin chính */}
                  <div className="flex-1 overflow-hidden">
                    {/* Tên File */}
                    <div className="flex items-center gap-2">
                      <p className="text-sm font-bold text-[#C69C6D] group-hover:text-black truncate">
                        {file.ten}
                      </p>
                    </div>

                    {/* Metadata: Người đăng - Thời gian */}
                    <div className="flex items-center gap-2 mt-0.5 text-[10px] text-white/40 group-hover:text-black/70 font-mono">
                      {file.nguoi_dang && (
                        <span className="flex items-center gap-1">
                          <User size={10} /> {file.nguoi_dang}
                        </span>
                      )}

                      {file.nguoi_dang && file.last_modified && <span>•</span>}

                      {file.last_modified && (
                        <span className="flex items-center gap-1">
                          <Clock size={10} /> {formatTime(file.last_modified)}
                        </span>
                      )}
                    </div>
                  </div>

                  <ExternalLink
                    size={14}
                    className="text-white/20 group-hover:text-black/40"
                  />
                </a>
              ))}
            </div>
          </div>
        ) : (
          <div className="p-3 rounded-lg border border-dashed border-white/10 flex items-center justify-center gap-2 text-white/20">
            <LinkIcon size={14} />
            <span className="text-xs italic">Chưa có file thiết kế nào</span>
          </div>
        )}

        {/* THÔNG TIN KHÁC */}
        <div className="grid gap-3 pt-2 border-t border-white/5">
          <DetailRow
            icon={<Tag size={18} />}
            label="Phân loại"
            value={item.phan_loai}
          />
          <DetailRow
            icon={<User size={18} />}
            label="Người tạo mẫu"
            value={item.ten_nguoi_tao}
          />
          <DetailRow
            icon={<Calendar size={18} />}
            label="Ngày tạo mẫu"
            value={
              item.tao_luc || item.created_at
                ? new Date(item.tao_luc || item.created_at).toLocaleDateString(
                    "vi-VN"
                  )
                : "---"
            }
          />
        </div>
      </div>
    </KhungChiTiet>
  );
}

function DetailRow({
  icon,
  label,
  value,
}: {
  icon: any;
  label: string;
  value: string;
}) {
  return (
    <div className="p-3 bg-[#151515] rounded-xl border border-white/5 flex items-center gap-3">
      <div className="text-[#C69C6D]">{icon}</div>
      <div>
        <p className="text-[10px] text-white/40 font-bold uppercase">{label}</p>
        <p className="text-white text-sm">{value || "---"}</p>
      </div>
    </div>
  );
}
</file>

<file path="app/components/cacchucnang/viecmau/MauThietKeForm.tsx">
"use client";

import React, { useState } from "react";
import { Plus, Link as LinkIcon, Trash2, Type } from "lucide-react";
import { KhungForm } from "@/app/components/cacchucnang/KhungGiaoDienChucNang";
import { MauThietKe, createMauThietKeConfig } from "./config";

interface Props {
  data: MauThietKe | null; // null = Tạo mới
  onClose: () => void;
  onSubmit: (formData: any) => Promise<void>;
  loading: boolean;
}

// 1. Định nghĩa kiểu dữ liệu cho file thiết kế
interface FileItem {
  ten: string;
  url: string;
}

// 2. Định nghĩa kiểu State cho Form (Tránh xung đột Type)
interface FormState extends Omit<Partial<MauThietKe>, "file_thiet_ke"> {
  file_thiet_ke: FileItem[];
}

export default function MauThietKeForm({
  data,
  onClose,
  onSubmit,
  loading,
}: Props) {
  const config = createMauThietKeConfig();

  // 3. Khởi tạo state
  const [formData, setFormData] = useState<FormState>(() => {
    let files: FileItem[] = [];

    // Logic parse dữ liệu cũ
    if (data && (data as any).file_thiet_ke) {
      try {
        const raw = (data as any).file_thiet_ke;
        let parsed: any[] = [];

        if (Array.isArray(raw)) {
          parsed = raw;
        } else if (typeof raw === "string") {
          parsed = JSON.parse(raw);
        }

        // Convert sang chuẩn { ten, url }
        files = parsed.map((item: any) => {
          if (typeof item === "string") return { ten: "", url: item };
          if (typeof item === "object")
            return { ten: item.ten || "", url: item.url || "" };
          return { ten: "", url: "" };
        });
      } catch {}
    }

    return data ? { ...data, file_thiet_ke: files } : { file_thiet_ke: [] };
  });

  // --- HANDLERS ---

  const handleChange = (field: keyof FormState, value: any) => {
    setFormData((prev) => ({ ...prev, [field]: value }));
  };

  const handleFileChange = (
    index: number,
    field: keyof FileItem,
    value: string
  ) => {
    const newFiles = [...formData.file_thiet_ke];
    if (!newFiles[index]) return;
    newFiles[index] = { ...newFiles[index], [field]: value };
    setFormData((prev) => ({ ...prev, file_thiet_ke: newFiles }));
  };

  const addFileRow = () => {
    setFormData((prev) => ({
      ...prev,
      file_thiet_ke: [...prev.file_thiet_ke, { ten: "", url: "" }],
    }));
  };

  const removeFileRow = (index: number) => {
    const newFiles = [...formData.file_thiet_ke];
    newFiles.splice(index, 1);
    setFormData((prev) => ({ ...prev, file_thiet_ke: newFiles }));
  };

  const handleSubmit = async () => {
    // 1. Validate thông tin chung
    if (!formData.mo_ta?.trim()) {
      alert("Vui lòng nhập Tên mẫu thiết kế!");
      return;
    }
    if (!formData.phan_loai) {
      alert("Vui lòng chọn Phân loại!");
      return;
    }

    // 2. Validate file
    const validFiles = formData.file_thiet_ke.filter(
      (f) => f.ten.trim() !== "" || f.url.trim() !== ""
    );
    const hasError = validFiles.some(
      (f) => f.ten.trim() === "" || f.url.trim() === ""
    );

    if (hasError) {
      alert(
        "Vui lòng nhập đầy đủ TÊN HIỂN THỊ và ĐƯỜNG DẪN cho file thiết kế!"
      );
      return;
    }

    // 3. Submit (GỬI MẢNG TRỰC TIẾP - Backend sẽ tự lo Stringify)
    // 🟢 SỬA: Không JSON.stringify ở đây nữa
    const finalData = {
      ...formData,
      file_thiet_ke: validFiles,
    };

    await onSubmit(finalData);
  };

  return (
    <KhungForm
      onClose={onClose}
      title={data ? "SỬA MẪU" : "THÊM MẪU MỚI"}
      onSubmit={handleSubmit}
      loading={loading}
      isDirty={true}
      showAvatarUpload={true}
      uploadBucket="images"
      avatar={formData.hinh_anh}
      onUploadComplete={(url) => handleChange("hinh_anh", url)}
    >
      <div className="space-y-4">
        {/* Tên mẫu */}
        <div>
          <label className="text-xs font-bold text-white/60 mb-2 block uppercase">
            Tên mẫu thiết kế <span className="text-red-500">*</span>
          </label>
          <input
            className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:border-[#C69C6D] outline-none placeholder-white/20"
            value={formData.mo_ta || ""}
            onChange={(e) => handleChange("mo_ta", e.target.value)}
            placeholder="Nhập tên mẫu..."
          />
        </div>

        {/* Phân loại */}
        <div>
          <label className="text-xs font-bold text-white/60 mb-2 block uppercase">
            Phân loại <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <select
              className="w-full bg-[#1a1a1a] text-white border border-white/10 rounded-lg px-4 py-3 focus:border-[#C69C6D] outline-none appearance-none"
              value={formData.phan_loai || ""}
              onChange={(e) => handleChange("phan_loai", e.target.value)}
            >
              <option value="" className="bg-[#1a1a1a] text-gray-500">
                -- Chọn loại --
              </option>
              {config.fields
                .find((f) => f.key === "phan_loai")
                ?.options?.map((opt: any) => (
                  <option
                    key={opt}
                    value={opt}
                    className="bg-[#1a1a1a] text-white py-2"
                  >
                    {opt}
                  </option>
                ))}
            </select>
            <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-white/50 text-xs">
              ▼
            </div>
          </div>
        </div>

        {/* File Thiết Kế */}
        <div>
          <div className="flex items-center justify-between mb-2">
            <label className="text-xs font-bold text-white/60 uppercase">
              File Thiết Kế (Google Drive)
            </label>
            <button
              type="button"
              onClick={addFileRow}
              className="flex items-center gap-1 text-[10px] bg-[#C69C6D]/20 text-[#C69C6D] hover:bg-[#C69C6D] hover:text-black px-2 py-1 rounded transition-all font-bold"
            >
              <Plus size={12} /> THÊM FILE
            </button>
          </div>

          <div className="space-y-2">
            {formData.file_thiet_ke.map((file, idx) => (
              <div key={idx} className="flex gap-2 items-start">
                {/* Tên */}
                <div className="w-1/3 relative group">
                  <div className="absolute left-3 top-1/2 -translate-y-1/2 text-white/30">
                    <Type size={14} />
                  </div>
                  <input
                    className={`w-full bg-white/5 border rounded-lg pl-9 pr-3 py-2.5 text-white text-xs outline-none placeholder-white/20 transition-all ${
                      file.ten.trim() === "" && file.url.trim() !== ""
                        ? "border-red-500/50 focus:border-red-500"
                        : "border-white/10 focus:border-[#C69C6D]"
                    }`}
                    placeholder="Tên hiển thị..."
                    value={file.ten}
                    onChange={(e) =>
                      handleFileChange(idx, "ten", e.target.value)
                    }
                  />
                </div>
                {/* Link */}
                <div className="flex-1 relative group">
                  <div className="absolute left-3 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-[#C69C6D] transition-colors">
                    <LinkIcon size={14} />
                  </div>
                  <input
                    className={`
                        w-full bg-white/5 border rounded-lg pl-9 pr-4 py-2.5 text-white text-xs outline-none placeholder-white/20 transition-all
                        ${
                          file.url.trim() === "" && file.ten.trim() !== ""
                            ? "border-red-500/50 focus:border-red-500"
                            : "border-white/10 focus:border-[#C69C6D]"
                        }
                    `}
                    value={file.url}
                    onChange={(e) =>
                      handleFileChange(idx, "url", e.target.value)
                    }
                    placeholder="Dán link Google Drive..."
                  />
                </div>
                {/* Xóa */}
                <button
                  type="button"
                  onClick={() => removeFileRow(idx)}
                  className="p-2 text-white/20 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-colors shrink-0 mt-[2px]"
                >
                  <Trash2 size={16} />
                </button>
              </div>
            ))}

            {formData.file_thiet_ke.length === 0 && (
              <div
                onClick={addFileRow}
                className="text-[10px] text-white/20 italic text-center py-3 border border-dashed border-white/10 rounded-lg cursor-pointer hover:border-white/30 transition-colors"
              >
                Chưa có file nào. Nhấn để thêm.
              </div>
            )}
          </div>
        </div>
      </div>
    </KhungForm>
  );
}
</file>

<file path="app/components/cacchucnang/viecmau/MauThietKeList.tsx">
"use client";

import React from "react";
import { Palette, User, Link as LinkIcon } from "lucide-react";
import { MauThietKe } from "./config";

interface Props {
  items: MauThietKe[];
  bulkMode: boolean;
  selectedIds: Set<string>;
  onToggleSelect: (id: string) => void;
  onClickItem: (item: MauThietKe) => void;
}

export default function MauThietKeList({
  items,
  bulkMode,
  selectedIds,
  onToggleSelect,
  onClickItem,
}: Props) {
  // Helper: Đếm số lượng file thiết kế
  const getFileCount = (item: MauThietKe) => {
    const files = item.file_thiet_ke;
    if (Array.isArray(files))
      return files.filter((f) => f && f.trim() !== "").length;
    if (typeof files === "string") {
      try {
        const parsed = JSON.parse(files);
        return Array.isArray(parsed)
          ? parsed.filter((f: any) => f && f.trim() !== "").length
          : 0;
      } catch {
        return 0;
      }
    }
    return 0;
  };

  return (
    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-2 p-2 md:p-4">
      {items.map((item) => {
        const fileCount = getFileCount(item);

        return (
          <div
            key={item.id}
            onClick={(e) => {
              if (bulkMode) {
                e.stopPropagation();
                onToggleSelect(item.id);
              } else {
                onClickItem(item);
              }
            }}
            className={`
                group relative bg-[#0f0f0f] border border-white/10 rounded-lg overflow-hidden cursor-pointer 
                hover:border-[#C69C6D]/50 transition-all 
                ${
                  selectedIds.has(item.id)
                    ? "border-[#C69C6D] bg-[#C69C6D]/10"
                    : ""
                }
            `}
          >
            {/* 🟢 HIỂN THỊ SỐ LƯỢNG FILE THIẾT KẾ (Badge) */}
            {fileCount > 0 && (
              <div className="absolute top-1 left-1 z-10 flex items-center gap-1 bg-black/60 backdrop-blur-sm px-1.5 py-0.5 rounded text-[9px] font-bold text-[#C69C6D] border border-white/10 shadow-sm">
                <LinkIcon size={10} />
                <span>{fileCount}</span>
              </div>
            )}

            {/* Checkbox Bulk Mode */}
            {bulkMode && (
              <div className="absolute top-1 right-1 z-10 w-5 h-5 border-2 rounded flex items-center justify-center transition-colors border-white/30 bg-black/50">
                {selectedIds.has(item.id) && (
                  <span className="text-[#C69C6D] font-bold text-xs">✓</span>
                )}
              </div>
            )}

            {/* Hình ảnh */}
            <div className="aspect-square w-full bg-[#1a1a1a] relative group-hover:opacity-90 transition-opacity">
              {item.hinh_anh ? (
                <img
                  src={item.hinh_anh}
                  alt=""
                  className="w-full h-full object-cover"
                  loading="lazy"
                />
              ) : (
                <div className="w-full h-full flex items-center justify-center text-white/10">
                  <Palette size={24} />
                </div>
              )}
            </div>

            {/* Nội dung (Đã căn giữa) */}
            <div className="p-2 text-center">
              <h3 className="font-bold text-white truncate text-xs leading-tight">
                {item.mo_ta}
              </h3>
              <p className="text-[9px] text-[#C69C6D] mt-0.5 truncate uppercase opacity-80">
                {item.phan_loai}
              </p>
              <div className="mt-1 flex items-center justify-center gap-1 text-[9px] text-white/30 truncate">
                <User size={8} />
                <span className="truncate">{item.ten_nguoi_tao || "---"}</span>
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
}
</file>

<file path="app/components/ConfirmDialog.tsx">
'use client';

import React, { useEffect, useState } from 'react';
import { createPortal } from 'react-dom';
import { AlertTriangle, CheckCircle2, X } from 'lucide-react';

interface ConfirmDialogProps {
  isOpen: boolean;
  title: string;
  message: string;
  confirmText?: string;
  cancelText?: string;
  isDangerous?: boolean; // Nếu true nút sẽ màu đỏ (Xóa)
  isLoading?: boolean;
  onConfirm: () => void;
  onCancel: () => void;
}

export default function ConfirmDialog({
  isOpen,
  title,
  message,
  confirmText = 'Xác nhận',
  cancelText = 'Hủy bỏ',
  isDangerous = false,
  isLoading = false,
  onConfirm,
  onCancel
}: ConfirmDialogProps) {
  const [mounted, setMounted] = useState(false);

  useEffect(() => { setMounted(true); }, []);

  if (!mounted || !isOpen) return null;

  return createPortal(
    <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
      {/* Backdrop mờ ảo */}
      <div 
        className="absolute inset-0 bg-black/80 backdrop-blur-sm animate-in fade-in duration-300"
        onClick={!isLoading ? onCancel : undefined}
      />

      {/* Dialog Content */}
      <div className="relative w-full max-w-sm bg-[#1a120f] border border-[#C69C6D]/40 rounded-2xl shadow-[0_0_50px_rgba(0,0,0,0.8)] overflow-hidden animate-in zoom-in-95 duration-300">
        
        {/* Glow effect phía trên */}
        <div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#C69C6D] to-transparent opacity-70"></div>

        <div className="p-6 text-center">
          {/* Icon */}
          <div className="mx-auto w-16 h-16 mb-4 flex items-center justify-center rounded-full bg-black border border-[#C69C6D]/20 shadow-inner">
            {isDangerous ? (
              <AlertTriangle size={32} className="text-red-500 animate-pulse" />
            ) : (
              <CheckCircle2 size={32} className="text-[#C69C6D]" />
            )}
          </div>

          {/* Title & Message */}
          <h3 className="text-xl font-serif font-bold text-[#F5E6D3] mb-2 uppercase tracking-wide">
            {title}
          </h3>
          <p className="text-white/60 text-sm font-light leading-relaxed mb-6">
            {message}
          </p>

          {/* Actions */}
          <div className="flex gap-3">
            <button
              onClick={onCancel}
              disabled={isLoading}
              className="flex-1 py-3 rounded-xl border border-white/10 text-white/50 hover:text-white hover:bg-white/5 transition-all text-xs font-bold uppercase tracking-widest"
            >
              {cancelText}
            </button>
            <button
              onClick={onConfirm}
              disabled={isLoading}
              className={`flex-1 py-3 rounded-xl text-black font-bold uppercase tracking-widest transition-all shadow-lg active:scale-95 text-xs flex items-center justify-center gap-2
                ${isDangerous 
                  ? 'bg-red-600 hover:bg-red-500 text-white shadow-red-900/20' 
                  : 'bg-[#C69C6D] hover:bg-[#B58B5D] shadow-[#C69C6D]/20'
                }
                ${isLoading ? 'opacity-70 cursor-not-allowed' : ''}
              `}
            >
              {isLoading ? 'Đang xử lý...' : confirmText}
            </button>
          </div>
        </div>
      </div>
    </div>,
    document.body
  );
}
</file>

<file path="app/components/ErrorBoundary.tsx">
'use client';
import React, { ReactNode } from 'react';
import { AlertCircle } from 'lucide-react';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error?: Error;
}

export default class ErrorBoundary extends React.Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error) {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('ErrorBoundary caught:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return this.props.fallback || (
        <div className="flex items-center justify-center min-h-[100dvh] bg-red-50 p-4">
          <div className="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
            <div className="flex items-center gap-3 mb-4">
              <AlertCircle className="text-red-600" size={24} />
              <h2 className="text-lg font-bold text-red-600">Có Lỗi Xảy Ra</h2>
            </div>
            <p className="text-gray-700 mb-4">Ứng dụng gặp sự cố. Vui lòng refresh trang hoặc liên hệ hỗ trợ.</p>
            <button
              onClick={() => window.location.reload()}
              className="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
            >
              Reload
            </button>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}
</file>

<file path="app/components/PushManager.tsx">
'use client';
import React, { useEffect, useState } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import { BellRing, Loader2 } from 'lucide-react';

const VAPID_PUBLIC_KEY = process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY;

// Hàm chuyển đổi key VAPID
function urlBase64ToUint8Array(base64String: string) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

export default function PushManager() {
    const { user } = useUser();
    const [isSupported, setIsSupported] = useState(false);
    const [subscription, setSubscription] = useState<PushSubscription | null>(null);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if ('serviceWorker' in navigator && 'PushManager' in window) {
            setIsSupported(true);
            registerServiceWorker();
        }
    }, []);

    const registerServiceWorker = async () => {
        try {
            const registration = await navigator.serviceWorker.register('/sw.js', {
                scope: '/',
                updateViaCache: 'none',
            });
            
            // Check nếu đã subscribe rồi
            const sub = await registration.pushManager.getSubscription();
            setSubscription(sub);
        } catch (error) {
            console.error('Service Worker Error:', error);
        }
    };

    const subscribeToPush = async () => {
        if (!user || !VAPID_PUBLIC_KEY) return;
        setLoading(true);

        try {
            const registration = await navigator.serviceWorker.ready;
            
            // 1. Yêu cầu trình duyệt cấp quyền (Nó sẽ hiện popup của Chrome/Safari)
            const sub = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
            });

            // 2. Gửi về Server lưu lại
            await fetch('/api/push/subscribe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    subscription: sub,
                    user_id: user.id,
                    user_agent: navigator.userAgent
                })
            });

            setSubscription(sub);
            alert("Đã bật thông báo thành công! Bạn sẽ nhận được tin tức mới nhất ngay trên màn hình khóa.");
        } catch (error) {
            console.error('Subscription failed:', error);
            alert("Vui lòng kiểm tra lại quyền thông báo trong cài đặt trình duyệt.");
        } finally {
            setLoading(false);
        }
    };

    // Nếu chưa hỗ trợ, hoặc đã đăng ký rồi thì ẩn
    if (!isSupported || subscription || !user) return null;

    return (
        <div className="fixed bottom-24 left-6 z-[8000] animate-in slide-in-from-left duration-500">
            <button 
                onClick={subscribeToPush}
                disabled={loading}
                className="flex items-center gap-3 px-4 py-3 bg-[#C69C6D] hover:bg-white text-black font-bold rounded-xl shadow-[0_0_20px_rgba(198,156,109,0.4)] transition-all active:scale-95 group"
            >
                <div className="bg-black/10 p-1.5 rounded-full">
                    {loading ? <Loader2 size={16} className="animate-spin"/> : <BellRing size={16} className="animate-wiggle"/>}
                </div>
                <div className="text-left">
                    <p className="text-[10px] uppercase tracking-wider opacity-70">Đừng bỏ lỡ</p>
                    <p className="text-xs font-black">BẬT THÔNG BÁO ĐẨY</p>
                </div>
            </button>
            <style jsx>{`
                @keyframes wiggle { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }
                .animate-wiggle { animation: wiggle 0.3s ease-in-out infinite; }
            `}</style>
        </div>
    );
}
</file>

<file path="app/CongDangNhap/AuthService.ts">
import { supabase } from '@/app/ThuVien/ketNoiSupabase';
import { DataNormalizer } from '@/app/ThuVien/DataNormalizer';

// --- ĐỊNH NGHĨA KIỂU DỮ LIỆU CHUẨN ---

// Quyền hạn mặc định (có thể mở rộng sau này)
const DEFAULT_PERMISSIONS = {
  isAdmin: false,
  canView: true,
  canEdit: false,
  canDelete: false,
};

export interface UserInfo {
  id: string;
  email: string;
  ho_ten: string | null;
  so_dien_thoai: string | null;
  hinh_anh?: string | null;
  
  // Phân loại quan trọng
  userType: 'nhan_su' | 'khach_hang';
  role: string; // Đây là giá trị quan trọng nhất để định tuyến (VD: 'admin', 'sales', 'khtrongtam')
  
  // Các trường chi tiết từ DB (để hiển thị)
  vi_tri?: string | null;            // VD: "Thợ Sản Xuất"
  vi_tri_normalized?: string | null; // VD: "thosanxuat"
  phan_loai?: string | null;         // VD: "KH Trọng tâm"
  phan_loai_normalized?: string | null; // VD: "khtrongtam"
  
  permissions: typeof DEFAULT_PERMISSIONS;
}

export class AuthService {

  /**
   * 1. HÀM CỐT LÕI: NHẬN DIỆN USER QUA EMAIL
   * Logic: Check bảng nhan_su trước -> Nếu không có thì check khach_hang
   */
  static async identifyUser(email: string): Promise<UserInfo | null> {
    if (!email) return null;
    const cleanEmail = email.trim().toLowerCase();

    try {
      // --- BƯỚC 1: TÌM TRONG BẢNG NHÂN SỰ ---
      const { data: nhanSu, error: errNS } = await supabase
        .from('nhan_su')
        .select('*')
        .eq('email', cleanEmail)
        .single();

      if (nhanSu && !errNS) {
        // Nếu là nhân sự, role chính là vi_tri_normalized
        // Nếu vi_tri_normalized null, fallback về 'parttime' cho an toàn
        const roleCode = nhanSu.vi_tri_normalized || 'parttime';
        
        return {
          id: nhanSu.id,
          email: nhanSu.email,
          ho_ten: nhanSu.ho_ten,
          so_dien_thoai: nhanSu.so_dien_thoai,
          hinh_anh: nhanSu.hinh_anh,
          
          userType: 'nhan_su',
          role: roleCode, // <-- Dùng cái này để tra bảng routing_permissions
          
          vi_tri: nhanSu.vi_tri,
          vi_tri_normalized: roleCode,
          
          permissions: {
            ...DEFAULT_PERMISSIONS,
            isAdmin: roleCode === 'admin' || roleCode === 'quanly'
          }
        };
      }

      // --- BƯỚC 2: TÌM TRONG BẢNG KHÁCH HÀNG ---
      const { data: khachHang, error: errKH } = await supabase
        .from('khach_hang')
        .select('*')
        .eq('email', cleanEmail)
        .single();

      if (khachHang && !errKH) {
        // Nếu là khách hàng, role chính là phan_loai_normalized
        // VD: 'vip', 'doitac', 'khtrongtam'
        const roleCode = khachHang.phan_loai_normalized || 'moi';

        return {
          id: khachHang.id,
          email: khachHang.email,
          ho_ten: khachHang.ho_ten,
          so_dien_thoai: khachHang.so_dien_thoai,
          
          userType: 'khach_hang',
          role: roleCode, // <-- Dùng cái này để tra bảng routing_permissions

          phan_loai: khachHang.phan_loai,
          phan_loai_normalized: roleCode,
          
          permissions: DEFAULT_PERMISSIONS
        };
      }

      // Không tìm thấy ở đâu cả
      return null;

    } catch (error) {
      console.error('AuthService: Lỗi định danh user:', error);
      return null;
    }
  }

  /**
   * 2. HÀM HỖ TRỢ: LẤY USER HIỆN TẠI TỪ SESSION
   * Dùng cho Client Side (UserContext)
   */
  static async getCurrentUser(): Promise<UserInfo | null> {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user || !user.email) return null;

    // Gọi hàm identify ở trên để lấy thông tin chi tiết từ DB
    return await this.identifyUser(user.email);
  }

  /**
   * 3. HÀM RPC (QUAN TRỌNG CHO CONGDANGNHAP.TSX)
   * Hàm này gọi RPC trong database để bypass RLS nếu cần thiết,
   * hoặc đơn giản là tái sử dụng logic identifyUser ở trên.
   * Để đảm bảo tương thích với code cũ của bạn, tôi viết hàm này wrap lại logic trên.
   */
  static async getUserByEmailWithRpc(email: string): Promise<UserInfo | null> {
    // Ưu tiên dùng logic identifyUser ở trên vì nó query trực tiếp bảng chuẩn
    return await this.identifyUser(email);
    
    /* Ghi chú: Nếu bạn thực sự muốn dùng RPC (Database Function) 'get_user_profile_by_email', 
       hãy đảm bảo function đó trong Postgres trả về đúng cấu trúc cột như mong đợi.
       Hiện tại, query trực tiếp (client-side query) là an toàn và dễ debug nhất 
       với cấu trúc bảng bạn vừa cung cấp.
    */
  }

  /**
   * 4. ĐĂNG XUẤT
   */
  static async signOut() {
    return await supabase.auth.signOut();
  }

  /**
   * 5. HELPER: KIỂM TRA QUYỀN ADMIN
   */
  static async isCurrentUserAdmin(): Promise<boolean> {
    const user = await this.getCurrentUser();
    return user?.permissions.isAdmin ?? false;
  }
}
</file>

<file path="app/CongDangNhap/middleware.ts">
import { createServerClient } from '@supabase/ssr';
import { NextResponse, type NextRequest } from 'next/server';

// Route công khai
const PUBLIC_ROUTES = [
  '/', 
  '/trangchu', 
  '/dathang', 
  '/CongDangNhap',
  '/auth/callback',
  '/login'
];

// Route tĩnh
const STATIC_PATHS = [
  '/_next', '/api', '/static', '/favicon.ico', '/manifest.json', 
  '.png', '.jpg', '.jpeg', '.svg', '.css', '.js', '.mp3'
];

export async function middleware(request: NextRequest) {
  const path = request.nextUrl.pathname;

  // 1. Bỏ qua file tĩnh
  if (STATIC_PATHS.some(p => path.startsWith(p) || path.endsWith(p))) {
    return NextResponse.next();
  }

  let response = NextResponse.next({
    request: { headers: request.headers },
  });

  // Setup Supabase
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) { return request.cookies.get(name)?.value; },
        set(name: string, value: string, options: any) {
          request.cookies.set({ name, value, ...options });
          response = NextResponse.next({ request: { headers: request.headers } });
          response.cookies.set({ name, value, ...options });
        },
        remove(name: string, options: any) {
          request.cookies.set({ name, value: '', ...options });
          response = NextResponse.next({ request: { headers: request.headers } });
          response.cookies.set({ name, value: '', ...options });
        },
      },
    }
  );

  // 2. Lấy User
  const { data: { user } } = await supabase.auth.getUser();

  // A. CHƯA ĐĂNG NHẬP
  if (!user) {
    if (!PUBLIC_ROUTES.includes(path)) {
      return NextResponse.redirect(new URL('/?login=1', request.url));
    }
    return response;
  }

  // B. ĐÃ ĐĂNG NHẬP
  const email = user.email;
  if (!email) return response;

  // 3. Xác định Role
  let userType = '';
  let roleNormalized = '';

  const { data: nhanSu } = await supabase
    .from('nhan_su')
    .select('vi_tri_normalized')
    .eq('email', email)
    .single();

  if (nhanSu) {
    userType = 'nhan_su';
    roleNormalized = nhanSu.vi_tri_normalized || 'parttime';
  } else {
    const { data: khachHang } = await supabase
      .from('khach_hang')
      .select('phan_loai_normalized')
      .eq('email', email)
      .single();

    if (khachHang) {
      userType = 'khach_hang';
      roleNormalized = khachHang.phan_loai_normalized || 'moi';
    } else {
      // User rác -> Logout
      await supabase.auth.signOut();
      return NextResponse.redirect(new URL('/', request.url));
    }
  }

  // 4. Kiểm tra quyền (Có Fallback)
  if (roleNormalized === 'admin' || roleNormalized === 'boss') {
    return response; 
  }

  // Thử đọc DB
  const { data: permission } = await supabase
    .from('routing_permissions')
    .select('allowed_routes, default_route')
    .eq('user_type', userType)
    .eq('role_normalized', roleNormalized)
    .single();

  let allowedRoutes: string[] = [];
  let defaultRoute = '/';

  if (permission) {
    // Có dữ liệu DB
    defaultRoute = permission.default_route || '/';
    if (Array.isArray(permission.allowed_routes)) {
        allowedRoutes = permission.allowed_routes;
    } else if (typeof permission.allowed_routes === 'string') {
        try { allowedRoutes = JSON.parse(permission.allowed_routes); } catch {}
    }
  } else {
    // 🟢 DÙNG FALLBACK TRONG CODE (Quan trọng)
    if (userType === 'nhan_su') {
        defaultRoute = `/phong${roleNormalized}`; // VD: /phongparttime
        allowedRoutes = [defaultRoute, '/dashboard'];
        
        // Fix đặc biệt cho trường hợp mapping không đều
        if (roleNormalized === 'thosanxuat') defaultRoute = '/phongtho';
        if (roleNormalized === 'congtacvien') defaultRoute = '/phongctv';
        
        allowedRoutes.push(defaultRoute);
    } else {
        allowedRoutes = ['/trangchu', '/dathang'];
        defaultRoute = '/trangchu';
    }
  }

  // Logic chặn đường
  const isAllowed = PUBLIC_ROUTES.includes(path) || allowedRoutes.some(route => {
    return path === route || path.startsWith(`${route}/`);
  });

  if (isAllowed) {
    return response;
  } else {
    // Redirect về phòng chuẩn
    if (path === defaultRoute) {
        // Tránh loop nếu defaultRoute cũng lỗi
        return NextResponse.redirect(new URL(userType === 'nhan_su' ? '/phongparttime' : '/', request.url));
    }
    return NextResponse.redirect(new URL(defaultRoute, request.url));
  }
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico).*)',
  ],
};
</file>

<file path="app/constants/zIndex.ts">
// ✅ Z-INDEX MANAGEMENT SYSTEM
// Centralized z-index values to prevent conflicts

export const Z_INDEX = {
  // Background layers
  background: 0,
  backgroundImage: 1,
  gradient: 4900,

  // Main content
  content: 10,
  contentOverlay: 20,

  // Menu system
  menuTren: 5000,
  menuDuoi: 5000,
  menuButton: 11000,

  // Chat system
  chatDrawer: 5500,
  chatToast: 5600,

  // Modals & Overlays
  modalBackdrop: 9900,
  modal: 9999,

  // Floating elements
  adminTools: 5001,
  loginButton: 5002,

  // Utilities
  tooltip: 10000,
  notification: 10100,
} as const;

// Export type for TypeScript strict checks
export type ZIndexKey = keyof typeof Z_INDEX;
</file>

<file path="app/dashboard/admin/page.tsx">
'use client';

import React from 'react';
import { useRouter } from 'next/navigation';
import { useUser } from '@/app/ThuVien/UserContext';
import { BarChart3, Users, Settings, AlertCircle } from 'lucide-react';

/**
 * 📊 ADMIN DASHBOARD
 * Route: /dashboard/admin
 */
export default function AdminDashboardPage() {
  const router = useRouter();
  const { user, loading } = useUser();

  // Loading state
  if (loading) {
    return (
      <div className="min-h-[100dvh] bg-[#050505] flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#C69C6D] mx-auto mb-4" />
          <p className="text-gray-400">Đang tải...</p>
        </div>
      </div>
    );
  }

  // No user - redirect
  if (!user) {
    router.push('/');
    return null;
  }

  return (
    <div className="min-h-[100dvh] bg-[#050505] p-4 md:p-8">
      {/* HEADER */}
      <div className="mb-8">
        <h1 className="text-4xl font-bold text-[#C69C6D] mb-2">📊 Admin Dashboard</h1>
        <p className="text-white/70">
          Chào {user.ho_ten} ({user.userType === 'nhan_su' ? user.vi_tri_normalized : user.phan_loai_normalized})
        </p>
      </div>

      {/* STATS GRID */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <StatCard icon={Users} title="Users" value="1,234" color="blue" />
        <StatCard icon={BarChart3} title="Analytics" value="85%" color="green" />
        <StatCard icon={Settings} title="Products" value="567" color="purple" />
        <StatCard icon={AlertCircle} title="Alerts" value="42" color="red" />
      </div>

      {/* SECTIONS */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div className="bg-[#1a120f] border border-[#8B5E3C]/30 rounded-lg p-6">
          <h2 className="text-xl font-bold text-[#C69C6D] mb-4 flex items-center gap-2">
            <Users size={20} /> User Management
          </h2>
          <p className="text-white/70 mb-4">Manage system users and roles</p>
          <button className="px-4 py-2 bg-[#C69C6D] text-black rounded font-bold hover:bg-white transition-all">
            Manage Users
          </button>
        </div>

        <div className="bg-[#1a120f] border border-[#8B5E3C]/30 rounded-lg p-6">
          <h2 className="text-xl font-bold text-[#C69C6D] mb-4 flex items-center gap-2">
            <Settings size={20} /> System Settings
          </h2>
          <p className="text-white/70 mb-4">Configure system settings</p>
          <button className="px-4 py-2 bg-[#C69C6D] text-black rounded font-bold hover:bg-white transition-all">
            Settings
          </button>
        </div>

        <div className="bg-[#1a120f] border border-[#8B5E3C]/30 rounded-lg p-6">
          <h2 className="text-xl font-bold text-[#C69C6D] mb-4 flex items-center gap-2">
            <BarChart3 size={20} /> Analytics
          </h2>
          <p className="text-white/70 mb-4">View detailed analytics</p>
          <button className="px-4 py-2 bg-[#C69C6D] text-black rounded font-bold hover:bg-white transition-all">
            View Analytics
          </button>
        </div>

        <div className="bg-[#1a120f] border border-[#8B5E3C]/30 rounded-lg p-6">
          <h2 className="text-xl font-bold text-[#C69C6D] mb-4">Content Management</h2>
          <p className="text-white/70 mb-4">Manage website content</p>
          <button className="px-4 py-2 bg-[#C69C6D] text-black rounded font-bold hover:bg-white transition-all">
            Manage Content
          </button>
        </div>
      </div>
    </div>
  );
}

interface StatCardProps {
  icon: React.ElementType;
  title: string;
  value: string;
  color: string;
}

function StatCard({ icon: Icon, title, value, color }: StatCardProps) {
  const colorClasses: Record<string, string> = {
    blue: 'text-blue-400 bg-blue-900/20 border-blue-500',
    green: 'text-green-400 bg-green-900/20 border-green-500',
    purple: 'text-purple-400 bg-purple-900/20 border-purple-500',
    red: 'text-red-400 bg-red-900/20 border-red-500',
  };

  return (
    <div className={`${colorClasses[color]} border rounded-lg p-6`}>
      <Icon size={24} />
      <p className="text-white/70 text-sm mt-2">{title}</p>
      <p className="text-2xl font-bold mt-2">{value}</p>
    </div>
  );
}
</file>

<file path="app/DuLieuBackend.md">
| ?column? |
| -------- |

| # DATABASE SCHEMA DOCUMENTATION

## Table: bang_luong

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| nhan_su_id | uuid | YES | - | |
| thang | integer | YES | - | |
| nam | integer | YES | - | |
| tong_thu_nhap | numeric | YES | 0... | |
| trang_thai | text | YES | 'chua_chot'::text... | |
| created_at | timestamp with time zone | YES | now()... | |

> Constraints:

- CHECK: 27491_54977_1_not_null

## Table: cac_buoc_mau

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| quy_trinh_id | uuid | YES | - | 🔗 FK -> quy_trinh_mau.id |
| ten_buoc | text | YES | - | |
| thu_tu | integer | YES | - | |
| thoi_gian_chuan | integer | YES | - | |
| huong_dan_ky_thuat | text | YES | - | |
| video_huong_dan | text | YES | - | |
| diem_thuong | integer | YES | 10... | |

> Constraints:

- FOREIGN KEY: cac_buoc_mau_quy_trinh_id_fkey
- CHECK: 27491_53195_1_not_null

## Table: cau_hinh_hop_qua

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | text | NO | - | 🔑 PK |
| ten_qua | text | YES | - | |
| ti_le_roi | double precision | YES | - | |
| loai_qua | text | YES | - | |
| gia_tri | numeric | YES | - | |
| hinh_anh | text | YES | - | |

> Constraints:

- CHECK: 27491_53393_1_not_null

## Table: dinh_muc

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| thanh_pham_id | uuid | YES | - | 🔗 FK -> vat_tu.id |
| nguyen_lieu_id | uuid | YES | - | 🔗 FK -> vat_tu.id |
| so_luong_can | numeric | YES | - | |

> Constraints:

- FOREIGN KEY: dinh_muc_nguyen_lieu_id_fkey
- FOREIGN KEY: dinh_muc_thanh_pham_id_fkey
- CHECK: 27491_53209_1_not_null

## Table: don_hang

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| organization_id | uuid | YES | - | |
| ma_don | text | YES | - | |
| khach_hang_id | uuid | YES | - | 🔗 FK -> khach_hang.id |
| sales_phu_trach_id | uuid | YES | - | 🔗 FK -> nhan_su.id |
| nguoi_tao_id | uuid | YES | - | 🔗 FK -> nhan_su.id |
| trang_thai | text | YES | 'moi'::text... | |
| tong_tien | numeric | YES | 0... | |
| da_thanh_toan | numeric | YES | 0... | |
| kenh_ban_hang | text | YES | - | |
| ghi_chu | text | YES | - | |
| thong_tin_giao_hang | jsonb | YES | - | |
| tao_luc | timestamp with time zone | YES | now()... | |
| cap_nhat_luc | timestamp with time zone | YES | now()... | |

> Constraints:

- FOREIGN KEY: don_hang_khach_hang_id_fkey
- UNIQUE: don_hang_ma_don_key
- FOREIGN KEY: don_hang_nguoi_tao_id_fkey
- FOREIGN KEY: don_hang_sales_phu_trach_id_fkey
- CHECK: 27491_53227_1_not_null

## Table: don_hang_chi_tiet

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| don_hang_id | uuid | YES | - | 🔗 FK -> don_hang.id |
| vat_tu_id | uuid | YES | - | 🔗 FK -> vat_tu.id |
| ten_item_hien_thi | text | YES | - | |
| so_luong | integer | YES | - | |
| don_gia | numeric | YES | - | |
| thanh_tien | numeric | YES | - | |
| quy_trinh_id | uuid | YES | - | 🔗 FK -> quy_trinh_mau.id |
| yeu_cau_rieng | jsonb | YES | - | |

> Constraints:

- FOREIGN KEY: don_hang_chi_tiet_don_hang_id_fkey
- FOREIGN KEY: don_hang_chi_tiet_quy_trinh_id_fkey
- FOREIGN KEY: don_hang_chi_tiet_vat_tu_id_fkey
- CHECK: 27491_53257_1_not_null

## Table: khach_hang

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| ho_ten | text | YES | - | |
| so_dien_thoai | text | YES | - | |
| nguoi_tao | uuid | YES | - | 🔗 FK -> nhan_su.id |
| tao_luc | timestamp with time zone | YES | now()... | |
| email | text | YES | - | |
| phan_loai | text | YES | - | |
| phan_loai_normalized | text | YES | - | |
| hinh_anh | text | YES | - | |
| dia_chi | text | YES | - | |
| organization_id | uuid | YES | '00000000-0000-0000-... | |
| art_coin | integer | YES | 0... | |
| hang_thanh_vien | text | YES | 'Newbie'::text... | |
| tong_chi_tieu_tich_luy | numeric | YES | 0... | |
| nguoi_gioi_thieu_id | uuid | YES | - | 🔗 FK -> nhan_su.id |
| metadata_so_thich | jsonb | YES | '{}'::jsonb... | |
| vi_blockchain | text | YES | - | |

> Constraints:

- FOREIGN KEY: fk_khachhang_nhansu_chinh
- FOREIGN KEY: khach_hang_nguoi_gioi_thieu_id_fkey
- CHECK: 27491_43793_1_not_null

## Table: lenh_san_xuat

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| organization_id | uuid | YES | - | |
| ma_lenh | text | YES | - | |
| don_hang_chi_tiet_id | uuid | YES | - | 🔗 FK -> don_hang_chi_tiet.id |
| quy_trinh_id | uuid | YES | - | 🔗 FK -> quy_trinh_mau.id |
| trang_thai | text | YES | 'moi'::text... | |
| tien_do | integer | YES | 0... | |
| nguoi_phu_trach | uuid | YES | - | 🔗 FK -> nhan_su.id |
| ma_qr_san_pham | text | YES | - | |
| bat_dau_luc | timestamp with time zone | YES | - | |
| ket_thuc_luc | timestamp with time zone | YES | - | |

> Constraints:

- FOREIGN KEY: lenh_san_xuat_don_hang_chi_tiet_id_fkey
- UNIQUE: lenh_san_xuat_ma_lenh_key
- FOREIGN KEY: lenh_san_xuat_nguoi_phu_trach_fkey
- FOREIGN KEY: lenh_san_xuat_quy_trinh_id_fkey
- CHECK: 27491_53280_1_not_null

## Table: lich_su_trung_thuong

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| nhan_su_id | uuid | YES | - | 🔗 FK -> nhan_su.id |
| qua_id | text | YES | - | 🔗 FK -> cau_hinh_hop_qua.id |
| ngay_trung | timestamp with time zone | YES | now()... | |

> Constraints:

- FOREIGN KEY: lich_su_trung_thuong_nhan_su_id_fkey
- FOREIGN KEY: lich_su_trung_thuong_qua_id_fkey
- CHECK: 27491_53400_1_not_null

## Table: lich_su_vi_pham

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| nhan_su_id | uuid | YES | - | 🔗 FK -> nhan_su.id |
| loai | text | YES | - | |
| ly_do | text | YES | - | |
| so_tien | numeric | YES | - | |
| ngay_ghi_nhan | timestamp with time zone | YES | now()... | |

> Constraints:

- FOREIGN KEY: lich_su_vi_pham_nhan_su_id_fkey
- CHECK: 27491_53366_1_not_null

## Table: mau_thiet_ke

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| mo_ta | text | YES | - | |
| phan_loai | text | YES | - | |
| phan_loai_normalized | text | YES | - | |
| hinh_anh | text | YES | - | |
| nguoi_tao | uuid | YES | - | 🔗 FK -> nhan_su.id |
| tao_luc | timestamp with time zone | YES | now()... | |
| file_thiet_ke | jsonb | YES | '[]'::jsonb... | |

> Constraints:

- FOREIGN KEY: mau_thiet_ke_nguoi_tao_fkey
- CHECK: 27491_55088_1_not_null

## Table: nhan_su

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| vi_tri | text | YES | - | |
| email | text | YES | - | |
| so_dien_thoai | text | YES | - | |
| so_tai_khoan | text | YES | - | |
| ngan_hang | text | YES | - | |
| luong_thang | bigint | YES | 0... | |
| thuong_doanh_thu | bigint | YES | 0... | |
| hinh_anh | text | YES | - | |
| ho_ten | text | YES | - | |
| luong_theo_gio | numeric | YES | - | |
| nguoi_tao | uuid | YES | auth.uid()... | 🔗 FK -> nhan_su.id |
| tao_luc | timestamp with time zone | YES | now()... | |
| trang_thai | text | YES | 'Đang hoạt động'::te... | |
| vi_tri_normalized | text | YES | - | |
| organization_id | uuid | YES | '00000000-0000-0000-... | |
| ma_qr_dinh_danh | text | YES | - | |
| diem_cong_hien | integer | YES | 0... | |
| cap_bac_game | text | YES | 'Học việc'::text... | |
| so_sao_tin_nhiem | numeric | YES | 5.0... | |
| metadata_hanh_vi | jsonb | YES | '{}'::jsonb... | |
| luong_co_ban | numeric | YES | 0... | |

> Constraints:

- FOREIGN KEY: fk_nhan_su_nguoi_tao
- UNIQUE: nhan_su_email_unique
- UNIQUE: nhan_su_ma_qr_dinh_danh_key
- CHECK: 27491_27601_1_not_null

## Table: nhat_ky_san_xuat

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| lenh_san_xuat_id | uuid | YES | - | 🔗 FK -> lenh_san_xuat.id |
| buoc_mau_id | uuid | YES | - | 🔗 FK -> cac_buoc_mau.id |
| nhan_su_thuc_hien | uuid | YES | - | 🔗 FK -> nhan_su.id |
| thoi_gian_bat_dau | timestamp with time zone | YES | - | |
| thoi_gian_ket_thuc | timestamp with time zone | YES | - | |
| ket_qua | text | YES | - | |
| so_luong_hoan_thanh | integer | YES | - | |
| anh_thanh_pham | text | YES | - | |
| diem_thuong_nhan_duoc | integer | YES | 0... | |
| qua_tang_random | jsonb | YES | - | |

> Constraints:

- FOREIGN KEY: nhat_ky_san_xuat_buoc_mau_id_fkey
- FOREIGN KEY: nhat_ky_san_xuat_lenh_san_xuat_id_fkey
- FOREIGN KEY: nhat_ky_san_xuat_nhan_su_thuc_hien_fkey
- CHECK: 27491_53307_1_not_null

## Table: nhom_vat_tu

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| ten_nhom | text | YES | - | |
| organization_id | uuid | YES | - | |

> Constraints:

- CHECK: 27491_53159_1_not_null

## Table: notifications

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| user_id | uuid | NO | - | |
| type | text | NO | - | |
| category | text | NO | - | |
| title | text | NO | - | |
| message | text | YES | - | |
| from_user_id | uuid | YES | - | |
| from_user_name | text | YES | - | |
| from_user_avatar | text | YES | - | |
| related_id | text | YES | - | |
| action_url | text | YES | - | |
| is_read | boolean | YES | false... | |
| created_at | timestamp with time zone | YES | now()... | |
| updated_at | timestamp with time zone | YES | now()... | |

> Constraints:

- CHECK: 27491_54947_1_not_null
- CHECK: 27491_54947_2_not_null
- CHECK: 27491_54947_3_not_null
- CHECK: 27491_54947_4_not_null
- CHECK: 27491_54947_5_not_null

## Table: push_subscriptions

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| user_id | uuid | NO | - | |
| endpoint | text | NO | - | |
| p256dh | text | NO | - | |
| auth | text | NO | - | |
| user_agent | text | YES | - | |
| created_at | timestamp with time zone | YES | now()... | |

> Constraints:

- CHECK: 27491_54968_1_not_null
- CHECK: 27491_54968_2_not_null
- CHECK: 27491_54968_3_not_null
- CHECK: 27491_54968_4_not_null
- CHECK: 27491_54968_5_not_null

## Table: quy_trinh_mau

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| ten_quy_trinh | text | YES | - | |
| loai_ap_dung | text | YES | - | |
| organization_id | uuid | YES | - | |

> Constraints:

- CHECK: 27491_53187_1_not_null

## Table: routing_permissions

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | integer | NO | nextval('routing_per... | 🔑 PK |
| user_type | character varying | NO | - | |
| role_normalized | character varying | NO | - | |
| allowed_routes | ARRAY | NO | - | |
| default_route | character varying | NO | - | |
| created_at | timestamp with time zone | YES | now()... | |

> Constraints:

- CHECK: 27491_49689_1_not_null
- CHECK: 27491_49689_2_not_null
- CHECK: 27491_49689_3_not_null
- CHECK: 27491_49689_4_not_null
- CHECK: 27491_49689_5_not_null

## Table: slider_data

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | bigint | NO | - | 🔑 PK |
| loai_slider | text | NO | - | |
| tieu_de | text | YES | - | |
| mo_ta | text | YES | - | |
| hinh_anh | text | YES | - | |
| thu_tu | integer | YES | 0... | |
| tao_luc | timestamp with time zone | YES | now()... | |

> Constraints:

- CHECK: 27491_54911_1_not_null
- CHECK: 27491_54911_2_not_null

## Table: so_cai_tai_chinh

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| organization_id | uuid | YES | - | |
| loai_giao_dich | text | YES | - | |
| so_tien | numeric | YES | - | |
| mo_ta | text | YES | - | |
| tham_chieu_id | uuid | YES | - | |
| hinh_anh_chung_tu | text | YES | - | |
| nguoi_thuc_hien | uuid | YES | - | 🔗 FK -> nhan_su.id |
| tao_luc | timestamp with time zone | YES | now()... | |

> Constraints:

- FOREIGN KEY: so_cai_tai_chinh_nguoi_thuc_hien_fkey
- CHECK: 27491_53331_1_not_null

## Table: to_chuc

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| ten_to_chuc | text | NO | - | |
| ma_so_thue | text | YES | - | |
| cau_hinh | jsonb | YES | '{"theme": "dark", "... | |
| tao_luc | timestamp with time zone | YES | now()... | |

> Constraints:

- CHECK: 27491_53148_1_not_null
- CHECK: 27491_53148_2_not_null

## Table: tu_van_messages

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| session_id | uuid | YES | - | 🔗 FK -> tu_van_sessions.id |
| nguoi_gui_id | text | YES | - | |
| la_nhan_vien | boolean | YES | false... | |
| noi_dung | text | YES | - | |
| hinh_anh | text | YES | - | |
| tao_luc | timestamp with time zone | YES | now()... | |

> Constraints:

- FOREIGN KEY: tu_van_messages_session_id_fkey
- CHECK: 27491_54932_1_not_null

## Table: tu_van_sessions

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| khach_hang_id | uuid | YES | - | |
| khach_vang_lai_id | text | YES | - | |
| ten_hien_thi | text | YES | - | |
| sdt_lien_he | text | YES | - | |
| loai_khach | text | YES | 'vang_lai'::text... | |
| trang_thai | text | YES | 'cho_tu_van'::text... | |
| nhan_su_phu_trach_id | uuid | YES | - | |
| tin_nhan_cuoi | text | YES | - | |
| cap_nhat_luc | timestamp with time zone | YES | now()... | |
| tao_luc | timestamp with time zone | YES | now()... | |
| ho_tro_vien_ids | ARRAY | YES | '{}'::uuid[]... | |
| is_read | boolean | YES | true... | |
| last_sender_type | text | YES | 'staff'::text... | |

> Constraints:

- CHECK: 27491_54920_1_not_null

## Table: user_devices

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| user_id | uuid | YES | - | 🔗 FK -> nhan_su.id |
| fcm_token | text | NO | - | |
| platform | text | YES | - | |
| last_active | timestamp with time zone | YES | now()... | |

> Constraints:

- UNIQUE: user_devices_user_id_fcm_token_key
- FOREIGN KEY: user_devices_user_id_fkey
- CHECK: 27491_56281_1_not_null
- CHECK: 27491_56281_3_not_null

## Table: user_registrations

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| auth_user_id | uuid | YES | - | |
| ho_ten | text | YES | - | |
| email | text | YES | - | |
| so_dien_thoai | text | YES | - | |
| user_type | text | YES | - | |
| requested_vi_tri | text | YES | - | |
| requested_phan_loai | text | YES | - | |
| status | text | YES | 'pending'::text... | |
| created_at | timestamp with time zone | YES | now()... | |
| hinh_anh | text | YES | - | |
| details | jsonb | YES | - | |

> Constraints:

- CHECK: 27491_54958_1_not_null

## Table: vat_tu

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| organization_id | uuid | YES | - | |
| ma_sku | text | YES | - | |
| ten_vat_tu | text | NO | - | |
| loai_vat_tu | text | YES | - | |
| don_vi_tinh | text | YES | - | |
| gia_von | numeric | YES | 0... | |
| gia_ban | numeric | YES | 0... | |
| ton_kho | numeric | YES | 0... | |
| canh_bao_toi_thieu | numeric | YES | 10... | |
| nhom_id | uuid | YES | - | 🔗 FK -> nhom_vat_tu.id |
| bo_suu_tap | text | YES | - | |
| hinh_anh | text | YES | - | |
| metadata | jsonb | YES | '{}'::jsonb... | |

> Constraints:

- UNIQUE: vat_tu_ma_sku_key
- FOREIGN KEY: vat_tu_nhom_id_fkey
- CHECK: 27491_53167_1_not_null
- CHECK: 27491_53167_4_not_null

## Table: yeu_cau_ho_tro

| Column | Type | Nullable | Default | Extra |\n|---|---|---|---|---|\n| id | uuid | NO | gen_random_uuid()... | 🔑 PK |
| nguoi_gui_id | uuid | YES | - | 🔗 FK -> nhan_su.id |
| loai_yeu_cau | text | YES | - | |
| noi_dung | text | YES | - | |
| trang_thai | text | YES | 'moi'::text... | |
| nguoi_nhan_id | uuid | YES | - | 🔗 FK -> nhan_su.id |
| hinh_anh_dinh_kem | text | YES | - | |
| diem_thuong | integer | YES | 5... | |
| tao_luc | timestamp with time zone | YES | now()... | |

> Constraints:

- FOREIGN KEY: yeu_cau_ho_tro_nguoi_gui_id_fkey
- FOREIGN KEY: yeu_cau_ho_tro_nguoi_nhan_id_fkey
- CHECK: 27491_53345_1_not_null

|
</file>

<file path="app/GiaoDienTong/MenuTren/NotificationCenter.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { Bell, X, Check, CheckCircle2, MessageCircle, Heart, Users, Zap, AlertCircle, ShoppingBag, Calendar, Award } from 'lucide-react';
import { Notification, NotificationGroup, NOTIFICATION_CONFIG, NotificationType } from './NotificationTypes';
import { useAppSettings } from '@/app/ThuVien/AppSettingsContext';

interface Props {
  notifications: Notification[];
  unreadCount: number;
  onMarkAsRead: (id: string) => void;
  onMarkAllAsRead: () => void;
  onDelete: (id: string) => void;
  onNotificationClick: (notification: Notification) => void;
}

export default function NotificationCenter({ 
  notifications, 
  unreadCount, 
  onMarkAsRead, 
  onMarkAllAsRead, 
  onDelete,
  onNotificationClick 
}: Props) {
  const [isOpen, setIsOpen] = useState(false);
  const [filteredCategory, setFilteredCategory] = useState<string | null>(null);
  const { t, language } = useAppSettings(); // 🌐 Hook ngôn ngữ

  // Nhóm thông báo theo category
  const groupedNotifications: NotificationGroup[] = React.useMemo(() => {
    const groups: Record<string, Notification[]> = {};
    
    notifications.forEach(notif => {
      if (!groups[notif.category]) {
        groups[notif.category] = [];
      }
      groups[notif.category].push(notif);
    });

    return Object.entries(groups).map(([category, notifs]) => ({
      category: category as any,
      label: getCategoryLabel(category),
      notifications: notifs.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime()),
      unread_count: notifs.filter(n => !n.is_read).length,
      icon: getCategoryIcon(category),
      color: getCategoryColor(category)
    }));
  }, [notifications]);

  const displayedNotifications = filteredCategory 
    ? groupedNotifications.find(g => g.category === filteredCategory)?.notifications || []
    : notifications.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());

  return (
    <div className="relative">
      {/* Notification Button */}
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className="relative w-10 h-10 bg-black/40 border border-white/10 rounded-lg flex items-center justify-center transition-all hover:bg-white/10 backdrop-blur-sm group active:scale-95"
      >
        <Bell size={18} className="text-[#C69C6D]" />
        
        {/* Badge - Unread count */}
        {unreadCount > 0 && (
          <div className="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-lg">
            {unreadCount > 99 ? '99+' : unreadCount}
          </div>
        )}

        {/* Indicator dot */}
        {unreadCount > 0 && (
          <div className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
        )}
      </button>

      {/* Notification Dropdown */}
      {isOpen && (
        <div className="fixed md:absolute top-[85px] md:top-[120%] left-0 md:left-auto md:right-0 w-screen md:w-[450px] md:max-h-[600px] bg-[#0a0807]/95 border-t md:border border-[#8B5E3C]/30 rounded-none md:rounded-xl shadow-2xl overflow-hidden z-[5100] backdrop-blur-xl flex flex-col animate-in fade-in slide-in-from-top-2 duration-200"
        >
          {/* Header */}
          <div className="sticky top-0 px-4 py-3 border-b border-[#8B5E3C]/20 bg-black/50 flex items-center justify-between">
            <div className="flex items-center gap-2">
              <h3 className="text-sm font-bold text-white uppercase tracking-widest">{t('notifications.title')}</h3>
              {unreadCount > 0 && (
                <span className="text-xs font-bold bg-red-500 text-white px-2 py-0.5 rounded-full">
                  {unreadCount} {t('notifications.new')}
                </span>
              )}
            </div>
            <div className="flex items-center gap-1">
              {unreadCount > 0 && (
                <button 
                  onClick={onMarkAllAsRead}
                  className="p-1.5 text-[#C69C6D] hover:bg-white/10 rounded transition-all active:scale-95"
                  title={t('notifications.markAllRead')}
                >
                  <CheckCircle2 size={16} />
                </button>
              )}
              <button 
                onClick={() => setIsOpen(false)}
                className="p-1.5 text-gray-400 hover:text-white hover:bg-white/10 rounded transition-all md:hidden active:scale-95"
              >
                <X size={18} />
              </button>
            </div>
          </div>

          {/* Category Filter */}
          {groupedNotifications.length > 0 && (
            <div className="sticky top-[53px] px-3 py-2 bg-black/30 border-b border-[#8B5E3C]/10 overflow-x-auto flex gap-2">
              <button
                onClick={() => setFilteredCategory(null)}
                className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider whitespace-nowrap transition-all active:scale-95 ${
                  filteredCategory === null
                    ? 'bg-[#C69C6D] text-black'
                    : 'bg-white/5 text-gray-300 hover:bg-white/10'
                }`}
              >
                {language === 'vi' ? 'Tất cả' : 'All'}
              </button>
              {groupedNotifications.map(group => (
                <button
                  key={group.category}
                  onClick={() => setFilteredCategory(group.category)}
                  className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider whitespace-nowrap transition-all flex items-center gap-1 active:scale-95 ${
                    filteredCategory === group.category
                      ? 'bg-[#C69C6D] text-black'
                      : 'bg-white/5 text-gray-300 hover:bg-white/10'
                  }`}
                >
                  {group.unread_count > 0 && (
                    <span className="bg-red-500 text-white text-[9px] font-bold rounded-full w-4 h-4 flex items-center justify-center">
                      {group.unread_count}
                    </span>
                  )}
                  {group.label}
                </button>
              ))}
            </div>
          )}

          {/* Notifications List */}
          <div className="flex-1 overflow-y-auto space-y-2 p-3">
            {displayedNotifications.length === 0 ? (
              <div className="flex flex-col items-center justify-center py-12 text-center">
                <Bell size={32} className="text-gray-500 mb-2 opacity-50" />
                <p className="text-sm text-gray-400">{t('notifications.empty')}</p>
              </div>
            ) : (
              displayedNotifications.map(notification => (
                <NotificationItem
                  key={notification.id}
                  notification={notification}
                  onMarkAsRead={() => {
                    onMarkAsRead(notification.id);
                  }}
                  onDelete={() => onDelete(notification.id)}
                  onClick={() => {
                    onNotificationClick(notification);
                    setIsOpen(false);
                  }}
                />
              ))
            )}
          </div>

          {/* Footer */}
          {notifications.length > 0 && (
            <div className="border-t border-[#8B5E3C]/20 px-4 py-3 bg-black/50 text-center">
              <button className="text-xs text-[#C69C6D] hover:text-white font-bold uppercase tracking-widest transition-all active:scale-95">
                Xem tất cả thông báo
              </button>
            </div>
          )}
        </div>
      )}

      {/* Overlay */}
      {isOpen && (
        <div 
          onClick={() => setIsOpen(false)}
          className="fixed inset-0 z-[5099] md:hidden"
        />
      )}
    </div>
  );
}

function NotificationItem({ 
  notification, 
  onMarkAsRead, 
  onDelete, 
  onClick 
}: {
  notification: Notification;
  onMarkAsRead: () => void;
  onDelete: () => void;
  onClick: () => void;
}) {
  const config = NOTIFICATION_CONFIG[notification.type as NotificationType];
  const IconComponent = getIconComponent(notification.type);

  return (
    <div
      onClick={onClick}
      className={`group relative p-3 rounded-lg transition-all cursor-pointer ${
        notification.is_read
          ? 'bg-white/5 hover:bg-white/10'
          : 'bg-[#C69C6D]/10 border border-[#C69C6D]/30 hover:bg-[#C69C6D]/20'
      }`}
    >
      {/* Unread indicator */}
      {!notification.is_read && (
        <div className="absolute top-3 left-3 w-2 h-2 bg-red-500 rounded-full"></div>
      )}

      <div className="flex gap-3 pl-4">
        {/* Avatar or Icon */}
        <div className="flex-shrink-0">
          {notification.from_user_avatar ? (
            <img
              src={notification.from_user_avatar}
              alt={notification.from_user_name}
              className="w-10 h-10 rounded-full object-cover border border-[#C69C6D]/30"
            />
          ) : (
            <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ backgroundColor: `${config.color}20` }}>
              <IconComponent size={18} style={{ color: config.color }} />
            </div>
          )}
        </div>

        {/* Content */}
        <div className="flex-1 min-w-0">
          <div className="flex items-start justify-between gap-2 mb-1">
            <p className="text-sm font-bold text-white truncate">
              {notification.title}
            </p>
            <span className="text-[10px] text-gray-400 flex-shrink-0">
              {formatTime(notification.created_at)}
            </span>
          </div>
          
          <p className="text-xs text-gray-300 line-clamp-2 mb-2">
            {notification.message}
          </p>

          {/* Actions */}
          <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
            {!notification.is_read && (
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onMarkAsRead();
                }}
                className="text-[10px] text-[#C69C6D] hover:text-white font-bold uppercase tracking-wider transition-all active:scale-95 flex items-center gap-1"
              >
                <Check size={12} /> Đã đọc
              </button>
            )}
            <button
              onClick={(e) => {
                e.stopPropagation();
                onDelete();
              }}
              className="text-[10px] text-gray-400 hover:text-red-400 font-bold uppercase tracking-wider transition-all active:scale-95"
            >
              Xóa
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function getCategoryLabel(category: string): string {
  const labels: Record<string, string> = {
    'from_users': 'Từ người dùng',
    'from_system': 'Từ hệ thống',
    'from_business': 'Từ đơn hàng',
    'from_events': 'Từ sự kiện',
    'from_content': 'Từ nội dung',
    'from_security': 'Bảo mật'
  };
  return labels[category] || category;
}

function getCategoryColor(category: string): string {
  const colors: Record<string, string> = {
    'from_users': '#3B82F6',
    'from_system': '#6366F1',
    'from_business': '#8B5E3C',
    'from_events': '#F59E0B',
    'from_content': '#C69C6D',
    'from_security': '#EF4444'
  };
  return colors[category] || '#C69C6D';
}

function getCategoryIcon(category: string): any {
  const icons: Record<string, any> = {
    'from_users': Users,
    'from_system': Zap,
    'from_business': ShoppingBag,
    'from_events': Calendar,
    'from_content': Award,
    'from_security': AlertCircle
  };
  return icons[category] || Bell;
}

function getIconComponent(type: NotificationType): any {
  const icons: Record<NotificationType, any> = {
    'user_follow': Users,
    'user_comment': MessageCircle,
    'user_like': Heart,
    'user_message': MessageCircle,
    'user_mention': MessageCircle,
    'user_tag': MessageCircle,
    'system_update': Zap,
    'system_announcement': Zap,
    'system_alert': AlertCircle,
    'order_created': ShoppingBag,
    'order_confirmed': CheckCircle2,
    'order_shipped': ShoppingBag,
    'order_delivered': CheckCircle2,
    'payment_received': CheckCircle2,
    'event_new': Calendar,
    'event_reminder': Calendar,
    'workshop_new': Users,
    'workshop_reminder': Bell,
    'achievement_unlocked': Award,
    'milestone_reached': Award,
    'product_new': ShoppingBag,
    'artwork_new': Award,
    'artwork_featured': Award,
    'security_alert': AlertCircle,
    'login_new_device': AlertCircle
  };
  return icons[type] || Bell;
}

function formatTime(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  
  const seconds = Math.floor(diff / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);

  if (seconds < 60) return 'Vừa xong';
  if (minutes < 60) return `${minutes}p trước`;
  if (hours < 24) return `${hours}h trước`;
  if (days < 7) return `${days}d trước`;
  
  return date.toLocaleDateString('vi-VN');
}
</file>

<file path="app/GiaoDienTong/MenuTren/NotificationTypes.ts">
// Loại thông báo từ các nguồn khác nhau
export type NotificationType = 
  // Từ NGƯỜI DÙNG KHÁC
  | 'user_follow' 
  | 'user_comment' 
  | 'user_like' 
  | 'user_message' 
  | 'user_mention'
  | 'user_tag'
  // Từ HỆ THỐNG
  | 'system_update'
  | 'system_announcement'
  | 'system_alert'
  // Từ HOẠT ĐỘNG KINH DOANH
  | 'order_created'
  | 'order_confirmed'
  | 'order_shipped'
  | 'order_delivered'
  | 'payment_received'
  // Từ SỰ KIỆN & WORKSHOP
  | 'event_new'
  | 'event_reminder'
  | 'workshop_new'
  | 'workshop_reminder'
  // Từ TƯỚNG CÔNG
  | 'achievement_unlocked'
  | 'milestone_reached'
  // Từ NỘI DUNG
  | 'product_new'
  | 'artwork_new'
  | 'artwork_featured'
  // Bảo mật
  | 'security_alert'
  | 'login_new_device';

export type NotificationCategory = 
  | 'from_users'      // Từ người khác
  | 'from_system'     // Từ hệ thống
  | 'from_business'   // Từ hoạt động kinh doanh
  | 'from_events'     // Từ sự kiện
  | 'from_content'    // Từ nội dung mới
  | 'from_security';  // Từ bảo mật

export interface Notification {
  id: string;
  user_id: string;
  type: NotificationType;
  category: NotificationCategory;
  
  // Thông tin chính
  title: string;
  message: string;
  icon?: string;
  avatar?: string;
  
  // Người gửi (nếu từ người dùng khác)
  from_user_id?: string;
  from_user_name?: string;
  from_user_avatar?: string;
  
  // Liên kết
  related_id?: string;        // ID của object liên quan (product_id, order_id, etc)
  action_url?: string;        // URL để navigate
  
  // Trạng thái
  is_read: boolean;
  created_at: string;
  updated_at: string;
  
  // Hành động
  action_label?: string;
  action_type?: 'confirm' | 'view' | 'dismiss';
}

export interface NotificationGroup {
  category: NotificationCategory;
  label: string;
  notifications: Notification[];
  unread_count: number;
  icon: any;
  color: string;
}

export const NOTIFICATION_CONFIG: Record<NotificationType, {
  category: NotificationCategory;
  label: string;
  icon: string;
  color: string;
  priority: number;
  description: (data?: any) => string;
}> = {
  // Từ NGƯỜI DÙNG
  'user_follow': {
    category: 'from_users',
    label: 'Theo dõi mới',
    icon: 'UserPlus',
    color: '#3B82F6',
    priority: 5,
    description: (data) => `${data?.from_user_name} đã theo dõi bạn`
  },
  'user_comment': {
    category: 'from_users',
    label: 'Bình luận mới',
    icon: 'MessageCircle',
    color: '#8B5E3C',
    priority: 4,
    description: (data) => `${data?.from_user_name} đã bình luận: "${data?.message}"`
  },
  'user_like': {
    category: 'from_users',
    label: 'Yêu thích',
    icon: 'Heart',
    color: '#EF4444',
    priority: 3,
    description: (data) => `${data?.from_user_name} yêu thích tác phẩm của bạn`
  },
  'user_message': {
    category: 'from_users',
    label: 'Tin nhắn mới',
    icon: 'Mail',
    color: '#10B981',
    priority: 6,
    description: (data) => `Tin nhắn từ ${data?.from_user_name}: "${data?.message}"`
  },
  'user_mention': {
    category: 'from_users',
    label: 'Được đề cập',
    icon: 'AtSign',
    color: '#C69C6D',
    priority: 4,
    description: (data) => `${data?.from_user_name} đã đề cập đến bạn`
  },
  'user_tag': {
    category: 'from_users',
    label: 'Được gắn thẻ',
    icon: 'Tag',
    color: '#8B5E3C',
    priority: 4,
    description: (data) => `${data?.from_user_name} đã gắn thẻ bạn`
  },

  // Từ HỆ THỐNG
  'system_update': {
    category: 'from_system',
    label: 'Cập nhật hệ thống',
    icon: 'RefreshCw',
    color: '#6366F1',
    priority: 2,
    description: (data) => 'Hệ thống đã được cập nhật với các tính năng mới'
  },
  'system_announcement': {
    category: 'from_system',
    label: 'Thông báo chung',
    icon: 'Megaphone',
    color: '#F59E0B',
    priority: 3,
    description: (data) => data?.message || 'Có thông báo chung mới từ hệ thống'
  },
  'system_alert': {
    category: 'from_system',
    label: 'Cảnh báo hệ thống',
    icon: 'AlertCircle',
    color: '#EF4444',
    priority: 5,
    description: (data) => data?.message || 'Cảnh báo từ hệ thống'
  },

  // Từ HOẠT ĐỘNG KINH DOANH
  'order_created': {
    category: 'from_business',
    label: 'Đơn hàng mới',
    icon: 'ShoppingBag',
    color: '#8B5E3C',
    priority: 4,
    description: (data) => `Đơn hàng #${data?.related_id} của bạn đã được tạo`
  },
  'order_confirmed': {
    category: 'from_business',
    label: 'Đơn hàng xác nhận',
    icon: 'CheckCircle',
    color: '#10B981',
    priority: 3,
    description: (data) => `Đơn hàng #${data?.related_id} đã được xác nhận`
  },
  'order_shipped': {
    category: 'from_business',
    label: 'Đơn hàng đã gửi',
    icon: 'Truck',
    color: '#3B82F6',
    priority: 3,
    description: (data) => `Đơn hàng #${data?.related_id} đang trên đường tới`
  },
  'order_delivered': {
    category: 'from_business',
    label: 'Đơn hàng đã giao',
    icon: 'Package',
    color: '#10B981',
    priority: 3,
    description: (data) => `Đơn hàng #${data?.related_id} đã được giao thành công`
  },
  'payment_received': {
    category: 'from_business',
    label: 'Thanh toán nhận được',
    icon: 'CreditCard',
    color: '#10B981',
    priority: 4,
    description: (data) => `Thanh toán ${data?.message} đã được xác nhận`
  },

  // Từ SỰ KIỆN & WORKSHOP
  'event_new': {
    category: 'from_events',
    label: 'Sự kiện mới',
    icon: 'Calendar',
    color: '#8B5E3C',
    priority: 2,
    description: (data) => `Sự kiện mới: ${data?.message}`
  },
  'event_reminder': {
    category: 'from_events',
    label: 'Nhắc nhở sự kiện',
    icon: 'Clock',
    color: '#F59E0B',
    priority: 4,
    description: (data) => `Sự kiện sắp diễn ra: ${data?.message}`
  },
  'workshop_new': {
    category: 'from_events',
    label: 'Workshop mới',
    icon: 'Users',
    color: '#8B5E3C',
    priority: 2,
    description: (data) => `Workshop mới: ${data?.message}`
  },
  'workshop_reminder': {
    category: 'from_events',
    label: 'Nhắc nhở workshop',
    icon: 'Bell',
    color: '#F59E0B',
    priority: 4,
    description: (data) => `Workshop sắp bắt đầu: ${data?.message}`
  },

  // Từ ĐẠT CÔNG
  'achievement_unlocked': {
    category: 'from_content',
    label: 'Thành tựu mở khóa',
    icon: 'Award',
    color: '#FBBF24',
    priority: 3,
    description: (data) => `Bạn đã mở khóa thành tựu: ${data?.message}`
  },
  'milestone_reached': {
    category: 'from_content',
    label: 'Cột mốc đạt được',
    icon: 'Target',
    color: '#FBBF24',
    priority: 3,
    description: (data) => `Chúc mừng! Bạn đã đạt ${data?.message}`
  },

  // Từ NỘI DUNG
  'product_new': {
    category: 'from_content',
    label: 'Sản phẩm mới',
    icon: 'Package',
    color: '#8B5E3C',
    priority: 1,
    description: (data) => `Tác phẩm mới: ${data?.message}`
  },
  'artwork_new': {
    category: 'from_content',
    label: 'Tác phẩm mới',
    icon: 'Image',
    color: '#8B5E3C',
    priority: 1,
    description: (data) => `Tác phẩm mới đã được thêm: ${data?.message}`
  },
  'artwork_featured': {
    category: 'from_content',
    label: 'Tác phẩm nổi bật',
    icon: 'Star',
    color: '#FBBF24',
    priority: 2,
    description: (data) => `Tác phẩm ${data?.message} đã được nổi bật`
  },

  // BẢO MẬT
  'security_alert': {
    category: 'from_security',
    label: 'Cảnh báo bảo mật',
    icon: 'Shield',
    color: '#EF4444',
    priority: 6,
    description: (data) => data?.message || 'Có hoạt động bất thường trên tài khoản'
  },
  'login_new_device': {
    category: 'from_security',
    label: 'Đăng nhập thiết bị mới',
    icon: 'Smartphone',
    color: '#F59E0B',
    priority: 5,
    description: (data) => `Đăng nhập từ thiết bị mới: ${data?.message}`
  }
};
</file>

<file path="app/GiaoDienTong/MenuTren/NutCaNhan/GiaoDienChiTiet.tsx">
'use client';
import React from 'react';
import { User, LogOut, Mail, Hash, KeyRound, Smartphone } from 'lucide-react';
import { xuLyDangXuat } from './ChucNang';

interface Props {
    nguoiDung: any;
}

export default function GiaoDienChiTiet({ nguoiDung }: Props) {
    // Chuẩn hóa dữ liệu
    const hoTen = nguoiDung?.ho_ten || 'Khách vãng lai';
    const viTri = nguoiDung?.vi_tri || 'Chưa xác định';
    const email = nguoiDung?.email || 'Chưa cập nhật';
    const role = nguoiDung?.role || 'khach';
    const avatar = nguoiDung?.avatar_url;
    const userId = nguoiDung?.id || 'N/A';

    return (
        <div className="max-w-md mx-auto w-full space-y-6 pt-4 pb-6">
            
            {/* 1. CARD AVATAR & INFO CHÍNH */}
            <div className="relative group">
                {/* Glow Effect */}
                <div className="absolute -inset-0.5 bg-gradient-to-br from-[#8B5E3C] to-[#C69C6D] rounded-2xl blur opacity-20 group-hover:opacity-40 transition duration-700"></div>
                
                <div className="relative bg-[#1a120f] border border-[#8B5E3C]/40 rounded-2xl p-6 flex flex-col items-center shadow-2xl overflow-hidden">
                    {/* Background Pattern */}
                    <div className="absolute inset-0 opacity-5 bg-[repeating-linear-gradient(45deg,transparent,transparent_5px,#C69C6D_5px,#C69C6D_6px)]"></div>
                    
                    {/* Avatar */}
                    <div className="w-28 h-28 md:w-32 md:h-32 rounded-full border-2 border-[#C69C6D] p-1 mb-4 relative z-10 shadow-[0_0_30px_rgba(198,156,109,0.2)] bg-[#110d0c]">
                        {avatar ? (
                            <img src={avatar} alt="Avt" className="w-full h-full rounded-full object-cover" />
                        ) : (
                            <div className="w-full h-full rounded-full bg-[#2a1e1b] flex items-center justify-center text-[#C69C6D]">
                                <User className="w-14 h-14" strokeWidth={1.5} />
                            </div>
                        )}
                        {/* Role Badge */}
                        <div className="absolute -bottom-2 -right-2 bg-[#C69C6D] text-[#1a120f] text-[10px] font-black px-2 py-1 rounded-md border border-[#1a120f] uppercase shadow-lg tracking-wider">
                            {role}
                        </div>
                    </div>

                    {/* Name & Title */}
                    <h3 className="text-xl md:text-2xl font-bold text-[#F5E6D3] uppercase tracking-wide relative z-10 text-center">{hoTen}</h3>
                    <p className="text-xs text-[#8B5E3C] font-bold uppercase tracking-[0.2em] mt-1 relative z-10 opacity-80">{viTri}</p>
                </div>
            </div>

            {/* 2. CARD CHI TIẾT */}
            <div className="space-y-3">
                <div className="bg-[#1a120f] border border-[#8B5E3C]/20 rounded-xl p-4 flex items-start gap-4 hover:border-[#C69C6D]/50 transition-colors">
                    <div className="p-2 bg-[#C69C6D]/10 rounded-full text-[#C69C6D] shrink-0 mt-1">
                        <Hash size={18} />
                    </div>
                    <div className="flex-1 min-w-0">
                        <p className="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Mã Định Danh (ID)</p>
                        <p className="text-sm text-gray-300 font-mono break-all leading-tight select-all">{userId}</p>
                    </div>
                </div>

                <div className="bg-[#1a120f] border border-[#8B5E3C]/20 rounded-xl p-4 flex items-start gap-4 hover:border-[#C69C6D]/50 transition-colors">
                    <div className="p-2 bg-[#C69C6D]/10 rounded-full text-[#C69C6D] shrink-0 mt-1">
                        <Mail size={18} />
                    </div>
                    <div className="flex-1 min-w-0">
                        <p className="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Email Xác Thực</p>
                        <p className="text-sm text-gray-300 font-sans break-words leading-tight">{email}</p>
                    </div>
                </div>
            </div>

            {/* 3. QUICK ACTIONS GRID */}
            <div className="grid grid-cols-2 gap-3">
                <button className="flex flex-col items-center justify-center gap-2 bg-[#1a120f] border border-[#8B5E3C]/20 hover:bg-[#C69C6D]/10 hover:border-[#C69C6D] p-4 rounded-xl transition-all group">
                    <KeyRound size={20} className="text-[#8B5E3C] group-hover:text-[#C69C6D]"/>
                    <span className="text-[10px] uppercase font-bold text-gray-400 group-hover:text-[#F5E6D3]">Đổi Mật Khẩu</span>
                </button>
                <button className="flex flex-col items-center justify-center gap-2 bg-[#1a120f] border border-[#8B5E3C]/20 hover:bg-[#C69C6D]/10 hover:border-[#C69C6D] p-4 rounded-xl transition-all group">
                    <Smartphone size={20} className="text-[#8B5E3C] group-hover:text-[#C69C6D]"/>
                    <span className="text-[10px] uppercase font-bold text-gray-400 group-hover:text-[#F5E6D3]">Thiết Bị</span>
                </button>
            </div>

            {/* 4. LOGOUT BUTTON */}
            <button 
                onClick={xuLyDangXuat} 
                className="w-full flex items-center justify-center gap-2 text-red-400 hover:text-white text-sm font-bold uppercase tracking-[0.15em] px-6 py-4 border border-red-900/50 bg-red-950/20 hover:bg-red-600 rounded-xl transition-all shadow-lg active:scale-95 group mt-4"
            >
                <LogOut size={18} className="group-hover:-translate-x-1 transition-transform" />
                Đăng Xuất Hệ Thống
            </button>

            <div className="text-center">
                <p className="text-[9px] text-[#5D4037] font-mono">Phiên bản hệ thống: 2.5.0 (Beta)</p>
            </div>
        </div>
    );
}
</file>

<file path="app/GiaoDienTong/MenuTren/NutCaNhan/ModalProfile.tsx">
'use client';
import React, { useState, useEffect, ReactNode } from 'react';
import { 
  X, User, Package, Phone, Mail, MapPin, CreditCard, 
  ChevronRight, LogOut, ChevronLeft, Settings, Trophy,
  Globe, Moon, Sun, Palette, Check
} from 'lucide-react';
import { OrderService, Order } from '@/app/ThuVien/OrderService';
import { Z_INDEX } from '@/app/constants/zIndex';
import { LoggerService } from '@/app/ThuVien/LoggerService';
import { xuLyDangXuat } from './ChucNang';
import { useAppSettings, ThemeMode, LanguageCode } from '@/app/ThuVien/AppSettingsContext';

// Inline ConfirmDialog component
interface ConfirmDialogProps {
  isOpen: boolean;
  title: string;
  message: string;
  icon?: ReactNode;
  confirmText?: string;
  cancelText?: string;
  isDangerous?: boolean;
  isLoading?: boolean;
  onConfirm: () => void;
  onCancel: () => void;
}

function ConfirmDialog({
  isOpen,
  title,
  message,
  icon,
  confirmText = 'Xác nhận',
  cancelText = 'Hủy',
  isDangerous = false,
  isLoading = false,
  onConfirm,
  onCancel
}: ConfirmDialogProps) {
  if (!isOpen) return null;
  
  return (
    <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm">
      <div className="bg-[#1a1a1a] border border-white/10 rounded-xl p-6 max-w-sm w-full mx-4 shadow-2xl">
        <div className="flex items-center gap-3 mb-4">
          {icon && <div>{icon}</div>}
          <h3 className="text-lg font-semibold text-white">{title}</h3>
        </div>
        <p className="text-white/70 mb-6">{message}</p>
        <div className="flex gap-3 justify-end">
          <button
            onClick={onCancel}
            disabled={isLoading}
            className="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 disabled:opacity-50"
          >
            {cancelText}
          </button>
          <button
            onClick={onConfirm}
            disabled={isLoading}
            className={`px-4 py-2 rounded-lg text-white ${
              isDangerous ? 'bg-red-600 hover:bg-red-700' : 'bg-[#C69C6D] hover:bg-[#C69C6D]/80'
            } disabled:opacity-50`}
          >
            {isLoading ? 'Đang xử lý...' : confirmText}
          </button>
        </div>
      </div>
    </div>
  );
}

interface ModalProfileProps {
  isOpen: boolean;
  onClose: () => void;
  nguoiDung: any;
}

// Các màn hình
type ScreenType = 
  | 'main'           // Màn chính: Cài Đặt, Hồ Sơ Của Tôi
  | 'caidat'         // Cài Đặt: Ngôn Ngữ, Giao Diện
  | 'hosocuatoi'     // Hồ Sơ: Thông Tin, Thành Tích/Đơn Hàng
  | 'thongtincanhan' // Chi tiết thông tin cá nhân
  | 'thanhtich'      // Thành tích (nhan_su)
  | 'donhang'        // Đơn hàng (khach_hang)
  | 'ngonngu'        // Chọn ngôn ngữ
  | 'giaodien';      // Chọn giao diện

export default function ModalProfile({ isOpen, onClose, nguoiDung }: ModalProfileProps) {
  const [currentScreen, setCurrentScreen] = useState<ScreenType>('main');
  const [orders, setOrders] = useState<Order[]>([]);
  const [isLoadingOrders, setIsLoadingOrders] = useState(false);
  const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);
  const [isLoggingOut, setIsLoggingOut] = useState(false);
  
  // 🌐 Hook settings cho theme + language
  const { t, language } = useAppSettings();
  
  // Xác định loại user
  const isNhanSu = nguoiDung?.userType === 'nhan_su' || nguoiDung?.vi_tri;
  const isKhachHang = nguoiDung?.userType === 'khach_hang' || nguoiDung?.phan_loai;

  // Reset về màn chính khi mở lại
  useEffect(() => {
    if (isOpen) {
      setCurrentScreen('main');
    }
  }, [isOpen]);

  // Load orders khi vào màn đơn hàng
  useEffect(() => {
    if (isOpen && currentScreen === 'donhang') {
      loadOrders();
    }
  }, [isOpen, currentScreen]);

  // ✅ ESC KEY HANDLING - Close modal on ESC press
  useEffect(() => {
    if (!isOpen) return;

    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        e.preventDefault();
        onClose();
      }
    };

    window.addEventListener('keydown', handleEscape);
    return () => window.removeEventListener('keydown', handleEscape);
  }, [isOpen, onClose]);

  const loadOrders = async () => {
    setIsLoadingOrders(true);
    try {
      const { orders: data } = await OrderService.getMyOrders(20);
      setOrders(data);
    } catch (error) {
      LoggerService.error('ModalProfile', 'Error loading orders', error);
    } finally {
      setIsLoadingOrders(false);
    }
  };

  const handleLogoutConfirm = async () => {
    setIsLoggingOut(true);
    try {
      await xuLyDangXuat();
    } catch (error) {
      LoggerService.error('ModalProfile', 'Logout error', error);
      setIsLoggingOut(false);
      setShowLogoutConfirm(false);
    }
  };

  // Xử lý nút back - quay về màn cha
  const handleBack = () => {
    switch (currentScreen) {
      case 'ngonngu':
      case 'giaodien':
        setCurrentScreen('caidat');
        break;
      case 'thongtincanhan':
      case 'thanhtich':
      case 'donhang':
        setCurrentScreen('hosocuatoi');
        break;
      default:
        setCurrentScreen('main');
    }
  };

  // Lấy tiêu đề màn hình
  const getScreenTitle = () => {
    switch (currentScreen) {
      case 'caidat': return t('profile.settings');
      case 'hosocuatoi': return t('profile.myProfile');
      case 'thongtincanhan': return t('profile.personalInfo');
      case 'thanhtich': return t('profile.achievements');
      case 'donhang': return t('profile.orders');
      case 'ngonngu': return t('settings.language');
      case 'giaodien': return t('settings.theme');
      default: return t('profile.title');
    }
  };

  if (!isOpen) return null;

  // =====================================================
  // MÀN HÌNH CON (không phải main)
  // =====================================================
  if (currentScreen !== 'main') {
    return (
      <div className="fixed inset-0 flex items-center justify-center sm:items-start sm:justify-end" style={{ zIndex: Z_INDEX.modal }}>
        <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose} />
        <div className="relative w-full h-full sm:h-[100dvh] sm:max-w-md bg-gradient-to-br from-[#0A0A0A] to-[#1A1A1A] border-l border-white/20 shadow-2xl flex flex-col overflow-hidden">
          
          {/* Header màn con */}
          <div className="flex-shrink-0 px-4 py-4 border-b border-white/10 bg-black/40 backdrop-blur-md">
            <div className="flex items-center gap-3">
              <button onClick={handleBack} className="p-2 hover:bg-white/10 rounded-lg transition-colors">
                <ChevronLeft size={24} className="text-white" />
              </button>
              <h2 className="text-lg font-bold text-white">{getScreenTitle()}</h2>
            </div>
          </div>

          {/* Content màn con */}
          <div className="flex-1 overflow-y-auto p-4">
            {currentScreen === 'caidat' && (
              <ScreenCaiDat 
                onGoToNgonNgu={() => setCurrentScreen('ngonngu')}
                onGoToGiaoDien={() => setCurrentScreen('giaodien')}
              />
            )}
            {currentScreen === 'hosocuatoi' && (
              <ScreenHoSoCuaToi 
                isNhanSu={isNhanSu}
                isKhachHang={isKhachHang}
                onGoToThongTin={() => setCurrentScreen('thongtincanhan')}
                onGoToThanhTich={() => setCurrentScreen('thanhtich')}
                onGoToDonHang={() => setCurrentScreen('donhang')}
              />
            )}
            {currentScreen === 'thongtincanhan' && <ScreenThongTinCaNhan nguoiDung={nguoiDung} />}
            {currentScreen === 'thanhtich' && <ScreenThanhTich nguoiDung={nguoiDung} />}
            {currentScreen === 'donhang' && <ScreenDonHang orders={orders} isLoading={isLoadingOrders} onReload={loadOrders} />}
            {currentScreen === 'ngonngu' && <ScreenNgonNgu />}
            {currentScreen === 'giaodien' && <ScreenGiaoDien />}
          </div>
        </div>
      </div>
    );
  }

  // =====================================================
  // MÀN HÌNH CHÍNH
  // =====================================================
  return (
    <div className="fixed inset-0 flex items-center justify-center sm:items-start sm:justify-end" style={{ zIndex: Z_INDEX.modal }}>
      <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose} />

      <div className="relative w-full h-full sm:h-[100dvh] sm:max-w-md bg-gradient-to-br from-[#0A0A0A] to-[#1A1A1A] border-l border-white/20 shadow-2xl flex flex-col overflow-hidden">
        
        {/* Header - Avatar & Tên */}
        <div className="flex-shrink-0 px-6 py-6 border-b border-white/10 bg-black/40 backdrop-blur-md">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-4">
              <div className="w-14 h-14 rounded-full bg-gradient-to-br from-[#C69C6D] to-[#F2D3A0] flex items-center justify-center text-black font-bold text-xl">
                {nguoiDung?.ho_ten?.[0]?.toUpperCase() || nguoiDung?.email?.[0]?.toUpperCase() || 'U'}
              </div>
              <div>
                <h2 className="text-lg font-bold text-white">
                  {nguoiDung?.ho_ten || (language === 'vi' ? 'Người dùng' : 'User')}
                </h2>
                <p className="text-white/60 text-sm">{nguoiDung?.email}</p>
              </div>
            </div>
            <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-lg transition-colors text-white/60 hover:text-white">
              <X size={24} />
            </button>
          </div>

          {/* Nút Đăng xuất */}
          <button
            onClick={() => setShowLogoutConfirm(true)}
            disabled={isLoggingOut}
            className="flex items-center gap-2 px-4 py-2.5 bg-white/5 border border-white/10 text-white rounded-lg font-medium text-sm transition-all hover:bg-white/10"
          >
            <LogOut size={18} />
            <span>{isLoggingOut ? t('auth.loggingOut') : t('auth.logout')}</span>
          </button>
        </div>

        {/* Content - 2 mục chính */}
        <div className="flex-1 overflow-y-auto p-4 space-y-4">
          
          {/* KHỐI MENU CHÍNH */}
          <div className="bg-white/5 border border-white/10 rounded-2xl overflow-hidden">
            <KhoiMenuChon 
              icon={<Settings size={20} className="text-[#C69C6D]" />}
              label={t('profile.settings')}
              subtitle={t('profile.settingsDesc')}
              onClick={() => setCurrentScreen('caidat')}
            />
            <KhoiMenuChon 
              icon={<User size={20} className="text-[#C69C6D]" />}
              label={t('profile.myProfile')}
              subtitle={isNhanSu ? t('profile.myProfileDescStaff') : t('profile.myProfileDescCustomer')}
              onClick={() => setCurrentScreen('hosocuatoi')}
              isLast
            />
          </div>

        </div>
      </div>

      {/* Logout Confirmation Dialog */}
      <ConfirmDialog
        isOpen={showLogoutConfirm}
        title={t('auth.logout')}
        message={t('auth.logoutConfirm')}
        icon={<LogOut className="text-[#C69C6D]" size={24} />}
        confirmText={t('auth.logout')}
        cancelText={t('app.cancel')}
        isDangerous={false}
        isLoading={isLoggingOut}
        onConfirm={handleLogoutConfirm}
        onCancel={() => !isLoggingOut && setShowLogoutConfirm(false)}
      />
    </div>
  );
}

// =====================================================
// COMPONENT: KHỐI MENU CHỌN
// =====================================================
function KhoiMenuChon({ 
  icon, 
  label, 
  subtitle,
  onClick, 
  isLast = false 
}: { 
  icon: ReactNode; 
  label: string; 
  subtitle?: string;
  onClick?: () => void; 
  isLast?: boolean;
}) {
  return (
    <button 
      onClick={onClick}
      className={`w-full px-4 py-4 flex items-center gap-3 hover:bg-white/5 transition-colors ${!isLast ? 'border-b border-white/5' : ''}`}
    >
      <div className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center">
        {icon}
      </div>
      <div className="flex-1 text-left">
        <p className="text-white font-medium">{label}</p>
        {subtitle && <p className="text-white/50 text-sm">{subtitle}</p>}
      </div>
      {onClick && <ChevronRight size={20} className="text-white/30" />}
    </button>
  );
}

// =====================================================
// MÀN HÌNH: CÀI ĐẶT
// =====================================================
function ScreenCaiDat({ 
  onGoToNgonNgu, 
  onGoToGiaoDien 
}: { 
  onGoToNgonNgu: () => void;
  onGoToGiaoDien: () => void;
}) {
  const { language, theme, t } = useAppSettings();
  
  const languageDisplay = language === 'vi' ? 'Tiếng Việt' : 'English';
  const themeDisplay = theme === 'dark' 
    ? (language === 'vi' ? 'Tối' : 'Dark')
    : (language === 'vi' ? 'Sáng' : 'Light');

  return (
    <div className="space-y-4">
      <div className="bg-[var(--bg-card)] border border-[var(--border-color)] rounded-2xl overflow-hidden">
        <KhoiMenuChon 
          icon={<Globe size={20} className="text-blue-400" />}
          label={t('settings.language')}
          subtitle={languageDisplay}
          onClick={onGoToNgonNgu}
        />
        <KhoiMenuChon 
          icon={<Palette size={20} className="text-purple-400" />}
          label={t('settings.theme')}
          subtitle={themeDisplay}
          onClick={onGoToGiaoDien}
          isLast
        />
      </div>
    </div>
  );
}

// =====================================================
// MÀN HÌNH: HỒ SƠ CỦA TÔI
// =====================================================
function ScreenHoSoCuaToi({ 
  isNhanSu,
  isKhachHang,
  onGoToThongTin, 
  onGoToThanhTich,
  onGoToDonHang
}: { 
  isNhanSu: boolean;
  isKhachHang: boolean;
  onGoToThongTin: () => void;
  onGoToThanhTich: () => void;
  onGoToDonHang: () => void;
}) {
  const { t } = useAppSettings();
  
  return (
    <div className="space-y-4">
      <div className="bg-white/5 border border-white/10 rounded-2xl overflow-hidden">
        <KhoiMenuChon 
          icon={<User size={20} className="text-[#C69C6D]" />}
          label={t('profile.personalInfo')}
          subtitle={t('profile.personalInfoDesc')}
          onClick={onGoToThongTin}
        />
        
        {/* Thành Tích - chỉ hiện cho nhân sự */}
        {isNhanSu && (
          <KhoiMenuChon 
            icon={<Trophy size={20} className="text-yellow-400" />}
            label={t('profile.achievements')}
            subtitle={t('profile.achievementsDesc')}
            onClick={onGoToThanhTich}
          />
        )}
        
        {/* Đơn Hàng - chỉ hiện cho khách hàng */}
        {isKhachHang && (
          <KhoiMenuChon 
            icon={<Package size={20} className="text-green-400" />}
            label={t('profile.orders')}
            subtitle={t('profile.ordersDesc')}
            onClick={onGoToDonHang}
            isLast
          />
        )}
        
        {/* Nếu là nhân sự thì Thành Tích là last */}
        {isNhanSu && !isKhachHang && (
          <div className="hidden" /> // Placeholder để isLast hoạt động đúng
        )}
      </div>
    </div>
  );
}

// =====================================================
// MÀN HÌNH: THÔNG TIN CÁ NHÂN
// =====================================================
function ScreenThongTinCaNhan({ nguoiDung }: { nguoiDung: any }) {
  const { t } = useAppSettings();
  
  const fields = [
    { icon: User, label: t('field.fullName'), value: nguoiDung?.ho_ten },
    { icon: Mail, label: t('field.email'), value: nguoiDung?.email },
    { icon: Phone, label: t('field.phone'), value: nguoiDung?.so_dien_thoai },
    { icon: MapPin, label: t('field.address'), value: nguoiDung?.dia_chi },
    { icon: CreditCard, label: t('field.idCard'), value: nguoiDung?.cccd },
  ];

  return (
    <div className="space-y-4">
      <div className="bg-white/5 border border-white/10 rounded-2xl overflow-hidden">
        {fields.map((field, idx) => {
          const Icon = field.icon;
          const isLast = idx === fields.length - 1;
          return (
            <div key={idx} className={`px-4 py-4 ${!isLast ? 'border-b border-white/5' : ''}`}>
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center">
                  <Icon size={20} className="text-[#C69C6D]" />
                </div>
                <div className="flex-1 min-w-0">
                  <p className="text-white/50 text-xs">{field.label}</p>
                  <p className="text-white font-medium truncate">
                    {field.value || <span className="text-white/30 italic">{t('field.notUpdated')}</span>}
                  </p>
                </div>
              </div>
            </div>
          );
        })}
      </div>

      <button className="w-full py-4 bg-gradient-to-r from-[#C69C6D] to-[#F2D3A0] text-black rounded-2xl font-bold">
        {t('profile.editInfo')}
      </button>
    </div>
  );
}

// =====================================================
// MÀN HÌNH: THÀNH TÍCH (nhan_su)
// =====================================================
function ScreenThanhTich({ nguoiDung }: { nguoiDung: any }) {
  const { t } = useAppSettings();
  
  return (
    <div className="space-y-4">
      <div className="bg-white/5 border border-white/10 rounded-2xl p-6 text-center">
        <Trophy size={48} className="text-yellow-400 mx-auto mb-4" />
        <h3 className="text-lg font-bold text-white mb-2">{t('achievements.title')}</h3>
        <p className="text-white/60 text-sm">{t('achievements.developing')}</p>
      </div>
      
      {/* Placeholder cho các thành tích */}
      <div className="bg-white/5 border border-white/10 rounded-2xl overflow-hidden">
        <div className="px-4 py-4 border-b border-white/5">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-yellow-500/20 flex items-center justify-center">
              <Trophy size={20} className="text-yellow-400" />
            </div>
            <div className="flex-1">
              <p className="text-white font-medium">{t('achievements.points')}</p>
              <p className="text-white/50 text-sm">0</p>
            </div>
          </div>
        </div>
        <div className="px-4 py-4">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center">
              <Trophy size={20} className="text-purple-400" />
            </div>
            <div className="flex-1">
              <p className="text-white font-medium">{t('achievements.badges')}</p>
              <p className="text-white/50 text-sm">{t('achievements.noBadges')}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// =====================================================
// MÀN HÌNH: ĐƠN HÀNG (khach_hang)
// =====================================================
function ScreenDonHang({ orders, isLoading, onReload }: { orders: Order[]; isLoading: boolean; onReload: () => void }) {
  const { t, language } = useAppSettings();
  
  if (isLoading) {
    return (
      <div className="flex items-center justify-center py-20">
        <div className="w-12 h-12 border-4 border-[#C69C6D]/30 border-t-[#C69C6D] rounded-full animate-spin"></div>
      </div>
    );
  }

  if (orders.length === 0) {
    return (
      <div className="text-center py-20">
        <Package size={48} className="text-white/20 mx-auto mb-4" />
        <h3 className="text-lg font-bold text-white mb-2">{t('orders.empty')}</h3>
        <p className="text-white/60 text-sm mb-4">{t('orders.emptyDesc')}</p>
        <button onClick={onReload} className="px-4 py-2 bg-[#C69C6D] text-black rounded-lg font-medium">
          {t('app.refresh')}
        </button>
      </div>
    );
  }

  return (
    <div className="space-y-3">
      {orders.map((order) => (
        <div key={order.id} className="bg-white/5 border border-white/10 rounded-xl p-4">
          <div className="flex items-center justify-between mb-2">
            <span className="text-[#C69C6D] font-bold">{order.ma_don}</span>
            <span className="text-xs px-2 py-1 bg-white/10 rounded-full text-white/80">
              {OrderService.formatStatus(order.trang_thai)}
            </span>
          </div>
          <p className="text-white/60 text-sm">{new Date(order.tao_luc).toLocaleDateString(language === 'vi' ? 'vi-VN' : 'en-US')}</p>
          <p className="text-white font-bold mt-2">{OrderService.formatMoney(order.tong_tien)}</p>
        </div>
      ))}
    </div>
  );
}

// =====================================================
// MÀN HÌNH: NGÔN NGỮ
// =====================================================
function ScreenNgonNgu() {
  const { language, setLanguage, t } = useAppSettings();
  
  const languages: { code: LanguageCode; name: string; flag: string }[] = [
    { code: 'vi', name: 'Tiếng Việt', flag: '🇻🇳' },
    { code: 'en', name: 'English', flag: '🇺🇸' },
  ];

  const handleSelect = (code: LanguageCode) => {
    setLanguage(code);
  };

  return (
    <div className="space-y-4">
      <div className="bg-[var(--bg-card)] border border-[var(--border-color)] rounded-2xl overflow-hidden">
        {languages.map((lang, idx) => (
          <button
            key={lang.code}
            onClick={() => handleSelect(lang.code)}
            className={`w-full px-4 py-4 flex items-center gap-3 hover:bg-[var(--hover-bg)] transition-colors ${idx < languages.length - 1 ? 'border-b border-[var(--border-light)]' : ''}`}
          >
            <span className="text-2xl">{lang.flag}</span>
            <span className="flex-1 text-left text-[var(--text-primary)] font-medium">{lang.name}</span>
            {language === lang.code && (
              <div className="w-6 h-6 rounded-full bg-[var(--accent)] flex items-center justify-center">
                <Check size={14} className="text-black" />
              </div>
            )}
          </button>
        ))}
      </div>
      
      <p className="text-[var(--text-muted)] text-xs text-center">
        {language === 'vi' ? 'Thay đổi ngôn ngữ sẽ được áp dụng ngay lập tức' : 'Language change will be applied immediately'}
      </p>
    </div>
  );
}

// =====================================================
// MÀN HÌNH: GIAO DIỆN
// =====================================================
function ScreenGiaoDien() {
  const { theme, setTheme, t } = useAppSettings();
  
  const themes: { code: ThemeMode; name: string; icon: typeof Moon; desc: string }[] = [
    { code: 'dark', name: t('settings.themeDark'), icon: Moon, desc: t('settings.themeDarkDesc') },
    { code: 'light', name: t('settings.themeLight'), icon: Sun, desc: t('settings.themeLightDesc') },
  ];

  const handleSelect = (code: ThemeMode) => {
    setTheme(code);
  };

  return (
    <div className="space-y-4">
      <div className="bg-[var(--bg-card)] border border-[var(--border-color)] rounded-2xl overflow-hidden">
        {themes.map((themeOption, idx) => {
          const Icon = themeOption.icon;
          return (
            <button
              key={themeOption.code}
              onClick={() => handleSelect(themeOption.code)}
              className={`w-full px-4 py-4 flex items-center gap-3 hover:bg-[var(--hover-bg)] transition-colors ${idx < themes.length - 1 ? 'border-b border-[var(--border-light)]' : ''}`}
            >
              <div className="w-10 h-10 rounded-xl bg-[var(--bg-card)] flex items-center justify-center">
                <Icon size={20} className={themeOption.code === 'dark' ? 'text-purple-400' : 'text-yellow-400'} />
              </div>
              <div className="flex-1 text-left">
                <p className="text-[var(--text-primary)] font-medium">{themeOption.name}</p>
                <p className="text-[var(--text-secondary)] text-sm">{themeOption.desc}</p>
              </div>
              {theme === themeOption.code && (
                <div className="w-6 h-6 rounded-full bg-[var(--accent)] flex items-center justify-center">
                  <Check size={14} className="text-black" />
                </div>
              )}
            </button>
          );
        })}
      </div>
      
      <p className="text-[var(--text-muted)] text-xs text-center">
        {t('settings.language') === 'Ngôn Ngữ' ? 'Thay đổi giao diện sẽ được áp dụng ngay lập tức' : 'Theme change will be applied immediately'}
      </p>
    </div>
  );
}
</file>

<file path="app/QueryProvider.tsx">
'use client';

import React, { useState } from 'react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';

export default function QueryProvider({ children }: { children: React.ReactNode }) {
  const [queryClient] = useState(() => new QueryClient({
    defaultOptions: {
      queries: {
        // Dữ liệu được coi là "tươi" trong 1 phút, sau đó mới fetch lại nếu cần
        staleTime: 60 * 1000, 
        // Tự động fetch lại khi cửa sổ trình duyệt được focus
        refetchOnWindowFocus: false,
        // Số lần thử lại nếu API lỗi
        retry: 1,
      },
    },
  }));

  return (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  );
}
</file>

<file path="app/ThuVien/DataNormalizer.ts">
'use client';

/**
 * 🔧 DATA NORMALIZER - Xử lý dữ liệu Vietnamese với:
 * - Trim whitespace
 * - Normalize case (UPPERCASE, lowercase, Title Case)
 * - Chuẩn hóa giá trị phân loại
 */

export class DataNormalizer {
  /**
   * Các vị trí hợp lệ trong bảng nhan_su
   */
  static VALID_VI_TRI = {
    ADMIN: 'Admin',
    QUAN_LY: 'Quản lý',
    SALES: 'Sales',
  } as const;

  /**
   * Các phân loại hợp lệ trong bảng khach_hang
   */
  static VALID_PHAN_LOAI = {
    VIP: 'VIP',
    KH_TRONG_TAM: 'KH Trọng tâm',
  } as const;

  /**
   * Normalize vị trí (vi_tri)
   * Chuyển đầu vào thành một giá trị chuẩn
   * Ví dụ: "  ADMIN  " → "Admin"
   *        "quản lý" → "Quản lý"
   *        "sales" → "Sales"
   */
  static normalizeViTri(value: string | null | undefined): string | null {
    if (!value) return null;

    const normalized = value.trim().toLowerCase();

    // Check Admin
    if (['admin', 'ad', 'administrator'].includes(normalized)) {
      return this.VALID_VI_TRI.ADMIN;
    }

    // Check Quản lý
    if (['quản lý', 'ql', 'quan ly', 'manager'].includes(normalized)) {
      return this.VALID_VI_TRI.QUAN_LY;
    }

    // Check Sales
    if (['sales', 'sale', 'bán hàng'].includes(normalized)) {
      return this.VALID_VI_TRI.SALES;
    }

    return null; // Giá trị không hợp lệ
  }

  /**
   * Normalize phân loại khách hàng (phan_loai)
   * Ví dụ: "  VIP  " → "VIP"
   *        "kh trọng tâm" → "KH Trọng tâm"
   */
  static normalizePhanLoai(value: string | null | undefined): string | null {
    if (!value) return null;

    const normalized = value.trim().toLowerCase().replace(/\s+/g, ' ');

    // Check VIP
    if (normalized === 'vip') {
      return this.VALID_PHAN_LOAI.VIP;
    }

    // Check KH Trọng tâm
    if (
      ['kh trọng tâm', 'kh trong tam', 'khách trọng tâm', 'khach trong tam'].includes(normalized)
    ) {
      return this.VALID_PHAN_LOAI.KH_TRONG_TAM;
    }

    return null; // Giá trị không hợp lệ
  }

  /**
   * Trim và normalize text chung
   */
  static normalizeText(value: string | null | undefined): string | null {
    if (!value) return null;
    return value.trim();
  }

  /**
   * Check xem vi_tri có phải Admin không
   */
  static isAdmin(viTri: string | null | undefined): boolean {
    const normalized = this.normalizeViTri(viTri);
    return normalized === this.VALID_VI_TRI.ADMIN;
  }

  /**
   * Check xem vi_tri có phải Quản lý không
   */
  static isQuanLy(viTri: string | null | undefined): boolean {
    const normalized = this.normalizeViTri(viTri);
    return normalized === this.VALID_VI_TRI.QUAN_LY;
  }

  /**
   * Check xem vi_tri có phải Sales không
   */
  static isSales(viTri: string | null | undefined): boolean {
    const normalized = this.normalizeViTri(viTri);
    return normalized === this.VALID_VI_TRI.SALES;
  }

  /**
   * Check xem phan_loai có phải VIP không
   */
  static isVIP(phanLoai: string | null | undefined): boolean {
    const normalized = this.normalizePhanLoai(phanLoai);
    return normalized === this.VALID_PHAN_LOAI.VIP;
  }

  /**
   * Check xem phan_loai có phải KH Trọng tâm không
   */
  static isKHTrongTam(phanLoai: string | null | undefined): boolean {
    const normalized = this.normalizePhanLoai(phanLoai);
    return normalized === this.VALID_PHAN_LOAI.KH_TRONG_TAM;
  }

  /**
   * Get tất cả valid vi_tri values
   */
  static getAllViTri(): string[] {
    return Object.values(this.VALID_VI_TRI);
  }

  /**
   * Get tất cả valid phan_loai values
   */
  static getAllPhanLoai(): string[] {
    return Object.values(this.VALID_PHAN_LOAI);
  }
}

export type ViTri = typeof DataNormalizer.VALID_VI_TRI[keyof typeof DataNormalizer.VALID_VI_TRI];
export type PhanLoai = typeof DataNormalizer.VALID_PHAN_LOAI[keyof typeof DataNormalizer.VALID_PHAN_LOAI];
</file>

<file path="app/ThuVien/InputValidator.ts">
// ✅ INPUT VALIDATION & SANITIZATION SERVICE
// Prevents XSS attacks and invalid data entry

/**
 * Sanitize HTML to prevent XSS attacks
 * Removes dangerous tags and attributes
 */
export function sanitizeHtml(html: string): string {
  if (!html || typeof html !== 'string') return '';
  
  // Create a temporary DOM element to safely parse HTML
  const temp = document.createElement('div');
  temp.textContent = html; // textContent prevents HTML parsing
  return temp.innerHTML;
}

/**
 * Sanitize chat message input
 * - Removes excessive whitespace
 * - Prevents XSS via HTML tags
 * - Max length 2000 chars
 */
export function sanitizeChatMessage(message: string): string {
  if (!message || typeof message !== 'string') return '';
  
  // Remove script tags and dangerous HTML
  let sanitized = message
    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
    .replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '')
    .replace(/on\w+\s*=\s*["'][^"']*["']/gi, '') // Remove event handlers
    .trim();
  
  // Limit length
  if (sanitized.length > 2000) {
    sanitized = sanitized.substring(0, 2000);
  }
  
  return sanitized;
}

/**
 * Validate email format
 */
export function validateEmail(email: string): boolean {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

/**
 * Validate phone format (Vietnamese)
 * Accepts: 09xx, 08xx, 07xx, 03xx format
 */
export function validatePhone(phone: string): boolean {
  const phoneRegex = /^(09|08|07|03|01)\d{8}$/;
  return phoneRegex.test(phone.replace(/\s+/g, ''));
}

/**
 * Validate Vietnamese name
 * - No special characters or numbers
 * - Min 2 chars, max 100
 */
export function validateVietnameseName(name: string): boolean {
  if (!name || typeof name !== 'string') return false;
  
  const trimmed = name.trim();
  if (trimmed.length < 2 || trimmed.length > 100) return false;
  
  // Allow Vietnamese characters, spaces, hyphens, apostrophes
  const nameRegex = /^[a-zA-ZÀ-ỿ\s'-]+$/;
  return nameRegex.test(trimmed);
}

/**
 * Sanitize search query
 * - Max 100 chars
 * - Remove special SQL characters
 */
export function sanitizeSearchQuery(query: string): string {
  if (!query || typeof query !== 'string') return '';
  
  let sanitized = query
    .trim()
    .substring(0, 100)
    .replace(/[;'"%\\]/g, ''); // Remove SQL injection chars
  
  return sanitized;
}

/**
 * Validate and parse JSON safely
 */
export function safeParseJson<T>(json: string, fallback: T): T {
  try {
    return JSON.parse(json) as T;
  } catch {
    return fallback;
  }
}

/**
 * Validate URL format
 */
export function validateUrl(url: string): boolean {
  try {
    new URL(url);
    return true;
  } catch {
    return false;
  }
}

/**
 * Truncate text with ellipsis
 */
export function truncateText(text: string, maxLength: number = 100): string {
  if (!text || typeof text !== 'string') return '';
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + '...';
}

/**
 * Validate password strength
 * - Min 8 chars
 * - At least 1 uppercase, 1 lowercase, 1 number, 1 special char
 */
export function validatePasswordStrength(password: string): {
  isValid: boolean;
  strength: 'weak' | 'fair' | 'good' | 'strong';
  feedback: string[];
} {
  const feedback: string[] = [];
  let score = 0;

  if (!password || password.length < 8) {
    feedback.push('Mật khẩu phải có ít nhất 8 ký tự');
  } else {
    score++;
  }

  if (!/[A-Z]/.test(password)) {
    feedback.push('Phải có ít nhất 1 chữ cái viết hoa');
  } else {
    score++;
  }

  if (!/[a-z]/.test(password)) {
    feedback.push('Phải có ít nhất 1 chữ cái viết thường');
  } else {
    score++;
  }

  if (!/[0-9]/.test(password)) {
    feedback.push('Phải có ít nhất 1 số');
  } else {
    score++;
  }

  if (!/[!@#$%^&*]/.test(password)) {
    feedback.push('Phải có ít nhất 1 ký tự đặc biệt (!@#$%^&*)');
  } else {
    score++;
  }

  let strength: 'weak' | 'fair' | 'good' | 'strong' = 'weak';
  if (score >= 5) strength = 'strong';
  else if (score >= 4) strength = 'good';
  else if (score >= 3) strength = 'fair';

  return {
    isValid: score >= 4,
    strength,
    feedback,
  };
}
</file>

<file path="app/ThuVien/LoggerService.ts">
// ✅ CENTRALIZED ERROR LOGGING SERVICE
// Provides unified error tracking and logging

type LogLevel = 'debug' | 'info' | 'warn' | 'error';

interface LogEntry {
  timestamp: string;
  level: LogLevel;
  context: string;
  message: string;
  data?: unknown;
  error?: {
    message: string;
    stack?: string;
    code?: string;
  };
}

export class LoggerService {
  private static isDevelopment = process.env.NODE_ENV === 'development';

  /**
   * Log at debug level
   */
  static debug(context: string, message: string, data?: unknown) {
    if (this.isDevelopment) {
      console.debug(`[${context}] ${message}`, data);
    }
    this.captureLog('debug', context, message, data);
  }

  /**
   * Log at info level
   */
  static info(context: string, message: string, data?: unknown) {
    console.info(`[${context}] ${message}`, data);
    this.captureLog('info', context, message, data);
  }

  /**
   * Log at warn level
   */
  static warn(context: string, message: string, data?: unknown) {
    console.warn(`[${context}] ${message}`, data);
    this.captureLog('warn', context, message, data);
  }

  /**
   * Log at error level - recommended for use with try/catch
   */
  static error(context: string, message: string, error?: Error | unknown) {
    const errorObj = error instanceof Error ? error : new Error(String(error));
    
    console.error(`[${context}] ${message}`, errorObj);
    
    this.captureLog('error', context, message, undefined, {
      message: errorObj.message,
      stack: errorObj.stack,
      code: (error as any)?.code,
    });
  }

  /**
   * Capture log entry for analytics/monitoring
   * In production, send to external service (Sentry, LogRocket, etc)
   */
  private static captureLog(
    level: LogLevel,
    context: string,
    message: string,
    data?: unknown,
    error?: LogEntry['error']
  ) {
    const entry: LogEntry = {
      timestamp: new Date().toISOString(),
      level,
      context,
      message,
    };

    if (data !== undefined) {
      entry.data = data;
    }

    if (error) {
      entry.error = error;
    }

    // TODO: In production, send to error tracking service
    // Sentry.captureMessage(message, level);
    // or custom API endpoint
  }

  /**
   * Create a scoped logger for a specific component/service
   */
  static createScoped(context: string) {
    return {
      debug: (msg: string, data?: unknown) => this.debug(context, msg, data),
      info: (msg: string, data?: unknown) => this.info(context, msg, data),
      warn: (msg: string, data?: unknown) => this.warn(context, msg, data),
      error: (msg: string, error?: Error | unknown) => this.error(context, msg, error),
    };
  }
}
</file>

<file path="app/ThuVien/QueryTimeout.ts">
// ✅ SUPABASE QUERY TIMEOUT WRAPPER
// Prevents hanging queries by adding timeout

export class QueryTimeoutError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'QueryTimeoutError';
  }
}

/**
 * Wrap a promise with a timeout
 * @param promise - The promise to wrap
 * @param timeoutMs - Timeout in milliseconds (default: 10000ms = 10s)
 * @param errorMessage - Custom error message
 */
export async function withTimeout<T>(
  promise: Promise<T>,
  timeoutMs: number = 10000,
  errorMessage: string = 'Truy vấn quá lâu, vui lòng thử lại'
): Promise<T> {
  let timeoutId: NodeJS.Timeout;

  const timeoutPromise = new Promise<never>((_, reject) => {
    timeoutId = setTimeout(() => {
      reject(new QueryTimeoutError(errorMessage));
    }, timeoutMs);
  });

  try {
    const result = await Promise.race([promise, timeoutPromise]);
    clearTimeout(timeoutId!);
    return result;
  } catch (error) {
    clearTimeout(timeoutId!);
    throw error;
  }
}

/**
 * Wrap Supabase query with timeout
 * Usage:
 * ```ts
 * const { data, error } = await withQueryTimeout(
 *   supabase.from('don_hang').select('*'),
 *   8000, // 8 second timeout
 *   'Không thể tải đơn hàng'
 * );
 * ```
 */
export async function withQueryTimeout<T>(
  queryPromise: Promise<{ data: T | null; error: any }>,
  timeoutMs: number = 10000,
  errorMessage: string = 'Truy vấn quá lâu'
): Promise<{ data: T | null; error: any }> {
  try {
    return await withTimeout(queryPromise, timeoutMs, errorMessage);
  } catch (error) {
    if (error instanceof QueryTimeoutError) {
      return {
        data: null,
        error: { message: error.message, code: 'QUERY_TIMEOUT' },
      };
    }
    throw error;
  }
}
</file>

<file path="app/ThuVien/withTimeout.ts">
// ✅ TIMEOUT WRAPPER for async operations
// Prevents hanging queries and provides fallback

/**
 * Wraps a promise with timeout functionality
 * @param promise The promise to wrap
 * @param ms Timeout in milliseconds (default: 10000ms = 10s)
 * @param timeoutError Custom error message on timeout
 */
export async function withTimeout<T>(
  promise: Promise<T>,
  ms: number = 10000,
  timeoutError: string = 'Operation timed out'
): Promise<T> {
  let timeoutId: NodeJS.Timeout;

  const timeoutPromise = new Promise<never>((_, reject) => {
    timeoutId = setTimeout(() => {
      reject(new Error(timeoutError));
    }, ms);
  });

  try {
    const result = await Promise.race([promise, timeoutPromise]);
    clearTimeout(timeoutId!);
    return result;
  } catch (error) {
    clearTimeout(timeoutId!);
    throw error;
  }
}

/**
 * Create a debounced function that delays invoking until after `ms` milliseconds
 * Useful for search inputs, button clicks, etc.
 */
export function debounce<T extends (...args: any[]) => any>(
  func: T,
  ms: number = 300
): (...args: Parameters<T>) => void {
  let timeoutId: NodeJS.Timeout;

  return function (...args: Parameters<T>) {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
      func(...args);
    }, ms);
  };
}

/**
 * Create a throttled function that only invokes at most once per `ms` milliseconds
 * Useful for scroll handlers, resize handlers
 */
export function throttle<T extends (...args: any[]) => any>(
  func: T,
  ms: number = 300
): (...args: Parameters<T>) => void {
  let lastRun = 0;

  return function (...args: Parameters<T>) {
    const now = Date.now();
    if (now - lastRun >= ms) {
      func(...args);
      lastRun = now;
    }
  };
}
</file>

<file path="app/types/index.ts">
// ✅ User & Auth Types
export interface User {
  id: string;
  ho_ten: string;
  email: string;
  avatar_url?: string | null;
  so_dien_thoai?: string | null;
  dia_chi?: string | null;
  cccd?: string | null;
  vi_tri?: string | null;
  phan_loai?: string | null;
  userType: 'nhan_su' | 'khach_hang' | 'guest';
  role?: string;
  permissions?: string[];
}

export interface AuthSession {
  user: User | null;
  isLoading: boolean;
  error?: string | null;
}

// ✅ Event Types
export interface ContentVisibilityEvent extends CustomEvent {
  detail: {
    id: string;
    open: boolean;
  };
}

// ✅ Component Props Types
export interface MenuTrenProps {
  nguoiDung: User | null;
  loiChao: string;
}

export interface MenuDuoiProps {
  currentUser: User | null;
  onToggleContent: (isOpen: boolean) => void;
}

export interface NutVuongProps {
  icon: React.ComponentType<{ size?: number; className?: string }>;
  badge?: number;
  onClick?: () => void;
}

// ✅ Chat Metadata Types
export interface MessageMetadata {
  edited?: boolean;
  edited_at?: string;
  pinned?: boolean;
  forwarded?: boolean;
  forwarded_from?: string;
  [key: string]: any;
}

export interface MessageAttachment {
  id: string;
  type: 'image' | 'file' | 'video' | 'audio';
  url: string;
  filename: string;
  size: number;
  mime_type?: string;
}

export interface ConversationMetadata {
  description?: string;
  avatar_url?: string;
  settings?: {
    mute_notifications?: boolean;
    archive?: boolean;
    pin?: boolean;
  };
  [key: string]: any;
}

// ✅ API Response Types
export interface ApiResponse<T> {
  data: T | null;
  error: string | null;
  success: boolean;
}

// ✅ Chat Types
export interface ChatMessage {
  id: string;
  conversation_id: string;
  sender_id: string;
  sender_name?: string;
  sender_email?: string;
  content: string;
  message_type: 'text' | 'image' | 'file';
  attachments?: Array<{
    id: string;
    url: string;
    type: 'image' | 'file';
    name?: string;
  }>;
  created_at: string;
  updated_at: string;
  reply_to_id?: string;
  reply_to?: ChatMessage;
  reactions?: Array<{
    id: string;
    emoji: string;
    user_id: string;
  }>;
}

export interface Order {
  id: string;
  ma_don: string;
  ten_khach: string | null;
  sdt: string | null;
  dia_chi: string | null;
  ghi_chu: string | null;
  trang_thai: 'moi' | 'dang_xu_ly' | 'dang_giao' | 'hoan_thanh' | 'huy';
  tong_tien: number;
  nguoi_tao: string;
  tao_luc: string;
  cap_nhat_luc: string;
}

export interface OrderItem {
  id: string;
  don_hang_id: string;
  ten_san_pham: string | null;
  so_luong: number;
  don_gia: number;
  thanh_tien: number;
}
</file>

<file path="docs/CauLenhLayDuLieuBackEnd.md">
-- ============================================================
-- GENERATE AI CONTEXT (MARKDOWN FORMAT)
-- Chạy cái này -> Copy kết quả -> Paste cho AI
-- ============================================================

SELECT 
    E'# DATABASE SCHEMA DOCUMENTATION\n\n' ||
    string_agg(
        E'## Table: ' || table_name || E'\n' ||
        '| Column | Type | Nullable | Default | Extra |\n' ||
        '|---|---|---|---|---|\n' ||
        columns_info || E'\n' ||
        CASE WHEN constraints_info IS NOT NULL THEN E'> Constraints:\n' || constraints_info || E'\n' ELSE '' END ||
        E'\n',
        E'\n'
    )
FROM (
    SELECT 
        t.table_name,
        string_agg(
            '| ' || c.column_name || 
            ' | ' || c.data_type || 
            ' | ' || c.is_nullable || 
            ' | ' || COALESCE(LEFT(c.column_default, 20) || '...', '-') || 
            ' | ' || 
            CASE 
                WHEN pk.column_name IS NOT NULL THEN '🔑 PK' 
                WHEN fk.column_name IS NOT NULL THEN '🔗 FK -> ' || fk.foreign_table_name || '.' || fk.foreign_column_name
                ELSE '' 
            END || ' |',
            E'\n' ORDER BY c.ordinal_position
        ) as columns_info,
        (
            SELECT string_agg('- ' || con.constraint_type || ': ' || con.constraint_name, E'\n')
            FROM information_schema.table_constraints con
            WHERE con.table_name = t.table_name AND con.table_schema = 'public' AND con.constraint_type != 'PRIMARY KEY' -- PK đã hiện ở cột rồi
        ) as constraints_info
    FROM information_schema.tables t
    JOIN information_schema.columns c ON t.table_name = c.table_name AND t.table_schema = c.table_schema
    
    -- Lấy thông tin Primary Key
    LEFT JOIN (
        SELECT kcu.table_name, kcu.column_name
        FROM information_schema.key_column_usage kcu
        JOIN information_schema.table_constraints tc ON kcu.constraint_name = tc.constraint_name
        WHERE tc.constraint_type = 'PRIMARY KEY'
    ) pk ON c.table_name = pk.table_name AND c.column_name = pk.column_name

    -- Lấy thông tin Foreign Key
    LEFT JOIN (
        SELECT 
            kcu.table_name, kcu.column_name, 
            ccu.table_name AS foreign_table_name, ccu.column_name AS foreign_column_name
        FROM information_schema.key_column_usage kcu
        JOIN information_schema.table_constraints tc ON kcu.constraint_name = tc.constraint_name
        JOIN information_schema.constraint_column_usage ccu ON tc.constraint_name = ccu.constraint_name
        WHERE tc.constraint_type = 'FOREIGN KEY'
    ) fk ON c.table_name = fk.table_name AND c.column_name = fk.column_name

    WHERE t.table_schema = 'public' AND t.table_type = 'BASE TABLE'
    GROUP BY t.table_name
) as schema_generator;
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="postcss.config.js">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/sw.js">
// public/sw.js

self.addEventListener('push', function (event) {
  if (!(self.Notification && self.Notification.permission === 'granted')) {
    return;
  }

  const data = event.data?.json() ?? {};
  const title = data.title || 'NghiemArt Thông Báo';
  const message = data.body || 'Bạn có thông báo mới';
  const icon = '/icon-192.png'; // Đảm bảo mày có icon này
  const badge = '/icon-192.png'; // Icon nhỏ trên thanh status (Android)
  const url = data.url || '/';

  const options = {
    body: message,
    icon: icon,
    badge: badge,
    data: { url: url }, // Lưu URL để click vào
    vibrate: [100, 50, 100], // Rung bần bật: Rung 100ms, nghỉ 50ms, rung 100ms
    actions: [
      { action: 'open', title: 'Xem ngay' },
      { action: 'close', title: 'Đóng' }
    ]
  };

  event.waitUntil(
    self.registration.showNotification(title, options)
  );
});

self.addEventListener('notificationclick', function (event) {
  event.notification.close();

  if (event.action === 'close') return;

  const urlToOpen = event.notification.data.url || '/';

  event.waitUntil(
    clients.matchAll({ type: 'window', includeUncontrolled: true }).then((windowClients) => {
      // Nếu app đang mở -> Focus vào nó
      for (let i = 0; i < windowClients.length; i++) {
        const client = windowClients[i];
        if (client.url === urlToOpen && 'focus' in client) {
          return client.focus();
        }
      }
      // Nếu app chưa mở -> Mở tab mới
      if (clients.openWindow) {
        return clients.openWindow(urlToOpen);
      }
    })
  );
});
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="typeDefs.ts">
// Type definitions for form extensions
export interface FormExtensions {
  // Override toàn bộ form component
  customFormComponent?: React.ComponentType<any>;

  // Extension functions
  beforeSubmit?: (data: any, config: any) => Promise<any> | any;
  afterSubmit?: (data: any, config: any) => Promise<void> | void;
  customValidation?: (data: any, config: any) => { isValid: boolean; errors: Record<string, string> };
  customFieldRenderer?: (field: any, value: any, onChange: (value: any) => void, error?: string) => React.ReactNode;

  // Field-level customizations
  fieldOverrides?: Record<string, any>;

  // Table-specific logic
  onFormInit?: (formData: any, config: any) => any;
  onFormChange?: (field: string, value: any, formData: any, config: any) => any;
}
</file>

<file path="app/actions/QuyenHanAdmin.ts">
'use server';

import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';
import { createClient } from '@supabase/supabase-js'; // 🟢 1. IMPORT THÊM

// Kết nối DB
const sql = postgres(process.env.DATABASE_URL!, {
  ssl: 'require',
  max: 10,
  idle_timeout: 20, 
});

// 🛡️ 1. CHECK QUYỀN SUPER ADMIN (CHỈ ADMIN & BOSS)
async function requireSuperAdmin() {
    const cookieStore = cookies();
    
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                get(name: string) { return cookieStore.get(name)?.value },
                set(name: string, value: string, options: any) {},
                remove(name: string, options: any) {},
            },
        }
    );

    const { data: { user } } = await supabase.auth.getUser();
    if (!user || !user.email) throw new Error("Unauthorized: Bạn chưa đăng nhập");

    const { data: nhanSu } = await supabase
        .from('nhan_su')
        .select('vi_tri, vi_tri_normalized')
        .eq('email', user.email)
        .single();
    
    // 🔒 CHỈ CHO PHÉP ADMIN VÀ BOSS
    const allowedRoles = ['admin', 'boss'];
    const userRoleNormalized = (nhanSu?.vi_tri_normalized || '').toLowerCase();
    
    const isAllowed = allowedRoles.includes(userRoleNormalized);

    if (!isAllowed) {
        throw new Error("Forbidden: Chỉ Super Admin mới có quyền truy cập System Core");
    }
}

// 🛡️ 2. VALIDATE INPUT
function validateIdentifier(name: string) {
    if (!/^[a-zA-Z0-9_]+$/.test(name)) {
        throw new Error(`Tên không hợp lệ: ${name}. Chỉ chấp nhận chữ, số và gạch dưới.`);
    }
}

// --- CÁC HÀM HỆ THỐNG (SYSTEM ACTIONS) ---

// 1. LẤY DANH SÁCH BẢNG
export async function getTablesWithRLSAction() {
    try {
        await requireSuperAdmin();
        const tables = await sql`
            SELECT c.relname as table_name, c.relrowsecurity as rls_enabled
            FROM pg_class c
            JOIN pg_namespace n ON n.oid = c.relnamespace
            WHERE n.nspname = 'public' AND c.relkind = 'r'
            ORDER BY c.relname;
        `;
        return { success: true, data: Array.from(tables).map(t => ({ table_name: t.table_name, rls_enabled: t.rls_enabled })) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 2. LẤY SCHEMA CẤU TRÚC BẢNG
export async function getTableSchemaAction(tableName: string) {
    try {
        await requireSuperAdmin();
        validateIdentifier(tableName);
        const columns = await sql`
            SELECT column_name, data_type, is_nullable, column_default
            FROM information_schema.columns 
            WHERE table_schema = 'public' AND table_name = ${tableName}
            ORDER BY ordinal_position;
        `;
        return { success: true, data: Array.from(columns) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 3. TOGGLE RLS (BẬT/TẮT BẢO MẬT)
export async function toggleRLSAction(tableName: string, enable: boolean) {
    try {
        await requireSuperAdmin();
        validateIdentifier(tableName);
        if (enable) {
            await sql.unsafe(`ALTER TABLE "${tableName}" ENABLE ROW LEVEL SECURITY`);
        } else {
            await sql.unsafe(`ALTER TABLE "${tableName}" DISABLE ROW LEVEL SECURITY`);
            await sql.unsafe(`GRANT ALL ON TABLE "${tableName}" TO anon, authenticated, service_role`);
        }
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 4. LẤY DỮ LIỆU THÔ (RAW DATA VIEWER)
export async function getTableDataPaginatedAction(tableName: string, page: number, pageSize: number) {
    try {
        await requireSuperAdmin();
        validateIdentifier(tableName);
        
        const columns = await sql`SELECT column_name FROM information_schema.columns WHERE table_schema = 'public' AND table_name = ${tableName}`;
        const colNames = Array.from(columns).map(c => c.column_name);
        
        let sortCol = 'id';
        if (colNames.includes('tao_luc')) sortCol = 'tao_luc';
        else if (colNames.includes('created_at')) sortCol = 'created_at';
        else if (!colNames.includes('id') && colNames.length > 0) sortCol = colNames[0];

        const offset = (page - 1) * pageSize;
        const data = await sql.unsafe(`SELECT * FROM "${tableName}" ORDER BY "${sortCol}" DESC LIMIT ${pageSize} OFFSET ${offset}`);
        const [countResult] = await sql.unsafe(`SELECT count(*) as total FROM "${tableName}"`);
        
        return { success: true, data: Array.from(data), total: Number(countResult.total) };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 5. CẬP NHẬT Ô DỮ LIỆU BẤT KỲ (RAW EDIT)
export async function updateTableCellAction(tableName: string, id: string, column: string, value: any) {
    try {
        await requireSuperAdmin();
        validateIdentifier(tableName);
        validateIdentifier(column);

        let finalValue = value === '' ? null : value;
        await sql.unsafe(`UPDATE "${tableName}" SET "${column}" = $1 WHERE id = $2`, [finalValue, id]);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// 6. QUẢN LÝ CẤU TRÚC (CREATE TABLE / ALTER COLUMN)
export async function manageTableStructureAction(tableName: string, columnsDef: any[]) {
  try {
    await requireSuperAdmin();
    if (!tableName) throw new Error("Tên bảng trống");
    validateIdentifier(tableName);

    await sql.unsafe(`
      CREATE TABLE IF NOT EXISTS "${tableName}" (
        id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
        tao_luc timestamptz DEFAULT now()
      )
    `);

    // Tự động tắt RLS khi tạo bảng mới để tránh lỗi quyền
    try {
        await sql.unsafe(`ALTER TABLE "${tableName}" DISABLE ROW LEVEL SECURITY`);
        await sql.unsafe(`GRANT ALL ON TABLE "${tableName}" TO anon, authenticated, service_role`);
    } catch (e) {}

    for (const col of columnsDef) {
        if (['id', 'tao_luc'].includes(col.name)) continue;
        validateIdentifier(col.name);

        const [existing] = await sql`SELECT column_name FROM information_schema.columns WHERE table_schema = 'public' AND table_name = ${tableName} AND column_name = ${col.name}`;
        
        // ... (Logic xử lý default value giữ nguyên từ file cũ)
        let safeDefault = '';
        if (col.defaultValue !== undefined && col.defaultValue !== null && col.defaultValue !== '') {
             let val = String(col.defaultValue).trim();
             const isFunc = ['now()', 'true', 'false'].includes(val.toLowerCase()) || !isNaN(Number(val));
             safeDefault = isFunc ? val : `'${val.replace(/'/g, "''")}'`;
        }

        if (existing) {
            await sql.unsafe(`ALTER TABLE "${tableName}" ALTER COLUMN "${col.name}" TYPE ${col.type} USING "${col.name}"::${col.type}`);
        } else {
            let query = `ALTER TABLE "${tableName}" ADD COLUMN "${col.name}" ${col.type}`;
            if (safeDefault) query += ` DEFAULT ${safeDefault}`;
            await sql.unsafe(query);
        }
    }
    return { success: true };
  } catch (error: any) { return { success: false, error: error.message }; }
}

export async function addColumnAction(tableName: string, colName: string, colType: string) {
    try {
        await requireSuperAdmin();
        validateIdentifier(tableName); validateIdentifier(colName);
        await sql.unsafe(`ALTER TABLE "${tableName}" ADD COLUMN "${colName}" ${colType}`);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// --- 🟢 7. HÀM MỚI: ĐỒNG BỘ USER (SYNC) ---
export async function syncUsersAction() {
    try {
        await requireSuperAdmin(); // Chỉ Admin/Boss được chạy

        // Tạo Client quyền tối cao (Service Role) để thao tác Auth
        const supabaseAdmin = createClient(
            process.env.NEXT_PUBLIC_SUPABASE_URL!,
            process.env.SUPABASE_SERVICE_ROLE_KEY!,
            { auth: { autoRefreshToken: false, persistSession: false } }
        );

        // 1. Lấy danh sách nhân sự hiện có (postgres.js returns array-like)
        const employees = await sql`SELECT email, ho_ten FROM "nhan_su"`;
        const empEmails = new Set(Array.from(employees).map((e: any) => e.email));

        // 2. Lấy danh sách User trong Auth
        const { data: { users: authUsers }, error: authError } = await supabaseAdmin.auth.admin.listUsers();
        if (authError) throw new Error(authError.message);

        let added = 0;
        let deleted = 0;

        // 3. XÓA USER DƯ THỪA (Có trong Auth nhưng không có trong Nhân sự)
        for (const user of authUsers) {
            // Giữ lại admin gốc hoặc các email đặc biệt nếu cần
            if (user.email === 'admin@local') continue;

            if (user.email && !empEmails.has(user.email)) {
                await supabaseAdmin.auth.admin.deleteUser(user.id);
                deleted++;
            }
        }

        // 4. TẠO USER THIẾU (Có trong Nhân sự nhưng chưa có Auth)
        for (const emp of employees) {
            const existingUser = authUsers.find(u => u.email === emp.email);
            if (!existingUser && emp.email) {
                await supabaseAdmin.auth.admin.createUser({
                    email: emp.email,
                    password: '12345678', // Mật khẩu mặc định
                    email_confirm: true,
                    user_metadata: { full_name: emp.ho_ten }
                });
                added++;
            }
        }

        return { success: true, message: `Đã đồng bộ: Xóa ${deleted}, Thêm ${added}` };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}
</file>

<file path="app/actions/QuyenHanKeToan.ts">
"use server";

import postgres from "postgres";
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";
import { sendNotificationToRoles } from "./NotificationAction"; // 🟢 IMPORT

const sql = postgres(process.env.DATABASE_URL!, { ssl: "require" });

async function requireAuth() {
  const cookieStore = cookies();
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
        set() {},
        remove() {},
      },
    }
  );
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) throw new Error("Unauthorized");
  // Lấy thêm tên
  const [ns] = await sql`SELECT id, ho_ten FROM nhan_su WHERE id = ${user.id}`;
  return ns;
}

// 1. LẤY DANH SÁCH
export async function getThuChiDataAction(
  page: number,
  pageSize: number,
  search: string,
  filterType: string
) {
  try {
    await requireAuth();
    let query = `
            SELECT tc.*, ns.ho_ten as nguoi_thuc_hien_ten
            FROM "so_cai_tai_chinh" tc
            LEFT JOIN "nhan_su" ns ON tc.nguoi_thuc_hien = ns.id
            WHERE 1=1
        `;
    const params: any[] = [];
    let paramCount = 1;

    if (search) {
      query += ` AND (mo_ta ILIKE $${paramCount})`;
      params.push(`%${search}%`);
      paramCount++;
    }

    if (filterType && filterType !== "all") {
      query += ` AND loai_giao_dich = $${paramCount}`;
      params.push(filterType);
      paramCount++;
    }

    const countQuery = `SELECT count(*) as total FROM (${query}) as sub`;
    const offset = (page - 1) * pageSize;
    query += ` ORDER BY tao_luc DESC LIMIT ${pageSize} OFFSET ${offset}`;

    const data = await sql.unsafe(query, params);
    const [countResult] = await sql.unsafe(countQuery, params);

    return {
      success: true,
      data: Array.from(data),
      total: Number(countResult.total),
    };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 2. TẠO MỚI (Đã thêm Noti)
export async function createThuChiAction(data: any) {
  try {
    const user = await requireAuth();
    await sql.unsafe(
      `
            INSERT INTO "so_cai_tai_chinh" (
                loai_giao_dich, so_tien, mo_ta, hinh_anh_chung_tu, nguoi_thuc_hien
            )
            VALUES ($1, $2, $3, $4, $5)
        `,
      [
        data.loai_giao_dich,
        data.so_tien,
        data.mo_ta,
        data.hinh_anh_chung_tu,
        user.id,
      ]
    );

    // 🔔 BÁO CHO BOSS/ADMIN
    const typeText = data.loai_giao_dich === "thu" ? "Khoản thu" : "Khoản chi";
    const icon =
      data.loai_giao_dich === "thu" ? "payment_received" : "system_alert";

    sendNotificationToRoles(
      ["admin", "boss"],
      "Biến động tài chính",
      `${user.ho_ten} vừa tạo ${typeText}: ${Number(
        data.so_tien
      ).toLocaleString()}đ - ${data.mo_ta}`,
      "/phongketoan",
      icon,
      user.ho_ten
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 3. CẬP NHẬT
export async function updateThuChiAction(id: string, data: any) {
  try {
    const user = await requireAuth();
    await sql.unsafe(
      `
            UPDATE "so_cai_tai_chinh"
            SET loai_giao_dich = $1, so_tien = $2, mo_ta = $3, hinh_anh_chung_tu = $4
            WHERE id = $5
        `,
      [
        data.loai_giao_dich,
        data.so_tien,
        data.mo_ta,
        data.hinh_anh_chung_tu,
        id,
      ]
    );

    // 🔔 BÁO CẬP NHẬT
    sendNotificationToRoles(
      ["admin", "boss"],
      "Cập nhật tài chính",
      `${user.ho_ten} đã sửa giao dịch ${data.mo_ta}`,
      "/phongketoan",
      "system_update",
      user.ho_ten
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 4. XÓA
export async function deleteThuChiAction(id: string) {
  try {
    const user = await requireAuth();
    await sql.unsafe(`DELETE FROM "so_cai_tai_chinh" WHERE id = $1`, [id]);

    // 🔔 BÁO XÓA (Quan trọng với tiền nong)
    sendNotificationToRoles(
      ["admin", "boss"],
      "⚠️ Xóa giao dịch",
      `${user.ho_ten} đã xóa một giao dịch tài chính!`,
      "/phongketoan",
      "security_alert",
      user.ho_ten
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}
</file>

<file path="app/actions/QuyenHanSanXuat.ts">
"use server";
import postgres from "postgres";
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";
// 👇 IMPORT MỚI
import { sendNotificationToRoles } from "./NotificationAction";

const sql = postgres(process.env.DATABASE_URL!, { ssl: "require" });

async function requireAuth() {
  const cookieStore = cookies();
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
        set() {},
        remove() {},
      },
    }
  );
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) throw new Error("Unauthorized");
  // Lấy thêm tên để gửi noti
  const [ns] = await sql`SELECT id, ho_ten FROM nhan_su WHERE id = ${user.id}`;
  return ns;
}

// 1. LẤY VIỆC CỦA TÔI (Đã nhận, chưa xong)
export async function getMyTasksAction() {
  try {
    const user = await requireAuth();

    const data = await sql`
            SELECT 
                lsx.id, lsx.ma_lenh, lsx.trang_thai, lsx.tien_do, lsx.bat_dau_luc,
                ct.ten_item_hien_thi, ct.so_luong,
                qt.ten_quy_trinh,
                dh.ma_don, dh.ghi_chu as ghi_chu_don
            FROM "lenh_san_xuat" lsx
            JOIN "don_hang_chi_tiet" ct ON lsx.don_hang_chi_tiet_id = ct.id
            JOIN "don_hang" dh ON ct.don_hang_id = dh.id
            LEFT JOIN "quy_trinh_mau" qt ON lsx.quy_trinh_id = qt.id
            WHERE lsx.nguoi_phu_trach = ${user.id}
            AND lsx.trang_thai != 'hoan_thanh'
            ORDER BY dh.tao_luc ASC
        `;

    return { success: true, data: Array.from(data) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 2. LẤY VIỆC MỚI (Sàn việc - Chưa ai nhận)
export async function getAvailableJobsAction() {
  try {
    await requireAuth();

    // Lấy các lệnh SX mà nguoi_phu_trach là NULL
    const data = await sql`
            SELECT 
                lsx.id, lsx.ma_lenh, lsx.trang_thai,
                ct.ten_item_hien_thi, ct.so_luong,
                qt.ten_quy_trinh,
                dh.ma_don, dh.ghi_chu as ghi_chu_don
            FROM "lenh_san_xuat" lsx
            JOIN "don_hang_chi_tiet" ct ON lsx.don_hang_chi_tiet_id = ct.id
            JOIN "don_hang" dh ON ct.don_hang_id = dh.id
            LEFT JOIN "quy_trinh_mau" qt ON lsx.quy_trinh_id = qt.id
            WHERE lsx.nguoi_phu_trach IS NULL 
            AND lsx.trang_thai = 'moi'
            ORDER BY dh.tao_luc DESC
            LIMIT 50
        `;
    return { success: true, data: Array.from(data) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 3. NHẬN VIỆC (Claim Job)
export async function claimJobAction(jobId: string) {
  try {
    const user = await requireAuth();

    // Update người phụ trách = User đang login
    const result = await sql`
            UPDATE "lenh_san_xuat"
            SET nguoi_phu_trach = ${user.id},
                trang_thai = 'dang_lam',
                bat_dau_luc = NOW()
            WHERE id = ${jobId} 
            AND nguoi_phu_trach IS NULL
            RETURNING ma_lenh
        `;

    if (result.count === 0) {
      return {
        success: false,
        error: "Công việc này đã bị người khác nhận mất rồi!",
      };
    }

    // 🔔 BÁO QUẢN LÝ
    sendNotificationToRoles(
      ["admin", "quanly"],
      "Tiến độ sản xuất",
      `Thợ ${user.ho_ten} đã nhận lệnh sản xuất: ${result[0].ma_lenh}`,
      "/phongsanxuat",
      "workshop_new",
      user.ho_ten
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 4. BẮT ĐẦU LÀM (Start Timer)
export async function startJobAction(jobId: string) {
  try {
    await requireAuth();
    await sql`
            UPDATE "lenh_san_xuat"
            SET trang_thai = 'dang_lam', 
                bat_dau_luc = COALESCE(bat_dau_luc, NOW()), -- Chỉ set nếu chưa có
                cap_nhat_luc = NOW()
            WHERE id = ${jobId}
        `;
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 5. HOÀN THÀNH VIỆC (Finish & Get Paid)
export async function completeJobAction(
  jobId: string,
  resultImage: string,
  note: string
) {
  try {
    const user = await requireAuth();

    // Dùng transaction để đảm bảo tính toàn vẹn
    await sql.begin(async (sql) => {
      // A. Cập nhật Lệnh SX thành hoàn thành
      const [job] = await sql`
                UPDATE "lenh_san_xuat"
                SET trang_thai = 'hoan_thanh',
                    tien_do = 100,
                    ket_thuc_luc = NOW()
                WHERE id = ${jobId}
                RETURNING ma_lenh
            `;

      // B. Ghi nhật ký (Để kích hoạt Trigger tính lương)
      // Lấy thông tin từ lệnh sx để ghi log
      await sql`
                INSERT INTO "nhat_ky_san_xuat" (
                    lenh_san_xuat_id, nhan_su_thuc_hien, 
                    thoi_gian_bat_dau, thoi_gian_ket_thuc,
                    ket_qua, anh_thanh_pham, diem_thuong_nhan_duoc
                )
                SELECT 
                    id, ${user.id}, 
                    bat_dau_luc, NOW(),
                    'dat', ${resultImage}, 10 -- Thưởng mặc định 10 điểm
                FROM "lenh_san_xuat"
                WHERE id = ${jobId}
            `;

      // 🔔 BÁO SALES & ADMIN ĐỂ GIAO HÀNG
      sendNotificationToRoles(
        ["admin", "quanly", "sales"],
        "Sản xuất hoàn tất ✅",
        `${user.ho_ten} đã hoàn thành lệnh ${job.ma_lenh}. Sản phẩm đã sẵn sàng giao!`,
        "/phongsanxuat",
        "artwork_featured",
        user.ho_ten
      );
    });

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 6. LẤY LƯƠNG HÔM NAY (Motivational Metric)
export async function getMySalaryToday() {
  try {
    const user = await requireAuth();
    // Tính tổng lương của tháng hiện tại
    const [res] = await sql`
            SELECT SUM(tong_thu_nhap) as total
            FROM "bang_luong"
            WHERE nhan_su_id = ${user.id}
            AND thang = EXTRACT(MONTH FROM CURRENT_DATE)
            AND nam = EXTRACT(YEAR FROM CURRENT_DATE)
        `;
    return { success: true, total: Number(res?.total || 0) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}
</file>

<file path="app/api/fs/content/route.ts">
import { NextResponse } from 'next/server';
import fs from 'fs';
import path from 'path';

// 🛡️ CHỈ CHO PHÉP CHẠY KHI ĐANG DEV TRÊN MÁY LOCAL
const isDev = process.env.NODE_ENV === 'development';

export async function POST(req: Request) {
    if (!isDev) {
        return NextResponse.json({ error: 'Tính năng này bị vô hiệu hóa trên môi trường mạng.' }, { status: 403 });
    }

    try {
        const { filePath, content } = await req.json();
        
        // 🛡️ Sanitize Path: Chặn việc truy cập ra khỏi thư mục dự án (Directory Traversal)
        if (filePath.includes('..')) {
            return NextResponse.json({ error: 'Đường dẫn không hợp lệ' }, { status: 400 });
        }

        const fullPath = path.join(process.cwd(), filePath);

        if (content !== undefined) {
            fs.writeFileSync(fullPath, content, 'utf-8');
            return NextResponse.json({ success: true });
        } else {
            if (!fs.existsSync(fullPath)) return NextResponse.json({ error: 'File 404' }, { status: 404 });
            const fileContent = fs.readFileSync(fullPath, 'utf-8');
            return NextResponse.json({ content: fileContent });
        }
    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="app/api/fs/manager/route.ts">
import { NextResponse } from 'next/server';
import fs from 'fs';
import path from 'path';

// 🛡️ BẢO MẬT
const isDev = process.env.NODE_ENV === 'development';

export async function POST(req: Request) {
    // 🛑 CHẶN TUYỆT ĐỐI
    if (!isDev) {
        return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }

    try {
        const { action, path: targetPath, newName, type } = await req.json();
        
        // 🛡️ BẢO MẬT PATH
        if (targetPath.includes('..')) return NextResponse.json({ error: 'Invalid path' }, { status: 400 });

        const fullPath = path.join(process.cwd(), targetPath);

        switch (action) {
            case 'create':
                if (type === 'folder') {
                    if (!fs.existsSync(fullPath)) fs.mkdirSync(fullPath, { recursive: true });
                } else {
                    if (!fs.existsSync(fullPath)) fs.writeFileSync(fullPath, '', 'utf-8');
                }
                break;

            case 'rename':
                // 🛡️ Bảo mật tên mới
                if (!newName || newName.includes('/') || newName.includes('\\')) {
                    return NextResponse.json({ error: 'Tên file không hợp lệ' }, { status: 400 });
                }
                const newPath = path.join(path.dirname(fullPath), newName);
                if (fs.existsSync(fullPath)) fs.renameSync(fullPath, newPath);
                break;

            case 'delete':
                if (fs.existsSync(fullPath)) {
                    // 🛡️ CHỐNG XÓA NHẦM FILE HỆ THỐNG
                    if (fullPath === process.cwd()) {
                         return NextResponse.json({ error: 'Không thể xóa root' }, { status: 403 });
                    }
                    fs.rmSync(fullPath, { recursive: true, force: true });
                }
                break;
                
            default:
                return NextResponse.json({ error: 'Hành động không hợp lệ' }, { status: 400 });
        }

        return NextResponse.json({ success: true });
    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="app/api/fs/open/route.ts">
import { NextResponse } from 'next/server';
import { exec } from 'child_process';
import path from 'path';

const isDev = process.env.NODE_ENV === 'development';

export async function POST(req: Request) {
    if (!isDev) return NextResponse.json({ error: 'Forbidden' }, { status: 403 });

    try {
        const { filePath } = await req.json();
        if (filePath.includes('..')) return NextResponse.json({ error: 'Invalid path' }, { status: 400 });
        
        const fullPath = path.join(process.cwd(), filePath); 

        let command = '';
        
        // 🛡️ BẢO MẬT: Chỉ cho phép mở file, không inject lệnh lạ
        // Sử dụng JSON.stringify để escape đường dẫn, tránh injection
        switch (process.platform) {
            case 'win32': 
                command = `explorer /select,${JSON.stringify(fullPath)}`; 
                break;
            case 'darwin': 
                command = `open -R ${JSON.stringify(fullPath)}`;
                break;
            default: 
                command = `xdg-open ${JSON.stringify(path.dirname(fullPath))}`;
        }

        exec(command, (error) => {
            if (error) console.error("Lỗi mở thư mục:", error);
        });

        return NextResponse.json({ success: true });
    } catch (error) {
        return NextResponse.json({ error: 'Lỗi server' }, { status: 500 });
    }
}
</file>

<file path="app/api/sync-users/route.ts">
import { createClient } from '@supabase/supabase-js';
import { NextResponse } from 'next/server';

const supabaseAdmin = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!, 
    {
        auth: {
            autoRefreshToken: false,
            persistSession: false
        }
    }
);

export async function POST(req: Request) {
    try {
        // 🛡️ BẢO MẬT: Kiểm tra Secret Key từ Header
        const authHeader = req.headers.get('x-admin-secret');
        if (authHeader !== process.env.ADMIN_SECRET_KEY) {
             console.warn("⚠️ Truy cập trái phép vào /api/sync-users");
             return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
        }

        console.log("--- BẮT ĐẦU ĐỒNG BỘ USER ---");

        // 1. Lấy danh sách nhân sự
        const { data: employees, error: empError } = await supabaseAdmin
            .from('nhan_su')
            .select('*');

        if (empError) throw new Error("Lỗi lấy dữ liệu nhân sự: " + empError.message);
        if (!employees) throw new Error("Không có dữ liệu nhân sự");

        // 2. Lấy danh sách Users hiện tại từ Auth
        const { data: { users: authUsers }, error: authError } = await supabaseAdmin.auth.admin.listUsers();
        if (authError) throw new Error("Lỗi lấy danh sách Auth Users: " + authError.message);

        let added = 0;
        let updated = 0;
        let deleted = 0;

        // 3. XỬ LÝ: THÊM HOẶC CẬP NHẬT
        for (const emp of employees) {
            if (!emp.email) continue; 

            const existingUser = authUsers.find(u => u.email === emp.email);

            if (!existingUser) {
                // -> Chưa có User -> TẠO MỚI
                const { error: createError } = await supabaseAdmin.auth.admin.createUser({
                    email: emp.email,
                    password: '12345678', 
                    email_confirm: true,
                    user_metadata: { 
                        full_name: emp.ten_hien_thi || emp.ten_day_du || 'Nhân viên',
                        source: 'auto_sync' 
                    }
                });
                
                if (createError) console.error(`Lỗi tạo user ${emp.email}:`, createError.message);
                else added++;

            } else {
                // -> Đã có User -> CẬP NHẬT
                const currentName = existingUser.user_metadata?.full_name;
                const newName = emp.ten_hien_thi || emp.ten_day_du;

                if (newName && currentName !== newName) {
                    await supabaseAdmin.auth.admin.updateUserById(existingUser.id, {
                        user_metadata: { ...existingUser.user_metadata, full_name: newName }
                    });
                    updated++;
                }
            }
        }

        // 4. XỬ LÝ: XÓA
        const empEmails = new Set(employees.map(e => e.email));

        for (const user of authUsers) {
            // Logic an toàn: Không xóa Super Admin (những user có email đặc biệt hoặc id cố định)
            // Ví dụ: Giữ lại admin@local
            if (user.email === 'admin@local') continue;

            if (user.email && !empEmails.has(user.email)) {
                 // Chỉ xóa user được tạo tự động để an toàn
                 if (user.user_metadata?.source === 'auto_sync') {
                    await supabaseAdmin.auth.admin.deleteUser(user.id);
                    deleted++;
                 }
            }
        }

        return NextResponse.json({ 
            success: true, 
            message: "Đồng bộ thành công",
            added, 
            updated, 
            deleted 
        });

    } catch (error: any) {
        console.error(error);
        return NextResponse.json({ success: false, error: error.message }, { status: 500 });
    }
}
</file>

<file path="app/components/cacchucnang/index.ts">
/**
 * ============================================================
 * CÁC CHỨC NĂNG - PHÒNG CHUẨN
 * ============================================================
 *
 * Thư mục chứa tất cả các chức năng dùng chung.
 * Mỗi chức năng nằm trong 1 folder riêng.
 *
 * CẤU TRÚC:
 * cacchucnang/
 * ├── nhansu/          - Quản lý nhân sự
 * ├── khachhang/       - Quản lý khách hàng (TODO)
 * ├── donhang/         - Quản lý đơn hàng (TODO)
 * ├── vattu/           - Quản lý vật tư kho (TODO)
 * └── thuchi/          - Quản lý thu chi (TODO)
 *
 * CÁCH SỬ DỤNG:
 * import { NhanSuChucNang } from '@/app/components/cacchucnang';
 */

// Nhân sự
export {
  NhanSuChucNang,
  createNhanSuConfig,
  type NhanSu,
  type NhanSuPermissions,
} from "./nhansu";

// TODO: Thêm các chức năng khác
// export { KhachHangChucNang } from './khachhang';
// export { DonHangChucNang } from './donhang';
// export { VatTuChucNang } from './vattu';
// export { ThuChiChucNang } from './thuchi';
export { MauThietKeChucNang } from "./mauthietke";
</file>

<file path="app/components/cacchucnang/mauthietke/MauThietKeChucNang.tsx">
"use client";

import React, { useState, useEffect, useMemo, useCallback } from "react";
import { Trash2 } from "lucide-react";
import { KhungDanhSach } from "@/app/components/cacchucnang/KhungGiaoDienChucNang";
import ConfirmDialog from "@/app/components/ConfirmDialog";
import {
  MauThietKe,
  MauThietKePermissions,
  createMauThietKeConfig,
} from "./config";

// IMPORT 3 THÀNH PHẦN ĐÃ TÁCH
import MauThietKeList from "./MauThietKeList";
import MauThietKeForm from "./MauThietKeForm";
import MauThietKeDetail from "./MauThietKeDetail";

interface Props {
  permissions?: MauThietKePermissions;
  className?: string;
}

const toNonAccent = (str: string) =>
  str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "")
    .toLowerCase();

export default function MauThietKeChucNang({
  permissions = {},
  className = "",
}: Props) {
  const config = createMauThietKeConfig(permissions);
  const {
    allowEdit = true,
    allowDelete = false,
    allowBulk = false,
  } = permissions;

  // --- STATE QUẢN LÝ ---
  const [items, setItems] = useState<MauThietKe[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [activeTab, setActiveTab] = useState("all");
  const [sortBy, setSortBy] = useState("newest");

  // View State
  const [viewMode, setViewMode] = useState<"list" | "detail" | "form">("list");
  const [selectedItem, setSelectedItem] = useState<MauThietKe | null>(null);

  // Action State
  const [bulkMode, setBulkMode] = useState(false);
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [confirmDelete, setConfirmDelete] = useState<{
    show: boolean;
    ids: string[];
  }>({ show: false, ids: [] });
  const [saving, setSaving] = useState(false);

  // --- FETCH DATA ---
  const fetchData = useCallback(async () => {
    setLoading(true);
    try {
      if (config.dataSource?.fetchList) {
        const res = await config.dataSource.fetchList(1, 100, "", "");
        if (res.success && res.data) setItems(res.data);
      }
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  }, [config.dataSource]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  // --- FILTER & SORT LOGIC ---
  const filteredList = useMemo(() => {
    let result = items;

    // 1. LOGIC LỌC MỚI (Xử lý tab 'ĐÃ CÓ FILE')
    if (activeTab === "has_file") {
      result = result.filter((i) => {
        // Kiểm tra xem có file thiết kế không (Array hoặc JSON string)
        const files = i.file_thiet_ke;
        if (Array.isArray(files) && files.length > 0) return true;
        if (typeof files === "string") {
          try {
            const parsed = JSON.parse(files);
            return Array.isArray(parsed) && parsed.length > 0;
          } catch {
            return false;
          }
        }
        return false;
      });
    }
    // Lọc theo phân loại thông thường
    else if (activeTab !== "all") {
      result = result.filter((i) => i.phan_loai_normalized === activeTab);
    }

    // Tìm kiếm
    if (searchTerm) {
      const term = toNonAccent(searchTerm);
      result = result.filter((i) => toNonAccent(i.mo_ta).includes(term));
    }

    // Sắp xếp
    const sortOpt = config.sortOptions?.find((s) => s.key === sortBy);
    if (sortOpt?.sortFn) {
      result = [...result].sort(sortOpt.sortFn);
    }
    return result;
  }, [items, activeTab, searchTerm, sortBy, config.sortOptions]);

  const tabs = useMemo(() => {
    const counts: Record<string, number> = { all: items.length };

    config.filterTabs?.forEach((tab) => {
      // 2. LOGIC ĐẾM SỐ LƯỢNG MỚI CHO TAB 'HAS_FILE'
      if (tab.id === "has_file") {
        counts[tab.id] = items.filter((i) => {
          const files = i.file_thiet_ke;
          if (Array.isArray(files) && files.length > 0) return true;
          if (typeof files === "string") {
            try {
              const parsed = JSON.parse(files);
              return Array.isArray(parsed) && parsed.length > 0;
            } catch {
              return false;
            }
          }
          return false;
        }).length;
      }
      // Đếm cho các tab phân loại bình thường
      else if (tab.id && tab.filterField) {
        counts[tab.id] = items.filter(
          (i) => (i as any)[tab.filterField!] === tab.id
        ).length;
      }
    });

    const dynamicTabs =
      config.filterTabs?.map((t) => ({
        id: t.id || "",
        label: t.label,
        count: t.id ? counts[t.id] || 0 : 0,
      })) || [];
    return [{ id: "all", label: "TẤT CẢ", count: counts.all }, ...dynamicTabs];
  }, [items, config.filterTabs]);

  // --- ACTION HANDLERS ---
  const handleOpenDetail = (item: MauThietKe) => {
    setSelectedItem(item);
    setViewMode("detail");
  };

  const handleOpenForm = (item?: MauThietKe) => {
    setSelectedItem(item || null);
    setViewMode("form");
  };

  // --- [UPDATED] LOGIC CHECK KẾT QUẢ TRẢ VỀ TỪ BACKEND ---
  const handleSave = async (formData: any) => {
    setSaving(true);
    try {
      let res; // Biến hứng kết quả

      if (selectedItem?.id) {
        if (config.dataSource?.update) {
          res = await config.dataSource.update(selectedItem.id, formData);
        }
      } else {
        if (config.dataSource?.create) {
          res = await config.dataSource.create(formData);
        }
      }

      // KIỂM TRA: Nếu Backend trả về success: false (do không có quyền sửa, lỗi logic...)
      if (res && !res.success) {
        // Hiện thông báo lỗi và KHÔNG đóng form
        alert(
          res.error || "Thao tác thất bại. Vui lòng kiểm tra lại quyền hạn!"
        );
        return; // Dừng hàm tại đây
      }

      // Nếu thành công -> Tải lại dữ liệu và đóng form
      await fetchData();
      setViewMode("list");
      setSelectedItem(null);
    } catch (e) {
      console.error(e);
      alert("Đã có lỗi hệ thống xảy ra!");
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (ids: string[]) => {
    if (config.dataSource?.delete) {
      // Logic xóa cũng nên có try/catch tương tự nhưng tạm thời giữ nguyên theo code gốc
      // để tránh ảnh hưởng logic delete hàng loạt
      for (const id of ids) await config.dataSource.delete(id);
      await fetchData();
      setSelectedIds(new Set());
      setConfirmDelete({ show: false, ids: [] });
      setViewMode("list");
    }
  };

  const handleBulkSelect = (id: string) => {
    const newSet = new Set(selectedIds);
    if (newSet.has(id)) newSet.delete(id);
    else newSet.add(id);
    setSelectedIds(newSet);
  };

  // --- RENDER ---
  return (
    <div className={`h-full ${className}`}>
      {/* 1. LIST VIEW */}
      {viewMode === "list" && (
        <KhungDanhSach
          tabs={tabs}
          activeTab={activeTab}
          onTabChange={setActiveTab}
          onSearch={setSearchTerm}
          sortOptions={
            config.sortOptions?.map((s) => ({ key: s.key, label: s.label })) ||
            []
          }
          activeSort={sortBy}
          onSortChange={setSortBy}
          showAddButton={allowEdit}
          onAdd={() => handleOpenForm()}
          bulkMode={bulkMode}
          onBulkModeToggle={
            allowBulk ? () => setBulkMode(!bulkMode) : undefined
          }
          selectedCount={selectedIds.size}
          onSelectAll={() =>
            setSelectedIds(new Set(filteredList.map((i) => i.id)))
          }
          onClearSelection={() => setSelectedIds(new Set())}
          bulkActions={
            allowDelete
              ? [
                  {
                    id: "delete",
                    label: "XÓA",
                    icon: Trash2,
                    color: "danger",
                    onClick: () =>
                      setConfirmDelete({
                        show: true,
                        ids: Array.from(selectedIds),
                      }),
                  },
                ]
              : []
          }
          loading={loading}
        >
          <MauThietKeList
            items={filteredList}
            bulkMode={bulkMode}
            selectedIds={selectedIds}
            onToggleSelect={handleBulkSelect}
            onClickItem={handleOpenDetail}
          />
        </KhungDanhSach>
      )}

      {/* 2. FORM VIEW */}
      {viewMode === "form" && (
        <MauThietKeForm
          data={selectedItem}
          onClose={() => {
            setViewMode("list");
            setSelectedItem(null);
          }}
          onSubmit={handleSave}
          loading={saving}
        />
      )}

      {/* 3. DETAIL VIEW */}
      {viewMode === "detail" && selectedItem && (
        <MauThietKeDetail
          data={selectedItem}
          onClose={() => {
            setViewMode("list");
            setSelectedItem(null);
          }}
          allowEdit={allowEdit}
          allowDelete={allowDelete}
          onEdit={() => handleOpenForm(selectedItem)}
          onDelete={() =>
            setConfirmDelete({ show: true, ids: [selectedItem.id] })
          }
        />
      )}

      <ConfirmDialog
        isOpen={confirmDelete.show}
        title="XÁC NHẬN XÓA"
        message={`Bạn có chắc muốn xóa ${confirmDelete.ids.length} mẫu thiết kế?`}
        onConfirm={() => handleDelete(confirmDelete.ids)}
        onCancel={() => setConfirmDelete({ show: false, ids: [] })}
      />
    </div>
  );
}
</file>

<file path="app/components/cacchucnang/mauthietke/MauThietKeDetail.tsx">
"use client";

import React, { useState } from "react";
import {
  Tag,
  User,
  Calendar,
  Link as LinkIcon,
  Palette,
  ExternalLink,
  Clock,
} from "lucide-react";
import { KhungChiTiet } from "@/app/components/cacchucnang/KhungGiaoDienChucNang";
import { MauThietKe, createMauThietKeConfig } from "./config";

interface Props {
  data: MauThietKe;
  onClose: () => void;
  allowEdit: boolean;
  allowDelete: boolean;
  onEdit: () => void;
  onDelete: () => void;
}

// Interface mở rộng để hứng các trường mới từ backend
interface FileItem {
  ten: string;
  url: string;
  nguoi_dang?: string; // Tên người upload
  last_modified?: string; // Thời gian upload
}

export default function MauThietKeDetail({
  data,
  onClose,
  allowEdit,
  allowDelete,
  onEdit,
  onDelete,
}: Props) {
  const config = createMauThietKeConfig();
  const [activeTab, setActiveTab] = useState("thongtin");
  const tabs = config.detailTabs.map((t) => ({ ...t, id: t.id || "" }));

  const item = data as any;

  // Helper format thời gian ngắn gọn (VD: 14:30 25/12)
  const formatTime = (isoString?: string) => {
    if (!isoString) return "";
    const date = new Date(isoString);
    return date.toLocaleString("vi-VN", {
      hour: "2-digit",
      minute: "2-digit",
      day: "2-digit",
      month: "2-digit",
      year: "numeric", // Có thể bỏ year nếu muốn gọn hơn
    });
  };

  const getFileNameFromUrl = (url: string) => {
    try {
      return decodeURIComponent(url).split("?")[0].split("/").pop() || url;
    } catch {
      return url;
    }
  };

  const getDesignFiles = (): FileItem[] => {
    if (!item || !item.file_thiet_ke) return [];
    let parsed: any[] = [];
    const rawData = item.file_thiet_ke;

    try {
      if (Array.isArray(rawData)) parsed = rawData;
      else if (typeof rawData === "string" && rawData.trim()) {
        const result = JSON.parse(rawData);
        if (Array.isArray(result)) parsed = result;
      }
    } catch {
      return [];
    }

    return parsed
      .map((entry: any) => {
        // Data cũ (String)
        if (typeof entry === "string") {
          return { ten: getFileNameFromUrl(entry), url: entry };
        }
        // Data mới (Object)
        if (typeof entry === "object" && entry !== null) {
          return {
            ten:
              entry.ten ||
              getFileNameFromUrl(entry.url || "") ||
              "File đính kèm",
            url: entry.url || "",
            nguoi_dang: entry.nguoi_dang,
            last_modified: entry.last_modified,
          };
        }
        return null;
      })
      .filter((f): f is FileItem => f !== null && f.url.trim() !== "");
  };

  const designFiles = getDesignFiles();

  return (
    <KhungChiTiet
      data={data}
      onClose={onClose}
      avatar={item.hinh_anh}
      title={item.ten || item.mo_ta || "Chi tiết mẫu"}
      tabs={tabs}
      activeTab={activeTab}
      onTabChange={setActiveTab}
      showEditButton={allowEdit}
      showDeleteButton={allowDelete}
      onEdit={onEdit}
      onDelete={onDelete}
    >
      <div className="p-4 space-y-4">
        {/* HÌNH ẢNH */}
        <div className="aspect-video w-full rounded-xl overflow-hidden bg-[#1a1a1a] border border-white/10 relative group">
          {item.hinh_anh ? (
            <img
              src={item.hinh_anh}
              alt=""
              className="w-full h-full object-contain"
            />
          ) : (
            <div className="w-full h-full flex items-center justify-center text-white/20">
              <Palette size={48} />
            </div>
          )}
        </div>

        {/* DANH SÁCH FILE - GIAO DIỆN MỚI */}
        {designFiles.length > 0 ? (
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <label className="text-[10px] text-white/40 font-bold uppercase">
                File Thiết Kế Gốc ({designFiles.length})
              </label>
            </div>

            <div className="grid gap-2">
              {designFiles.map((file, idx) => (
                <a
                  key={idx}
                  href={file.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="group flex items-center gap-3 p-3 bg-[#151515] hover:bg-[#C69C6D] border border-white/10 hover:border-[#C69C6D] rounded-lg transition-all relative overflow-hidden"
                  title={file.url}
                >
                  {/* Icon File */}
                  <div className="w-10 h-10 rounded bg-black/20 flex items-center justify-center text-[#C69C6D] group-hover:text-black shrink-0">
                    <LinkIcon size={18} />
                  </div>

                  {/* Thông tin chính */}
                  <div className="flex-1 overflow-hidden">
                    {/* Tên File */}
                    <div className="flex items-center gap-2">
                      <p className="text-sm font-bold text-[#C69C6D] group-hover:text-black truncate">
                        {file.ten}
                      </p>
                    </div>

                    {/* Metadata: Người đăng - Thời gian */}
                    <div className="flex items-center gap-2 mt-0.5 text-[10px] text-white/40 group-hover:text-black/70 font-mono">
                      {file.nguoi_dang && (
                        <span className="flex items-center gap-1">
                          <User size={10} /> {file.nguoi_dang}
                        </span>
                      )}

                      {file.nguoi_dang && file.last_modified && <span>•</span>}

                      {file.last_modified && (
                        <span className="flex items-center gap-1">
                          <Clock size={10} /> {formatTime(file.last_modified)}
                        </span>
                      )}
                    </div>
                  </div>

                  <ExternalLink
                    size={14}
                    className="text-white/20 group-hover:text-black/40"
                  />
                </a>
              ))}
            </div>
          </div>
        ) : (
          <div className="p-3 rounded-lg border border-dashed border-white/10 flex items-center justify-center gap-2 text-white/20">
            <LinkIcon size={14} />
            <span className="text-xs italic">Chưa có file thiết kế nào</span>
          </div>
        )}

        {/* THÔNG TIN KHÁC */}
        <div className="grid gap-3 pt-2 border-t border-white/5">
          <DetailRow
            icon={<Tag size={18} />}
            label="Phân loại"
            value={item.phan_loai}
          />
          <DetailRow
            icon={<User size={18} />}
            label="Người tạo mẫu"
            value={item.ten_nguoi_tao}
          />
          <DetailRow
            icon={<Calendar size={18} />}
            label="Ngày tạo mẫu"
            value={
              item.tao_luc || item.created_at
                ? new Date(item.tao_luc || item.created_at).toLocaleDateString(
                    "vi-VN"
                  )
                : "---"
            }
          />
        </div>
      </div>
    </KhungChiTiet>
  );
}

function DetailRow({
  icon,
  label,
  value,
}: {
  icon: any;
  label: string;
  value: string;
}) {
  return (
    <div className="p-3 bg-[#151515] rounded-xl border border-white/5 flex items-center gap-3">
      <div className="text-[#C69C6D]">{icon}</div>
      <div>
        <p className="text-[10px] text-white/40 font-bold uppercase">{label}</p>
        <p className="text-white text-sm">{value || "---"}</p>
      </div>
    </div>
  );
}
</file>

<file path="app/components/cacchucnang/mauthietke/MauThietKeForm.tsx">
"use client";

import React, { useState } from "react";
import { Plus, Link as LinkIcon, Trash2, Type } from "lucide-react";
import { KhungForm } from "@/app/components/cacchucnang/KhungGiaoDienChucNang";
import { MauThietKe, createMauThietKeConfig } from "./config";

interface Props {
  data: MauThietKe | null; // null = Tạo mới
  onClose: () => void;
  onSubmit: (formData: any) => Promise<void>;
  loading: boolean;
}

// 1. Định nghĩa kiểu dữ liệu cho file thiết kế
interface FileItem {
  ten: string;
  url: string;
}

// 2. Định nghĩa kiểu State cho Form (Tránh xung đột Type)
interface FormState extends Omit<Partial<MauThietKe>, "file_thiet_ke"> {
  file_thiet_ke: FileItem[];
}

export default function MauThietKeForm({
  data,
  onClose,
  onSubmit,
  loading,
}: Props) {
  const config = createMauThietKeConfig();

  // 3. Khởi tạo state
  const [formData, setFormData] = useState<FormState>(() => {
    let files: FileItem[] = [];

    // Logic parse dữ liệu cũ
    if (data && (data as any).file_thiet_ke) {
      try {
        const raw = (data as any).file_thiet_ke;
        let parsed: any[] = [];

        if (Array.isArray(raw)) {
          parsed = raw;
        } else if (typeof raw === "string") {
          parsed = JSON.parse(raw);
        }

        // Convert sang chuẩn { ten, url }
        files = parsed.map((item: any) => {
          if (typeof item === "string") return { ten: "", url: item };
          if (typeof item === "object")
            return { ten: item.ten || "", url: item.url || "" };
          return { ten: "", url: "" };
        });
      } catch {}
    }

    return data ? { ...data, file_thiet_ke: files } : { file_thiet_ke: [] };
  });

  // --- HANDLERS ---

  const handleChange = (field: keyof FormState, value: any) => {
    setFormData((prev) => ({ ...prev, [field]: value }));
  };

  const handleFileChange = (
    index: number,
    field: keyof FileItem,
    value: string
  ) => {
    const newFiles = [...formData.file_thiet_ke];
    if (!newFiles[index]) return;
    newFiles[index] = { ...newFiles[index], [field]: value };
    setFormData((prev) => ({ ...prev, file_thiet_ke: newFiles }));
  };

  const addFileRow = () => {
    setFormData((prev) => ({
      ...prev,
      file_thiet_ke: [...prev.file_thiet_ke, { ten: "", url: "" }],
    }));
  };

  const removeFileRow = (index: number) => {
    const newFiles = [...formData.file_thiet_ke];
    newFiles.splice(index, 1);
    setFormData((prev) => ({ ...prev, file_thiet_ke: newFiles }));
  };

  const handleSubmit = async () => {
    // 1. Validate thông tin chung
    if (!formData.mo_ta?.trim()) {
      alert("Vui lòng nhập Tên mẫu thiết kế!");
      return;
    }
    if (!formData.phan_loai) {
      alert("Vui lòng chọn Phân loại!");
      return;
    }

    // 2. Validate file
    const validFiles = formData.file_thiet_ke.filter(
      (f) => f.ten.trim() !== "" || f.url.trim() !== ""
    );
    const hasError = validFiles.some(
      (f) => f.ten.trim() === "" || f.url.trim() === ""
    );

    if (hasError) {
      alert(
        "Vui lòng nhập đầy đủ TÊN HIỂN THỊ và ĐƯỜNG DẪN cho file thiết kế!"
      );
      return;
    }

    // 3. Submit (GỬI MẢNG TRỰC TIẾP - Backend sẽ tự lo Stringify)
    // 🟢 SỬA: Không JSON.stringify ở đây nữa
    const finalData = {
      ...formData,
      file_thiet_ke: validFiles,
    };

    await onSubmit(finalData);
  };

  return (
    <KhungForm
      onClose={onClose}
      title={data ? "SỬA MẪU" : "THÊM MẪU MỚI"}
      onSubmit={handleSubmit}
      loading={loading}
      isDirty={true}
      showAvatarUpload={true}
      uploadBucket="images"
      avatar={formData.hinh_anh}
      onUploadComplete={(url: string) => handleChange("hinh_anh", url)}
    >
      <div className="space-y-4">
        {/* Tên mẫu */}
        <div>
          <label className="text-xs font-bold text-white/60 mb-2 block uppercase">
            Tên mẫu thiết kế <span className="text-red-500">*</span>
          </label>
          <input
            className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:border-[#C69C6D] outline-none placeholder-white/20"
            value={formData.mo_ta || ""}
            onChange={(e) => handleChange("mo_ta", e.target.value)}
            placeholder="Nhập tên mẫu..."
          />
        </div>

        {/* Phân loại */}
        <div>
          <label className="text-xs font-bold text-white/60 mb-2 block uppercase">
            Phân loại <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <select
              className="w-full bg-[#1a1a1a] text-white border border-white/10 rounded-lg px-4 py-3 focus:border-[#C69C6D] outline-none appearance-none"
              value={formData.phan_loai || ""}
              onChange={(e) => handleChange("phan_loai", e.target.value)}
            >
              <option value="" className="bg-[#1a1a1a] text-gray-500">
                -- Chọn loại --
              </option>
              {config.fields
                .find((f) => f.key === "phan_loai")
                ?.options?.map((opt: any) => (
                  <option
                    key={opt}
                    value={opt}
                    className="bg-[#1a1a1a] text-white py-2"
                  >
                    {opt}
                  </option>
                ))}
            </select>
            <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-white/50 text-xs">
              ▼
            </div>
          </div>
        </div>

        {/* File Thiết Kế */}
        <div>
          <div className="flex items-center justify-between mb-2">
            <label className="text-xs font-bold text-white/60 uppercase">
              File Thiết Kế (Google Drive)
            </label>
            <button
              type="button"
              onClick={addFileRow}
              className="flex items-center gap-1 text-[10px] bg-[#C69C6D]/20 text-[#C69C6D] hover:bg-[#C69C6D] hover:text-black px-2 py-1 rounded transition-all font-bold"
            >
              <Plus size={12} /> THÊM FILE
            </button>
          </div>

          <div className="space-y-2">
            {formData.file_thiet_ke.map((file, idx) => (
              <div key={idx} className="flex gap-2 items-start">
                {/* Tên */}
                <div className="w-1/3 relative group">
                  <div className="absolute left-3 top-1/2 -translate-y-1/2 text-white/30">
                    <Type size={14} />
                  </div>
                  <input
                    className={`w-full bg-white/5 border rounded-lg pl-9 pr-3 py-2.5 text-white text-xs outline-none placeholder-white/20 transition-all ${
                      file.ten.trim() === "" && file.url.trim() !== ""
                        ? "border-red-500/50 focus:border-red-500"
                        : "border-white/10 focus:border-[#C69C6D]"
                    }`}
                    placeholder="Tên hiển thị..."
                    value={file.ten}
                    onChange={(e) =>
                      handleFileChange(idx, "ten", e.target.value)
                    }
                  />
                </div>
                {/* Link */}
                <div className="flex-1 relative group">
                  <div className="absolute left-3 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-[#C69C6D] transition-colors">
                    <LinkIcon size={14} />
                  </div>
                  <input
                    className={`
                        w-full bg-white/5 border rounded-lg pl-9 pr-4 py-2.5 text-white text-xs outline-none placeholder-white/20 transition-all
                        ${
                          file.url.trim() === "" && file.ten.trim() !== ""
                            ? "border-red-500/50 focus:border-red-500"
                            : "border-white/10 focus:border-[#C69C6D]"
                        }
                    `}
                    value={file.url}
                    onChange={(e) =>
                      handleFileChange(idx, "url", e.target.value)
                    }
                    placeholder="Dán link Google Drive..."
                  />
                </div>
                {/* Xóa */}
                <button
                  type="button"
                  onClick={() => removeFileRow(idx)}
                  className="p-2 text-white/20 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-colors shrink-0 mt-[2px]"
                >
                  <Trash2 size={16} />
                </button>
              </div>
            ))}

            {formData.file_thiet_ke.length === 0 && (
              <div
                onClick={addFileRow}
                className="text-[10px] text-white/20 italic text-center py-3 border border-dashed border-white/10 rounded-lg cursor-pointer hover:border-white/30 transition-colors"
              >
                Chưa có file nào. Nhấn để thêm.
              </div>
            )}
          </div>
        </div>
      </div>
    </KhungForm>
  );
}
</file>

<file path="app/components/StaffPresence.tsx">
"use client";
import { useEffect } from "react";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { useUser } from "@/app/ThuVien/UserContext";

export default function StaffPresence() {
  const { user } = useUser();

  useEffect(() => {
    // Chỉ chạy nếu là nhân sự
    if (!user || user.userType !== "nhan_su") return;

    // Xác định role chuẩn để gửi đi
    // Ưu tiên vi_tri_normalized, nếu không có thì lấy role từ context
    const roleToSend =
      (user as any).vi_tri_normalized || user.role || "nhan_su";

    // Tạo kênh 'online-users'
    const channel = supabase.channel("online-users", {
      config: {
        presence: {
          key: user.id, // ID định danh duy nhất
        },
      },
    });

    channel
      .on("presence", { event: "sync" }, () => {
        // Debug chơi thôi
        // console.log('📡 Staff signal sent:', user.ho_ten);
      })
      .subscribe(async (status) => {
        if (status === "SUBSCRIBED") {
          // Gửi thông tin nhân viên lên kênh
          await channel.track({
            id: user.id,
            name: user.ho_ten,
            role: roleToSend, // Quan trọng: Gửi role chuẩn để bên kia lọc
            online_at: new Date().toISOString(),
          });
        }
      });

    return () => {
      supabase.removeChannel(channel);
    };
  }, [user]);

  return null;
}
</file>

<file path="app/components/ThanhPhongChucNang.tsx">
"use client";
import React, { useState } from "react";
import { Check, List } from "lucide-react";

interface FunctionItem {
  id: string;
  label: string;
  icon: React.ElementType;
}

interface Props {
  tenPhong: string;
  functions: FunctionItem[];
  activeFunction: string;
  onFunctionChange: (id: string) => void;
}

export default function ThanhPhongChucNang({
  tenPhong,
  functions,
  activeFunction,
  onFunctionChange,
}: Props) {
  const [showDropdown, setShowDropdown] = useState(false);

  // Tìm chức năng đang được chọn
  const activeItem = functions.find((f) => f.id === activeFunction);

  return (
    // justify-between: Đẩy Tên Phòng sang trái, Chức Năng sang phải
    <div className="flex-none z-30 w-full h-[50px] bg-[#080808] border-b border-[#C69C6D]/20 shadow-md flex items-center justify-between px-4 md:px-6">
      {/* 1. TÊN PHÒNG (BÊN TRÁI - Canh sát lề trái) */}
      <div className="shrink-0 bg-gradient-to-r from-[#C69C6D] to-[#B58B5D] text-black px-4 py-1.5 rounded-l-md rounded-r-xl transform skew-x-[-10deg] shadow-[0_0_15px_rgba(198,156,109,0.3)]">
        <h1 className="text-xs md:text-sm font-black uppercase tracking-[0.15em] skew-x-[10deg] whitespace-nowrap">
          {tenPhong}
        </h1>
      </div>

      {/* 2. TRÌNH CHỌN CHỨC NĂNG (BÊN PHẢI - Canh sát lề phải) */}
      <div className="relative flex items-center">
        <button
          onClick={() => setShowDropdown(!showDropdown)}
          className="flex items-center gap-3 group outline-none text-right"
        >
          {/* Tên chức năng - Chữ to, không viền */}
          <span className="text-[#C69C6D] font-black text-base md:text-lg uppercase tracking-wide truncate max-w-[180px] sm:max-w-xs">
            {activeItem?.label}
          </span>

          {/* Nút danh sách (Icon) - Cùng màu vàng */}
          <List
            size={24}
            strokeWidth={2.5}
            className={`transition-transform duration-300 ${
              showDropdown
                ? "rotate-90 text-white"
                : "text-[#C69C6D] group-hover:text-white"
            }`}
          />
        </button>

        {/* MENU XỔ XUỐNG - Căn phải (right-0) */}
        {showDropdown && (
          <>
            <div
              className="fixed inset-0 z-40"
              onClick={() => setShowDropdown(false)}
            />

            <div className="absolute top-full right-0 mt-3 w-[240px] bg-[#1a1a1a] rounded-lg shadow-[0_20px_50px_rgba(0,0,0,0.9)] overflow-hidden z-50 animate-in fade-in slide-in-from-top-2 py-2 border border-white/5">
              {functions.map((func) => {
                const Icon = func.icon;
                const isActive = func.id === activeFunction;
                return (
                  <button
                    key={func.id}
                    onClick={() => {
                      onFunctionChange(func.id);
                      setShowDropdown(false);
                    }}
                    className={`
                                            w-full flex items-center justify-end gap-3 px-4 py-3 text-xs font-bold uppercase tracking-wide transition-all text-right
                                            ${
                                              isActive
                                                ? "bg-[#C69C6D] text-black"
                                                : "text-white/60 hover:bg-white/5 hover:text-white hover:pr-6"
                                            }
                                        `}
                  >
                    <span className="flex-1 truncate">{func.label}</span>
                    <Icon size={16} strokeWidth={isActive ? 2.5 : 2} />
                    {isActive && (
                      <Check
                        size={14}
                        strokeWidth={3}
                        className="shrink-0 order-first"
                      />
                    )}
                  </button>
                );
              })}
            </div>
          </>
        )}
      </div>
    </div>
  );
}
</file>

<file path="app/CongDangNhap/page.tsx">
'use client';

import React from 'react';
import CongDangNhap from './CongDangNhap';

/**
 * 🔐 TRANG CỔNG ĐĂNG NHẬP
 * Route: /CongDangNhap
 * 
 * Sử dụng component CongDangNhap đã tối ưu giao diện
 * với đầy đủ tính năng: remember me, fullscreen, redirect đúng phòng
 */
export default function TrangCongDangNhap() {
  return <CongDangNhap isGateKeeper={true} />;
}
</file>

<file path="app/CongDangNhap/RoleRedirectService.ts">
import { supabase } from '@/app/ThuVien/ketNoiSupabase';

// Hàm chuẩn hóa chuỗi
const normalizeString = (str: string | null | undefined): string => {
    if (!str) return '';
    return str
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .replace(/[^a-z0-9]/g, "")
        .trim();
};

// 🟢 CẤU HÌNH DỰ PHÒNG (Khớp 100% với file CSV routing_permissions)
// Giúp hệ thống vẫn chạy ngon kể cả khi Database bị chặn quyền đọc
const FALLBACK_ROUTES: Record<string, string> = {
    // Nhóm Quản Trị
    'admin': '/phongadmin',
    'boss': '/phongadmin',
    'quanly': '/phongquanly',
    
    // Nhóm Nghiệp Vụ
    'sales': '/phongsales',
    'ketoan': '/phongketoan',   // ✅ Mới: Kế toán
    'thukho': '/phongkho',      // ✅ Mới: Thủ kho
    
    // Nhóm Sản Xuất
    'congtacvien': '/phongctv',
    'ctv': '/phongctv',
    'parttime': '/phongparttime',
    'thosanxuat': '/phongtho',
    'tho': '/phongtho',
    'kythuat': '/phongtho',
    'thietke': '/phongthietke',
    
    // Nhóm Khách hàng
    'vip': '/trangchu',
    'doitac': '/trangchu',
    'moi': '/trangchu',
    'damuahang': '/trangchu',
    'khtrongtam': '/trangchu',
    'khach': '/trangchu'
};

const FALLBACK_ALLOWED_ROUTES: Record<string, string[]> = {
    // Admin & Boss: Full quyền
    'admin': ['/phongadmin', '/phongquanly', '/phongkho', '/phongketoan', '/phongsales', '/phongparttime', '/phongctv', '/phongthietke', '/dashboard', '/settings'],
    'boss': ['/phongadmin', '/phongquanly', '/phongkho', '/phongketoan', '/phongsales', '/phongparttime', '/phongctv', '/phongthietke', '/dashboard', '/settings'],
    
    // Quản lý: Được xem Kho, Kế toán để duyệt
    'quanly': ['/phongquanly', '/phongkho', '/phongketoan', '/dashboard'],
    
    // Nghiệp vụ cụ thể
    'sales': ['/phongsales', '/dathang', '/phongkho'], // ✅ Sales được xem kho để báo khách
    'ketoan': ['/phongketoan', '/dashboard'],          // ✅ Mới
    'thukho': ['/phongkho', '/dashboard'],             // ✅ Mới
    
    // Sản xuất
    'parttime': ['/phongparttime'],
    'thosanxuat': ['/phongtho'],
    'congtacvien': ['/phongctv'],
    'thietke': ['/phongthietke'],
    
    // Khách hàng
    'khach': ['/trangchu', '/dathang', '/giohang']
};

export class RoleRedirectService {

    // ============================================================
    // 1. LOGIC ĐIỀU HƯỚNG (ƯU TIÊN DB -> DỰ PHÒNG SAU)
    // ============================================================

    static async getRedirectUrl(
        userType: string, 
        roleNormalized: string
    ): Promise<string> {
        try {
            const p_role = normalizeString(roleNormalized);

            // 1. Thử đọc từ Database
            const { data, error } = await supabase
                .from('routing_permissions')
                .select('default_route')
                .eq('user_type', userType)
                .eq('role_normalized', p_role)
                .maybeSingle();

            if (!error && data && data.default_route) {
                return data.default_route;
            }

            // 2. Nếu lỗi hoặc không tìm thấy -> Dùng chế độ DỰ PHÒNG
            // Điều này phá vỡ vòng lặp vô tận khi DB bị lỗi
            if (FALLBACK_ROUTES[p_role]) {
                console.log(`⚠️ Dùng Fallback Route cho ${p_role}: ${FALLBACK_ROUTES[p_role]}`);
                return FALLBACK_ROUTES[p_role];
            }

            // 3. Đường cùng (Mặc định an toàn để không về trang chủ nếu là nhân sự)
            return userType === 'nhan_su' ? '/phongparttime' : '/trangchu';

        } catch (err) {
            console.error('RoleRedirectService Error:', err);
            return '/';
        }
    }

    // ============================================================
    // 2. CHECK QUYỀN TRUY CẬP (DB -> DỰ PHÒNG)
    // ============================================================

    static async isRouteAllowed(
        userType: string, 
        roleNormalized: string, 
        route: string
    ): Promise<boolean> {
        try {
            const p_role = normalizeString(roleNormalized);
            const cleanRoute = route.split('?')[0];

            // Admin luôn được đi mọi nơi
            if (p_role === 'admin' || p_role === 'boss') return true;

            // 1. Thử đọc DB
            const { data, error } = await supabase
                .from('routing_permissions')
                .select('allowed_routes')
                .eq('user_type', userType)
                .eq('role_normalized', p_role)
                .maybeSingle();

            let allowedRoutes: string[] = [];

            if (!error && data && data.allowed_routes) {
                if (Array.isArray(data.allowed_routes)) {
                    allowedRoutes = data.allowed_routes;
                } else if (typeof data.allowed_routes === 'string') {
                    try { allowedRoutes = JSON.parse(data.allowed_routes); } catch {}
                }
            } else {
                // 2. Dùng Dự phòng
                allowedRoutes = FALLBACK_ALLOWED_ROUTES[p_role] || FALLBACK_ALLOWED_ROUTES['khach'];
            }

            // Logic khớp route
            const isAllowed = allowedRoutes.some((r: string) => {
                return cleanRoute === r || cleanRoute.startsWith(r + '/');
            });

            return isAllowed;

        } catch (err) {
            console.error('Permission Check Error:', err);
            return false;
        }
    }

    // ============================================================
    // 3. UI HELPERS (Giữ nguyên)
    // ============================================================

    static isHRAdmin(viTriNormalized: string | null | undefined): boolean {
        if (!viTriNormalized) return false;
        const role = normalizeString(viTriNormalized);
        return ['admin', 'quanly', 'boss', 'sep', 'manager'].includes(role);
    }

    static getModalIdFromPosition(viTriNormalized: string | null | undefined): string | null {
        if (!viTriNormalized) return null;
        const role = normalizeString(viTriNormalized);
        
        const map: Record<string, string> = {
            'admin': 'admin',
            'quanly': 'quanly',
            'boss': 'quanly',
            'sales': 'sales',
            'ketoan': 'ketoan', // ✅ Mới
            'thukho': 'thukho', // ✅ Mới
            'thosanxuat': 'tho',
            'tho': 'tho',
            'kythuat': 'tho',
            'thietke': 'thietke',
            'parttime': 'parttime',
            'thoivu': 'parttime',
            'congtacvien': 'ctv',
            'ctv': 'ctv',
            'khtrongtam': 'trungbay',
            'vip': 'trungbay'
        };
        
        return map[role] || null;
    }

    static getModalDisplayName(viTriNormalized: string | null | undefined): string | null {
        if (!viTriNormalized) return null;
        const role = normalizeString(viTriNormalized);
        
        const map: Record<string, string> = {
            'admin': 'Phòng Admin',
            'quanly': 'Phòng Quản Lý',
            'sales': 'Phòng Sales',
            'ketoan': 'Phòng Kế Toán', // ✅ Mới
            'thukho': 'Kho Tổng',      // ✅ Mới
            'thosanxuat': 'Phòng Thợ',
            'thietke': 'Phòng Thiết Kế',
            'parttime': 'Phòng Part-time',
            'congtacvien': 'Phòng CTV',
            'khtrongtam': 'Phòng Trưng Bày',
            'vip': 'Phòng VIP'
        };
        
        if (!map[role]) {
            return `Phòng ${role.charAt(0).toUpperCase() + role.slice(1)}`;
        }

        return map[role];
    }
}

// Export lẻ
export const getRedirectUrl = RoleRedirectService.getRedirectUrl;
export const isRouteAllowed = RoleRedirectService.isRouteAllowed;
export const isHRAdmin = RoleRedirectService.isHRAdmin;
export const getModalIdFromPosition = RoleRedirectService.getModalIdFromPosition;
export const getModalDisplayName = RoleRedirectService.getModalDisplayName;
</file>

<file path="app/dathang/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { supabase } from '@/app/ThuVien/ketNoiSupabase';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import { useUser } from '@/app/ThuVien/UserContext';
import { Search, ShoppingCart, Filter, Loader2 } from 'lucide-react';

export default function TrangDatHang() {
  const { user } = useUser();
  const [products, setProducts] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('all');

  useEffect(() => {
    const fetchProducts = async () => {
      // Lấy dữ liệu từ bảng VAT_TU (đã seed)
      const { data } = await supabase
        .from('vat_tu')
        .select('*')
        .eq('loai_vat_tu', 'thanh_pham')
        .order('gia_ban', { ascending: true });
      
      if (data) setProducts(data);
      setLoading(false);
    };
    fetchProducts();
  }, []);

  const handleOrder = async (product: any) => {
    if (!user) {
        alert("Vui lòng đăng nhập để đặt hàng!");
        return;
    }
    const confirmMsg = `Xác nhận đặt tác phẩm: ${product.ten_vat_tu}\nGiá: ${product.gia_ban.toLocaleString()} VNĐ?`;
    if (!confirm(confirmMsg)) return;

    // Gọi API tạo đơn hàng (đã có trigger trừ kho)
    const { error } = await supabase.from('don_hang_chi_tiet').insert({
        don_hang_id: null, // Tạo đơn nháp (hoặc logic tạo đơn mới) - Ở đây demo
        vat_tu_id: product.id,
        so_luong: 1,
        don_gia: product.gia_ban,
        ten_item_hien_thi: product.ten_vat_tu
    });
    
    // Vì logic tạo đơn phức tạp cần Header đơn hàng, ở đây ta giả lập báo thành công
    // Thực tế nên dùng OrderService.createOrder
    alert("Đã gửi yêu cầu đặt hàng! Nhân viên sẽ liên hệ bạn sớm.");
  };

  return (
    <KhungTrangChuan nguoiDung={user} loiChao="BỘ SƯU TẬP TÁC PHẨM">
      <div className="max-w-6xl mx-auto px-4 pb-20">
        
        {/* Bộ lọc */}
        <div className="flex gap-2 overflow-x-auto pb-4 mb-6 scrollbar-hide">
             {['all', 'Xuân', 'Hạ', 'Thu', 'Đông'].map(bg => (
                 <button 
                    key={bg}
                    onClick={() => setFilter(bg)}
                    className={`px-4 py-2 rounded-full text-xs font-bold uppercase border transition-all whitespace-nowrap
                    ${filter === bg ? 'bg-[#C69C6D] text-black border-[#C69C6D]' : 'bg-white/5 border-white/10 text-white hover:border-white'}`}
                 >
                    {bg === 'all' ? 'Tất cả' : `BST ${bg}`}
                 </button>
             ))}
        </div>

        {/* Grid Sản phẩm */}
        {loading ? (
            <div className="flex justify-center py-20"><Loader2 className="animate-spin text-[#C69C6D]"/></div>
        ) : (
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {products
                .filter(p => filter === 'all' || p.bo_suu_tap === filter)
                .map((p) => (
                <div key={p.id} className="bg-[#111] border border-white/10 rounded-2xl overflow-hidden group hover:border-[#C69C6D]/50 transition-all">
                    <div className="aspect-square relative overflow-hidden">
                        <img src={p.hinh_anh} alt={p.ten_vat_tu} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"/>
                        <div className="absolute top-2 right-2 bg-black/60 backdrop-blur px-2 py-1 rounded text-[10px] text-[#C69C6D] font-bold border border-[#C69C6D]/30">
                            BST {p.bo_suu_tap}
                        </div>
                    </div>
                    <div className="p-4">
                        <h3 className="text-white font-serif text-lg font-bold truncate">{p.ten_vat_tu}</h3>
                        <div className="flex items-center justify-between mt-2">
                            <span className="text-[#C69C6D] font-bold">
                                {p.gia_ban.toLocaleString()} ₫
                            </span>
                            <button 
                                onClick={() => handleOrder(p)}
                                className="p-2 bg-white text-black rounded-full hover:bg-[#C69C6D] transition-colors"
                            >
                                <ShoppingCart size={18} />
                            </button>
                        </div>
                        <p className="text-gray-500 text-xs mt-2">Còn lại: {p.ton_kho} tác phẩm</p>
                    </div>
                </div>
            ))}
            </div>
        )}
      </div>
    </KhungTrangChuan>
  );
}
</file>

<file path="app/GiaoDienTong/MenuSystemWrapper.tsx">
"use client";

import React from "react";

interface MenuSystemWrapperProps {
  currentUser?: any;
  onToggleContent?: (isOpen: boolean) => void;
  onlyAccountButton?: boolean;
}

/**
 * 🎨 Reusable Menu System Wrapper
 * Packages gradient overlays + MenuDuoi for consistent styling across all pages
 * Usage: <MenuSystemWrapper currentUser={user} onlyAccountButton={true} />
 */
export default function MenuSystemWrapper({
  currentUser,
  onToggleContent,
  onlyAccountButton,
}: MenuSystemWrapperProps) {
  return (
    <>
      {/* GRADIENT BẢO VỆ MENU - Bottom */}
      <div className="fixed bottom-0 left-0 right-0 h-28 bg-gradient-to-t from-black to-transparent z-[4900] pointer-events-none"></div>
    </>
  );
}
</file>

<file path="app/GiaoDienTong/MenuTren/NotificationService.ts">
import { Notification, NotificationType } from "./NotificationTypes";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { RealtimeChannel } from "@supabase/supabase-js";

export class NotificationService {
  // ... (Giữ nguyên các hàm getUserNotifications, getUnreadCount, create, markRead, delete...)

  static async getUserNotifications(
    userId: string,
    limit = 50
  ): Promise<Notification[]> {
    try {
      const { data, error } = await supabase
        .from("notifications")
        .select("*")
        .eq("user_id", userId)
        .order("created_at", { ascending: false })
        .limit(limit);

      if (error) throw error;
      return (data as Notification[]) || [];
    } catch (error) {
      console.error("Error fetching notifications:", error);
      return [];
    }
  }

  static async getUnreadCount(userId: string): Promise<number> {
    try {
      const { count, error } = await supabase
        .from("notifications")
        .select("*", { count: "exact", head: true })
        .eq("user_id", userId)
        .eq("is_read", false);

      if (error) throw error;
      return count || 0;
    } catch (error) {
      console.error("Error fetching unread count:", error);
      return 0;
    }
  }

  static async markAsRead(notificationId: string) {
    try {
      const { error } = await supabase
        .from("notifications")
        .update({ is_read: true, updated_at: new Date().toISOString() })
        .eq("id", notificationId);
      if (error) throw error;
      return true;
    } catch (error) {
      console.error("Error marking notification as read:", error);
      return false;
    }
  }

  static async markAllAsRead(userId: string) {
    try {
      const { error } = await supabase
        .from("notifications")
        .update({ is_read: true, updated_at: new Date().toISOString() })
        .eq("user_id", userId)
        .eq("is_read", false);
      if (error) throw error;
      return true;
    } catch (error) {
      console.error("Error marking all notifications as read:", error);
      return false;
    }
  }

  static async deleteNotification(notificationId: string) {
    try {
      const { error } = await supabase
        .from("notifications")
        .delete()
        .eq("id", notificationId);
      if (error) throw error;
      return true;
    } catch (error) {
      console.error("Error deleting notification:", error);
      return false;
    }
  }

  // 🟢 SỬA LẠI HÀM SUBSCRIBE CHO AN TOÀN
  static subscribeToNotifications(
    userId: string,
    callback: (notification: Notification) => void
  ) {
    // Tạo channel với ID duy nhất để tránh trùng lặp
    const channelId = `notifications:${userId}:${Date.now()}`;

    const channel = supabase
      .channel(channelId)
      .on(
        "postgres_changes",
        {
          event: "INSERT",
          schema: "public",
          table: "notifications",
          filter: `user_id=eq.${userId}`,
        },
        (payload) => {
          // Validate dữ liệu trước khi callback
          if (payload.new && payload.new.id) {
            callback(payload.new as Notification);
          }
        }
      )
      .subscribe((status) => {
        if (status === "SUBSCRIBED") {
          console.log(`🔔 Đã kết nối thông báo cho user ${userId}`);
        }
      });

    // Trả về object chứa hàm unsubscribe an toàn
    return {
      unsubscribe: () => {
        console.log(`🔕 Hủy kết nối thông báo ${channelId}`);
        supabase.removeChannel(channel);
      },
    };
  }
}
</file>

<file path="app/GiaoDienTong/MenuTren/NutCaNhan/NutCaNhan.tsx">
'use client';
import React, { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { UserCircle } from 'lucide-react';

 
import ModalProfile from '@/app/GiaoDienTong/MenuTren/NutCaNhan/ModalProfile';
import { useAppSettings } from '@/app/ThuVien/AppSettingsContext';

interface Props {
    nguoiDung: any; 
    isOpen: boolean;       
    onToggle: () => void;  
    onClose: () => void;
}

export default function NutCaNhan({ nguoiDung, isOpen, onToggle, onClose }: Props) {
    const [mounted, setMounted] = useState(false);
    const { t } = useAppSettings();

    useEffect(() => {
        setMounted(true);
    }, []);

    // Modal nội dung Profile mới
    const modalContent = isOpen && nguoiDung ? (
        <ModalProfile
            isOpen={true}
            onClose={onClose}
            nguoiDung={nguoiDung}
        />
    ) : null;

    return (
        <>
          

            {mounted && modalContent && createPortal(modalContent, document.body)}
        </>
    );
}
</file>

<file path="app/ThuVien/compressImage.ts">
export const compressImage = async (
  file: File,
  quality: number = 0.8,
  maxWidth: number = 1920
): Promise<File> => {
  return new Promise((resolve, reject) => {
    // Validate input
    if (!file) {
      reject(new Error("No file provided"));
      return;
    }

    const reader = new FileReader();
    reader.readAsDataURL(file);

    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target?.result as string;

      img.onload = () => {
        try {
          const canvas = document.createElement("canvas");
          let width = img.width;
          let height = img.height;

          // Resize nếu ảnh quá lớn
          if (width > maxWidth) {
            height = Math.round((height * maxWidth) / width);
            width = maxWidth;
          }

          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext("2d");
          if (!ctx) {
            reject(new Error("Canvas context error"));
            return;
          }

          // Vẽ ảnh lên canvas
          ctx.drawImage(img, 0, 0, width, height);

          // Xuất blob
          canvas.toBlob(
            (blob) => {
              if (!blob) {
                reject(new Error("Compression failed: Blob is null"));
                return;
              }
              // Tạo file mới từ blob đã nén
              const compressedFile = new File([blob], file.name, {
                type: "image/jpeg",
                lastModified: Date.now(),
              });
              resolve(compressedFile);
            },
            "image/jpeg",
            quality
          );
        } catch (e) {
          reject(e);
        }
      };

      img.onerror = (err) => reject(new Error("Image load error"));
    };

    reader.onerror = (err) => reject(new Error("File read error"));
  });
};
</file>

<file path="app/ThuVien/GoogleDich.tsx">
'use client';
import React, { useEffect, useState } from 'react';
import { useAppSettings, LanguageCode } from '@/app/ThuVien/AppSettingsContext';

const LANGUAGES = [
  { code: 'vi', label: 'Tiếng Việt', flag: 'https://flagcdn.com/w40/vn.png' },
  { code: 'en', label: 'English', flag: 'https://flagcdn.com/w40/us.png' },
  { code: 'zh-CN', label: 'Chinese', flag: 'https://flagcdn.com/w40/cn.png' },
  { code: 'ja', label: 'Japanese', flag: 'https://flagcdn.com/w40/jp.png' },
  { code: 'fr', label: 'French', flag: 'https://flagcdn.com/w40/fr.png' },
  { code: 'de', label: 'German', flag: 'https://flagcdn.com/w40/de.png' },
];

export default function GoogleDich() {
  // 🌐 Đồng bộ với AppSettingsContext
  const { language, setLanguage } = useAppSettings();
  
  // currentLang dùng string vì Google Translate hỗ trợ nhiều ngôn ngữ hơn AppSettings
  const [currentLang, setCurrentLang] = useState<string>(language);
  const [showMenu, setShowMenu] = useState(false);
  const [isMounted, setIsMounted] = useState(false);

  // Đồng bộ khi language từ context thay đổi
  useEffect(() => {
    setCurrentLang(language);
  }, [language]);

  useEffect(() => {
    setIsMounted(true);
    if (typeof document !== 'undefined') {
        const cookies = document.cookie.split(';');
        const googCookie = cookies.find(c => c.trim().startsWith('googtrans='));
        if (googCookie) {
            const langCode = googCookie.split('/').pop();
            if (langCode) setCurrentLang(langCode);
        }
    }

    if (!document.getElementById('google-translate-script')) {
        const addScript = document.createElement('script');
        addScript.id = 'google-translate-script';
        addScript.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
        document.body.appendChild(addScript);

        // @ts-ignore
        window.googleTranslateElementInit = () => {
             // @ts-ignore
             if (window.google && window.google.translate) {
                // @ts-ignore
                new window.google.translate.TranslateElement({
                    pageLanguage: 'vi',
                    autoDisplay: false, 
                    layout: 0 
                }, 'google_translate_element');
             }
        };
    }
  }, []);

  const changeLanguage = (langCode: string) => {
    document.cookie = `googtrans=/auto/${langCode}; path=/; domain=${window.location.hostname}`;
    document.cookie = `googtrans=/auto/${langCode}; path=/;`;
    setCurrentLang(langCode);
    setShowMenu(false);
    
    // 🌐 Đồng bộ với AppSettingsContext (chỉ vi/en)
    if (langCode === 'vi' || langCode === 'en') {
      setLanguage(langCode as LanguageCode);
    }
    
    window.location.reload(); 
  };

  if (!isMounted) return null;

  const currentFlag = LANGUAGES.find(l => l.code === currentLang)?.flag || LANGUAGES[0].flag;

  return (
    <div className="absolute top-6 right-6 z-50">
      <div id="google_translate_element" className="hidden" />

      <div className="relative">
        <button 
          onClick={() => setShowMenu(!showMenu)}
          className="w-10 h-10 rounded-full overflow-hidden border-2 border-white/20 hover:border-white transition-all shadow-lg active:scale-95 bg-black/50"
        >
          <img src={currentFlag} alt="Flag" className="w-full h-full object-cover" />
        </button>

        {showMenu && (
          <div className="absolute right-0 top-12 bg-black/90 backdrop-blur-md border border-white/10 rounded-xl overflow-hidden shadow-2xl w-40 z-[60]">
            {LANGUAGES.map((lang) => (
              <button
                key={lang.code}
                onClick={() => changeLanguage(lang.code)}
                className={`flex items-center gap-3 w-full px-4 py-3 hover:bg-white/10 transition-colors text-left ${currentLang === lang.code ? 'bg-white/5' : ''}`}
              >
                <img src={lang.flag} alt={lang.code} className="w-6 h-4 object-cover rounded-sm" />
                <span className={`text-xs font-bold ${currentLang === lang.code ? 'text-yellow-500' : 'text-gray-300'}`}>
                  {lang.label}
                </span>
              </button>
            ))}
          </div>
        )}
      </div>
      
      {/* 🟢 CSS QUAN TRỌNG: Ẩn thanh Google triệt để */}
      <style jsx global>{`
        .goog-te-banner-frame { display: none !important; }
        .skiptranslate { display: none !important; } 
        body { top: 0px !important; }
        #goog-gt-tt { display: none !important; visibility: hidden !important; }
        .goog-tooltip { display: none !important; }
        .goog-text-highlight { background-color: transparent !important; box-shadow: none !important; }
      `}</style>
    </div>
  );
}
</file>

<file path="app/ThuVien/ketNoiSupabase.ts">
import { createBrowserClient } from '@supabase/ssr'

// 1. Lấy biến môi trường
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY

// 2. Kiểm tra biến môi trường
if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error(
    'Lỗi nghiêm trọng: Không tìm thấy biến môi trường Supabase! Hãy kiểm tra file .env.local.'
  )
}

// 3. Khởi tạo Client cho Trình duyệt (Browser Client)
// Dùng createBrowserClient của @supabase/ssr để tự động xử lý Cookies
export const supabase = createBrowserClient(supabaseUrl, supabaseAnonKey)
</file>

<file path="app/ThuVien/KieuDuLieu.ts">
// ThuVien/KieuDuLieu.ts

export type LoaiNoiDung = 'image' | 'text' | 'task';

export type DuLieuKhoi = {
  id: string;
  tieuDe: string;
  loai: LoaiNoiDung;
  noiDung: string;
  doRongCot: 1 | 2 | 3 | 4; // ColSpan
};

export type DuLieuHang = {
  id: string;
  chieuCao: number;
  danhSachKhoi: DuLieuKhoi[];
};
</file>

<file path="app/ThuVien/OrderService.ts">
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { LoggerService } from "@/app/ThuVien/LoggerService";

// Interface khớp với DB bảng don_hang
export interface Order {
  id: string;
  ma_don: string;
  ten_khach: string | null;
  sdt: string | null;
  dia_chi: string | null;
  ghi_chu: string | null;
  trang_thai: string;
  tong_tien: number;
  nguoi_tao_id: string; // Đã sửa từ nguoi_tao -> nguoi_tao_id cho khớp DB
  tao_luc: string;
  cap_nhat_luc: string;
}

// Interface khớp với DB bảng don_hang_chi_tiet
export interface OrderItem {
  id: string;
  don_hang_id: string;
  vat_tu_id: string | null;
  ten_item_hien_thi: string | null; // Sửa từ ten_san_pham -> ten_item_hien_thi
  so_luong: number;
  don_gia: number;
  thanh_tien?: number; // Có thể tính toán ở frontend
}

// Interface dữ liệu đầu vào khi tạo đơn (từ Form)
export interface CreateOrderData {
  ten_khach?: string;
  sdt?: string;
  dia_chi?: string;
  ghi_chu?: string;
  items: Array<{
    id?: string; // Thêm id (vat_tu_id) để trừ kho nếu cần
    ten_san_pham: string;
    so_luong: number;
    don_gia: number;
  }>;
}

export class OrderService {
  /**
   * Tạo đơn hàng mới (auto set nguoi_tao_id = auth.uid())
   */
  static async createOrder(data: CreateOrderData): Promise<string | null> {
    try {
      // 1. Tính tổng tiền
      const tongTien = data.items.reduce(
        (sum, item) => sum + item.so_luong * item.don_gia,
        0
      );

      // 2. Lấy User ID hiện tại
      const {
        data: { user },
      } = await supabase.auth.getUser();

      // 3. Insert đơn hàng (Header)
      const { data: orderData, error: orderError } = await supabase
        .from("don_hang")
        .insert({
          ten_khach: data.ten_khach,
          sdt: data.sdt,
          dia_chi: data.dia_chi,
          ghi_chu: data.ghi_chu,
          tong_tien: tongTien,
          trang_thai: "moi",
          nguoi_tao_id: user?.id, // Dùng nguoi_tao_id cho chuẩn
          // kenh_ban_hang: 'web' // Có thể thêm nếu cần
        })
        .select("id")
        .single();

      if (orderError) {
        LoggerService.error("OrderService", "Error creating order", orderError);
        return null;
      }

      // 4. Insert chi tiết đơn hàng (Items)
      if (data.items.length > 0) {
        const itemsToInsert = data.items.map((item) => ({
          don_hang_id: orderData.id,
          vat_tu_id: item.id || null, // Map ID vật tư nếu có
          ten_item_hien_thi: item.ten_san_pham, // Map sang cột đúng trong DB
          so_luong: item.so_luong,
          don_gia: item.don_gia,
        }));

        const { error: itemsError } = await supabase
          .from("don_hang_chi_tiet") // ✅ Đã sửa tên bảng đúng
          .insert(itemsToInsert);

        if (itemsError) {
          console.error("Error creating order items:", itemsError);
          // Lưu ý: Nếu insert items lỗi, có thể cần xóa đơn hàng header (rollback thủ công)
        }
      }

      return orderData.id;
    } catch (error) {
      console.error("OrderService.createOrder error:", error);
      return null;
    }
  }

  /**
   * Lấy danh sách đơn hàng của user hiện tại
   */
  static async getMyOrders(
    limit = 50
  ): Promise<{ orders: Order[]; error: string | null }> {
    try {
      const {
        data: { user },
      } = await supabase.auth.getUser();

      if (!user) return { orders: [], error: "User not logged in" };

      // Lấy đơn hàng do user tạo HOẶC user là khách hàng (dựa trên id)
      // Ở đây ta tạm lấy theo nguoi_tao_id để đơn giản
      const { data, error } = await supabase
        .from("don_hang")
        .select("*")
        .eq("nguoi_tao_id", user.id)
        .order("tao_luc", { ascending: false })
        .limit(limit);

      if (error) {
        console.error("Error fetching orders:", error.message);
        return { orders: [], error: error.message };
      }

      return { orders: (data ?? []) as Order[], error: null };
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : "Unknown error";
      console.error("OrderService.getMyOrders error:", errorMsg);
      return { orders: [], error: errorMsg };
    }
  }

  /**
   * Lấy chi tiết đơn hàng (bao gồm items)
   */
  static async getOrderById(
    orderId: string
  ): Promise<{ order: Order; items: OrderItem[] } | null> {
    try {
      // Lấy Header
      const { data: orderData, error: orderError } = await supabase
        .from("don_hang")
        .select("*")
        .eq("id", orderId)
        .single();

      if (orderError) {
        console.error("Error fetching order:", orderError);
        return null;
      }

      // Lấy Items
      const { data: itemsData, error: itemsError } = await supabase
        .from("don_hang_chi_tiet") // ✅ Đã sửa tên bảng đúng
        .select("*")
        .eq("don_hang_id", orderId);

      if (itemsError) {
        console.error("Error fetching order items:", itemsError);
        // Vẫn trả về order nhưng không có items
        return { order: orderData as Order, items: [] };
      }

      return {
        order: orderData as Order,
        items: itemsData as OrderItem[],
      };
    } catch (error) {
      console.error("OrderService.getOrderById error:", error);
      return null;
    }
  }

  /**
   * Cập nhật trạng thái đơn hàng
   */
  static async updateOrderStatus(
    orderId: string,
    trangThai: string
  ): Promise<boolean> {
    try {
      const { error } = await supabase
        .from("don_hang")
        .update({ trang_thai: trangThai })
        .eq("id", orderId);

      if (error) {
        console.error("Error updating order status:", error);
        return false;
      }

      return true;
    } catch (error) {
      console.error("OrderService.updateOrderStatus error:", error);
      return false;
    }
  }

  /**
   * Lấy đơn hàng gần nhất
   */
  static async getLatestOrder(): Promise<{
    order: Order | null;
    error: string | null;
  }> {
    try {
      const { data, error } = await supabase
        .from("don_hang")
        .select("*")
        .order("tao_luc", { ascending: false })
        .limit(1)
        .single();

      if (error) {
        // Có thể không có đơn hàng nào
        if (error.code === "PGRST116") return { order: null, error: null };

        console.error("Error fetching latest order:", error);
        return { order: null, error: error.message };
      }

      return { order: data as Order, error: null };
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : "Unknown error";
      console.error("OrderService.getLatestOrder error:", errorMsg);
      return { order: null, error: errorMsg };
    }
  }

  /**
   * Format trạng thái đơn hàng thành tiếng Việt
   */
  static formatStatus(status: string): string {
    const statusMap: Record<string, string> = {
      moi: "🆕 Mới",
      dang_xu_ly: "⏳ Đang xử lý",
      dang_giao: "🚚 Đang giao",
      hoan_thanh: "✅ Hoàn thành",
      huy: "❌ Đã hủy",
      dang_san_xuat: "🔨 Đang sản xuất",
    };
    return statusMap[status] || status;
  }

  /**
   * Format số tiền VND
   */
  static formatMoney(amount: number): string {
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
    }).format(amount);
  }
}
</file>

<file path="app/actions/QuyenHanSales.ts">
"use server";

import postgres from "postgres";
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";
// 👇 IMPORT MỚI
import { sendNotificationToRoles } from "./NotificationAction";

const sql = postgres(process.env.DATABASE_URL!, {
  ssl: "require",
  max: 10,
  idle_timeout: 20,
});

// Helper: Lấy thông tin nhân viên đang login
async function getStaffUser() {
  const cookieStore = cookies();
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
        set() {},
        remove() {},
      },
    }
  );
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) throw new Error("Unauthorized: Bạn chưa đăng nhập");

  // Lấy role và organization_id
  const [ns] =
    await sql`SELECT id, ho_ten, vi_tri_normalized, organization_id FROM nhan_su WHERE id = ${user.id} LIMIT 1`;
  if (!ns) throw new Error("Not a staff member: Không tìm thấy hồ sơ nhân sự");

  return ns;
}

// --- 1. NGHIỆP VỤ CHAT TƯ VẤN (Cũ) ---
export async function claimChatSessionAction(sessionId: string) {
  try {
    const staff = await getStaffUser();

    const [session] =
      await sql`SELECT nhan_su_phu_trach_id FROM tu_van_sessions WHERE id = ${sessionId} LIMIT 1`;
    if (!session) throw new Error("Cuộc hội thoại không tồn tại");

    if (
      session.nhan_su_phu_trach_id &&
      session.nhan_su_phu_trach_id !== staff.id
    ) {
      if (["admin", "quanly", "boss"].includes(staff.vi_tri_normalized)) {
        // Admin được quyền cướp
      } else {
        return {
          success: false,
          error: "Cuộc hội thoại này đã có Sales khác hỗ trợ!",
        };
      }
    }

    await sql`
            UPDATE tu_van_sessions 
            SET nhan_su_phu_trach_id = ${staff.id}, 
                trang_thai = 'dang_tu_van' 
            WHERE id = ${sessionId}
        `;

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// --- 2. NGHIỆP VỤ BÁN HÀNG (POS) ---

// Lấy danh sách sản phẩm để bán
export async function getProductsForPOS(search: string) {
  try {
    await getStaffUser();
    let query = `SELECT * FROM "vat_tu" WHERE loai_vat_tu = 'thanh_pham' AND ton_kho > 0`;
    const params: any[] = [];

    if (search) {
      query += ` AND (ten_vat_tu ILIKE $1 OR ma_sku ILIKE $1)`;
      params.push(`%${search}%`);
    }

    query += ` ORDER BY ten_vat_tu ASC LIMIT 20`;
    const data = await sql.unsafe(query, params);
    return { success: true, data: Array.from(data) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// Tìm khách hàng nhanh
export async function searchCustomer(term: string) {
  try {
    await getStaffUser();
    const data = await sql`
            SELECT id, ho_ten, so_dien_thoai, phan_loai 
            FROM "khach_hang" 
            WHERE ho_ten ILIKE ${"%" + term + "%"} OR so_dien_thoai ILIKE ${
      "%" + term + "%"
    }
            LIMIT 5
        `;
    return { success: true, data: Array.from(data) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 🔥 QUAN TRỌNG: TẠO ĐƠN & TỰ ĐỘNG BẮN LỆNH SẢN XUẤT
export async function createPOSOrder(orderData: any) {
  try {
    const staff = await getStaffUser();

    // 1. Tạo Đơn hàng
    // Trạng thái 'dang_san_xuat' để kích hoạt quy trình
    const [newOrder] = await sql`
            INSERT INTO "don_hang" (
                khach_hang_id, sales_phu_trach_id, nguoi_tao_id, organization_id,
                trang_thai, tong_tien, da_thanh_toan, kenh_ban_hang, ghi_chu
            ) VALUES (
                ${orderData.khach_hang_id}, ${staff.id}, ${staff.id}, ${staff.organization_id},
                'dang_san_xuat', ${orderData.tong_tien}, ${orderData.da_thanh_toan}, 'pos', ${orderData.ghi_chu}
            ) RETURNING id, ma_don
        `;

    // 2. Lấy quy trình mẫu mặc định (Để gắn vào lệnh SX)
    // Trong thực tế có thể chọn quy trình, ở đây lấy mặc định cái đầu tiên tìm thấy
    const [defaultProcess] = await sql`SELECT id FROM quy_trinh_mau LIMIT 1`;
    const quyTrinhId = defaultProcess?.id || null;
    let hasJob = false;

    // 3. Tạo Chi tiết đơn & Lệnh Sản Xuất (Job)
    for (const item of orderData.items) {
      // A. Insert Chi tiết đơn
      const [newItem] = await sql`
                INSERT INTO "don_hang_chi_tiet" (
                    don_hang_id, vat_tu_id, ten_item_hien_thi, so_luong, don_gia
                ) VALUES (
                    ${newOrder.id}, ${item.id}, ${item.ten_vat_tu}, ${item.so_luong}, ${item.don_gia}
                ) RETURNING id
            `;

      // B. TẠO LỆNH SẢN XUẤT (Treo lên "Sàn việc" cho thợ nhận)
      if (quyTrinhId) {
        hasJob = true;
        // Tạo mã lệnh ngẫu nhiên
        const maLenh = "LSX-" + Math.floor(100000 + Math.random() * 900000);

        await sql`
                    INSERT INTO "lenh_san_xuat" (
                        ma_lenh, organization_id, don_hang_chi_tiet_id, quy_trinh_id,
                        trang_thai, tien_do, nguoi_phu_trach
                    ) VALUES (
                        ${maLenh}, 
                        ${staff.organization_id},
                        ${newItem.id}, ${quyTrinhId},
                        'moi', 0, NULL -- NULL = Chưa ai nhận (Available Job)
                    )
                `;
      }
    }

    // 4. Ghi nhận Thu tiền (nếu khách trả ngay)
    if (orderData.da_thanh_toan > 0) {
      await sql`
                INSERT INTO "so_cai_tai_chinh" (
                    loai_giao_dich, so_tien, mo_ta, tham_chieu_id, nguoi_thuc_hien, organization_id
                ) VALUES (
                    'thu', ${orderData.da_thanh_toan}, ${
        "Thu tiền đơn " + newOrder.ma_don
      }, ${newOrder.id}, ${staff.id}, ${staff.organization_id}
                )
            `;
    }

    // 🔔 GỬI THÔNG BÁO ĐA KÊNH
    // Logic: Báo cho Admin, Quản lý, Kho, Kế toán
    const targetRoles = ["admin", "boss", "quanly", "kho", "ketoan"];
    // Nếu có lệnh sản xuất -> Báo thêm cho Thợ
    if (hasJob) targetRoles.push("thosanxuat");

    sendNotificationToRoles(
      targetRoles,
      `Đơn hàng mới: ${newOrder.ma_don}`,
      `${staff.ho_ten} vừa chốt đơn thành công! Doanh thu: ${Number(
        orderData.tong_tien
      ).toLocaleString()}đ`,
      "/dathang", // Link mở danh sách đơn
      "order_created", // Icon
      staff.ho_ten
    );

    return { success: true, ma_don: newOrder.ma_don };
  } catch (error: any) {
    console.error("Lỗi tạo đơn POS:", error);
    return { success: false, error: error.message };
  }
}
</file>

<file path="app/actions/QuyenHanThietKe.ts">
"use server";
import postgres from "postgres";
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";
// 👇 IMPORT MỚI: Action gửi thông báo trung tâm
import { sendNotificationToRoles } from "./NotificationAction";

const sql = postgres(process.env.DATABASE_URL!, {
  ssl: "require",
  max: 10,
  idle_timeout: 20,
});

// --- HELPER: CHUẨN HÓA TÊN FILE (Chỉ xử lý text, không gắn user) ---
const standardizeBasicName = (inputName: string) => {
  let name = inputName.trim();

  // 1. Viết hoa chữ cái đầu (VD: "thọ" -> "Thọ")
  if (name.length > 0) {
    name = name.charAt(0).toUpperCase() + name.slice(1);
  }

  // 2. Tự động thêm "cm" và dấu gạch ngang cho kích thước
  // VD: "20x30" -> " - 20x30cm"
  name = name.replace(/(\d+)\s*[xX*]\s*(\d+)\s*(cm|CM)?/g, (match, w, h) => {
    return ` - ${w}x${h}cm`;
  });

  // 3. Xử lý dấu gạch ngang bị thừa
  name = name
    .replace(/\s*-\s*-\s*/g, " - ")
    .replace(/\s*-\s*/g, " - ")
    .replace(/^\s*-\s*/, "");

  return name;
};

// --- HELPER: XỬ LÝ LIST FILE TRƯỚC KHI LƯU ---
const processFileList = (input: any, currentUser: string) => {
  if (!input) return "[]";

  let files: any[] = [];

  // Parse dữ liệu đầu vào
  try {
    if (Array.isArray(input)) files = input;
    else if (typeof input === "string") {
      const parsed = JSON.parse(input);
      if (Array.isArray(parsed)) files = parsed;
    }
  } catch {
    return "[]";
  }

  // Xử lý từng file
  const processedFiles = files
    .map((file: any) => {
      const now = new Date().toISOString();

      // TRƯỜNG HỢP 1: File là string (kiểu cũ) -> convert sang object mới
      if (typeof file === "string") {
        return {
          ten: standardizeBasicName("File đính kèm"),
          url: file,
          nguoi_dang: currentUser, // Gắn người đang sửa vì file cũ chưa có info
          last_modified: now,
        };
      }

      // TRƯỜNG HỢP 2: Là object chuẩn
      if (typeof file === "object" && file.url) {
        // Logic bảo toàn lịch sử:
        // - Nếu file đã có 'nguoi_dang' (file cũ) -> Giữ nguyên.
        // - Nếu chưa có (file mới thêm) -> Gán currentUser.
        const uploader = file.nguoi_dang || currentUser;

        // - Nếu file cũ -> Giữ nguyên thời gian.
        // - Nếu mới -> Lấy thời gian hiện tại.
        const timestamp = file.last_modified || now;

        return {
          ...file,
          // Luôn chuẩn hóa lại tên (để sửa lỗi chính tả nếu user mới nhập)
          ten: standardizeBasicName(file.ten || "File thiết kế"),
          nguoi_dang: uploader,
          last_modified: timestamp,
        };
      }
      return null;
    })
    .filter(Boolean); // Lọc bỏ null

  return JSON.stringify(processedFiles);
};

// --- CORE AUTH ---
async function requireAuth() {
  const cookieStore = cookies();
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
        set() {},
        remove() {},
      },
    }
  );
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user || !user.email) throw new Error("Unauthorized: Vui lòng đăng nhập");
  return user;
}

async function checkOwnershipOrAdmin(
  userEmail: string,
  resourceId?: string,
  action: "update" | "delete" = "update"
) {
  const [nhanSu] = await sql`
        SELECT id, vi_tri_normalized, ho_ten 
        FROM nhan_su 
        WHERE email = ${userEmail}
    `;

  if (!nhanSu) throw new Error("Không tìm thấy thông tin nhân sự.");

  const role = nhanSu.vi_tri_normalized || "";
  const isAdmin = ["admin", "quanly", "boss"].includes(role);

  // Trả về cả info nhân sự để dùng tên
  const userInfo = { id: nhanSu.id, name: nhanSu.ho_ten || "Nhân viên" };

  if (isAdmin) return userInfo;

  if (action === "delete") {
    throw new Error("⛔ Bạn không có quyền xóa (Chỉ Admin mới được xóa).");
  }

  if (resourceId) {
    const [mau] =
      await sql`SELECT nguoi_tao FROM mau_thiet_ke WHERE id = ${resourceId}`;
    if (!mau) throw new Error("Mẫu không tồn tại.");
    if (mau.nguoi_tao !== nhanSu.id) {
      throw new Error("⛔ Bạn chỉ được phép sửa mẫu do chính mình tạo ra.");
    }
  }
  return userInfo;
}

// --- ACTIONS ---

export async function getMauThietKeDataAction(
  page: number,
  pageSize: number,
  search: string,
  filterCategory: string
) {
  try {
    await requireAuth();
    let query = `
            SELECT m.*, n.ho_ten as ten_nguoi_tao 
            FROM "mau_thiet_ke" m
            LEFT JOIN "nhan_su" n ON m.nguoi_tao = n.id
            WHERE 1=1
        `;
    const params: any[] = [];
    let paramCount = 1;

    if (search) {
      query += ` AND (m.mo_ta ILIKE $${paramCount})`;
      params.push(`%${search}%`);
      paramCount++;
    }

    if (filterCategory && filterCategory !== "all") {
      if (filterCategory === "has_file") {
        query += ` AND m.file_thiet_ke IS NOT NULL AND m.file_thiet_ke::text != '[]' AND m.file_thiet_ke::text != '' `;
      } else {
        query += ` AND m.phan_loai_normalized = $${paramCount}`;
        params.push(filterCategory);
        paramCount++;
      }
    }

    const countQuery = `SELECT count(*) as total FROM (${query}) as sub`;
    const offset = (page - 1) * pageSize;
    query += ` ORDER BY m.tao_luc DESC LIMIT ${pageSize} OFFSET ${offset}`;

    const data = await sql.unsafe(query, params);
    const [countResult] = await sql.unsafe(countQuery, params);

    return {
      success: true,
      data: Array.from(data),
      total: Number(countResult.total),
    };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function createMauThietKeAction(data: any) {
  try {
    const user = await requireAuth();
    // Lấy thông tin người dùng đang thao tác
    const [nhanSu] = await sql`SELECT id, ho_ten FROM nhan_su WHERE email = ${
      user.email || ""
    }`;
    if (!nhanSu) throw new Error("Không xác định được danh tính nhân sự.");

    const phanLoaiNorm =
      data.phan_loai_normalized ||
      (data.phan_loai
        ? data.phan_loai
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/\s+/g, "")
            .toLowerCase()
        : "");

    // 🟢 TỰ ĐỘNG CHUẨN HÓA TÊN FILE + GẮN NGƯỜI TẠO
    const fileThietKeJson = processFileList(
      data.file_thiet_ke,
      nhanSu.ho_ten || "Admin"
    );

    await sql.unsafe(
      `
            INSERT INTO "mau_thiet_ke" (
                mo_ta, phan_loai, phan_loai_normalized, hinh_anh, 
                file_thiet_ke, nguoi_tao, tao_luc
            )
            VALUES ($1, $2, $3, $4, $5, $6, now())
        `,
      [
        data.mo_ta,
        data.phan_loai,
        phanLoaiNorm,
        data.hinh_anh,
        fileThietKeJson,
        nhanSu.id,
      ]
    );

    // 🔔 GỬI THÔNG BÁO TỰ ĐỘNG
    // Logic: Báo cho Admin, Boss, Quản lý và Phòng Thiết kế
    sendNotificationToRoles(
      ["admin", "boss", "quanly", "thietke"],
      "Mẫu thiết kế mới",
      `${nhanSu.ho_ten} vừa thêm mẫu: "${data.mo_ta}"`,
      "/phongthietke", // Link mở khi click
      "artwork_new", // Icon type
      nhanSu.ho_ten // Người gửi
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function updateMauThietKeAction(id: string, data: any) {
  try {
    const user = await requireAuth();
    // Check quyền và lấy luôn thông tin người đang sửa (currentUser)
    const currentUser = await checkOwnershipOrAdmin(
      user.email || "",
      id,
      "update"
    );

    const phanLoaiNorm =
      data.phan_loai_normalized ||
      (data.phan_loai
        ? data.phan_loai
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/\s+/g, "")
            .toLowerCase()
        : "");

    // 🟢 TỰ ĐỘNG CHUẨN HÓA TÊN FILE
    const fileThietKeJson = processFileList(
      data.file_thiet_ke,
      currentUser.name || "Admin"
    );

    await sql.unsafe(
      `
            UPDATE "mau_thiet_ke"
            SET mo_ta = $1,
                phan_loai = $2,
                phan_loai_normalized = $3,
                hinh_anh = $4,
                file_thiet_ke = $5,
                tao_luc = now()
            WHERE id = $6
        `,
      [
        data.mo_ta,
        data.phan_loai,
        phanLoaiNorm,
        data.hinh_anh,
        fileThietKeJson,
        id,
      ]
    );

    // 🔔 GỬI THÔNG BÁO CẬP NHẬT
    sendNotificationToRoles(
      ["admin", "boss", "quanly", "thietke"],
      "Cập nhật mẫu thiết kế",
      `${currentUser.name} vừa cập nhật mẫu: "${data.mo_ta}"`,
      "/phongthietke",
      "system_update",
      currentUser.name
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function deleteMauThietKeAction(id: string) {
  try {
    const user = await requireAuth();
    const currentUser = await checkOwnershipOrAdmin(
      user.email || "",
      id,
      "delete"
    );

    await sql.unsafe(`DELETE FROM "mau_thiet_ke" WHERE id = $1`, [id]);

    // 🔔 GỬI THÔNG BÁO XÓA (Chỉ báo cho Admin/Boss biết có người xóa)
    sendNotificationToRoles(
      ["admin", "boss"],
      "Đã xóa mẫu thiết kế",
      `${currentUser.name} đã xóa một mẫu thiết kế khỏi hệ thống.`,
      "/phongthietke",
      "system_alert",
      currentUser.name
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}
</file>

<file path="app/components/cacchucnang/khachhang/KhachHangChucNang.tsx">
/**
 * ============================================================
 * COMPONENT: KHÁCH HÀNG
 * ============================================================
 *
 * Sử dụng KhungGiaoDien để đồng bộ giao diện.
 * 3 chế độ view: List | Detail | Form (inline, không popup)
 */

"use client";

import React, { useState, useEffect, useMemo, useCallback } from "react";
import {
  User,
  Phone,
  Mail,
  MapPin,
  ShoppingBag,
  Calendar,
  Trash2,
} from "lucide-react";
import {
  KhungDanhSach,
  KhungChiTiet,
  KhungForm,
} from "@/app/components/cacchucnang/KhungGiaoDienChucNang";
import ConfirmDialog from "@/app/components/ConfirmDialog";
import {
  KhachHang,
  KhachHangPermissions,
  createKhachHangConfig,
  PHAN_LOAI_OPTIONS,
} from "./config";

// ============================================================
// PROPS
// ============================================================

interface Props {
  permissions?: KhachHangPermissions;
  className?: string;
}

// ============================================================
// HELPER
// ============================================================

const toNonAccent = (str: string) =>
  str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "")
    .toLowerCase();

const getPhanLoaiStyle = (phanLoai?: string) => {
  const styles: Record<string, string> = {
    "Tiềm năng": "bg-blue-500/20 text-blue-400 border-blue-500/40",
    Mới: "bg-green-500/20 text-green-400 border-green-500/40",
    "Thân thiết": "bg-purple-500/20 text-purple-400 border-purple-500/40",
    VIP: "bg-yellow-500/20 text-yellow-400 border-yellow-500/40",
    "Không hoạt động": "bg-gray-500/20 text-gray-400 border-gray-500/40",
  };
  return (
    styles[phanLoai || ""] || "bg-gray-500/20 text-gray-400 border-gray-500/40"
  );
};

// ============================================================
// COMPONENT
// ============================================================

export default function KhachHangChucNang({
  permissions = {},
  className = "",
}: Props) {
  const config = createKhachHangConfig(permissions);
  const {
    allowView = true,
    allowEdit = true,
    allowDelete = false,
    allowBulk = false,
  } = permissions;

  // ========== STATE ==========
  const [items, setItems] = useState<KhachHang[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [activeTab, setActiveTab] = useState("all");
  const [sortBy, setSortBy] = useState("name");

  // VIEW STATE: 'list' | 'detail' | 'form'
  const [viewMode, setViewMode] = useState<"list" | "detail" | "form">("list");
  const [selectedItem, setSelectedItem] = useState<KhachHang | null>(null);
  const [detailTab, setDetailTab] = useState("thongtin");

  const [bulkMode, setBulkMode] = useState(false);
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [confirmDelete, setConfirmDelete] = useState<{
    show: boolean;
    ids: string[];
  }>({ show: false, ids: [] });

  const [formData, setFormData] = useState<Partial<KhachHang>>({});
  const [saving, setSaving] = useState(false);

  // ========== FETCH DATA ==========
  const fetchData = useCallback(async () => {
    setLoading(true);
    try {
      // 🛠️ FIX: Kiểm tra dataSource và method tồn tại
      if (config.dataSource?.fetchList) {
        const res = await config.dataSource.fetchList(1, 50, "", "");
        if (res.success && res.data) setItems(res.data);
      }
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  }, [config.dataSource]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  // ========== TABS với COUNT ==========
  const tabs = useMemo(() => {
    const counts: Record<string, number> = { all: items.length };
    config.filterTabs?.forEach((tab) => {
      // 🛠️ FIX: Kiểm tra id và filterField
      if (tab.id && tab.filterField) {
        counts[tab.id] = items.filter(
          (i) => (i as any)[tab.filterField!] === tab.id
        ).length;
      }
    });

    const dynamicTabs =
      config.filterTabs?.map((t) => ({
        id: t.id || "", // Fallback ID rỗng
        label: t.label,
        count: t.id ? counts[t.id] || 0 : 0,
      })) || [];

    return [{ id: "all", label: "TẤT CẢ", count: counts.all }, ...dynamicTabs];
  }, [items, config.filterTabs]);

  // ========== FILTERED & SORTED ==========
  const filteredList = useMemo(() => {
    let result = items;

    // Filter by tab
    if (activeTab !== "all") {
      result = result.filter((i) => i.phan_loai_normalized === activeTab);
    }

    // Search
    if (searchTerm) {
      const term = toNonAccent(searchTerm);
      result = result.filter((i) => {
        const hoTen = toNonAccent(i.ho_ten || "");
        const match =
          hoTen.includes(term) ||
          (i.so_dien_thoai || "").includes(term) ||
          toNonAccent(i.email || "").includes(term);
        return match;
      });
    }

    // Sort
    const sortOpt = config.sortOptions?.find((s) => s.key === sortBy);
    if (sortOpt?.sortFn) {
      result = [...result].sort(sortOpt.sortFn);
    }

    return result;
  }, [items, activeTab, searchTerm, sortBy, config.sortOptions]);

  // ========== HANDLERS ==========
  const handleOpenDetail = (item: KhachHang) => {
    setSelectedItem(item);
    setDetailTab("thongtin");
    setViewMode("detail");
  };

  const handleOpenForm = (item?: KhachHang) => {
    setFormData(item ? { ...item } : {});
    setSelectedItem(item || null);
    setViewMode("form");
  };

  const handleBackToList = () => {
    setViewMode("list");
    setSelectedItem(null);
  };

  const handleSave = async () => {
    setSaving(true);
    try {
      // 🛠️ FIX: Kiểm tra dataSource trước khi gọi
      if (selectedItem?.id) {
        if (config.dataSource?.update) {
          await config.dataSource.update(selectedItem.id, formData);
        }
      } else {
        if (config.dataSource?.create) {
          await config.dataSource.create(formData);
        }
      }
      await fetchData();
      handleBackToList();
    } catch (e) {
      console.error(e);
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (ids: string[]) => {
    // 🛠️ FIX: Kiểm tra delete method
    if (config.dataSource?.delete) {
      for (const id of ids) {
        await config.dataSource.delete(id);
      }
      await fetchData();
      setSelectedIds(new Set());
      setConfirmDelete({ show: false, ids: [] });
      handleBackToList();
    }
  };

  const toggleSelect = (id: string) => {
    const newSet = new Set(selectedIds);
    if (newSet.has(id)) newSet.delete(id);
    else newSet.add(id);
    setSelectedIds(newSet);
  };

  // ========== DETAIL TABS COUNT ==========
  const detailTabCounts = useMemo(
    () => ({
      thongtin: 4,
      donhang: 0,
      ghichu: selectedItem?.ghi_chu ? 1 : 0,
    }),
    [selectedItem]
  );

  // ========== RENDER ==========
  return (
    <div className={`h-full ${className}`}>
      {/* ====== CHẾ ĐỘ DANH SÁCH ====== */}
      {viewMode === "list" && (
        <KhungDanhSach
          tabs={tabs}
          activeTab={activeTab}
          onTabChange={setActiveTab}
          onSearch={setSearchTerm} // 🛠️ FIX: Đã xóa searchPlaceholder
          sortOptions={
            config.sortOptions?.map((s) => ({ key: s.key, label: s.label })) ||
            []
          }
          activeSort={sortBy}
          onSortChange={setSortBy}
          showAddButton={allowEdit}
          onAdd={() => handleOpenForm()}
          bulkMode={bulkMode}
          onBulkModeToggle={
            allowBulk ? () => setBulkMode(!bulkMode) : undefined
          }
          selectedCount={selectedIds.size}
          onSelectAll={() =>
            setSelectedIds(new Set(filteredList.map((i) => i.id)))
          }
          onClearSelection={() => setSelectedIds(new Set())}
          bulkActions={
            allowDelete
              ? [
                  {
                    id: "delete",
                    label: "XÓA",
                    icon: Trash2,
                    color: "danger",
                    onClick: () =>
                      setConfirmDelete({
                        show: true,
                        ids: Array.from(selectedIds),
                      }),
                  },
                ]
              : []
          }
          loading={loading}
        >
          {/* Cards */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 p-4">
            {filteredList.map((item) => (
              <div
                key={item.id}
                onClick={() => !bulkMode && handleOpenDetail(item)}
                className={`group relative bg-[#0f0f0f] border rounded-xl overflow-hidden cursor-pointer transition-all hover:border-[#C69C6D]/50 hover:shadow-lg ${
                  selectedIds.has(item.id)
                    ? "border-[#C69C6D] bg-[#C69C6D]/5"
                    : "border-white/10"
                }`}
              >
                {/* Bulk checkbox */}
                {bulkMode && (
                  <div
                    onClick={(e) => {
                      e.stopPropagation();
                      toggleSelect(item.id);
                    }}
                    className="absolute top-3 right-3 z-10"
                  >
                    <div
                      className={`w-5 h-5 rounded border-2 flex items-center justify-center transition-colors ${
                        selectedIds.has(item.id)
                          ? "bg-[#C69C6D] border-[#C69C6D]"
                          : "border-white/30 bg-black/50"
                      }`}
                    >
                      {selectedIds.has(item.id) && (
                        <span className="text-black text-xs">✓</span>
                      )}
                    </div>
                  </div>
                )}

                <div className="p-4 flex items-center gap-4">
                  {/* Avatar */}
                  <div className="w-14 h-14 rounded-full bg-[#1a1a1a] border-2 border-[#C69C6D]/30 overflow-hidden shrink-0">
                    {item.hinh_anh ? (
                      <img
                        src={item.hinh_anh}
                        alt=""
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center text-[#C69C6D]/50">
                        <User size={24} />
                      </div>
                    )}
                  </div>

                  {/* Info */}
                  <div className="flex-1 min-w-0">
                    <h3 className="font-bold text-white truncate">
                      {item.ho_ten}
                    </h3>
                    <span
                      className={`inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase border ${getPhanLoaiStyle(
                        item.phan_loai
                      )}`}
                    >
                      {item.phan_loai || "Chưa phân loại"}
                    </span>
                    <p className="text-xs text-white/40 truncate mt-1">
                      <Phone size={10} className="inline mr-1" />
                      {item.so_dien_thoai || "---"}
                    </p>
                  </div>
                </div>
              </div>
            ))}

            {filteredList.length === 0 && !loading && (
              <div className="col-span-full py-20 text-center text-white/30">
                Không có dữ liệu
              </div>
            )}
          </div>
        </KhungDanhSach>
      )}

      {/* ====== CHẾ ĐỘ CHI TIẾT ====== */}
      {viewMode === "detail" && selectedItem && (
        <KhungChiTiet
          data={selectedItem}
          onClose={handleBackToList}
          avatar={selectedItem.hinh_anh}
          avatarFallback={<User size={10} className="text-[#C69C6D]/50" />}
          title={selectedItem.ho_ten}
          tabs={[
            { id: "thongtin", label: "THÔNG TIN" },
            { id: "donhang", label: "ĐƠN HÀNG" },
            { id: "ghichu", label: "GHI CHÚ" },
          ]}
          activeTab={detailTab}
          onTabChange={setDetailTab}
          tabCounts={detailTabCounts}
          showEditButton={allowEdit}
          showDeleteButton={allowDelete}
          onEdit={() => handleOpenForm(selectedItem)}
          onDelete={() =>
            setConfirmDelete({ show: true, ids: [selectedItem.id] })
          }
        >
          <div className="p-4">
            {detailTab === "thongtin" && (
              <div className="space-y-3">
                <InfoRow
                  icon={Phone}
                  label="SỐ ĐIỆN THOẠI"
                  value={selectedItem.so_dien_thoai}
                  action={() =>
                    window.open(`tel:${selectedItem.so_dien_thoai}`)
                  }
                />
                <InfoRow icon={Mail} label="EMAIL" value={selectedItem.email} />
                <InfoRow
                  icon={MapPin}
                  label="ĐỊA CHỈ"
                  value={selectedItem.dia_chi}
                />
                <InfoRow
                  icon={Calendar}
                  label="NGÀY THAM GIA"
                  value={
                    selectedItem.tao_luc
                      ? new Date(selectedItem.tao_luc).toLocaleDateString(
                          "vi-VN"
                        )
                      : undefined
                  }
                />
              </div>
            )}
            {detailTab === "donhang" && (
              <div className="flex flex-col items-center justify-center py-10 text-white/30">
                <ShoppingBag size={40} className="mb-3 opacity-30" />
                <p className="text-sm">Chưa có đơn hàng</p>
              </div>
            )}
            {detailTab === "ghichu" && (
              <div className="p-4 bg-[#151515] rounded-xl border border-white/5 min-h-[100px]">
                <p className="text-sm text-white/60 whitespace-pre-wrap">
                  {selectedItem.ghi_chu || "Chưa có ghi chú"}
                </p>
              </div>
            )}
          </div>
        </KhungChiTiet>
      )}

      {/* ====== CHẾ ĐỘ FORM ====== */}
      {viewMode === "form" && (
        <KhungForm
          isEditing={!!selectedItem}
          data={formData}
          onClose={handleBackToList}
          title={selectedItem ? selectedItem.ho_ten : "THÊM KHÁCH HÀNG"}
          avatar={selectedItem?.hinh_anh}
          avatarFallback={<User size={10} className="text-[#C69C6D]/50" />}
          showAvatarUpload={true}
          onSubmit={handleSave}
          loading={saving}
          isDirty={Object.keys(formData).length > 0}
        >
          <div className="space-y-4">
            <FormField label="Họ và Tên" required>
              <input
                type="text"
                value={formData.ho_ten || ""}
                onChange={(e) =>
                  setFormData({ ...formData, ho_ten: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                placeholder="Nhập họ tên..."
              />
            </FormField>

            <div className="grid grid-cols-2 gap-4">
              <FormField label="Số điện thoại" required>
                <input
                  type="tel"
                  value={formData.so_dien_thoai || ""}
                  onChange={(e) =>
                    setFormData({ ...formData, so_dien_thoai: e.target.value })
                  }
                  className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                  placeholder="09..."
                />
              </FormField>
              <FormField label="Email">
                <input
                  type="email"
                  value={formData.email || ""}
                  onChange={(e) =>
                    setFormData({ ...formData, email: e.target.value })
                  }
                  className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                  placeholder="email@..."
                />
              </FormField>
            </div>

            <FormField label="Phân loại">
              <select
                value={formData.phan_loai || ""}
                onChange={(e) =>
                  setFormData({ ...formData, phan_loai: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white focus:border-[#C69C6D]/50 focus:outline-none"
              >
                <option value="">Chọn phân loại...</option>
                {PHAN_LOAI_OPTIONS.map((opt) => (
                  <option key={opt} value={opt}>
                    {opt}
                  </option>
                ))}
              </select>
            </FormField>

            <FormField label="Địa chỉ">
              <textarea
                value={formData.dia_chi || ""}
                onChange={(e) =>
                  setFormData({ ...formData, dia_chi: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none resize-none"
                rows={2}
                placeholder="Nhập địa chỉ..."
              />
            </FormField>

            <FormField label="Ghi chú">
              <textarea
                value={formData.ghi_chu || ""}
                onChange={(e) =>
                  setFormData({ ...formData, ghi_chu: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none resize-none"
                rows={3}
                placeholder="Ghi chú thêm..."
              />
            </FormField>
          </div>
        </KhungForm>
      )}

      {/* ====== CONFIRM DELETE ====== */}
      <ConfirmDialog
        isOpen={confirmDelete.show}
        title="XÁC NHẬN XÓA"
        message={`Bạn có chắc muốn xóa ${confirmDelete.ids.length} khách hàng?`}
        onConfirm={() => handleDelete(confirmDelete.ids)}
        onCancel={() => setConfirmDelete({ show: false, ids: [] })}
      />
    </div>
  );
}

// ============================================================
// SUB-COMPONENTS
// ============================================================

function InfoRow({
  icon: Icon,
  label,
  value,
  action,
}: {
  icon: any;
  label: string;
  value?: string;
  action?: () => void;
}) {
  return (
    <div className="flex items-center gap-3 p-3 rounded-xl bg-[#151515] border border-white/5 hover:border-[#C69C6D]/30 transition-colors">
      <div className="p-2 rounded-lg bg-black text-[#C69C6D]">
        <Icon size={16} />
      </div>
      <div className="flex-1 min-w-0">
        <p className="text-[9px] font-black uppercase tracking-wider text-white/40 mb-0.5">
          {label}
        </p>
        <p className="text-sm font-bold text-gray-200 truncate">
          {value || "---"}
        </p>
      </div>
      {action && value && (
        <button
          onClick={action}
          className="px-3 py-1 text-[10px] font-bold uppercase bg-[#C69C6D]/20 text-[#C69C6D] rounded hover:bg-[#C69C6D]/30"
        >
          GỌI
        </button>
      )}
    </div>
  );
}

function FormField({
  label,
  required,
  children,
}: {
  label: string;
  required?: boolean;
  children: React.ReactNode;
}) {
  return (
    <div>
      <label className="block text-xs font-bold text-white/60 uppercase tracking-wider mb-2">
        {label} {required && <span className="text-red-400">*</span>}
      </label>
      {children}
    </div>
  );
}
</file>

<file path="app/components/cacchucnang/nhansu/NhanSuChucNang.tsx">
/**
 * ============================================================
 * COMPONENT: NHÂN SỰ
 * ============================================================
 *
 * Sử dụng KhungGiaoDien để đồng bộ giao diện.
 * 3 chế độ view: List | Detail | Form (inline, không popup)
 */

"use client";

import React, { useState, useEffect, useMemo, useCallback } from "react";
import { User, Phone, Mail, Banknote, Briefcase, Trash2 } from "lucide-react";
import {
  KhungDanhSach,
  KhungChiTiet,
  KhungForm,
} from "@/app/components/cacchucnang/KhungGiaoDienChucNang";
import ConfirmDialog from "@/app/components/ConfirmDialog";
import { NhanSu, NhanSuPermissions, createNhanSuConfig } from "./config";

// ============================================================
// PROPS
// ============================================================

interface Props {
  permissions?: NhanSuPermissions;
  className?: string;
}

// ============================================================
// HELPER: Format tiền VNĐ
// ============================================================

const formatMoney = (value: number | undefined) => {
  if (!value) return "0 ₫";
  return new Intl.NumberFormat("vi-VN", {
    style: "currency",
    currency: "VND",
  }).format(value);
};

const toNonAccent = (str: string) =>
  str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "")
    .toLowerCase();

// ============================================================
// COMPONENT
// ============================================================

export default function NhanSuChucNang({
  permissions = {},
  className = "",
}: Props) {
  console.log("🔴 NhanSuChucNang MOUNTED - new version with KhungDanhSach");
  const config = createNhanSuConfig(permissions);
  const {
    allowView = true,
    allowEdit = true,
    allowDelete = false,
    allowBulk = false,
  } = permissions;

  // ========== STATE ==========
  const [items, setItems] = useState<NhanSu[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [activeTab, setActiveTab] = useState("all");
  const [sortBy, setSortBy] = useState("name");

  // VIEW STATE: 'list' | 'detail' | 'form'
  const [viewMode, setViewMode] = useState<"list" | "detail" | "form">("list");
  const [selectedItem, setSelectedItem] = useState<NhanSu | null>(null);
  const [detailTab, setDetailTab] = useState("hoso");

  const [bulkMode, setBulkMode] = useState(false);
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [confirmDelete, setConfirmDelete] = useState<{
    show: boolean;
    ids: string[];
  }>({ show: false, ids: [] });

  const [formData, setFormData] = useState<Partial<NhanSu>>({});
  const [saving, setSaving] = useState(false);

  // ========== FETCH DATA ==========
  const fetchData = useCallback(async () => {
    setLoading(true);
    try {
      // 🛠️ FIX: Kiểm tra kỹ dataSource.fetchList có tồn tại không
      if (config.dataSource?.fetchList) {
        const res = await config.dataSource.fetchList(1, 50, "", "");
        if (res.success && res.data) setItems(res.data);
      }
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  }, [config.dataSource]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  // ========== TABS với COUNT ==========
  const tabs = useMemo(() => {
    const counts: Record<string, number> = { all: items.length };
    config.filterTabs?.forEach((tab) => {
      // Kiểm tra an toàn trước khi truy cập
      if (tab.id && tab.filterField) {
        counts[tab.id] = items.filter(
          (i) => (i as any)[tab.filterField!] === tab.id
        ).length;
      }
    });

    const dynamicTabs =
      config.filterTabs?.map((t) => ({
        id: t.id || "", // Fallback ID rỗng
        label: t.label,
        count: t.id ? counts[t.id] || 0 : 0,
      })) || [];

    return [{ id: "all", label: "TẤT CẢ", count: counts.all }, ...dynamicTabs];
  }, [items, config.filterTabs]);

  // ========== FILTERED & SORTED ==========
  const filteredList = useMemo(() => {
    let result = items;

    // Filter by tab
    if (activeTab !== "all") {
      result = result.filter((i) => i.vi_tri_normalized === activeTab);
    }

    // Search
    if (searchTerm) {
      const term = toNonAccent(searchTerm);
      result = result.filter((i) => {
        const hoTen = toNonAccent(i.ho_ten || "");
        const match =
          hoTen.includes(term) ||
          (i.so_dien_thoai || "").includes(term) ||
          toNonAccent(i.email || "").includes(term);
        return match;
      });
    }

    // Sort
    const sortOpt = config.sortOptions?.find((s) => s.key === sortBy);
    if (sortOpt?.sortFn) {
      result = [...result].sort(sortOpt.sortFn);
    }

    return result;
  }, [items, activeTab, searchTerm, sortBy, config.sortOptions]);

  // ========== HANDLERS ==========
  const handleOpenDetail = (item: NhanSu) => {
    setSelectedItem(item);
    setDetailTab("hoso");
    setViewMode("detail");
  };

  const handleOpenForm = (item?: NhanSu) => {
    setFormData(item ? { ...item } : {});
    setSelectedItem(item || null);
    setViewMode("form");
  };

  const handleBackToList = () => {
    setViewMode("list");
    setSelectedItem(null);
  };

  const handleSave = async () => {
    setSaving(true);
    try {
      // 🛠️ FIX: Kiểm tra create/update có tồn tại không
      if (selectedItem?.id) {
        if (config.dataSource?.update) {
          await config.dataSource.update(selectedItem.id, formData);
        }
      } else {
        if (config.dataSource?.create) {
          await config.dataSource.create(formData);
        }
      }
      await fetchData();
      handleBackToList();
    } catch (e) {
      console.error(e);
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (ids: string[]) => {
    // 🛠️ FIX: Kiểm tra delete có tồn tại không
    if (config.dataSource?.delete) {
      for (const id of ids) {
        await config.dataSource.delete(id);
      }
      await fetchData();
      setSelectedIds(new Set());
      setConfirmDelete({ show: false, ids: [] });
      handleBackToList();
    }
  };

  const toggleSelect = (id: string) => {
    const newSet = new Set(selectedIds);
    if (newSet.has(id)) newSet.delete(id);
    else newSet.add(id);
    setSelectedIds(newSet);
  };

  // ========== DETAIL TABS COUNT ==========
  const detailTabCounts = useMemo(
    () => ({
      hoso: 3,
      luong: 3,
      nganhang: 2,
    }),
    []
  );

  // ========== RENDER ==========
  return (
    <div className={`h-full ${className}`}>
      {/* ====== CHẾ ĐỘ DANH SÁCH ====== */}
      {viewMode === "list" && (
        <KhungDanhSach
          tabs={tabs}
          activeTab={activeTab}
          onTabChange={setActiveTab}
          onSearch={setSearchTerm} // 🛠️ FIX: Đã xóa searchPlaceholder gây lỗi
          sortOptions={
            config.sortOptions?.map((s) => ({ key: s.key, label: s.label })) ||
            []
          }
          activeSort={sortBy}
          onSortChange={setSortBy}
          showAddButton={allowEdit}
          onAdd={() => handleOpenForm()}
          bulkMode={bulkMode}
          onBulkModeToggle={
            allowBulk ? () => setBulkMode(!bulkMode) : undefined
          }
          selectedCount={selectedIds.size}
          onSelectAll={() =>
            setSelectedIds(new Set(filteredList.map((i) => i.id)))
          }
          onClearSelection={() => setSelectedIds(new Set())}
          bulkActions={
            allowDelete
              ? [
                  {
                    id: "delete",
                    label: "XÓA",
                    icon: Trash2,
                    color: "danger",
                    onClick: () =>
                      setConfirmDelete({
                        show: true,
                        ids: Array.from(selectedIds),
                      }),
                  },
                ]
              : []
          }
          loading={loading}
        >
          {/* Cards */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 p-4">
            {filteredList.map((item) => (
              <div
                key={item.id}
                onClick={() => !bulkMode && handleOpenDetail(item)}
                className={`group relative bg-[#0f0f0f] border rounded-xl overflow-hidden cursor-pointer transition-all hover:border-[#C69C6D]/50 hover:shadow-lg ${
                  selectedIds.has(item.id)
                    ? "border-[#C69C6D] bg-[#C69C6D]/5"
                    : "border-white/10"
                }`}
              >
                {/* Bulk checkbox */}
                {bulkMode && (
                  <div
                    onClick={(e) => {
                      e.stopPropagation();
                      toggleSelect(item.id);
                    }}
                    className="absolute top-3 right-3 z-10"
                  >
                    <div
                      className={`w-5 h-5 rounded border-2 flex items-center justify-center transition-colors ${
                        selectedIds.has(item.id)
                          ? "bg-[#C69C6D] border-[#C69C6D]"
                          : "border-white/30 bg-black/50"
                      }`}
                    >
                      {selectedIds.has(item.id) && (
                        <span className="text-black text-xs">✓</span>
                      )}
                    </div>
                  </div>
                )}

                <div className="p-4 flex items-center gap-4">
                  {/* Avatar */}
                  <div className="w-14 h-14 rounded-full bg-[#1a1a1a] border-2 border-[#C69C6D]/30 overflow-hidden shrink-0">
                    {item.hinh_anh ? (
                      <img
                        src={item.hinh_anh}
                        alt=""
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center text-[#C69C6D]/50">
                        <User size={24} />
                      </div>
                    )}
                  </div>

                  {/* Info */}
                  <div className="flex-1 min-w-0">
                    <h3 className="font-bold text-white truncate">
                      {item.ho_ten}
                    </h3>
                    <p className="text-xs text-[#C69C6D] truncate">
                      {item.vi_tri}
                    </p>
                    <p className="text-xs text-white/40 truncate mt-1">
                      <Phone size={10} className="inline mr-1" />
                      {item.so_dien_thoai || "---"}
                    </p>
                  </div>
                </div>
              </div>
            ))}

            {filteredList.length === 0 && !loading && (
              <div className="col-span-full py-20 text-center text-white/30">
                Không có dữ liệu
              </div>
            )}
          </div>
        </KhungDanhSach>
      )}

      {/* ====== CHẾ ĐỘ CHI TIẾT ====== */}
      {viewMode === "detail" && selectedItem && (
        <KhungChiTiet
          data={selectedItem}
          onClose={handleBackToList}
          avatar={selectedItem.hinh_anh}
          avatarFallback={<User size={10} className="text-[#C69C6D]/50" />}
          title={selectedItem.ho_ten}
          tabs={[
            { id: "hoso", label: "HỒ SƠ" },
            { id: "luong", label: "LƯƠNG" },
            { id: "nganhang", label: "NGÂN HÀNG" },
          ]}
          activeTab={detailTab}
          onTabChange={setDetailTab}
          tabCounts={detailTabCounts}
          showEditButton={allowEdit}
          showDeleteButton={allowDelete}
          onEdit={() => handleOpenForm(selectedItem)}
          onDelete={() =>
            setConfirmDelete({ show: true, ids: [selectedItem.id] })
          }
        >
          <div className="p-4">
            {detailTab === "hoso" && (
              <div className="space-y-3">
                <InfoRow icon={Mail} label="EMAIL" value={selectedItem.email} />
                <InfoRow
                  icon={Phone}
                  label="SỐ ĐIỆN THOẠI"
                  value={selectedItem.so_dien_thoai}
                />
                <InfoRow
                  icon={Briefcase}
                  label="VỊ TRÍ"
                  value={selectedItem.vi_tri}
                />
              </div>
            )}
            {detailTab === "luong" && (
              <div className="space-y-3">
                <InfoRow
                  icon={Banknote}
                  label="LƯƠNG THÁNG"
                  value={formatMoney(selectedItem.luong_thang)}
                  highlight
                />
                <InfoRow
                  icon={Banknote}
                  label="LƯƠNG THEO GIỜ"
                  value={formatMoney(selectedItem.luong_theo_gio)}
                />
                <InfoRow
                  icon={Banknote}
                  label="THƯỞNG DOANH SỐ"
                  value={`${selectedItem.thuong_doanh_thu || 0}%`}
                />
              </div>
            )}
            {detailTab === "nganhang" && (
              <div className="space-y-3">
                <InfoRow
                  icon={Banknote}
                  label="NGÂN HÀNG"
                  value={selectedItem.ngan_hang}
                />
                <InfoRow
                  icon={Banknote}
                  label="SỐ TÀI KHOẢN"
                  value={selectedItem.so_tai_khoan}
                />
              </div>
            )}
          </div>
        </KhungChiTiet>
      )}

      {/* ====== CHẾ ĐỘ FORM ====== */}
      {viewMode === "form" && (
        <KhungForm
          isEditing={!!selectedItem}
          data={formData}
          onClose={handleBackToList}
          title={selectedItem ? selectedItem.ho_ten : "THÊM NHÂN SỰ"}
          avatar={selectedItem?.hinh_anh}
          avatarFallback={<User size={10} className="text-[#C69C6D]/50" />}
          showAvatarUpload={true}
          onSubmit={handleSave}
          loading={saving}
          isDirty={Object.keys(formData).length > 0}
        >
          <div className="space-y-4">
            <FormField label="Họ và Tên" required>
              <input
                type="text"
                value={formData.ho_ten || ""}
                onChange={(e) =>
                  setFormData({ ...formData, ho_ten: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                placeholder="Nhập họ tên..."
              />
            </FormField>

            <FormField label="Vị trí" required>
              <input
                type="text"
                value={formData.vi_tri || ""}
                onChange={(e) =>
                  setFormData({ ...formData, vi_tri: e.target.value })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                placeholder="Nhập vị trí..."
              />
            </FormField>

            <div className="grid grid-cols-2 gap-4">
              <FormField label="Email">
                <input
                  type="email"
                  value={formData.email || ""}
                  onChange={(e) =>
                    setFormData({ ...formData, email: e.target.value })
                  }
                  className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                  placeholder="email@..."
                />
              </FormField>
              <FormField label="Số điện thoại">
                <input
                  type="tel"
                  value={formData.so_dien_thoai || ""}
                  onChange={(e) =>
                    setFormData({ ...formData, so_dien_thoai: e.target.value })
                  }
                  className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                  placeholder="09..."
                />
              </FormField>
            </div>

            <FormField label="Lương tháng (VNĐ)">
              <input
                type="number"
                value={formData.luong_thang || ""}
                onChange={(e) =>
                  setFormData({
                    ...formData,
                    luong_thang: Number(e.target.value),
                  })
                }
                className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-white/30 focus:border-[#C69C6D]/50 focus:outline-none"
                placeholder="0"
              />
            </FormField>
          </div>
        </KhungForm>
      )}

      {/* ====== CONFIRM DELETE ====== */}
      <ConfirmDialog
        isOpen={confirmDelete.show}
        title="XÁC NHẬN XÓA"
        message={`Bạn có chắc muốn xóa ${confirmDelete.ids.length} nhân sự?`}
        onConfirm={() => handleDelete(confirmDelete.ids)}
        onCancel={() => setConfirmDelete({ show: false, ids: [] })}
      />
    </div>
  );
}

// ============================================================
// SUB-COMPONENTS
// ============================================================

function InfoRow({
  icon: Icon,
  label,
  value,
  highlight,
}: {
  icon: any;
  label: string;
  value?: string;
  highlight?: boolean;
}) {
  return (
    <div className="flex items-center gap-3 p-3 rounded-xl bg-[#151515] border border-white/5">
      <div
        className={`p-2 rounded-lg ${
          highlight
            ? "bg-[#C69C6D]/20 text-[#C69C6D]"
            : "bg-black text-[#C69C6D]"
        }`}
      >
        <Icon size={16} />
      </div>
      <div className="flex-1 min-w-0">
        <p className="text-[9px] font-black uppercase tracking-wider text-white/40 mb-0.5">
          {label}
        </p>
        <p
          className={`text-sm font-bold truncate ${
            highlight ? "text-[#C69C6D]" : "text-gray-200"
          }`}
        >
          {value || "---"}
        </p>
      </div>
    </div>
  );
}

function FormField({
  label,
  required,
  children,
}: {
  label: string;
  required?: boolean;
  children: React.ReactNode;
}) {
  return (
    <div>
      <label className="block text-xs font-bold text-white/60 uppercase tracking-wider mb-2">
        {label} {required && <span className="text-red-400">*</span>}
      </label>
      {children}
    </div>
  );
}
</file>

<file path="app/CongDangNhap/ChanForm.tsx">
'use client';

import React from 'react';

interface Props {
    onSupportClick?: () => void;
}

export default function ChanForm({ onSupportClick }: Props) {
    return (
        <div className="w-full flex flex-col items-center gap-3 mt-6 animate-in fade-in duration-700 delay-300">
            {/* Đường kẻ mờ tinh tế */}
            <div className="w-24 h-[1px] bg-gradient-to-r from-transparent via-[#8B5E3C] to-transparent opacity-50"></div>
            
            <div className="flex flex-col items-center gap-1 text-[10px] uppercase tracking-widest font-medium text-white/30 font-serif">
                <span>Được kiến tạo bởi</span>
                <span className="text-[#C69C6D] font-bold drop-shadow-md tracking-[0.2em]">Tommy Nghiêm Art</span>
            </div>
            
            {/* Nút Hỗ trợ */}
            <button 
                type="button" 
                onClick={onSupportClick}
                className="text-[10px] text-gray-600 hover:text-white transition-colors cursor-pointer mt-2 hover:underline decoration-dotted underline-offset-4"
            >
                Gặp sự cố đăng nhập?
            </button>
        </div>
    );
}
</file>

<file path="app/ThuVien/AppSettingsContext.tsx">
'use client';
import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';

// =====================================================
// TYPES
// =====================================================
export type ThemeMode = 'dark' | 'light';
export type LanguageCode = 'vi' | 'en';

interface AppSettings {
  theme: ThemeMode;
  language: LanguageCode;
}

interface AppSettingsContextType {
  // State
  theme: ThemeMode;
  language: LanguageCode;
  
  // Actions
  setTheme: (theme: ThemeMode) => void;
  setLanguage: (language: LanguageCode) => void;
  toggleTheme: () => void;
  
  // Helpers
  isDark: boolean;
  isVietnamese: boolean;
  
  // Translation function
  t: (key: string) => string;
}// =====================================================
// TRANSLATIONS (ĐÃ THỔI HỒN NGHỆ THUẬT)
// =====================================================
const translations: Record<LanguageCode, Record<string, string>> = {
  vi: {
    // Chung - Tông giọng trang trọng
    'app.name': 'NghiemArt Management',
    'app.loading': 'Đang khởi tạo...',
    'app.error': 'Đã có sự cố',
    'app.save': 'Lưu Tác Phẩm',
    'app.cancel': 'Hủy Bỏ',
    'app.confirm': 'Xác Nhận',
    'app.close': 'Đóng Lại',
    'app.back': 'Trở Về',
    'app.next': 'Tiếp Tục',
    'app.done': 'Hoàn Tất',
    'app.edit': 'Hiệu Chỉnh',
    'app.delete': 'Loại Bỏ',
    'app.search': 'Tìm kiếm tinh hoa...',
    'app.refresh': 'Làm Mới',
    'app.noData': 'Chưa có dữ liệu trưng bày',
    
    // Navigation - Định danh không gian
    'nav.home': 'Sảnh Chính',
    'nav.account': 'Hồ Sơ Nghệ Nhân',
    'nav.notifications': 'Thư Tín',
    'nav.department': 'Không Gian',
    
    // Auth - Lời chào mời
    'auth.login': 'Tiếp Bước',
    'auth.loginRegister': 'Đăng Nhập / Gia Nhập',
    'auth.logout': 'Rời Cõi Nghệ',
    'auth.logoutConfirm': 'Quý vị muốn kết thúc phiên làm việc?',
    'auth.loggingOut': 'Đang đăng xuất...',
    'auth.loginFailed': 'Chưa thể truy cập',
    'auth.loginError': 'Thông tin định danh chưa chính xác.',
    'auth.needHelp': 'Cần hỗ trợ kỹ thuật?',
    'auth.enterEmail': 'Email định danh',
    'auth.enterPassword': 'Mật khẩu bảo mật',
    'auth.forgotPassword': 'Quên mật khẩu?',
    'auth.rememberMe': 'Ghi nhớ phiên này',
    
    // Profile Modal
    'profile.title': 'Hồ Sơ Cá Nhân',
    'profile.settings': 'Thiết Lập Hệ Thống',
    'profile.settingsDesc': 'Ngôn ngữ & Giao diện',
    'profile.myProfile': 'Thông Tin Của Tôi',
    'profile.myProfileDescStaff': 'Chức vụ & Thành tựu',
    'profile.myProfileDescCustomer': 'Lịch sử sưu tầm',
    'profile.personalInfo': 'Sơ Yếu Lý Lịch',
    'profile.personalInfoDesc': 'Thông tin liên hệ chính',
    'profile.achievements': 'Bảng Vàng',
    'profile.achievementsDesc': 'Ghi nhận đóng góp',
    'profile.orders': 'Bộ Sưu Tập Đã Mua',
    'profile.ordersDesc': 'Các tác phẩm sở hữu',
    'profile.editInfo': 'Cập nhật thông tin',
    'profile.user': 'Thành viên',
    
    // Fields
    'field.fullName': 'Họ và Tên',
    'field.email': 'Thư điện tử',
    'field.phone': 'Số điện thoại',
    'field.address': 'Địa chỉ liên hệ',
    'field.idCard': 'Định danh công dân',
    'field.notUpdated': '---',
    
    // Settings
    'settings.language': 'Ngôn Ngữ',
    'settings.theme': 'Sắc Thái',
    'settings.themeDark': 'Huyền Bí (Tối)',
    'settings.themeDarkDesc': 'Tăng chiều sâu, dịu mắt',
    'settings.themeLight': 'Thanh Tao (Sáng)',
    'settings.themeLightDesc': 'Rực rỡ, rõ ràng',
    
    // Orders
    'orders.title': 'Đơn Đặt Tác Phẩm',
    'orders.empty': 'Chưa có tác phẩm nào',
    'orders.emptyDesc': 'Quý khách chưa sở hữu tác phẩm nào.',
    
    // Achievements
    'achievements.title': 'Thành Tựu',
    'achievements.developing': 'Đang kiến tạo...',
    'achievements.points': 'Điểm Cống Hiến',
    'achievements.badges': 'Huân Chương',
    'achievements.noBadges': 'Chưa đạt',
    
    // Notifications
    'notifications.title': 'Thông Báo',
    'notifications.empty': 'Hộp thư trống',
    'notifications.markAllRead': 'Đã xem tất cả',
    'notifications.new': 'Mới',
    
    // Homepage
    'home.welcome': 'Hân hạnh đón tiếp',
    'home.goodMorning': 'Chúc ngày mới rực rỡ',
    'home.goodAfternoon': 'Chúc buổi chiều an lành',
    'home.goodEvening': 'Chúc buổi tối ấm áp',
    'home.guest': 'Quý Thưởng Khách',
    
    // Rooms/Departments - Tên phòng ban nghệ thuật
    'room.admin': 'Đài Quản Trị',
    'room.manager': 'Phòng Điều Hành',
    'room.parttime': 'Không Gian Sáng Tạo',
    'room.showroom': 'Phòng Trưng Bày',
    'room.vip': 'Phòng Thượng Khách',
  },
  en: {
    // Common
    'app.name': 'NghiemArt System',
    'app.loading': 'Initializing...',
    'app.error': 'An error occurred',
    'app.save': 'Save Artwork',
    'app.cancel': 'Cancel',
    'app.confirm': 'Confirm',
    'app.close': 'Close',
    'app.back': 'Return',
    'app.next': 'Next',
    'app.done': 'Completed',
    'app.edit': 'Modify',
    'app.delete': 'Remove',
    'app.search': 'Search masterpieces...',
    'app.refresh': 'Refresh',
    'app.noData': 'No data available',
    
    // Navigation
    'nav.home': 'Grand Hall',
    'nav.account': 'Artisan Profile',
    'nav.notifications': 'Messages',
    'nav.department': 'Studio',
    
    // Auth
    'auth.login': 'Enter',
    'auth.loginRegister': 'Login / Join',
    'auth.logout': 'Leave Studio',
    'auth.logoutConfirm': 'Do you wish to end your session?',
    'auth.loggingOut': 'Leaving...',
    'auth.loginFailed': 'Access Denied',
    'auth.loginError': 'Incorrect credentials.',
    'auth.needHelp': 'Need assistance?',
    'auth.enterEmail': 'Your Email',
    'auth.enterPassword': 'Your Password',
    'auth.forgotPassword': 'Lost Key?',
    'auth.rememberMe': 'Remember me',
    
    // Profile
    'profile.title': 'My Dossier',
    'profile.settings': 'Configuration',
    'profile.settingsDesc': 'Language & Aesthetics',
    'profile.myProfile': 'My Portfolio',
    'profile.myProfileDescStaff': 'Career & Awards',
    'profile.myProfileDescCustomer': 'Collection History',
    'profile.personalInfo': 'Biography',
    'profile.personalInfoDesc': 'Contact details',
    'profile.achievements': 'Honors',
    'profile.achievementsDesc': 'Points & Medals',
    'profile.orders': 'Acquisitions',
    'profile.ordersDesc': 'Artwork history',
    'profile.editInfo': 'Update Bio',
    'profile.user': 'Member',
    
    // Fields
    'field.fullName': 'Full Name',
    'field.email': 'Email',
    'field.phone': 'Contact Number',
    'field.address': 'Address',
    'field.idCard': 'ID / Passport',
    'field.notUpdated': '---',
    
    // Settings
    'settings.language': 'Language',
    'settings.theme': 'Ambiance',
    'settings.themeDark': 'Mystic (Dark)',
    'settings.themeDarkDesc': 'Deep & Elegant',
    'settings.themeLight': 'Radiant (Light)',
    'settings.themeLightDesc': 'Bright & Clear',
    
    // Orders
    'orders.title': 'Orders',
    'orders.empty': 'No acquisitions yet',
    'orders.emptyDesc': 'Your collection is empty',
    
    // Achievements
    'achievements.title': 'Achievements',
    'achievements.developing': 'Coming soon...',
    'achievements.points': 'Tribute Points',
    'achievements.badges': 'Badges',
    'achievements.noBadges': 'None',
    
    // Notifications
    'notifications.title': 'Notifications',
    'notifications.empty': 'Silence',
    'notifications.markAllRead': 'Mark all read',
    'notifications.new': 'New',
    
    // Homepage
    'home.welcome': 'Welcome',
    'home.goodMorning': 'Splendid Morning',
    'home.goodAfternoon': 'Good Afternoon',
    'home.goodEvening': 'Tranquil Evening',
    'home.guest': 'Distinguished Guest',
    
    // Rooms
    'room.admin': 'Command Center',
    'room.manager': 'Operations',
    'room.parttime': 'Creative Space',
    'room.showroom': 'Gallery',
    'room.vip': 'VIP Lounge',
  },
};
// =====================================================
// LOCAL STORAGE KEYS
// =====================================================
const STORAGE_KEYS = {
  theme: 'app_theme',
  language: 'app_language',
};

// =====================================================
// CONTEXT
// =====================================================
const AppSettingsContext = createContext<AppSettingsContextType | undefined>(undefined);

// =====================================================
// PROVIDER
// =====================================================
export function AppSettingsProvider({ children }: { children: ReactNode }) {
  const [theme, setThemeState] = useState<ThemeMode>('dark');
  const [language, setLanguageState] = useState<LanguageCode>('vi');
  const [isHydrated, setIsHydrated] = useState(false);

  // Load settings từ localStorage khi mount
  useEffect(() => {
    const savedTheme = localStorage.getItem(STORAGE_KEYS.theme) as ThemeMode;
    const savedLanguage = localStorage.getItem(STORAGE_KEYS.language) as LanguageCode;
    
    if (savedTheme && ['dark', 'light'].includes(savedTheme)) {
      setThemeState(savedTheme);
    }
    if (savedLanguage && ['vi', 'en'].includes(savedLanguage)) {
      setLanguageState(savedLanguage);
    }
    
    setIsHydrated(true);
  }, []);

  // Apply theme to document
  useEffect(() => {
    if (!isHydrated) return;
    
    const root = document.documentElement;
    const body = document.body;
    
    if (theme === 'light') {
      root.classList.add('light-theme');
      root.classList.remove('dark-theme');
      body.style.backgroundColor = '#f5f5f5';
      body.style.color = '#1a1a1a';
    } else {
      root.classList.add('dark-theme');
      root.classList.remove('light-theme');
      body.style.backgroundColor = '#000000';
      body.style.color = '#ffffff';
    }
    
    // Lưu vào localStorage
    localStorage.setItem(STORAGE_KEYS.theme, theme);
  }, [theme, isHydrated]);

  // Save language to localStorage
  useEffect(() => {
    if (!isHydrated) return;
    localStorage.setItem(STORAGE_KEYS.language, language);
    document.documentElement.lang = language;
  }, [language, isHydrated]);

  const setTheme = (newTheme: ThemeMode) => {
    setThemeState(newTheme);
  };

  const setLanguage = (newLanguage: LanguageCode) => {
    setLanguageState(newLanguage);
  };

  const toggleTheme = () => {
    setThemeState(prev => prev === 'dark' ? 'light' : 'dark');
  };

  // Translation function
  const t = (key: string): string => {
    return translations[language][key] || key;
  };

  const value: AppSettingsContextType = {
    theme,
    language,
    setTheme,
    setLanguage,
    toggleTheme,
    isDark: theme === 'dark',
    isVietnamese: language === 'vi',
    t,
  };

  return (
    <AppSettingsContext.Provider value={value}>
      {children}
    </AppSettingsContext.Provider>
  );
}

// =====================================================
// HOOK
// =====================================================
export function useAppSettings() {
  const context = useContext(AppSettingsContext);
  if (context === undefined) {
    throw new Error('useAppSettings must be used within an AppSettingsProvider');
  }
  return context;
}

// =====================================================
// CSS VARIABLES (thêm vào globals.css)
// =====================================================
/*
Thêm vào globals.css:

:root {
  --bg-primary: #000000;
  --bg-secondary: #0A0A0A;
  --bg-tertiary: #1A1A1A;
  --text-primary: #ffffff;
  --text-secondary: rgba(255, 255, 255, 0.6);
  --text-muted: rgba(255, 255, 255, 0.3);
  --border-color: rgba(255, 255, 255, 0.1);
  --accent: #C69C6D;
  --accent-light: #F2D3A0;
}

.light-theme {
  --bg-primary: #ffffff;
  --bg-secondary: #f5f5f5;
  --bg-tertiary: #e5e5e5;
  --text-primary: #1a1a1a;
  --text-secondary: rgba(0, 0, 0, 0.6);
  --text-muted: rgba(0, 0, 0, 0.3);
  --border-color: rgba(0, 0, 0, 0.1);
  --accent: #C69C6D;
  --accent-light: #F2D3A0;
}
*/
</file>

<file path="app/trangchu/NutDatHang.tsx">
'use client';

import React from 'react';
import { useRouter } from 'next/navigation';
import { ShoppingBag, ArrowRight } from 'lucide-react';

export default function NutDatHang() {
  const router = useRouter();

  return (
    <button 
      onClick={() => router.push('/dathang')}
      className="group relative px-8 py-3 bg-[#C69C6D] hover:bg-[#B58B5D] text-black font-bold text-sm md:text-base uppercase tracking-widest rounded-full shadow-[0_0_20px_rgba(198,156,109,0.3)] hover:shadow-[0_0_30px_rgba(198,156,109,0.5)] transition-all duration-300 flex items-center gap-3 overflow-hidden transform hover:-translate-y-1 active:scale-95"
    >
      {/* Hiệu ứng quét sáng (Shimmer effect) */}
      <div className="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/30 to-transparent -translate-x-[150%] group-hover:translate-x-[150%] transition-transform duration-700 ease-in-out" />
      
      <ShoppingBag size={18} className="shrink-0" />
      <span className="relative z-10">Khám Phá Tác Phẩm</span>
      <ArrowRight size={18} className="shrink-0 group-hover:translate-x-1 transition-transform" />
    </button>
  );
}
</file>

<file path="app/trangchu/slider1.tsx">
'use client';

import React, { useState, useEffect, useRef } from 'react';
import { ChevronLeft, ChevronRight, Edit, Trash2, Plus, Save, X, Image as ImageIcon } from 'lucide-react';
import { supabase } from '@/app/ThuVien/ketNoiSupabase';
import { compressImage } from '@/app/ThuVien/compressImage'; 

interface SlideData {
  id: number;
  tieu_de: string;
  mo_ta: string;
  hinh_anh: string;
}

export default function Slider1() {
  const [slides, setSlides] = useState<SlideData[]>([]);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [isAdmin, setIsAdmin] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  
  // State cho form
  const [editForm, setEditForm] = useState<{ title: string; desc: string; file: File | null; previewUrl: string }>({
    title: '', desc: '', file: null, previewUrl: ''
  });
  const [isLoading, setIsLoading] = useState(false);

  // Load dữ liệu lần đầu
  useEffect(() => {
    fetchSlides();
    checkAdmin();
  }, []);

  // Kiểm tra quyền từ LocalStorage
  const checkAdmin = () => {
    if (typeof window !== 'undefined') {
        const role = localStorage.getItem('USER_ROLE');
        // Nếu là admin hoặc quản lý thì hiện nút sửa
        if (role === 'admin' || role === 'quan_ly') setIsAdmin(true);
    }
  };

  // Hàm lấy dữ liệu từ Supabase
  const fetchSlides = async () => {
    const { data, error } = await supabase
      .from('slider_data')
      .select('*')
      .eq('loai_slider', 'slider1')
      .order('tao_luc', { ascending: false });
    
    if (error) {
        console.error("Lỗi tải slider:", error);
    } else if (data && data.length > 0) {
        setSlides(data);
    } else {
        // Dữ liệu mẫu hiển thị khi chưa có DB
        setSlides([{
            id: 0, 
            tieu_de: "NGHỆ THUẬT TRANH GẠO", 
            mo_ta: "Chưa có dữ liệu, vui lòng thêm mới.", 
            hinh_anh: "https://images.unsplash.com/photo-1513364776144-60967b0f800f?q=80&w=1000&auto=format&fit=crop"
        }]);
    }
  };

  // Logic chuyển slide
  const prevSlide = () => setCurrentIndex((prev) => (prev === 0 ? slides.length - 1 : prev - 1));
  const nextSlide = () => setCurrentIndex((prev) => (prev === slides.length - 1 ? 0 : prev + 1));

  // Logic chọn file và nén ảnh
  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      const originalFile = e.target.files[0];
      try {
        // Nén ảnh xuống còn tối đa 1920px chiều rộng
        const compressed = await compressImage(originalFile, 0.8, 1920); 
        setEditForm(prev => ({ ...prev, file: compressed, previewUrl: URL.createObjectURL(compressed) }));
      } catch (err) {
        console.error("Lỗi nén ảnh:", err);
        alert("Không thể xử lý ảnh này.");
      }
    }
  };

  // Logic Lưu Slide (Quan trọng)
  const handleSave = async () => {
    if (!editForm.file && !isEditing) return alert("Vui lòng chọn ảnh!");
    setIsLoading(true);

    try {
      let imageUrl = editForm.previewUrl;

      // 1. Upload ảnh nếu có file mới
      if (editForm.file) {
        const fileName = `slider1-${Date.now()}.jpg`;
        // Upload lên bucket 'slider'
        const { data, error: uploadError } = await supabase.storage.from('slider').upload(fileName, editForm.file);
        
        if (uploadError) {
             console.error("Lỗi Upload:", uploadError);
             throw new Error(`Lỗi Upload Storage: ${uploadError.message}. Bạn cần chạy lệnh SQL cấp quyền Storage.`);
        }
        
        const { data: publicUrl } = supabase.storage.from('slider').getPublicUrl(fileName);
        imageUrl = publicUrl.publicUrl;
      }

      // 2. Insert vào bảng slider_data
      const newSlide = {
        loai_slider: 'slider1',
        tieu_de: editForm.title,
        mo_ta: editForm.desc,
        hinh_anh: imageUrl
      };

      const { error: insertError } = await supabase.from('slider_data').insert([newSlide]);
      
      // Bắt lỗi Permission cụ thể để thông báo
      if (insertError) {
          console.error("Lỗi Insert:", insertError);
          if (insertError.code === '42501' || insertError.message.includes('permission denied')) {
              throw new Error("Lỗi Quyền (42501): Bạn CHƯA chạy lệnh SQL mở khóa bảng slider_data. Vui lòng copy lệnh SQL ở trên và chạy trong Supabase SQL Editor.");
          }
          throw insertError;
      }

      alert("Thêm mới thành công!");
      setIsEditing(false);
      setEditForm({ title: '', desc: '', file: null, previewUrl: '' });
      fetchSlides(); // Reload lại danh sách
    } catch (err: any) {
      alert(err.message);
    } finally {
      setIsLoading(false);
    }
  };

  // Logic Xóa Slide
  const handleDelete = async (id: number) => {
      if(!confirm("Bạn chắc chắn muốn xóa slide này?")) return;
      const { error } = await supabase.from('slider_data').delete().eq('id', id);
      if (error) {
          alert("Lỗi xóa: " + error.message);
      } else {
          fetchSlides();
          if (currentIndex >= slides.length - 1) setCurrentIndex(0);
      }
  };

  return (
    <div className="relative w-full h-full group/slider flex flex-col items-center justify-center">
      
      {/* KHUNG GỖ CAO CẤP */}
      <div className="relative w-full h-full overflow-hidden rounded-lg shadow-2xl"
           style={{
               border: '12px solid #5D4037', 
               boxShadow: 'inset 0 0 20px rgba(0,0,0,0.8), 0 10px 30px rgba(0,0,0,0.5)',
               backgroundImage: 'linear-gradient(45deg, #5D4037 25%, #4E342E 25%, #4E342E 50%, #5D4037 50%, #5D4037 75%, #4E342E 75%, #4E342E 100%)',
               backgroundSize: '20px 20px' 
           }}
      >
        {/* Viền vàng trang trí */}
        <div className="absolute inset-0 border-[2px] border-[#FFD700] opacity-50 pointer-events-none z-20 m-1"></div>

        {/* NỘI DUNG SLIDE */}
        <div className="relative w-full h-full bg-black">
            {slides.map((slide, index) => (
            <div
                key={slide.id || index}
                className={`absolute inset-0 w-full h-full transition-opacity duration-700 ease-in-out ${index === currentIndex ? 'opacity-100 z-10' : 'opacity-0 z-0'}`}
            >
                <img src={slide.hinh_anh} alt={slide.tieu_de} className="w-full h-full object-cover opacity-80" />
                <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent" />
                
                {/* Text Content: Có Stroke & Shadow */}
                <div className="absolute bottom-16 left-8 right-8 text-center md:text-left">
                    <h2 
                        className="text-3xl md:text-5xl font-serif text-[#F5F5F5] mb-2 drop-shadow-[0_4px_4px_rgba(0,0,0,1)]"
                        style={{ WebkitTextStroke: '1px rgba(0,0,0,0.5)' }}
                    >
                        {slide.tieu_de}
                    </h2>
                    <p 
                        className="text-[#E8D4B9] text-sm md:text-lg font-light drop-shadow-[0_2px_2px_rgba(0,0,0,1)]"
                    >
                        {slide.mo_ta}
                    </p>
                </div>

                {/* Nút Xóa (Admin Only) */}
                {isAdmin && slide.id !== 0 && (
                    <button onClick={() => handleDelete(slide.id)} className="absolute top-4 right-4 z-50 p-2 bg-red-600/80 text-white rounded hover:bg-red-500 shadow-lg border border-white/20">
                        <Trash2 size={16}/>
                    </button>
                )}
            </div>
            ))}
        </div>

        {/* NÚT ĐIỀU HƯỚNG */}
        <button onClick={prevSlide} className="absolute left-4 top-1/2 -translate-y-1/2 z-30 p-3 bg-black/40 border border-[#C69C6D] text-[#C69C6D] hover:bg-[#C69C6D] hover:text-black transition-all rounded-full opacity-0 group-hover/slider:opacity-100 active:scale-95">
            <ChevronLeft size={24} />
        </button>
        <button onClick={nextSlide} className="absolute right-4 top-1/2 -translate-y-1/2 z-30 p-3 bg-black/40 border border-[#C69C6D] text-[#C69C6D] hover:bg-[#C69C6D] hover:text-black transition-all rounded-full opacity-0 group-hover/slider:opacity-100 active:scale-95">
            <ChevronRight size={24} />
        </button>
      </div>

      {/* FORM ADMIN THÊM MỚI */}
      {isAdmin && (
        <div className="absolute top-4 left-4 z-50">
            {!isEditing ? (
                <button onClick={() => setIsEditing(true)} className="flex items-center gap-2 bg-[#C69C6D] text-black px-4 py-2 rounded-md font-bold text-xs shadow-lg hover:bg-white transition-colors border-2 border-white/20 active:scale-95">
                    <Plus size={14}/> Thêm Slide Mới
                </button>
            ) : (
                <div className="bg-black/95 p-4 rounded-lg border border-[#C69C6D] w-[300px] shadow-[0_0_30px_rgba(0,0,0,0.8)] animate-fade-in-up backdrop-blur-md">
                    <div className="flex justify-between items-center mb-3 text-[#C69C6D] border-b border-white/10 pb-2">
                        <span className="font-bold text-sm uppercase">Thêm Slide Mới</span>
                        <button onClick={() => setIsEditing(false)} className="hover:text-white"><X size={16}/></button>
                    </div>
                    
                    <div className="space-y-3">
                        {/* Input Title */}
                        <input 
                            type="text" placeholder="Tiêu đề chính..." 
                            className="w-full bg-white/10 border border-white/20 rounded p-2 text-white text-xs focus:border-[#C69C6D] outline-none placeholder-white/30"
                            value={editForm.title} onChange={e => setEditForm({...editForm, title: e.target.value})}
                        />
                         {/* Input Desc */}
                        <textarea 
                            placeholder="Mô tả ngắn..." 
                            className="w-full bg-white/10 border border-white/20 rounded p-2 text-white text-xs focus:border-[#C69C6D] outline-none h-16 resize-none placeholder-white/30"
                            value={editForm.desc} onChange={e => setEditForm({...editForm, desc: e.target.value})}
                        />
                        {/* Input File */}
                        <div className="relative w-full h-28 border-2 border-dashed border-white/20 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-[#C69C6D] hover:bg-white/5 transition-colors overflow-hidden group/upload">
                            {editForm.previewUrl ? (
                                <img src={editForm.previewUrl} className="absolute inset-0 w-full h-full object-cover opacity-60" />
                            ) : <ImageIcon className="text-white/30 mb-1 group-hover/upload:text-[#C69C6D]"/>}
                            <span className="text-[10px] text-white/50 relative z-10 font-bold uppercase">{editForm.file ? "Đổi ảnh khác" : "Chọn ảnh (Tự nén)"}</span>
                            <input type="file" accept="image/*" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleFileChange} />
                        </div>

                        <button 
                            onClick={handleSave} disabled={isLoading}
                            className="w-full bg-[#C69C6D] text-black font-bold py-2.5 rounded text-xs hover:bg-white transition-colors flex justify-center items-center gap-2 disabled:opacity-50"
                        >
                            {isLoading ? "Đang lưu..." : <><Save size={14}/> LƯU SLIDE</>}
                        </button>
                    </div>
                </div>
            )}
        </div>
      )}
    </div>
  );
}
</file>

<file path="next.config.mjs">
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: false, // Tắt strict mode để kéo thả mượt hơn

  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '**', // "Trùm cuối": Chấp nhận ảnh từ mọi nguồn (Supabase, Unsplash, v.v.)
      },
    ],
  },
  
  // 🟢 QUAN TRỌNG: BỎ QUA LỖI KHI BUILD TRÊN VERCEL
  typescript: {
    ignoreBuildErrors: true,
  },
  eslint: {
    ignoreDuringBuilds: true,
  },
};

export default nextConfig;
</file>

<file path="tailwind.config.ts">
import type { Config } from "tailwindcss";

const config: Config = {
  content: [
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      fontFamily: {
        // 🟢 CẬP NHẬT: Sử dụng biến CSS từ Next.js Font
        // Class 'font-serif' sẽ dùng Playfair Display (có tiếng Việt)
        serif: ["var(--font-playfair)", "ui-serif", "Georgia", "serif"],

        // Class 'font-sans' sẽ dùng Inter (có tiếng Việt)
        sans: ["var(--font-inter)", "ui-sans-serif", "system-ui", "sans-serif"],

        // Giữ nguyên mono hoặc tùy chỉnh thêm nếu cần
        mono: ["Courier New", "monospace"],
      },
    },
  },
  plugins: [],
};
export default config;
</file>

<file path="app/actions/QuyenHanQuanLy.ts">
"use server";

import postgres from "postgres";
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";
// 👇 IMPORT MỚI
import { sendNotificationToRoles } from "./NotificationAction";

// Kết nối DB
const sql = postgres(process.env.DATABASE_URL!, {
  ssl: "require",
  max: 10,
  idle_timeout: 20,
});

// 🛡️ 1. CHECK QUYỀN QUẢN LÝ (ADMIN + BOSS + QUANLY)
async function requireManager() {
  const cookieStore = cookies();

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
        set() {},
        remove() {},
      },
    }
  );

  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user || !user.email) throw new Error("Unauthorized: Bạn chưa đăng nhập");

  // Lấy thông tin nhân sự
  const [nhanSu] = await sql`
        SELECT id, ho_ten, vi_tri, vi_tri_normalized 
        FROM nhan_su 
        WHERE lower(email) = lower(${user.email})
        LIMIT 1
    `;

  // ✅ DANH SÁCH QUYỀN ĐƯỢC PHÉP
  const allowedRoles = ["admin", "boss", "quanly"];
  const userRoleNormalized = (nhanSu?.vi_tri_normalized || "").toLowerCase();

  const isAllowed = allowedRoles.includes(userRoleNormalized);

  if (!isAllowed) {
    throw new Error("Forbidden: Bạn không có quyền Quản Lý nghiệp vụ này");
  }

  // 👇 TRẢ VỀ THÔNG TIN NHÂN SỰ ĐỂ GỬI NOTI (Thay vì user object của Auth)
  return nhanSu;
}

function validateIdentifier(name: string) {
  if (!/^[a-zA-Z0-9_]+$/.test(name))
    throw new Error("Tên bảng/cột không hợp lệ");
}

// ==============================================================================
// 🚀 ACTIONS (ĐÃ BẬT BẢO MẬT)
// ==============================================================================

// --- 💬 NGHIỆP VỤ CHAT & HỖ TRỢ ---

export async function getManagerChatSessionsAction(
  filterStatus: string = "all"
) {
  try {
    await requireManager(); // 🛡️ BẢO MẬT ĐÃ BẬT

    let query = `
            SELECT 
                s.*,
                ns.ho_ten as ten_sales_phu_trach
            FROM tu_van_sessions s
            LEFT JOIN nhan_su ns ON s.nhan_su_phu_trach_id = ns.id
            WHERE 1=1
        `;

    if (filterStatus !== "all") {
      query += ` AND s.trang_thai = '${filterStatus}'`;
    }

    query += ` ORDER BY s.cap_nhat_luc DESC LIMIT 100`;

    const data = await sql.unsafe(query);
    return { success: true, data: Array.from(data) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function getManagerChatMessagesAction(sessionId: string) {
  try {
    await requireManager(); // 🛡️ BẢO MẬT ĐÃ BẬT

    const data = await sql`
            SELECT * FROM tu_van_messages 
            WHERE session_id = ${sessionId} 
            ORDER BY tao_luc ASC
        `;

    return { success: true, data: Array.from(data) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// --- 👥 NGHIỆP VỤ NHÂN SỰ ---

export async function getNhanSuDataAction(
  page: number,
  pageSize: number,
  search: string,
  filterRole: string
) {
  try {
    await requireManager(); // 🛡️ BẢO MẬT ĐÃ BẬT

    let baseQuery = `SELECT * FROM "nhan_su" WHERE 1=1`;
    let countQueryBase = `SELECT count(*) as total FROM "nhan_su" WHERE 1=1`;
    const params: any[] = [];
    let paramCount = 1;

    if (search) {
      const searchClause = ` AND (ho_ten ILIKE $${paramCount} OR so_dien_thoai ILIKE $${paramCount} OR email ILIKE $${paramCount})`;
      baseQuery += searchClause;
      countQueryBase += searchClause;
      params.push(`%${search}%`);
      paramCount++;
    }

    if (filterRole && filterRole !== "all") {
      const roleClause = ` AND vi_tri_normalized = $${paramCount}`;
      baseQuery += roleClause;
      countQueryBase += roleClause;
      params.push(filterRole);
      paramCount++;
    }

    const offset = (page - 1) * pageSize;
    baseQuery += ` ORDER BY tao_luc DESC LIMIT ${pageSize} OFFSET ${offset}`;

    // 🔥 TỐI ƯU: Chạy song song sau khi đã check quyền
    const [dataResult, countResult] = await Promise.all([
      sql.unsafe(baseQuery, params),
      sql.unsafe(countQueryBase, params),
    ]);

    return {
      success: true,
      data: Array.from(dataResult),
      total: Number(countResult[0]?.total || 0),
    };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 🔒 CÁC HÀM GHI (CREATE/UPDATE/DELETE)

export async function createNhanSuAction(data: any) {
  try {
    const manager = await requireManager();
    await sql.unsafe(
      `INSERT INTO "nhan_su" (
            ho_ten, so_dien_thoai, vi_tri, vi_tri_normalized, email, 
            trang_thai, luong_thang, thuong_doanh_thu, 
            ngan_hang, so_tai_khoan, hinh_anh
        ) VALUES ($1, $2, $3, $4, $5, 'Đang hoạt động', $6, $7, $8, $9, $10)`,
      [
        data.ho_ten,
        data.so_dien_thoai,
        data.vi_tri,
        data.vi_tri_normalized,
        data.email,
        data.luong_thang || 0,
        data.thuong_doanh_thu || 0,
        data.ngan_hang || null,
        data.so_tai_khoan || null,
        data.hinh_anh || null,
      ]
    );

    // 🔔 GỬI THÔNG BÁO: Nhân sự mới
    sendNotificationToRoles(
      ["admin", "boss"],
      "Tuyển dụng mới",
      `${manager.ho_ten} vừa thêm nhân sự: ${data.ho_ten} (${data.vi_tri})`,
      "/phongquanly",
      "user_follow",
      manager.ho_ten
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function updateNhanSuAction(id: string, data: any) {
  try {
    const manager = await requireManager();
    await sql.unsafe(
      `UPDATE "nhan_su"
       SET ho_ten = $1, so_dien_thoai = $2, vi_tri = $3, vi_tri_normalized = $4, email = $5,
           luong_thang = $6, thuong_doanh_thu = $7, ngan_hang = $8, so_tai_khoan = $9, hinh_anh = $10
       WHERE id = $11`,
      [
        data.ho_ten,
        data.so_dien_thoai,
        data.vi_tri,
        data.vi_tri_normalized,
        data.email || "",
        data.luong_thang || 0,
        data.thuong_doanh_thu || 0,
        data.ngan_hang || null,
        data.so_tai_khoan || null,
        data.hinh_anh || null,
        id,
      ]
    );

    // 🔔 GỬI THÔNG BÁO: Cập nhật nhân sự
    sendNotificationToRoles(
      ["admin", "boss"],
      "Cập nhật hồ sơ",
      `${manager.ho_ten} đã cập nhật thông tin của ${data.ho_ten}`,
      "/phongquanly",
      "system_update",
      manager.ho_ten
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function deleteNhanSuAction(id: string) {
  try {
    const manager = await requireManager();
    await sql.unsafe(`DELETE FROM "nhan_su" WHERE id = $1`, [id]);

    // 🔔 GỬI THÔNG BÁO: Xóa nhân sự (Cảnh báo)
    sendNotificationToRoles(
      ["admin", "boss"],
      "⚠️ Xóa nhân sự",
      `${manager.ho_ten} đã xóa một nhân sự khỏi hệ thống.`,
      "/phongquanly",
      "security_alert",
      manager.ho_ten
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function bulkUpdateNhanSuAction(
  ids: string[],
  data: { vi_tri?: string; vi_tri_normalized?: string }
) {
  try {
    await requireManager();
    if (!ids.length) return { success: false, error: "Chưa chọn nhân sự" };

    const setClauses: string[] = [];
    const params: any[] = [];
    let paramCount = 1;

    if (data.vi_tri) {
      setClauses.push(`vi_tri = $${paramCount}`);
      params.push(data.vi_tri);
      paramCount++;
    }
    if (data.vi_tri_normalized) {
      setClauses.push(`vi_tri_normalized = $${paramCount}`);
      params.push(data.vi_tri_normalized);
      paramCount++;
    }

    const idPlaceholders = ids.map((_, i) => `$${paramCount + i}`).join(", ");
    params.push(...ids);

    await sql.unsafe(
      `UPDATE "nhan_su" SET ${setClauses.join(
        ", "
      )} WHERE id IN (${idPlaceholders})`,
      params
    );
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// --- 🤝 NGHIỆP VỤ KHÁCH HÀNG ---

export async function getKhachHangDataAction(
  page: number,
  pageSize: number,
  search: string,
  filterRole: string
) {
  try {
    await requireManager(); // 🛡️ BẢO MẬT ĐÃ BẬT

    let query = `SELECT * FROM "khach_hang" WHERE 1=1`;
    let countQuery = `SELECT count(*) as total FROM "khach_hang" WHERE 1=1`;
    const params: any[] = [];
    let paramCount = 1;

    if (search) {
      const searchClause = ` AND (ho_ten ILIKE $${paramCount} OR so_dien_thoai ILIKE $${paramCount} OR email ILIKE $${paramCount})`;
      query += searchClause;
      countQuery += searchClause;
      params.push(`%${search}%`);
      paramCount++;
    }
    if (filterRole && filterRole !== "all") {
      const roleClause = ` AND phan_loai_normalized = $${paramCount}`;
      query += roleClause;
      countQuery += roleClause;
      params.push(filterRole);
      paramCount++;
    }

    const offset = (page - 1) * pageSize;
    query += ` ORDER BY tao_luc DESC LIMIT ${pageSize} OFFSET ${offset}`;

    const [data, countResult] = await Promise.all([
      sql.unsafe(query, params),
      sql.unsafe(countQuery, params),
    ]);

    return {
      success: true,
      data: Array.from(data),
      total: Number(countResult[0]?.total || 0),
    };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function createKhachHangAction(data: any) {
  try {
    const manager = await requireManager();
    const phanLoaiNorm =
      data.phan_loai_normalized ||
      (data.phan_loai
        ? data.phan_loai
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
            .replace(/\s+/g, "")
        : "moi");

    await sql.unsafe(
      `INSERT INTO "khach_hang" (ho_ten, so_dien_thoai, email, phan_loai, phan_loai_normalized, hinh_anh, dia_chi, tao_luc)
       VALUES ($1, $2, $3, $4, $5, $6, $7, now())`,
      [
        data.ho_ten,
        data.so_dien_thoai,
        data.email,
        data.phan_loai,
        phanLoaiNorm,
        data.hinh_anh || null,
        data.dia_chi || null,
      ]
    );

    // 🔔 GỬI THÔNG BÁO: Khách hàng mới
    // Báo cho Sales để chăm sóc ngay
    sendNotificationToRoles(
      ["sales", "boss", "admin"],
      "Khách hàng mới",
      `${manager.ho_ten} đã thêm khách hàng tiềm năng: ${data.ho_ten}`,
      "/phongkhachhang",
      "user_follow",
      manager.ho_ten
    );

    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function updateKhachHangAction(id: string, data: any) {
  try {
    await requireManager();
    const phanLoaiNorm =
      data.phan_loai_normalized ||
      (data.phan_loai
        ? data.phan_loai
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
            .replace(/\s+/g, "")
        : "moi");

    await sql.unsafe(
      `UPDATE "khach_hang"
       SET ho_ten = $1, so_dien_thoai = $2, email = $3, phan_loai = $4, phan_loai_normalized = $5, hinh_anh = $6, dia_chi = $7
       WHERE id = $8`,
      [
        data.ho_ten,
        data.so_dien_thoai,
        data.email,
        data.phan_loai,
        phanLoaiNorm,
        data.hinh_anh || null,
        data.dia_chi || null,
        id,
      ]
    );
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function deleteKhachHangAction(id: string) {
  try {
    await requireManager();
    await sql.unsafe(`DELETE FROM "khach_hang" WHERE id = $1`, [id]);
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

export async function bulkUpdateKhachHangAction(
  ids: string[],
  data: { phan_loai?: string; phan_loai_normalized?: string }
) {
  try {
    await requireManager();
    if (!ids.length) return { success: false, error: "Chưa chọn khách hàng" };

    const setClauses: string[] = [];
    const params: any[] = [];
    let paramCount = 1;

    if (data.phan_loai) {
      setClauses.push(`phan_loai = $${paramCount}`);
      params.push(data.phan_loai);
      paramCount++;
    }
    if (data.phan_loai_normalized) {
      setClauses.push(`phan_loai_normalized = $${paramCount}`);
      params.push(data.phan_loai_normalized);
      paramCount++;
    }

    const idPlaceholders = ids.map((_, i) => `$${paramCount + i}`).join(", ");
    params.push(...ids);

    await sql.unsafe(
      `UPDATE "khach_hang" SET ${setClauses.join(
        ", "
      )} WHERE id IN (${idPlaceholders})`,
      params
    );
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// --- UTILS (Dropdowns) ---
export async function getDistinctValuesAction(
  tableName: string,
  columnName: string
) {
  try {
    await requireManager(); // 🛡️ BẢO MẬT ĐÃ BẬT
    validateIdentifier(tableName);
    validateIdentifier(columnName);

    const data = await sql.unsafe(`
            SELECT DISTINCT "${columnName}" FROM "${tableName}" 
            WHERE "${columnName}" IS NOT NULL AND "${columnName}" != ''
            ORDER BY "${columnName}" ASC
        `);
    return {
      success: true,
      data: Array.from(data).map((row) => row[columnName]),
    };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}

// 🟢 LẤY TÁC PHẨM HOÀN THIỆN
export async function getFinishedArtworksAction(limit: number = 50) {
  try {
    await requireManager(); // 🛡️ BẢO MẬT ĐÃ BẬT

    const data = await sql`
            SELECT 
                nk.id, 
                nk.anh_thanh_pham, 
                nk.thoi_gian_ket_thuc,
                ns.ho_ten as ten_nghe_nhan,
                vt.ten_vat_tu as ten_tac_pham,
                vt.ma_sku,
                dh.ma_don
            FROM nhat_ky_san_xuat nk
            JOIN nhan_su ns ON nk.nhan_su_thuc_hien = ns.id
            JOIN lenh_san_xuat lsx ON nk.lenh_san_xuat_id = lsx.id
            JOIN don_hang_chi_tiet dhct ON lsx.don_hang_chi_tiet_id = dhct.id
            JOIN don_hang dh ON dhct.don_hang_id = dh.id
            JOIN vat_tu vt ON dhct.vat_tu_id = vt.id
            WHERE nk.anh_thanh_pham IS NOT NULL 
            AND nk.ket_qua = 'dat'
            ORDER BY nk.thoi_gian_ket_thuc DESC
            LIMIT ${limit}
        `;

    return { success: true, data: Array.from(data) };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
}
</file>

<file path="app/GiaoDienTong/MenuTren/NutCaNhan/ChucNang.ts">
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { LoggerService } from "@/app/ThuVien/LoggerService";

const logger = LoggerService.createScoped("xuLyDangXuat");

export const xuLyDangXuat = async () => {
  try {
    logger.info("🚪 Bắt đầu quá trình đăng xuất...");

    // 1. XÓA THỦ CÔNG TOÀN BỘ LOCALSTORAGE
    if (typeof window !== "undefined") {
      // Xóa các key của App
      localStorage.removeItem("USER_INFO");
      localStorage.removeItem("USER_ROLE");
      localStorage.removeItem("user_role");
      localStorage.removeItem("LA_ADMIN_CUNG");
      localStorage.removeItem("SAVED_EMAIL");

      // QUAN TRỌNG: Xóa token của Supabase (thường có dạng sb-xxxx-auth-token)
      Object.keys(localStorage).forEach((key) => {
        if (key.startsWith("sb-") || key.includes("supabase")) {
          localStorage.removeItem(key);
        }
      });

      // Xóa sessionStorage
      sessionStorage.clear();
    }

    // 2. XÓA COOKIE THỦ CÔNG (Để Middleware không bắt lại được)
    document.cookie.split(";").forEach((c) => {
      document.cookie = c
        .replace(/^ +/, "")
        .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
    });

    // 3. GỌI SUPABASE SIGN OUT (Cho chắc ăn phía server)
    try {
      await supabase.auth.signOut({ scope: "global" });
    } catch (err) {
      console.warn("Supabase signOut warning:", err);
    }

    logger.info("✅ Đã dọn dẹp sạch sẽ session");

    // 4. FORCE REDIRECT VỀ TRANG CHỦ VỚI PARAM ĐẶC BIỆT
    // Thêm timestamp để trình duyệt không cache
    // Param ?logout=success báo hiệu cho trang chủ biết "Tao vừa logout đấy, đừng có auto-login lại"
    window.location.href = `/?logout=success&t=${Date.now()}`;
  } catch (error) {
    logger.error("❌ Lỗi đăng xuất nghiêm trọng", error);
    // Fallback cuối cùng: Force reload trang gốc
    window.location.href = `/?logout=force&t=${Date.now()}`;
  }
};
</file>

<file path="app/phongctv/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { UserCheck } from 'lucide-react';

// Quyền của CTV: chỉ xem
const CTV_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const CTV_FUNCTIONS = [
    { id: 'khachhang', label: 'KHÁCH HÀNG', icon: UserCheck },
];

export default function PhongCTV() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('khachhang');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-[100dvh] bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PHÒNG CTV"
            contentClassName="flex flex-col h-[100dvh] pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PHÒNG CTV"
                functions={CTV_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={CTV_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="app/phongketoan/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { NhanSuChucNang } from '@/app/components/cacchucnang/nhansu';
import { Users } from 'lucide-react';

// Quyền của Kế toán: xem - KHÔNG sửa, KHÔNG xóa
const KETOAN_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const KETOAN_FUNCTIONS = [
    { id: 'nhansu', label: 'NHÂN SỰ', icon: Users },
];

export default function PhongKeToan() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('nhansu');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-[100dvh] bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PHÒNG KẾ TOÁN"
            contentClassName="flex flex-col h-[100dvh] pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PHÒNG KẾ TOÁN"
                functions={KETOAN_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'nhansu' && (
                            <NhanSuChucNang permissions={KETOAN_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="app/phongkhachhang/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { UserCheck } from 'lucide-react';

// Quyền của Khách VIP: chỉ xem thông tin cá nhân
const KHACHHANG_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const KHACHHANG_FUNCTIONS = [
    { id: 'khachhang', label: 'THÔNG TIN', icon: UserCheck },
];

export default function PhongKhachHang() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('khachhang');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-[100dvh] bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PHÒNG KHÁCH VIP"
            contentClassName="flex flex-col h-[100dvh] pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PHÒNG KHÁCH VIP"
                functions={KHACHHANG_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={KHACHHANG_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="app/phongkho/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { NhanSuChucNang } from '@/app/components/cacchucnang/nhansu';
import { Users } from 'lucide-react';

// Quyền của Kho: xem - KHÔNG sửa, KHÔNG xóa
const KHO_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const KHO_FUNCTIONS = [
    { id: 'nhansu', label: 'NHÂN SỰ', icon: Users },
];

export default function PhongKho() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('nhansu');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-[100dvh] bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PHÒNG KHO"
            contentClassName="flex flex-col h-[100dvh] pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PHÒNG KHO"
                functions={KHO_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'nhansu' && (
                            <NhanSuChucNang permissions={KHO_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="app/ThuVien/UserContext.tsx">
"use client";

import React, {
  createContext,
  useContext,
  useEffect,
  useState,
  ReactNode,
} from "react";
import { AuthService, type UserInfo } from "@/app/CongDangNhap/AuthService";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { LoggerService } from "@/app/ThuVien/LoggerService";

interface UserContextType {
  user: UserInfo | null;
  loading: boolean;
  error: string | null;
  refreshUser: () => Promise<void>;
  signOut: () => Promise<void>;
}

const UserContext = createContext<UserContextType | undefined>(undefined);

/**
 * UserProvider - Wrap app để share user info
 * Dùng: <UserProvider><App /></UserProvider>
 */
export function UserProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<UserInfo | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    // ✅ SESSION PERSISTENCE - Check Supabase session first
    const initSession = async () => {
      // 🛡️ CHẶN NGAY NẾU VỪA LOGOUT (Tránh load lại user cũ từ cache)
      if (typeof window !== "undefined") {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get("logout")) {
          console.log(
            "🛑 [UserContext] Phát hiện vừa đăng xuất. Bỏ qua init session."
          );
          setLoading(false);
          return;
        }
      }

      try {
        setLoading(true);

        // Check if user has active Supabase session
        const {
          data: { session },
        } = await supabase.auth.getSession();

        if (session?.user) {
          // Has active session - load user data
          const currentUser = await AuthService.getCurrentUser();
          setUser(currentUser);

          // Save to localStorage as backup
          if (currentUser) {
            localStorage.setItem("USER_INFO", JSON.stringify(currentUser));
          }
        } else {
          // No active session - check localStorage as fallback
          const savedUser = localStorage.getItem("USER_INFO");
          if (savedUser) {
            try {
              setUser(JSON.parse(savedUser));
            } catch (e) {
              LoggerService.error("UserContext", "Error parsing saved user", e);
              localStorage.removeItem("USER_INFO");
            }
          }
        }
      } catch (err) {
        LoggerService.error("UserContext", "Error loading user", err);
        setError(err instanceof Error ? err.message : "Unknown error");
      } finally {
        setLoading(false);
      }
    };

    initSession();

    // ✅ Listen for auth state changes (login/logout)
    const { data: authListener } = supabase.auth.onAuthStateChange(
      async (event, session) => {
        if (event === "SIGNED_IN" && session) {
          const currentUser = await AuthService.getCurrentUser();
          setUser(currentUser);
          if (currentUser) {
            localStorage.setItem("USER_INFO", JSON.stringify(currentUser));
          }
        } else if (event === "SIGNED_OUT") {
          setUser(null);
          localStorage.removeItem("USER_INFO");
        }
      }
    );

    return () => {
      authListener.subscription.unsubscribe();
    };
  }, []);

  const loadUser = async () => {
    try {
      setLoading(true);
      setError(null);
      const currentUser = await AuthService.getCurrentUser();
      setUser(currentUser);
    } catch (err: any) {
      console.error("Error loading user:", err);
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const refreshUser = async () => {
    await loadUser();
  };

  // 🟢 LOGIC ĐĂNG XUẤT "HỦY DIỆT" + "ĐUA TỐC ĐỘ" (FIX ZOMBIE SESSION & TREO)
  const signOut = async () => {
    try {
      setLoading(true);

      // 1. CHIẾN THUẬT: ĐUA TỐC ĐỘ (RACE)
      // Tạo một cái đồng hồ đếm ngược 3 giây
      const timeoutPromise = new Promise((resolve) =>
        setTimeout(resolve, 3000)
      );

      // Gọi lệnh đăng xuất của Supabase
      const supabaseLogoutPromise = AuthService.signOut();

      // Cho 2 thằng đua nhau: Nếu Supabase xong trước -> Tốt.
      // Nếu 3 giây trôi qua mà Supabase chưa xong -> Kệ nó, chạy tiếp lệnh bên dưới.
      await Promise.race([supabaseLogoutPromise, timeoutPromise]);

      // --- ĐOẠN DƯỚI NÀY SẼ LUÔN CHẠY SAU TỐI ĐA 3 GIÂY ---

      // 2. Reset State React ngay lập tức
      setUser(null);
      setError(null);

      // 3. Xóa sạch Storage thủ công
      if (typeof window !== "undefined") {
        localStorage.clear();
        sessionStorage.clear();
        // Xóa cookie visitor
        document.cookie = "VISITOR_MODE=; Path=/; Max-Age=0; SameSite=Lax";

        // Xóa token Supabase thủ công
        Object.keys(localStorage).forEach((key) => {
          if (key.startsWith("sb-") || key.includes("supabase")) {
            localStorage.removeItem(key);
          }
        });
      }

      // 4. Redirect cứng với cờ hiệu logout
      window.location.href = `/?logout=success&t=${Date.now()}`;
    } catch (err) {
      console.error("Logout error (Force quit):", err);
      // Vẫn force logout dù lỗi
      if (typeof window !== "undefined") localStorage.clear();
      window.location.href = `/?logout=force&t=${Date.now()}`;
    } finally {
      setLoading(false);
    }
  };

  return (
    <UserContext.Provider
      value={{ user, loading, error, refreshUser, signOut }}
    >
      {children}
    </UserContext.Provider>
  );
}

/**
 * Hook để dùng user info
 * const { user, loading } = useUser();
 */
export function useUser() {
  const context = useContext(UserContext);
  if (context === undefined) {
    throw new Error("useUser must be used within UserProvider");
  }
  return context;
}
</file>

<file path="app/trangchu/BackgroundManager.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { Image as ImageIcon, Upload, RefreshCw, Smartphone, Monitor, Tablet, Loader2 } from 'lucide-react';
import { supabase } from '@/app/ThuVien/ketNoiSupabase';
import { compressImage } from '@/app/ThuVien/compressImage';

interface Props {
  onUpdate: () => void;
}

export default function BackgroundManager({ onUpdate }: Props) {
  const [isAdmin, setIsAdmin] = useState(false);
  const [isOpen, setIsOpen] = useState(false);
  const [deviceType, setDeviceType] = useState<'desktop' | 'mobile' | 'tablet'>('desktop');
  const [file, setFile] = useState<File | null>(null);
  
  // Trạng thái xử lý: 'idle' | 'compressing' | 'uploading' | 'waiting' | 'done'
  const [status, setStatus] = useState<string>('idle'); 

  useEffect(() => {
    const role = typeof window !== 'undefined' ? localStorage.getItem('USER_ROLE') : '';
    if (role === 'admin' || role === 'quan_ly') setIsAdmin(true);
  }, []);

  if (!isAdmin) return null;

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      setFile(e.target.files[0]);
    }
  };

  const handleUpload = async () => {
    if (!file) return alert("Vui lòng chọn ảnh!");
    
    try {
      setStatus('compressing');

      // 1. Xác định tên file chuẩn (Hardcode)
      let targetFileName = '';
      let maxWidth = 1920;

      if (deviceType === 'desktop') {
        targetFileName = 'trangchu-desktop.jpg';
        maxWidth = 1920;
      } else if (deviceType === 'tablet') {
        targetFileName = 'trangchu-tablet.jpg';
        maxWidth = 1024;
      } else {
        targetFileName = 'trangchu-mobile.jpg';
        maxWidth = 800;
      }

      // 2. Nén ảnh
      const compressedBlob = await compressImage(file, 0.8, maxWidth);

      // 3. Tái tạo file với tên chuẩn (để đảm bảo đổi tên đúng)
      const finalFile = new File([compressedBlob], targetFileName, {
        type: 'image/jpeg',
        lastModified: Date.now(),
      });

      setStatus('uploading');

      // 4. Upload lên Supabase (Ghi đè - Upsert)
      const { data, error } = await supabase.storage
        .from('hinh-nen')
        .upload(targetFileName, finalFile, {
          cacheControl: '0', // Yêu cầu không cache
          upsert: true       // Bắt buộc ghi đè
        });

      if (error) throw error;

      // 5. QUAN TRỌNG: Chờ server đồng bộ (Propagation Delay)
      setStatus('waiting');
      
      // Đợi 2.5 giây để CDN Supabase kịp cập nhật file mới
      setTimeout(() => {
          setStatus('done');
          alert("Cập nhật thành công!");
          setIsOpen(false);
          setFile(null);
          setStatus('idle');
          
          // Lúc này mới báo cho trang chủ load lại ảnh
          onUpdate(); 
      }, 2500);

    } catch (err: any) {
      console.error(err);
      alert("Lỗi upload: " + err.message);
      setStatus('idle');
    }
  };

  // Helper để hiển thị text trạng thái
  const getStatusText = () => {
      switch(status) {
          case 'compressing': return 'Đang nén ảnh...';
          case 'uploading': return 'Đang tải lên...';
          case 'waiting': return 'Đang đồng bộ...';
          case 'done': return 'Hoàn tất!';
          default: return 'Lưu Thay Đổi';
      }
  };

  return (
   <div className="fixed bottom-32 right-6 z-[200] flex flex-col items-end gap-2">
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className="w-10 h-10 rounded-full bg-white/10 backdrop-blur-md border border-white/20 text-[#C69C6D] flex items-center justify-center hover:bg-[#C69C6D] hover:text-black transition-all shadow-lg"
        title="Đổi hình nền (Admin)"
      >
        <ImageIcon size={20} />
      </button>

      {isOpen && (
        <div className="bg-black/90 border border-[#C69C6D] p-4 rounded-lg shadow-2xl w-64 animate-fade-in-up flex flex-col gap-3">
          <h4 className="text-[#C69C6D] text-xs font-bold uppercase border-b border-white/10 pb-2 mb-1">
            Cập nhật hình nền
          </h4>

          <div className="flex gap-1 bg-white/10 p-1 rounded">
            <button onClick={() => setDeviceType('desktop')} className={`flex-1 p-1.5 rounded flex justify-center transition-all active:scale-95 ${deviceType === 'desktop' ? 'bg-[#C69C6D] text-black' : 'text-white hover:bg-white/10'}`} title="Desktop">
                <Monitor size={14} />
            </button>
            <button onClick={() => setDeviceType('tablet')} className={`flex-1 p-1.5 rounded flex justify-center transition-all active:scale-95 ${deviceType === 'tablet' ? 'bg-[#C69C6D] text-black' : 'text-white hover:bg-white/10'}`} title="Tablet">
                <Tablet size={14} />
            </button>
            <button onClick={() => setDeviceType('mobile')} className={`flex-1 p-1.5 rounded flex justify-center transition-all active:scale-95 ${deviceType === 'mobile' ? 'bg-[#C69C6D] text-black' : 'text-white hover:bg-white/10'}`} title="Mobile">
                <Smartphone size={14} />
            </button>
          </div>

          <input type="file" accept="image/*" onChange={handleFileChange} className="text-[10px] text-white file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:bg-[#C69C6D] file:text-black hover:file:bg-white cursor-pointer" />

          <button 
            onClick={handleUpload} 
            disabled={status !== 'idle'}
            className="bg-[#C69C6D] text-black text-xs font-bold py-2 rounded flex items-center justify-center gap-2 hover:bg-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed active:scale-95"
          >
            {status !== 'idle' ? <Loader2 size={14} className="animate-spin"/> : <Upload size={14} />}
            {getStatusText()}
          </button>
          
          <div className="text-[9px] text-gray-400 italic text-center">
            *Hệ thống sẽ tự động nén & đổi tên file chuẩn.
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="app/trangchu/slider2.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { Star, Plus, Trash2, ShoppingCart, Loader2 } from 'lucide-react';
import { supabase } from '@/app/ThuVien/ketNoiSupabase';
import { useRouter } from 'next/navigation';

interface ProductData {
  id: string; // Đổi sang string vì UUID
  ten_vat_tu: string;
  gia_ban: number;
  hinh_anh: string;
  bo_suu_tap: string;
}

export default function Slider2() {
  const [products, setProducts] = useState<ProductData[]>([]);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [loading, setLoading] = useState(true);
  const router = useRouter();

  useEffect(() => {
    fetchProducts();
  }, []);

  // Tự động trượt
  useEffect(() => {
    if (products.length <= 1) return;
    const timer = setInterval(() => {
      setCurrentIndex(prev => (prev === products.length - 1 ? 0 : prev + 1));
    }, 4000); // 4 giây trượt 1 lần
    return () => clearInterval(timer);
  }, [products]);

  const fetchProducts = async () => {
    setLoading(true);
    // 👇 LẤY DỮ LIỆU TỪ BẢNG VAT_TU (Dữ liệu thật)
    const { data, error } = await supabase
      .from('vat_tu')
      .select('id, ten_vat_tu, gia_ban, hinh_anh, bo_suu_tap')
      .eq('loai_vat_tu', 'thanh_pham') // Chỉ lấy thành phẩm
      .not('hinh_anh', 'is', null)     // Chỉ lấy cái nào có ảnh
      .limit(10); // Lấy 10 cái tiêu biểu

    if (data) {
      setProducts(data);
    }
    setLoading(false);
  };

  const handleBuy = (id: string) => {
    router.push(`/dathang?product=${id}`);
  };

  if (loading) return <div className="h-64 flex items-center justify-center"><Loader2 className="animate-spin text-[#C69C6D]"/></div>;
  if (products.length === 0) return null;

  return (
    <div className="w-full bg-black/40 backdrop-blur-md border border-white/5 rounded-xl p-4 md:p-6 relative group/container">
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-[#C69C6D] text-sm font-bold uppercase tracking-widest flex items-center gap-2">
          <Star size={14} fill="currentColor" /> Tác phẩm tiêu biểu ({products.length})
        </h3>
      </div>

      {/* VIEWPORT */}
      <div className="overflow-hidden w-full rounded-lg relative">
        <div 
          className="flex transition-transform duration-700 ease-in-out will-change-transform"
          style={{ transform: `translateX(-${currentIndex * 100}%)` }}
        >
          {products.map((item) => (
            <div key={item.id} className="w-full flex-shrink-0 px-2 relative group">
              <div className="relative overflow-hidden rounded-lg aspect-video md:aspect-[21/9] border border-white/10">
                <img 
                   src={item.hinh_anh} alt={item.ten_vat_tu} 
                   className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                />
                <div className="absolute inset-0 bg-black/20 group-hover:bg-black/40 transition-colors" />
                
                {/* Text Content */}
                <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black via-black/80 to-transparent">
                  <div className="flex justify-between items-end">
                    <div>
                        <span className="text-[10px] bg-[#C69C6D] text-black px-2 py-0.5 rounded font-bold uppercase mb-1 inline-block">
                            BST {item.bo_suu_tap || 'Mới'}
                        </span>
                        <h2 className="text-xl md:text-3xl font-serif text-[#F5F5F5] drop-shadow-md truncate max-w-[200px] md:max-w-md">
                            {item.ten_vat_tu}
                        </h2>
                        <p className="text-[#C69C6D] text-sm md:text-lg font-bold mt-1">
                            {new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.gia_ban)}
                        </p>
                    </div>
                    <button 
                        onClick={() => handleBuy(item.id)}
                        className="bg-white text-black p-3 rounded-full hover:bg-[#C69C6D] transition-colors shadow-lg active:scale-95"
                    >
                        <ShoppingCart size={20} />
                    </button>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>

        {/* Nút điều hướng ảo (Click trái/phải để chuyển) */}
        <div className="absolute inset-y-0 left-0 w-1/4 cursor-w-resize z-10" onClick={() => setCurrentIndex((prev) => (prev === 0 ? products.length - 1 : prev - 1))}></div>
        <div className="absolute inset-y-0 right-0 w-1/4 cursor-e-resize z-10" onClick={() => setCurrentIndex((prev) => (prev === products.length - 1 ? 0 : prev + 1))}></div>
      </div>
    </div>
  );
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "noImplicitAny": true,         // Báo lỗi ngay nếu biến nào không có kiểu (any)
    "strictNullChecks": true,      // Kiểm tra kỹ các trường hợp null/undefined
    "noUnusedLocals": false,        // Báo lỗi nếu khai báo biến mà không dùng (Vercel hay bắt cái này)
    "noUnusedParameters": false,    // Báo lỗi tham số thừa trong hàm


    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "target": "ES2017"
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="app/components/RegisterForm.tsx">
"use client";

import React, { useState, useRef } from "react";
import { createClient } from "@supabase/supabase-js";
import {
  Mail,
  Phone,
  Lock,
  Eye,
  EyeOff,
  UserPlus,
  Briefcase,
  User,
  MapPin,
  CreditCard,
  Building,
  CheckCircle2,
  ShieldCheck,
  ChevronRight,
  Camera,
  Banknote,
  Clock,
  Percent,
  Image as ImageIcon,
  FileText,
} from "lucide-react";
import { compressImage } from "@/app/ThuVien/compressImage";

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

const VN_BANKS = [
  "Vietcombank",
  "VietinBank",
  "BIDV",
  "Agribank",
  "Techcombank",
  "MBBank",
  "ACB",
  "VPBank",
  "TPBank",
  "Sacombank",
  "HDBank",
  "VIB",
  "MSB",
  "SHB",
  "SeABank",
  "OCB",
  "Eximbank",
  "LienVietPostBank",
  "Nam A Bank",
  "Viet Capital Bank",
];

const PHAN_LOAI_OPTIONS = [
  "Tiềm năng",
  "Mới",
  "Thân thiết",
  "VIP",
  "Không hoạt động",
];

// 🟢 Helper lấy ID khách vãng lai từ localStorage (để merge chat)
const getGuestId = () => {
  if (typeof window === "undefined") return null;
  return localStorage.getItem("guest_chat_id");
};

interface RegisterFormProps {
  onSuccess?: () => void;
  onSwitchToLogin?: () => void;
}

export default function RegisterForm({
  onSuccess,
  onSwitchToLogin,
}: RegisterFormProps) {
  const [userType, setUserType] = useState<"nhan_su" | "khach_hang">(
    "khach_hang"
  );

  // Common Fields
  const [hoTen, setHoTen] = useState("");
  const [email, setEmail] = useState("");
  const [phone, setPhone] = useState("");
  const [password, setPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [showPassword, setShowPassword] = useState(false);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);

  // Staff Fields
  const [viTri, setViTri] = useState("");
  const [luongThang, setLuongThang] = useState<number | "">("");
  const [thuongDoanhThu, setThuongDoanhThu] = useState<number | "">("");
  const [nganHang, setNganHang] = useState("");
  const [soTaiKhoan, setSoTaiKhoan] = useState("");

  // Customer Fields
  const [diaChi, setDiaChi] = useState("");
  const [phanLoai, setPhanLoai] = useState("Mới");
  const [ghiChu, setGhiChu] = useState("");

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);
  const [isUploading, setIsUploading] = useState(false);

  const fileInputRef = useRef<HTMLInputElement>(null);

  const luongTheoGio = luongThang
    ? Math.round(Number(luongThang) / 24 / 8 / 1000) * 1000
    : 0;

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
      setAvatarFile(file);
    }
  };

  const handleRegister = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);

    try {
      // 1. Validation
      if (!hoTen.trim()) throw new Error("Vui lòng nhập Họ và Tên");
      if (!email.includes("@")) throw new Error("Email không hợp lệ");
      if (phone.length < 10) throw new Error("Số điện thoại không hợp lệ");
      if (password.length < 6) throw new Error("Mật khẩu phải từ 6 ký tự");
      if (password !== confirmPassword)
        throw new Error("Mật khẩu xác nhận không khớp");

      if (userType === "khach_hang" && !diaChi.trim())
        throw new Error("Vui lòng nhập địa chỉ");
      if (userType === "nhan_su" && !viTri.trim())
        throw new Error("Vui lòng nhập vị trí mong muốn");

      // 2. Check existing
      const { data: existing } = await supabase
        .from(userType)
        .select("id")
        .or(`email.eq.${email.trim()},so_dien_thoai.eq.${phone.trim()}`)
        .maybeSingle();

      if (existing) {
        throw new Error("Email hoặc Số điện thoại đã tồn tại trong hệ thống.");
      }

      // 3. Upload Avatar
      let avatarUrl = null;
      if (avatarFile) {
        setIsUploading(true);
        const compressed = await compressImage(avatarFile, 0.7, 800);
        const fileName = `avatar_${Date.now()}_${avatarFile.name.replace(
          /\W/g,
          ""
        )}`;
        const { error: upErr } = await supabase.storage
          .from("avatar")
          .upload(fileName, compressed);
        if (upErr) throw upErr;

        const { data: urlData } = supabase.storage
          .from("avatar")
          .getPublicUrl(fileName);
        avatarUrl = urlData.publicUrl;
        setIsUploading(false);
      }

      // 4. Create Auth User
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email: email.trim(),
        password: password,
        options: {
          data: {
            ho_ten: hoTen,
            phone: phone,
            user_type: userType,
            waiting_approval: true,
          },
        },
      });

      if (authError) throw authError;
      if (!authData.user) throw new Error("Không thể tạo tài khoản.");

      // 5. Insert Registration Data
      const guestId = getGuestId(); // 🟢 Lấy ID vãng lai để merge chat

      const registrationData = {
        auth_user_id: authData.user.id,
        ho_ten: hoTen.trim(),
        email: email.trim(),
        so_dien_thoai: phone.trim(),
        user_type: userType,
        hinh_anh: avatarUrl,
        details:
          userType === "nhan_su"
            ? {
                vi_tri: viTri,
                luong_thang: Number(luongThang) || 0,
                thuong_doanh_thu: Number(thuongDoanhThu) || 0,
                ngan_hang: nganHang,
                so_tai_khoan: soTaiKhoan,
              }
            : {
                dia_chi: diaChi,
                phan_loai: phanLoai,
                ghi_chu: ghiChu,
                guest_id: guestId, // 🟢 Gửi kèm guest_id lên DB
              },
        status: "pending",
        created_at: new Date().toISOString(),
      };

      const { error: regError } = await supabase
        .from("user_registrations")
        .insert(registrationData);

      if (regError) {
        console.warn("Lỗi lưu đơn đăng ký:", regError);
      } else {
        // 6. Notify Staff
        fetch("/api/push/notify-staff", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: `🆕 Đăng ký mới: ${hoTen}`,
            body: `${
              userType === "nhan_su" ? "Ứng viên" : "Khách hàng"
            } ${hoTen} vừa đăng ký. Vui lòng duyệt.`,
            url: "/quan-ly/duyet-thanh-vien",
          }),
        }).catch((err) => console.error("Notify error:", err));
      }

      setSuccess(true);
      if (onSuccess) setTimeout(onSuccess, 3000);
    } catch (err: any) {
      setError(err.message || "Đăng ký thất bại");
    } finally {
      setLoading(false);
      setIsUploading(false);
    }
  };

  if (success) {
    return (
      <div className="w-full h-full flex flex-col items-center justify-center p-8 text-center animate-in zoom-in duration-300">
        <div className="w-20 h-20 bg-green-500/20 rounded-full flex items-center justify-center mb-6">
          <CheckCircle2 size={40} className="text-green-400" />
        </div>
        <h2 className="text-2xl font-bold text-[#C69C6D] mb-2">
          Đăng Ký Thành Công!
        </h2>
        <p className="text-white/70 mb-6 max-w-sm">
          Hồ sơ của bạn đã được gửi. Vui lòng chờ admin xác nhận qua Email.
        </p>
        <button
          onClick={onSwitchToLogin}
          className="px-6 py-3 bg-white/10 hover:bg-white/20 rounded-xl text-white font-bold transition-all"
        >
          Quay lại Đăng Nhập
        </button>
      </div>
    );
  }

  return (
    // 🟢 Fix lỗi cuộn trên mobile bằng h-[100dvh]
    <div className="flex flex-col lg:flex-row w-full h-[100dvh] lg:h-full bg-[#0a0a0a] overflow-hidden">
      {/* CỘT TRÁI: QUY TRÌNH (Ẩn trên mobile) */}
      <div className="hidden lg:flex w-1/3 bg-[#111] border-r border-[#C69C6D]/30 p-6 flex-col shrink-0">
        <h3 className="text-lg font-bold text-[#C69C6D] uppercase tracking-widest mb-6 flex items-center gap-2">
          <ShieldCheck size={20} /> Quy Trình
        </h3>

        <div className="flex-1 space-y-8 relative pl-2">
          <div className="absolute left-[19px] top-2 bottom-10 w-[1px] bg-white/10 z-0"></div>
          <StepItem
            number="1"
            title="Đăng Ký"
            desc="Điền thông tin hồ sơ."
            active={true}
          />
          <StepItem
            number="2"
            title="Xét Duyệt"
            desc="Admin kiểm tra và phân quyền."
          />
          <StepItem
            number="3"
            title="Sử Dụng"
            desc="Đăng nhập và bắt đầu làm việc."
          />
        </div>

        <div className="mt-auto pt-6 border-t border-white/10">
          <p className="text-white/40 text-xs italic">
            * Cam kết bảo mật thông tin tuyệt đối.
          </p>
        </div>
      </div>

      {/* CỘT PHẢI: FORM NHẬP LIỆU */}
      <div className="w-full lg:w-2/3 flex flex-col h-full bg-[#0a0a0a] min-h-0">
        {/* Header cố định */}
        <div className="shrink-0 px-6 py-4 border-b border-white/10 flex items-center justify-between bg-[#0a0a0a]/90 backdrop-blur z-10">
          <h2 className="text-xl font-bold text-white">Đăng Ký Tài Khoản</h2>
          {onSwitchToLogin && (
            <button
              onClick={onSwitchToLogin}
              className="text-xs text-[#C69C6D] hover:underline flex items-center gap-1"
            >
              Đăng nhập <ChevronRight size={14} />
            </button>
          )}
        </div>

        {/* Form Body - Cuộn được */}
        <div className="flex-1 overflow-y-auto p-6 custom-scrollbar pb-32">
          {error && (
            <div className="bg-red-900/30 border border-red-500/50 p-3 rounded-lg mb-6 text-red-200 text-sm flex items-start gap-2 animate-in fade-in slide-in-from-top-2">
              <ShieldCheck size={16} className="mt-0.5 shrink-0" />
              <span>{error}</span>
            </div>
          )}

          <form onSubmit={handleRegister} className="space-y-6">
            {/* 1. Chọn Loại & Avatar */}
            <div className="flex flex-col sm:flex-row gap-6">
              {/* Avatar Upload */}
              <div className="shrink-0 flex flex-col items-center gap-2">
                <div
                  onClick={() => fileInputRef.current?.click()}
                  className="w-24 h-24 rounded-full border-2 border-dashed border-white/20 hover:border-[#C69C6D] flex items-center justify-center cursor-pointer overflow-hidden bg-white/5 relative group transition-all"
                >
                  {avatarPreview ? (
                    <img
                      src={avatarPreview}
                      alt="Avatar"
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <Camera
                      className="text-white/30 group-hover:text-[#C69C6D]"
                      size={32}
                    />
                  )}
                  <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                    <ImageIcon size={20} className="text-white" />
                  </div>
                </div>
                <span className="text-[10px] text-white/40 uppercase font-bold">
                  Ảnh đại diện
                </span>
                <input
                  type="file"
                  ref={fileInputRef}
                  className="hidden"
                  accept="image/*"
                  onChange={handleFileChange}
                />
              </div>

              {/* Loại tài khoản */}
              <div className="flex-1">
                <label className="block text-white/60 text-xs font-bold uppercase mb-2">
                  Bạn là ai?
                </label>
                <div className="grid grid-cols-2 gap-3 h-[88px]">
                  <TypeButton
                    active={userType === "khach_hang"}
                    onClick={() => setUserType("khach_hang")}
                    icon={User}
                    label="Khách Hàng"
                  />
                  <TypeButton
                    active={userType === "nhan_su"}
                    onClick={() => setUserType("nhan_su")}
                    icon={Briefcase}
                    label="Nhân Sự"
                  />
                </div>
              </div>
            </div>

            {/* 2. Thông tin chung */}
            <div className="space-y-4">
              <p className="text-[#C69C6D] text-xs font-bold uppercase border-b border-white/10 pb-1">
                Thông tin đăng nhập
              </p>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <InputGroup label="Họ và Tên" icon={User} required>
                  <input
                    className="w-full bg-transparent outline-none text-white text-sm"
                    placeholder="Nguyễn Văn A"
                    value={hoTen}
                    onChange={(e) => setHoTen(e.target.value)}
                  />
                </InputGroup>
                <InputGroup label="Số Điện Thoại" icon={Phone} required>
                  <input
                    className="w-full bg-transparent outline-none text-white text-sm"
                    placeholder="09..."
                    type="tel"
                    value={phone}
                    onChange={(e) => setPhone(e.target.value)}
                  />
                </InputGroup>
              </div>
              <InputGroup label="Email" icon={Mail} required>
                <input
                  className="w-full bg-transparent outline-none text-white text-sm"
                  placeholder="email@example.com"
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                />
              </InputGroup>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <InputGroup label="Mật Khẩu" icon={Lock} required>
                  <div className="relative w-full">
                    <input
                      className="w-full bg-transparent outline-none text-white text-sm pr-8"
                      placeholder="••••••"
                      type={showPassword ? "text" : "password"}
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                    />
                    <button
                      type="button"
                      onClick={() => setShowPassword(!showPassword)}
                      className="absolute right-0 top-1/2 -translate-y-1/2 text-white/40 hover:text-white"
                    >
                      {showPassword ? <EyeOff size={14} /> : <Eye size={14} />}
                    </button>
                  </div>
                </InputGroup>
                <InputGroup label="Xác Nhận" icon={Lock} required>
                  <input
                    className="w-full bg-transparent outline-none text-white text-sm"
                    placeholder="••••••"
                    type="password"
                    value={confirmPassword}
                    onChange={(e) => setConfirmPassword(e.target.value)}
                  />
                </InputGroup>
              </div>
            </div>

            {/* 3. Fields riêng */}
            {userType === "khach_hang" && (
              <div className="space-y-4 animate-in fade-in slide-in-from-right-4 duration-300">
                <p className="text-[#C69C6D] text-xs font-bold uppercase border-b border-white/10 pb-1">
                  Hồ sơ khách hàng
                </p>
                <InputGroup label="Địa Chỉ Giao Hàng" icon={MapPin} required>
                  <input
                    className="w-full bg-transparent outline-none text-white text-sm"
                    placeholder="Số nhà, đường..."
                    value={diaChi}
                    onChange={(e) => setDiaChi(e.target.value)}
                  />
                </InputGroup>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <InputGroup label="Phân Loại" icon={Briefcase}>
                    <select
                      className="w-full bg-transparent outline-none text-white text-sm appearance-none"
                      value={phanLoai}
                      onChange={(e) => setPhanLoai(e.target.value)}
                    >
                      {PHAN_LOAI_OPTIONS.map((opt) => (
                        <option key={opt} value={opt} className="bg-[#111]">
                          {opt}
                        </option>
                      ))}
                    </select>
                  </InputGroup>
                  <InputGroup label="Ghi Chú" icon={FileText}>
                    <input
                      className="w-full bg-transparent outline-none text-white text-sm"
                      placeholder="Ghi chú thêm..."
                      value={ghiChu}
                      onChange={(e) => setGhiChu(e.target.value)}
                    />
                  </InputGroup>
                </div>
              </div>
            )}

            {userType === "nhan_su" && (
              <div className="space-y-4 animate-in fade-in slide-in-from-right-4 duration-300">
                <p className="text-[#C69C6D] text-xs font-bold uppercase border-b border-white/10 pb-1">
                  Hồ sơ nhân sự
                </p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <InputGroup
                    label="Vị Trí / Chức Vụ"
                    icon={Briefcase}
                    required
                  >
                    <input
                      className="w-full bg-transparent outline-none text-white text-sm"
                      placeholder="VD: Sales..."
                      value={viTri}
                      onChange={(e) => setViTri(e.target.value)}
                    />
                  </InputGroup>
                  <InputGroup label="Thưởng Doanh Số (%)" icon={Percent}>
                    <input
                      type="number"
                      className="w-full bg-transparent outline-none text-white text-sm"
                      placeholder="0 - 30"
                      value={thuongDoanhThu}
                      onChange={(e) =>
                        setThuongDoanhThu(Number(e.target.value))
                      }
                      max={30}
                    />
                  </InputGroup>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <InputGroup label="Lương Cứng (VNĐ)" icon={Banknote}>
                    <input
                      type="number"
                      className="w-full bg-transparent outline-none text-white text-sm"
                      placeholder="10,000,000"
                      value={luongThang}
                      onChange={(e) => setLuongThang(Number(e.target.value))}
                    />
                  </InputGroup>
                  <InputGroup label="Lương Theo Giờ (Auto)" icon={Clock}>
                    <input
                      className="w-full bg-transparent outline-none text-white/50 text-sm"
                      readOnly
                      value={
                        luongTheoGio
                          ? new Intl.NumberFormat("vi-VN").format(
                              luongTheoGio
                            ) + " đ/h"
                          : "---"
                      }
                    />
                  </InputGroup>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <InputGroup label="Ngân Hàng" icon={Building}>
                    <select
                      className="w-full bg-transparent outline-none text-white text-sm appearance-none"
                      value={nganHang}
                      onChange={(e) => setNganHang(e.target.value)}
                    >
                      <option value="" className="bg-[#111]">
                        -- Chọn --
                      </option>
                      {VN_BANKS.map((bank) => (
                        <option key={bank} value={bank} className="bg-[#111]">
                          {bank}
                        </option>
                      ))}
                    </select>
                  </InputGroup>
                  <InputGroup label="Số Tài Khoản" icon={CreditCard}>
                    <input
                      className="w-full bg-transparent outline-none text-white text-sm"
                      placeholder="STK..."
                      value={soTaiKhoan}
                      onChange={(e) => setSoTaiKhoan(e.target.value)}
                    />
                  </InputGroup>
                </div>
              </div>
            )}
          </form>
        </div>

        {/* Footer Action - Cố định dưới cùng */}
        <div className="shrink-0 p-6 border-t border-white/10 bg-[#0a0a0a] z-20 absolute bottom-0 left-0 right-0">
          <button
            onClick={handleRegister}
            disabled={loading || isUploading}
            className="w-full py-3.5 bg-[#C69C6D] hover:bg-white text-black font-bold uppercase tracking-widest rounded-xl transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed shadow-[0_0_20px_rgba(198,156,109,0.3)] flex items-center justify-center gap-2"
          >
            {loading || isUploading ? (
              <div className="w-5 h-5 border-2 border-black border-t-transparent rounded-full animate-spin" />
            ) : (
              <UserPlus size={18} />
            )}
            Gửi Đơn Đăng Ký
          </button>
        </div>
      </div>

      <style jsx global>{`
        .custom-scrollbar::-webkit-scrollbar {
          width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: #111;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: #333;
          border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background: #c69c6d;
        }
      `}</style>
    </div>
  );
}

// Sub-components
function StepItem({ number, title, desc, active }: any) {
  return (
    <div className="relative flex gap-4 z-10">
      <div
        className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm border-2 shrink-0 transition-colors ${
          active
            ? "bg-[#C69C6D] border-[#C69C6D] text-black"
            : "bg-[#111] border-white/20 text-white/40"
        }`}
      >
        {number}
      </div>
      <div>
        <h4
          className={`text-sm font-bold ${
            active ? "text-white" : "text-white/60"
          }`}
        >
          {title}
        </h4>
        <p className="text-xs text-white/40 mt-1 leading-relaxed">{desc}</p>
      </div>
    </div>
  );
}

function TypeButton({ active, onClick, icon: Icon, label }: any) {
  return (
    <button
      type="button"
      onClick={onClick}
      className={`p-4 rounded-xl border flex flex-col items-center justify-center transition-all h-full ${
        active
          ? "bg-[#C69C6D]/20 border-[#C69C6D]"
          : "bg-white/5 border-white/10 hover:bg-white/10"
      }`}
    >
      <Icon
        size={24}
        className={`mb-2 ${active ? "text-[#C69C6D]" : "text-white/50"}`}
      />
      <div
        className={`font-bold text-sm ${
          active ? "text-white" : "text-white/70"
        }`}
      >
        {label}
      </div>
    </button>
  );
}

function InputGroup({ label, icon: Icon, required, children }: any) {
  return (
    <div className="group w-full">
      <label className="block text-white/60 text-[10px] font-bold uppercase mb-1.5 ml-1">
        {label} {required && <span className="text-red-400">*</span>}
      </label>
      <div className="flex items-center gap-3 px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus-within:border-[#C69C6D] focus-within:bg-black transition-all">
        <Icon
          size={16}
          className="text-white/30 group-focus-within:text-[#C69C6D] transition-colors shrink-0"
        />
        {children}
      </div>
    </div>
  );
}
</file>

<file path="public/manifest.json">
{
  "name": "Nghiem's Art - Tranh nghệ thuật Đăng Nghiêm",
  "short_name": "Nghiem's Art",
  "description": "Phòng trưng bày tác phẩm và dịch vụ làm tranh bằng hạt gạo",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#000000",
  "theme_color": "#000000",
  "icons": [
    {
      "src": "/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
</file>

<file path="app/actions/admindb.ts">
'use server';

import postgres from 'postgres';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

// Kết nối DB (Dùng Postgres.js cho các lệnh DDL mạnh)
const sql = postgres(process.env.DATABASE_URL!, {
  ssl: 'require',
  max: 10,
  idle_timeout: 20, 
});

// 🛡️ 1. HÀM KIỂM TRA QUYỀN ADMIN (BẮT BUỘC)
async function requireAdmin() {
    const cookieStore = cookies();
    
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                get(name: string) {
                    return cookieStore.get(name)?.value
                },
                set(name: string, value: string, options: any) {},
                remove(name: string, options: any) {},
            },
        }
    );

    const { data: { user } } = await supabase.auth.getUser();
    if (!user || !user.email) throw new Error("Unauthorized: Bạn chưa đăng nhập");

    // Check email hoặc bảng nhan_su để xem có phải admin không
    const { data: nhanSu } = await supabase
        .from('nhan_su')
        .select('vi_tri, vi_tri_normalized')
        .eq('email', user.email)
        .single();
    
    // Ưu tiên trường normalized để khớp RLS/routing; vẫn hỗ trợ legacy vi_tri
    const allowedRoles = ['admin', 'quanly', 'boss'];
    const userRoleNormalized = (nhanSu?.vi_tri_normalized || '').toLowerCase();
    const userRoleLegacy = (nhanSu?.vi_tri || '').toLowerCase().replace(/\s/g, '');
    
    const isAllowed = allowedRoles.includes(userRoleNormalized) || allowedRoles.some(r => userRoleLegacy.includes(r));

    if (!isAllowed) {
        throw new Error("Forbidden: Bạn không có quyền quản trị Database");
    }
}

// 🛡️ 2. HÀM KIỂM TRA TÊN BẢNG/CỘT (CHỐNG SQL INJECTION)
function validateIdentifier(name: string) {
    if (!/^[a-zA-Z0-9_]+$/.test(name)) {
        throw new Error(`Tên không hợp lệ: ${name}. Chỉ chấp nhận chữ, số và gạch dưới.`);
    }
}

// --- CÁC HÀM ACTION ---

// --- 1. LẤY DANH SÁCH BẢNG ---
export async function getTablesWithRLSAction() {
    try {
        await requireAdmin(); // 🛡️ Check quyền
        const tables = await sql`
            SELECT c.relname as table_name, c.relrowsecurity as rls_enabled
            FROM pg_class c
            JOIN pg_namespace n ON n.oid = c.relnamespace
            WHERE n.nspname = 'public' AND c.relkind = 'r'
            ORDER BY c.relname;
        `;
        return { success: true, data: Array.from(tables).map(t => ({ table_name: t.table_name, rls_enabled: t.rls_enabled })) };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 2. KIỂM TRA RLS ---
export async function checkTableRLSAction(tableName: string) {
    try {
        await requireAdmin();
        const [result] = await sql`
            SELECT c.relrowsecurity as rls_enabled
            FROM pg_class c
            JOIN pg_namespace n ON n.oid = c.relnamespace
            WHERE n.nspname = 'public' AND c.relkind = 'r' AND c.relname = ${tableName}
        `;
        if (!result) return { success: false, error: "Bảng không tồn tại" };
        return { success: true, rls_enabled: result.rls_enabled };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 3. LẤY SCHEMA ---
export async function getTableSchemaAction(tableName: string) {
    try {
        await requireAdmin();
        const columns = await sql`
            SELECT column_name, data_type, is_nullable, column_default
            FROM information_schema.columns 
            WHERE table_schema = 'public' AND table_name = ${tableName}
            ORDER BY ordinal_position;
        `;
        return { success: true, data: Array.from(columns) };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 4. TOGGLE RLS (NGUY HIỂM - CẦN CHECK KỸ) ---
export async function toggleRLSAction(tableName: string, enable: boolean) {
    try {
        await requireAdmin(); // 🛡️ Check quyền cực quan trọng
        validateIdentifier(tableName); // 🛡️ Check SQL Injection

        if (enable) {
            await sql.unsafe(`ALTER TABLE "${tableName}" ENABLE ROW LEVEL SECURITY`);
        } else {
            await sql.unsafe(`ALTER TABLE "${tableName}" DISABLE ROW LEVEL SECURITY`);
            await sql.unsafe(`GRANT ALL ON TABLE "${tableName}" TO anon, authenticated, service_role`);
        }
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// --- 5. LẤY DỮ LIỆU PHÂN TRANG (ĐÃ SỬA LỖI SORT COLUMN) ---
export async function getTableDataPaginatedAction(tableName: string, page: number, pageSize: number) {
    try {
        await requireAdmin();
        validateIdentifier(tableName);
        
        // 🟢 BƯỚC 1: Tìm cột sắp xếp hợp lệ (Tránh lỗi column does not exist)
        const columns = await sql`
            SELECT column_name 
            FROM information_schema.columns 
            WHERE table_schema = 'public' AND table_name = ${tableName}
        `;
        
        const colNames = Array.from(columns).map(c => c.column_name);
        let sortCol = 'id'; // Mặc định sort theo id nếu không tìm thấy ngày
        
        // Ưu tiên các cột thời gian phổ biến
        if (colNames.includes('tao_luc')) sortCol = 'tao_luc';
        else if (colNames.includes('created_at')) sortCol = 'created_at';
        else if (colNames.includes('date_created')) sortCol = 'date_created';
        
        // Nếu không có id luôn (hiếm gặp), lấy cột đầu tiên
        if (!colNames.includes('id') && sortCol === 'id' && colNames.length > 0) {
             sortCol = colNames[0];
        }

        const offset = (page - 1) * pageSize;
        
        // 🟢 BƯỚC 2: Query an toàn với cột sắp xếp động
        const data = await sql.unsafe(`SELECT * FROM "${tableName}" ORDER BY "${sortCol}" DESC LIMIT ${pageSize} OFFSET ${offset}`);
        
        const [countResult] = await sql.unsafe(`SELECT count(*) as total FROM "${tableName}"`);
        
        return { 
            success: true, 
            data: Array.from(data), 
            total: Number(countResult.total) 
        };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// --- 6. TẠO KHÓA NGOẠI ---
export async function createForeignKeyAction(table: string, col: string, refTable: string, refCol: string = 'id') {
    try {
        await requireAdmin();
        validateIdentifier(table);
        validateIdentifier(col);
        validateIdentifier(refTable);
        validateIdentifier(refCol);

        const constraintName = `fk_${table}_${col}_${Date.now()}`;
        await sql.unsafe(`
            ALTER TABLE "${table}" ADD CONSTRAINT "${constraintName}" 
            FOREIGN KEY ("${col}") REFERENCES "${refTable}" ("${refCol}") ON DELETE SET NULL
        `);
        return { success: true };
    } catch (error: any) { return { success: false, error: error.message }; }
}

// --- 7. QUẢN LÝ CẤU TRÚC BẢNG (CORE) ---
export async function manageTableStructureAction(tableName: string, columnsDef: any[]) {
  try {
    await requireAdmin();
    if (!tableName) throw new Error("Tên bảng không được để trống");
    validateIdentifier(tableName);

    await sql.unsafe(`
      CREATE TABLE IF NOT EXISTS "${tableName}" (
        id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
        tao_luc timestamptz DEFAULT now()
      )
    `);

    try {
        await sql.unsafe(`ALTER TABLE "${tableName}" DISABLE ROW LEVEL SECURITY`);
        await sql.unsafe(`GRANT ALL ON TABLE "${tableName}" TO anon, authenticated, service_role`);
    } catch (e) {}

    for (const col of columnsDef) {
        if (['id', 'tao_luc'].includes(col.name)) continue;
        validateIdentifier(col.name);

        try {
            const [existing] = await sql`SELECT column_name FROM information_schema.columns WHERE table_schema = 'public' AND table_name = ${tableName} AND column_name = ${col.name}`;

            let safeDefault = '';
            if (col.defaultValue !== undefined && col.defaultValue !== null && col.defaultValue !== '') {
                let val = String(col.defaultValue).trim();
                val = val.replace(/::[a-zA-Z0-9_ ]+$/, ''); 
                const isFuncOrNum = ['now()', 'gen_random_uuid()', 'true', 'false', 'current_timestamp'].includes(val.toLowerCase()) || !isNaN(Number(val));
                if (isFuncOrNum) {
                    safeDefault = val;
                } else {
                    if (val.startsWith("'") && val.endsWith("'")) safeDefault = val;
                    else {
                         if (col.type.endsWith('[]') && !val.startsWith('{')) val = `{${val}}`;
                         safeDefault = `'${val.replace(/'/g, "''")}'`; 
                    }
                }
            }

            if (existing) {
                await sql.unsafe(`ALTER TABLE "${tableName}" ALTER COLUMN "${col.name}" TYPE ${col.type} USING "${col.name}"::${col.type}`);
                await sql.unsafe(`ALTER TABLE "${tableName}" ALTER COLUMN "${col.name}" ${col.isNullable ? 'DROP NOT NULL' : 'SET NOT NULL'}`);
                if (safeDefault) await sql.unsafe(`ALTER TABLE "${tableName}" ALTER COLUMN "${col.name}" SET DEFAULT ${safeDefault}`);
                else await sql.unsafe(`ALTER TABLE "${tableName}" ALTER COLUMN "${col.name}" DROP DEFAULT`);
            } else {
                let query = `ALTER TABLE "${tableName}" ADD COLUMN "${col.name}" ${col.type}`;
                if (!col.isNullable) query += ` NOT NULL`;
                if (safeDefault) query += ` DEFAULT ${safeDefault}`;
                await sql.unsafe(query);
            }
        } catch (colErr: any) {
            throw new Error(`Lỗi cột '${col.name}': ${colErr.message}`);
        }
    }
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error instanceof Error ? error.message : String(error) };
  }
}

// --- 8. CÁC HÀM KHÁC ---
export async function unlockTableAction(tableName: string) {
    return toggleRLSAction(tableName, false);
}

export async function addColumnAction(tableName: string, colName: string, colType: string) {
    try {
        await requireAdmin();
        validateIdentifier(tableName);
        validateIdentifier(colName);
        
        await sql.unsafe(`ALTER TABLE "${tableName}" ADD COLUMN "${colName}" ${colType}`);
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 9. CẬP NHẬT DỮ LIỆU ---
export async function updateTableCellAction(tableName: string, id: string, column: string, value: any) {
    try {
        await requireAdmin();
        validateIdentifier(tableName);
        validateIdentifier(column);

        // Xử lý giá trị đặc biệt
        let finalValue = value;
        if (value === '' || value === null) finalValue = null;

        await sql.unsafe(`
            UPDATE "${tableName}" 
            SET "${column}" = $1 
            WHERE id = $2
        `, [finalValue, id]);

        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 🟢 10. LẤY DỮ LIỆU NHÂN SỰ (CÓ SEARCH & FILTER) ---
export async function getNhanSuDataAction(page: number, pageSize: number, search: string, filterRole: string) {
    try {
        await requireAdmin();
        
        let query = `SELECT * FROM "nhan_su" WHERE 1=1`;
        const params: any[] = [];
        let paramCount = 1;

        if (search) {
            query += ` AND (ho_ten ILIKE $${paramCount} OR so_dien_thoai ILIKE $${paramCount} OR email ILIKE $${paramCount})`;
            params.push(`%${search}%`);
            paramCount++;
        }

        if (filterRole && filterRole !== 'all') {
            query += ` AND vi_tri_normalized = $${paramCount}`;
            params.push(filterRole);
            paramCount++;
        }

        const countQuery = query.replace('SELECT *', 'SELECT count(*) as total');
        const offset = (page - 1) * pageSize;
        query += ` ORDER BY tao_luc DESC LIMIT ${pageSize} OFFSET ${offset}`;

        const data = await sql.unsafe(query, params);
        const [countResult] = await sql.unsafe(countQuery, params);

        return { 
            success: true, 
            data: Array.from(data), 
            total: Number(countResult.total) 
        };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 🟢 11. CẬP NHẬT NHÂN SỰ ---
export async function updateNhanSuAction(id: string, data: any) {
    try {
        await requireAdmin();
        
        // 🟢 FIX LỖI 428C9: BỎ CỘT luong_theo_gio VÌ LÀ GENERATED COLUMN
        await sql.unsafe(`
            UPDATE "nhan_su"
            SET ho_ten = $1,
                so_dien_thoai = $2,
                vi_tri = $3,
                vi_tri_normalized = $4,
                email = $5,
                luong_thang = $6,
                thuong_doanh_thu = $7,
                ngan_hang = $8,
                so_tai_khoan = $9,
                hinh_anh = $10
            WHERE id = $11
        `, [
            data.ho_ten, 
            data.so_dien_thoai, 
            data.vi_tri, 
            data.vi_tri_normalized, 
            data.email || '',
            data.luong_thang || 0,
            data.thuong_doanh_thu || 0,
            data.ngan_hang || null,
            data.so_tai_khoan || null,
            data.hinh_anh || null,
            id
        ]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 🟢 12. TẠO MỚI NHÂN SỰ ---
export async function createNhanSuAction(data: any) {
    try {
        await requireAdmin();
        
        // 🟢 FIX LỖI 428C9: BỎ CỘT luong_theo_gio VÌ LÀ GENERATED COLUMN
        await sql.unsafe(`
            INSERT INTO "nhan_su" (
                ho_ten, so_dien_thoai, vi_tri, vi_tri_normalized, email, 
                trang_thai, luong_thang, thuong_doanh_thu, 
                ngan_hang, so_tai_khoan, hinh_anh
            )
            VALUES ($1, $2, $3, $4, $5, 'Đang hoạt động', $6, $7, $8, $9, $10)
        `, [
            data.ho_ten, 
            data.so_dien_thoai, 
            data.vi_tri, 
            data.vi_tri_normalized, 
            data.email,
            data.luong_thang || 0,
            data.thuong_doanh_thu || 0,
            data.ngan_hang || null,
            data.so_tai_khoan || null,
            data.hinh_anh || null
        ]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 🟢 13. LẤY GIÁ TRỊ DUY NHẤT CỦA CỘT (Dùng cho Dropdown) ---
export async function getDistinctValuesAction(tableName: string, columnName: string) {
    try {
        await requireAdmin();
        validateIdentifier(tableName);
        validateIdentifier(columnName);

        const data = await sql.unsafe(`
            SELECT DISTINCT "${columnName}" 
            FROM "${tableName}" 
            WHERE "${columnName}" IS NOT NULL AND "${columnName}" != ''
            ORDER BY "${columnName}" ASC
        `);
        
        return { success: true, data: Array.from(data).map(row => row[columnName]) };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}
// --- 🟢 14. XÓA NHÂN SỰ ---
export async function deleteNhanSuAction(id: string) {
    try {
        await requireAdmin(); // Chỉ Admin/Quản lý mới gọi được
        validateIdentifier('nhan_su');

        await sql.unsafe(`
            DELETE FROM "nhan_su" WHERE id = $1
        `, [id]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 🟢 14b. CẬP NHẬT HÀNG LOẠT NHÂN SỰ (BULK UPDATE) ---
export async function bulkUpdateNhanSuAction(ids: string[], data: { vi_tri?: string; vi_tri_normalized?: string }) {
    try {
        await requireAdmin();
        
        if (!ids || ids.length === 0) {
            return { success: false, error: 'Không có ID nào được chọn' };
        }

        const setClauses: string[] = [];
        const params: any[] = [];
        let paramCount = 1;

        if (data.vi_tri !== undefined) {
            setClauses.push(`vi_tri = $${paramCount}`);
            params.push(data.vi_tri);
            paramCount++;
        }

        if (data.vi_tri_normalized !== undefined) {
            setClauses.push(`vi_tri_normalized = $${paramCount}`);
            params.push(data.vi_tri_normalized);
            paramCount++;
        }

        if (setClauses.length === 0) {
            return { success: false, error: 'Không có dữ liệu để cập nhật' };
        }

        const idPlaceholders = ids.map((_, i) => `$${paramCount + i}`).join(', ');
        params.push(...ids);

        const query = `UPDATE "nhan_su" SET ${setClauses.join(', ')} WHERE id IN (${idPlaceholders})`;
        
        await sql.unsafe(query, params);
        
        return { success: true, updated: ids.length };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// ... (Giữ nguyên các hàm cũ)

// --- 🟢 15. LẤY DỮ LIỆU KHÁCH HÀNG (CÓ SEARCH & FILTER) ---
export async function getKhachHangDataAction(page: number, pageSize: number, search: string, filterRole: string) {
    try {
        await requireAdmin();
        
        let query = `SELECT * FROM "khach_hang" WHERE 1=1`;
        const params: any[] = [];
        let paramCount = 1;

        if (search) {
            query += ` AND (ho_ten ILIKE $${paramCount} OR so_dien_thoai ILIKE $${paramCount} OR email ILIKE $${paramCount})`;
            params.push(`%${search}%`);
            paramCount++;
        }

        if (filterRole && filterRole !== 'all') {
            query += ` AND phan_loai_normalized = $${paramCount}`;
            params.push(filterRole);
            paramCount++;
        }

        const countQuery = query.replace('SELECT *', 'SELECT count(*) as total');
        const offset = (page - 1) * pageSize;
        // Sắp xếp khách hàng mới nhất lên đầu
        query += ` ORDER BY tao_luc DESC LIMIT ${pageSize} OFFSET ${offset}`;

        const data = await sql.unsafe(query, params);
        const [countResult] = await sql.unsafe(countQuery, params);

        return { 
            success: true, 
            data: Array.from(data), 
            total: Number(countResult.total) 
        };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 🟢 16. TẠO MỚI KHÁCH HÀNG ---
export async function createKhachHangAction(data: any) {
    try {
        await requireAdmin();
        
        // Đảm bảo normalized có giá trị
        const phanLoaiNorm = data.phan_loai_normalized || 
            (data.phan_loai ? data.phan_loai.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/\s+/g, "") : 'moi');

        await sql.unsafe(`
            INSERT INTO "khach_hang" (
                ho_ten, so_dien_thoai, email, 
                phan_loai, phan_loai_normalized, 
                hinh_anh, dia_chi, tao_luc
            )
            VALUES ($1, $2, $3, $4, $5, $6, $7, now())
        `, [
            data.ho_ten, 
            data.so_dien_thoai, 
            data.email,
            data.phan_loai,
            phanLoaiNorm,
            data.hinh_anh || null,
            data.dia_chi || null
        ]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 🟢 17. CẬP NHẬT KHÁCH HÀNG ---
export async function updateKhachHangAction(id: string, data: any) {
    try {
        await requireAdmin();

         const phanLoaiNorm = data.phan_loai_normalized || 
            (data.phan_loai ? data.phan_loai.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/\s+/g, "") : 'moi');
        
        await sql.unsafe(`
            UPDATE "khach_hang"
            SET ho_ten = $1,
                so_dien_thoai = $2,
                email = $3,
                phan_loai = $4,
                phan_loai_normalized = $5,
                hinh_anh = $6,
                dia_chi = $7
            WHERE id = $8
        `, [
            data.ho_ten, 
            data.so_dien_thoai, 
            data.email,
            data.phan_loai,
            phanLoaiNorm,
            data.hinh_anh || null,
            data.dia_chi || null,
            id
        ]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 🟢 18. XÓA KHÁCH HÀNG ---
export async function deleteKhachHangAction(id: string) {
    try {
        await requireAdmin();
        validateIdentifier('khach_hang');

        await sql.unsafe(`DELETE FROM "khach_hang" WHERE id = $1`, [id]);
        
        return { success: true };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}

// --- 🟢 19. CẬP NHẬT HÀNG LOẠT KHÁCH HÀNG (BULK UPDATE) ---
export async function bulkUpdateKhachHangAction(ids: string[], data: { phan_loai?: string; phan_loai_normalized?: string }) {
    try {
        await requireAdmin();
        
        if (!ids || ids.length === 0) {
            return { success: false, error: 'Không có ID nào được chọn' };
        }

        // Build SET clause dynamically
        const setClauses: string[] = [];
        const params: any[] = [];
        let paramCount = 1;

        if (data.phan_loai !== undefined) {
            setClauses.push(`phan_loai = $${paramCount}`);
            params.push(data.phan_loai);
            paramCount++;
        }

        if (data.phan_loai_normalized !== undefined) {
            setClauses.push(`phan_loai_normalized = $${paramCount}`);
            params.push(data.phan_loai_normalized);
            paramCount++;
        }

        if (setClauses.length === 0) {
            return { success: false, error: 'Không có dữ liệu để cập nhật' };
        }

        // Create placeholders for IDs: $3, $4, $5, ...
        const idPlaceholders = ids.map((_, i) => `$${paramCount + i}`).join(', ');
        params.push(...ids);

        const query = `UPDATE "khach_hang" SET ${setClauses.join(', ')} WHERE id IN (${idPlaceholders})`;
        
        await sql.unsafe(query, params);
        
        return { success: true, updated: ids.length };
    } catch (error: any) {
        return { success: false, error: error.message };
    }
}
</file>

<file path="app/components/NutHoTro.tsx">
"use client";

import React, { useState, useEffect, useRef, useMemo } from "react";
import {
  MessageCircle,
  X,
  Send,
  User,
  ShieldCheck,
  Image as ImageIcon,
  Loader2,
  Headphones,
  PhoneCall,
  Info,
  LogIn,
} from "lucide-react";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { useUser } from "@/app/ThuVien/UserContext";
import { useRouter } from "next/navigation";
import { compressImage } from "@/app/ThuVien/compressImage";

// Hook âm thanh click nhẹ
const useSoundEffect = () => {
  const audioRef = useRef<HTMLAudioElement | null>(null);
  useEffect(() => {
    if (typeof window !== "undefined") {
      audioRef.current = new Audio("/sounds/click.mp3");
      audioRef.current.volume = 0.5;
    }
  }, []);
  return () => audioRef.current?.play().catch(() => {});
};

// 🟢 Helper tạo ID khách vãng lai (Giữ chat khi F5)
const getGuestId = () => {
  if (typeof window === "undefined") return "guest";
  let id = localStorage.getItem("guest_chat_id");
  if (!id) {
    id = "guest_" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem("guest_chat_id", id);
  }
  return id;
};

export default function NutHoTro() {
  const { user } = useUser();
  const router = useRouter();
  const playClick = useSoundEffect();

  // State
  const [isOpen, setIsOpen] = useState(false);
  const [viewMode, setViewMode] = useState<"form_guest" | "chat">("form_guest");
  const [isSending, setIsSending] = useState(false);
  const [guestInfo, setGuestInfo] = useState({ name: "", phone: "" });
  const [messages, setMessages] = useState<any[]>([]);
  const [inputMsg, setInputMsg] = useState("");
  const [sessionId, setSessionId] = useState<string | null>(null);
  const [onlineStaffCount, setOnlineStaffCount] = useState(0);

  // 🟢 Thêm state thông tin nhân viên đang chat
  const [staffInfo, setStaffInfo] = useState<any>(null);

  const scrollRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const guestId = getGuestId(); // Lấy ID khách vãng lai

  // 1. REALTIME STAFF COUNT
  useEffect(() => {
    const channel = supabase.channel("online-users-counter");
    channel
      .on("presence", { event: "sync" }, () => {
        const state = channel.presenceState();
        const allUsers: any[] = Object.values(state).flat();
        const supportStaff = allUsers.filter(
          (u) =>
            u.role &&
            ["admin", "boss", "quanly", "sales"].includes(u.role.toLowerCase())
        );
        setOnlineStaffCount(supportStaff.length);
      })
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, []);

  // 2. CHECK USER & RESTORE SESSION
  useEffect(() => {
    if (isOpen) {
      if (user) {
        setViewMode("chat");
        initChatSession(
          user.id,
          user.ho_ten || "Khách hàng",
          user.so_dien_thoai
        );
      } else {
        const saved = localStorage.getItem("guest_chat_info");
        if (saved) {
          const p = JSON.parse(saved);
          setGuestInfo(p);
          setViewMode("chat");
          initChatSession(null, p.name, p.phone);
        } else if (localStorage.getItem("guest_chat_id")) {
          checkExistingGuestSession();
        } else {
          setViewMode("form_guest");
        }
      }
    }
  }, [isOpen, user]);

  // Hàm kiểm tra session cũ của khách vãng lai
  const checkExistingGuestSession = async () => {
    const { data } = await supabase
      .from("tu_van_sessions")
      .select("*")
      .eq("khach_vang_lai_id", guestId)
      .neq("trang_thai", "ket_thuc")
      .single();
    if (data) {
      setViewMode("chat");
      setSessionId(data.id);
      subscribeToChat(data.id);
    } else {
      setViewMode("form_guest");
    }
  };

  // Auto scroll
  useEffect(() => {
    if (scrollRef.current)
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
  }, [messages, viewMode, isOpen]);

  // 3. LOGIC HIỂN THỊ THÔNG BÁO LỊCH SỰ
  const showPoliteMessage = useMemo(() => {
    if (messages.length < 2) return false;
    const last2 = messages.slice(-2);
    return last2.every((m) => !m.la_nhan_vien);
  }, [messages]);

  // Init Session
  const initChatSession = async (
    userId: string | null,
    name: string,
    phone: string | null
  ) => {
    let q = supabase
      .from("tu_van_sessions")
      .select("*")
      .neq("trang_thai", "ket_thuc");

    if (userId) q = q.eq("khach_hang_id", userId);
    else q = q.eq("khach_vang_lai_id", guestId);

    const { data } = await q
      .order("cap_nhat_luc", { ascending: false })
      .limit(1);

    if (data && data.length > 0) {
      setSessionId(data[0].id);
      subscribeToChat(data[0].id);

      if (data[0].nhan_su_phu_trach_id) {
        const { data: s } = await supabase
          .from("nhan_su")
          .select("ho_ten, hinh_anh")
          .eq("id", data[0].nhan_su_phu_trach_id)
          .single();
        setStaffInfo(s);
      }
    }
  };

  // 🟢 Subscribe Chat (Đã tối ưu)
  const subscribeToChat = async (sId: string) => {
    const { data } = await supabase
      .from("tu_van_messages")
      .select("*")
      .eq("session_id", sId)
      .order("tao_luc", { ascending: true });
    if (data) setMessages(data);

    // Dùng tên channel unique để tránh conflict
    const channel = supabase
      .channel(`guest_chat_room_${sId}`)
      .on(
        "postgres_changes",
        {
          event: "INSERT",
          schema: "public",
          table: "tu_van_messages",
          filter: `session_id=eq.${sId}`,
        },
        (payload) => {
          setMessages((p) => {
            // Chống duplicate
            if (p.some((m) => m.id === payload.new.id)) return p;
            return [...p, payload.new];
          });
          if (scrollRef.current)
            scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
        }
      )
      .on(
        "postgres_changes",
        {
          event: "UPDATE",
          schema: "public",
          table: "tu_van_sessions",
          filter: `id=eq.${sId}`,
        },
        async (payload) => {
          if (
            payload.new.nhan_su_phu_trach_id &&
            payload.new.nhan_su_phu_trach_id !==
              payload.old.nhan_su_phu_trach_id
          ) {
            const { data: s } = await supabase
              .from("nhan_su")
              .select("ho_ten, hinh_anh")
              .eq("id", payload.new.nhan_su_phu_trach_id)
              .single();
            setStaffInfo(s);
          }
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  };

  // 4. GỬI TIN NHẮN & PUSH NOTIFICATION
  const handleSend = async (file?: File) => {
    if (!inputMsg.trim() && !file) return;

    setIsSending(true);
    const text = inputMsg;
    setInputMsg("");

    try {
      let activeId = sessionId;
      let imgUrl = null;
      let isNew = false;

      if (file) {
        const compressed = await compressImage(file, 0.7, 1200);
        const name = `chat_${Date.now()}_${file.name.replace(/\W/g, "")}`;
        const { error: upErr } = await supabase.storage
          .from("images")
          .upload(name, compressed);
        if (!upErr) {
          const { data } = supabase.storage.from("images").getPublicUrl(name);
          imgUrl = data.publicUrl;
        }
      }

      if (!activeId) {
        const { data: newSess, error } = await supabase
          .from("tu_van_sessions")
          .insert({
            khach_hang_id: user?.id || null,
            khach_vang_lai_id: !user ? guestId : null,
            ten_hien_thi:
              user?.ho_ten || guestInfo.name || `Khách ${guestId.slice(-4)}`,
            sdt_lien_he: user?.so_dien_thoai || guestInfo.phone,
            loai_khach: user ? "thanh_vien" : "vang_lai",
            trang_thai: "cho_tu_van",
            tin_nhan_cuoi: imgUrl ? "[Hình ảnh]" : text,
          })
          .select()
          .single();

        if (!error) {
          activeId = newSess.id;
          setSessionId(newSess.id);
          subscribeToChat(newSess.id);
          isNew = true;
        }
      } else {
        await supabase
          .from("tu_van_sessions")
          .update({
            tin_nhan_cuoi: imgUrl
              ? text
                ? `[Ảnh] ${text}`
                : "[Hình ảnh]"
              : text,
            cap_nhat_luc: new Date().toISOString(),
          })
          .eq("id", activeId);
      }

      if (activeId) {
        await supabase.from("tu_van_messages").insert({
          session_id: activeId,
          nguoi_gui_id: user?.id || guestId,
          la_nhan_vien: false,
          noi_dung: text,
          hinh_anh: imgUrl,
        });

        // Gửi thông báo cho nhân viên
        fetch("/api/push/notify-staff", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: `💬 Khách: ${user?.ho_ten || guestInfo.name || "Vãng lai"}`,
            body: text || "Đã gửi hình ảnh",
            url: "/quan-ly/tu-van",
            sessionId: activeId,
            targetStaffId: staffInfo ? null : null,
          }),
        }).catch(() => {});
      }
    } finally {
      setIsSending(false);
      if (fileInputRef.current) fileInputRef.current.value = "";
    }
  };

  const handleGuestSubmit = () => {
    if (!guestInfo.name.trim() || !guestInfo.phone.trim())
      return alert("Vui lòng nhập tên và SĐT");
    localStorage.setItem("guest_chat_info", JSON.stringify(guestInfo));
    setViewMode("chat");
    initChatSession(null, guestInfo.name, guestInfo.phone);
  };

  if (user?.userType === "nhan_su") return null; // Nhân sự dùng TuVanKhachHang

  return (
    <>
      <style jsx global>{`
        .glass-panel {
          background: rgba(10, 10, 10, 0.95);
          backdrop-filter: blur(20px);
          border-right: 1px solid rgba(198, 156, 109, 0.2);
          box-shadow: 10px 0 50px rgba(0, 0, 0, 0.8);
        }
        .chat-bubble-guest {
          background: #c69c6d;
          color: #000;
          border-radius: 12px 12px 2px 12px;
        }
        .chat-bubble-staff {
          background: #222;
          color: #fff;
          border: 1px solid #333;
          border-radius: 12px 12px 12px 2px;
        }
      `}</style>

      <div className="fixed bottom-6 left-6 z-[9000] font-sans flex flex-col items-start gap-4">
        {isOpen && (
          <div className="fixed inset-0 z-[9999] flex justify-start">
            <div
              className="absolute inset-0 bg-black/60 backdrop-blur-sm animate-in fade-in"
              onClick={() => setIsOpen(false)}
            ></div>
            <div className="relative w-full md:w-[450px] h-full glass-panel flex flex-col animate-in slide-in-from-left duration-300">
              {/* Header */}
              <div className="flex items-center justify-between p-5 border-b border-[#C69C6D]/20 bg-[#151515]">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-full bg-[#C69C6D]/10 flex items-center justify-center text-[#C69C6D]">
                    {staffInfo && staffInfo.hinh_anh ? (
                      <img
                        src={staffInfo.hinh_anh}
                        className="w-full h-full rounded-full object-cover"
                      />
                    ) : (
                      <Headphones size={20} />
                    )}
                  </div>
                  <div>
                    <h2 className="text-sm font-bold text-white uppercase tracking-widest">
                      {staffInfo ? staffInfo.ho_ten : "Trung Tâm Hỗ Trợ"}
                    </h2>
                    <div className="flex items-center gap-1.5 mt-1">
                      <span
                        className={`w-2 h-2 rounded-full ${
                          onlineStaffCount > 0
                            ? "bg-green-500 animate-pulse"
                            : "bg-gray-500"
                        }`}
                      ></span>
                      <span className="text-[10px] text-white/60">
                        {staffInfo
                          ? "Đang hỗ trợ bạn"
                          : onlineStaffCount > 0
                          ? `${onlineStaffCount} tư vấn viên Online`
                          : "Đang ngoại tuyến"}
                      </span>
                    </div>
                  </div>
                </div>
                <button
                  onClick={() => setIsOpen(false)}
                  className="p-2 hover:bg-white/10 rounded-full text-white/60 hover:text-white transition-colors"
                >
                  <X size={24} />
                </button>
              </div>

              {/* Body */}
              <div className="flex-1 bg-[#0a0a0a] relative overflow-hidden flex flex-col">
                {viewMode === "form_guest" ? (
                  <div className="flex-1 flex flex-col justify-center p-8 space-y-6 animate-in zoom-in-95">
                    <div className="text-center space-y-3">
                      <ShieldCheck
                        size={48}
                        className="mx-auto text-[#C69C6D]"
                      />
                      <h3 className="text-lg font-bold text-white">
                        Kết Nối Với Chúng Tôi
                      </h3>
                      <p className="text-white/50 text-sm">
                        Để được hỗ trợ tốt nhất, quý khách vui lòng để lại thông
                        tin liên hệ.
                      </p>
                    </div>
                    <div className="space-y-4">
                      <input
                        placeholder="Họ và tên của bạn"
                        className="w-full bg-[#1a1a1a] border border-white/10 rounded-xl p-4 text-white outline-none focus:border-[#C69C6D] transition-all"
                        value={guestInfo.name}
                        onChange={(e) =>
                          setGuestInfo({ ...guestInfo, name: e.target.value })
                        }
                      />
                      <input
                        placeholder="Số điện thoại liên hệ"
                        className="w-full bg-[#1a1a1a] border border-white/10 rounded-xl p-4 text-white outline-none focus:border-[#C69C6D] transition-all"
                        value={guestInfo.phone}
                        onChange={(e) =>
                          setGuestInfo({ ...guestInfo, phone: e.target.value })
                        }
                      />
                      <button
                        onClick={handleGuestSubmit}
                        className="w-full py-4 bg-[#C69C6D] text-black font-bold uppercase tracking-wider rounded-xl hover:bg-white transition-all shadow-[0_0_20px_rgba(198,156,109,0.3)]"
                      >
                        Bắt đầu trò chuyện
                      </button>
                    </div>
                    <div className="text-center pt-4 border-t border-white/5">
                      <button
                        onClick={() => {
                          setIsOpen(false);
                          router.push("/?login=1");
                        }}
                        className="text-white/40 hover:text-[#C69C6D] text-xs uppercase font-bold tracking-widest transition-colors flex items-center justify-center gap-2"
                      >
                        <LogIn size={14} /> Đăng nhập tài khoản
                      </button>
                    </div>
                  </div>
                ) : (
                  <>
                    {/* Chat Messages */}
                    <div
                      className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar"
                      ref={scrollRef}
                    >
                      <div className="text-center py-4">
                        <span className="text-[10px] text-white/20 uppercase tracking-widest border px-3 py-1 rounded-full border-white/10">
                          Kênh hỗ trợ bảo mật
                        </span>
                      </div>
                      {messages.map((m) => (
                        <div
                          key={m.id}
                          className={`flex ${
                            m.la_nhan_vien ? "justify-start" : "justify-end"
                          }`}
                        >
                          <div
                            className={`max-w-[80%] p-3 text-sm font-medium shadow-md ${
                              m.la_nhan_vien
                                ? "chat-bubble-staff"
                                : "chat-bubble-guest"
                            }`}
                          >
                            {m.hinh_anh && (
                              <img
                                src={m.hinh_anh}
                                className="w-full h-auto rounded-lg mb-2 border border-black/10"
                              />
                            )}
                            {m.noi_dung}
                          </div>
                        </div>
                      ))}
                      {showPoliteMessage && (
                        <div className="bg-[#15202B] border border-[#C69C6D]/30 p-4 rounded-xl flex gap-4 animate-in fade-in slide-in-from-bottom-2 shadow-xl mx-2">
                          <Info className="text-[#C69C6D] shrink-0" size={24} />
                          <div className="flex-1">
                            <p className="text-[#C69C6D] text-sm font-bold mb-1">
                              QUÝ KHÁCH CẦN HỖ TRỢ GẤP?
                            </p>
                            <p className="text-white/70 text-xs mb-3 leading-relaxed">
                              Hiện tại các tư vấn viên đang bận. Quý khách vui
                              lòng gọi trực tiếp để được ưu tiên phục vụ.
                            </p>
                            <div className="flex gap-2">
                              <a
                                href="tel:0939941588"
                                className="flex-1 bg-[#1E3A8A] hover:bg-[#1E40AF] text-white text-xs py-2 rounded-lg font-bold flex items-center justify-center gap-1 transition-colors"
                              >
                                <PhoneCall size={12} /> MS. CHI
                              </a>
                              <a
                                href="tel:0939852511"
                                className="flex-1 bg-[#065F46] hover:bg-[#047857] text-white text-xs py-2 rounded-lg font-bold flex items-center justify-center gap-1 transition-colors"
                              >
                                <PhoneCall size={12} /> MR. TOMMY
                              </a>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>

                    {/* Input Area */}
                    <div className="p-4 bg-[#111] border-t border-white/10 flex gap-3 items-end">
                      <button
                        onClick={() => fileInputRef.current?.click()}
                        className="p-3 bg-white/5 hover:bg-white/10 rounded-xl text-white/60 hover:text-[#C69C6D] transition-colors h-[46px] w-[46px] flex items-center justify-center"
                      >
                        <ImageIcon size={20} />
                      </button>
                      <input
                        type="file"
                        ref={fileInputRef}
                        className="hidden"
                        accept="image/*"
                        onChange={(e) =>
                          e.target.files?.[0] && handleSend(e.target.files[0])
                        }
                      />
                      <div className="flex-1 bg-white/5 border border-white/10 rounded-xl flex items-center px-4 min-h-[46px] focus-within:border-[#C69C6D] transition-colors">
                        <input
                          className="flex-1 bg-transparent text-sm text-white placeholder-white/30 outline-none py-3"
                          placeholder={
                            isSending ? "Đang gửi..." : "Nhập tin nhắn..."
                          }
                          value={inputMsg}
                          onChange={(e) => setInputMsg(e.target.value)}
                          onKeyDown={(e) => e.key === "Enter" && handleSend()}
                          disabled={isSending}
                        />
                        <button
                          onClick={() => handleSend()}
                          disabled={isSending}
                          className="ml-2 text-[#C69C6D] hover:text-white disabled:opacity-50 transition-colors"
                        >
                          {isSending ? (
                            <Loader2 size={20} className="animate-spin" />
                          ) : (
                            <Send size={20} />
                          )}
                        </button>
                      </div>
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Floating Toggle Button */}
        {!isOpen && (
          <button
            onClick={() => {
              playClick();
              setIsOpen(true);
            }}
            className="w-14 h-14 rounded-full flex items-center justify-center bg-[#C69C6D] text-black shadow-[0_0_30px_rgba(198,156,109,0.4)] hover:scale-110 active:scale-95 transition-all animate-bounce-slow z-[9000] border-2 border-white/20"
          >
            <MessageCircle size={28} fill="currentColor" />
            {onlineStaffCount > 0 && (
              <span className="absolute top-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-black"></span>
            )}
          </button>
        )}
      </div>
    </>
  );
}
</file>

<file path="app/components/TuVanKhachHang.tsx">
"use client";

import React, { useState, useEffect, useRef, useMemo } from "react";
import {
  MessageSquare,
  X,
  Send,
  User,
  AlertCircle,
  Shield,
  Briefcase,
  Image as ImageIcon,
  Loader2,
  BellRing,
  UserPlus,
  Search,
  MoreVertical,
  Check,
  Circle,
} from "lucide-react";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { useUser } from "@/app/ThuVien/UserContext";
import { compressImage } from "@/app/ThuVien/compressImage";

const formatTime = (iso: string) => {
  if (!iso) return "";
  const d = new Date(iso);
  return `${d.getHours()}:${String(d.getMinutes()).padStart(2, "0")}`;
};

export default function TuVanKhachHang() {
  const { user } = useUser();

  // --- STATE UI ---
  const [isOpen, setIsOpen] = useState(false);
  const [activeTab, setActiveTab] = useState<"waiting" | "my_chats" | "all">(
    "waiting"
  );
  const [showInviteModal, setShowInviteModal] = useState(false);

  // --- STATE DATA ---
  const [allSessions, setAllSessions] = useState<any[]>([]);
  const [staffList, setStaffList] = useState<any[]>([]);
  const [onlineStaffIds, setOnlineStaffIds] = useState<Set<string>>(new Set());

  // --- STATE CHAT ---
  const [selectedSession, setSelectedSession] = useState<any>(null);
  const [messages, setMessages] = useState<any[]>([]);
  const [inputMsg, setInputMsg] = useState("");
  const [isSending, setIsSending] = useState(false);
  const [isLoadingMessages, setIsLoadingMessages] = useState(false);

  // Refs
  const ringtoneRef = useRef<HTMLAudioElement | null>(null);
  const scrollRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const isManager =
    user && ["admin", "quanly", "boss"].includes(user.role || "");

  // 1. INIT SOUND & STAFF LIST (ĐÃ SỬA LẠI QUERY)
  useEffect(() => {
    if (typeof window !== "undefined") {
      ringtoneRef.current = new Audio("/sounds/ring.mp3");
      ringtoneRef.current.loop = true;
    }

    // 🟢 LOAD DANH SÁCH NHÂN VIÊN ĐỂ MỜI (FIXED)
    const fetchStaff = async () => {
      const { data, error } = await supabase
        .from("nhan_su")
        .select("id, ho_ten, hinh_anh, vi_tri, vi_tri_normalized")
        .eq("trang_thai", "dang_lam_viec")
        // Chỉ lấy những người có vai trò hỗ trợ
        .in("vi_tri_normalized", ["admin", "quanly", "sales"]);

      if (error) {
        console.error("Lỗi lấy danh sách nhân viên:", error);
      } else if (data) {
        setStaffList(data);
      }
    };

    if (user) fetchStaff();
  }, [user]);

  // 2. REALTIME ONLINE STATUS
  useEffect(() => {
    if (!user) return;
    const channel = supabase.channel("online_staff_tracking");
    channel
      .on("presence", { event: "sync" }, () => {
        const state = channel.presenceState();
        const ids = new Set<string>();
        Object.values(state).forEach((presences: any) => {
          presences.forEach((p: any) => {
            if (p.user_id) ids.add(p.user_id);
          });
        });
        setOnlineStaffIds(ids);
      })
      .subscribe(async (status) => {
        if (status === "SUBSCRIBED") {
          await channel.track({
            user_id: user.id,
            online_at: new Date().toISOString(),
          });
        }
      });
    return () => {
      supabase.removeChannel(channel);
    };
  }, [user]);

  // 3. LOAD SESSIONS & SUBSCRIBE
  useEffect(() => {
    if (!user) return;

    const fetchSessions = async () => {
      const { data } = await supabase
        .from("tu_van_sessions")
        .select("*")
        .neq("trang_thai", "ket_thuc")
        .order("cap_nhat_luc", { ascending: false });
      if (data) setAllSessions(data);
    };
    fetchSessions();

    const channel = supabase
      .channel("staff_chat_global")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "tu_van_sessions" },
        (payload) => {
          if (payload.eventType === "INSERT") {
            setAllSessions((prev) => [payload.new, ...prev]);
          } else if (payload.eventType === "UPDATE") {
            setAllSessions((prev) =>
              prev.map((s) => (s.id === payload.new.id ? payload.new : s))
            );
            if (selectedSession?.id === payload.new.id) {
              setSelectedSession(payload.new);
            }
          }
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [user, selectedSession?.id]);

  // 4. LOAD MESSAGES
  useEffect(() => {
    if (!selectedSession) return;

    setIsLoadingMessages(true);
    const fetchMsgs = async () => {
      const { data, error } = await supabase
        .from("tu_van_messages")
        .select("*")
        .eq("session_id", selectedSession.id)
        .order("tao_luc", { ascending: true });

      if (!error && data) {
        setMessages(data);
        scrollToBottom();
      }
      setIsLoadingMessages(false);
    };
    fetchMsgs();

    const isMine =
      selectedSession.nhan_su_phu_trach_id === user?.id ||
      (selectedSession.ho_tro_vien_ids &&
        selectedSession.ho_tro_vien_ids.includes(user?.id));
    if (
      isMine &&
      !selectedSession.is_read &&
      selectedSession.last_sender_type === "customer"
    ) {
      supabase.rpc("mark_session_as_read", {
        p_session_id: selectedSession.id,
      });
    }

    const channel = supabase
      .channel(`room_${selectedSession.id}`)
      .on(
        "postgres_changes",
        {
          event: "INSERT",
          schema: "public",
          table: "tu_van_messages",
          filter: `session_id=eq.${selectedSession.id}`,
        },
        (payload) => {
          setMessages((prev) => [...prev, payload.new]);
          scrollToBottom();
          if (!payload.new.la_nhan_vien) {
            supabase.rpc("mark_session_as_read", {
              p_session_id: selectedSession.id,
            });
          }
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [selectedSession?.id]);

  const scrollToBottom = () => {
    setTimeout(() => {
      if (scrollRef.current)
        scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }, 100);
  };

  // --- LOGIC PHÂN LOẠI & BADGE ---
  const displayedSessions = useMemo(() => {
    if (!user) return [];
    if (activeTab === "waiting")
      return allSessions.filter((s) => !s.nhan_su_phu_trach_id);
    if (activeTab === "my_chats")
      return allSessions.filter(
        (s) =>
          s.nhan_su_phu_trach_id === user.id ||
          (s.ho_tro_vien_ids && s.ho_tro_vien_ids.includes(user.id))
      );
    return allSessions.filter((s) => s.nhan_su_phu_trach_id);
  }, [allSessions, activeTab, user]);

  const badgeCount = useMemo(() => {
    if (!user) return 0;
    const waiting = allSessions.filter((s) => !s.nhan_su_phu_trach_id).length;
    const myUnread = allSessions.filter(
      (s) =>
        (s.nhan_su_phu_trach_id === user.id ||
          (s.ho_tro_vien_ids && s.ho_tro_vien_ids.includes(user.id))) &&
        s.is_read === false &&
        s.last_sender_type === "customer"
    ).length;
    return waiting + myUnread;
  }, [allSessions, user]);

  useEffect(() => {
    if (badgeCount > 0 && !isOpen) ringtoneRef.current?.play().catch(() => {});
    else {
      ringtoneRef.current?.pause();
      if (ringtoneRef.current) ringtoneRef.current.currentTime = 0;
    }
  }, [badgeCount, isOpen]);

  // --- ACTIONS ---
  const handleClaim = async () => {
    if (!selectedSession || !user) return;
    const { data: check } = await supabase
      .from("tu_van_sessions")
      .select("nhan_su_phu_trach_id")
      .eq("id", selectedSession.id)
      .single();
    if (check?.nhan_su_phu_trach_id) {
      alert("Đã có người nhận!");
      return;
    }
    await supabase
      .from("tu_van_sessions")
      .update({
        nhan_su_phu_trach_id: user.id,
        trang_thai: "dang_tu_van",
        ho_tro_vien_ids: [],
      })
      .eq("id", selectedSession.id);
    setActiveTab("my_chats");
  };

  const handleSend = async (file?: File) => {
    if ((!inputMsg.trim() && !file) || !selectedSession || !user) return;
    if (!selectedSession.nhan_su_phu_trach_id) {
      if (!confirm("Tiếp nhận khách này?")) return;
      await handleClaim();
    }
    setIsSending(true);
    const text = inputMsg;
    setInputMsg("");
    try {
      let imageUrl = null;
      if (file) {
        const compressed = await compressImage(file, 0.7, 1200);
        const fileName = `staff_chat_${Date.now()}_${file.name}`;
        const { error } = await supabase.storage
          .from("images")
          .upload(fileName, compressed);
        if (!error)
          imageUrl = supabase.storage.from("images").getPublicUrl(fileName)
            .data.publicUrl;
      }
      await supabase.from("tu_van_messages").insert({
        session_id: selectedSession.id,
        nguoi_gui_id: user.id,
        la_nhan_vien: true,
        noi_dung: text,
        hinh_anh: imageUrl,
      });
    } finally {
      setIsSending(false);
      scrollToBottom();
    }
  };

  const handleInvite = async (staffId: string) => {
    // Gọi RPC để add staffId vào mảng ho_tro_vien_ids
    const { error } = await supabase.rpc("invite_staff_to_session", {
      p_session_id: selectedSession.id,
      p_staff_id: staffId,
    });

    if (error) {
      console.error("Lỗi mời:", error);
      alert("Không thể mời. Vui lòng thử lại.");
    } else {
      setShowInviteModal(false);
      alert("Đã thêm vào nhóm chat!");
    }
  };

  if (!user || user.userType !== "nhan_su") return null;
  const UserIcon = isManager ? Shield : Briefcase;

  return (
    <>
      <div className="fixed bottom-6 left-6 z-[9000]">
        <button
          onClick={() => setIsOpen(!isOpen)}
          className={`group relative w-16 h-16 rounded-full flex items-center justify-center shadow-2xl transition-all border-2 ${
            badgeCount > 0 && !isOpen
              ? "bg-red-600 border-white animate-bounce"
              : "bg-[#C69C6D] border-[#C69C6D] text-black hover:scale-110"
          }`}
        >
          {badgeCount > 0 && !isOpen ? (
            <BellRing size={32} className="text-white" />
          ) : isOpen ? (
            <X size={28} />
          ) : (
            <User size={32} />
          )}
          {!isOpen && badgeCount > 0 && (
            <span className="absolute -top-2 -right-2 w-7 h-7 bg-white text-red-600 border-2 border-red-600 rounded-full flex items-center justify-center text-xs font-black">
              {badgeCount}
            </span>
          )}
        </button>
      </div>

      {isOpen && (
        <div className="fixed inset-4 md:inset-10 z-[8999] bg-[#0a0a0a] border border-[#C69C6D]/30 rounded-2xl shadow-2xl flex overflow-hidden animate-in zoom-in-95 duration-200 flex-col md:flex-row">
          {/* CỘT TRÁI: LIST */}
          <div className="w-full md:w-[350px] border-r border-white/10 flex flex-col bg-[#111]">
            <div className="p-4 border-b border-white/10 bg-[#161616]">
              <div className="flex items-center gap-3 mb-4">
                <div className="w-10 h-10 rounded-full bg-[#C69C6D]/20 flex items-center justify-center text-[#C69C6D]">
                  <UserIcon size={20} />
                </div>
                <div>
                  <div className="font-bold text-white uppercase">
                    {user.ho_ten}
                  </div>
                  <div className="text-xs text-gray-400">Trực tuyến</div>
                </div>
              </div>
              <div className="flex bg-black p-1 rounded-lg border border-white/10">
                <button
                  onClick={() => setActiveTab("waiting")}
                  className={`flex-1 py-2 text-xs font-bold rounded ${
                    activeTab === "waiting"
                      ? "bg-red-600 text-white"
                      : "text-gray-400 hover:text-white"
                  }`}
                >
                  CHỜ (
                  {allSessions.filter((s) => !s.nhan_su_phu_trach_id).length})
                </button>
                <button
                  onClick={() => setActiveTab("my_chats")}
                  className={`flex-1 py-2 text-xs font-bold rounded ${
                    activeTab === "my_chats"
                      ? "bg-[#C69C6D] text-black"
                      : "text-gray-400 hover:text-white"
                  }`}
                >
                  CỦA TÔI
                </button>
                {isManager && (
                  <button
                    onClick={() => setActiveTab("all")}
                    className={`flex-1 py-2 text-xs font-bold rounded ${
                      activeTab === "all"
                        ? "bg-blue-600 text-white"
                        : "text-gray-400 hover:text-white"
                    }`}
                  >
                    GIÁM SÁT
                  </button>
                )}
              </div>
            </div>

            <div className="flex-1 overflow-y-auto custom-scrollbar bg-[#0a0a0a]">
              {displayedSessions.map((s) => {
                const isUnread =
                  activeTab === "my_chats" &&
                  !s.is_read &&
                  s.last_sender_type === "customer";
                return (
                  <div
                    key={s.id}
                    onClick={() => setSelectedSession(s)}
                    className={`p-4 border-b border-white/5 cursor-pointer hover:bg-white/5 relative ${
                      selectedSession?.id === s.id ? "bg-white/10" : ""
                    } ${isUnread ? "bg-[#C69C6D]/10" : ""}`}
                  >
                    {isUnread && (
                      <div className="absolute top-4 right-4 w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_#22c55e]"></div>
                    )}
                    <div className="flex justify-between mb-1">
                      <span
                        className={`font-bold text-sm ${
                          isUnread ? "text-[#C69C6D]" : "text-white"
                        }`}
                      >
                        {s.ten_hien_thi}
                      </span>
                      <span className="text-[10px] text-gray-500">
                        {formatTime(s.cap_nhat_luc)}
                      </span>
                    </div>
                    <div
                      className={`text-xs truncate ${
                        isUnread ? "text-white font-bold" : "text-gray-400"
                      }`}
                    >
                      {s.last_sender_type === "staff" ? "Bạn: " : ""}{" "}
                      {s.tin_nhan_cuoi || "..."}
                    </div>
                  </div>
                );
              })}
              {displayedSessions.length === 0 && (
                <div className="p-8 text-center text-gray-600 text-sm">
                  Không có dữ liệu
                </div>
              )}
            </div>
          </div>

          {/* CỘT PHẢI: CHAT */}
          <div className="flex-1 flex flex-col bg-[#050505] relative min-w-0">
            {selectedSession ? (
              <>
                <div className="h-16 border-b border-white/10 flex justify-between items-center px-6 bg-[#161616] shrink-0">
                  <div>
                    <h3 className="font-bold text-white">
                      {selectedSession.ten_hien_thi}
                    </h3>
                    <div className="flex items-center gap-2 text-xs text-gray-400">
                      <span>
                        {selectedSession.nhan_su_phu_trach_id
                          ? selectedSession.nhan_su_phu_trach_id === user.id
                            ? "Đang chat với bạn"
                            : "Đồng nghiệp đang chat"
                          : "Chưa ai nhận"}
                      </span>
                      {selectedSession.ho_tro_vien_ids?.length > 0 && (
                        <span className="bg-blue-900/50 text-blue-300 px-2 rounded-full text-[10px]">
                          Có hỗ trợ
                        </span>
                      )}
                    </div>
                  </div>
                  <div className="flex gap-3">
                    {!selectedSession.nhan_su_phu_trach_id ? (
                      <button
                        onClick={handleClaim}
                        className="px-4 py-2 bg-[#C69C6D] hover:bg-white text-black font-bold text-xs rounded animate-pulse"
                      >
                        TIẾP NHẬN
                      </button>
                    ) : (
                      // 🟢 NÚT MỜI ĐỒNG NGHIỆP: Chỉ hiện cho người phụ trách hoặc Admin
                      (selectedSession.nhan_su_phu_trach_id === user.id ||
                        isManager) && (
                        <button
                          onClick={() => setShowInviteModal(true)}
                          className="p-2 bg-white/5 hover:bg-white/20 rounded-full text-white"
                          title="Mời đồng nghiệp"
                        >
                          <UserPlus size={20} />
                        </button>
                      )
                    )}
                  </div>
                </div>

                <div
                  className="flex-1 overflow-y-auto p-6 space-y-4 bg-black/50"
                  ref={scrollRef}
                >
                  {isLoadingMessages ? (
                    <div className="flex justify-center pt-10">
                      <Loader2
                        className="animate-spin text-[#C69C6D]"
                        size={30}
                      />
                    </div>
                  ) : (
                    messages.map((m) => (
                      <div
                        key={m.id}
                        className={`flex ${
                          m.la_nhan_vien ? "justify-end" : "justify-start"
                        }`}
                      >
                        <div
                          className={`max-w-[70%] p-3 rounded-2xl text-sm ${
                            m.la_nhan_vien
                              ? "bg-[#C69C6D] text-black"
                              : "bg-[#222] text-white border border-white/10"
                          }`}
                        >
                          {m.hinh_anh && (
                            <img
                              src={m.hinh_anh}
                              className="w-full h-auto rounded-lg mb-2"
                            />
                          )}
                          <p className="whitespace-pre-wrap">{m.noi_dung}</p>
                          <div className="text-[9px] mt-1 opacity-50 text-right">
                            {formatTime(m.tao_luc)}
                          </div>
                        </div>
                      </div>
                    ))
                  )}
                </div>

                <div className="p-4 border-t border-white/10 bg-[#161616] flex gap-3">
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="p-3 text-gray-400 hover:text-[#C69C6D] bg-white/5 rounded-xl"
                  >
                    <ImageIcon size={20} />
                  </button>
                  <input
                    type="file"
                    ref={fileInputRef}
                    className="hidden"
                    accept="image/*"
                    onChange={(e) =>
                      e.target.files?.[0] && handleSend(e.target.files[0])
                    }
                  />
                  <div className="flex-1 flex gap-2">
                    <input
                      className="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 text-white text-sm outline-none focus:border-[#C69C6D]"
                      placeholder="Nhập tin nhắn..."
                      value={inputMsg}
                      onChange={(e) => setInputMsg(e.target.value)}
                      onKeyDown={(e) => e.key === "Enter" && handleSend()}
                      disabled={
                        isSending ||
                        (!selectedSession.nhan_su_phu_trach_id && !isManager)
                      }
                    />
                    <button
                      onClick={() => handleSend()}
                      className="p-3 bg-[#C69C6D] hover:bg-white text-black rounded-xl disabled:opacity-50"
                    >
                      <Send size={20} />
                    </button>
                  </div>
                </div>
              </>
            ) : (
              <div className="flex-1 flex items-center justify-center text-white/20 flex-col gap-3">
                <MessageSquare size={64} />
                <p className="uppercase font-bold tracking-widest">
                  Chưa chọn hội thoại
                </p>
              </div>
            )}
          </div>

          {/* 🟢 MODAL MỜI ĐỒNG NGHIỆP (ĐÃ FIX: LẤY ĐÚNG DATA STAFF) */}
          {showInviteModal && (
            <div
              className="absolute inset-0 z-[9999] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4"
              onClick={() => setShowInviteModal(false)}
            >
              <div
                className="bg-[#1a1a1a] w-[400px] max-h-[80vh] rounded-2xl border border-white/10 shadow-2xl flex flex-col overflow-hidden"
                onClick={(e) => e.stopPropagation()}
              >
                <div className="p-4 border-b border-white/10 flex justify-between items-center bg-[#222]">
                  <h3 className="text-white font-bold uppercase">Mời hỗ trợ</h3>
                  <button onClick={() => setShowInviteModal(false)}>
                    <X className="text-gray-400 hover:text-white" size={20} />
                  </button>
                </div>
                <div className="flex-1 overflow-y-auto p-2 space-y-1">
                  {staffList.length === 0 && (
                    <div className="p-4 text-center text-gray-500 text-sm">
                      Không tìm thấy nhân viên hỗ trợ nào khác.
                    </div>
                  )}

                  {staffList
                    .filter((s) => s.id !== user.id)
                    .map((s) => {
                      const isOnline = onlineStaffIds.has(s.id);
                      return (
                        <button
                          key={s.id}
                          onClick={() => handleInvite(s.id)}
                          className="w-full flex items-center gap-3 p-3 hover:bg-white/10 rounded-xl transition-all group"
                        >
                          <div className="relative">
                            <div className="w-10 h-10 rounded-full bg-gray-700 overflow-hidden">
                              {s.hinh_anh ? (
                                <img
                                  src={s.hinh_anh}
                                  className="w-full h-full object-cover"
                                />
                              ) : (
                                <User
                                  size={20}
                                  className="m-auto text-gray-400"
                                />
                              )}
                            </div>
                            <div
                              className={`absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-[#1a1a1a] ${
                                isOnline ? "bg-green-500" : "bg-gray-500"
                              }`}
                            ></div>
                          </div>
                          <div className="text-left flex-1">
                            <div className="text-sm font-bold text-white group-hover:text-[#C69C6D]">
                              {s.ho_ten}
                            </div>
                            <div className="text-xs text-gray-500">
                              {s.vi_tri || "Nhân viên"} •{" "}
                              {isOnline ? "Online" : "Offline"}
                            </div>
                          </div>
                          <div className="w-8 h-8 rounded-full border border-white/10 flex items-center justify-center text-gray-400 group-hover:bg-[#C69C6D] group-hover:text-black group-hover:border-[#C69C6D]">
                            <UserPlus size={16} />
                          </div>
                        </button>
                      );
                    })}
                </div>
              </div>
            </div>
          )}
        </div>
      )}
    </>
  );
}
</file>

<file path="app/phongparttime/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { UserCheck } from 'lucide-react';

// Quyền của Part-time: chỉ xem
const PARTTIME_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const PARTTIME_FUNCTIONS = [
    { id: 'khachhang', label: 'KHÁCH HÀNG', icon: UserCheck },
];

export default function PhongPartTime() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('khachhang');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-[100dvh] bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PHÒNG PART-TIME"
            contentClassName="flex flex-col h-[100dvh] pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PHÒNG PART-TIME"
                functions={PARTTIME_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={PARTTIME_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="app/phongsales/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { UserCheck } from 'lucide-react';

// Quyền của Sales: xem, sửa - KHÔNG xóa, KHÔNG bulk
const SALES_PERMISSIONS = {
    allowView: true,
    allowEdit: true,
    allowDelete: false,
    allowBulk: false,
};

const SALES_FUNCTIONS = [
    { id: 'khachhang', label: 'KHÁCH HÀNG', icon: UserCheck },
];

export default function PhongSales() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('khachhang');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-[100dvh] bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PHÒNG SALES"
            contentClassName="flex flex-col h-[100dvh] pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PHÒNG SALES"
                functions={SALES_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={SALES_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="app/phongtrungbay/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { UserCheck } from 'lucide-react';

// Quyền của Trưng bày: chỉ xem
const TRUNGBAY_PERMISSIONS = {
    allowView: true,
    allowEdit: false,
    allowDelete: false,
    allowBulk: false,
};

const TRUNGBAY_FUNCTIONS = [
    { id: 'khachhang', label: 'KHÁCH HÀNG', icon: UserCheck },
];

export default function PhongTrungBay() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('khachhang');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    if (authLoading) {
        return (
            <div className="min-h-[100dvh] bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PHÒNG TRƯNG BÀY"
            contentClassName="flex flex-col h-[100dvh] pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            <ThanhPhongChucNang
                tenPhong="PHÒNG TRƯNG BÀY"
                functions={TRUNGBAY_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={TRUNGBAY_PERMISSIONS} />
                        )}
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="app/GiaoDienTong/MenuTren/MenuTren.tsx">
"use client";
import React, { useState, useEffect, useRef } from "react";
import { createPortal } from "react-dom";
import { ShoppingCart, QrCode, UserCircle } from "lucide-react";
import NhacNen from "@/app/Music/NhacNen";
import NotificationCenter from "./NotificationCenter";
import { NotificationService } from "./NotificationService";
import { Notification } from "./NotificationTypes";
import { useUser } from "@/app/ThuVien/UserContext";
import { Z_INDEX } from "@/app/constants/zIndex";
import { useAppSettings } from "@/app/ThuVien/AppSettingsContext";
import ModalProfile from "@/app/GiaoDienTong/MenuTren/NutCaNhan/ModalProfile";

// Hook âm thanh thông báo
const useNotificationSound = () => {
  const audioRef = useRef<HTMLAudioElement | null>(null);
  useEffect(() => {
    if (typeof window !== "undefined") {
      audioRef.current = new Audio("/sounds/hover.mp3");
    }
  }, []);
  return () => {
    if (audioRef.current) {
      audioRef.current.currentTime = 0;
      audioRef.current.play().catch(() => {});
    }
  };
};

export default function MenuTren({
  nguoiDung: fallbackUser,
}: {
  nguoiDung: any;
  loiChao: string;
}) {
  const { user: contextUser } = useUser();
  const { t } = useAppSettings();
  const playSound = useNotificationSound();

  // Ưu tiên user từ context
  const nguoiDung = contextUser
    ? {
        id: contextUser.id,
        ho_ten: contextUser.ho_ten || t("profile.user"),
        email: contextUser.email,
        role:
          contextUser.userType === "nhan_su"
            ? contextUser.vi_tri_normalized
            : contextUser.phan_loai_normalized,
        permissions: contextUser.permissions,
        vi_tri: contextUser.vi_tri,
        userType: contextUser.userType,
        phan_loai: contextUser.phan_loai,
        so_dien_thoai: contextUser.so_dien_thoai,
      }
    : fallbackUser;

  const isVisitor =
    !nguoiDung ||
    nguoiDung?.userType === "guest" ||
    nguoiDung?.role === "visitor";
  const isNhanSu = nguoiDung?.userType === "nhan_su";

  // State
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const [unreadCount, setUnreadCount] = useState(0);
  const [cartCount, setCartCount] = useState(0);
  const [showProfile, setShowProfile] = useState(false);
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  // 🟢 LOGIC LẤY TÊN HIỂN THỊ (RÚT GỌN CHO MOBILE)
  const getDisplayName = () => {
    if (isVisitor) return { full: "Quý Khách", short: "KHÁCH" };

    const fullName = nguoiDung?.ho_ten || "";
    const lastName = fullName.trim().split(" ").pop()?.toUpperCase() || "BẠN";

    return {
      full: fullName,
      short: lastName,
    };
  };

  const displayName = getDisplayName();

  // 🟢 LOGIC GIỎ HÀNG
  useEffect(() => {
    if (isNhanSu) return;

    const checkCart = () => {
      try {
        const cartData = localStorage.getItem("cart_items");
        const items = cartData ? JSON.parse(cartData) : [];
        setCartCount(items.length || 0);
      } catch {
        setCartCount(0);
      }
    };

    checkCart();
    window.addEventListener("storage", checkCart);
    window.addEventListener("cart_updated", checkCart);

    return () => {
      window.removeEventListener("storage", checkCart);
      window.removeEventListener("cart_updated", checkCart);
    };
  }, [isNhanSu]);

  // 🟢 NOTIFICATION LOGIC
  useEffect(() => {
    if (!nguoiDung?.id || isVisitor) return;

    let isMounted = true;
    let subscription: any = null;

    const initNotifications = async () => {
      try {
        const [notifs, count] = await Promise.all([
          NotificationService.getUserNotifications(nguoiDung.id),
          NotificationService.getUnreadCount(nguoiDung.id),
        ]);

        if (isMounted) {
          setNotifications(notifs);
          setUnreadCount(count);
        }

        subscription = NotificationService.subscribeToNotifications(
          nguoiDung.id,
          (newNotification) => {
            if (isMounted) {
              playSound();
              setNotifications((prev) => {
                if (prev.some((n) => n.id === newNotification.id)) return prev;
                return [newNotification, ...prev];
              });
              if (!newNotification.is_read) setUnreadCount((prev) => prev + 1);
            }
          }
        );
      } catch (error) {
        console.error("Lỗi thông báo:", error);
      }
    };

    initNotifications();

    return () => {
      isMounted = false;
      if (subscription?.unsubscribe) subscription.unsubscribe();
    };
  }, [nguoiDung?.id, isVisitor]);

  const handleMarkAsRead = async (id: string) => {
    setNotifications((prev) =>
      prev.map((n) => (n.id === id ? { ...n, is_read: true } : n))
    );
    setUnreadCount((prev) => Math.max(0, prev - 1));
    await NotificationService.markAsRead(id);
  };

  const handleMarkAllAsRead = async () => {
    if (!nguoiDung?.id) return;
    setNotifications((prev) => prev.map((n) => ({ ...n, is_read: true })));
    setUnreadCount(0);
    await NotificationService.markAllAsRead(nguoiDung.id);
  };

  const handleDelete = async (id: string) => {
    setNotifications((prev) => {
      const notif = prev.find((n) => n.id === id);
      if (notif && !notif.is_read) setUnreadCount((c) => Math.max(0, c - 1));
      return prev.filter((n) => n.id !== id);
    });
    await NotificationService.deleteNotification(id);
  };

  const handleNotificationClick = (notification: Notification) => {
    if (notification.action_url) window.location.href = notification.action_url;
    if (!notification.is_read) handleMarkAsRead(notification.id);
  };

  return (
    <>
      <div
        className={`fixed top-0 left-0 right-0 h-[65px] md:h-[85px] px-3 md:px-6 flex justify-between items-center bg-transparent transition-all duration-300 pointer-events-none`}
        style={{ zIndex: Z_INDEX.menuTren }}
      >
        {/* 🟢 GÓC TRÁI: TÊN HIỂN THỊ (CO GIÃN TỐT) */}
        <div className="flex-1 min-w-0 flex items-center gap-2 animate-slide-down pointer-events-auto mr-2">
          {/* Desktop: Hiện đầy đủ */}
          <div className="hidden md:flex flex-col">
            <span className="text-xs font-medium italic text-gray-300 drop-shadow-md">
              {isVisitor ? "Chào mừng," : "Xin chào,"}
            </span>
            <span
              className="font-black text-white uppercase tracking-wider drop-shadow-lg shadow-black truncate max-w-[200px] lg:max-w-none"
              style={{ fontSize: "20px" }}
            >
              {displayName.full}
            </span>
          </div>

          {/* Mobile: Hiện rút gọn */}
          <div className="md:hidden flex items-baseline gap-1 overflow-hidden">
            <span className="text-[10px] text-gray-300 italic whitespace-nowrap">
              Chào
            </span>
            <span className="font-bold text-[#C69C6D] uppercase truncate text-sm drop-shadow-md">
              {displayName.short}
            </span>
          </div>
        </div>

        {/* 🟢 GÓC PHẢI: CÁC NÚT (KHÔNG BAO GIỜ BỊ ĐẨY MẤT) */}
        {!isVisitor && (
          <div className="shrink-0 flex gap-1.5 md:gap-3 animate-slide-down delay-100 pointer-events-auto items-center">
            {/* 1. Nhạc nền: Hiện mọi nơi */}
            {nguoiDung?.id && <NhacNen />}

            {/* 2. Giỏ hàng: Chỉ hiện nếu là Khách hàng & có đồ */}
            {!isNhanSu && cartCount > 0 && (
              <NutVuong
                icon={ShoppingCart}
                badge={cartCount}
                onClick={() => {
                  /* Logic mở giỏ hàng */
                }}
                className="animate-bounce-slow"
              />
            )}

            {/* 3. Thông báo */}
            {nguoiDung?.id && (
              <NotificationCenter
                notifications={notifications}
                unreadCount={unreadCount}
                onMarkAsRead={handleMarkAsRead}
                onMarkAllAsRead={handleMarkAllAsRead}
                onDelete={handleDelete}
                onNotificationClick={handleNotificationClick}
              />
            )}

            {/* 4. QR Code: CHỈ HIỆN TRÊN DESKTOP (Mobile ẩn đi để tiết kiệm chỗ cho Nhạc) */}
            <div className="hidden md:block">
              <NutVuong icon={QrCode} />
            </div>

            {/* 5. Nút Cá Nhân: Luôn hiện */}
            <NutVuong
              icon={UserCircle}
              onClick={() => setShowProfile(true)}
              isActive={showProfile}
            />
          </div>
        )}
      </div>

      {mounted &&
        showProfile &&
        nguoiDung &&
        !isVisitor &&
        createPortal(
          <ModalProfile
            isOpen={true}
            onClose={() => setShowProfile(false)}
            nguoiDung={nguoiDung}
          />,
          document.body
        )}
    </>
  );
}

// Component Nút Vuông (Đã chỉnh padding nhỏ hơn cho Mobile)
function NutVuong({
  icon: Icon,
  badge,
  onClick,
  isActive,
  className = "",
}: any) {
  return (
    <button
      onClick={onClick}
      className={`
                w-9 h-9 md:w-10 md:h-10 rounded-lg flex items-center justify-center relative active:scale-95 transition-all backdrop-blur-sm shadow-sm group cursor-pointer
                ${
                  isActive
                    ? "bg-[#C69C6D] border border-[#C69C6D] text-black shadow-[0_0_15px_rgba(198,156,109,0.4)]"
                    : "bg-black/40 border border-white/10 hover:bg-white/10 text-white"
                }
                ${className}
            `}
    >
      <Icon
        size={18}
        className={`transition-colors ${
          isActive ? "text-black" : "text-white group-hover:text-[#C69C6D]"
        }`}
      />

      {badge && badge > 0 && (
        <span className="absolute -top-1.5 -right-1.5 w-4 h-4 bg-red-600 text-white text-[9px] font-bold flex items-center justify-center rounded-full border border-black shadow-sm z-10 animate-in zoom-in">
          {badge > 99 ? "99+" : badge}
        </span>
      )}
    </button>
  );
}
</file>

<file path="app/Music/NhacNen.tsx">
'use client';

import React, { useState, useRef, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { 
    Music, Play, Pause, Volume2, VolumeX, Upload, Loader2, X, 
    SkipForward, Trash2, Repeat1, Shuffle, AlertCircle, Volume1, ChevronUp, ChevronDown, Square
} from 'lucide-react';
import { supabase } from '@/app/ThuVien/ketNoiSupabase'; 

interface BaiHat {
    id: string;
    name: string;
    url: string;
}

export default function NhacNen() {
    const [danhSachNhac, setDanhSachNhac] = useState<BaiHat[]>([]);
    const [isPlaying, setIsPlaying] = useState(false);
    const [volume, setVolume] = useState(0.5);
    const [isMuted, setIsMuted] = useState(false);
    const [isOpen, setIsOpen] = useState(false);
    const [currentSongIndex, setCurrentSongIndex] = useState(0);
    const [mounted, setMounted] = useState(false);
    const [showQuickControls, setShowQuickControls] = useState(false);
    
    // State logic (Giữ nguyên phần nâng cấp logic)
    const [isLooping, setIsLooping] = useState(false);   
    const [isShuffling, setIsShuffling] = useState(false); 

    const [isAdmin, setIsAdmin] = useState(false);
    const [isUploading, setIsUploading] = useState(false);
    const [isDeleting, setIsDeleting] = useState<string | null>(null);
    const [errorMsg, setErrorMsg] = useState<string | null>(null);
    const [isUserAuthenticated, setIsUserAuthenticated] = useState(false);
    const [playlistLoaded, setPlaylistLoaded] = useState(false);
    const [hasAutoPlayed, setHasAutoPlayed] = useState(false); // Flag để chỉ auto-play 1 lần
    
    const uploadInputRef = useRef<HTMLInputElement>(null);
    const audioRef = useRef<HTMLAudioElement>(null);
    const controlsRef = useRef<HTMLDivElement>(null);

    // 🎵 AUTO-PLAY: Phát nhạc khi user login thành công - CHỈ 1 LẦN
    useEffect(() => {
        console.log('🎵 Auto-play check:', { isUserAuthenticated, playlistLoaded, songsCount: danhSachNhac.length, hasAutoPlayed });
        if (isUserAuthenticated && playlistLoaded && danhSachNhac.length > 0 && !hasAutoPlayed && audioRef.current) {
            // Delay một chút để đảm bảo audio element sẵn sàng
            const timer = setTimeout(() => {
                setHasAutoPlayed(true); // Đánh dấu TRƯỚC khi play để tránh race condition
                audioRef.current?.play().then(() => {
                    setIsPlaying(true);
                    console.log('🎵 Auto-play nhạc thành công');
                }).catch(err => {
                    console.warn('Auto-play failed (có thể do browser policy):', err);
                    // Không set isPlaying = true nếu play thất bại
                });
            }, 500);
            return () => clearTimeout(timer);
        }
    }, [isUserAuthenticated, playlistLoaded, danhSachNhac.length, hasAutoPlayed]);

    useEffect(() => {
        setMounted(true);
        if (typeof window !== 'undefined') {
            const storedUser = localStorage.getItem('USER_INFO');
            const storedRole = localStorage.getItem('USER_ROLE');
            let role = storedRole || '';
            let isAuthenticated = false;
            
            if (storedUser) {
                try {
                    const parsed = JSON.parse(storedUser);
                    role = parsed.role || parsed.vi_tri || parsed.chuc_vu || role;
                    isAuthenticated = true; // User đã đăng nhập
                } catch (e) { console.error(e); }
            }
            
            setIsUserAuthenticated(isAuthenticated);
            if (['admin', 'quanly', 'boss'].includes(role.toLowerCase().trim())) {
                setIsAdmin(true);
            }
        }
        fetchDanhSachNhac();
    }, []);

    const fetchDanhSachNhac = async () => {
        try {
            // 'tao_luc' không phải column chuẩn của Storage -> gây 400. Dùng created_at luôn.
            const { data, error } = await supabase.storage
                .from('nhac-nen')
                .list('', { sortBy: { column: 'created_at', order: 'asc' } });

            if (error) {
                console.warn("Không thể load playlist nhạc:", error);
                setPlaylistLoaded(true);
                return; // Return early instead of throwing
            }

            if (data) {
                const songs: BaiHat[] = data
                    .filter(file => file.name !== '.emptyFolderPlaceholder')
                    .map((file, index) => {
                        const { data: urlData } = supabase.storage
                            .from('nhac-nen')
                            .getPublicUrl(file.name);
                        return {
                            id: file.name,
                            name: `Giai điệu ${index + 1}: ${file.name.replace(/\.[^/.]+$/, "")}`,
                            url: urlData.publicUrl
                        };
                    });
                setDanhSachNhac(songs);
                setPlaylistLoaded(true); // 🎵 Đánh dấu playlist đã load xong
                setErrorMsg(null);
            }
        } catch (err: any) {
            console.error("Lỗi tải playlist:", err);
            setErrorMsg("Không thể tải danh sách nhạc.");
            setPlaylistLoaded(true); // Cũng đánh dấu là đã cố gắng load, để auto-play không chờ mãi
        }
    };

    useEffect(() => { if (audioRef.current) audioRef.current.volume = isMuted ? 0 : volume; }, [volume, isMuted]);

    // Close quick controls when clicking outside
    useEffect(() => {
        const handleClickOutside = (e: MouseEvent) => {
            if (controlsRef.current && !controlsRef.current.contains(e.target as Node)) {
                setShowQuickControls(false);
            }
        };
        if (showQuickControls) {
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
        }
    }, [showQuickControls]);

    useEffect(() => {
        if (audioRef.current && danhSachNhac.length > 0) {
            audioRef.current.load();
            if (isPlaying) {
                audioRef.current.play().catch(() => setIsPlaying(false));
            }
        }
    }, [currentSongIndex, danhSachNhac]);

    const togglePlay = () => {
        if (!audioRef.current || danhSachNhac.length === 0) return;
        if (audioRef.current.paused) { 
            audioRef.current.play().then(() => setIsPlaying(true)).catch(console.error);
        } else { 
            audioRef.current.pause(); 
            setIsPlaying(false); 
        }
    };

    const handleNext = () => {
        if (danhSachNhac.length === 0) return;
        if (isShuffling && danhSachNhac.length > 1) {
            let randomIndex;
            do { randomIndex = Math.floor(Math.random() * danhSachNhac.length); } 
            while (randomIndex === currentSongIndex);
            setCurrentSongIndex(randomIndex);
        } else {
            setCurrentSongIndex((prev) => (prev + 1) % danhSachNhac.length);
        }
    };

    const handlePrev = () => {
        if (danhSachNhac.length === 0) return;
        setCurrentSongIndex((prev) => (prev - 1 + danhSachNhac.length) % danhSachNhac.length);
    };

    const handleSongEnded = () => {
        if (isLooping && audioRef.current) {
            audioRef.current.currentTime = 0;
            audioRef.current.play();
        } else {
            handleNext();
        }
    };

    const handleUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
        if (!isAdmin) return; 
        const file = e.target.files?.[0];
        if (!file || !file.type.startsWith('audio/')) return alert('Chọn file âm thanh!');

        try {
            setIsUploading(true);
            const fileName = `music-${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
            const { error } = await supabase.storage.from('nhac-nen').upload(fileName, file);
            if (error) throw error;
            await fetchDanhSachNhac();
            alert('Tải nhạc thành công!');
        } catch (err: any) {
            alert(`Lỗi: ${err.message}`);
        } finally {
            setIsUploading(false);
            if (uploadInputRef.current) uploadInputRef.current.value = ''; 
        }
    };

    const handleDelete = async (songId: string, songName: string) => {
        if (!isAdmin) return;
        if (!confirm(`Xóa "${songName}"?`)) return;
        try {
            setIsDeleting(songId);
            const { error } = await supabase.storage.from('nhac-nen').remove([songId]);
            if (error) throw error;
            if (danhSachNhac[currentSongIndex]?.id === songId) {
                setIsPlaying(false);
                setCurrentSongIndex(0);
            }
            await fetchDanhSachNhac();
        } catch (err: any) {
            alert('Lỗi xóa: ' + err.message);
        } finally {
            setIsDeleting(null);
        }
    };

    const modalContent = isOpen ? (
        <div className="fixed inset-0 z-[9999] bg-black/95 backdrop-blur-xl flex flex-col animate-in fade-in duration-300">
            <div className="flex items-center justify-between p-6 border-b border-white/10 shrink-0">
                <div className="flex items-center gap-3">
                    <Music className="text-[#C69C6D]" />
                    <h2 className="text-xl font-serif text-[#C69C6D]">Music Player</h2>
                </div>
                <button onClick={() => setIsOpen(false)} className="p-2 rounded-full hover:bg-white/10 text-white transition-colors"><X size={24} /></button>
            </div>
            <div className="flex-1 overflow-hidden flex flex-col md:flex-row">
                <div className="w-full md:w-1/2 p-4 md:p-8 flex flex-col items-center justify-center gap-6 md:gap-8 border-b md:border-b-0 md:border-r border-white/10 bg-gradient-to-br from-[#1a1512] to-black">
                    <div className={`w-48 h-48 md:w-64 md:h-64 rounded-full border-4 border-[#C69C6D]/30 shadow-[0_0_50px_rgba(198,156,109,0.2)] flex items-center justify-center relative overflow-hidden ${isPlaying ? 'animate-[spin_10s_linear_infinite]' : ''}`}>
                        <div className="absolute inset-0 bg-gradient-to-tr from-black via-[#C69C6D]/20 to-black opacity-80"></div>
                        <div className="w-16 h-16 md:w-20 md:h-20 bg-black rounded-full border-2 border-[#C69C6D] z-10 flex items-center justify-center">
                             <div className="w-3 h-3 md:w-4 md:h-4 bg-[#C69C6D] rounded-full"></div>
                        </div>
                    </div>
                    <div className="text-center space-y-1 md:space-y-2">
                        <h3 className="text-xl md:text-2xl font-bold text-[#F5F5F5] line-clamp-1 px-4">{danhSachNhac.length > 0 ? danhSachNhac[currentSongIndex]?.name : 'Chưa có nhạc trong Playlist'}</h3>
                        {errorMsg && <p className="text-red-500 text-xs flex items-center justify-center gap-1"><AlertCircle size={12}/> {errorMsg}</p>}
                    </div>
                    <div className="flex items-center gap-4 md:gap-8">
                        <button onClick={() => setIsShuffling(!isShuffling)} className={`p-2 transition-all ${isShuffling ? 'text-[#C69C6D]' : 'text-white/30 hover:text-white'}`} title="Trộn bài"><Shuffle size={20} /></button>
                        <button onClick={handlePrev} className="text-white/50 hover:text-white transition-colors disabled:opacity-30" disabled={danhSachNhac.length === 0}><SkipForward size={24} className="rotate-180" /></button>
                        <button onClick={togglePlay} disabled={danhSachNhac.length === 0} className="w-14 h-14 md:w-16 md:h-16 rounded-full bg-[#C69C6D] text-black flex items-center justify-center hover:scale-105 active:scale-95 transition-all shadow-[0_0_20px_rgba(198,156,109,0.5)] disabled:opacity-50 disabled:cursor-not-allowed">
                            {isPlaying ? <Pause size={28} fill="currentColor" /> : <Play size={28} fill="currentColor" className="ml-1" />}
                        </button>
                        <button onClick={handleNext} className="text-white/50 hover:text-white transition-colors disabled:opacity-30" disabled={danhSachNhac.length === 0}><SkipForward size={24} /></button>
                        <button onClick={() => setIsLooping(!isLooping)} className={`p-2 transition-all ${isLooping ? 'text-[#C69C6D]' : 'text-white/30 hover:text-white'}`} title="Lặp lại 1 bài"><Repeat1 size={20} /></button>
                    </div>
                    <div className="w-full max-w-[250px] flex items-center gap-4">
                        <button onClick={() => setVolume(v => v === 0 ? 0.5 : 0)} className="text-gray-400">{volume === 0 ? <VolumeX size={20}/> : <Volume2 size={20}/>}</button>
                        <input type="range" min="0" max="1" step="0.05" value={volume} onChange={(e) => setVolume(parseFloat(e.target.value))} className="flex-1 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[#C69C6D]"/>
                    </div>
                </div>
                <div className="w-full md:w-1/2 flex flex-col bg-[#0a0807] min-h-0">
                    <div className="p-4 border-b border-white/10 flex justify-between items-center bg-white/5 shrink-0">
                        <span className="text-sm font-bold text-white uppercase">Playlist ({danhSachNhac.length})</span>
                        {isAdmin && (
                            <div>
                                <input type="file" ref={uploadInputRef} onChange={handleUpload} accept="audio/*" className="hidden" />
                                <button onClick={() => uploadInputRef.current?.click()} disabled={isUploading} className="flex items-center gap-2 px-4 py-2 bg-[#C69C6D]/20 hover:bg-[#C69C6D] text-[#C69C6D] hover:text-black rounded-full text-xs font-bold uppercase transition-all">
                                    {isUploading ? <Loader2 size={14} className="animate-spin" /> : <Upload size={14} />} {isUploading ? 'Đang tải...' : 'Thêm nhạc'}
                                </button>
                            </div>
                        )}
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scroll p-4 space-y-2">
                        {danhSachNhac.length === 0 && <div className="text-center text-gray-500 py-10"><Music size={40} className="mx-auto mb-2 opacity-20"/><p>Chưa có bài hát nào</p></div>}
                        {danhSachNhac.map((song, idx) => (
                            <div key={song.id} onClick={() => { setCurrentSongIndex(idx); setIsPlaying(true); }} className={`group flex items-center gap-4 p-3 rounded-xl cursor-pointer transition-all border border-transparent ${currentSongIndex === idx ? 'bg-[#C69C6D]/10 border-[#C69C6D]/30 text-[#C69C6D]' : 'hover:bg-white/5 text-gray-400 border-white/5'}`}>
                                <div className="w-8 h-8 flex items-center justify-center rounded bg-black/30 text-[10px] font-mono shrink-0">
                                    {currentSongIndex === idx && isPlaying ? <div className="flex gap-0.5 items-end h-3"><span className="w-0.5 bg-current animate-[bounce_1s_infinite] h-2"></span><span className="w-0.5 bg-current animate-[bounce_1.2s_infinite] h-3"></span></div> : idx + 1}
                                </div>
                                <div className="flex-1 min-w-0"><div className="text-sm font-medium truncate">{song.name}</div></div>
                                {isAdmin && (
                                    <button onClick={(e) => { e.stopPropagation(); handleDelete(song.id, song.name); }} disabled={isDeleting === song.id} className="p-2 text-gray-500 hover:text-red-500 hover:bg-red-500/10 rounded-full transition-all">
                                        {isDeleting === song.id ? <Loader2 size={16} className="animate-spin" /> : <Trash2 size={16} />}
                                    </button>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    ) : null;

    return (
        <>
            <audio 
                ref={audioRef} 
                src={danhSachNhac[currentSongIndex]?.url || ''} 
                onEnded={handleSongEnded} 
                onError={(e) => {
                    console.warn("Audio load error, skipping to next track");
                    handleNext(); // Skip to next song on error
                }}
            />
            
            {/* Main Music Button - INLINE (no fixed positioning) */}
            <div ref={controlsRef} className="relative">
                {/* Quick Controls Panel - Dropdown style */}
                {showQuickControls && (
                    <div className="absolute top-full right-0 mt-2 bg-black/95 backdrop-blur-lg border border-white/20 rounded-2xl shadow-xl animate-in slide-in-from-top-2 duration-200 z-50 min-w-[280px]">
                        {/* Player Controls */}
                        <div className="px-4 py-3 border-b border-white/10 space-y-3">
                            {/* Current Song */}
                            <div className="text-xs font-semibold text-[#C69C6D] px-2 line-clamp-1 text-center">
                                {danhSachNhac.length > 0 ? danhSachNhac[currentSongIndex]?.name : 'Chưa có nhạc'}
                            </div>
                            
                        {/* Quick Control Buttons */}
                            <div className="flex items-center justify-center gap-3">
                                {/* Play */}
                                <button
                                    onClick={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        if (audioRef.current?.paused) {
                                            audioRef.current?.play().then(() => setIsPlaying(true)).catch(console.error);
                                        }
                                    }}
                                    disabled={danhSachNhac.length === 0}
                                    className="p-2.5 text-white/60 hover:text-white hover:bg-[#C69C6D]/10 rounded-lg transition-colors disabled:opacity-30"
                                    title="Phát"
                                >
                                    <Play size={18} fill="currentColor" className="ml-0.5" />
                                </button>
                                
                                {/* Stop */}
                                <button
                                    onClick={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        if (audioRef.current) {
                                            audioRef.current.pause();
                                            audioRef.current.currentTime = 0;
                                            setIsPlaying(false);
                                        }
                                    }}
                                    disabled={danhSachNhac.length === 0}
                                    className="p-2.5 text-white/60 hover:text-white hover:bg-[#C69C6D]/10 rounded-lg transition-colors disabled:opacity-30"
                                    title="Dừng"
                                >
                                    <Square size={18} fill="currentColor" />
                                </button>
                            </div>
                        </div>
                        
                        {/* Volume Control */}
                        <div className="px-4 py-3 border-b border-white/10">
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        setIsMuted(!isMuted);
                                    }}
                                    className={`p-1.5 rounded-lg transition-all ${
                                        isMuted 
                                            ? 'bg-red-500/20 text-red-400' 
                                            : 'text-white/60 hover:text-white hover:bg-white/10'
                                    }`}
                                    title={isMuted ? 'Bật âm' : 'Tắt âm'}
                                >
                                    {isMuted ? <VolumeX size={16} /> : <Volume1 size={16} />}
                                </button>
                                <input
                                    type="range"
                                    min="0"
                                    max="1"
                                    step="0.05"
                                    value={isMuted ? 0 : volume}
                                    onChange={(e) => {
                                        const val = parseFloat(e.target.value);
                                        setVolume(val);
                                        if (val > 0) setIsMuted(false);
                                    }}
                                    className="flex-1 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[#C69C6D]"
                                />
                                <span className="text-xs text-white/40 w-8">{Math.round((isMuted ? 0 : volume) * 100)}%</span>
                            </div>
                        </div>
                        
                        {/* Mode Buttons */}
                        <div className="px-4 py-3 flex items-center justify-between gap-2">
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    setIsLooping(!isLooping);
                                }}
                                className={`flex-1 p-2 text-xs rounded-lg transition-all font-semibold ${
                                    isLooping
                                        ? 'bg-[#C69C6D]/20 text-[#C69C6D]'
                                        : 'bg-white/5 text-white/60 hover:bg-white/10'
                                }`}
                                title="Lặp 1 bài"
                            >
                                <Repeat1 size={14} className="mx-auto" />
                            </button>
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    setIsShuffling(!isShuffling);
                                }}
                                className={`flex-1 p-2 text-xs rounded-lg transition-all font-semibold ${
                                    isShuffling
                                        ? 'bg-[#C69C6D]/20 text-[#C69C6D]'
                                        : 'bg-white/5 text-white/60 hover:bg-white/10'
                                }`}
                                title="Trộn bài"
                            >
                                <Shuffle size={14} className="mx-auto" />
                            </button>
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    setIsOpen(true);
                                }}
                                className="flex-1 p-2 text-xs bg-white/5 text-white/60 hover:bg-white/10 rounded-lg transition-all font-semibold"
                                title="Mở playlist đầy đủ"
                            >
                                <Music size={14} className="mx-auto" />
                            </button>
                        </div>
                    </div>
                )}
                
                {/* Main Music Button - 1 nút duy nhất */}
                {!isOpen && (
                    <button 
                        onClick={() => setShowQuickControls(!showQuickControls)}
                        className={`w-10 h-10 rounded-full flex items-center justify-center relative active:scale-95 transition-all border shadow-lg ${
                            isPlaying 
                                ? 'bg-[#C69C6D] border-[#C69C6D] text-black shadow-[0_0_15px_rgba(198,156,109,0.4)] animate-[spin_4s_linear_infinite]' 
                                : 'bg-black/40 border-white/20 text-white hover:bg-white/10 backdrop-blur-md'
                        }`}
                        title="Điều khiển nhạc"
                    >
                        <Music size={18} />
                    </button>
                )}
            </div>
            
            {mounted && createPortal(modalContent, document.body)}
        </>
    );
}
</file>

<file path="app/phongthietke/page.tsx">
"use client";

import React, { useState, useEffect } from "react";
import { useRouter } from "next/navigation"; // Import Router để chuyển trang
import { useUser } from "@/app/ThuVien/UserContext";
import KhungTrangChuan from "@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan";
import ThanhPhongChucNang from "@/app/components/ThanhPhongChucNang";
import { Palette } from "lucide-react";

// Import chức năng Mẫu Thiết Kế
import MauThietKeChucNang from "@/app/components/cacchucnang/mauthietke/MauThietKeChucNang";

// ============================================================
// CẤU HÌNH QUYỀN HẠN PHÒNG THIẾT KẾ
// ============================================================
const THIETKE_PERMISSIONS = {
  allowView: true,
  allowEdit: true,
  allowDelete: false, // Không được xóa
  allowBulk: false,
};

const THIETKE_FUNCTIONS = [
  { id: "mauthietke", label: "KHO THIẾT KẾ", icon: Palette },
];

// ============================================================
// COMPONENT CHÍNH
// ============================================================

export default function PhongThietKe() {
  const router = useRouter(); // Khởi tạo router
  const { user: contextUser, loading: contextLoading } = useUser();
  const [authLoading, setAuthLoading] = useState(true);

  // Mặc định vào thẳng Mẫu thiết kế
  const [activeFunction, setActiveFunction] = useState<string>("mauthietke");

  // 🟢 LOGIC KIỂM TRA ĐĂNG NHẬP
  useEffect(() => {
    // Chỉ chạy khi Context đã load xong
    if (!contextLoading) {
      // Kiểm tra user trong Context hoặc LocalStorage (đề phòng reload trang)
      let currentUser = contextUser;
      if (!currentUser && typeof window !== "undefined") {
        try {
          const stored = localStorage.getItem("USER_INFO");
          currentUser = stored ? JSON.parse(stored) : null;
        } catch {}
      }

      // Nếu vẫn không có user -> Đá về TRANG CHỦ
      if (!currentUser) {
        router.push("/trangchu");
      } else {
        // Đã đăng nhập -> Tắt màn hình loading
        setAuthLoading(false);
      }
    }
  }, [contextLoading, contextUser, router]);

  // Màn hình chờ trong lúc kiểm tra (Loading Screen)
  if (authLoading) {
    return (
      <div className="min-h-[100dvh] bg-black flex items-center justify-center">
        <div className="flex flex-col items-center gap-4">
          <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
          <p className="text-[#C69C6D] text-xs font-bold animate-pulse uppercase">
            Đang kiểm tra quyền truy cập...
          </p>
        </div>
      </div>
    );
  }

  // Get User info fallback (để hiển thị lên Header)
  let displayUser = contextUser;
  if (!displayUser && typeof window !== "undefined") {
    try {
      const stored = localStorage.getItem("USER_INFO");
      displayUser = stored ? JSON.parse(stored) : null;
    } catch {
      displayUser = null;
    }
  }

  return (
    <KhungTrangChuan
      nguoiDung={displayUser}
      loiChao="PHÒNG THIẾT KẾ"
      contentClassName="flex flex-col h-[100dvh] pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
    >
      {/* Thanh Chức Năng */}
      <ThanhPhongChucNang
        tenPhong="PHÒNG THIẾT KẾ"
        functions={THIETKE_FUNCTIONS}
        activeFunction={activeFunction}
        onFunctionChange={setActiveFunction}
      />

      {/* Vùng Nội Dung Chính */}
      <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
        <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />

        <div className="absolute inset-0 z-10">
          <div className="w-full h-full flex flex-col relative">
            {activeFunction === "mauthietke" && (
              <MauThietKeChucNang permissions={THIETKE_PERMISSIONS} />
            )}
          </div>
        </div>
      </div>
    </KhungTrangChuan>
  );
}
</file>

<file path="app/components/ForceFullScreen.tsx">
"use client";

import React, { useState, useEffect } from "react";
import {
  Download,
  Share,
  PlusSquare,
  Smartphone,
  XCircle,
  CheckCircle2,
  Globe,
  MoreHorizontal,
} from "lucide-react";
import { usePathname } from "next/navigation";

export default function ForceFullScreen() {
  const pathname = usePathname();
  const [showPrompt, setShowPrompt] = useState(false);
  const [isIOS, setIsIOS] = useState(false);
  const [isInAppBrowser, setIsInAppBrowser] = useState(false); // Detect Zalo/FB
  const [deferredPrompt, setDeferredPrompt] = useState<any>(null);

  // 1. LOGIC TÍNH CHIỀU CAO "BẤT TỬ" (Giữ nguyên vì đã tốt)
  useEffect(() => {
    const setAppHeight = () => {
      const vh = window.visualViewport
        ? window.visualViewport.height
        : window.innerHeight;
      document.documentElement.style.setProperty("--app-height", `${vh}px`);
    };
    setAppHeight();
    if (window.visualViewport) {
      window.visualViewport.addEventListener("resize", setAppHeight);
      window.visualViewport.addEventListener("scroll", setAppHeight);
    } else {
      window.addEventListener("resize", setAppHeight);
    }
    return () => {
      if (window.visualViewport) {
        window.visualViewport.removeEventListener("resize", setAppHeight);
        window.visualViewport.removeEventListener("scroll", setAppHeight);
      } else {
        window.removeEventListener("resize", setAppHeight);
      }
    };
  }, []);

  // 2. LOGIC KIỂM TRA THÔNG MINH
  useEffect(() => {
    // Check nếu người dùng đã "Cấm hiện lại"
    const isDismissed =
      typeof window !== "undefined" &&
      localStorage.getItem("PWA_PROMPT_DISMISSED") === "true";

    if (isDismissed) return;

    // A. Bắt sự kiện cài đặt của Chrome (Android/PC)
    const handleBeforeInstall = (e: any) => {
      e.preventDefault();
      setDeferredPrompt(e);
      // Chỉ hiện popup nếu đang ở các trang nội bộ
      if (checkIsInternalPage()) setShowPrompt(true);
    };
    window.addEventListener("beforeinstallprompt", handleBeforeInstall);

    // B. Logic kiểm tra thiết bị & Môi trường
    const checkDeviceAndMode = () => {
      const userAgent = window.navigator.userAgent || window.navigator.vendor;

      // 1. Check xem có phải Zalo/Facebook/Instagram không? (QUAN TRỌNG)
      // Các app này dùng browser riêng (webview) rất tù, không cài app được
      const isInApp = /Zalo|FBAN|FBAV|Instagram/.test(userAgent);
      setIsInAppBrowser(isInApp);

      // 2. Check iOS
      const isIOSDevice =
        /iPad|iPhone|iPod/.test(userAgent) ||
        (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
      setIsIOS(isIOSDevice);

      // 3. Check xem đã cài app chưa (Standalone mode)
      const isStandalone =
        window.matchMedia("(display-mode: standalone)").matches ||
        (window.navigator as any).standalone ||
        document.referrer.includes("android-app://");

      // 4. QUYẾT ĐỊNH HIỂN THỊ
      const isInternal = checkIsInternalPage();

      if (isStandalone) {
        setShowPrompt(false); // Đã cài rồi thì ẩn luôn
      } else if (isInternal) {
        // Nếu chưa cài và đang ở trang nội bộ
        if (isInApp) {
          setShowPrompt(true); // Zalo/FB -> Hiện cảnh báo bắt mở browser ngoài
        } else if (isIOSDevice) {
          setShowPrompt(true); // iOS -> Hiện hướng dẫn
        }
        // Android/Chrome sẽ được handle bởi sự kiện `beforeinstallprompt` ở trên
      }
    };

    checkDeviceAndMode();
    
    // Check lại khi resize (xoay màn hình)
    window.addEventListener("resize", checkDeviceAndMode);

    return () => {
      window.removeEventListener("beforeinstallprompt", handleBeforeInstall);
      window.removeEventListener("resize", checkDeviceAndMode);
    };
  }, [pathname]);

  // Hàm phụ kiểm tra trang nội bộ
  const checkIsInternalPage = () => {
    return (
      pathname.startsWith("/phong") ||
      pathname.startsWith("/dashboard") ||
      pathname.startsWith("/admin")
    );
  };

  const handleInstallClick = async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === "accepted") {
        setDeferredPrompt(null);
        setShowPrompt(false);
      }
    } else {
      // Fallback cho PC hoặc browser lạ
      alert("Hãy tìm biểu tượng Cài đặt trên thanh địa chỉ trình duyệt.");
    }
  };

  const handleDismiss = () => {
    localStorage.setItem("PWA_PROMPT_DISMISSED", "true");
    setShowPrompt(false);
  };

  if (!showPrompt) return null;

  // --- RENDER GIAO DIỆN ---

  return (
    <div className="fixed inset-0 z-[99999] bg-black/95 backdrop-blur-xl flex flex-col items-center justify-center p-6 animate-in fade-in duration-500 text-center">
      {/* Nút đóng */}
      <button
        onClick={() => setShowPrompt(false)}
        className="absolute top-4 right-4 text-white/30 hover:text-white p-2"
      >
        <XCircle size={30} />
      </button>

      {/* Icon chính */}
      <div className="w-20 h-20 mb-6 rounded-2xl bg-gradient-to-br from-[#C69C6D] to-[#5D4037] flex items-center justify-center shadow-[0_0_40px_rgba(198,156,109,0.3)] animate-bounce">
        {isInAppBrowser ? (
          <Globe className="text-white w-10 h-10" />
        ) : isIOS ? (
          <Smartphone className="text-white w-10 h-10" />
        ) : (
          <Download className="text-white w-10 h-10" />
        )}
      </div>

      <h2 className="text-2xl font-bold text-[#F5E6D3] mb-4 uppercase tracking-widest font-serif">
        {isInAppBrowser ? "Mở Trình Duyệt" : "Cài Đặt Ứng Dụng"}
      </h2>

      <p className="text-gray-400 text-sm md:text-base max-w-md mb-8 leading-relaxed">
        {isInAppBrowser
          ? "Bạn đang dùng Zalo/Facebook. Để ứng dụng hoạt động ổn định, vui lòng mở bằng trình duyệt (Safari/Chrome)."
          : isIOS
          ? "Để full màn hình và không bị lỗi trên iPhone, hãy thêm vào màn hình chính."
          : "Cài đặt ứng dụng vào thiết bị để có trải nghiệm tốt nhất, không bị lỗi giao diện."}
      </p>

      {/* KHỐI NỘI DUNG TUỲ THEO THIẾT BỊ */}
      
      {/* 1. Trường hợp Zalo/FB */}
      {isInAppBrowser && (
        <div className="bg-[#1a120f] border border-red-500/30 p-5 rounded-xl max-w-xs w-full text-left space-y-4 shadow-2xl animate-pulse">
           <div className="flex items-center gap-3 text-[#F5E6D3] text-sm font-bold">
            <MoreHorizontal size={20} />
            <span>1. Nhấn vào dấu 3 chấm góc trên</span>
          </div>
          <div className="w-full h-[1px] bg-[#8B5E3C]/20"></div>
          <div className="flex items-center gap-3 text-[#C69C6D] text-sm font-bold">
            <Globe size={20} />
            <span>2. Chọn "Mở bằng trình duyệt"</span>
          </div>
        </div>
      )}

      {/* 2. Trường hợp iOS (iPhone) */}
      {!isInAppBrowser && isIOS && (
        <div className="bg-[#1a120f] border border-[#8B5E3C]/30 p-5 rounded-xl max-w-xs w-full text-left space-y-4 shadow-2xl">
          <div className="flex items-center gap-3 text-[#C69C6D] text-sm font-bold">
            <Share size={20} />
            <span>1. Nhấn nút Chia sẻ (Share)</span>
          </div>
          <div className="w-full h-[1px] bg-[#8B5E3C]/20"></div>
          <div className="flex items-center gap-3 text-[#F5E6D3] text-sm font-bold">
            <PlusSquare size={20} />
            <span>2. Chọn "Thêm vào MH chính"</span>
          </div>
        </div>
      )}

      {/* 3. Trường hợp Android/Chrome */}
      {!isInAppBrowser && !isIOS && (
        <div className="w-full max-w-xs space-y-3">
          <button
            onClick={handleInstallClick}
            className="w-full py-4 bg-[#C69C6D] hover:bg-[#b08b5e] text-[#1a120f] font-bold text-sm uppercase tracking-widest rounded-xl transition-all active:scale-95 shadow-[0_0_20px_rgba(198,156,109,0.4)] flex items-center justify-center gap-2"
          >
            <Download size={20} strokeWidth={2.5} /> CÀI ĐẶT NGAY
          </button>
        </div>
      )}

      <button
        onClick={handleDismiss}
        className="mt-8 flex items-center gap-2 px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-white/50 hover:text-white transition-colors text-xs font-medium border border-white/5"
      >
        <CheckCircle2 size={14} />
        Đã cài đặt / Không hiện lại
      </button>
    </div>
  );
}
</file>

<file path="package.json">
{
  "name": "tommynghiem",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@dnd-kit/core": "^6.1.0",
    "@dnd-kit/sortable": "^8.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "@monaco-editor/react": "^4.7.0",
    "@supabase/ssr": "^0.3.0",
    "@supabase/supabase-js": "^2.43.4",
    "@tanstack/react-query": "^5.90.14",
    "browser-image-compression": "^2.0.2",
    "chart.js": "^4.4.3",
    "date-fns": "^4.1.0",
    "lucide-react": "^0.395.0",
    "next": "14.2.4",
    "postgres": "^3.4.7",
    "react": "^18.3.1",
    "react-chartjs-2": "^5.2.0",
    "react-dom": "^18.3.1",
    "web-push": "^3.6.7"
  },
  "devDependencies": {
    "@types/node": "^20",
    "@types/react": "^18",
    "@types/react-dom": "^18",
    "@types/web-push": "^3.6.4",
    "autoprefixer": "^10.4.19",
    "eslint": "^8",
    "eslint-config-next": "14.2.4",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.4",
    "typescript": "^5"
  }
}
</file>

<file path="app/GiaoDienTong/KhungGiaoDienTong.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Loader2 } from 'lucide-react';

// 🟢 CẬP NHẬT IMPORT
 
import CongDangNhap from '../CongDangNhap/CongDangNhap'; 
import StaffPresence from '../components/StaffPresence';

export default function KhungGiaoDienTong({ children }: { children: React.ReactNode }) {
  const pathname = usePathname();
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(true);
  const [currentUser, setCurrentUser] = useState<any>(null);

  useEffect(() => {
    const loadUser = () => {
      // 1. Các trang tự quản lý auth -> Cho qua luôn
      if (pathname === '/' || pathname === '/admin' || pathname === '/phongquanly' || pathname === '/phongparttime' || pathname === '/trangchu') {
          setIsLoading(false);
          return;
      }

      // 2. Load user từ localStorage
      const storedUser = typeof window !== 'undefined' ? localStorage.getItem('USER_INFO') : null;
      
      if (storedUser) {
        try {
          setCurrentUser(JSON.parse(storedUser));
        } catch (e) {
          console.error('Error parsing user:', e);
        }
      }
      
      setIsLoading(false);
    };

    loadUser();
  }, [pathname]);

  if (isLoading) return (
      <div className="h-[100dvh] bg-black flex flex-col items-center justify-center gap-4">
          <Loader2 className="animate-spin text-[#C69C6D]" size={40}/>
      </div>
  );
 
  return (
    <div className="flex flex-col min-h-[100dvh] bg-[#0a0a0a] text-gray-200 font-sans relative">
        <main className="flex-1 w-full max-w-[1920px] mx-auto p-3 pb-20 md:p-6 md:pb-20">
            {children}
        </main>
 <StaffPresence />
 
    </div>
  );
}
</file>

<file path="app/CongDangNhap/CongDangNhap.tsx">
"use client";

import React, { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { AuthService } from "@/app/CongDangNhap/AuthService";
import { getRedirectUrl } from "@/app/CongDangNhap/RoleRedirectService";
import {
  X,
  Square,
  CheckSquare,
  Lock,
  Eye,
  EyeOff,
  Loader2,
  ArrowRight,
  Mail,
  ArrowLeft,
  UserPlus,
  KeyRound,
} from "lucide-react";
import { Z_INDEX } from "@/app/constants/zIndex";
import RegisterForm from "@/app/components/RegisterForm"; // 🟢 Import Form mới

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const BASE_IMG_URL = `${SUPABASE_URL}/storage/v1/object/public/hinh-nen`;

// Hiệu ứng nền (Giữ nguyên)
const NenHieuUng = ({ isModalMode }: { isModalMode: boolean }) => {
  const bgMobile = `${BASE_IMG_URL}/login-mobile.jpg`;
  const bgTablet = `${BASE_IMG_URL}/login-tablet.jpg`;
  const bgDesktop = `${BASE_IMG_URL}/login-desktop.jpg`;

  return (
    <div
      className={`absolute inset-0 bg-[#050505] overflow-hidden ${
        isModalMode ? "rounded-2xl" : ""
      }`}
    >
      <div
        className="absolute inset-0 bg-cover bg-center md:hidden transition-opacity duration-700"
        style={{ backgroundImage: `url('${bgMobile}')` }}
      />
      <div
        className="absolute inset-0 bg-cover bg-center hidden md:block lg:hidden transition-opacity duration-700"
        style={{ backgroundImage: `url('${bgTablet}')` }}
      />
      <div
        className="absolute inset-0 bg-cover bg-center hidden lg:block transition-opacity duration-700"
        style={{ backgroundImage: `url('${bgDesktop}')` }}
      />
      <div
        className={`absolute inset-0 bg-black/60 ${
          isModalMode ? "bg-black/70" : ""
        }`}
      />
      <div className="absolute top-[-20%] left-[50%] -translate-x-1/2 w-[500px] h-[500px] bg-yellow-600/10 rounded-full blur-[100px] mix-blend-overlay" />
    </div>
  );
};

// 🟢 Định nghĩa Interface để fix lỗi TypeScript cho ONhapLieu
interface ONhapLieuProps {
  id: string;
  label: string;
  value: string;
  onChange: (val: string) => void;
  type?: string;
  showEye?: boolean;
  isPasswordVisible?: boolean;
  onToggleEye?: () => void;
}

// Ô nhập liệu (Giữ nguyên)
const ONhapLieu = ({
  id,
  label,
  value,
  onChange,
  type = "text",
  showEye = false,
  isPasswordVisible = false,
  onToggleEye,
}: ONhapLieuProps) => {
  const inputType = showEye ? (isPasswordVisible ? "text" : "password") : type;

  return (
    <div className="group relative w-full">
      <label
        htmlFor={id}
        className="block text-white/80 text-xs font-bold uppercase tracking-[0.2em] mb-2 drop-shadow-md ml-1"
      >
        {label}
      </label>
      <div className="relative w-full">
        <input
          id={id}
          type={inputType}
          value={value}
          onChange={(e) => onChange(e.target.value)}
          className="w-full bg-black/40 hover:bg-black/60 focus:bg-black/80 text-white text-lg font-bold tracking-wider border border-white/20 focus:border-[#C69C6D] rounded-xl px-5 py-4 outline-none transition-all duration-300 placeholder-transparent shadow-lg"
          autoComplete="off"
        />
        {showEye && (
          <button
            type="button"
            onClick={onToggleEye}
            className="absolute right-4 top-1/2 -translate-y-1/2 text-white/40 hover:text-[#C69C6D] transition-colors p-1"
            tabIndex={-1}
          >
            {isPasswordVisible ? <EyeOff size={20} /> : <Eye size={20} />}
          </button>
        )}
      </div>
      <div className="absolute bottom-0 left-5 right-5 h-[1px] bg-[#C69C6D] scale-x-0 group-focus-within:scale-x-100 transition-transform duration-500 origin-left"></div>
    </div>
  );
};

// Nút xác nhận (Giữ nguyên)
const NutXacNhan = ({
  isLoading,
  mode = "login",
}: {
  isLoading: boolean;
  mode?: "login" | "register" | "forgotPassword";
}) => {
  const getButtonText = () => {
    switch (mode) {
      // case 'register': return 'ĐĂNG KÝ'; // Đã chuyển sang form riêng
      case "forgotPassword":
        return "GỬI EMAIL";
      default:
        return "LOGIN";
    }
  };
  const getIcon = () => {
    switch (mode) {
      // case 'register': return <UserPlus size={28} ... />;
      case "forgotPassword":
        return (
          <Mail
            size={28}
            className="group-hover:scale-110 transition-transform duration-500"
            strokeWidth={2}
          />
        );
      default:
        return (
          <ArrowRight
            size={28}
            className="group-hover:-rotate-45 transition-transform duration-500"
            strokeWidth={2}
          />
        );
    }
  };

  return (
    <button
      type="submit"
      disabled={isLoading}
      className="group mt-8 flex flex-col items-center gap-3 opacity-90 hover:opacity-100 transition-all disabled:opacity-50 mx-auto"
    >
      <div className="w-16 h-16 md:w-20 md:h-20 rounded-full flex items-center justify-center bg-transparent border-2 border-white/30 text-white group-hover:bg-white group-hover:text-black group-hover:border-white group-hover:shadow-[0_0_30px_rgba(255,255,255,0.4)] transition-all duration-500 ease-out shadow-xl">
        {isLoading ? <Loader2 className="animate-spin" size={28} /> : getIcon()}
      </div>
      <div className="flex flex-col items-center">
        <span className="text-lg font-bold tracking-[0.3em] text-white group-hover:text-yellow-400 transition-colors drop-shadow-md">
          {isLoading ? "..." : getButtonText()}
        </span>
      </div>
    </button>
  );
};

// Component Chính
export default function CongDangNhap({
  isOpen,
  onClose,
  isGateKeeper = false,
  initialMode = "login",
}: {
  isOpen?: boolean;
  onClose?: () => void;
  isGateKeeper?: boolean;
  initialMode?: "login" | "register";
}) {
  console.log("🎨 CongDangNhap MOUNTED/RENDERED", {
    isOpen,
    isGateKeeper,
    initialMode,
  });

  const router = useRouter();
  const [mode, setMode] = useState<"login" | "register" | "forgotPassword">(
    "login"
  );
  const [user, setUser] = useState({ name: "", phone: "" }); // name=email, phone=password
  const [flags, setFlags] = useState({ loading: false, anim: false });
  const [isError, setIsError] = useState(false);

  const [wantFullScreen, setWantFullScreen] = useState(true);
  const [rememberMe, setRememberMe] = useState(true);
  const [showPhone, setShowPhone] = useState(false);

  // Dialog states
  const [showErrorDialog, setShowErrorDialog] = useState(false);
  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");
  const [showSuccessDialog, setShowSuccessDialog] = useState(false);

  const isModal = typeof isOpen === "boolean";

  const isVipCustomer = (phanLoai: string) =>
    !!phanLoai && phanLoai.trim().length > 0;

  // 🟢 UPDATE: Set mode từ prop initialMode
  useEffect(() => {
    if (isOpen) {
      setMode(initialMode || "login");
      const timer = setTimeout(
        () => setFlags((p) => ({ ...p, anim: true })),
        50
      );
      return () => clearTimeout(timer);
    } else {
      setFlags((p) => ({ ...p, anim: false }));
    }
  }, [isOpen, initialMode]);

  useEffect(() => {
    const savedEmail = localStorage.getItem("SAVED_EMAIL");
    if (savedEmail) {
      try {
        const parsed = JSON.parse(savedEmail);
        if (parsed.email) setUser((prev) => ({ ...prev, name: parsed.email }));
        setRememberMe(true);
      } catch (e) {
        setRememberMe(false);
      }
    }
    const savedPref = localStorage.getItem("GLOBAL_FULLSCREEN_PREF");
    if (savedPref !== null) setWantFullScreen(savedPref === "true");
  }, []);

  if (isModal && !isOpen) return null;

  const triggerFullScreen = () => {
    try {
      const elem = document.documentElement as any;
      if (elem.requestFullscreen) elem.requestFullscreen();
      else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
    } catch (err) {
      console.warn("Fullscreen error:", err);
    }
  };

  // --- LOGIC LOGIN (GIỮ NGUYÊN) ---
  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    if (typeof window !== "undefined")
      localStorage.setItem(
        "GLOBAL_FULLSCREEN_PREF",
        wantFullScreen ? "true" : "false"
      );
    if (wantFullScreen) triggerFullScreen();

    setFlags((p) => ({ ...p, loading: true }));
    setIsError(false);

    const email = user.name.trim().toLowerCase();
    const password = user.phone.trim();

    try {
      const { data: authData, error: authError } =
        await supabase.auth.signInWithPassword({ email, password });
      if (authError) throw new Error(`Lỗi đăng nhập: ${authError.message}`);
      if (!authData.session) throw new Error("Session không được tạo.");

      const finalUser = await AuthService.getUserByEmailWithRpc(email);
      if (!finalUser) throw new Error("Không tìm thấy hồ sơ.");

      let finalRole = "khach";
      if (finalUser.userType === "nhan_su") {
        finalRole = (finalUser as any).vi_tri_normalized || "parttime";
      } else {
        const phanLoai = finalUser.phan_loai || "";
        if (!isVipCustomer(phanLoai))
          throw new Error("Tài khoản này không được phép truy cập.");
        finalRole = (finalUser as any).phan_loai_normalized || "moi";
      }

      if (rememberMe)
        localStorage.setItem("SAVED_EMAIL", JSON.stringify({ email }));
      else localStorage.removeItem("SAVED_EMAIL");

      const userInfo = {
        id: finalUser.id,
        ho_ten: (finalUser as any).ten_hien_thi || finalUser.ho_ten || email,
        email: email,
        role: finalRole,
        role_normalized:
          (finalUser as any).vi_tri_normalized ||
          (finalUser as any).phan_loai_normalized ||
          finalRole,
        userType: finalUser.userType,
        avatar_url: (finalUser as any).hinh_anh,
      };

      localStorage.setItem("USER_INFO", JSON.stringify(userInfo));
      localStorage.setItem("USER_ROLE", finalRole);
      document.cookie = "VISITOR_MODE=; Path=/; Max-Age=0; SameSite=Lax";

      await new Promise((resolve) => setTimeout(resolve, 1000));
      const targetUrl = await getRedirectUrl(finalUser.userType, finalRole);

      if (isModal && onClose) onClose();
      router.push(targetUrl);
    } catch (err: any) {
      setErrorMessage(err?.message || "Lỗi không xác định");
      setShowErrorDialog(true);
      setIsError(true);
    } finally {
      setFlags((p) => ({ ...p, loading: false }));
    }
  };

  // Logic Quên mật khẩu (GIỮ NGUYÊN)
  const handleForgotPassword = async (e: React.FormEvent) => {
    e.preventDefault();
    setFlags((p) => ({ ...p, loading: true }));
    const email = user.name.trim().toLowerCase();
    try {
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${window.location.origin}/reset-password`,
      });
      if (error) throw error;
      setSuccessMessage(
        "Đã gửi link đặt lại mật khẩu! Vui lòng kiểm tra email."
      );
      setShowSuccessDialog(true);
      setTimeout(() => {
        setShowSuccessDialog(false);
        setMode("login");
      }, 3000);
    } catch (err: any) {
      setErrorMessage(err.message);
      setShowErrorDialog(true);
    } finally {
      setFlags((p) => ({ ...p, loading: false }));
    }
  };

  const handleClose = () => {
    if (isGateKeeper) {
      router.push("/");
      return;
    }
    setFlags((p) => ({ ...p, anim: false }));
    setTimeout(() => onClose && onClose(), 300);
  };

  // 🟢 ĐIỀU CHỈNH ĐỘ RỘNG MODAL
  const modalWidthClass =
    mode === "register"
      ? "max-w-4xl h-auto md:h-[650px]"
      : "max-w-screen-xl h-full";

  return (
    <div
      className={`fixed inset-0 w-screen h-[100dvh] font-sans text-white overflow-hidden bg-black/90 backdrop-blur-sm flex items-center justify-center`}
      style={{ zIndex: Z_INDEX.modal }}
    >
      {/* Background Effect */}
      <div className="absolute inset-0 opacity-50 pointer-events-none">
        <NenHieuUng isModalMode={isModal} />
      </div>

      {/* Main Container */}
      <div
        className={`relative w-full ${modalWidthClass} mx-auto flex flex-col items-center justify-center transition-all duration-700 ease-out transform 
                  ${
                    isModal
                      ? flags.anim
                        ? "opacity-100 blur-0 scale-100"
                        : "opacity-0 blur-xl scale-110"
                      : "opacity-100"
                  }
            `}
      >
        {/* Close Button */}
        {isModal && (
          <button
            onClick={handleClose}
            className="absolute top-4 right-4 md:top-8 md:right-8 text-white/50 hover:text-white transition-colors p-2 z-50 bg-black/20 rounded-full active:scale-95"
          >
            <X size={24} className="md:w-8 md:h-8" strokeWidth={1.5} />
          </button>
        )}

        {/* 🟢 SWITCH CONTENT: REGISTER FORM vs LOGIN FORM */}
        {mode === "register" ? (
          // 🟢 FORM ĐĂNG KÝ MỚI (TÍCH HỢP)
          <div className="w-full h-full bg-[#0a0a0a] md:border border-[#C69C6D]/30 rounded-none md:rounded-2xl shadow-2xl overflow-hidden relative z-10 flex">
            <RegisterForm
              onSwitchToLogin={() => setMode("login")}
              onSuccess={() => {
                /* Có thể thêm logic redirect hoặc thông báo ở đây */
              }}
            />
          </div>
        ) : (
          // 🟢 FORM LOGIN / FORGOT CŨ (GIỮ NGUYÊN)
          <form
            onSubmit={mode === "login" ? handleLogin : handleForgotPassword}
            className="w-full px-6 flex flex-col items-center justify-center relative z-10"
          >
            <div className="w-full max-w-[500px] flex flex-col gap-5 md:gap-6">
              {/* Mode Title với Back button */}
              <div
                className={`flex items-center justify-center mb-2 ${
                  isError ? "animate-shake" : ""
                }`}
              >
                {mode === "forgotPassword" && (
                  <button
                    type="button"
                    onClick={() => setMode("login")}
                    className="absolute left-6 md:left-auto md:relative md:mr-4 text-white/50 hover:text-white transition-colors p-2"
                  >
                    <ArrowLeft size={24} />
                  </button>
                )}
                <h1 className="text-2xl md:text-3xl font-bold tracking-[0.3em] text-white/80">
                  {mode === "forgotPassword" ? "QUÊN MẬT KHẨU" : "LOGIN"}
                </h1>
              </div>

              {/* Input Group */}
              <div
                className={`flex flex-col gap-4 ${
                  isError ? "animate-shake" : ""
                }`}
              >
                <ONhapLieu
                  id="inp_email"
                  label="EMAIL"
                  value={user.name}
                  onChange={(v: string) => setUser((p) => ({ ...p, name: v }))}
                />

                {mode === "login" && (
                  <ONhapLieu
                    id="inp_password"
                    label="MẬT KHẨU"
                    value={user.phone}
                    onChange={(v: string) =>
                      setUser((p) => ({ ...p, phone: v }))
                    }
                    type={showPhone ? "text" : "password"}
                    showEye={true}
                    isPasswordVisible={showPhone}
                    onToggleEye={() => setShowPhone(!showPhone)}
                  />
                )}

                {/* Options Checkbox */}
                {mode === "login" && (
                  <div className="flex flex-row items-center justify-between px-1 mt-1">
                    <div
                      className="flex items-center gap-2 cursor-pointer group select-none"
                      onClick={() => setRememberMe(!rememberMe)}
                    >
                      <div
                        className={`transition-colors ${
                          rememberMe
                            ? "text-[#C69C6D]"
                            : "text-gray-600 group-hover:text-gray-400"
                        }`}
                      >
                        {rememberMe ? (
                          <CheckSquare size={16} />
                        ) : (
                          <Square size={16} />
                        )}
                      </div>
                      <span
                        className={`text-[10px] md:text-xs font-bold uppercase tracking-widest transition-colors ${
                          rememberMe
                            ? "text-white"
                            : "text-gray-500 group-hover:text-gray-400"
                        }`}
                      >
                        GHI NHỚ ĐĂNG NHẬP
                      </span>
                    </div>
                    <div
                      className="flex items-center gap-2 cursor-pointer group select-none"
                      onClick={() => setWantFullScreen(!wantFullScreen)}
                    >
                      <div
                        className={`transition-colors ${
                          wantFullScreen
                            ? "text-yellow-500"
                            : "text-gray-600 group-hover:text-gray-400"
                        }`}
                      >
                        {wantFullScreen ? (
                          <CheckSquare size={16} />
                        ) : (
                          <Square size={16} />
                        )}
                      </div>
                      <span
                        className={`text-[10px] md:text-xs font-bold uppercase tracking-widest transition-colors ${
                          wantFullScreen
                            ? "text-white"
                            : "text-gray-500 group-hover:text-gray-400"
                        }`}
                      >
                        Toàn màn hình
                      </span>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Submit Button */}
            <div className="w-full max-w-[500px] mt-6 flex justify-center">
              <NutXacNhan isLoading={flags.loading} mode={mode} />
            </div>

            {/* Footer Links */}
            <div className="mt-6 flex flex-col items-center gap-3">
              {mode === "login" && (
                <>
                  <button
                    type="button"
                    onClick={() => setMode("forgotPassword")}
                    className="inline-flex items-center gap-2 text-xs md:text-sm text-white/40 hover:text-[#C69C6D] transition-all duration-300"
                  >
                    <KeyRound size={14} /> <span>Quên mật khẩu?</span>
                  </button>
                  <button
                    type="button"
                    onClick={() => setMode("register")}
                    className="inline-flex items-center gap-2 text-xs md:text-sm text-white/40 hover:text-[#C69C6D] transition-all duration-300"
                  >
                    <UserPlus size={14} />{" "}
                    <span>Chưa có tài khoản? Đăng ký ngay</span>
                  </button>
                </>
              )}

              {mode === "forgotPassword" && (
                <button
                  type="button"
                  onClick={() => setMode("login")}
                  className="inline-flex items-center gap-2 text-xs md:text-sm text-white/40 hover:text-[#C69C6D] transition-all duration-300"
                >
                  <span>Quay lại đăng nhập</span>
                </button>
              )}

              <a
                href="tel:+84939941588"
                className="inline-flex items-center gap-2 text-xs md:text-sm text-white/30 hover:text-white transition-all duration-300 border-b border-transparent hover:border-white/50 pb-0.5 group"
              >
                <Lock
                  size={12}
                  className="group-hover:text-green-400 transition-colors"
                />{" "}
                <span>Cần hỗ trợ?</span>
              </a>
            </div>
          </form>
        )}
      </div>

      {/* Error Dialog */}
      {showErrorDialog && (
        <div
          className="fixed inset-0 flex items-center justify-center bg-black/80 backdrop-blur-sm"
          style={{ zIndex: Z_INDEX.modal + 10 }}
          onClick={() => setShowErrorDialog(false)}
        >
          <div
            className="relative bg-gradient-to-b from-zinc-900 to-black border border-white/10 rounded-2xl p-8 max-w-sm w-[90%] shadow-2xl transform animate-fadeIn"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex justify-center mb-6">
              <div className="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center border border-red-500/30">
                <Lock className="w-8 h-8 text-red-400" />
              </div>
            </div>
            <h3 className="text-xl font-bold text-white text-center mb-2">
              Đăng nhập thất bại
            </h3>
            <p className="text-white/60 text-sm text-center mb-6">
              {errorMessage || "Vui lòng kiểm tra lại thông tin"}
            </p>
            <button
              onClick={() => setShowErrorDialog(false)}
              className="w-full py-3 bg-white/10 hover:bg-white/20 text-white font-semibold rounded-xl transition-all duration-300 border border-white/10 hover:border-white/30"
            >
              Thử lại
            </button>
          </div>
        </div>
      )}

      {/* Success Dialog */}
      {showSuccessDialog && (
        <div
          className="fixed inset-0 flex items-center justify-center bg-black/80 backdrop-blur-sm"
          style={{ zIndex: Z_INDEX.modal + 10 }}
          onClick={() => setShowSuccessDialog(false)}
        >
          <div
            className="relative bg-gradient-to-b from-emerald-900/30 to-black border border-emerald-500/30 rounded-2xl p-8 max-w-sm w-[90%] shadow-2xl transform animate-fadeIn"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex justify-center mb-6">
              <div className="w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center border border-green-500/30">
                <Lock className="w-8 h-8 text-green-400" />
              </div>
            </div>
            <h3 className="text-xl font-bold text-white text-center mb-2">
              Thành công!
            </h3>
            <p className="text-white/60 text-sm text-center mb-6">
              {successMessage}
            </p>
            <button
              onClick={() => setShowSuccessDialog(false)}
              className="w-full py-3 bg-green-500/20 hover:bg-green-500/30 text-green-400 font-semibold rounded-xl transition-all duration-300 border border-green-500/30 hover:border-green-500/50"
            >
              Đóng
            </button>
          </div>
        </div>
      )}

      <style jsx global>{`
        @keyframes shake {
          0%,
          100% {
            transform: translateX(0);
          }
          25% {
            transform: translateX(-5px);
          }
          75% {
            transform: translateX(5px);
          }
        }
        .animate-shake {
          animation: shake 0.3s ease-in-out;
        }
        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: scale(0.9);
          }
          to {
            opacity: 1;
            transform: scale(1);
          }
        }
        .animate-fadeIn {
          animation: fadeIn 0.3s ease-out;
        }
      `}</style>
    </div>
  );
}
</file>

<file path="app/phongadmin/page.tsx">
/**
 * ============================================================
 * PHÒNG ADMIN - COMMAND CENTER
 * ============================================================
 */

"use client";

import React, { useState, useEffect } from "react";
import { useUser } from "@/app/ThuVien/UserContext";
import {
  Users,
  BookUser,
  LayoutDashboard,
  Database,
  Settings,
  Palette, // 🟢 THÊM: Import icon cho thiết kế
} from "lucide-react";
import KhungTrangChuan from "@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan"; // Kiểm tra lại đường dẫn này cho đúng với dự án
import ThanhPhongChucNang from "@/app/components/ThanhPhongChucNang";

// Import chức năng từ cacchucnang
import { NhanSuChucNang } from "@/app/components/cacchucnang";
import { KhachHangChucNang } from "@/app/components/cacchucnang/khachhang";
// Import chức năng Mẫu Thiết Kế
import { MauThietKeChucNang } from "@/app/components/cacchucnang/mauthietke";

// ============================================================
// QUYỀN HẠN PHÒNG ADMIN - FULL ACCESS
// ============================================================

const ADMIN_PERMISSIONS = {
  nhansu: {
    allowView: true,
    allowEdit: true,
    allowDelete: true,
    allowBulk: true,
  },
  khachhang: {
    allowView: true,
    allowEdit: true,
    allowDelete: true,
    allowBulk: true,
  },
  // 🟢 THÊM: Cấu hình quyền cho Mẫu thiết kế
  mauthietke: {
    allowView: true,
    allowEdit: true,
    allowDelete: true,
    allowBulk: true,
  },
};

// ============================================================
// DANH SÁCH CHỨC NĂNG
// ============================================================

const ADMIN_FUNCTIONS = [
  // Quản lý người dùng
  { id: "nhansu", label: "NHÂN SỰ", icon: Users },
  { id: "khachhang", label: "KHÁCH HÀNG", icon: BookUser },
  // 🟢 THÊM: Mục menu Mẫu thiết kế
  { id: "mauthietke", label: "KHO THIẾT KẾ", icon: Palette },
];

// ============================================================
// COMPONENT CHÍNH
// ============================================================

export default function PhongAdminPage() {
  const { user: contextUser, loading: contextLoading } = useUser();
  const [authLoading, setAuthLoading] = useState(true);
  const [activeFunction, setActiveFunction] = useState<string>("dashboard");

  useEffect(() => {
    if (!contextLoading) setAuthLoading(false);
  }, [contextLoading]);

  // Loading state
  if (authLoading) {
    return (
      <div className="min-h-[100dvh] bg-black flex items-center justify-center">
        <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
      </div>
    );
  }

  // Get user info
  let displayUser = contextUser;
  if (!displayUser && typeof window !== "undefined") {
    try {
      const stored = localStorage.getItem("USER_INFO");
      displayUser = stored ? JSON.parse(stored) : null;
    } catch (e) {
      displayUser = null;
    }
  }

  // ========================================
  // RENDER
  // ========================================

  return (
    <KhungTrangChuan
      nguoiDung={displayUser}
      loiChao="ADMIN COMMAND CENTER"
      contentClassName="flex flex-col h-[100dvh] pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
    >
      {/* Thanh Phòng + Chức Năng */}
      <ThanhPhongChucNang
        tenPhong="PHÒNG ADMIN"
        functions={ADMIN_FUNCTIONS}
        activeFunction={activeFunction}
        onFunctionChange={setActiveFunction}
      />

      {/* Content Area */}
      <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
        <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />

        <div className="absolute inset-0 z-10">
          <div className="w-full h-full flex flex-col relative">
            {/* ====== RENDER CÁC CHỨC NĂNG ====== */}

            {/* Nhân sự */}
            {activeFunction === "nhansu" && (
              <NhanSuChucNang permissions={ADMIN_PERMISSIONS.nhansu} />
            )}

            {/* Khách hàng */}
            {activeFunction === "khachhang" && (
              <KhachHangChucNang permissions={ADMIN_PERMISSIONS.khachhang} />
            )}

            {/* 🟢 THÊM: Hiển thị chức năng Mẫu thiết kế */}
            {activeFunction === "mauthietke" && (
              <MauThietKeChucNang permissions={ADMIN_PERMISSIONS.mauthietke} />
            )}
            
             {/* Dashboard (Mặc định) */}
             {activeFunction === "dashboard" && <DashboardPlaceholder />}

          </div>
        </div>
      </div>
    </KhungTrangChuan>
  );
}

// ============================================================
// COMPONENTS PHỤ
// ============================================================

function DashboardPlaceholder() {
  return (
    <div className="h-full flex flex-col items-center justify-center text-white/30">
      <LayoutDashboard size={64} className="mb-4 opacity-30" />
      <p className="font-bold uppercase">Dashboard Tổng Quan</p>
      <p className="text-sm mt-2">Đang phát triển...</p>
    </div>
  );
}
</file>

<file path="app/phongquanly/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useUser } from '@/app/ThuVien/UserContext';
import KhungTrangChuan from '@/app/components/cacchucnang/KhungGiaoDienChucNang/KhungTrangChuan';
import ThanhPhongChucNang from '@/app/components/ThanhPhongChucNang';
import { NhanSuChucNang } from '@/app/components/cacchucnang/nhansu';
import { KhachHangChucNang } from '@/app/components/cacchucnang/khachhang';
import { Users, UserCheck } from 'lucide-react';

// Quyền của Quản lý: xem, sửa, bulk - KHÔNG xóa
const QUANLY_PERMISSIONS = {
    allowView: true,
    allowEdit: true,
    allowDelete: false,
    allowBulk: true,
};

const QUANLY_FUNCTIONS = [
    { id: 'nhansu', label: 'NHÂN SỰ', icon: Users },
    { id: 'khachhang', label: 'KHÁCH HÀNG', icon: UserCheck },
];

export default function PhongQuanLy() {
    const { user: contextUser, loading: contextLoading } = useUser();
    const [authLoading, setAuthLoading] = useState(true);
    const [activeFunction, setActiveFunction] = useState<string>('nhansu');

    useEffect(() => {
        if (!contextLoading) setAuthLoading(false);
    }, [contextLoading]);

    // Loading state
    if (authLoading) {
        return (
            <div className="min-h-[100dvh] bg-black flex items-center justify-center">
                <div className="w-16 h-16 border-4 border-[#C69C6D] border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    // Get user info
    let displayUser = contextUser;
    if (!displayUser && typeof window !== 'undefined') {
        try {
            const stored = localStorage.getItem('USER_INFO');
            displayUser = stored ? JSON.parse(stored) : null;
        } catch (e) {
            displayUser = null;
        }
    }

    return (
        <KhungTrangChuan
            nguoiDung={displayUser}
            loiChao="PHÒNG QUẢN LÝ"
            contentClassName="flex flex-col h-[100dvh] pt-[70px] pb-0 px-0 overflow-hidden bg-[#050505]"
        >
            {/* Thanh Phòng + Chức Năng */}
            <ThanhPhongChucNang
                tenPhong="PHÒNG QUẢN LÝ"
                functions={QUANLY_FUNCTIONS}
                activeFunction={activeFunction}
                onFunctionChange={setActiveFunction}
            />

            {/* Content Area */}
            <div className="flex-1 w-full relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-[#050505]">
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none" />
                
                <div className="absolute inset-0 z-10">
                    <div className="w-full h-full flex flex-col relative">
                        
                        {/* Nhân sự */}
                        {activeFunction === 'nhansu' && (
                            <NhanSuChucNang permissions={QUANLY_PERMISSIONS} />
                        )}

                        {/* Khách hàng */}
                        {activeFunction === 'khachhang' && (
                            <KhachHangChucNang permissions={QUANLY_PERMISSIONS} />
                        )}
                        
                    </div>
                </div>
            </div>
        </KhungTrangChuan>
    );
}
</file>

<file path="app/trangchu/page.tsx">
"use client";

import React, { useState, useEffect, useCallback, Suspense } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { PlayCircle, Star, ArrowRight, UserPlus, LogIn } from "lucide-react";

// Import các component hệ thống
import MenuTren from "@/app/GiaoDienTong/MenuTren/MenuTren";

// Import component con
import Slider1 from "./slider1";
import Slider2 from "./slider2";
import NutDatHang from "./NutDatHang";
import BackgroundManager from "./BackgroundManager";
import { useUser } from "@/app/ThuVien/UserContext";
import { getRedirectUrl } from "@/app/CongDangNhap/RoleRedirectService";
import { useAppSettings } from "@/app/ThuVien/AppSettingsContext";
import CongDangNhap from "@/app/CongDangNhap/CongDangNhap"; // Import Popup

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const BASE_IMG_URL = `${SUPABASE_URL}/storage/v1/object/public/hinh-nen`;

function TrangChuContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const { user: contextUser, loading: contextLoading } = useUser();
  const { t, language } = useAppSettings();

  const [nguoiDung, setNguoiDung] = useState<any>(null);
  const [loiChao, setLoiChao] = useState("");
  const [daKiemTraLogin, setDaKiemTraLogin] = useState(false);
  const [currentTime, setCurrentTime] = useState<string>("");
  const [showGreeting, setShowGreeting] = useState(true);
  const [hasGreetingFinished, setHasGreetingFinished] = useState(false);
  const [showScrollHint, setShowScrollHint] = useState(false);
  const [scrollStartTime, setScrollStartTime] = useState<number | null>(null);

  // UI State
  const [activeOverlays, setActiveOverlays] = useState<Set<string>>(new Set());
  const [bgVersion, setBgVersion] = useState(Date.now());
  const [showHero, setShowHero] = useState(true);
  const [hasScrolled, setHasScrolled] = useState(false);

  // 🟢 STATE ĐIỀU KHIỂN POPUP AUTH
  const [showAuthModal, setShowAuthModal] = useState(false);
  const [authMode, setAuthMode] = useState<"login" | "register">("login");

  // Smooth Scroll
  const smoothScrollTo = useCallback((targetY: number, duration = 1200) => {
    const startY = typeof window !== "undefined" ? window.scrollY : 0;
    const diff = targetY - startY;
    const start = typeof performance !== "undefined" ? performance.now() : 0;
    const easeInOutCubic = (t: number) =>
      t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
    const step = (now: number) => {
      const elapsed = now - start;
      const t = Math.min(1, elapsed / duration);
      const eased = easeInOutCubic(t);
      window.scrollTo(0, startY + diff * eased);
      if (t < 1) requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
  }, []);

  const bgUrlMobile = `${BASE_IMG_URL}/trangchu-mobile.jpg?t=${bgVersion}`;
  const bgUrlTablet = `${BASE_IMG_URL}/trangchu-tablet.jpg?t=${bgVersion}`;
  const bgUrlDesktop = `${BASE_IMG_URL}/trangchu-desktop.jpg?t=${bgVersion}`;

  // ============================================================
  // 🟢 LOGIC KIỂM TRA USER
  // ============================================================
  useEffect(() => {
    // 1. Nếu có param ?login=1 -> Mở popup đăng nhập ngay
    const shouldShowLogin = searchParams.get("login") === "1";
    if (shouldShowLogin) {
      setDaKiemTraLogin(true);
      setNguoiDung(null);
      window.history.replaceState({}, "", "/trangchu");

      // Mở Modal Login
      setAuthMode("login");
      setShowAuthModal(true);
      return;
    }

    // 2. TIMEOUT FALLBACK
    const timeoutId = setTimeout(() => {
      if (!daKiemTraLogin) {
        setDaKiemTraLogin(true);
        const storedUser = localStorage.getItem("USER_INFO");
        if (storedUser) {
          try {
            setNguoiDung(JSON.parse(storedUser));
          } catch {}
        } else {
          setNguoiDung({ userType: "guest", role: "visitor" });
        }
      }
    }, 2000);

    // 3. XỬ LÝ KHI CONTEXT LOAD XONG
    if (contextLoading) return () => clearTimeout(timeoutId);

    try {
      if (contextUser) {
        const userType = contextUser.userType;
        if (userType === "nhan_su") {
          const role = (contextUser as any)?.vi_tri_normalized;
          getRedirectUrl(userType, role).then((targetRoute: string) => {
            router.replace(targetRoute);
          });
          return;
        }
        setNguoiDung(contextUser);
      } else {
        const storedUser = localStorage.getItem("USER_INFO");
        if (storedUser) {
          try {
            const parsed = JSON.parse(storedUser);
            if (parsed.userType === "nhan_su") {
              getRedirectUrl(parsed.userType, parsed.vi_tri_normalized).then(
                (targetRoute: string) => {
                  router.replace(targetRoute);
                }
              );
              return;
            }
            setNguoiDung(parsed);
          } catch {
            setNguoiDung({ userType: "guest", role: "visitor" });
          }
        } else {
          setNguoiDung({ userType: "guest", role: "visitor" });
        }
      }
    } finally {
      clearTimeout(timeoutId);
      setDaKiemTraLogin(true);
    }
  }, [contextUser, contextLoading, router, searchParams]);

  // Set greeting
  useEffect(() => {
    const name = nguoiDung?.ho_ten || t("home.guest");
    const h = new Date().getHours();
    let timeGreeting = t("home.goodEvening");
    if (h >= 5 && h < 11) timeGreeting = t("home.goodMorning");
    else if (h >= 11 && h < 14)
      timeGreeting = language === "vi" ? "Chào buổi trưa" : "Good afternoon";
    else if (h >= 14 && h < 18) timeGreeting = t("home.goodAfternoon");

    setLoiChao(`${timeGreeting}, ${name}!`);
    setShowGreeting(true);
    setHasGreetingFinished(false);
    setScrollStartTime(null);

    const hideTimer = setTimeout(() => {
      setShowGreeting(false);
      setShowScrollHint(true);
    }, 5000);
    const finishTimer = setTimeout(() => {
      setHasGreetingFinished(true);
      setShowScrollHint(false);
    }, 5700);

    return () => {
      clearTimeout(hideTimer);
      clearTimeout(finishTimer);
    };
  }, [nguoiDung, t, language]);

  // Auto scroll
  useEffect(() => {
    if (!hasGreetingFinished) return;
    setShowHero(false);
    const target = document.getElementById("content-start");
    const top = target ? target.offsetTop : window.innerHeight;
    smoothScrollTo(top, 1400);
  }, [hasGreetingFinished, smoothScrollTo]);

  // Clock
  useEffect(() => {
    const updateTime = () => {
      const now = new Date();
      setCurrentTime(
        `${String(now.getHours()).padStart(2, "0")}:${String(
          now.getMinutes()
        ).padStart(2, "0")}:${String(now.getSeconds()).padStart(2, "0")}`
      );
    };
    updateTime();
    const interval = setInterval(updateTime, 1000);
    return () => clearInterval(interval);
  }, []);

  // Events listeners
  useEffect(() => {
    const handleVisibilityChange = (e: any) => {
      const { id, open } = e.detail;
      setActiveOverlays((prev) => {
        const next = new Set(prev);
        if (open) next.add(id);
        else next.delete(id);
        return next;
      });
      if (open) setShowHero(false);
    };
    window.addEventListener(
      "toggle-content-visibility",
      handleVisibilityChange
    );
    return () =>
      window.removeEventListener(
        "toggle-content-visibility",
        handleVisibilityChange
      );
  }, []);

  useEffect(() => {
    const openModal = searchParams.get("openModal");
    if (openModal) {
      window.dispatchEvent(
        new CustomEvent("openModal", { detail: { modalId: openModal } })
      );
      setShowHero(false);
    }
  }, [searchParams]);

  const handleUpdateBackground = useCallback(() => {
    setBgVersion(Date.now());
  }, []);

  const isVisitor =
    nguoiDung?.userType === "guest" || nguoiDung?.role === "visitor";

  // 🟢 HÀM MỞ FORM ĐĂNG KÝ
  const handleOpenRegister = useCallback(() => {
    setAuthMode("register");
    setShowAuthModal(true);
  }, []);

  const hienThiNoiDung = activeOverlays.size === 0;

  useEffect(() => {
    const handleCloseAllOverlays = () => {
      setActiveOverlays(new Set());
      setShowHero(true);
      setHasScrolled(false);
      window.scrollTo({ top: 0, behavior: "smooth" });
    };
    window.addEventListener("closeAllOverlays", handleCloseAllOverlays);
    return () =>
      window.removeEventListener("closeAllOverlays", handleCloseAllOverlays);
  }, []);

  useEffect(() => {
    const handleScroll = () => {
      if (activeOverlays.size === 0) {
        if (window.scrollY > 50 && showScrollHint) {
          if (scrollStartTime === null) setScrollStartTime(Date.now());
          else if (Date.now() - scrollStartTime >= 1000)
            setShowScrollHint(false);
        } else if (window.scrollY <= 50) setScrollStartTime(null);

        if (window.scrollY > 100) {
          setShowHero(false);
          setHasScrolled(true);
        } else {
          setShowHero(true);
          setHasScrolled(false);
        }
      }
    };
    window.addEventListener("scroll", handleScroll);
    return () => window.removeEventListener("scroll", handleScroll);
  }, [activeOverlays.size, showScrollHint, scrollStartTime]);

  // Lock body scroll
  useEffect(() => {
    if (activeOverlays.size > 0) {
      const scrollY = window.scrollY;
      document.body.style.position = "fixed";
      document.body.style.top = `-${scrollY}px`;
      document.body.style.width = "100%";
      document.body.style.overflow = "hidden";
    } else {
      const scrollY = document.body.style.top;
      document.body.style.position = "";
      document.body.style.top = "";
      document.body.style.width = "";
      document.body.style.overflow = "";
      if (scrollY) window.scrollTo(0, parseInt(scrollY || "0") * -1);
    }
    return () => {
      document.body.style.position = "";
      document.body.style.top = "";
      document.body.style.width = "";
      document.body.style.overflow = "";
    };
  }, [activeOverlays.size]);

  if (!daKiemTraLogin) return <div className="fixed inset-0 bg-[#050505]" />;

  return (
    <div className="relative w-full min-h-[100dvh] bg-[#050505] text-[#F5F5F5] font-sans selection:bg-[#C69C6D] selection:text-black overflow-x-hidden">
      {/* 🟢 COMPONENT AUTH MODAL */}
      <CongDangNhap
        isOpen={showAuthModal}
        onClose={() => setShowAuthModal(false)}
        initialMode={authMode} // Truyền chế độ (login/register)
      />

      {/* LAYER 0: HÌNH NỀN */}
      <div className="fixed inset-0 w-full h-full z-0 pointer-events-none select-none bg-black">
        <img
          key={`m-${bgVersion}`}
          src={bgUrlMobile}
          alt="BG"
          className="absolute inset-0 w-full h-full object-cover md:hidden opacity-100 transition-opacity duration-1000"
        />
        <img
          key={`t-${bgVersion}`}
          src={bgUrlTablet}
          alt="BG"
          className="absolute inset-0 w-full h-full object-cover hidden md:block lg:hidden opacity-100 transition-opacity duration-1000"
        />
        <img
          key={`d-${bgVersion}`}
          src={bgUrlDesktop}
          alt="BG"
          className="absolute inset-0 w-full h-full object-cover hidden lg:block opacity-100 transition-opacity duration-1000"
        />
        <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-90" />
      </div>

      {/* LAYER 1: NỘI DUNG CHÍNH */}
      <main
        className={`relative z-[10] w-full flex flex-col items-center transition-all duration-500 ease-in-out ${
          hienThiNoiDung
            ? "opacity-100 translate-y-0 blur-0"
            : "opacity-0 translate-y-10 blur-sm pointer-events-none !hidden"
        }`}
      >
        {/* HERO SECTION */}
        <section
          className={`relative w-full h-[100dvh] bg-transparent pointer-events-none flex flex-col items-center justify-center transition-all duration-700 ${
            showHero && hienThiNoiDung
              ? "opacity-100 translate-y-0"
              : "opacity-0 -translate-y-20 pointer-events-none"
          }`}
        >
          <div className="absolute inset-0 flex items-center justify-center pointer-events-none px-4">
            <div className="w-full max-w-4xl">
              <div className="relative p-0 md:p-4 min-h-[60vh] flex items-center justify-center">
                <div className="relative z-10 w-full flex flex-col items-center justify-center gap-6 text-center">
                  {showGreeting && (
                    <h1 className="text-4xl sm:text-5xl md:text-6xl font-serif font-bold text-[#C69C6D] tracking-wide leading-tight greeting-zoom-out text-center">
                      <span
                        className="inline-block"
                        style={{
                          textShadow:
                            "0 4px 30px rgba(0,0,0,0.95), 0 0 60px rgba(198,156,109,0.6), 0 8px 40px rgba(0,0,0,0.8)",
                        }}
                      >
                        {loiChao}
                      </span>
                    </h1>
                  )}
                </div>
              </div>
            </div>
          </div>

          {showScrollHint && (
            <div className="absolute bottom-20 left-0 right-0 flex justify-center pointer-events-none animate-fade-in-up">
              <p
                className="text-[#C69C6D]/70 text-sm md:text-base font-light tracking-wide"
                style={{
                  textShadow:
                    "0 2px 15px rgba(0,0,0,0.9), 0 0 30px rgba(198,156,109,0.4)",
                }}
              >
                Cuộn xuống để xem nội dung
              </p>
            </div>
          )}
        </section>

        <div
          id="content-start"
          className="w-full bg-black/90 backdrop-blur-xl min-h-[100dvh] pt-20 pb-32 flex flex-col items-center gap-20 relative"
        >
          <div className="absolute -top-32 left-0 right-0 h-32 bg-gradient-to-b from-transparent via-transparent to-black/90 pointer-events-none"></div>

          <div className="w-full max-w-5xl mx-auto px-4 flex flex-col items-center gap-10 relative z-20">
            <div className="w-full h-[60vh] md:h-[70vh] rounded-lg shadow-[0_0_50px_rgba(0,0,0,0.8)] relative">
              <Slider1 />
            </div>
            <div className="animate-fade-in-up">
              <NutDatHang />
            </div>
          </div>

          <div className="w-full max-w-5xl mx-auto px-6 text-center">
            <div className="mb-10 space-y-3">
              <h2 className="text-stroke-title text-3xl md:text-5xl font-serif italic text-transparent drop-shadow-lg">
                Tinh Hoa Nghệ Thuật
              </h2>
              <p className="text-white/80 max-w-2xl mx-auto text-sm md:text-base font-light font-sans leading-relaxed drop-shadow-md">
                Hành trình biến những hạt gạo bình dị thành kiệt tác tinh xảo,
                mỗi sợi gạo là một nét vẽ trong bức tranh cuộc sống.
              </p>
            </div>
            <div className="w-full aspect-video rounded-xl overflow-hidden shadow-[0_20px_50px_rgba(198,156,109,0.15)] border border-[#C69C6D]/30 relative group bg-black">
              <iframe
                className="w-full h-full object-cover"
                src="https://www.youtube.com/embed/jfKfPfyJRdk?si=9lJ_kH2g0b0b0b0b&rel=0&modestbranding=1"
                title="Video"
                frameBorder="0"
                allowFullScreen
              ></iframe>
            </div>
          </div>

          <div className="w-full max-w-6xl mx-auto px-4">
            <div className="flex items-end justify-between px-2 border-b border-white/10 pb-4 mb-8">
              <div>
                <h3 className="text-[#C69C6D] text-sm font-bold font-sans tracking-[0.2em] uppercase mb-1 shadow-black drop-shadow-md">
                  Bộ Sưu Tập
                </h3>
                <h2 className="text-stroke-title text-3xl md:text-4xl font-serif text-transparent">
                  Tác Phẩm Tiêu Biểu
                </h2>
              </div>
              <button className="hidden md:flex items-center gap-2 text-xs font-bold font-sans uppercase text-white/50 hover:text-[#C69C6D] transition-colors">
                Xem tất cả <ArrowRight size={14} />
              </button>
            </div>
            <Slider2 />
          </div>

          <div className="w-full max-w-6xl mx-auto px-4 relative z-20">
            <div className="text-center mb-12">
              <h2 className="text-stroke-title text-3xl font-serif mt-2 text-transparent">
                Tri Thức & Hành Trình
              </h2>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div className="p-8 rounded-xl bg-white/5 border border-white/10 hover:border-[#C69C6D]/50 transition-all hover:-translate-y-1">
                <div className="flex items-center gap-2 mb-4 text-[#C69C6D] text-xs font-bold font-sans uppercase">
                  <Star size={12} /> <span>Triển Lãm</span>
                </div>
                <h3 className="text-xl text-white font-serif font-bold mb-2">
                  Hồn Gạo Việt 2025
                </h3>
                <p className="text-gray-400 text-sm font-sans">
                  Triển lãm nghệ thuật đương đại - nơi những tác phẩm gạo kể câu
                  chuyện về tâm hồn dân tộc và giá trị vĩnh hằng.
                </p>
              </div>
              <div className="p-8 rounded-xl bg-white/5 border border-white/10 hover:border-[#C69C6D]/50 transition-all hover:-translate-y-1">
                <div className="flex items-center gap-2 mb-4 text-[#C69C6D] text-xs font-bold font-sans uppercase">
                  <PlayCircle size={12} /> <span>Workshop</span>
                </div>
                <h3 className="text-xl text-white font-serif font-bold mb-2">
                  Lớp Học Nghệ Nhân
                </h3>
                <p className="text-gray-400 text-sm font-sans">
                  Tự tay tạo nên cõi nghệ thuật - workshop mở cửa cho những ai
                  muốn khám phá kỹ thuật và tâm huyết của một nghệ nhân thực
                  thụ.
                </p>
              </div>
            </div>
          </div>
        </div>
      </main>

      {/* LAYER 2: GRADIENT BẢO VỆ MENU */}
      <div className="fixed top-0 left-0 right-0 h-28 bg-gradient-to-b from-black to-transparent z-[4900] pointer-events-none"></div>
      <div className="fixed bottom-0 left-0 right-0 h-28 bg-gradient-to-t from-black to-transparent z-[4900] pointer-events-none"></div>

      {/* LAYER 3: HỆ THỐNG MENU */}
      <MenuTren nguoiDung={nguoiDung} loiChao={loiChao} />

      {/* Admin Tools */}
      <div className="fixed bottom-32 left-6 z-[5001] flex flex-col gap-4">
        <BackgroundManager onUpdate={handleUpdateBackground} />
      </div>

      {/* 🟢 NÚT ĐĂNG KÝ (ĐÃ CẬP NHẬT: NHỎ GỌN, TRONG SUỐT, GÓC PHẢI) */}
      {isVisitor && (
        <button
          onClick={handleOpenRegister}
          className="fixed bottom-6 right-4 sm:bottom-8 sm:right-6 z-[5002] flex items-center gap-2 px-4 py-2 rounded-full
                        bg-black/30 backdrop-blur-md border border-white/10 hover:bg-black/50 hover:border-[#C69C6D]/50
                        text-white/70 hover:text-[#C69C6D] text-xs font-bold uppercase tracking-wider
                        transition-all duration-300 transform hover:scale-105 active:scale-95 group"
        >
          <UserPlus size={14} className="opacity-70 group-hover:opacity-100" />
          <span className="whitespace-nowrap">ĐĂNG KÝ</span>
        </button>
      )}

      <style jsx global>{`
        ::-webkit-scrollbar {
          display: none;
        }
        html,
        body {
          -ms-overflow-style: none;
          scrollbar-width: none;
          overflow-x: hidden;
          width: 100%;
        }
        .text-stroke-title {
          -webkit-text-stroke: 1px #f5f5f5;
          color: transparent;
          text-shadow: 0 0 15px rgba(198, 156, 109, 0.3);
        }
        @keyframes fade-in-up {
          0% {
            opacity: 0;
            transform: translateY(20px);
          }
          100% {
            opacity: 1;
            transform: translateY(0);
          }
        }
        .animate-fade-in-up {
          animation: fade-in-up 1s ease-out forwards;
        }
        @keyframes greetingZoomOut {
          0% {
            transform: scale(1.15);
            opacity: 1;
          }
          40% {
            transform: scale(1);
            opacity: 0.9;
          }
          70% {
            transform: scale(0.6);
            opacity: 0.5;
          }
          100% {
            transform: scale(0.2);
            opacity: 0;
          }
        }
        .greeting-zoom-out {
          animation: greetingZoomOut 5s ease-in forwards;
        }
      `}</style>
    </div>
  );
}

export default function TrangChuDashboard() {
  return (
    <Suspense
      fallback={
        <div className="w-full h-[100dvh] bg-[#050505] flex items-center justify-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#C69C6D]"></div>
        </div>
      }
    >
      <TrangChuContent />
    </Suspense>
  );
}
</file>

<file path="app/page.tsx">
"use client";

import React, { useState, useEffect, Suspense } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { MapPin, ArrowRight, LogIn, Loader2 } from "lucide-react";
import CongDangNhap from "@/app/CongDangNhap/CongDangNhap";
import GoogleDich from "@/app/ThuVien/GoogleDich";
import { AuthService } from "@/app/CongDangNhap/AuthService";
import { useAppSettings } from "@/app/ThuVien/AppSettingsContext";
import { supabase } from "@/app/ThuVien/ketNoiSupabase";
import { getRedirectUrl } from "@/app/CongDangNhap/RoleRedirectService";

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const BASE_IMG_URL = `${SUPABASE_URL}/storage/v1/object/public/hinh-nen`;

function TrangChuContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const { language } = useAppSettings();

  const [hienPopupLogin, setHienPopupLogin] = useState(false);
  const [nguoiDung, setNguoiDung] = useState<any>(null);
  const [loiChao, setLoiChao] = useState("");
  const [showGreeting, setShowGreeting] = useState(true);
  const [isCheckingAuth, setIsCheckingAuth] = useState(true);
  const [isRedirecting, setIsRedirecting] = useState(false);
  const [daKiemTraLogin, setDaKiemTraLogin] = useState(false);

  // 1. ZOMBIE KILLER - Xử lý khi vừa Logout
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get("logout")) {
      console.log("🛑 [ZOMBIE KILLER] Logout detected.");
      setNguoiDung(null);
      setDaKiemTraLogin(true); // Cho phép render UI ngay
      setIsCheckingAuth(false);
      if (typeof window !== "undefined") {
        localStorage.clear();
        sessionStorage.clear();
        document.cookie = "VISITOR_MODE=; Path=/; Max-Age=0; SameSite=Lax";
      }
      window.history.replaceState({}, "", "/");
      return;
    }
  }, []);

  // 2. CHECK SESSION + SAFETY TIMER (FIX LỖI MÀN HÌNH ĐEN)
  useEffect(() => {
    if (new URLSearchParams(window.location.search).get("logout")) return;

    // 🟢 TIMER CỨU HỘ: Sau 3s nếu chưa check xong thì coi như chưa login để hiện nút
    const safetyTimer = setTimeout(() => {
      setDaKiemTraLogin((prev) => {
        if (!prev) {
          console.warn("⚠️ Login check timeout - Force UI render");
          setNguoiDung(null);
          setIsCheckingAuth(false);
          return true; // Bắt buộc render UI
        }
        return prev;
      });
    }, 3000);

    const checkSession = async () => {
      setIsCheckingAuth(true);
      try {
        // Dọn rác localStorage
        const cached = localStorage.getItem("USER_INFO");
        if (cached === "undefined") localStorage.removeItem("USER_INFO");
        else if (cached) {
          try {
            JSON.parse(cached);
          } catch {
            localStorage.removeItem("USER_INFO");
          }
        }

        // Hỏi Supabase
        const {
          data: { session },
          error,
        } = await supabase.auth.getSession();

        if (error || !session) {
          console.log("🚫 No session found.");
          setNguoiDung(null);
          localStorage.removeItem("USER_INFO");
          localStorage.removeItem("USER_ROLE");
        } else {
          console.log("✅ Session valid:", session.user.email);
          const user = await AuthService.getCurrentUser();
          if (user) {
            setNguoiDung(user);
            localStorage.setItem("USER_INFO", JSON.stringify(user));
          } else {
            setNguoiDung(null);
          }
        }
      } catch (e) {
        console.error("Session check error:", e);
        setNguoiDung(null);
      } finally {
        setIsCheckingAuth(false);
        setDaKiemTraLogin(true); // Đánh dấu đã xong
      }
    };

    checkSession();

    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange(async (event) => {
      if (event === "SIGNED_IN") await checkSession();
      else if (event === "SIGNED_OUT") {
        setNguoiDung(null);
        localStorage.removeItem("USER_INFO");
        localStorage.removeItem("USER_ROLE");
      }
    });

    return () => {
      subscription.unsubscribe();
      clearTimeout(safetyTimer); // Xóa timer khi unmount
    };
  }, []);

  // 3. AUTO-REDIRECT
  useEffect(() => {
    if (!nguoiDung || isRedirecting) return;
    if (new URLSearchParams(window.location.search).get("logout")) return;
    handleMainAction();
  }, [nguoiDung]);

  // 4. LỜI CHÀO
  useEffect(() => {
    const name = nguoiDung?.ho_ten || (language === "vi" ? "Khách" : "Guest");
    const h = new Date().getHours();
    let timeGreeting = language === "vi" ? "Chào buổi tối" : "Good evening";
    if (h >= 5 && h < 11)
      timeGreeting = language === "vi" ? "Chào buổi sáng" : "Good morning";
    else if (h >= 11 && h < 14)
      timeGreeting = language === "vi" ? "Chào buổi trưa" : "Good afternoon";
    else if (h >= 14 && h < 18)
      timeGreeting = language === "vi" ? "Chào buổi chiều" : "Good afternoon";

    setLoiChao(`${timeGreeting}, ${name}!`);
    setShowGreeting(true);
    const timer = setTimeout(() => setShowGreeting(false), 5000);
    return () => clearTimeout(timer);
  }, [nguoiDung, language]);

  const handleGuestVisit = () => {
    document.cookie = "VISITOR_MODE=1; path=/; max-age=86400; SameSite=Lax";
    router.push("/trangchu");
  };

  const handleMainAction = async () => {
    if (!nguoiDung) {
      setHienPopupLogin(true);
      return;
    }
    setIsRedirecting(true);
    try {
      const role =
        nguoiDung.role ||
        nguoiDung.vi_tri_normalized ||
        nguoiDung.phan_loai_normalized ||
        "khach";
      const type = nguoiDung.userType || "khach_hang";
      const targetUrl = await getRedirectUrl(type, role);
      router.push(targetUrl);
    } catch (e) {
      console.error("Redirect error:", e);
      setIsRedirecting(false);
      setNguoiDung(null);
    }
  };

  const bgVersion = React.useMemo(() => Date.now(), []);
  const bgMobile = `${BASE_IMG_URL}/login-mobile.jpg?v=${bgVersion}`;
  const bgDesktop = `${BASE_IMG_URL}/login-desktop.jpg?v=${bgVersion}`;

  // MÀN HÌNH CHỜ (Đã có timeout bảo vệ nên sẽ không treo mãi)
  if (!daKiemTraLogin)
    return <div className="fixed inset-0 bg-[#050505] z-50" />;

  return (
    <div className="relative h-app w-full bg-[#050505] text-[#F5F5F5] overflow-hidden font-sans flex flex-col">
      {/* Background */}
      <div className="absolute inset-0 w-full h-full z-0 pointer-events-none select-none">
        {SUPABASE_URL && (
          <>
            <img
              src={bgMobile}
              className="absolute inset-0 w-full h-full object-cover md:hidden"
              loading="eager"
              alt="bg"
            />
            <img
              src={bgDesktop}
              className="absolute inset-0 w-full h-full object-cover hidden md:block"
              loading="eager"
              alt="bg"
            />
          </>
        )}
        <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent" />
      </div>

      <GoogleDich />

      <div className="absolute inset-0 z-10 flex flex-col justify-center items-center translate-y-[10%] p-4">
        <div className="w-full max-w-[95%] md:max-w-2xl flex flex-col items-center gap-6 md:gap-8 animate-fade-in-up">
          {/* Header */}
          <div className="text-center w-full">
            <div className="flex items-center justify-center gap-2 mb-2 md:mb-3">
              <MapPin size={16} className="text-yellow-500" />
              <span className="text-sm font-bold tracking-[0.3em] uppercase text-white drop-shadow-md">
                {language === "vi"
                  ? "CẦN THƠ / VIỆT NAM"
                  : "CAN THO / VIET NAM"}
              </span>
            </div>
            <div className="relative">
              <h1
                className="font-thin tracking-widest leading-none text-white super-text-shadow whitespace-nowrap"
                style={{ fontSize: "clamp(2rem, 5vw, 3.5rem)" }}
              >
                {language === "vi" ? "ĐĂNG NGHIÊM" : "DANG NGHIEM"}
              </h1>
              <p
                className="font-serif italic text-yellow-500 mt-2 tracking-wide font-medium drop-shadow-md"
                style={{ fontSize: "clamp(14px, 1.5vw, 1.2rem)" }}
              >
                Art Gallery
              </p>
            </div>
            <div className="h-8 flex items-center justify-center mt-2">
              {showGreeting && (
                <p className="text-sm md:text-base text-white/80 animate-pulse font-serif italic">
                  {loiChao}
                </p>
              )}
            </div>
          </div>

          {/* Buttons */}
          <div className="flex flex-wrap items-center justify-center gap-6 md:gap-10 w-full">
            <button
              onClick={handleGuestVisit}
              className="group flex flex-col items-center gap-3 opacity-90 hover:opacity-100 transition-all cursor-pointer hover:scale-105 active:scale-95"
            >
              <div className="w-12 h-12 md:w-14 md:h-14 rounded-full flex items-center justify-center bg-white/5 text-white group-hover:bg-yellow-500 group-hover:text-black transition-all duration-500 ease-out shadow-lg border border-white/20 hover:border-yellow-400">
                <ArrowRight
                  size={24}
                  className="group-hover:-rotate-45 transition-transform duration-500"
                />
              </div>
              <div className="flex flex-col items-center gap-1">
                <span className="text-sm font-bold tracking-[0.2em] text-white group-hover:text-yellow-400 transition-colors drop-shadow-lg">
                  {language === "vi" ? "THAM QUAN" : "VISIT"}
                </span>
              </div>
            </button>

            <div className="hidden sm:block w-[1px] h-12 bg-white/20" />

            <button
              onClick={handleMainAction}
              disabled={isCheckingAuth || isRedirecting}
              className="group flex flex-col items-center gap-3 opacity-90 hover:opacity-100 transition-all cursor-pointer hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <div className="w-12 h-12 md:w-14 md:h-14 rounded-full flex items-center justify-center bg-transparent text-gray-400 group-hover:bg-white group-hover:text-black transition-all duration-500 ease-out shadow-lg border border-white/20 hover:border-white">
                {isCheckingAuth || isRedirecting ? (
                  <Loader2 size={24} className="animate-spin" />
                ) : nguoiDung ? (
                  <ArrowRight size={24} />
                ) : (
                  <LogIn size={24} />
                )}
              </div>
              <div className="flex flex-col items-center gap-1">
                <span className="text-sm font-bold tracking-[0.2em] text-gray-400 group-hover:text-white transition-colors drop-shadow-lg">
                  {isCheckingAuth
                    ? "..."
                    : isRedirecting
                    ? language === "vi"
                      ? "ĐANG VÀO..."
                      : "LOADING..."
                    : nguoiDung
                    ? language === "vi"
                      ? "VÀO PHÒNG"
                      : "MY ROOM"
                    : language === "vi"
                    ? "ĐĂNG NHẬP"
                    : "LOGIN"}
                </span>
              </div>
            </button>
          </div>
        </div>

        <div className="mt-8 md:mt-12 opacity-40">
          <p className="text-sm tracking-[0.2em] uppercase font-bold text-gray-500 drop-shadow-sm">
            © {new Date().getFullYear()} DANG NghiemArt
          </p>
        </div>
      </div>

      <CongDangNhap
        isOpen={hienPopupLogin}
        onClose={() => setHienPopupLogin(false)}
      />

      <style jsx global>{`
        @keyframes fade-in-up {
          0% {
            opacity: 0;
            transform: translateY(20px);
          }
          100% {
            opacity: 1;
            transform: translateY(0);
          }
        }
        .animate-fade-in-up {
          animation: fade-in-up 1.2s ease-out forwards;
        }
        .super-text-shadow {
          text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9),
            0 8px 16px rgba(0, 0, 0, 0.8), 0 0 20px rgba(0, 0, 0, 0.5);
        }
      `}</style>
    </div>
  );
}

export default function TrangChuDashboard() {
  return (
    <Suspense
      fallback={
        <div className="w-full h-[100dvh] bg-[#050505] flex items-center justify-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#C69C6D]"></div>
        </div>
      }
    >
      <TrangChuContent />
    </Suspense>
  );
}
</file>

<file path="app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  /* MÀU SẮC CHỦ ĐẠO - DAY MODE */
  --gold-artisan: #c69c6d;
  --gold-hover: #b58b5d;
  --black-matte: #1a120f;
  --void-black: #050505;
  --paper-rice: #f5e6d3;
  --red-seal: #8b0000;

  /* Cấu hình giao diện Light */
  --bg-primary: #f5f5f5;
  --bg-secondary: #ebebeb;
  --bg-card: #ffffff;
  --text-primary: #1a120f;
  --text-secondary: rgba(26, 18, 15, 0.6);
  --border-color: rgba(198, 156, 109, 0.3);

  /* Biến chiều cao dynamic cho Mobile - Mặc định 100vh */
  --app-height: 100vh;
}

.dark-theme {
  /* Cấu hình giao diện Dark */
  --bg-primary: #050505;
  --bg-secondary: #0a0a0a;
  --bg-card: #1a120f;
  --text-primary: #f5e6d3;
  --text-secondary: rgba(245, 230, 211, 0.5);
  --border-color: rgba(198, 156, 109, 0.2);
}

/* 🟢 CẤU HÌNH QUAN TRỌNG: FIX LỖI SCROLL TRÊN MOBILE */
html,
body {
  background-color: var(--bg-primary);
  color: var(--text-primary);
  font-family: "Inter", sans-serif;
  transition: background-color 0.3s ease, color 0.3s ease;

  /* Khóa viewport: Ngăn kéo dãn (Rubber-banding) trên iOS */
  height: 100%;
  width: 100%;
  overflow: hidden; /* Chặn scroll ở body, bắt buộc scroll ở thẻ con (div) */
  position: fixed; /* Khóa cứng body */
  overscroll-behavior: none;
  -webkit-overflow-scrolling: touch;
}

/* Class thay thế h-[100dvh] để tương thích biến dynamic */
.h-app {
  height: 100vh; /* Fallback */
  height: var(--app-height);
}

/* 🟢 ARTISAN UTILITIES */
@layer components {
  .btn-artisan {
    @apply px-6 py-3 rounded-xl font-bold uppercase tracking-widest transition-all duration-300;
    background-color: var(--gold-artisan);
    color: #000;
    box-shadow: 0 4px 15px rgba(198, 156, 109, 0.3);
  }
  .btn-artisan:hover {
    background-color: var(--gold-hover);
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(198, 156, 109, 0.4);
  }
  .btn-artisan:active {
    transform: scale(0.98);
  }

  .artisan-card {
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    backdrop-filter: blur(12px);
  }
}

@layer utilities {
  .text-gold {
    color: var(--gold-artisan);
  }
  .bg-gold {
    background-color: var(--gold-artisan);
  }
  .border-gold {
    border-color: var(--gold-artisan);
  }
  .glow-text {
    text-shadow: 0 0 10px rgba(198, 156, 109, 0.5);
  }

  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
}

*::-webkit-scrollbar {
  display: none;
}
* {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

@keyframes hologram {
  0% {
    opacity: 0;
    transform: scale(0.95) translateY(10px);
    filter: blur(5px);
  }
  100% {
    opacity: 1;
    transform: scale(1) translateY(0);
    filter: blur(0);
  }
}
.animate-hologram {
  animation: hologram 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}
</file>

<file path="app/layout.tsx">
import type { Metadata, Viewport } from "next";
import { Inter, Playfair_Display } from "next/font/google";
import "./globals.css";

// Components
import NutHoTro from "@/app/components/NutHoTro";
import TuVanKhachHang from "@/app/components/TuVanKhachHang";
import ForceFullScreen from "@/app/components/ForceFullScreen";
import PushManager from "@/app/components/PushManager";
import ErrorBoundary from "@/app/components/ErrorBoundary";

// Providers
import QueryProvider from "@/app/QueryProvider";
import { UserProvider } from "@/app/ThuVien/UserContext";
import { AppSettingsProvider } from "@/app/ThuVien/AppSettingsContext";

const inter = Inter({
  subsets: ["latin", "vietnamese"],
  display: "swap",
  variable: "--font-inter",
});

const playfair = Playfair_Display({
  subsets: ["latin", "vietnamese"],
  display: "swap",
  variable: "--font-playfair",
  weight: ["400", "500", "600", "700", "800", "900"],
});

export const metadata: Metadata = {
  title: "Hệ Thống Quản Lý ERP",
  description: "Generated by Tommy Nghiem",
  manifest: "/manifest.json",
  icons: {
    icon: "/icon-192.png",
    shortcut: "/icon-192.png",
    apple: "/icon-192.png",
    other: {
      rel: "apple-touch-icon-precomposed",
      url: "/icon-192.png",
    },
  },
  appleWebApp: {
    capable: true,
    statusBarStyle: "black-translucent",
    title: "NghiemArt ERP",
  },
};

export const viewport: Viewport = {
  width: "device-width",
  initialScale: 1,
  minimumScale: 1,
  maximumScale: 1,
  userScalable: false,
  viewportFit: "cover",
  themeColor: "#000000",
  interactiveWidget: "resizes-visual", // Giúp bàn phím ảo không che input
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="vi">
      <body
        className={`${inter.variable} ${playfair.variable} bg-black h-app w-full overflow-hidden font-sans`}
      >
        <UserProvider>
          <AppSettingsProvider>
            <QueryProvider>
              <ErrorBoundary>
                {/* 1. Xử lý chiều cao & Fullscreen cho Mobile PWA */}
                <ForceFullScreen />

                {/* 2. Nội dung chính của trang (Page) */}
                {children}

                {/* 3. Các thành phần Fixed (Nổi trên cùng) */}
                {/* NutHoTro: Góc Phải (Khách hàng) */}
                <NutHoTro />

                {/* TuVanKhachHang: Góc Trái (Nhân viên) */}
                <TuVanKhachHang />

                {/* PushManager: Xử lý đăng ký nhận thông báo ngầm */}
                <PushManager />
              </ErrorBoundary>
            </QueryProvider>
          </AppSettingsProvider>
        </UserProvider>
      </body>
    </html>
  );
}
</file>

</files>
